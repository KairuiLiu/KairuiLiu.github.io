<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>LiuKairui&#39;s Blog</title>
  
  <subtitle>整点薯条</subtitle>
  <link href="https://blog.liukairui.me/atom.xml" rel="self"/>
  
  <link href="https://blog.liukairui.me/"/>
  <updated>2023-05-22T16:00:03.000Z</updated>
  <id>https://blog.liukairui.me/</id>
  
  <author>
    <name>Liu Kairui</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>一些前端认证技术</title>
    <link href="https://blog.liukairui.me/article/%E4%B8%80%E4%BA%9B%E5%89%8D%E7%AB%AF%E8%AE%A4%E8%AF%81%E6%8A%80%E6%9C%AF/"/>
    <id>https://blog.liukairui.me/article/%E4%B8%80%E4%BA%9B%E5%89%8D%E7%AB%AF%E8%AE%A4%E8%AF%81%E6%8A%80%E6%9C%AF/</id>
    <published>2023-05-22T16:00:03.000Z</published>
    <updated>2023-05-22T16:00:03.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="web-authentication">Web Authentication</h2><blockquote><p>Web Authentication 仅在安全上下文 (HTTPS) 中可用</p><hr /><p>Web Authentication 一般用于辅助验证 (两步验证)单独使用的话用户数据会直接和认证设备绑定...设备丢了数据就寄了</p></blockquote><p>Web Authentication API 是一种新的验证模式, 其允许网站调用计算机的PIN, 生物特征 (如指纹或面部识别) 识别器或硬件令牌 (如USB密钥)来验证用户身份，而无需依赖传统的用户名和密码组合. 例如在用户可以通过Windows Hello 扫脸直接登陆网站</p><p>Web Authentication API 的主要目标是替代传统的用户名和密码登录方式,以解决密码泄露, 弱密码和重复密码使用等安全隐患.通过采用公钥加密和生物特征识别技术,Web身份验证API提供了更高的安全性和用户友好性. 可以在<span class="exturl" data-url="aHR0cHM6Ly90cnktd2ViYXV0aG4uYXBwc3BvdC5jb20v">这个网站<i class="fa fa-external-link-alt"></i></span>尝试使用 WebAuthentication API</p><p>基本流程</p><ul><li><p>注册</p><p><img src="./一些前端认证技术/WebAuthen.png" /></p><ol start="0" type="1"><li><p>客户端请求服务器用户希望注册凭据, 一般包括用户名 (非 WebAuthentication 标准)</p></li><li><p>服务器返回构建密钥所需信息, 包含</p><ol type="1"><li>一个 "挑战" (Challenge): 一般是一个大随机数</li><li>一个 <code>pubKeyCredParams</code>: 包含服务端希望的加密算法优先级(例如: <code>[EdDSA, SHA-256]</code> 就是希望使用 <code>EdDSA</code>如果不行就用 <code>SHA-256</code>)</li><li><code>authenticatorSelection</code>: 允许使用的认证器类型</li><li><code>attestation</code>: 是否需要来自认证器的证明</li></ol><p>这步仍然不是 Web Authentication 标准规定的</p></li><li><p>客户端基于传回的 <code>authenticatorSelection</code> 选择认证器.向认证器调用 <code>authenticatorMakeCredential</code>并传入服务器回传的信息</p></li><li><p>认证器先要求用户完成一次某种形式的认证 (PIN, 指纹, 面容)以确认用户正在操作并同意注册</p></li><li><p>认证器向浏览器推送一个公钥凭据对象,该公钥对象上包含了用于证明公钥与认证器私钥匹配的签名</p></li><li><p>客户端获取数据并构造 <code>PublicKeyCredential</code>, 其包含</p><ol type="1"><li><code>identifier</code>: 标识符</li><li><code>response</code>: 认证器客户端请求的回应<ul><li><code>clientData</code>: 凭据上下文, 包括挑战与发起请求的来源</li><li><code>attestationObject</code>: 证明信息(如果第一步服务端有要求)</li></ul></li></ol></li><li><p>Web 服务器做验证</p><ol type="1"><li>检查返回的 challange 与发出的 challange 是否匹配</li><li>检查发回数据与最初请求 challange 的源地址是否相同</li><li>检查服务器发回的证明是否足够</li></ol><p>并关联凭据到用户</p></li></ol></li><li><p>登录验证</p><p><img src="./一些前端认证技术/WebAuthen-log.png" /></p><ol start="0" type="1"><li>客户端发起登录请求, 并携带一些可能的识别字段(用户名啥的)</li><li>服务端确定公钥, 生成一个挑战并构造可选的<code>PublicKeyCredentialRequestOptions</code>, 其包括<ul><li><code>allowCredentials</code>: 若客户端传入了用户名,该字段返回该用户的凭据</li><li><code>userVerification</code>是否应该执行用户验证</li></ul></li><li>浏览器调用 <code>navigator.credentials.get()</code> 方法,将服务器挑战和其他数据 (如允许的凭据列表) 转换为一个<code>PublicKeyCredential</code> 请求参数对象</li><li>用户在其身份验证设备上验证自己的身份</li><li>设备响应, 浏览器接收到一个公钥凭据对象. 此对象包含一个签名,证明设备具有与凭据公钥配对的私钥, 并且用户已经验证了自己的身份</li><li>客户端获取认证器创建的数据并构造 <code>PublicKeyCredential</code>,包括:<ul><li><code>identifier</code>: 标识符</li><li><code>response</code>: 认证器客户端请求的回应<ul><li><code>clientData</code>: 凭据上下文, 包括挑战与发起请求的来源</li><li><code>authenticatorData</code>: 凭证, 签名, 签名计数器</li><li><code>signature</code>: 包含 <code>clientDataJSON</code> 与<code>authenticatorData</code> 对象</li></ul></li></ul></li><li>服务器验证该凭据对象</li></ol></li></ul><p>代码实现:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> rawId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// store cert id (get it from server actually)</span><span class="token comment">// registor</span><span class="token keyword">let</span> challenge <span class="token operator">=</span> window<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span><span class="token function">getRandomValues</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">id</span><span class="token operator">:</span> Uint8Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">atob</span><span class="token punctuation">(</span><span class="token string">"UZSL85T9AFC"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">c</span><span class="token operator">=></span>c<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// sample user id in Base64</span>    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"kairuiliu@msn.com"</span><span class="token punctuation">,</span>    <span class="token literal-property property">displayName</span><span class="token operator">:</span> <span class="token string">"Kairui Liu"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">let</span> relyingParty <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"Example Domain"</span><span class="token punctuation">,</span>    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">"example.com"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">let</span> credentialCreationOptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">challenge</span><span class="token operator">:</span> challenge<span class="token punctuation">,</span>    <span class="token literal-property property">rp</span><span class="token operator">:</span> relyingParty<span class="token punctuation">,</span>    <span class="token literal-property property">user</span><span class="token operator">:</span> user<span class="token punctuation">,</span>    <span class="token comment">// most device support -7 (ES256), but windows hello can only worked on -257 (RS256), you can aslo add -8 (EdDSA), but in most of cases -7 (and -257, if you want to use windows hello) is enough (https://github.com/w3c/webauthn/issues/1757)</span>    <span class="token literal-property property">pubKeyCredParams</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"public-key"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">257</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"public-key"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>    <span class="token literal-property property">attestation</span><span class="token operator">:</span> <span class="token string">"direct"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>navigator<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">publicKey</span><span class="token operator">:</span> credentialCreationOptions<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newCredentialInfo</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>newCredentialInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>    rawId <span class="token operator">=</span> newCredentialInfo<span class="token punctuation">.</span>rawId<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// verify</span><span class="token keyword">let</span> challenge <span class="token operator">=</span> window<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span><span class="token function">getRandomValues</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> allowCredentials <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"public-key"</span><span class="token punctuation">,</span>    <span class="token literal-property property">id</span><span class="token operator">:</span> rawId<span class="token punctuation">,</span>    <span class="token comment">// transports: ["usb", "nfc", "ble"] // do not write this config if you want to use build-in verifier. actually, it should be provided by server</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">let</span> credentialRequestOptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">challenge</span><span class="token operator">:</span> challenge<span class="token punctuation">,</span>    <span class="token literal-property property">allowCredentials</span><span class="token operator">:</span> allowCredentials<span class="token punctuation">,</span>    <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>navigator<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">publicKey</span><span class="token operator">:</span> credentialRequestOptions<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">assertion</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>assertion<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>还可以参考 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvb2dsZS93ZWJhdXRobmRlbW8=">google/webauthndemo<i class="fa fa-external-link-alt"></i></span></p><h2 id="oauth">OAuth</h2><p>WIP</p><h2 id="oauth2-pkce-proof-key-for-code-exchange">OAuth2 PKCE (Proof Keyfor Code Exchange)</h2><p>WIP</p><h2 id="jwt">JWT</h2><p>WIP</p><h2 id="openid-connect">OpenID Connect</h2><p>WIP</p><h2 id="saml-security-assertion-markup-language">SAML (SecurityAssertion Markup Language)</h2><p>WIP</p><h2 id="session-based-authentication">Session-based Authentication</h2><p>WIP</p><h2 id="http基本认证">HTTP基本认证</h2><p>WIP</p><h2 id="http摘要认证-digest-authentication">HTTP摘要认证 (DigestAuthentication)</h2><p>WIP</p><h2 id="bearer-token">Bearer Token</h2><p>WIP</p><h2 id="hmac-tokens-hash-based-message-authentication-code">HMAC Tokens(Hash-based Message Authentication Code)</h2><p>WIP</p><h2 id="multi-factor-authentication-mfa">Multi-Factor Authentication(MFA)</h2><p>WIP</p><h2 id="总结">总结</h2><table style="width:100%;"><colgroup><col style="width: 32%" /><col style="width: 8%" /><col style="width: 8%" /><col style="width: 8%" /><col style="width: 11%" /><col style="width: 11%" /><col style="width: 8%" /><col style="width: 11%" /></colgroup><thead><tr class="header"><th>技术</th><th>安全性</th><th>易用性</th><th>跨平台</th><th>用户体验</th><th>实现难度</th><th>扩展性</th><th>数据隐私</th></tr></thead><tbody><tr class="odd"><td>WebAuthn</td><td>高</td><td>一般</td><td>一般</td><td>良好</td><td>高</td><td>良好</td><td>高</td></tr><tr class="even"><td>OAuth</td><td>一般</td><td>良好</td><td>良好</td><td>良好</td><td>一般</td><td>良好</td><td>一般</td></tr><tr class="odd"><td>JWT</td><td>一般</td><td>良好</td><td>良好</td><td>良好</td><td>一般</td><td>良好</td><td>低</td></tr><tr class="even"><td>OpenID Connect</td><td>高</td><td>一般</td><td>良好</td><td>良好</td><td>高</td><td>良好</td><td>高</td></tr><tr class="odd"><td>SAML</td><td>高</td><td>一般</td><td>良好</td><td>一般</td><td>高</td><td>良好</td><td>高</td></tr><tr class="even"><td>Session-based Auth</td><td>一般</td><td>良好</td><td>良好</td><td>良好</td><td>低</td><td>一般</td><td>一般</td></tr><tr class="odd"><td>HTTP Basic Auth</td><td>低</td><td>良好</td><td>良好</td><td>一般</td><td>低</td><td>一般</td><td>低</td></tr><tr class="even"><td>Digest Authentication</td><td>一般</td><td>一般</td><td>良好</td><td>一般</td><td>高</td><td>一般</td><td>一般</td></tr><tr class="odd"><td>Bearer Tokens</td><td>一般</td><td>良好</td><td>良好</td><td>良好</td><td>一般</td><td>良好</td><td>一般</td></tr><tr class="even"><td>HMAC Tokens</td><td>高</td><td>一般</td><td>良好</td><td>一般</td><td>高</td><td>良好</td><td>高</td></tr><tr class="odd"><td>Multi-Factor Auth (MFA)</td><td>高</td><td>一般</td><td>良好</td><td>一般</td><td>一般</td><td>良好</td><td>高</td></tr><tr class="even"><td>OAuth2 PKCE</td><td>高</td><td>一般</td><td>良好</td><td>良好</td><td>高</td><td>良好</td><td>高</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">最近被网站唤醒 Windows Hello 震惊到了, 简单了解一下这块的技术</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="安全" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="安全" scheme="https://blog.liukairui.me/tags/%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Blob与File</title>
    <link href="https://blog.liukairui.me/article/Blob%E4%B8%8EFile/"/>
    <id>https://blog.liukairui.me/article/Blob%E4%B8%8EFile/</id>
    <published>2023-04-05T16:00:04.000Z</published>
    <updated>2023-04-05T16:00:04.000Z</updated>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <summary type="html">经常用 Blob 但是对这块 API 完全不了解, 就看一下</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="JS" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/JS/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="Blob" scheme="https://blog.liukairui.me/tags/Blob/"/>
    
  </entry>
  
  <entry>
    <title>前端安全策略及其解决方案</title>
    <link href="https://blog.liukairui.me/article/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5%E5%8F%8A%E5%85%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    <id>https://blog.liukairui.me/article/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5%E5%8F%8A%E5%85%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</id>
    <published>2023-04-05T16:00:03.000Z</published>
    <updated>2023-04-05T16:00:03.000Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="抱歉, 这个密码看着不太对, 请再试试." data-whm="抱歉, 这个文章不能被校验, 不过您还是能看看解密后的内容.">  <script id="hbeData" type="hbeData" data-hmacdigest="c77527f16d0cef26b975021417675d416e5f41d6154514e40275542a3b79f058">34e85ffb0b6d2d12b6c2e177fdc7251ef828b24d094c5f9b0c6691c535f2e78b2073ac93317b8381299614d0913df98d6f64589fed558a8ad9dcb91884da8185dd6a1400c14cca78848bd546b9ce13accae4c98d1f7f45c171c2cf0709f86f02b3143a7373b584a7608f19f759df28369e9ea6d2e8c73527beed525d5c726ee2205f5f4f04f75c5559f1412fba8c6d186900b6f69403cf63eca1f91c585e5f0be72d9cd079a950f543cbd9a64450f9fb9e7ecb57c2f9d4a5f9e089327d046b25940b424f0d43a97e19192a1c3231c5f764cd5f2e0c5d16f1169dbeacfe23cac2253794ff4dba0257ed4a6041491cc36340e8af36cef4021a2ea2bf9819deec2092548d445f1880bbebd7a098feafb5b6e4c6decbac50d2e9162fe53e9f2e63ea7df676016dbbef283ad0d955050c6e75264b82b90316259c389aa9a9552abf21e2a8e66cb5c29fe3487214746ef1033e8918cbd25ba2e220a82df6044605c73940070dfffb666e0e6482778b39473adbe353d5bff6eec7537eab7818ef0e70bcca6d389b8a83169409031bae99772580d57277944aad141bfa93eec81484443fe797a5196711b14e24dadf4a20aff400f4a4972dd1c4c647223ab15065464c5df6ad48cae865760746575cf04fdff4467379ca68a35cc71e9a8b0bfefc579a133d2595f45c04a50d63fc6586d107aa1dc38629703d37fca90ce81a0ac6cc642791b5a386f1c5ff63032cee9c373935e944c60fb2ab7fbf778447d5beba5c8e6891a9db9d7ac68b02de554d3cecacb70a8a9f8b3c46a7bb522cc29fe10e52d358c255aee745fddd24a6cfa558fa42bd9d3aea0ffd4e29c636850ffb3483f143a8feef5f9c75be1fe60d4bcb17bd2cd2a223ce01362aa6a4bcde497fa440e48077a6f829f8466375ab5c735852f1f9b6b90bbac60aa3dde1f0f943802fb6f45deecefd3a5649c0b6efb3008df660a971b4c9cca0a3636341c366cadeda52ab1712aac80a375c8aa9be78775d4b0bd7203ac7086af610d6404ef47632771824d3fab11d6b5a8b5c63caac26a66c20b057985e216457b6d8e3ad5f05ce3b51a6176250f3db0f8a20717693e5fb373fe64858e40efcd9c112d4d029cfe4a1833ba5c1d62b0ff99000478ab91c027ddd4e5163ea92d254343746443daba25951b3732f05818621d70144808b390c40820c0886eeb55cdce2633fdc70d1991cdcb0e2730f9f129370a64e02b056b5e05b415d7186d98767e4a77187b2f937e0fa1a68352fc3cacd3f3e07dbdb634e0554ff186c679f04dc1441cbc194d760ff0986964c475ef5acd60464e7be4a0b08ba2041cf9d980841f2710a2ffbecc6f5441eb798fa63d8137a1e2c24acb46f47e01d3b7024dd2e5c7f627678710c88ac4089749730acba78b57fb689a871585fc0b0cc3d887ae23a75e01bdb63b081bb44ed5faf6b2a3665bdde7be1c3c6904699ec6e5bfc86d9e067ae16c62b71daef4e9bef24f38065732212ef3557db8219d6b11b18dbfaeab0730dbee0fedd9408963038c57f03c10afa4778237285da1865ee432e6aaeef9dbc46790da1b62ff907f2f4a9fcc05654632b288ec06b8d812838822f6a5616341d118d93ec1d9be5e2123931da7932794cc85a30666c4d31ee08ffdf713bef65ab83827109eeabf8a9e35c1ede78bed224b20b38e9deb4d9012aa23f11fa45d53df8ba1dc80b1088e0cace7f5e700380a6cc3a361cb73fb83f47d3eac6302643eab908d203f1600c91fcbdc4e0a3dc1ddf0adf0a0bf78678bb216d724c062f7f515f5bdafcf0d22fce5cc6dbac1f256c14da4958d4a334c4bbb3404307197fb617d886c59c0a6fa903c3a535c3d3cf78a58b1cf9f0c42178bf35548c3ffd92b972698a817f420d7829a88f4ae336fc61bea56453c9cc8c4affabcac99349800db1fb3ecc79e503dc7c0ae98775a39c37c7f2f0737761dc63bde05b938720930c9479f43d03acad7daff46bc6178037557a006680e68e3f529c30ccfddad209989d062478f1297e8a33971fbbaee570da261784b07cc6d40d30172e7560f167febac431bdb48768ce3a3160146eeaa2fbe85d69524632c5f7281627d19cc2401c8f26e0dd187cd1fb837b468140e7bc6f313f1cfed53f71b121869c92d5eff9d8bf7c3b7b85a437e4210fe6a3ada9e6c7f5f97fd1d6774a3d5b5a413a151e4ec45167c94062a36ca10c1c707585c4b74656b32affedf44ddc643747d2634cac9b2aa7a8225b0f191aa7049a4e96c1011d2535652a9fd510c27f6f66325950681885a585544c81c9ec18e1a632ccf166c03c9196fac1e288c2d0bc7ad88dd3672888e52c701ccafe630d506643f7054bc995af913c5abe8fedb0d8b8c447fed00907eb35b97faaa508ac55f291a3882b4c8cb4333d51a9967c1367ab734d8646c53a1b2c7162281bdccb557af5ba662cc90f127474ea36b763ba7bef91bbff412501cfbea5b78911f8cd67feca0eee2395fdbb3b1737ea5dbfa88d0f1351a349df0bdab8debd09abb7c9da17d8614a001a195c74903c5187af65bf00ee4c55eb6a20d792a7fe1ce44175efccf3c3649b62434b03ef3b54b4409409adc7184eb3cce7b95fd8af23b98fab888204b38503eb1f2516f9556d88bcf52c9a2dcfba266c2af9f2af847f1e24b691c2d1d3cd0cea81685d9e11ac145c2fcffe7060ba4f83280ea7db15930dde569559034b0ba5aae61d6d22765ccd2f5bf641e085af5ec274a70e81bc1e8aea35712b03de3ee9370c46cda75583616aad8fd9d5bdc3f2fbd59c1aedf049fcdc6a4b3befdea078ac1014af0ada4c9eecd0312ca0a42803ce2e3db9b42f090a33dbaa3501f030b6243e1caa422403d0ca4410697d092f72436f1796d3e5716a7dc2e15b3ac4841c5f96701d5e92838724c7cecbfa1f91676e4e66075808b56cd88a317fbe0c05cad47503bf714ce4d0ea6b9f19b0eac0d69dc451e02ca1f2e5fd566fb6309c6a418da75137211e8cb5b7d051b18bb73afc6af2d72f86cf94c322ca48dbc880b8d2cb3367274a65f66c4c38bcdd852adb019148fb8a356a64eb1922c90e21f1b76e3bb4df432c67d6f1b542f6e5b2c2f434d841c7e5fc27f95b09eca6c74ec8550c83371d9967973959de21b4ca950ea84bce2a4f8f35706bd94694fb226d4df254c43f5d9f6f4098e44dbe8252cc906aacb5b6a7933e560a916ec35c8e2411d4e79d2a8696421cfe2454318674fd903835ea5706eec27c208bd9699f2a6764f7eb95296b9f871bbce52d349a363f3605b40abdd4464c5cebac05c981f51604a21f14a9ebf39cca3a6bb5510569753d901671da66720839cef2d6abd7b9555454a7f99b7bd2976a9454214f085d82ccc7a05ea6105fdf111462a1dd7391a6708ca006bcb273fd52623d55683c1bdab01897d7833548d5f0f21c5379ac1a1199482b9c1058385d6950a264ff14be37a093fa2593ded06b4c6609cf6ceb1520406256bf752e28eba10e92c4fa7882ce95ff9bd0f5d33692bc58b343c64da251ee3660f1bbf9183703cd9af2bd971cc668c39092d5c4a22812519a8352be513070b62c87df4a4df8b49cb127d1e904633e7062d277a68ead90f6ed6bd83d2f6626bd76ed11a3277599b242745df888b9053433694efb78609e074d33156827147adeac73474067c83ffccd9d28043eba31fc1558a6fdc1d697d981eda782b2cad8d6749144540a686b8306b555c0c8a8b31c8648c7a329abf1ec9fb276deed1840d3c22676e03eef364a94be9bff792ce136a0a2203ce718c7d09089acd200582d0a1855daa30e353376e8900236f683f534c565188819f4caabd32dfd06e0cd2e975ce7827cb730d546f5c0e4a4dfde5d017c4ace52c394dcbca6500da9367aac59ea9fca6c08c5d2630896dff420c79159c063a1bca9c0516a8a99e3cf6b0a820877bdcbbb8689f2cf9c226a583be61a66e63d0f71c324125a1d5243a576403f819f4916b4fec7ff5caf5140e6e12d3dd502e498e7d199aac79d0a5445fc9f0fcd387532404517a5980a3780b4bf89094c4b0b47f6a1a0e16061706f659b701d9fa1ec425d5ecfd6cf28875ddda32be6c69552527a5d78048cb1edd3f53e5efb6dc5658410d07ee4b5b9abf2133707c64e40f3016f370f23231be6761e9fe698957e0715211a38e38fc2d5ffcdf639bbf3a119f39e2c0a1dfc5873724bab856e1b9536c9cd42cfb2ba0960ada2bad951b44759d6953c82053e2a1e95e76838c138e2fe9e0465421126bd9778b8cbe38a85514e8a4e2c93471ca02276e96adb642146fe645b7d2422ee173e1178ae8fd7d8d6f7e340dfef5fab139fdf7859c6d5b605e4652e0b1947dbd679e7851f01deaf7dcca85fd8d1a19a6226bcb732886db3587e6368fb340112b1a89839b20df372638c357b86091910c5849e2a3e2832c35520f234de7564d402f68afa2bae86975a527fd63cb0777c31a6837b31a6d1eacf879736da50ba5e27e04b6fbdc2cf237667d34f8036de6bf174a8a1cf49a970dedccece2ef78066b15352a3e30d0acabc70ca40ab5c1ecdaa163b48a847b9bd24ac0226d228abff14900dc3970cdfc1f680f7c472b832f2d457989d5476a7cdf939b9ae575629c838f5c0e31d5f6e9a4f9fad8e413ac789fa9316d7af7b9b4dbd1b9f49e49317771586e81c7c150bb82848a207613dafd9f4d31a095f2c12e0e9e01945e379adc8167031f1c31d87cbe3c985213f981c1d02f2dca81fa2ea66bc1c5b27b3d5da77d7e0bc8ada059cf56ccad816506a5336e4c8ed2c38e94e9c688eb6215f0c74b643223a056412f4382f833ad56853cf984eeda7a2def6bc8626192e8b358bd88998b20eeb09867107abf3c65353c7dc87f241ddbbd22d0d87e411a6c6222e96bd54fe15bfaeaf435270c4dacf2b4f25e16beff3de5f5489bbf5a5f0b4e541be16afa2798ab7db9037fbef3a8ad98c328792967f9b628f8ee9b2759c9b1603eb5cca26b2ddddc64c78a8a8e2dc68dca3e3b76b19c46d2762b38c1b94b3e6485ae09327e8cdc46bb7af3f2f24576d4b35db35db901c4bc4ede1b53d30db20e15454e53bb0466893c315f0d1a69d8686ff7259546fd61fbd3b86541b72511a47656fb237147d18c7327f0b6bd86bedd2cec2ea46abe8a13565096c6001c8bd94a58693ac7a8927412c9af8f07c6f585f400015a9426a9575d9f44241c77ae754e7a0175723c60d8bcae62a7d49c359f04d5573839a8ce11e5f2809c1c8712cceafc2c0f159255dd51ad0148a77e28069834d94b357fc941f4da8ed80b3527f3b27a05f16fb75614fb5632c8eb56edcb317b7482aae6b79e614b23427579885c6360a013c683771f64565d952dc588ed7f9bdcf00cf7962cdc7abb94a86b0d1f9fb7c3a974a282d65c3548c220e5b9553f75b53a554982535dfffcd0ca3d8c3d3a602bb4af822deb929331a4243c6391ec6fa672a80f15def4ba69c51b5de77731cff1d3aa0ee6a66cbf5b4a916358158b5e8acd8cd321407d2b1d6a93eb528e65fc6247746ed3516f3cd7f2aaaa8a287bf87539d5a60ca38e440a04d0e3fc14eec5dd297658e13528c1b5eb83de9401d579b89604e8f0f834d55297057ea12c3ba91c031a578a9d6b7f5e1d2c3ee3519c9953fb54e2d27807ae6856c85ff659e0daba770e29f3cf5c8df80eb9957c7d2d7ae858bb562271d32608e3e749e9867b231e693d3cb8f0ccc0064d131785a0b41b8512a8bf10ed3421d129db5e461be045e6c306bcaf4c4333230d2544ac85b245f6354d4d75f1fb4e73a7b0cd6521a934bcfe23a1839a3a06ebe0232e23495a72c16248a719c572b184ac53b4b87090a6f09ec715cd90afc98a76f38824311c9e1d13f5a8a01031dbfc2f21153859e198d4605994b5105c860aa993210fcd8582aeead2ffbe5c4f3576ea964765339a8d7a9171f6ec0fbf9cb0f69b029b7643aa24c62db6c243c96aca09b74c3b5392e5cc6dd3400aaf3377abc298afadaf03f86d823be5e6e280306e085ab687b4b99ebfc1ef770f005cb75b1c0d290bb8088709709557f44f1ca4d4812722bc2afbbc3b59d4bc1181e60e9de40e4161bf0778dba162951ac28f9720808cb65cd3dd8a027cf2ab74f2703f53bda4bb5ad0c296ddce54056a6c155f40422d9eae7389ba4cd4352bc283937d1e9f5266eecb94530c49fe190d36bc2b392290ec6321b28bc632e36661dc4740d5b70dae11a6e5fa78628d4e1d4718c7764fa25265fea09077fa3b59e31a295a473b6feee3c2f0922a575474f728092c01a9e661d80c255ff74d78264a942b7b73c46299f42af900304f8f5fcd81794984cbf2daa30b7f3de1984afd1c289da3ec6af4f6eb89e225af1d72e589e339283984184c864bc02e30595b4e6f9dac4ac5980df0c67e72379285b67d68c0254c826525c415e6eb086046756b458af6f26a96571c5344b2019f9169067f9ce0b7f9a6c00fe9bad6c1267ee3f1d3be22da0559507c05fa34d22a693eb4b16d6eea6629db20ffcd7afbb160b6d421fd51af148dcead162fbfd8d81256890f7b5e470c42670fde8da17ec2b23176021ca53ae6de20aafe2af7c1ecd11f06a75d8b1da425de020cb495f166680596ba110fca857b94e6466aa46f3bfd83b6cde92c298b8246c296cf628a1031c974bc15b2da0e92d01dd631761999fa9b385f3b684837127d61fed089c5e9a98758d900d113f8fcae972a23634e0844102a540daed29f80fc0cc37aba72a994546e0266e61ba72b2f708ab199cbd0ce2c894fa973482c851acc81a994ecbb1ad1d1f063ba49d0dd96c37adf9286de5a169d9f8c427f6f0a706d1f3380304c8f082ec9f44e3bccbf2d0bcd9827cc0cf9b7ae979fc033d08725e514f117d7d9084b52824b4e4a6433dea626ef11a05f32c5d0e01c4d26ef9b3288a72942706db782cb6ed66dc6ed7a9920eb06e7a3602064fbf2b740cb704f0547f75d2450c751e0ead60bb6efa4dd54b55a756fc8a3675516f3b7f89bd28b93ad172b28046c0d39c859fd7a6ceb3a7d0372d1b38105fa5cb25b01245241356b70738e1b52102b5963f32e4fc62d4d547998583a6265b3f392565425454b598218f0d7b2f8703070f8cc55f4d7f84db40cb37334db1f1c370f16768bd5d94504232b90f894b0906810d3233444403f1e794edcf1d4420b1af6259ae7f4dcf1d81d92cd99290720750d33c010259648624284e82ae47267a1558e0661209d232781b14da6afac97d95813b4cdd83ea4073c6cc4193c59f39c06870bef4d5c20eaf21409818df86d1013193b2ffe545a1f98b2c604e18a46ec7ec0b4d11c5e5a726e2c98600b6deb0830b96785e6a922dec52b08aac8344b219677fcfaf183f8e732dcdeb088ebe40817112292358aab94609d3bef95c07c5596003f06108e440fb2beaeaf90ec204e95de01666c7465deb88e50d679806f2aa48af1271000f777ae553e1ed491729ba0ac1a2ae1524350fe0c75db0fca39bcea0359d2c893a892a1be27397e4b5fdd0702a7886635e2a566bd7baf71571a74d5123b3a48bdf86cefb392dfe8e8db548fc2d0accc5ae3053d6874d8f50b8fd8281cdacfa2e3bdf9891ceda3f621b74b8f221d032f1341c4a5e83dea79e0cbb4b14d5f3b7f905f668164244acfe6115ab6f7ea3e2c645392ae3ece5b0e02aac104f1a1690eaa7663cbd439efb10e508471868a61b7d661e6417f6220e3cdd63d9b3265d0c2371a0df88663d2672602ca7b495b3bb6b1a8700deaab8de36b890e292214758e4972e314eab6f7b24089de21e36b054dd3c5c0bcd2a2991d7bef74cf2e8584066553ebc4f4c51e24fedc0aa9d8bb32533e89cbe61e7aeba37e1a55241d8eb8adcbf522f8168ba8fd90934f9c387de8e873f8f2a1178afe74a326b98cd5c8d39bdccceeab48f0522ec7c5c11626fee96428cee0b5ae6ce09fd2070aea8652e633b4f307ef6afdf0880dfaaa712ed97deeee1739078485839f69b938a43f4682b627176361f5b052d6aefb793fb7602c1aa024ea5242539e8a44ad89d2f85c79db3f6d1a18a964f7159b449f7318c580205a8d487050807581e882f69afacaab2bc3fd02222c74e662f407a7e93794f1c7259c1bec53562c8bf5973a043d34d81ef66f4ac58b8630f7bb3782d73b67d8ad4ec9bc3da43127383399ab39a1f14a5325396d212a3f3d2beeef0fec904ec48be4a4da89dff623d29e513bf3436b0928b4f6e0c55dc60ee3b21de6d85a3282be73b26810c934c8098cb6b1abb1059f015f76728927278dc65cbbb5c66b30482e4840894c3a376c76702232f6a13f470ee5e8270c8ea335c1ac56514f55afbb3f7b810933cf82e0e4789d491c67c404b2b7ca785cfe2a3ed6e82b3b038493810e7f331461fa1331c179595ede9bf06271ff3179087fecf9d53f87c2c0340d56f37b06452f1202aac40bd4ad8fc4cab46501403a93e6d22ca19c0ab2fe61a8cbb0574be7ebf548614c5c81332bf432290778f9b103d96fd707f8c199f76ac8365b3a4e1e78180c6806f13b397c78627d7c0b7b5a9dbaa4bdb253a4b3deb5737b4e19121f9e06f25a5d3a3bdf00e9721d9394e9054529f105224ec086a073973aba5c222fc0d3a487f2a8b08d26c255d95490b268a1f3efdfec5a5af65704b2acf9ddbae3a59a823fd4d190b8cb9b5a0169d7376d333e39514b524d2c36e6c1852590e1a9ce73ac5051f1dc1d7380601eff681af08e91d71315533e26a54c83ecd9b2980d8dc6aa3b4748d60c01e08aae5b9913322ec1d78124ab4b7a034fed0676c04dd12c505c7b839ec93d81c7abe05f8cf1da78709349d9aca18685aef4d1a6a2424bea9f42fd71a9b5af7378ec32d4a0e441839eb991b8b22b5a3c21252e39911ad041a94c971ac6162febad8837fad1fb4d23192fa697fd7ce08cc2bc44ca7bc31cf9013f4b7de7ff4ad956b2cbef692a21a56796a8f2d0f438a35acd19f32493adb7b424509835dbe12f37e3643d77eda79c16d7dfd1fa2b22f39cdf77f07b2f5cdcb21d42aa57fb3ee50c0ca25d9e157655775c5fd1fba50d7423bb83fa647d3b2f31de6d4d09f6470cbe1a1d09775de7eeb7f67915748a547164ec65fb8e1405eaccd8a02f3ce41ad5fd78d24be277160ccb672c9700b933886953c8975a57142d6f8eaa6c7e72f50ced9f82117fcc8ee4ca46f0a89c88275ba09712116a06fa5af10a573201c8ae3db7a7a68662d70e3cdeb708e3450134c654e5b678b7663ccff918c1777e51367059f4435d4787b63aaead9e15c8ccd8bce56cf8c7d3e45973ae465b98c95c0550918aad912b12ade55865a4b0dd8a9cef325d690a55e4e0130167685937f0525df37a1d41af1c5d59bc7ecfcbb1ddce9a8d4380ffe18eeb3d816b1c2c47a4086baafddcecda2ca0673bf6a170d0934d859e1f69012a2feded442cfe96a0277a76793410cc9bdf4f835d1cd4ce40e26ca55dc2813ca6c87e605afb99a811afa82a9c33584da296e1e632b8d43998ae94086f9ce981b6d880930a569bb2f468fd59963a63abaa72f91d2a7f7d13d2eff92d74edd84c414bf745115b3c3224f731c8349ac85058d498972198617e4ae61d7367f14792daeaccd0a2e94fbca081791c9f3af74a4cc5ec6b2ad063b6a7990511786e81f81c469a15dca7e3a2cac17847e19dfe68bd18b71e52e51229ca97cfec2c8d5ae6fcaeb3e663bb5aa877bd266284406f27b07817d7b3a377f820435969f9da25966472e99676a2d39a516a48e534ed2b7d3c8b54c04cb0a1fc040feaa20856c58bc70da57bcc827b1ae0b68ca4639256c748e9c1e4e1ab66522d6adaf467c6239b7ec9c418131de45c3ddea19429e1c4622516d76ff7223b4f1073adc31fb3f9fb776c8c53e14adb315449b8bccd3953aed7eae4a4ac8526ea05ce706f816f67e4c5ed385b38166d743afee7ed8acc8456bc6bdce39ae0f40b0c1fc7d74eabec3d0b770cc603dddfe6348e87b0bdbd93c55e52275ffb55956779bbc75be6514958f75b7c726d69b3ae8ca211c6f084d7daf5d7bc0bb8173d2a48e1ca429f277a0a3c598c76889fd21f958416e21150c932124b0e67b9297cc233901fc30b97443e1f252ad192697cca63ca48f5135263bbe00d34e5d296c821411a85ca95496591614668e6b61a7723c07615686f921219e9f3d4f877c8658417a979b01abf05d8e93d59e10dfe903db7e544b26449088c7febe085ca1f959d41553ba7e8c66c0c693eac0d8c4b123b403d37f30b5bd803d0c4dfeeb333682832d4b871bfc757c2c2211540250409f389ee2fe97b5760fdd40f7ae62aa93c25e6a2e062d4147da165bc5b762e195c5b4bdba3a609db1d6c2a6333c742004f109d12592bff69d7b3cb263a4998f1699768e92c51904786654b6333746690b826eba49e6813f1ab45d8922232998368ecc1b8e614ad8ec2ed4cd55b09f247ecc12c38c9919c464e8f347562c188e5b5d45f4388de0a1ee3e2448794c2962dce65e48d6b0f25d46926a1b8f13daff470ce7742f830a476764e4b255acfd7b12ded0962bff94b4e87116ac54394ea631d76385fe97171f5c0a00bad8c34dfec95766191bcd71a11da88511277879c93f92f17a99a963a0dc588ae1b2f4d804d4fad7239044f9da52b8136d31eaae338a4915a87d2988ddb229194ae38897797084ac8a7f563c13b4735c577ba437964945f09929bfa19f76afd7711f11e838f3d0b9b4e462f5ee3085063beca2c9818920025f36552a61f20076fe2b38741ed92a026cf9c53347645776c604d9f9c6857f0afd41371517f72034de5c9ff82fc3fcb49d4385ae6ff4e4a2930c6caa817f5b404f14afff537b944c4af1997e9b9f4997e1af26ae3843e771e27ec66eb4e3d833737148436a4228bc0353b8c242c4d11ce5ab17792e36e4350750c01563121c5ad27f1108c3b7b11bd2662e010c68a250bc581be8049f358a4046877dcc91a572c0a0a21f6b04590870beb1b028f7feac37adaa110df86f8324b293b95e8bc19570b95d6bf8feceb223add47e41af6135d329ee690d6b3268839730a13b9d853b7ea39e9e33942e8fc550587280045f5c6dbc5b24706c04ae12a1c8709977c909c965f7dc19b9fc610b6bbb17afe94772a6a0d2c916d292e2045587e12058d4fcc39bf7bdd1aa8e475eff5d697825932c3e3798d7d03b8c2bd1bd03f63a3cd52c857dc178c216aae84a17dbf276cad8f807b4f668d7713a4ea9a27966c3e1d18555a61a8df2c364caffa7c867db315ab216a6a401c7edbfff31be988b5cd071126b0f1f31b99a2f4f2efeb01643a2a53db81a382947358ca15f5bd31015d53c37c22b1c21451460c4193c27dc769b03f429392f2bfd0b757c5b74899c841c32b2a6584827c1927fa2dae52c84cf1715f6678ceab06548c462f5425590a44664f9e972b971b604ef8b00aa38172b3dd2a8911af8b7b1323f7e7dbffefd1d43d418cdac0016ac0c71d1e3ef5614464f53109d777afe5a66c2fa27ea031814f9776266e17724e92e114e3ad69700ff1f92fab61897da1cfd83c4542c7c0e6576346c3b2efc1aad5137a52e66f54e5684eb89137869fdd036ea3f651b018f7d8161d7ed8d47d134d3cc0b7831c71f93c71c1f237b2a6a133eedd2bec3767f1839042cb9e4c06ea8fb48c60b83a404beb83258b96da66ba43434974a47104043428cf0386aa3b8a8b73f06331e915f4f24aa80ce177f0d6a43e21d4a6ebf3ca494523d4958f839b808e9d1d7cef67dbcb941f60d79b08b2500b44354009c5e08cf9eed64d9462b4b7b2523303f38bf509977d8a51116d36175929a9fcfcecd16f969317d38ba52e01b6ce465e41ac16c1ed1897d60eef5b73abf22bf907ca9adec2b139d5848a119bb0b0948ce14c19482f0ada3b19bc5483080838a37806e187bf80278108f2652f19baee20e3bc52a8af51edea7e5014ca7461064fc7491a20107319ee0a1bd2f1fbc2712800866599b4299a463710af8146f351d2f82f0f72a804bb6eced8e2cf51e3f3b433b852da8398376200bfe9559944596d33272de6a9449ffc8299510291dc683cb83d7650ad22ead4c0af063c158a911c31cf55d7a1cd5499591929a4ebcfc224c36fff77e0de10985f84da1d3c4de046609974cb2d95786280c8499437e1d29182bca3d26dad38a9a771fcd0ec295d62ddf35c944af3f3e941e9b7818feae512378c99bb3b6fb2b87b41e5a6bcbde61f6b285fc3df6b4f0a064a31b60a43ded423678eb16fba0e74c85f815074e3d27b37f1d953ad86023ac838c11e8402bf9328dfcfedb3af7a7f6d90092b942ca0a9783a44ac20dcbb88c42bd78ccdbac3c4bae02203f24c4128215e846ef6866f869e668c015294c4374908d06ce723372a083a4e36019287c8b25d0ad591f6c6c1b63405af5680c7f99fc9105dfd308de142bbfbdae9fd2805f8be4858531aa025b1c12a3b2e5a0e20e8046111f9705d4c4c98b52b14d49673c81da5bf8d3eb05b4ea175a14a859de3787840ff5cd4bdc9e115be5911bb3944ddc0184b8aae0fa2fa0e9832967ce721a8f74c35883f4158555b77e839b8f3a350af59e1b2f900be7d2dd44235b775fb7cda97ba70122e7a3737653fc9bacf5f857b4f398b38aae361d92804a6427f9f8abff15d1ad5c3bb739f9188b7610e6ccf7a59cd966f84d589dc8184d4e8c42ca4e45b283bb676d5e7aaf010a7b82af787881b2f1c5ce7ada9fad3c808694cb16c3c08775e8c2e7e23d7f7ac037c97bec0eefe88b4028cd15ff32ab9714cb441b75a77c77ccf5dafb00d4e94e8dcac3e425a6c11437a7ed424e0d6ca168ebcd0a32536ff3174e412dfd369f62848dd3acd248f565fdd0b950454ea312640d7e7d0613aae23024ebe39ff868d4ccc1d6f18901550acb2bf65a11109d44b89d02b9df480aa3fd18a6ec91cb3ff68183f2ec2c8a3d7a7c4d958c34c0b3226d110203ca84d88013822022cfb7c775873fac5ae4b38f8c97fee73c539b84c99b735b6c2ff3e14184085efb36b7ac66e62cba69d6861d6f7a475fa54639355f788b4fd6629a4360145da598d1a51f9c5fe912433329c17b0b24a737491090eee920f90a98cf87a0fb8f91eca925a074fd3aacc9aa24f3fe124bdec985929ce7705fc9cd2177b71f993ffcc895e1eabf611eeb244b74811e209ed9e808f78bfdc8eec7757c53ecdbbb1c5b248e57a9e236f91450be74932b8df7f1bf115ac23615f693259c99168205aac296cd15752ce7622b133a9c8a359d301621fcba0bc17cf4918e2d1d0ad456efaa592686521f4b44cae8baf0dbc6c39131a3be1b9aaa016fd4750c58416b3de464f23ba70b1cab1a827fec140189b23a824a4f64f4c20e6b2475fffbc7507bb65c8459e1986b48bea5cd8dc3a5d41c825e6772634e9fcfe68aa3f23150b4b1e5a3f1b839f1f861da043d3ed38f58efe32e13e6c29034bd0d4db2e450893d122b7e6638f952b888dc3ece339d27e8d57ad43561651bd342c3d022c5aa246ecc602bece9072250a38847d307a69808337a09304a668d245523a069d91d4ff8070dbcffcd7c3b5d8d4db2d7895b8560e940fd054f0b1081e35cce287de0326f4c9aef626edefa3e31a71828908e636d9c98d0bef0cfae9bb4b232ebcad65c7eddc0259ab211c7783ea58c13d63305159f85347e7187105121fbeb1eca4bfd31620e809d19e5870509b8410b60406746f7eb5c0958070d4a16716a9c5603984c9ed322f642df15f8455b2a4734716e21ce2b1fd334a66991ae7c1b6466d03cf8dcae077984a65a7fc7e1eccb425c4d0c79e91c6e832228f993f8ef0dd2db6c1458c41fd806143594a7f56b7f549c2178443f20bb57db761f96b67a3a07c143338ec1f91fa6d612b1436471193757226302e9bcfeef4752d6fd017ff3c76fd4f9e04b4649b06fdba9e19f60482b5b9dc985c83ae09ac7e28171251046e5bef4ce2d4525faf0b79adbe19f8fd696b880ef287612aa9c6f48db5a1c4d4e20181ed369a1f87f4924a3d1893beac2b63ee9ad5eb4623757c484fadf5fe2123be967c7b1c0fd7b981e1c9151d423fdc4cc71c38a1601fcb69353a059b7f7b4f14f1dc035b673a400aced383432590b2423348538462b6f8647c991386278fda3073886496c65afcde943d4cb523fc055a0635063f48a2408804b0535c9eeafc15ae49e9b03fcc0a9b94c73bba60977c217a98c9488d19db1f99c54ce5577b97264400ff07d21588c378359698e73f0c48e49b342c9729bdaa2596980835a52cff79640931f225217380cedd2e2fea6660c9c07e736356449b289eba61f6a4e565f9254fe41d9470f5bbdb8b128b5323630e0ba8b9f6a187333ddb8a30f879e820108a84f2016820225b75ebbd3a6ee16ec5a7677b33bf9840614716bebce9af10c42c11402c25cdd33be9e351d638393bec2b7f45f4c9ffcc1ec03de27c60cc94fe8d758a06c414302db8ef6e8a667917e4828eb2fc7ea21a2465b12bbd176824de63babfc760618d49bbadfd2bcc6bb595cc7f496779e2f1bde10fc63fc22d29683a922ea45fe6d55f76b3e7516227fe67b718ff0b5f0050a5a5f6230b14d5f75391268e147c03feae2b97d2944478fea045bd20c936f55d258bc17742e81929916e0e380f328732344f155d55bbf03cad34cadb231dab5145aca203392994a44a3b8e048f870cc09b7e94395f94ed2d3fe0c2e1cf682c85da085829532b2008f534a1b46615a9e4fe7e874523c28b368b5972f6beda766af77a09ac9309ccf8244145c62a2e0a91189f2cbbca6d067d29c75b0d17fd59f6df6057d075791be2406f2fd0c4494b22a4371e4970cda39d5ec2b386ea67c7526a1f16af7d329862dc7c3b96602ee8c150c031971fd7b4995db63ee7d00e6a21b183ecc06f4a9c1e41d6cd6619434984f40d2315627a61b440895295a7f9b857d539dbbbe2f817fa1bf4a14b04350e907888c132d7fa08a0bf1a99f563fcf6bae676b7efec5d47ae291eb72141b4e7dcd71014f1ddd7f18d45f2b27bb770c970be7d91f18995d3a61b9fd2a052d70d6a99f236a65bbebf8ce3d86e31543eebf40fb2b1b004ec9f7df0c3c50f9831082e774b28a4fa396ccd0ae52e3776758a1c9a4af7b828237a970bf8acc3f5f362522974e75bdef82a6749e4aeb60f261fac1ff7036e3961ca8999313b474acc6a285c923aa3bda4e3b1e2d57414ec7d823ec755fe06a2e224fc1d187fbc5028ba031666007df2926a698f87572435e59386476be22bc5fd64f4246a58320778cf5c6d22832efcdf344bb0517627320d25f45df797a5c8d8fb690310a0a707849fdb0cc13abf24067ba36c4687644379b4d6107fb55a325e1544b296466fed7b1a8c2efe778020a5e7eb990f6dc0859308b04cb4cdc4aef49c675fb1ae31d26c2aebea6d9d63c6a353b27b3f134b9ea18341b3cf87a3059c2c3af502ddb1ccc3dd8eb39e13509007610e2e9fc4879cebbc089e506ac1319e8dec790a71d188bb983038dfaa1f2cfa63f6741f304409bd5a8f2aaa986282a7cbed07fbb7d481a86ea6c07e65b17c55b42548429dc2b6d115cf0d9b8dec0b3e90729c27a5cbc83ed9cb5a5758061928bc0ea9b882400be97cc849e1d61fc407c32a0982751395b7994376831c6ea7b2b56774634fa1c4d964782e1766f39322cd9afafae7beeece2283530cca18d2b68292bf7cbb93878e56354ab5f87bd44d73f83486528f6f8b6d485ca73de2f0b7bd0254b8e1799a6d5a25d17a3df530d05032065d6fbfe13b49882f4c6c23c138201575e37f16007a54afbc706830759eb87f817ea72de354ac4409c1a01ea02570c914ac241917d3b82c54d53ad20f12a81dfebf80f5cdf91f8d813dd26004d2df6c154e1a63c8497ff58ccd54c09fd8467002e893ed2634e8abdb3944f2b27f94af4df0026aad4f8a2267d0b3a21d9b8a9f10cbba38ba95d4327cffa18ceaf1d2e5ff05778aa54505e997dca8bc5f09dc9a10826e759fa5fd540f06a4149054769a8eeb8997c389b96808b90c70f577b002d92ccaf4f781a185bea0f265140e25125c2d6198384d1ced0829fb11f443ac488ee1d7d08948b3d00f4f5327f710bea110892c90feb21a152e969a297ec5a8a8028da47dfb3524897bb77d0e2afb369eb933488986a80a53fb7b8c9d566038b9428249e441ebf814cadf4b04610e2f1051bd4614e30f78a7f31fdda5b360214f42d1926a2d10cb76845fdc6b58f770d87ad891e097fdde3c43a2c291b0ae6f97258acf6a482f18891c9d0ba9510ae423bb1fe4b812b9c4497ccf4f2b6259f91150d7b331714dab676dfeb8911c80c6cc29b2460b43d09e5b82644a8561c97694151a958b284a42ce300fe9ce6ed99ce2b0940aae77056d27b0ad21714316a19c1ef39df356f57d881ecb6db630ba506f973eb9297c29adb5b305ff793c35117408c73373fb037add3bcb9cf036476eb0e0bad60d336d668f525db35cbb1cb7ab2203a1fa56d94541a9dec3bfb8c02a299de879b2bfef1fc15d01b5244a2fd70686de7ad3dc9262b2779fa7169123b918a74f198ce70898b525e25a9746bd031dca489568d9fecb107539f606152d50c4d448f59ea72b68fd2666bd9db778fc94bba71a81165c16f5dec8fdacb1f2f865df8d634958dbdb70e946b2c2549e98c335a568e9c012421aeb6b521bc3f058c15cfcd16b7c83de38a2269d0bfe7b57fa79eeacee482031dc36831631dbbd1cf999541d265d13ba198092b5c5dd329c46f6f3a40bb37424a338c29d6230955087eb95d97dfcc73ede8d35a84947928392fd1539d5dfcf0f8ab519a28527f185fcec114eecf2fe49ce82bc22f35f9971830ad325cc71a119672fc74ed5384d55c9f3c412b2482343ddff84f65be8f7e979da2c5b0117ec787e872d0866b079c028ec5ccc803550b7804b549ea7646020b0beb2ceeb4dc08358ea6970d0897368f387a240f1ed21d6d94a6ec1e84feb5a0118d1ba4551129d7fd56609a2f6b4e573eaa6d7dbc052dd440225fa5c66091a19e08e5b0cbd9873c932f19591c381a0e6a5631269f9d2c20280a6325d376be5dd13d8560b9ab0276ebef355f3d76f401d3c4eb4bc8b6a7f04c333d3b147ac9eb4c1c797458aaec2ba4cdffb67e703d61b0373a5d5f133f14ea8b4d2b6ad4b898aad338e613e05a7eff42d275c1ec3d976198fd379fd992400f4e15b9e102a34129d4bf5010c33d86b9c638ddc98146ebe7ac358cac7402bc3153439d64bdaf7f121538d7ad0ec553329b06a4a0aa9a62eff002407d60e64f0880341f467820793df3316e5e746d85fa0cd90fcdaef2adcb1af8412e26342c57c89ffc350ffe7c0e749d088963299fd9be46dc0905c014d4ddfa8edb687802ffe3c3bc08199901dc3b8860200ca355e63059d5cf9973f9c88d02b403aabb02958002bf5d6a210ccaff96f97f0b5c42f461b08467b42115a9d470be1e8d45ead62361b4dfc621ad35a4baa73b30a00167276ee2189af369df3cc88e4c4bf8f8dd50bfa2bca177dadfae341c01b20da1d54fcc8eef8e3f77cd33087884fa4b72ed24eb4b1effda40a86dd4030d0f313fa409f7342c317dc0c1b1f516c5d208e0a7bfa9ee8c209ce4a6e4fb900b22c16a8921696f6f62b06d22f9d2fc8a33af8f2ead809555d6268a1bb0bce14240ae075b2ebef6c7e25c5332d2635c63e64b21affb399feb11e655df6a0afbdfb6761ff57c26ad425ba64e7f04d56c9ef4164dc3e28a2d35b78c7290183b37f81c00e3b5ce9ecbb6023f78e162d2585e46d66cb401dd71ff5b006f5ec063b5768ce1da3ac6dd39a505765c6d584a95cb789b537a9584b8394ae4383814c1d7ef976533582c7e9615fa6b2572dfd082b2c46cd9c500ced48a40f38fd60cbc4c19cb6f68c37755ec0af395ee0000c67ce0886f18cef4bc52eeaa31563f6784efad26d676e4b7eb20fb10097a5c5f214cbca4c2df454f8cd051cfb3e4da1f4babeaac2f2f119c330068ce991367d55bd1f4da0465c54727982a9ee64b56222fd727cbe7b254ab3093329bfb96ee9d593ad775edd9615ffc08dfe51612dd7a9235742ddb4ab97fe21380c3b5e90b65b45b9833b307c61b825e478b32f8994a527005bbf911d5c1ac2dad7a75b24805d80d46374af95be59950db1d3da4b56c6bf3ebe66e4e61d9926100c7251dfb5353b64a73ea9ed3cbc9b38cd352e784a07874e1c9c4ccaf56c7bba107eb79f1aa4c284dd36516025b1b8d9eef20c5d0423103318c6fc49d874c232ec48d9d1fbbfa094ce6028e004e659c2c3f23f592f9c4235cfa305a678250ce9e6a3d1a3678d07f99d1212c0c8dc09cbc5959f5cc563b55e1578bbff1ac5ce4ebd1e45e828631363348c7d0825243f1f9c4d25cc1fb05fc73dca75190f851b54a8e9355d9e987d2c3f00b95277459103b362a4992f86b115e3a826d98640cc10f6798b2842d8bf2fadde1cc6002cf6022a644fa69c8dc18d121edc93e54ed0255050eaeb4779ab2f06f86f667970b21964d412f99d5b08c1f65d6eac87b2fe61d7bc877ec769324a12558c606f386809c64549b230ee5746ac475bcfc6ac2ccad777fa71d9e418cd03496950054b8e98ead3270f7564e1549a0a6ba8c9f4accec937447ea296b8906dfe244bd726b0be5bd42f12456f800458a27b258eb3a54a750a9c2819e4fecf01d8db60766ee83640f73b913548e97dbaf405442decbcfcaef3374a15e0e57b13263ec8f20b7b65be0501de9b9c5b181ddc2b9d57b70168508cdb38e2c9f9a1e1c3250f2d75492b6dd9df1612be6a3bb0e830aff0f8086d2beb1c2239b64a3bf8d77dbc204fa38136e83ed2646d9dfcb267c89f1bfb5aa1fda91c03d4fad8507aab34b04f86f8ebf8a534f8ccadd9b78243f9a5d33fc0cb7ecf49ca2b3a7f78b7d8382352043b1573b22c0bd0e1ea098c13155c74a4185c52a1d48629e7ff2333839a21bbd7dfa4789da1cf41a5810b59292262108828dcadae7046fa191ad86b3f22178af0322ff03bdfe8b3b2de348b1ace4880bd92625b123871257f332437ac5ece2d721132f67b777ac92d4ad0675608c6e509a2c82681a53645b6056ffce3aba670892dbf10b0d278c631ae0d7222090f54a0dea98250f71c05b5520b65d60e65da303d8e6d32b791edd834fd87230e0548e6fdb90482c2a29dd8a8263e7209e53644b4d9896562b17f58086acbdccaaaa26529a79a8df55dcf48407cc056c6a1665a5989291e0303b574645de02eb644276fab7a56dd09ac5d12e6e3b745e125089f337f58cf3366f3cf753363ba7653eda1557dba69135fee37d37ca099d13c53a130102494fb4924763cbf3622d91df44ab90524f8dad81270bfae0465b24dd01ffda0c3e68ef6734b6f933672fee88c8603d1875f2101bd2b30d54bddefa93b21fb25b1f10c554c4013456f1fb48aa7d3b650cdcc13dd084b009a2f3ffb9f789525e4c0f8659a07432673147f94ac1461dbe9883817b67330afb68419ebdd567df026d3f7d9a22dc331e51e72aee7fb50b57b8fc5aaa952bc360d5ec9c8cc98002fba759f3a63231b5123f8a7611e5a90ac4ebd3a304c74cb1c0af140fcaa5f6775656b8c74e1655822902f873e75d3b6eb01e180010c9af54bbf666ed52dbd5f822607480d1ac3f69b984c9a1fe3249395081bb0c22c04b915039e087656f8dc5e763e414262afd9b69d0ead14093014a144fc2df5b1e7eba2c65843fffaf2ded6c593f25574d86f723ac415176da4da03bab475c7880092c5cac02c0d2e4436c26dce97313bd6deda184a31b9e4ae402c8144738e09bd79b494351a3b8d7d892ea162f87d1d12eb921f988c7e9d66bdc103ce9fe9b317152f189761791bbec6028361bd5dfb2d99c8e946e5b879acb65f71fd0c33e9452b6d8699e575b38b452108b2581e0dcaf0f9cd24d04b6ddaaf2d9adaa7c04f010c95d5425e4360ac97f2ac85aa8c22505dffb90eec6ec589c58831d7d2d819ba7d6d00b4836be1de97c2783357614dd6e0b4a1bed8dece99d6538dec604be1e6e2a668cd9f1517cf12e85adb67c847bb5ffc4513ec3876605b174c946e245b8da903757eb6fa5c971053fcd0d0694e13d4f8c242cd72a30ba8c807349054e79ebe2a2c75145e88d325aaea58076d0d90b93276f5357e1f1bc2067937301d471527ec7850ef9b1e1e5dc265dfecfdc538cc5d3c61c19db5282429364ae8f43a9d2da7d84b08ba964232c238fa37af343803ec85345fc781a5b183141d157c5cfd7065dc2ab17a26c5f44d80889e2092891cce81ef7348515ec2f2318ad889552ef741277c5546387c315fb639d325f8c12fcab5437ff260d8dc6f17eca5cd2624456f725dd5eba8052d19b4fd313df0b1a5ad574d9e7f503e0571eb9c4364972f619f1a400486135ac70bc15fe16f90fcc5c8187e328e58d4e1465f299c6eb7ca89e8b0e60976364ffeef63f4165c030478e8c843b1b60e61d6d5ce4ee1b48160b78b5ae5800ef1c104234563f5fe29fa6d43e26920cdbd646f995f7f96aef1b8b48caa04a2f3052e2a1edc1ac1c007a94a403e713e433788b08712b8bec868d6dccf738db2e595a5cd398d7d2c23ea0a5984a71d38c426e34dbe8448f0b80935c80b6af2edf1fd3d7cf2bccc93214e4e1f9c0588650398780410f8e6ab89296e24a687e6d74170f8febe3166f182226bb76e4049da3134cbd46a5dd9861175b86ca757dc701b87f947a93f704b86c0cdf6c204d4db49d5bfcb3ff5d1f81c809f754e1957bf4a79faea3aed1ba77d352e9d897c7ab6d42801d1fda04be8c62795987c9f99757bb6638c0a802d276a1fba45cc9fa65cae368cc200bff45e16bb34f8b2222014bd7fc82a2a164ec3e49d0f418fdfe61b75e3dd88a15a870364df0d3a9f949e41c25a1a13dfe38c328c960281f8d4458a469c76877ff7849210c7d58edf0adaa17433fd8ac3fbc985d3bf3cf8e107e1d99d29ead170ca373f740e4062c18aea3c7b0ea8e6364b23e4717ed14fa5e64a7aa32268c7689f2ffd8b8e111a3a6f9e7d00a872d751a56d4556d70dbf0498aed680dfc03ff7ecf54d2498d78422c025df59572d52c00ff7e380a9da50d439358feab413edf01beb3206088b32a1955868f58eebb2ac4d15d1876a7802f8c67042da2ec9580702ece72e11e3662e7cdf1d3cd27991b86d1fdb65e6d8a4ef9280c54fe1545f3cfbf2f9d6f2a7d1b50db265578f984cb57138d0518305daf8ac890a05472a64f070015bda88960bd2a45d2d9aa3ebfe2cd72b6f61374a840553b5c02037a8d329c32b0631ce95d00479af30706f3a7a75509809f601d4df0be31a909ca66bb1a413c93f7be1dbd9cdc683841d4099ebeaea5039ee172afcee20269c2da547d551d3bc50ed6059d25001639fe173f98afa886b5fa65db987124aec4216d45a34b7b4f57b6652d123ba74050981e7c19fb360a87400eb32b67c10818e454cd6cb505fbf09efce94498e6b444a850d2224e06e5ec1a0ad2b7ae2fee13135bada5974db4938e564123835fe152b6cc2bccff4b8063a844818d9bcb81c74d72b5a744d708fd487850ebc4fccb1cde7c8b3fb843e46d88ea0e08ef405dc331678ef9b18eed4786b6c47694d8276c6ebeb09869e6fd64703f32f6b7b8e60920af1c11d94f2ad44c9cc42ade0e06760d76fe3da06076f6cb5d274797d86db4a760f61346e6da430583f1b9bb00f3b4049b9284340472bdca9f1ed2294be39d051507d779eab79171382991ed191369414b211ba97e911a0c74b2ddff03e82eb8bffc458de3d12ffbd0b9e6972e1fbf946a6e91aafda106c39a456ab5eb36631029213ab2305a68a7377e0d5d8c3366f24f75546b70e1ddd36adc572c704aec2965ca3a83b9c039cbdb9db2b5ddecab0760877d849aa5b49ad4e71165862e2455d8e34f76aba1066408dfc04097a60e27d1767cc08fdf81fc46758a8c8c06f5a82b82c911ebb18bc082e7b8fea0533e61fb9fb19bede64f10797fe65fc6e40827ba25186b17da48e739499389f941bf2d1502c2b800cde2ec20458c58ebb3e0f8af3915c1d7a6240cda52c2e12f9a65854a856f53be97ce65ebc773cc14b242f34634b1cca7a53879e7cd02ae62aa488e5b132b5611187d7d02283c875dad93cd271392a7e821b246d22f52188b15e4cb0bbeacdd78f53afa4126e4d0d1ac825c6e10b1c08c3b289e1c0cf4e2a7f5b03d933c662d3a95c0b503bd1f7f3804ce5b51c85299880756832e3d1ccfd54052b2512d5413650338cfec24ff815d52a32713d2364683805e6976d5072470d53ed2212c754500aaf17b910c37a4f2a0328f9b0c7c5b02e92dafdb2c256894b88a3526e89923302e60d96f9ea1a600248da9b08261e818dedd95399004714c4b71a4c8139e44d99211ea39055e457b7252c007c1060b743aaa2193c1470098aafc5f19531b584307f0a1d71811f4cc8484201f3d8c4e6dcfad86b408083b66aa68baa091e64623c8a4d4941707372c94ed7b0351e07d89478b17c98d5808736521958851c35591585fdaa265cb132582ca35d13de5bd5b280a1ab183da38c7efab717c9f73c43e619876a4472a220cf6facd773daeae1e7e4a14b8408ab434ecb404a7d22d7cd03015b152738c5991d51b1da8a839449d285b04962050646fdf91a04e9a256be46871dda7b08467f073f9e4c16a22ef1a1a7004db18fd744dc6a6614bf0cb24cdeec624f8d2e93425003c955253814166e2ba9f724f9d3981231a984aca226b059782247de17a10d34fb6436281e12f6976cd4ca1c35f38eb5ae1579d7ef71f3be1efaf5f1474f96454c2ec66e8b48b14251cc324500b857b91eed0f807011f638c25f78c59f36057073c14119e9008b8e93f9b3714811d81d34cfd4ac42a889d56dbe012d477e5b0796bb361ff7f705a57ea19279fa12451674ca32e56f09f4f4af0c1d3f6eb340dc37fdbebf8c320b8d6e30e03ea604f15fd403ef83462e23f6f797b7f221362d7b6100d5ed30d69794417fffa5e61086bdac16276a4422d4e3417f1c8798c52200f137505281aa96a731089eeea7b539d34fdc5f438b1b1176c9985884fbc160596ecfb6af59d2f9fe59bea12b3a998beed919992b7d2ddf7c9c64a23855887e6ae45b54fedea0febb8b516a4c313303e6135a5c87218f6f4ad841b2e807f7a18cf5b47a6d34edc10324c116cf5e016b3ce45b358b39afe081e8fb65c05938bdda579730d0b0680160d51a9e03645d2336737caa5c14c8571a1a69e0c8066b4212c1299914b52931bacb7a07ef2eb8ee6c20bd0b46442029e0216514e3ed379ebf6639efd7e38405598a96c1ba63ccba5d927638e942ce0178e08ae7b0f597bf45ff52eab7c051d521ea881e55fb42792323b5984031e67459c1bea391185b7a0dc7827ddb088dfd712377104cb7c56f88f8fcba3667bf1632b080c90ed36cb4409b3f32630906a9959e2f68755084bdd6dc9e59ab9e05511bfdfcc3cc635bb07ee0cf34936f5ece9595347bca77606690439bbb274e755b3c2ae0aad1ba054cccc19e77b27b6180a080a61c9aaf206305a83adb9986f83dd05e96a33688abc591f9dae66eb279fc8aba2bf6e7150c2202de901ae4c4014c811848c03ffd15d559822132f2053cd0b061d37e1e00395c99da31b6843bdc1ef7c70c5c4f6edfda48926e74401a33aec9b5d9a6c5b1f62b48afba6f37e558f742bad057281d1594550bb83a41c5b4b516f8122c55023ae59feb51ff74e07e7c3fd810050941ee7e20eaa0ed0904086b0d91073f18b79cf28765e20da4586aad723a933d5d0703c8ea5cdf32922ebc58b558f6640f240707641b2e3f4293e4cc8da3b67e512080aab388e56ade5742c1a0c8da7f27753f877f71620e7250f189d7c055d68543561dd89f4e14f69023fd91867735b9a7cb320ab865422f787c374e921e70abc4bbefe51d1413b037d1e48cda518f627fd02963d24bfb998d8aebc11b32ae9c39cdaa082ebc15a5682c4676aa8b7ec8353726d9c6301c564ad3edc1e3c0169e560c1119ad3f1fd7abe17a9e20267fc2ed28316f3ad6997b870a754aef7e3c23c27041731bbb7cf2326dee07d1ba7eaa2b76341c8dd37ab13809aa804b8b1f931819d6334af167912d9a76105f602eebd7ce179d9c5fb4fa84a9aa4dd2eb96c8a46648f3a1574bbd777375eafb15c4b72382578a8d2a2aa2d0c33a397c893e652fc6aca92c13482cad4df51a90628d37dfb98158462461b6e677f150b1921e3e42023f1190337035a25b1d27fc48f8d6b0b92f54c779be14b43c509d286a01ab0547cdddc02b507364b9a720b3fc69e8286725d800e9758a628f8e9486c9ff6a60abac02ef6b76c3b282c9c889a46df5f322b0c36649df30d5a9020655db42fb99200934ef6b5dfc73d7130689a819c9ff7d9c2ee4361e1f098302998efcdffbd4e2eadf0136a80cc5d0f2f1fd818acf1249325147d1dfb4a708449ac1008aa75f528f7a4dab906ca29071ebac7f53c8a48dddf228738fdd44693dd5d69b20be8aa2077856f75eb8cc98c256e13d7c7e791eccaaf86769de13a527d9635130be57f1a79e22f9e69ed3b9322b7e2deb1e1e0f51bbe10cef9edd64dd4a26349d897977acef5e86b6e784b66340b4ac4eb6cb6199d63b1a4a1053e9e358efe4371bff27c90e1255795b9249987062c0f7693ad55f3a09f3dfc9b8a5962837d86eda5c2938ef2a1481334188ced56ec60de9e4799e07a0faab948ce2a9942ee5a5bb46038329b44a55d32d9f595cee10db93e6d6ed0d32c5e7941eea55ad69b7ec50df655a6509bdc64fbb106057be3a56b1cfec013a41df6ff4e4b40d4b3d2dc76c36ba86bff8df8b40d53a978abde79c6f317ea8ec95a75958f0c3211b34edf226b87a4d46dc60e071c8be550290195499d1b259c100eaffdccaad0171892565440de3e43be26bd01cbecf1f00ba387ab320ecaed28d1b581c2f6ef269e0b87eba5b2943ec6e51ebb54c24ce9b8ddab6af96f8382ca69dc9451fbd177ab9ac90c948a99a6380893eb57a9a9d1117f9b71239a99fc0357ea10a72bbb162ef020131106805d23e56f8f940dea52b108898971d9b154d3ce9dcb583f5e485e606d18a92b058b75d23945d46c2994ac5972bb495e6f4cbc8adb510f52c880b80238cfb6391796f37c1f78ab44d809c5157595751010c58e2f6fa6d914b4ac3ab81f7253a7dea550022c61297de63410aef7db9db3cefc8203a5bab5bd86627fd2dbf515582ba2247168b15e1154fbb9c1584d1fba158fbba371ee11dfc2e509094f3e80ad185dfac97db3190dfd5afaa18967b9bccad20f27ef9b1c46723f3a5b3f179af4e12aa8102322db2143d77120bb59b0c48a9b835622c1604f28bfbf77ac6ba18654a3504dce1a2b1f8795b2f10cbaf11e4224a0b7b192bc04446ce8e521119c8c3db74c976bb20c65b349bac317378481f8072e9e40de74dfd3935469e9418b0f6472a70020a717435b9fade8b2f1fd46c7b5b8a515a10dcdc2f6bc33635b731153f93cd5087fbc8a4e65a035913d1c2295795eb053e20d8c2e841f2b209572f40ef30387a60368ccf2c844eccd2a034d99e82b4ddc4e56ac967646b6656496fbc8f80f1ded08650e5d808c6a3accef57a0bf5ef3823badc97dcbe28ebbb6610632ce31bdb41b3f90080af4d70d3fe9c762ac066b46a16c828cd3893e31ae7c2dcc33f9a4881b1914baed7d9eee912c854399ee50f69f4ed7ee15ebf6d22d8ec4b1eeddc13350d2d52915b3e66b7f162f1f9140bcb7c4a44364bfc32f26e5a1287c667ab27b8dc129b74f129d90e751a87b080da6e234558d14b57b9aa3b582a31b7445db7e6d89cd4bcd46eb83aa0721f7c8d51905a39d43fc13539829fdbdeca9bc0bd1267d1c604aaf5e24845561a1f13226741be08a9fc59526150527433b8b1393d7c89f316a1d834b0f805c73f313a0b5ccc5f08a95bb03d61396dfeade9fb9adf3b2259ceeca8e78da3b2b514c31173859a72c2653d337c422a83073c2dcf75e1fc9a915f46da36c5e818f04d75adcdbdbaccf7551bd8361db88e12cd66f118ca836fae5e56874123fda6d0a9a285210128a2d91b497e5e3f39a1ad27b4ea78471597ab53273b86dd013ae60375c4e6929bfaeaea3ba5fbeeda93425fb1db8aae8d110e8db6b2b934e75b50c3431b870d6bb9198be6ec5cf3dbcefc8ed5185dda52da45c126c3f67f2d481ebd5c0de3e94ed4c0dd51e42db22c10d5e7a01514e17ec88543efd146299c9b402c4995455f839a2b6e6c7346323c0649b6aee33954a662396cbc56dc2fae7c4a12cf297f30de5e4c5c265b223a8caba91e1ef3c75eff3a0e06e1ccdb303e9ce07636864c5f60418e426b9270e9dfde0fe64df64e056013f4a554d7c841ce27551a383c600880740cef2918a2248e7da53829ca84dc1a4d4cba209e3cfa42908fefd3f23af9666120c2105b5c084c591f14c4551355a824934e2bc37fbe67da455c652570443eed547c75e8780b3d571780e24c59d714de3eee0080963d78b13728f4cd86409bdd1df87fad6641015cb511226a77d21e9725a9d060867b4504e2a060e3771f859aa16ef87c6b8f7db6628958e383b507191e2413db9c535508a8c9eaba1f11748b94e9a396c5a5073067b9ca7cc38e897aa6fd2c116fe8d47e2853afb1cc75f9fbd272145c29aada48dcb145f91ff5c3a5a67517b68b3527a2703a13c8d69b7714d7d171a9f3adf026fad7b6067e8b30fcf1f65d071edc68d9b2c810b10f8e8c3d88f1142d89cdc4df069ba923efdb1afa57f91ebda96e3ad5f5d743407ee48712d80c59fb51d1913b212fc1d4807eaf91d0e379b488c9bd18a5f289a0d8825e22bc4e29475a3df23f12013b8fd58aca84392fd0a3e29a058e61083dd203990c4a91cf935dc78368aad84ff6201d0ea3a9bb692ed07bb156621afb8965ed22792808042229b2820f2ab448b3b148e8dd773cf58cfed605b21469e222b9cb95b356c5a98cac3e07878f4e40f6c6ce2ad69a55ba6ef32680f371d0021b5ba613195a3780a9e01a8a0e269274310ac377e562b873ae165083db23b44e59018895d9c1d74ee67c47fdf2b61e524e4249fe8f29634698dc9e3f406cf35ddb3cd7458dea65229082d1a782cdf2adc210ca80f085767bfc43af199f28b1731b30b8004af6cdd222270808eb0a98dc6a86aa6a8b91075ec2697bce2cd91b0b02b97135c256ecde80911d6202773c83ae3ae0bc3044e6110dd618d0dee7ead80da3d5e7ba085b53ce1b496a705d5f2a031e04818397c69b5a675593b3500fca78c69c7795d098967d65a2792f8633dc521469ab902a06db65136f0c10cb9246442956fbab936210684e19a3a0ced3c46b470d5a38421950073f7378d646fca802149aeb5c01a10dec6c3038bb2340e1791e8f602a64598e2bb443ed50610f7b9040a54c48fdd89546b51b2da0f0b68aea0b6ab81b8a52581184b0b7395529242b3a5cea4c69e48a9e9c525630918f74558cb12a06667a35e0aac53175f750c9d30ca995af888be9c786c3ffa06ac0f3ce806ebc19da4adadf040ad54de157a471eed0678d512ff4f4897b1911b36c553bd72738a5e7ef2adae0fdbfb994db62acfbbdf6a975dd85916eea6dd3f006c17d4d36620995c5ace1441a43023cc68e37d56d5ebbf4a405b2a372eea7719b29695ed678c070337553391f2794c2a9c4b9b42fde7b9901a99c79b0d1992618d00ee4345e3a5d73489c03b9648d1130692ffc828ded8384e48ef2e8e81f9d6906ba2b641b58edc2502847411e636a1a815c500d427924a7b3d0ba7e43723d6009913a50bb82e789e550be029db28147c9b355b8387ffe438124f794b3fc1073e449862966930c689b5a9f0b0f9cc94ecc047e5ea01d761a72c5c061ddd5bfbc93a95bdfc796371df21aabf065b7151dfb4ead88a79a7e5c9100bb692917d35d7cc18c222a5fe9a8511c6193c78dcabe4c4624f0a35bb0b88cc06c708137a98562fa5f232526f9fac8e27dd862f74416acbad9ddd9c443ef9c49ab141105147a37dfc16e0e02c5d0c2dc6c938601d2582e41d62c8589e6782e69f1bc7dcbe1e699d51adbb7995915614d5bc70909bead07ea0c43c4719b2407d13c0868b1a95b7e9d80b6ecf16b04357493a3262ce86e923cb9f75a7be7ff7e0e864f47199c19870f5f5624372a431ed43b11a8051e3de25b9e7704865569c2daed149dc8272b847883dce70e692d7b424406438e28c5aefcacf83625d7572dbbc755da7676f9438222cfbf8baff0f8425ed1ca6581fadb413960a4767ac13e5a40a32c287589694550e92e8abe0ce79f5f5c0f43604874fef5589904c150f25d5d06bf1baacfb2f6f658e61186526c7abfce81e1b8502bc174264727bae18faf51659df6e37e5e649213b2251d97ac044f6ef5a13f6806e51d8872e81042002ce5819262aeb930853421ae749733648b80e2b6684008f0fff9dfae57350084d50e0bad7c38a330d955aeebdc060c186f5032726eb2f300f6dfc1bf144e9c889c3802587e48df804252986320c415c156e1f4ac13c12c0d40970a862727319266194b3d6de37b244a70042f504aed3edaeff08600f9030b51588e98b83c7d31dc25e495a5b260ea523cbd0fdc439847e1f402c615b02097dd10f5f3b8066af4b1db6b2df51628c68c49f24e6517373e9f535ff5ca0ed2edf34e959ec2d2dbb4bf62c48c0064b8507c6c74d01ac323cf21def37c54c7a83638b2a56b9b696fb72a48c572ab31b7f928a0043841fb7ee8f35be9496426a2349120954a07fc0c270ab2bdaa4747e80f9d038e9bb3d75ab1e4532f6c8c51a0e51d542c64ef15442fcb306b14186784df3274a477c2c383b0bef04ef26013b46bc7924f455445855f78b0884311e28cb8f15ac87b4f663c5295e1d872cf5fce6ef7cf4bae452a4e2d924360d0c75b0bccd73297a14a6eed6f34402223ef52ea0be502629cd26874faa9932052faab40563bff02eb43edf0f8ae48088cc0623a4ce8d9b8b5edbeec2d51a6db5d7ee9ba9d92c0decc5ac28a668cccee78872e15d7b834a384c7e72f8904c380f7451bc2b2533930c50c80aa3e9b15cb48684f7fde8976e6b081d0f76e724237d0b3c5dd327677d6cfbf41df3752d14a46f13ff98d11751ef6dd0e1948991d6f2d65142e30a861af1ea88f7a5e41633bc65e72ae30e90341b2a0b0513d1eda0058d9426b55934eca0146a2391c740e6ed71ee759f9c5c438a38eb359cd9a1a036d3f490ca92a9dcfc7510c9c251b7f19be8a08a34ba442d6ffadcc3e6979f3030454727dde46770dbb084ca5a37cac7152fa0787f12c3edbedbc8dea75b757357c4d4beb0159560f1b500944d04333653699a519eb542ed49474587e4dbe5dc1b2a40d2f1e57378457bccec6e304bc51caf8fbf680cd00c2eee51e2cc1dfd4f81e1a250d9a223273dfcdc773f4b30bde7e2a3f71c465fb2bc1a44f86a3c7aa5298e9f409b5faaf2d7093cc508d22e1efd0d08e20ce580143ad62a9c99936752507755e532e07ebf7f272ab4d3581d2d31dfee86b9809c0ae8a61533d9f0e7c5c5bac7de88bcc7d3984d38946484cc5c090b880e9e669caf3d362eb9e7619c2afe53857de50a0a33f6c0137d87445dae83acfcdd7aa2c2afcd5d4bcf445b7419c3870247db526517e86df7e82fbca4997411135fba6a2d52be747eb5ae004021b7ab90b6151e679b04553d388acddb9aee509c39de28c0abf60448a481c93f13c5f96f24b2465306f3c5ec213af6e6883d24ec613436bfbc2013ffc5120489f0201dd480561a385a00e9f3fde8fef48e19c5bdd10ba32fb574815cf3ef36f08c973a2eb5d87804f4b9613d261e9e4c4993f7ffc6110ede6983de4bb4ad906dbe9e054f08b175e99ce6b0819fbdafd4bee72eee00f2be90017989425098db327ed48821da3e29b4c973f59bbd58a8853f6812fe9d19c0a711582f4cf598e72096be53617b813907b895ab951d4603c2fdd281b76c5defaf931c58ba170f31ed9de0a32f846d27e3106f15ee8c373ff5e74097dc7c625735912047ab4a042548b11cfa1a3b30e48856ce93bae493ad93c2f913b970dab961cb03750a06a93a394725061738daacbdd6d1515142fb3c4d8b1af226615eb37daae38c6fac90eac2c538be21e64e41afc24c3091f1e0b00fec102f25bf76d9b0de3cb5d5ab08a5b75fb132f647e027611c7e266773a082188e1a861223c15847ba279b1c833e7244e6555e374d90bf447e3f3d8d28a75317c6417f697e2f5d63820f176fecfc2fae0b29175f6aa9a2eb2c720546d4671e7ecc587319434218f07d5dd75593b06aeb70e4dc333fdbf7276705b779233333c957ebaa8c94c1b203c910c6cf9c18a4e8fe36a124fb22ff52cac31ad3d2b1ccf1d69893790a6a57e550f41d829e9ba5c8c97adaacd0b08602418abce3c23e70c1a66848a19688309f7d5ab43f0cec82f149699bc1c83e9e951b4549d7803611c3f38b3b0b5fde473b092e361be5d478cd5c47e9aed148f3245717abc9c368a2bdb2e472991ef3d9b0961fc717c99e51c84c05bdeb73f5b6dacaf20f7adf070881349f340bec28d970ca2012aca46b49c16b1513d6f1198e4e0c7fd0898426f1e04406114de0d1c97c4af97c57326b218c1dc08f7c793e8d64f736ee46b8f9654416c312bee78de53864dadb1c1e4fc037bce0f88b1f52ca67e680fec5b329ff973c971f081926de774ac34112777f756ba5373a83a19975cc3176a68d40b012d783870a7579f1132b568d8008daa58b88c7c4e2361fd953864c94d7e7433adc9d16c6648c2384c11372c921bf28ef623ea6db690a64e0ccacf74677142a568c451def20d714ae61cfa54e2702e910b64fd94ab3550449b589e094d95d377869c025c278a811a9e2f76cad8c7707dd125d40213d056138962dab8c694c4b0207500ff2fc24ba387cfe2079ed788c36d55165d03be193ba63abe894d4d2a8122b8080408f113c8420b3c04b823e2c3d2efa1fa5a83a3c50d3d2d6a0208d362ec312279c535fe9038649b2b20b2e6b678d22000ab049259f0a0c79a78c58d314d0da3e657e0e4f2f2f22e60db421712fb3ed7ee04eb1d5a503c00bc8677a0168c7bf2c82dbf23640f9c30ad9c7c7e5efd3271e4ca6bfd816052dd2b423e278688a5cf12d574fd278d9f79fb635f38575fc215ba3ff77d8f8d094972a0cda0d60ba8417a34b808f63b36d3af78b7793af64617d5ab03c3e055da02d7913eb22eeaca65a526dc196e3b8393470d2d993928df26d1e458af683ed1b72dcd70749df0e9b74d7a3ab4bb503df5f86abaabbe63b6f97df3cacb73977dc3794c2ad29a552e555f9fcbd9f65ee18679f1de0879afac5867c88242f131cc43bc3ac4fbc0d33a6c84c635299d7f06682ff5627e420e7820d84726303dcdaf73dedaa48b4a0df0705fccb97e3ddad2de16c3c0cf9e283b3240dfb3cb9039ee322d646f684845df6de0e961c9a1789e3390fdb993293abc6ff9ecaf7e0e97b70ee80438192d99e78156b70c34fa11a39138ecac4fe368ec30023bb78195c15c760f8ef28038ee202a780010b6d771ed53c15c25c9260e16f4c88ac32a145c8b3fe8fc76aa976bf4efda35d6d90180e10809cbc9087dd5828169e179ae00a111d829dead42fee86842b9e6c5ee3b40ea9277f186278b5bc18940e24cf645f0ffcec29e4d7c3fbfbdb801f5a8d3e82a81299d5d78e32b45422d532dd20671276bfd7710c93fa23112498f841405aceb17a4fcbce777207f359ef75afdd2b096d3a9e8a4c3ed794a89ce02177032f8b9044e7a91b92018031315fe95ffd78ae289492edd7377251b1d67825f6c186e91b97bda630fe43bb832596f5259b6dedf59df140a5b2200dfec6f88e58696e5593266e298928a4ffdeeea61512af9a45198b3db84d27e57b50106998988ed36e4b36f657853e191acff495087f4a351cdef0bcfecd0e6570de977436e20873ecf5058b939b007375484daf9593964904df2af3fe767d647bdaf648c2915abc8d01f509bec75b86292430be2f93d956853b089b56ef17eaad8596e7645fe9eba3c7e00563b859c1cab241007b06f9a74a28cdd0e55ac72c03ec3196c5ad808c67d9f088a7eb76703420565d29ff52347d9282f7b04c38dec66d7dd3fe13335b3ac4710fe8204b3cbe25ea002ab4707cee105b6f4917bef5b63228c16fbd47e27a66ee293e10541788d4acf6ad4d1c677e7e7dfe2caebf3a3ea3886fc520409acd35db6768494696be2d17fd6252dcec3b3eab2ce050a6efb0b1f7dcecc0d13f3d17344ebd8be6f615b2976d60c65dec1d31358a23c822265db97b205054bc24b9470fb245a3de8fa77c39918f6a8d8513a5579957a5f19f14b44c252bdc0cfddaefbc2bac6a9f8f5a8263603c18360a88057283f9fb45526ffbfbc5bd7704bb41f0e0224ccd5c86b65dede327eaf2cc74f7638b5bec9de4f2ed019b1a91f9b31a11855133bb79474b0d3503a1465a4142a19247d9fee927fe4a7fd50a56b2d16db5420b5a6ebb3688248795a9bac6fbeba1e6e374cb0a10e08e4bf2c775690ff6b12532ed96c27c1c87c3428627fd028878c1b674e9ddf17e6f6bfae0ada908da966cd1d929cd6410ff0798e7393147bd82ac8898b89a556b303ffb2b1d04fad372a8c4398ca39e5aabdccd2677c5063fecc281f22a3c6d6bd3c3efe8e909d20746827aca70058c1058ca38382ba82aa928dfcbec035e0ebab9462279d367999b02fe38485ceeee6134433789ffd4817407f2b27b658f17aa26298d704eaf348ae17b36986195d24270ad94861d7e81be9d78d36b94fe8899a21dce79be7b3faf9e53b78785789b79808566ef931aa06b5cf49176c56546ecfa8bef0e811f00b15e53d054c62844bd436afcbd5f18a1d860d0af7ae25ce40a8d629eb4f56340880acdb871585e81ccf1e1273b6c98c4a8bd36e142d641f971c0f83659bfc76a9da6a3a7f681c433d667cddf8f4cb5a9e1747090749d8243d4ab3b8970332868af92964501297f43370e1bbc691c7395c418fb4d3374ee887d4a4846c7042bff9ec977ae4414127e47b48679ee8aa3ea0dbb1580a14769b3428c8ab14e0a944a12afa6e61509dfb8f2bd2bd385b651157ace3e57685680af6ede5092a04115c071e66945e1abb20fec37601d7f7fe14c7c86d277254d8cae7f03dae05ace31d5c9de2a18ede57ec82c5dc8832fd72510b08c6f5faed3f207115c6164355e545b8908e54a0bd91e021371d2d5d771dcc32156a810292e33569987d9663f6c1c6319fdbb5b8335ae2708519eb2ed7326f32a20714493c784a373931fc8435fec451f97b893bb6d894e801ce418afe4c69881b031b1a132547e97a89ea5cf22d47117852884bde0cf43a9791d5ba1bafc699b49f8287a1808d2cd5b10b7d9a8eeeca7f740f34cf87a87a183bf1f7f6ca32eaa76ddf455ca12b3b29276790b07e9aaa01f8fcc43e7d626bf12c9b576a0663fd3b4cbc80326957112551610e95666a52b51567362ee5c7337bbdf3ca5014beedebdc1163a1533d9352b23d162850b1518c9eecbcabd170e19f1c025b0d5f50c2a95dd06d7dab8dd4df6951da0677b2584a9196cc31cff8cd6ed1737956ef36a190622f00b17fa6aafb9b63ad59a9799bc29220e9d602aaca0a8556c79608ef2420d487ff7f7193a6727b4e3c54de3a878362fbc98c041af9bfec2647b3f41baffd311b2b883245b82884089c0d0f8e176dc6e1043e042ee099c2612d2d51c64c8837348b4123bc9caabdc0b0f126468a850bd07ee465a9537c3930d44f9809886d209c89c2b141b4b1c27aff24ea8367750f6c178877ce6edcb6d441f523692bb67ae1b1e5ab11d8f0c7cdd4f1fc444589535f4e618db3b9baf77217c8e030a608f9741ed66791ea71a1d4c75316af22698163deef49ef9efa9a7b898a9bae0908f0a62cb412fa7c2af8fd61b6c8138d4d312be2c2a5e490ef05cdafa31da24839abfb8947e4abf22ff5bd03a82881724791279a17d0698cc496b79dae71572eb3967dee98b7f8a3ed425dc02a333e9c69f2999dfc68860f4a215684b41d7c34bb75c2c598557f357249789aa2d5c4c21f48e75d50fd2a61bfaef25d630e1854516df572d6978fee6ca1f59603610d213cc6b85e18681287a354a16e4877db253c9d1cdd16e2801a0534a5f4a90c9d4981b2850e305f2ce063da4f9fa25d1dcb3eac76c10c13a6ee92e67aa828874a7524b6464ad8b9df2bb2029e30935f5b3a3a9a53f06c96304f912b093919f4d6f8d29e560ba72970e42d50f441093fc538d0bc5869e9cdeaba47f31d87f23e026519ff149aedbeaf3571e298da99e7d682d157af9bf99124bca42c10e496d538272d4ffc612d160059a8c0547a8ee692812bf0a30d9993e08df21153e2363a6983e4edbdd001b9502a4238eabf36876c6423a95ae5e1bb30a1df4ab79d1034f248aa053d01d20bf84f9b045f42e07cfa6ba198e7e1e290720d8583e072147eac22419cadc8e2faef31d129b476056a6778ebafc72dfca0d7458c3d4611707df1261c62057c1e51edc5d86ec5d90436d3acd1b0711e5c601f7f71cc2284d4b54aab0b9d19eef47e6caae3c3973fbf663b769f0379d97597b7cd78dce213008717a341dbb3f6a814290ec48e2b5c8f73082506eb304e0eff4a02c05d30e3a2e7ee10f9a7335cff940a70ca809eefdde5db83e418f2d0e68bd68d7bb97a3983b2a401887a6bc61aa87d42f755842285d10353e1164e5ae1b24857915f572f8be18a9236eb22a61930a52b06ac989f0a96e5cc9600f44c4c4ee3569d1222bdb19ce619626ca2238d160cff5b35349e8697a6fbbcef2af679af283db85f24c5466a3509e7b8ed1b22bb917d279ca216f3d0516c16271fe7cf4ecd05dda69bde609e9b8be97d8239e1831f52161d9b89fba5fe1bb934dfca6a70cb0b6be8d4871db51e492fb168da69a45bb30165a65ed1ac909c2cc598b5c3226fcb3c85e4f286204d61569c49c3fbd9e41a8112fbb6f4a68fe0222be8777ab9bc43ea72d5c1872d2a82c2d0546c49df3ca93a40e6faeef2a9a7c58ec13ec8e85ce492cdfcaaf72b96af2e03c179a244e32c866b3d0d28f04d786309cd03742b59dac132ce4b9184ffa70fd52947aea4a521b326ff19263f3f7db0f9f213e261a0111a338a001dba28ef68241cde1d7a5f44c8ca3c50706a78bf79510ab868f44198a5d18d4038df34cd6299d362c5babeecd634ab82d00cab510f98a7cef91341ebfbdfd08c56e1a5e68621840e8ecea36373f70b4412783c3fea91df448b70829840c8bf7d4eff4b93fb59c88aa6e3b845342359e6dd1ed6614f68c37f8b0953a070eafdb790737479c7a285e6b078e882c02ad12407f365ddc6d6d9c176a8b2fe187edbcb7c9f1b5e47af786e0711ef34b76f04f7dbe15a085459d91ba5fbb54b353e57a6f4d7f7a1f011bcc971709d10396379d2887144f20262cc88268ee86d73c4e625f730a9faabbddfa5c160b023f240f907294ddd6d01b769cbe834d248960e4c69bdf7c42a319fb7f69ca35f4cee8dea71499d268a0ac424cca0156de9e03d3d747e792ba43c3210f823817398024fe2afc4313052b71dba42baa35f2797397e9357c3417325fd5ba7d0656d3851bf999a53b93c1c30ed0bc9d6c4641aba8b15b20266fa9ab8c70b74de52a70de1da50776fa97f8af154eda48507c1480dd5eff4c65418fc09b56115830e7faf800985eee06fd33dee25e0d2ed108448a44c09783fd7110915ef870ff1c272fa592c84e837af7493b8d8fa5ec178cecd25e9f9b6f46ccaa404e227ea4f21b389026e7d6651a57b414660b24cce09134d2d632652e88d25dc0d788794277ecabe628078cef50a8e835eaecc41ad950ef070753d1379818ba1941c212cc69aa6a5b8c2a8d33bf486449b9e6210735494fd7662e59b0886242d2d6f1766d5ea99b7c4deb2e36e9ea7121a9f8b0c5b12f396969ce9f1c2c520b656bf65bdec13b55b4ba5605c22479a635eb6976547df9990636d966cbf8c861f5431af75c34e8af8460d930fc05b4ab9ef192f65ffa7dafba207b59a379098c2bce3bf8ebba24e5cd65dec76990dcabb33c2cacf30189262c671a830384d2413af92d16d7ec1f31e62d9e1320ed588f42943456035190b01f243583afc67ae5c753bdcbd5635b208206621cebcb0fd6e5d9d50392b1bb617d8604bb718a6737508ae22fda5434a029b40df700b9a59ecf85a09a0b66a1e14c0a61113710760fb3f944b050be62740f0175bb9cd4f6fb11e1073389776e348784ab4537ce8d18b743e22e6015a781d747dab0ec231d886628642afa9c2a5a6a0914990ce81288b8f808bf7e3d3f1ffa30f083d372f5105310866a6e03dadb3a474ac8d82f1d47882b58955544d206850b02f4c7c397176b6592f206f1462c48eb4f14feef56b70b31d364bdc095c4af96f076bee62edd4f84a2a04d7d6ad23be364d73b81ee06c2f7c8237cddf7025e0e86d667dcd7228e50ba5d1b5ba4f155e17db93e21482542caa9b733ffce60e6a90b94709ce89763913a362bf346273135c1f3e86015de5ad1260a965b8447fa9dbde4cf9b339b6899b88f28430153b58d6763b622261cff1cdeb98922cf807ab24d57dffa966917ad30f6c0fff2f301d3c9df9a0c9cf765f9d7799d4e66f155d210406fe34c51401e20a4640ae32255d94e4500cef36ec01dbbb03be2104646331a70ddf720f61e4b3b6827650b3bbf37a8811be987ce18eddf60d9c5109b9ddec73a129f0111c08121faf3e6549bc4d58900d337f06d1883911baac302024a7ff477081c32a33543bbae907b9a306cf9dfafe0d205ebfd6f0c62b7633d3ac3da712958df64408671a4157b1c74f4f77d4a7598574b5071a39c1d08a41c4c4e8ced7b6a6d8e81c53ab3b32d7631ee13fdcaf1a997bc234024f319db70eb566064b918e346afb755abf6e481fcfb5c03716404caa82b0d8be830dd531a0f96802579bf23e7de107ff37469aa1b4a7ba811a8afba0c6ea367dd3f6343ff3bf11ada373edd7d178c3a0029d92d1e2b5cf486e390f59de36a75525fc3160a7832a4fccaf00574be64557d2fcb1c25c869cceca4ccecb9f85d70cfb42c25d9311026233e6e70ec392f2ed9812b4881934d38d865ede89a21dc3e7892d09d42e93226a45ebb42d8021b5384b3f0b6d7d9df99fb72672a2dad2bcf67c1e09e4ffb4f170ee06abc20fad035f85f142055a35cbba4c0735e7537e62b8d4904d64cf00251ac00d23672580bc6cb4a6abb1f6654dc24f87c4a52412f70c8a22e3651b2647b74de9af134e2b0dce7596f716e68496703b9b9684aad92f3b501f646706939f8ee2d797ae1d0e9a2a561237d3783ccd0d841f13d3417637858c07e4445b8b58fb885868b4efa9fd3dd0445db4bcd40aefecaa7efa4321d712180c63530afb5041549ea1621b7db865511a19fa507618d399c102efd41292fcaa52b465fa85bbdea4a8b81235e7dc1e5113afb1fa25fbe9ffee8c4597f39756047769b86550223e9abbbea53bc9e33403415837a0a35ea4a2ba95b3078755a5a40ae9929c5c335085c5d7eeef9f435d0ec10568c76628ff85825f3777bdad7bb4948221c0021695c5a94a37fab0604a083aedff08da91871016fd43416a5113e4b040bd0139fb35dc89665cd2e67c11c4646ab841a89fa4f3ebdd231d75c7c3ff3a0554361ce78512145d2278217389bb9c833364cd0037fc38e525a382a6177fa9cbbc2d42d7b37cccac2bfb0c59447dd11c61cb450f8afbb58da3cc014436a4b9f3885f8525b07cb4d34e9e0f00b4636c2868572a2318f04cda2c3db0af194b08d42ba3d7a317b41298420e556a07cd076680e22a7eb64a63c2567c03663b5ec09e753a5051cd776a81f159238d3267443e3ad98c95aa32d9f1fb3e93952f8bffcd2c5d234d64719099350debd4e9d512592d4c7f34af51570b94e542d9a398ff4ef607fff8272d37b30a37225b9383efdce177bef4935893dfd6270c1756d080a998a2b49d0f27c8947f05bcc081ab574ebe54ae33400cec775d5b2056d867aeb25ba6f99bccd5889f781bca92f9e7669c033c3131fc9625eb47c60c51000834e497b27eea3f8e806603648f35c499f158f20b3bb8b71d435c26f05f5a6e77dd88f373bda736666eca3f49a31047ec47d6787310b409cac1e6db8658e6212a1cc682ee2658cf33071f8ff251b27eebd5e9f547c1e0bc8e334121705c7dc0f2f2cf7505a2bfd7e927952f774e70125214d2e76d8fc239d8a510cbe4027f1a7543d997d16295c8e2864ff510378b3dc3ee99522125aead9c5c739b11982a09d157d45b38136ebbca30a467b9cfcd3e3973d174878f8145bfd8055343299abdf3e7b54e223c2436029ef764112bda4057ae97059bb86b9cbe4d5372e68b921b055740278164f4a903c28ce575abd19e961fa275051ced57e27c22571df603e2b1de660c876566d766fb301e2318eedf5b0d8084e68e2373252242a3269bee18035de8e1b17c2fe2121186598297247ca4c392e71964979c25f5a0409f5bfbb1661b85d2bb4fd0747cb01521662f324670f89302335f01cb61a4c2df71c040da8f6aaa3132fa06d08151d8e75a59acbea3ed30dd653f0709611851e7a2ac49cea70cdb22cd41f2619a5b591510aab8d0978d42b82ed783e98c479987b4a8ffa6194c08f4b39620de0b76fcb90daec97d683bf219ef9afc7fe648f5da20ddb351c17f0196e7807004caeffa01f6cfa1f2e6e6a5d8afd188e23d8a3fa14f752cf5c50e9c47e2f767c215096e651374115d20dcf042fc6dd1af5caaa9e7add48af3e8e2808965c8ad5e00b153d8da1713bd56034bd4c7f36e5427e2fef615d680d63f491b75917b65d8b035affdc95ebd3c882e224337575704bffa2a4113000a82c21f0bae0d495417939a1166eccb57a9ce24abfe6014bb2c9d00c85a4fcf4ced05050ee96c3bb0319c676b2b02798263c145a539f94931fcfa41ede7b7ecfd4bffb3b6242673e98434b1d94a928216bcc6e698f03c3c6a8490a454ce1f1e969ac6c9c470dbc4112c939b618cb0c779654d0b91192df3bfe193fd1bba0ef7d3c1225d39a465c6c8ddcab997f301c6abdc6493677fb2d8a103045daef41fd86e65d767cb4de62188c3fb2b76635154077e2dcbbe2cacd082329cba4402ec526da1e0c4b9d79c53ad10d2f3fbc7d39bc3a8cb46bf9f8fd4d231493a376c65a824bdf2ee6782c25eb4070f064113e7b55c2a02c24e9278bb40c04680cbaac9bab3b98745c1db9b7c5a731aaad58ce2a63fffcd82ad85141a0f70d88cf816eb1be7996288aa75665301288ce44013509fe671ae8c93640e1ad0d11eda917f82ba5b1e07a6da9f742a48160b5ccddbb514fbf6780b2547d362a661d176480d22bbed7cf7101041b8c84884690d46841334062007f0720293d66dd1f99a6074ad14c895e72cec586e40b7b3b29b6cedfb0494d2a4181e61e1fafc42c888095aadf8b245979e1fbca6823337d8f10279eeca298f631ffcfceb100a40051f275a9ffacb12a8f1467879ef8ea629c833210c043e89ba04884326f3713a08da23ca65d6ace67c9182fdea9b1fa85d149c3cfb0f4f4bda36b7f00cce8d96ac8e2dcd9d394890f182008c1eedf85c7928d2caa668fad7f36ab9df966daddaa3a7bbcc6383e91b474d1cde83420d1e2136941e91c4359256a4244baf14ec954036e054911b98322f405ba0f3cf51d17a69f1382f3b2f52707392f196a0b5c1b8f4c10f834bc0b67b95422c41fbf4ae2a52acbb1bfd605c63e67903e45b930629ffb0e532538a7d7651173808d6aff9a9b250f0faa84f6b61b9f4d56193790b360e4120622ec3b5e1ca6a84dd33e0b759f84d80752b1957235a1bd3d25fdaf95e13ae1b0da139f0e7c958d6ee34e9204c04ef9dc997cda5ba9ae0ecde03164dfbfb949dda2cbad4e0f58e604356a25a578c4c4d669cc6b1dc77f9da925c1d341b7c325ceda82b71ee66d3e9bd99671c9ed6ef0f3f5f4bc217e2eae6a15b6f51834a30654457e8d7a025405d695fba37af85ab553cc2e078fde84e72516bc1027b90688657235fab080bdb624fd2bd093ef7c8b4bca2a310881e62df1c2b13e14f25988f052962c97f6ba00a201dbd04abe7843b57252b28415ce63ea66fb015ab274e2d041972279cb054237ef745350093add4ff7de30ab469d43f9961283eb593674fa29516b39fec86cd008c8c417e6f8e14dd02688a93c27b50b19b0fe67ed55e1bbcfa6e174cc9adf5d7b863b233bb31ffdcab8cb840869748b6efc3a700705e18792f6c9e6705cd27f54fff9f5a2b55bc1317dcebe7b07e6bcdcc20d1b15f94036895eaf59ea7f081787cd2fb28f7f89cb36d3c031044e9df534133aca67c415b21bcc449305a3e14463f6d3919732b0993ff0b49c2d9ecc8bf3268dad83e6cfbb01800d7924257cd31528b4cc048bbcb2f8a6ca5bb4aadb7a95a3ff5bfb14314460e68c1d05239691de76a15648e36f4d2d86186c6465475868803af9b5d1b73777200188767be133de149f81c2860ccc8ee0d717495cdb5e5d186479059699bea916578367e5e73546bdb7e41508105e199ebcc833edd8bc7b61e96fa9e4b15651c5d0d535a8a5318b55cfdbc0eb4cc58b4fcbd1385e673507092c2bcdf257d8c704f1be4bec080eb0c72658afc45d6ee365d56262b1909b25188bd47dbdd3aa61c69c844a04a4250ac928004a80fc835fe6f5ffa5f16daad143ff241748b247d97c6f6fc87fe153372f7fe98dcc45c97e770ebc51fab0aeb6bd872d80aa7cf23bd5272a0c376d43198787a8bcd434ec899cd094d186742961c7d92d9e9187cadbd93d105b7fb815c3e2e2865c53c10759d5b86d532a59ec815daa8afac72e5bd347c27b449497b60740a01c9e1ab71fb9f434d3a627f70902e38caaea216aa6b4b0b0d02ba9b21e39e0dac0a82fc070b70d6314a9c1c68602878b8d701164e9d603c18a2736e88203fdc75504187c6cabdf6f4c8b0d5a944b14b6115d4a6707ccc3bc102ca3379c1900d0e7eda4c417e6fe1b05ecb88a73792e7545c6e3ace88c602555285492b080ff80b499172cc9bceb48d6f86ddc00de9f356551097e9e090d98cf1d7c3efe7af0689bffd080dfaffeccb589f441c51187b1ccfebabb538c645a252321be7cee4d758eee49bd7fd893aac54ee45e12717e9f7bbb46a501644a1526bd365ff333f2601ee31f468d61eb9860e5e36008d632c007fd5b42339ade2f12fc087853d78562eddd17e36c2b3312f61304ac0927ba505bb952d62b21071b3161a9e264335cd6c0795121c322e726ffddcd62e301f34e7cbaf385ed2eaa7978fe9826966f65ddaf2010aeec3cbe77fe2de43fbc98fb911b9e4c0a11135d4747ebf30a23aabae9405174f15d6b851def7b94c936ec135b302e207d56858e539231f3dcb4b2cf444dfefeb699002e70bb185f786a28388958a43af891c095182c4089cad4d40b3ea18f4742ccfbdf2583978de46c6977ac121a761392caf9e0c813e1c3043b923ef2ef854a9fca81b4a4c56be847b45ae3bde4af0716913791df536c3f69394f4c1b8ea45eacfe8aadee50400b6e5136020520e2ca7515b20c68aac6287a342617bfcd9abfaea0cf4f8fd5689ec6e7aa8fd8f977c77ddadf11ae6f7227f9d40af7c9ca67a4d6307b8150a168752f76f129655dc76e547bc7cb766495ea61df8711c027d86aaaef8b3a8f70ca7b074cd504c6c32d83852574c26f9b3826f2682cf006f353882616c5c135022c9dcfb970fe250cbc274dc05b5a2f111682edb4fb16e9c6d8ee2328b7b8aa270d619d7bd3729324dce53abf45ba8e29c6f6fce347a6264f8d29aabb31fbab511a2f55e4520712b72ab4832dc296130465cc2353595665bbcf05370cffd663021dca98c00a98b84ba7c8c068029ea3045d32594ec8e6550e02a52f38d56a73440a96ca375effa4dffda111097d775bb728e5fbc8122a48b345fd2fa28bf08ca18e3241f9b8e821456e85dd244d7e1f8c8b9832e7523ef7402fa06889ef2f39cf42c7a179a49f6856464dcf26dcfd8a349cb48a816484b494eab0afc3e824c6008bffb7ef9091ee4ab834a97fbc5b210b401bd538dd188486491faee5d29033d6f2320b4d28ed95d514a1c3fb8bd961981e66c6ab487d013e5cc0b8b62cb865197383de6d3506dddeefe6c7a23cb3c9ec05ce357a945fe55137f799b4e2454cb8251aed15b7662e256c803aaa465daabe1845d05f14348a76c37ec5f319e61bd032316d880051e60606df3e766ed8d8483c3ae5e46482c1c8d94b762a770568421c72237e24dd855820a3acd6eeedff8c79be3ce3702cb92927085891e2f4a4f57963334155a1c2c06eb37d8bb628a98749f1e1941a4d55b5fde4ba79fb642db66acb323f0a232fd91ba0ab22e1dc6c8872c0825ab073041bd4dd3c29e8e9726741598a12179212fbae3ab9dbb16785290e6b16d678cb3c709cab438e2b3365a6f2fea04f2bca732d8028ed49ea9695df3d8db6cd23977306c0500b66c9e8991afadb9378f47d545a83b08beb88ac0f895f2b24719a5dc7383d5a177f8cbe1e338f68ffc2ef4a420f7ee7ede2847a2bccb3cac3031132f7503bcdd307d996938f36b7b80fa3d8188eda8c6b3b956b6d147a7b2bc742d9bc8c65147de94e917628e6faafa880702a2bc0b29f1639a4597c347e3e986d591778ac4a7f9de2e6a6713fa2b140f0a671246894b42d47b6606e9c35993fbe093e8ffece1c01f5eb3f43aa008f8b6ce9f6d37832b4fe3c991f11ba29800affef1b966d47010da5bbcd0688570c4a147ec0b5e1785372f0e27a47b709570c0113d441544b4af4eecd78c4404d97f6706c625db67e01a55c4d5db694e4681e0cf15cb0e5934e044ae4916ece35a73e26d945e1351485c01e8e006dcc7f5e9b6005a2fdee48cec035b43db99036727d4e83a735e630ae0f46bccde8c7d9497e22ba00f559fb5b846167b84e0800617ad11cf9a03a475353165506a3da974034405cf3ef129b10f8b3f7dfd31c997a2133c303e3616f14999b109709269caeea5bdf79fa956d6fc99f37531aafc30373c2960ce1475247868a2e1a1d3b9193fb29bee64034ca58b460cca3a8bc8e6060ef3148f13b018f8830619448b5d033e6db04c325cfe8b90e3debf17f8834ba9facee85b8ae47c9e5c6df35d90d2579a8f03007a3f225ce13b258a041b7b606bb763e338265729fa6bddeab6a38b3b978f4f00b0cbc27bbd3cc5412ca01fa035e8a913c0c7e0164072e5999e20d83172c3a6fc8fc9bfc3a508dca01356e08f407680bda251776ad21c39fd167d9afae1afa0b13ab842fda734e617ac44070cc8904a7d389ca7e64a646fd0d87a82eb12beab62f6b94a28b755093f9e50957a77044bc74a5e2c0e46455038591c370870c3ed81139ec8b82620721404569e2a0fc68b2381430475cf8ce62b02005e5f7e263e140575f26ed4c3619ca0a7580ce61a37a70fdb266dbdd025dbf729a083dcecdd70346d92b52bb01632a91b6f6d0f9c8213cce710b6500ccc9c99b4ea6b7b385b7a2bac00c2b6d61a08d2da3b31c879c40971578a957441fd5d0e9b228b57bc5e383414ecc40e15ba69e5df6c4d592bddc66bd4497a1c45c766cab0607b5d759e3887643b1baf6157ae8e734e6922344f9bea958fdde9897b3db8c2ac0cb0dffe1a8869ed7d2f243f1da45e40ed61d5fbda29f261b09c56417e39343282956d5a99ce7af078b4b3e638a2c91cbeef484381f852cc4ed1c7190974de128366488de2139b58f5d6bd69e5c18aad8f0539e79f710d342d1c18ec944495ab588638201aa3d339177204b9f0b5d85bc28acf91bc341d602e5085cfbb9438c34ff47d55c83e5bbc7909534cbf657c4a5f7b65092e6d1653bbf5dfd8749d8e16957d12e822cdacb87d0a3562547f8c8aa82ccce7b857b03b13b1c1b8c75d0e98ec52592ea518948a490c66313650d9643ad1893ec10427d4e8b13ca12f027298a00e4f164f3544605b20c54fa2ee0dbfff5748f3eaadda69ab4ef11c4d294b8f1024d8cac2063f0524c804751f4d328269ff7b77fd7b47a5d987190dadcfb7eebec28d68b4985c0e1274c6068b6ffcf8189ded5b0f72e5b7c9f22c8842a898293f45546ae46d159233c0219f67f54f62f65d3404c9ce4f74eb62ebf940f000b7ac6ef8b186c47c58113a599ae72ec6c3b979a3af9aae1ae75c12baee05a7039d940c51028643f48be446f6cc0dd7c38d56c01e82e9d8535ca82bc3cfd7989daff45ad730b09119f2aef9361e03f45431a3bd8f4aaa92d5902f7dc76725a6b5a98dce544ee20e099d3af1e860fc7f3c9cdd244e26acb6571154faff84300c6e4369c4dc476286efef082c4712b78b4b2747578b36b6830f9ac872bc466f3cb6c47f40ae281f65149f8167af11b474e5b0d0ba586997f3f582970b7da243af806587dd4a16766074fa51a54a989fa6e8d28bd6e84fca703ab0723c4fd2413ba18b4bbea46e154c423b1a1718d13d45a271ad8fd4a01a2dddf61e344b33617c3d90a7dcd2eb4161efbbe01f64062f64002a12b87a44efc77b23bc39da67d52a08ef178790d4ceded32e2d1da1b446a07532d7dc202fc5ffbd3fcdd3a10f30cac81ac3f22698c196b4e63930bd425d8e5b19c991ba79b3bcc0363819a2609c94843054f5a9bf3c9e367183905bade67b1beb73ee4a74f70ea573450f3487773c96c05169610dbd20cd36af9e3c9f72825605c73e7be035183d645d905da198b0026e4cf2f56d6dbe19419665de5b316c85b3114b346b1759e5a7bc96002a4ecbddd0a80c7837f2e6eb3824fb742e75a4865e6073b4429b729c86f6256d916b5ee7e74035a09dcd14ebed5f1271795600d83ef44ee4a46e2afd9e2d00496920f60cc597de01457ad1e6d7a65a9e659c9dc4e1cae1e6004754c8aa71849ddbbd5f50aa31cb5ebf47c0c6440792f0c49cede8df6d291e8b98ee1d3a267d6674bec88771250ef24f386702425297291db10acd775b512f692fb41bfdc476ebd4c29addf7e91a2eadd0619d367741ae87afeaf53b993e3b9978f90c7740e03b2d2decb099c60a73cf8004c6f990c0e6537b426769ab278483b2c82375cb1a1e39d9f0c84d0bbdb23f90aa3dc1e1a1d500ea20a5d5e288dd55e86c24386699558afc1d06e9d85bb1939de9171cd4d28ba44c2edc20dc331eb27164a6e418f16396ecd117db9eca819c1f4eeed2b159c4a4528785d1243f221440c60287426915608f5e39b9e648411efc924fe156111e49fa4414d795dc518520ee9aa989ac6327163bfb0e1d5902263de38c5f4424a04f00985d04d3026d455c47097bde542880d5096e16505dc1d63f700d4a441cf3a1faea6b0be0889f7626c68466cf4d14e063369ac5e76a96ec0201c1cf95d07001b40f896dca5d2b7a9288963148e39e50f4c8ae18027b9ea2f092ea0f9f140581e090a6365efed1ffa20cfe1e851ad8f17c117452ba45e39d76a8eaf0210e8db6aa9d99a41156d91c4196aafbdc053c20c6065caa23b587606a30d936ebe5b49cdca9b05862d4d4a53b079833ce2faf6e02d728808bd1f810bc8d441ca9eda16f24a9b3fe7c5547d48075826d29de89cc57b67f38e49e50dbde1ecbc56308763a0bb9a690329bee92f9d8306b30f0288f6d1f753e63dcf10ebcdd6c99e82d72016fc8515b36f2786bff66e995dca788839829774518f39de2181702ef1b4c38a7a55a72cce76bee4a1b60fa11a8f79e62e32d8dafb8ba0037fd7df99e6ae0b3cb670cb44f713e0d0900583fe2eeeb5e5110e5ea67204eddd77131590d06494879ae568fccfb3183c5db7b0b2bebd8ccb8094a583e7f7ac2ecd92450be0eeae245a69d6e8271d4f10d0901ced00b6777aaadfdd5aed9c85477d32e2fe6690f8d9485f24b179665d1309af4508be0d9196faf0c5ed5022cf52b0eabde9a87467a39927b99b7d45122f39ba89de1ba61d6670b0c4e69a205678707681a5ac6733e4631c12f897d59c11655ef025ee2a8678ad41c0efdf2cd1cf9463a20910b67c3654efbd25bbce466d3833d44793ec8691d915e98ad92edb219ad81e5854820bb9f13e8487ab53220eefd6eb890b4a43b5fb170767fdfae5c9362c4877ed2ce7b43309e1b4003b3700d3989a5b4511ed12860715b31c3f9b295423a28a5096fce4682a272f01e2035b4310a2550b60d858f7fa04fff3a111ddfb0e4f8e2995a03b825ba10244eaa8d5093db75c1b4711f7d15a727b57a7c7253285290f31253756ce24b5c69bf049bb7522f967f0f9cb8f3db9ba7b1e833e5acf40c73824d9b2dd117edec03ed682abb6340788c51dc8e7b1e2260c4332d16d68d2a527d6a1b7ebab579c21cb9f2af9b099c897b9f676cd5a3659ce0b213f01f071e888747e17d94610f0272fe3ceccf7047d50e687598a222d13924631518dd2928332884783e91e834cf553472c709762644f9aca023b4684385f6e969952f84df044e15a60b13d506bd126eef5b550f60cf75cf7b8fc68adc5fd40a84ceaee2117485c48959fc62bbd1f1fe9bcc5b7cba3ef2ddd940a191527a36e6cf88e58d6ccf37a2d37d28fa594f68dc9e071f13c5f95b968a77a9aeef4ea4b9fb42eaaf95d12e6793e8edb37fdd669eee094415cbc8d28d1a9a8b41d41dc0f835bc22cd9a5b2e28bb467856f788d31eac99ec9edc20ca4e2d1f8133117a30141f8fd04908628245514e5b788b6d73d97e03cc581544ce4ac426e82498a081b2233fcd19f532adb2ec4e31f4773c01d65445fb9265cf632df4fd1267553f7b83ae217015cd0f17e744316610bfe1340d9fb1bba49a6e7c5af66167ab1ceca5c8ebf8b2f4fc4a4f3aee5a93f2a2782660f5fd533921d49f3ee8022875775491a3bd2bdbcae9a44a1e07985901df1a8cf01c5b95cf4baf09ea7984013157a46f3763a5e08c885848c7e0bc6c06a7488e80ff11ed325aff15adc884d71251102997483d6b184350d1e5112050900b20ee629409691de309177775a1c4dabc6a325962a0fff88865d7e028054849115867ab8b73723f4a8c20a4cddb2ca534bc565f8a9db4c2b0d2b838ffd83d744af27d0b56422ed600e8a2c2c98c94eb4e5a81dbb9759c8a14188f2e95aa567f1cf23459944b6bc27a0aa5c15a05b2c79b646e9de41a40f567e40eca3ce7df7bb5b26ccf96eece7a43c1bc5becf3eaa28bac924bd595bbac968d373f64ec3ffe340a5e257f6016dc98f639794f55c13d2c0fee735e840e76b6b0b28f4a1e3048cf6ff885302e70e280dc7290818b9a9be68a9d2a5e8e9b6a544059f7254bfe706eb7c97f2fd5e2c0c91a6a6955d9a532cdfa8fc4056f57e6071632783a0f5c73d492c80a714a5691424c5fa3717c760c1a0f9093e0e5f59c5186eefccffad09378c129ff4a6d4990e7df907d0e3ccbf87c3392dd8509f015bf6f55e9263b0ea050f2ea7d044912f7416bfadd042aa0794082d421c0ab1e979007f10b983f24424171b14ffc5ecace3c1b392b7a0db934c377d0caaecbb46da8381412afe4e83095a686cadcfe204d16d48994998a6e48fab411134000009a114d76773c79f7827f5f8cbeac6c7d9f129324b620e44df50cabc9dacdf82afa6a6073bcf03c3bac9590804c96f7623df18c68c69e5bf4cf1820ab571c93fd442b4c2a2eb88ecbb61c486ce25e796affccae4a92917d4ebeb8e2356327451f377e9de7f46897912f658c9348a5dc00752bdcd73a6565c5d2077987e4877986eb4011b85f60359f1cb2de8705a8824fa0d221b580fa44ced094dd2707fe07a1ee36ca2077e6938013a8abfbc3a638c4f7e3c6384f0f6adf4b419ad763cd848c5a37af500dd70647b238206e58789979018bd2409bb0c0d0a8100345c9c12a1527a0c19f69fd0a06aa1217088b912f976d62bf29e8fe85a03852b94538e812ad7a1b987bdbbd15256e127e298967916c20a8d215c95590177e8915e083e331c90983e3058765074bbc322453ae0e7e2eddfe2dfb1c8823325ce7d4036c522cc0dcff8283b30ce22ff113579803bf73bd898312f0210499f60dd3c80d4f889ada10509f375547d31df410f32099901a98ebee7dd81b7de152fdb1d59841b55ea70df4ee7f57c98e65b28fe91c243de7ba176c31a3506bbd7356130f35c89c2c79594efb793bbe0308f8ac5d2cb6577c246da84f93aed6a63f8bc877043cf77237a1972c5093e92d94ca969ce09fdf519233735c460df8cb081247c7cb3cfd3ae9a5051553af6ff02ee4cfb77d566dcb8a5d8d333f66a4bc460b8065b73d506aa29f75432f8d742bd370bf526e2cabed3f2a4ce5d43d1bac6070d9fd9cec42b810022fa28a147cf385c45b004c4aff297f229146f50894ff6a230a3a942c103ca39e4843338f633effb85fefbd2190d4c5552b323738efda809b37e6a1721c2d575d568e9fa384486deccea584e5394cc52062cbb3ac13e268b1bafd4be739e8dd7a3de6d43486e25e6465195cb74122c3e35c3f633e2e120152e239e96bd875bd7fa07da88c4335711cb40e817ba6543dfc020c4f0d18cc5a92b5b9786a624fda47314e556585f15221eb048c8e0de12c0ee7b0d2b57a4091845e79aab4bf92a4df0965754543d82540a160c7c2b35ad0f27ac79e294d6e136ed40307e481dddb9212e31e3d3d6ab31808291c240d42265518211d7c3426a8802ec846245374b7186c4c699fb28a346dee7aee584319bc14a365178ad8f4dbe47203624f306867edf97ad0f8119e585b33a7e84aab7becc69ddb7cd02c543279a2ca23b9ae7a03b87a56949890fc8708f020eef8f33fbe4ecb6dc1b851caf1b8ecc9c626d51108a6ff7aa12ff72abd2b6e7aae98cce5ac1af5afc85e095a17c8e7741fd10c5c2dcbfef0973462f9270373d1261c1e695754f2bda43e3ac969ba50bbce2964e83108a4eae2d1b2ee1810029e922e5cc0d5da58f6e3980f408794208e1478ea206ae517ceb5334e43bb60c0378e1b20b40103fcbd61dba379c2a65d19c9a81b124fd2be89540bdde8160a4ae99b0b988df4954111531188c4d2c06afc11e217585ee66ab53459141b4e35e174eb0c56096cbd0000399f5eaa150db362f2a821b8fc42090d2e6f15d6a7021dd80e6b179be665d44000646c5253c611d38c829fd3751a154e43543359561c16aea32cf948e9966a47dd6535a0b065e016ec147d406f870bf2795bea1a2fc3a6ff5d900f3cb6a6bd367099d63972b446fc37e0a149aea5f59b0b6799c19bf0aa9046a367d929d21392533cf739f64598656bc86ea7ae1bdd5075d227e387758e086043c255579b6eb7bbbfb95579bce6a5ce40da0d8c9c443e578209e9e26ee9cd7c2d66696436f3cfa4ff72990fd9302d5b0a75fb45af2f24a2fe3220e590ecba70cf8dcaa79a6df337d800d6e10ee8dcb2533248296a7887d30e89e954e2964c83299fe43608c3f7956d4776563c26d7438cf5c14d77ddc4c67e8b4f12ead8f3273ea99c4c6d8a3c383fe0b529ded3a6b97ab2a9637b0461ae6859770327c49cbda83fb330aae14d5682f648a456b03d4d3f21ae610209aa123926d8e83fbeff1d6e500c00a266ec719e4b78f57d9e78942f7cd6185879f91e7036ac657291844a536bcf6ba4f792704e99b948198caee8fa0bd0946a1d38abe4b2e3a6ab8de9b1b22e7cba0a2566dd18e42eed08f35518095260f258666b3365377556b40e2f06dfaffff27878c6fbeace0cb85ba413eb844c27f6745d214cedf5bbb4547389e008236a3a8d2ac608f118ff4ab8a482cb272d95921aa9b96a9b2e1fa7cd65ace25b55b5b617fc30527655b668bf4f20dd77e0a4be24ccc9b4693354499476fc3d101d7b27e52b571423e92bdbdab7b5ac62e7dba8e8fd17667c7586b8e96e45ad59161dc494da24a3e614725309f82194556c39f363ced60083a73dcd92f985eb2e405fe0964e596a7e21477452d7fd0c3204585289dcb01d17fd19d607d3636a8d39b3ee64d6a7d3f7384b84c884dfc2577fb907a87765e14d89a01ee2952beca118db19eff8f337f36f1ca58db0ab334f3edd95a8ebf599c047779ae22a4b3a72a9dfa7fcebb11dd5e0d4eedf02e6fb197c76ad81ad917158fc1d279ccc8f624ee8fe46edaa9a36889ddda2a5dd990416f82b605dbcef394e7412ed04ad3c41bd85b5c29d3a0cc00b8cb1d9df483e302ed5f3038ed0d569851adab253dbf37dd67e4c58503a40d0196182e38177d7318696fd2c8694c4bf76a50dd0d6908c393da707100eb25fd51e6ec7c953b19a969fb3475c2755000dddfab41d5a41a7f4b95cd8b72e3f6af6a59b430ecbcd9e68b1782e7ff5ebce4713ce6bc73b99d9fc94a8cf614a275f052e9299e0fcbac7d39bd96ef9fbd477e18714beba6c00317778f833666797c6e5c710d34a2f10d7b9155bf73428bae1fc4e9ea11999627ecfb35ebc64100a0d9d8bcfb48021e626a585bed15ae999b5ceb9bba30cf96d5612e952d5b1b45becd7738ae0979b8c9b2155e09248de82f50068f3768304bb9a958a8214e783f2f2c794d7bc6590976a8077c8b2b9241670a284bff1832dc3588b35d581dc7ee2b7fdf7f9fa1d25fd5d39c37775a8fd3561a57cf50a213c16f70f273c6bf5434b094e0422db65f01dce6e8b6bf5d81ccb9d918cb8b0f35c08f6bf9e2b1c90790e9a753f0a42621aedfe7ac5925dac937ba49d9bbbd418322aecf140143a574da59f811c6b9b359df07be44a45d9e76437c8a254e26591ada963d155432883c164b979c7f3ece2958286d7d8a439dc54074d8d92c1204fed9cfcbc7b1b9d9a58a6a74ef2d969e133d04c11ecd3b17252d5036dff84fab9f1368868ef97b1fd3cc287060ee502cfb5b1421a297272684aeccaa381bc50d2c243d5cab634eacec822d1fd75df5b12fb7d8d7d38c6717776683c21f50737dfaca4d7c27f5282167024a0a6c5e2b1bc8d9937ee1129fd12e565d3ea6780e6380822927725607b8b7a068f116906c857afb610121c4bfec8103be15c13343f5be912ca73cf2da3d8d1e671592dbdb031a2e1dab7969af7bcbcf1c8d02297308a1e01f13999c55cf3dae7e0e918b9a0e4cd4a602b1c28566c8a9eee502de4c67555bb56489db5bfb5044f835c018885fe0ca51d871c7e830075028fa2fe3851f6245ebef340a8582a60358f2f323f5c60a866e0ad1a4358ec6c6938dd5a1fcf6e6b2f8b4b83c12aa4a8df4626c37bd24a60adb2751ae16e618d67ecff4d8d03e9dd7dddc1411d8b56766b244af6f9534cf4b783b03856d00698960b330365c2e00572d1cb5379ad99c1e8494fc6caa4b71413d80f92b2300aec4093d2f3e08b0e1b5cc715e08098e15167bbb6cabb42c8bf13b4a35db7ea04c1de67f2f316e83646d8e4d519362917e77956973107c189913f391abcebb247df6d1915caa501f36d466a23e243751df6a8e76ba4412be50f3a6cc3f872e1fbea1c3070916156034a4e2a9e34582d0e879b3d75bfc1e211054b9d0eb76b0329c634ae5fcd868de134ca14bb4542f22b1641356bbf8aa38aef5214cec491c42522d526cced9cdc91af6e530c3afcddf4b85702020d204b6d44ad059e096d2cdaf040af2e01dbad1211249c2ff6e87285d629753d6b69281f51d36648dc8521e3410514db495d55aa13feeaa8432d04a9795fc5d626f58887750f3ba6e76226e41ce3db37a794b9584593581a50ddbef6a196f115e362d0523691f2f4abfc15bb0b26d6a11426bc77802f02fd47c59edd9e1b1d4f218b9629e8c1c1ec9b54698ab44798c57850bdbc99a55807ed648c82364838ead66f23e070273d86f934a5401aa12fc0a4ed4d64a87c0c71d23658435e5686f69552f0ecb0ee456e588514672a540037a65ea32da1e792c8d50c5509b0aef99bce5477e235ac93d54d23d10210e2576701c88c36e8ebacb49098cfe662253921a36649bb90a574af284829095a7bdf58b53b8a1b5d39853f2ba3aead684132bd3723e2a4c6f833a625bef11b71ae14da299be9f09c1aaa9bcf2b79476aacc86dfdf327df06579a83281465e3380b3d67e2ccbf2f7b066d5113c07919ba7e9a27afdb17d9233075ed7891ece205e172a17d2e979af474d0e28a6c6547d891a20320bc95606d333e5eee0033f2d37ddd1d75ae3af7bd670538390fcf853fd6f9a5c51069c3ab8cf06f8027d53649fa972684398c21860aec42cac08e0ce6f1ca0967823c028a429831f48029da519586cfdfa3bf9ac6e088f06993c294872cac9b4e0258d55d441d1bd42cc27ec6cc3bec860ae9c837b09c72c6c9757b41f3e48a680fdc9fc3797253cdabcd6b9ce45c760f4fc589438ac7bd9922fb970e685d203a02ef363a1d4a24e04f7e8fc1c011d3f119f5f23038aa2824693a32b80b5e0be091a46dad0cb789603ca6ec6f2184baec1fce180a40f21362d50fa0a8b1a1dc34c869b1d7a96f4e75bffcf31d62a677aeab4da0e840d10728a472d8eb11cde9a2f2740df86a347d22011f873ddbd1bf55c324b4db78caf04ab63b275eb14840fa721cd2865c9e735e093b0f2fdf0557da2ee84e24e2fc768ca89830f7d98fc23a57fb9d21283445aba95a81f07807a259ea0a30265d61b89a87afbaa3589118514fd6865de69c26e40983dbc83de482948d67d1c820440a6e643918d1a94b232319149cfdb4ac857b4926a9f6566f40413e7a02ce17cd0c8e00e003b0ba8a9a19e678b0403daa9f83f4d304e52ffd6a026499e4e620c18786e21c8b3e44c54b47998dcb03661084a6f93e77f1aec0529ba4de0d8db567f3f91c4f645ab8f45178aec5ca64c2fc067cb9364d8ef2e496b49e637e4972c10f08cda7bb667f798886e44cac7c9284a335d8dec41aba706ca978ed175ac380fd3c458cb2037d588d0b05d7d113c61e101e3a22d38b23608a48eb2d29d7b4b5cfd39ad233fe3d70b6c29ac346a4fb256b7ff8a667345fe54e320ff4ce96f1ff1b95805542b3a432e26a20ae41d4b286d37451064e73d32fa2cf0160706b594a36a4165f5660c5399e6e41bcced5d22d8b236d60a38b8a12c88332c22882fa9b9da5673ac9f9263eb3832c0421ddc085843b4b8c1c821b1b159b78235e05f5acd812926b47a91ef781c0f095b3bb2ceb59aff682e6602def01d00bb02d69041d812bb50b611186df9ff927202f67387944290d76698cf792def00d39ab1e0d8fd96cd346016ded81feb2e79270f4860c23bf6240e7d5b1000885724f66b022d33ab8fcd978cf7fb0ca8223cb26f48ee81c4b840e098586b466975c6a1ed16eeebdd962a96539e22f2f5fe0764eb7aab0a8d4e9ae8061b8f739be9fb32bf65bfdc9a4d9784f1b4072bbc0819c54ded092fd72ee301dd0e97dc4f41ef7cff08e668eb97be0b4a9aee1300d5f896317c20fce3226ae24a65006c9df9747b043715bbbf2e3dfd186d690672876d8b74fe938a24c869d98d5cfc02cfd93f2ece86066876b6c2a06262633eb65759e63dbf13c6aaae340c2b0069bc0a49e8f5e4c3ebd14b024715f9ae5980df037b0a9d587da6ccfb622a881ab3783881c50ddba881821074291cdd8f7469fac5e61db1cee992a57de628c6809b9985676005bac2ac64937c35b5d6c5c558e263f12dda20b5fbe7c3ec1a28a007caafaa554add0eba3f6dd81c6702a45e3183f17d711ceace4b3df94a443f1cdf99a1d1b6a341f9c9a2256b854e6cc4df4bb89af80bf0c8297ffcebe2a3dba6124bd89f41e5c16d1f6c8289c469b457ae8a0271d7c56fbc2a9ecb54e0aaa76d20698012a18353f4621c8a5ecd8d3e0dacaaec3bc8c4ef8ea8590b90ad6896e78be5f0a874ead8c72ae22e1b1fd31f6b1ff681c208df36419553d13d3cced20d3ca167721ae4a414fdb212e27424b1fd3542598fc129f2dd2ab76b810d98f9fac4bf173ae5727821f4a2ecee4135830a776edb52c9e2a753c6e3fd737f659e135323071110080b74edc656302816325733843a7925840dd8415672b3aa39327aded11a269c1a13481eb32bf5a49846a40e6f7f1a574a38de06cdf51c7301ac052c9cd6985a8e2a3af3a3a1b7e8618abfbb1f1863e96bbebef8e021155da0278eecbd7b77ff79d01e140ddcf17a388514028d49049dab6d42f5d12457c0598135390e83061020d0a47d0aab6c40750cf1f9dd31d6ffd2af405b7f597d75d91cb1407d8721afc6436a858b8ac48c10da109a31c64a39fd926b7ebc1b0a9326cfd5340049ef4d84ed3a8ba4e72094b93610297d2f68ac20ce77159036b33626c1c5fd9afdd96fc8a69aeae21e65564dd9d2620cf9ad88719c47f38d90edf32cfa05c22f501ccfab3cd08f81a9bf6ad29f73df432410a290e417c60bdb4c57878f790f31c3309d58e8308b1ac17aa4646ba1d6c86a535bc31b6230460e27ba7885ebe96e95370d47978e4648796abc4067d2edab205b198cf03ba192486b0d95381fded5a289cad56403084ff4ea61872b4132866e444ed16dd3e862334e34a34c2fde19e31a8999f1fdcfe46d470262a6560527d6a7a0f5bb15672f35bd654bf31a14c7167835802c5a2cf3e410cfbe7a2ef30148a86ca91216b937d114bfd8ba89905a53a7b47a352899bc04b1b08a8284194c28e926b5c379cfe26b974260181a9f75950cd84a14ca6ded792afe8147f3b4de2c3b11430ddc60cba9e2a701fe897c2f2f18d4fb23f3ce89c77f5c9b0636eb3acd035138f95f1feec91b1ebc9ed9a293491ec365edd9b7e68d2a67b20058bbb561b16f2dd137f94ffa7f03ef4779857e6129466f7518bdd4db42adad7683a068939f0a7e65cbbb2fb82498881dd4b9e0c2676690ff65843a4346ae6d257f4cf05673645b69f15c2565d87a724cb95006042ee1d1a9bbb86f0054ebbc1103a805ae9d65e408dcb311a941a557865b795ed1d997332cb7dc352fb823d19efe868f24701ef8707de40ae48c2ec1b70f83f9a7fbffa17840fc1cc09ca21faf2f7730dc7ccfda664655c025480d4b7545f5ce7904de326c8c518d369fcd0ae2693000b482412c7931dcc002288a99f527b1336b9631f95b036f73a4860a6740dab0f649e28ef7214367d59a6ca463e38ba23c72be98a210ff03aa33b018997500fbbbf2975fde98096bbb0c514361f61f13e2cae2bb4e2f271c1989671bad283fab098c19265d79568f88a7cc0da7e6c3257f4abfc5bd09233a326e57e7ef89512c357b0ad6b79169870982010517f9620297a5995afdad710431c33f0e14b5d35cd62f7183ab1baa4c139ad2f962d38339293e905e10dc408a4e715be2d8b82755dcf93057c9653644d5727630ca511f6db72a92217d8ddf7b5b8ba76f3bb630f0d9abc510b5a1b66cd83282615ac6b08239c025e31b84562c831bdb1d170d62ea3d1c7c683206272ac1d240f9ae4969c85fe11ed1a7243f4c35767ab0fc42d21eed829aff653a68de0f8f8496001db7ffb51905e5320aca8f40247de77d6180aaa32ff2e75ee08f2fe51a7fa34affa9767b96761f0676b6223d4c8dda22e1a31d848dcada1946d4a50ab05ec68917c89947b8f4a6704c1b991b5ed1e421f7ee0299bfac369144fe302517906de0451090fcec5f6a9564d8f88164e06def76bb99d10d8fb308c8bc8b8c53f2a72603ec3b415c3ffd7441846a592868b1c8c006f123e8ee587a3f9d4101860a8ee11f9cd24ff2d2763762074692e16e6f06ecfff430d3db9da0184796aac54a570bee2595b5fa39aceed5df3234ef0e75b8cef3b878b129a7894ff81fecc320893a0e08d4da73748396fcaafc4ed75c4a51b2220442ec00bd3780223bab775a90856388f01b0ec36f1e828f65c623d15734d5da753a22f48e0f2d78ac57e94e1efc68d771f6dfd24a0b49b5b448009a875a71bf9932b81fc385e62b3475736ea2dc8441e66c58e54364e92ea510fc43f92dc4acd220c7ee0d8de0cc678de41cdfcc4399a9ead2f0b0bbd8f24725fb5f267450f294522fe2700728969145b2038af9e06488632572b88bd25f67eeb14f0c8c8847803ceb001a6f31e630f117fd20e5f2fe5d2d0da3de9f7cd89a64050a763f481f2772c3ce7b306fd506123f4c35a955f115502c3d73b87f918ddd9b4717b9f6bc64e84dd667bd5d5f099f388d1fbe0e54373fe3e773b1bec710f7f76192400cf5ca6c539404d65f080c2a14fd6955f2db25d5bfd052aa10457a4ecaa41e1de52d842345c8f834b5d6673ef644492ad7a3797e94274855fb2e80502ca4c2089c924d69d340953025b980def3b7a36be2ad33b451a225bc2dc23a261f51d58cbd1dc8713fb6184dcbae9727254907d879f50104018bac7cc19f4a8380864c5873f990569e4396ab0fd518f5729e86e6fe0f85ebc5cd967cb0f94bf5d0b4d958e9269f68aaa4d19f67624f711991f75cfd0c017c9fe8c26ebc345b5bd623f0f712919a3eee74e790202b8244feda862c04fecb38de203ec91cf49d49e1a6b0a64cda06f83b3a5a6d0df0a5e3e6c43efc6c83f0d33c6be03b368a0055165e3722f62d7888a28dd88fcd5ae877dfecfd0349f692dc699895a3374368372789a2b53ce38111363fa21541c6ecc034bb08741cceeb20e1326672ca536c810dc48dcace6c10ccdc977b8c790866936b006fb82ae667323a8bbe0d27a88e390530bc77f1aca98fbdbe23b8a71b412f3cbe1088ea56e9e33a6cc434051d9a39aa2ba6f116944dca12a51a7cce3f094826803d86cd73117c2a6c776fd0f71a5f77f0e11cbc9fccb0d4fdd22d5e67afe66033d91788569d2581b1714d894b85301d90778816b9947dc005f5f5ecf818276a38fc0f1e3a42501db0076edccca68291c04c22d881cbcd2e89d2e5ca229e7d88b30fd7463f6bb9026a56c4b048b18629d8c4077dee7ddb4fa7a5ed4ab709e8f9364f4141ef8579e217d855d9e849c6ef275de7ae47d6480d39200b6c2a12f5d857502a731e4bb38bf45893564b6c0561dce33a4f3f8237fea1d76789616427fcb165deeb5b936ad19c61db4174fe30731cb5e982ca0ecf34a74b4cda6734ee3ce2296e47f0ea0ef894a97fb12421b82eaabd265007f6b433b2ea0331c345a53c26915753b7c5f100ddf38388fe0f13e144e125b9eae47f34288fdc2adef699d2ab6bd9b8f13bfeae5282e20958db6680da925afbcc06cd9c80400118f317f7592ddb9a1f4c7dd00c94e72198dc909d6e527a1004bdc9f9100b15493dfc5315dac62d81570e496c24bca6af80c2c4f25b24e82ed9b02447622bd53e3e2e3f41f24dd21c51cd0bc6d7f4657517e0a7e49bb2fa896f448540ae33a9878ffb0e222d07c154158981c285c2813298155b69bc983f0d4b3ea0b20fef42f52b95ea882fbaf6fc18d19f320c71c2efb4fbe15f8f2fa00fb686f1caad42b29d7387bc5d6e94b555e3872961c2ab4cc97b2ac15c14fff097c5f315bfbd9e6a2296f561c2d6ab38fb423b18a3c0a697c64ec8782e9c2fe64fa25dd724d7fe92ddad607781b0a2a17b079a785050120add851e5087c7d13016e4bf0865ef075cbfb8bca465621d1231a2852185d39782c8054ce0596035fd43b4896047139c00ba5f081bc2beca9418ee90ac777dc6318c20f7ea5a8e47e1ae9dbfbea84b865eabdcfab5fc22824497265bd8ad676d583970e530299e1530eee8f4341d6a7843d2c2ca553249a19a1323b61abf760f81c25b8f31701ec7eeeee824231737689ed10b373b7d805e4fcafa52267d0fa5b23502635630ecbc6826cc426bfb83c4ccc4b81c80c5143bdde47a4ac9ece8424178224372f933804e35b671d1d79860b6633faed3b635f9238cb396ffbb6a4f0ec5415890763a5bf25a08d9e5bb621c8677e4c932118cb130cbfbe84b778770366f7f60eb99fead8cccc7a6ed644229af286d51a27abd405ad2b70ff35176ec9efda3d5891edb1d732ef2b3b9cf1d33a250b591d7634cd7e5e83515061b1b0752822a867fee1df7f92a40852cf72ddb3508629f001294ba5c63d12864e0c16154544cd275259e22e1d6b6f44e4184679428272a91663051da3060eb73b61e146a6ec35ec9b12cdd7c035da6f71af7a08c2edaf746080c71747d6f29fd25a49589d5b0be538c87d7f74013ff176a65f566e9ce882be5ecbec17a5cf8e588e6423a3b6860b583716a5957651be47ff875316acfde4b0c214b2ec54596ab623adb045b3a117d7f285bdb13cf38e14488ccb90c61a87b68f7f2ee1e979e8a3766a8377d75eee962ab1e2a851d96e744d9e660258ef2ceeaba7caa1404f53165f45f05ed6df85e9a1cb6b4102915e77c25454671ff19ebbe46199b547b1a05f70f9c52091e27b65739adfc63f0b7473cc16ce839845337309377b861765ad67266a60c3b8acd9233246b1227d3c003ceaf8d901c3d6a91b65edb26cd9df684aeeb66f974d6aa1ab3452a12873333adaa5b3b3c39c351987228bac273ecc5bc589bdadb6737b4407c57cca0d433c69468c95664dc0590a443464f2b447283dd76826af942e3d582ff2c44045ebff68bf181a192ebb55f68ac20fb8ab092bf95ac56200d43160e31f5f20cc4dedf7f1077f974a48ed4abfca89bdb8d695cfcc9b430f983a1bcd798cfd6af71bbc11e59f325ec6fe013bf694355e7d5d521b8c19b8f6e9df6e0d82a2bf73b043bd7b46cfa8410e11c00736c691b63efd6ceff4ede14f823143a3afc8b131df113b0f53756b0785b5c6ca4753174af9be378aadc0c865ba842636e8bd28383b5c2cf5ec3fc7e204174043136cc620d25084eec0470b7d388a4f2888aebb13a075c43726a5562a5c3abaa2c7b6f247162092673c6dc2d93ee96183d84ff28c571e27b6a67efcea21f17cc3796e1bcd563f4035214dc4598f79c703f11ad74a8d42f310ccbc1b63eda93bf115e2e34452a521c61fa2b20eb11659689b97b92bb7a765c8b2cbe67ba5615137efb8179bd2f0b52bc9fc20f4c3bc438aea2915a9fb3f6684d29617085eda06d41da8bfa40be541c1cbb0ae2e6b38e20326183f8170a43809b80e32f0787cf979313abeb0c6291cb38b1afdc93495d58ae9fd7bc1d7e12811a998c32da9b335a7745c213509188b8a112e5093c4c305e6b46cec24aeb410a90d2cc37d3ff6f9806223e3e249f93f5cd2f861de34cd8016a46f6dc119a96b859804484eae7908d1a1d8043023ccd76ae98dbfa25e2d1404467b18b9a92e7e58a0fa56889935621ce6dfa649d7ec3c8442ecb14bc9c0ccbcdc65875c856e2cfdac114f100e09c4845103fcd6588a350768daf0d0fe39d8b8407cd6b408e1bac30cdf9aacdfd743704d1d67037fb43df4c2e89cc5616174c68236a2d5f300019a0a042cb375a23785727aa23d22ce79d826bec21ed0fa1a2156268de98767e35cf1a838161e3028108fab025d60443c857377178fc0d746a8f5aeeadad9ddd356b5bd4e1879c9eff5df5cb014586394dd217fd2c4a858f2cb8d95990ed808bb482df4939f48577249aa394f038b2c9386b52b9530cc800ad22630801bc5fdd70fb02eb72ca80d7d469513eaf76b5134cfcf505cdbed6f528ad82b09afc3005816908e5c7781e3094f86c1ad9707750b927d6175394d197dee9c8f59d0131dddab68b845a579941a76188c94aa80681c27a2d2aa31aaba169f3183902f69e58f1ab2beebc242aba2041f0fda8073091af9c929e26057cdc50e5ad95dfa42c61ae81913fcf6b06772ce3342e5e5412e7f90247ca98c960fde9a219150bcb7715250c1cac4ecdfa1c91de4f76fe609b8d332e964a13f0da730b1c45d48b92d82d7299e42bbac54f271dba107c55558ccea31e59a8c144704b63509667b3e30daa226a6bd1e4bdd919eb6681e350af3cbb54635525403dea3b59810f34ba676ca9fe54dcfb6fe44dce0eeccf0e9111cadafa8bba0c10d8c8f5c523559c4b612d58ef138d4eb625f491cf9fcfcb972d0a30c24ef069b70e6b76c3a92f39b827d041c576564b65493a5b201744891d4fcddfa1cece6c8ae9279233b306336cf7adc66a1f46bd0fb5f5432e0c70324a0ca88ab815df8bd82e0e93f6a3b426cafe3cdceb2e86c8df9127326d4f7d6756adfc71f417b546ad1b03ce53e7577532493de3b1b1e20ba9b2d9e19628f37a59bd588d8c0c78a4566591d0e3744d1f5b886af9cbfb5039e30b9f4758063764743327a4fd8c1a5689006577fc6ba3333435578617eed86182644e891a85ebd6fca882784643b9e82976f5420d19b9385059a5dcb7a0ba5c004be5c7ba64da4cd5a66a58e1627a336b3c46128f9229161439729f4d7a48c628cb57eef1c78623e8b31f32ede6cfb01f444164e9d663e71b91c72048b808f3d2fcb43a6b6624e4ff8d8c61fd5c1bf8a2863a894201d1559a2a846c23fd44ab586351cf48091a441bb5d7b64a7b359ad5d5bc01863f1a4780007ce919604736b29623351a8273788f51db83474c952a3c134f2fe2c2943cbb210a9f1046af65cb45f7471cba7da92085aa9f4387db91c947845ea57e6bca55fa7b6c362f5cc2b8b98ab3bc1cf4a577240cc78a2aad422a596e01ed32729bda30fa058ff4c96cfdac06fe153f3bf13f92e38ca4354e4a456cfb4e4edc4015bde4e8dc925f15596ed88fef181f4dc23aa6ca22679c390d3c7052d6624b8f3421bb2157db2d161617a3d899cd42f608eda2f1bec29dffc44208731ce11805017dd7ef2a3244e179508cf3e78769795ab39ce37126dcf1b12e7afc34df7231109b2d1908091f46bee067d0d452c1fd40848d24fb38b0bd10a596fd37d9a0b98a0d5417434715659c0b913c26df21e7a57ac6ecf6bde89ad364644c83cec2e1c2a0df01f6311ee35a56f41c78789f39a54c48493cb05d0fcddc7e9f78999fcd239d451640722e5c37dfe6c74cd17568455ffcc41e6fb581f301bbdf621d79229e753d430eefe63c04e5861fdda2f618e9b8c7b32b6236a287b16e44e9e35e240691e22de591013ec8bc36d5a4731a1596d2da5dd7e8d725d1c4a02c4e8de85bb6a4624c43dbd8474de8e0edf82d434cc9f61632f0b42a8ed327aaa08175fe0d5e5ebfb1908f865ee1b2a377cba60d438ed47650084d2391eaffc6ae01616b8a9422538ed203e7912f62e52e720eaa30088d0ce11c6cf70d76cddcc7b22e765f3cdb02d8f541c3d0a2e0bed6844477f186ebbeae98815a49b3b84d964071f1469552993e8994913e649b398bae8206bc0e569198ccf53de96d2e4075d584c371cef9c0e7bc54d049c07e9205b8c6d43a9a21ce76ab4e7b122957b27d0a0ebe0b4ad2a6354a1814168b40eb262507db669047ecb343406144f69a7fa7400e6e6febbab6645e18cb7b2c86b37d1aa9edf57beb46e45e0aefae74adedcad10234287a1c55df5f042627a7d70c492b7613ba7e84194f7d6034cd6767de8e3fbbdb1fd5f020ea98d408f14b09edb1e450c7c4ca702008ff4ffcb071c54c9ce5e52bcba7983332b904e338822999b9d6b1e8cb989f19a22cd20c318b22b453650fdd099b434854ddba360a5d0882b0cfee52e33ab079cd05ce2c0096a796975e1bed95a310745b1a0810c44a72bc97df694060e2343bcf3714be6997d09a3839e160c7f4f73f351663688639a39fb6d0ef2add683d7995ec298238fc62a02e42c493f511595b6600f4adb145d361082323531858509cbb39e0bec1642423e1bc365ac0c942fe83aa5809fc935e9d656c5b900e84d95a9e888eff2b761310e31b9691ba8a1ea68bad19e10e56fdc5c2d04ab0dfe2d08d172290d2dac988ec81b1a5803e728e869f75725c3f97ae56e72e7b0ac80e42e358d6431d13fc1fe99e804633a8f1c70b869d16e2ed202a91a6ea044a3b89c0ec571257dd3145fc45a2db15528360e0b18bded239dba7ef1f9ccd0a6486cbfafee42d1c63de00487614178c5b5eec2dac80dc9763ca6bf1125d8ac68296b1837776d1a92ea68125b79976bb79ea09b1cb3d9d0e472c619f52406d9e3c9af334441bdf630755b4f507845699029bde7b222293180252302dfb8608639fb310cbc608ca92a5d7a0b29928769092bf07b6180e47291851e643b95342312134ca86b52feabe85b9bee5908f9ba3e23d3fcf2c53c6bbdcd7b332b89ef6e6bab3d9f93091b00920ae1afb7e3db9450ca69051e12b5b262e826eb1cd10683b4fbfd6e64a2f88cba1c8e8b07095e8ea78084918597fefdc8720cd59fe0eceb7a844bcbc67bf84a04c530f0abc9c8cd90b585c88b241bb01155b31ea2cfea6c07c36245168fc647cc3a6d08a910aa3c08668f57af28e402009e0224670cf9df85f57169c79af66db0d73d3bc8de492a80c5f3c4eee201802b72d6909d95dd6a749f9ff762a5ec5a11eb766739a01dd56cc34a50224160a37924cc9844ece95c6b6f1cb7ab7e7497aeda23ce4e974e97f81776cd24878b1bf2afcbecaa248e1b6b3c3cc49845281bd0798fe9a8e80fac6c440d6e6f5284686ad11a6668ee9dee35b197a3e9f0ae1b9d60cab2aadb66e4605fb35cc1820dffce10d37ba1d0b6feb05506c1b935edbc6792e35d3e5914df1efd1c8f4b6efceabd196afbbb124ce2dd6edac7968c6db382e3f806ac52d69e8c4e4692dd67324a7b4d3b45c5af85f3cb5475ff0ad00f6c12c7758a7736c74c2f8da23b14e8e1385efc29b6df93f2bf4ebefbb1a3fdedc671bd4089fabe19cb1da5955d73a3e61c9a5df2088731f28c037a8066387fafe98368b8037d179084a3f91e761bcc4ef0fc2f0bafb2b56f67611334a0e3217b643277a82c369e1938544646f4aef255f6b31e5caca211a5bc3dba610f1dbe9aa2cf02db5c78bb245fd1af90e1626bf4242518d842100d44548e02ecd49e34083f2304b982d55742d454ac1bf9738532ea47bab49930aebd37f9b2d1ffc5e424a5a25e7da6528c1ba258c280c2031a6a97204b39b4623026a443095365dba75daa5d22723d5c14b809edd47557af0e9cfa397095e038f4fb1ec6ce409d8b8a4c977768a59a99d1fa6df04ff8012a940ff1061b9a937162d1e4611571974f620c89a28baec53c4970e3ed2119fec71a51af28ce292573f26cbe1938b7a19779d2e3cc3b030965543c7b629a7609d1354feaf0d5ca8fcb57fa6e4bb720046ce116729d91d143a8f2a090f0c86f52264f1b564dbcde2a0265ceead1310e5178ab95a4732038fc964fc1c65138ca790745754fe24044970f34a32be52499f55d7885f702ea23efd4e48f2dff5c3b8cc62b90fcf646d666ef52fbbe11fde867a67c54e6f921c43ea011d70b4f8ffd0055ef2393784966b57942aa824ed63e4dfeac2895ea63b95fd0097e96903a55b95af330a9e06c1430d7e6f91786192ccff55fa02617233144e0f04f252794723d312524029162c55bbdd3495e9a5948102723c5c289ff88eda290033eb06ce3387b74d9a6f40abbb74297a145803a90dd170c6a6eb772818fcab5802c8673d563262c3d2d432e6e301b2e8af482e2d728460f26929fcad46e1a3e9fe26716a6c33778db177301b2962bcf2d6f601b7fdb7cbb71c6d6fa8cb14777228545797c07ccb2c444c5147d5529075a9a7082639a119471f395e76364414db7dfb3120757e32f369ed79f30a6f105f47c3701fdd94bb06271d63fdd620aa4ab9e058f8cb3ad0df1d062f4b9844ed9fdd01e90aa3c439288f3391874b8a72249a392bf6bb777911e9ef061535d1ba72fb12117956e48a0d961d276d798912094e8fd529ce2583decac7fe02eff6b1dedae52695e5db708c8dfd5abaa210dacd54850251d119fd82b32f9225ef9ec6924a4368ff8ba2187bb0094dd79fa628af20dafd0453792fd9da82eb8ca7c8126c85abc6306de33efb26b500727ba45fe8656cb30494780f6184f09f44f1d18d810d84b8091bc1119a8b3dbba240ab12dd390b3d0841475be008de89253105cafa24ba24f49e4670be8c6fdc4d8f9dbef3e3fb70ea5b7e3abe7444cefa4b22c99da41a7691b6dd3fad677ccd5f9aa4ce939b45d3e65da674153e26087909705d4b6f0552d131ee6296d98865463d535ee65a5d85457665c354280cc5a7de81c0cfebb0a9aab7bee0d595fc0e01488091a810673c6b5261b70f587faf37abfb30cb9663007cccbd9658d0e9c5d6e3e14caf4e446512985d0ccc151a7c71c9c60ddace2703dccd6d3971fedc6206b9bef2d0435c582c757e3873d3a51f2c5bec5da30003915cb1d9f69002469aede3df25b86bba841b5a4d9ec338cc7ed131e60e686f4ba406772d9cf878247e6c960c5ac9ec28801c8d7d9ada7a91358d3c22febc75af5caf05a6f3636b1ca6abc95151f261fe42128943773a4326b8ea52d996e132353db2f1ecf80668603c403b2fd0894f3ae82e6e253ea787547dc986ac80bacbf7f95c38ca8f173222ec6a1ebcd8fe9dd468ee481151652e00f00c38810768c303b08a3dc7c8223fb136e371b09c4134d779a3064137ce990b6346fdc95c3f072c320504644d1e5ab6fbec3e672522550c5e56ca174e043b4ae7870d07cc0fb2383f076a17dc6d06bc905525750180c1b4eb15e3e7ccda55e7a47087461d6c1bd5017b4a586c7f60ca290a04461028298a2c8495b08604f1f6b1560f57a434c161a414d8ea14c323e727f99ad1165f8aca97b3c5940df44a3e189a61cf0fbd7a2e1f3d9375c5ae5b0fc8e90e9592c922a6c1a2e34204eb903e19d333d7d41d40e96fa0e2d3fc07d2356537a8691110c99456c7ce462b8791ca22582083ce7225cc6d9580b8617702b99f9282c17349438b5293266ba6e20f98bf30cb617b6059e4c118c2e0bcbb910d091a769cc816a9f46d5e5523a916f85142094405c4ee80f2d2c4c587655944650839973c01c1740b19b74fd0cea0bb26c2a0d779a9d8637d32c252cead1e0ec132520a3682c695e77b19026bbbb4cca1d9115fcab84628f35357870690cbfd3b4c793e9f3e2bb6e31599da0a550efe6bc92bbe3639d43e2019f0bc77ad99c9526712981d461990a143ddf70bc4109a11f441fde2f077291e8cd76021e3a895c27be1d5f3f758f81df5a8fdd4a9291eb6271b705247b2bd05df27fe48df2e137fbccbb7e1f3e2df7c989053dca85878634bc945e6bc6043b66e5878600149af6b39b1711a15c095e3c4ac2072b366a94407b8b11aefa6e57392f5feff3e65d5a92da1aca89b352815c8a97ccd07a5d52f6497954124f520eb0e884690d217ad7ae7be7978051abaec1d4d44fa45498bd9afb50037904399f779724b030857733a896f80f29dd166bc3d34a4ab2a9bdc48f12c2f7d2d8687eb5ee4d87dbef5c0aeaceac17793d65b38f28d0fb613c194bc673ba7306ee538ed35cb7581a4c85b1a23d897a9b8367a352564a2290b43c7eddbf001ea8d622144065acd8a882cbd1fee28561994940838bae64c132e1d1fc24ca03fa78d2e0d373a658735b1e8a7a65dc6f3c80749b7e4c8c8abb272f2880a49f5a7cbef5982ea8ac9a3a854d9f937b51a286c8b058f2a741c2fb099b4d7ae55d3fd222dc8c8ac8b03f8b8fe33635ed0d9b5612e3cf30dd393fc5a847e440ce80b2ffa0427ebbcad47320f10e37c2bc02ff0abbacb11232745b00b31d779ecc297f1e4a6effdc14649841197d06ea3640eaa76e9b9ec87661628d882544c68d9db1f691218e8c1d7e22e26eb8acd93dcf7e7e2a00f7b29e6322bee57de8302083d83038e7a2e4b947563f9626e1fff9c26185188bead0161b50f5e5b56e531afbab06532d02eac1f58a29710f771310d8af199219217ff3c1794291e6de6de6ae7f51e49c307eb3e1aa24491e8b40c20129d50cc915d03f467cdc9e53392875e040ad35e7e4d29340581025766091b55c4a1530c26ae756b99d65deceee008b7f29711d7aecae1a1e8dc4a32439eda10342aff0daccba468ed78e1dc33517fe7e28ef4dd7be43637719c24c8411c42361895e38ae6545846edcfa05f3fa590780efc704cf3ed59a99683f0eff768e78b2022312a6d68140e3dbd32470f92ff47135cf0a21d71a4ffe2e4bb08b199a3bdac4ba22519dd3a06500e230f3c5015b048a764a0708c438128f2bbb5e85e2bca4bd5804a1a49ab627ab46cb05aefc9d1f851cd28c781e5c4449a9b49410ddf01ff619346c7033d135a3ec579f37df3a33a88ff7521ccdd7037d4afc0fb5bb0669799e2a04845dbfd9ee0bdba46266f84a17cdda6d73f0088b9602039e2bb60c3c8cc26e9eeb779367ec31023de31ffce0a2791d479ec72151449de03f87538e9c193a00e4eda99df8da61c6934fbd39bbd9f4b4eb0adfee867700f99badaac0bf3e6ec5f3afd8990f96723f8130b72a421f46cf06f49b4f86fedc20454a1ff51425018da67750aa3afca9b40a7294e827b92dfe82542e636c62fd326e56479bff37ae6b8225298713012e6756ca94f1c1c395ec06396bf495e7fb0b8268c7a45df4b2a3b840a1af81c225e5b452fd52eca177ae45f63300928d719d71b500ec65b1aba5b87cc18a9b3c22aa04e407e28f1893749585c529caa48fe1b6227d3cb036e23eeb77136953a203cf74e4698160d64a773d8d225069bd673f1c7833d7a46959f63f0ad3ce243ec58f820f861502ad00ccf072e64fcf6a7a66e93fa21aac8c52a30f582b34631eb60326431ab8a63c7263f8653205a1d86fcd257c4e98563d7194b9cbfd2a1deb4e68a7952748461f0c9c906cbabf0850279c52c9d50ca80bfe8fe888f8f8a6669da9a22c30690238cdb1c7332a5f2c1729cdad668582d995bb68b66c9686533ac3b7eab2bbd0b2feae039eb3d623b3a515d540f2047fdc3a4f54d7cd05ea0399ffd9c150a04c93269a9d935120424b3590d217e103847a1a06c65f218a892ca69dd0655ea30e34682d3999e0342de2474a51c456a4d8614ab4bd33e835cdfc94e2f50d4b67d046e6310ab3752b4a00516226ad58d8888162dfcc66a00219adbbdd09da3a8a939d9f7c1f11d374598f8e2914ecc09f1cda854d0b0a029668fefd8227e5fa063cc4389bbeacb1fe372bb1e57024e8c0dfd6d9650b0aea418067b4a286c5e39f0fcdfe6cd370d7282480490d8e293957e36a453dc705e8db59f0bfc6f390d0b8fdbb0b2d1c7838427716b40389ceed6ac11370906c73043acfbd381b5c0bb74f313851d34f95eb029cca44cf54228e745957f27366ca1970141fbe0c777d6b98f8a5f27b9b46db9948b922c8561a59c3e5604e15a174ca6aa13bea3e066dc0b5aa493832ba671307b01a0892d5f44a83a00b4191be059f2ada22b264a09d58d3142b869e7965f00a0e4acc295b2a4044b85b3988c981242751817ff1e52558e374b882960004c03acf0b5126a8559bf23f4e5a84d689fd08c4696553e67e29e9c85393eafbbd4929c4f9b40ff788b08aed463fe7e4529803aae2eb9a841a7ce8036cc0251e69236ca96bc9f97f77ebe54cb60ad4e93a3ceafe1055ee061aaf7109a30bedc274ebaa4bfb9acba298017bc923a2c435762e9b51c93bd6120c1b403ece0d8631d0d62d9d703c18a4b5497855e0899b50aed9bce68cb5b08e429f9d942a146a580983169c9a511d16bee708984ea556760e9e018b4eb8fcc71b1e4791e485908db7e6542aa795516f30c26dafee1e056e1effc6303eee046f2790401663648613d1173cca5fbf39196e3dd10f7856bc136305af6455020ea7a5ba0077c63cb4e44cf46492db2a3e6e0a31d9b40ae4bf7f7291eb0f71900202415af8f67eb478d5f92455630838bad9729d82799f7923e6bd1b0e759bfd5a3c88486f6456ed96c8970d7ed11ef7c40ed5e769caa229f2fcafe4e748e711b32b0abeea19dd92eca2b8a37c1986fb2bc9d48e163ca596739ef9016c6c9857ec8b9870d8d93d32f277cc293804a7b1bcfced6b1d3b9ef635689ee020951e48c722da4410de097d84f9e608447486329a260f8eb800820cdca0915c2ee145e5a105551765d48460372f859c3381d8dc946de365cf0781f90492699e2d94c4c09715111dc9af50c9ea638d20d02b956a881cbe61456f6415138a565d3768d310d89a516a460ad7292685acb00860f554ba68efb5094a89761b5ad44fabac65eb9dce0c527dd11fac71be318f42a35734a5d6e7648404f03d31a3d6f4076d0cdaccdd5278f5e88d16f6756a6782ac01dedf7818a94beed354838cd11ac4f4e987f70f545cac3257b1ab9dc616edda446476227626b90c17afb05ac509ee7b5f2f006bc8c681af88924fd26e0d8a96d99252a0d677fdd3e81c3c10524803c68ed9f09d654cb44144b26dda245dd76b7d2e6209cfb3f2c52ce87c4941a082c3b187fe63dc2f464a47de25e408b2d507be5918a2f8be25579b1863d59956ac4a575a4339fdcda4c832b840f97d990d9740c4cd2dc4b8a0728eddcf642dd347a70dc6dd6df633aa3f23851a9de38198a8685d06823b184f21b212901d5b307de0571c50267f292c31ffd3b8cd3b507b75315c463d3556033f1f8f13026c8bc823da720c70761e08d52468d593d90347a4fbdd02ba447a20440f38e9c4c08923de028fe72c344e2f44a607dfd75d1eba94594281cb4b03749cec76541f86fe6a73f75c7be563ce7fcd3f5845f3caa89e41ff680d7aa67ee354bf24c8b0bd5dd49a1b00dd2a851f2dccbbb745001e1a912da62fc9cbcb18925d2e91d20fca7c5282514bd14630183fb721699a0033030429b86e17577fffbd270653f6aa180e8b19096f15179bebede00529451ae7b3d95eb6896971d5ffc5286a35dd15b78236b7c88bd81dba668ca8af8be2bc2ed78299a37b226dc2d9b258c0db1d093d5523d45df4b1ef8f4c772e74bccb3fd6b10fc08c89e26862b2afd6c09fd92b1caa7f549b53a98fa967a0755a8d59261561b7afff4dd8d636e07a37aaa1a9b59a40376ed5ba68a0e8332baef75194ac0d463dc53fded17d92f0f765826c56b7cab0dfa4b5cf1aa84f3ea436306637c8967bccd76151f69f46c50b07a0eb0914f518c289a126782796ab42f85ffa9d5d54b1825e19753d03edc4a60d64ff64ed7968d4d1db3cfe8c26f729ae6b8ba4ddf640ab011f149e01a653dfea05c9bcdd46b9b43e31c8f8ddf40532997c0d8e23df2b327efc8b694d563f251b576a78f28cb9f25b6476f6284002aa421f8255f92b45347adffd51640994dfc039f7ec911bdab6eae2ba784117f0a08a8b7bbdeae544d88cf2666a7f94af4cda71b198a1a7aa5bc8e71172380f7e30108700f6cae6cb0df27cfe69bde89c7afe975f2cbcea03ba1c832d64416a206ec779f0b32a85009b2d412b9ce9a0c15c413a11fd5dc5d42daccb7f65a933b37ebcf59b90d2ab628555dd87cd774f9053a2ba2e8a8f10a994a1b26767cb1af1b16e5039f14e952c6a4f853d49fa2cbb8c1d17e81f8fd45b0e2f8834b8b828d959e25e3ed09018258db0e31e8c27731f032a7fde3d58cfaeba76c62dd42e82389b20e93fad950940d7749bc3e6cca4b09b102143365138726308300f3b4e0fca1492c7cdba8870e529fb29769c49f66b8318676ee215eb9e072748ac073ee69ef66fadc036bb7ab2b982c2ebfdcedf706e9b4bd7a4a77b093aa4df9ffdcc01e60010cf4312b53df3e54f95e509144fb413050058c359aaa33127391636eff4b1e2f1359521fb3e77881994876662adfe6b0349ea309d4db9dbca3fd78dececbc4e40eec7a6eb1769df965106f1b42d8d46e58123de2a5253c4adf956a2c5ebf86a554f280f47965162a109ac3d48ac5ccef7b2650c5b031f53edc8caac6a38f18c2a614e7c083a441fc10020c67e6f897a149ddba38c0862d14c59255993af8f2920e60f712bc34a143c0b059e77972d778879e72a57ed9e52991e7453551bd1b517c477233409e72ad6eecfc0eff0ae4a34f696e60ee4432bea4c2f2d5ded3aed8f0bde85c627d5d53cb0e1d4ada17d441ff63831704b782ff43b63e88fd7906e9f32e8c1aa4ed828a2caa8954ea79833f09b0c724c7b97e89fffd6e3a6fbc9f28267574a7556a4a936f66ee1a83befa13fd245a5b571d22fdba074b58be1859ff65f31e64974bf54a0555</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-wave">      <input class="hbe hbe-input-field hbe-input-field-wave" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-wave" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-wave">文章被加密了, 请输入密码查看.</span>      </label>      <svg class="hbe hbe-graphic hbe-graphic-wave" width="300%" height="100%" viewBox="0 0 1200 60" preserveAspectRatio="none">        <path d="M0,56.5c0,0,298.666,0,399.333,0C448.336,56.5,513.994,46,597,46c77.327,0,135,10.5,200.999,10.5c95.996,0,402.001,0,402.001,0"></path>      </svg>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">🔒浏览器的安全限制越来越复杂且零散, 各大浏览器厂商的安全限制还不兼容, 确实需要详细了解一下这些鬼安全限制了</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="安全" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="加密文章" scheme="https://blog.liukairui.me/tags/%E5%8A%A0%E5%AF%86%E6%96%87%E7%AB%A0/"/>
    
    <category term="安全" scheme="https://blog.liukairui.me/tags/%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>ShadowDOM的坑</title>
    <link href="https://blog.liukairui.me/article/ShadowDOM%E7%9A%84%E5%9D%91/"/>
    <id>https://blog.liukairui.me/article/ShadowDOM%E7%9A%84%E5%9D%91/</id>
    <published>2023-04-05T16:00:02.000Z</published>
    <updated>2023-04-05T16:00:02.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li><p>CSS 隔离问题</p><ul><li>可继承 ShadowDOM提供了样式隔离, 但是 ShadowDOM 还是会继承外部Document Body 定义的可继承 <code>style</code>, 可以使用<code>all: initial</code> 隔离</li><li>组件库 组件库的样式可能由于 CSS 隔离无法被应用</li><li>Tailwind 等基于 <code>rem</code> 的 CSS 解决方案 由于<code>rem</code> 是可继承的, 因此, Tailwind 中的相对值都会应用最外部的<code>rem</code></li></ul></li><li><p>open &amp; close</p><ul><li>如果将模式设置为 <code>open</code>, 那么主文档可以通过访问组件的<code>.shadowRoot</code> 属性来访问组件内部的 ShadowDOM,这意味着开发者可以在主文档中修改组件内部的代码.</li><li>如果将模式设置为 <code>close</code>, 那么主文档将无法通过<code>.shadowRoot</code> 属性访问组件内部的 ShadowDOM.</li></ul><p>因此, 当我们在 <code>closed</code> 模式的 ShadowDOM中使用了某些组件库, 这些组件库如果没有在 ShadowDOM 内部的监听,那么这些监听大概率会失效</p></li><li><p>事件冒泡被重定向</p><p>为了保护内部 Element 不被外部获取, 当事件触发冒泡时, 外部EventHandler 无法获取到内部 target, 例如下面例子中两个按钮分别在 closed与 open ShadowDOM, 但是外部的 onClick 获取到的 target 都是被重定向后的Container</p><iframe src="https://codesandbox.io/embed/stoic-swartz-hw8u8f?expanddevtools=1&amp;fontsize=14&amp;hidenavigation=1&amp;theme=dark" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" title="stoic-swartz-hw8u8f" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"></iframe></li><li><p>CSP 问题</p><p>ShadowDOM 内部的元素依然遵守外部 document 定义的 CSP 规则, 无法通过meta 修改 CSP</p></li></ul>]]></content>
    
    
    <summary type="html">ShadowDOM 虽然可以将内外部 CSS 与 JS 隔离开, 但是也存在一些由此产生的小坑</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="JS" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/JS/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="ShadowDOM" scheme="https://blog.liukairui.me/tags/ShadowDOM/"/>
    
    <category term="插件开发" scheme="https://blog.liukairui.me/tags/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>CSS样式隔离方案</title>
    <link href="https://blog.liukairui.me/article/CSS%E6%A0%B7%E5%BC%8F%E9%9A%94%E7%A6%BB%E6%96%B9%E6%A1%88/"/>
    <id>https://blog.liukairui.me/article/CSS%E6%A0%B7%E5%BC%8F%E9%9A%94%E7%A6%BB%E6%96%B9%E6%A1%88/</id>
    <published>2023-04-05T16:00:01.000Z</published>
    <updated>2023-04-05T16:00:01.000Z</updated>
    
    <content type="html"><![CDATA[<p>当我们想让保护一个元素不被外部 CSS 所污染时, 有如下方案</p><ol type="1"><li><p>让元素不被选中</p><ol type="1"><li>覆写所有可继承样式</li><li>使用 custom elements 自定义标签名防止被选中</li></ol></li></ol><p>可用是可用, 但是 css 会写起来很乱</p><ol start="2" type="1"><li>采用 ShadowDOM</li></ol><p>ShadowDOM 看起可以在 HTML 中产生一个隔离环境,但是可继承的样式并不会被隔离. 例如,</p><ul><li><p>在外部 css 中定义</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">html</span><span class="token punctuation">&#123;</span>  <span class="token property">font-size</span><span class="token punctuation">:</span> 100px<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>在 ShadowDOM 中写入 css</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">:root, :host</span><span class="token punctuation">&#123;</span>  <span class="token property">font-size</span><span class="token punctuation">:</span> 50px<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>在 ShadowDOM 中使用</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">span</span><span class="token punctuation">&#123;</span>  <span class="token property">font-size</span><span class="token punctuation">:</span> 1rem<span class="token punctuation">;</span> <span class="token comment">/* 最后得到的是 100px */</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><p>最后我们 ShadowDOM 中的 <code>font-size</code> 为 <code>100px</code>,在 Element Panel 中可以看到, ShadowDOM 继承了 Body 的样式... 并且<code>:root</code> 选择器失效了...</p><ol start="3" type="1"><li>iframe</li></ol><p>最彻底的解决方案, 但是 iframe 并不好用</p><ol start="4" type="1"><li><code>all: initial</code></li></ol><p>这个 css 可以重置来自上级页面可继承的 CSS,但是当内部元素恰好命中了外部 CSS 选择器时仍然会被修改样式</p><p>综上, 最佳方案似乎是 <code>all: initial</code> + ShadowDOM:<code>all: initial</code> 阻止了宿主网页的样式侵入到 ShadowDOM 内部, 而ShadowDOM 则阻止了宿主网页里相同类名的样式应用到内部,它们俩正好形成了一个互补.</p>]]></content>
    
    
    <summary type="html">原以为 ShadowDOM 可以直接解决掉样式隔离问题, 但是实际上 ShadowDOM 并不可靠</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="CSS" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/CSS/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="CSS" scheme="https://blog.liukairui.me/tags/CSS/"/>
    
    <category term="ShadowDOM" scheme="https://blog.liukairui.me/tags/ShadowDOM/"/>
    
    <category term="插件开发" scheme="https://blog.liukairui.me/tags/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>媒体元数据相关方法</title>
    <link href="https://blog.liukairui.me/article/%E5%AA%92%E4%BD%93%E5%85%83%E6%95%B0%E6%8D%AE%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95/"/>
    <id>https://blog.liukairui.me/article/%E5%AA%92%E4%BD%93%E5%85%83%E6%95%B0%E6%8D%AE%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95/</id>
    <published>2023-03-02T16:00:01.000Z</published>
    <updated>2023-03-02T16:00:01.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近一直好奇 chrome /操作系统是如何获取到用户网站正在播放的媒体信息(标题, 作者, 播放进度,专辑封面)并提供类似上一首下一首 API 的</p><p><img src="./媒体元数据相关方法/chrome_player.png" style="zoom:50%;" /></p><p><img src="./媒体元数据相关方法/macos.jpg" style="zoom: 25%;" /></p><p>曾经有了解过 Linux 上基于 D-Bus 的 <span class="exturl" data-url="aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvTVBSSVM=">mpris<i class="fa fa-external-link-alt"></i></span>协议大概可以猜到系统可以通过类似的协议获取到浏览器上报的媒体信息,但是一直不明白浏览器是怎么获取到网站播放的媒体信息的.</p><h2 id="video-标签上的元数据"><code>&lt;video&gt;</code>标签上的元数据</h2><p>考虑到 <code>&lt;video&gt;</code> 有一个<code>onloadedmetadata</code> 回调, 感觉 <code>&lt;video&gt;</code>上肯呢个存着视频的元数据, 于是读取 <code>&lt;video&gt;</code> 的属性,发现上面<strong>只有播放进度, 总时长, 视频长宽</strong>这几个信息.视频的标题, 作者, 专辑名并没有</p><h2 id="从无障碍角度入手">从无障碍角度入手</h2><p>对于视觉障碍用户,网站在播放视频的时候一定做了特殊照顾(例如只展示封面, 自动朗读字幕) 在MDN 上找到了 <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvQVBJL1dlYlZUVF9BUEk=">WebVTT<i class="fa fa-external-link-alt"></i></span>该文件<strong>标识了媒体标题,</strong> 但是这似乎并不是一套强制标准,很多网站都没有使用</p><h2 id="从-api-角度入手">从 API 角度入手</h2><p>我们只是想知道 JS 上报媒体信息的协议名字是什么,于是我尝试爬取包含视频元信息的请求报文, 如果一个包里面只有媒体元数据,而这个 API 又是有语义的(例如<code>example.com/api/video/xxx-api/</code>) 那么大概能猜到存在一个<code>xxx</code> 协议用于描述元数据. 但是没有收获</p><h2 id="从-chromium-设计文档入手">从 Chromium 设计文档入手</h2><p>既然是 Chromium 的功能, Chromium 一定会有关于这方面的介绍. 在 <ahref="chromium.org/developers/design-documents/">Chromium项目的开发者设计文档索引</a> 搜索 <code>media</code>(因为视频音频都可以被检测, 所以不能搜索 <code>video</code> /<code>audio</code>) 找到 <span class="exturl" data-url="aHR0cHM6Ly93d3cuY2hyb21pdW0ub3JnL2RldmVsb3BlcnMvZGVzaWduLWRvY3VtZW50cy9leHRlbnNpb25zL3Byb3Bvc2VkLWNoYW5nZXMvYXBpcy11bmRlci1kZXZlbG9wbWVudC9tZWRpYS1nYWxsZXJ5Lw==">MediaGallery<i class="fa fa-external-link-alt"></i></span>这个 feature, 在介绍中可以看到</p><blockquote><p>Overview Media and metadata access API. ...</p></blockquote><p>在 MDN 上以 <code>Media and metadata access API</code>为关键字就可以找到 <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL01lZGlhTWV0YWRhdGE=">MediaMetadata<i class="fa fa-external-link-alt"></i></span>这个 API.</p><p>这就是我们想要的东西, 他包含了: 标题, 艺术家, 组, 创建者, 专辑名,媒体相关的图片(一般是专辑封面)数组</p><p>一下是一个 metadate 样例</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">navigator<span class="token punctuation">.</span>mediaSession<span class="token punctuation">.</span>metadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaMetadata</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"Unforgettable"</span><span class="token punctuation">,</span>  <span class="token literal-property property">artist</span><span class="token operator">:</span> <span class="token string">"Nat King Cole"</span><span class="token punctuation">,</span>  <span class="token literal-property property">album</span><span class="token operator">:</span> <span class="token string">"The Ultimate Collection (Remastered)"</span><span class="token punctuation">,</span>  <span class="token literal-property property">artwork</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">src</span><span class="token operator">:</span> <span class="token string">"https://dummyimage.com/96x96"</span><span class="token punctuation">,</span>      <span class="token literal-property property">sizes</span><span class="token operator">:</span> <span class="token string">"96x96"</span><span class="token punctuation">,</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"image/png"</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">src</span><span class="token operator">:</span> <span class="token string">"https://dummyimage.com/128x128"</span><span class="token punctuation">,</span>      <span class="token literal-property property">sizes</span><span class="token operator">:</span> <span class="token string">"128x128"</span><span class="token punctuation">,</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"image/png"</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">src</span><span class="token operator">:</span> <span class="token string">"https://dummyimage.com/192x192"</span><span class="token punctuation">,</span>      <span class="token literal-property property">sizes</span><span class="token operator">:</span> <span class="token string">"192x192"</span><span class="token punctuation">,</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"image/png"</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">src</span><span class="token operator">:</span> <span class="token string">"https://dummyimage.com/256x256"</span><span class="token punctuation">,</span>      <span class="token literal-property property">sizes</span><span class="token operator">:</span> <span class="token string">"256x256"</span><span class="token punctuation">,</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"image/png"</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">src</span><span class="token operator">:</span> <span class="token string">"https://dummyimage.com/384x384"</span><span class="token punctuation">,</span>      <span class="token literal-property property">sizes</span><span class="token operator">:</span> <span class="token string">"384x384"</span><span class="token punctuation">,</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"image/png"</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">src</span><span class="token operator">:</span> <span class="token string">"https://dummyimage.com/512x512"</span><span class="token punctuation">,</span>      <span class="token literal-property property">sizes</span><span class="token operator">:</span> <span class="token string">"512x512"</span><span class="token punctuation">,</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"image/png"</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="更多功能">更多功能</h2><p>mediaSession 还可以控制播放位置, 切换音轨, 挂断电话, 切换麦克风,开启摄像头</p><p>参考: https://web.dev/media-session/</p>]]></content>
    
    
    <summary type="html">一些与媒体元信息相关的 BOM API</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="JS" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/JS/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="JS" scheme="https://blog.liukairui.me/tags/JS/"/>
    
  </entry>
  
  <entry>
    <title>前端性能优化总结</title>
    <link href="https://blog.liukairui.me/article/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93/"/>
    <id>https://blog.liukairui.me/article/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93/</id>
    <published>2023-02-22T16:00:01.000Z</published>
    <updated>2023-02-22T16:00:01.000Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="抱歉, 这个密码看着不太对, 请再试试." data-whm="抱歉, 这个文章不能被校验, 不过您还是能看看解密后的内容.">  <script id="hbeData" type="hbeData" data-hmacdigest="b1d75aa3cf2822df181c1268fbaf3f481f84ca69dfa3e519714fa48e23aee874">34e85ffb0b6d2d12b6c2e177fdc7251e4f3b271ff6412d26f1f73acb56b1ede322f2988334f022f5f1dff7335eedf42d9093f75bef88737165e3aeee80dd9120c913a0431273d7f6918d63d27bc2f59da956e55727f107f2ecb90e211ee6f14626a56685b07adcd1b08046a4f70550f0fe9277762c714a82809b00f9c6f5ead4d413fb1efbb7abb974d26c12bfe235ca06a9cd31347ebf76087200389c4c973f794af52ecce23944bc07002a8be07e723362a79f771fa3a85182abecfc389c090a7171e87f29fa7c8157df79db2c8277c262b57f2426d6acf495d33c61d7997a96f1885e781f29e03fd6e979fe3d0c573e7f148add1332a39f51bbf98c38d84a9640e513a6cf1d4d66ab2686a11e2a9c55ed0a8d97ae10b0bd6d81691c3fc4fd45cfd00e168398cddf7230d81d272977d7a6719df2a5e5035885fa0eb57925304ff7621d07e28803f4d3dabf732e230250618dd91347077a2a8e50f1f698d7cad013245df8d276452af38a31176e7a92a019659e5d1a7f19ac29d204b24ce6d37761808a346fb7bea0f230068c598e5aa7c77c617f4b3041be79fa9b097ac8693e2e9986646dbf3d3dedee5b5f254311f731b194854cd06ecb27e3b9a1643bc638a233eabdc8ff898f81ce7e13654565514f36ebb28dd9b313baae7262da05954342fd406a4183ecfe52137a5475344c7b521602aec099f351f6001c4928e12ca7f1f43b9a0086bf28ec55566f29bccf1df57db05ae14ed20f13d5b3085efa00b6993bfe11518796dba5b2126240e0bc916046d84004865ae85d1ebab2f264b8273df7831e81c83109d9d446cc2c004ee738214fedd7309e443fb9c3e71c3c68469a7d440b0589512314c73b4ca1fbf428fbdb4547937653186e5b5ae209e0fb7e832b07b0a7dc19b9e61e65f6da22da59050a0a9cf25f673e42258e106e0c68b4cb9a5d235d9d2490a42562559af160ecb2eb03b7b755280004a23afdbd39e12b742e4e6d6dfb0ead636205d2fa6bed3df1392e54d4305863a829e2fd332ed36102fde00771226343447e9ddc0cabd4c66c2ebf86d1e12f956174de4dc1af54bb3612077c61a1ceef0dd61008c2ecafdd8e12637c6fb602ffaf4268b7de2d7c776c4b232b68e700a495e1eaaded8e3d7dcb4ccf4b92430f3824a8d14d72e1039e9920a88774afafa94442d1bf766c39694777ee76143b07eba2c74cebb6a3fc7e141e72e117a5f20cbbf8939e2cbfe379f11ebedfb83fdb682f08efe3821277a2b02e2e760060aeaa453e50a1868782ce292de079b303c2e67578f77682d972588bc5b10d6ef69e8fa5a2b92264721a1b099c17524927619b51ea7b94148df1486b0a27c862acf32bc9cffcfe6a48390f6316e0d22c34cc50e08b94afe698e9a07e38c53aaea23cdae9ce89af174e91d1cd5a0dcbaabaf6c141f0075eb4a2cff85ce4aa05f2939a82fe280e5c8419832c151249d6da7f536bce612f4e0a87a1dc8a46cc96ef0040d4af3405b17699366c7750ec47d3e8180bb864b1eab4fb48926563e293aaadb07497ec3be8824455c1b81cad84990325984a664bb5404ed1675c58f137c27a35283da0bff2bb3c35e6e690c0aca443e9183a0024121c6fe52be5608327507177559dec46f574f133f80e22c0f0b434bebc99e72c521ba0345957647503ea6bc3c4580c1b36b567e81e786231342e3b0bf5fc4a291b78698d69b47cc0608add6ee633b5c4e92a012856f289576a88f59e62e28ece533a68be6bd119e899d5112db1d25bd3aa1b288c9f77da70f95c01990fd600f35757f47bc30f182d1ed26d3a4d0e4f6d45bad911b4d0b6ff0054772baa49b51e8a70a62af1ed2169b5eaaa79d25c202201df83f6d453ec32c73b5eee30e82fff70ec9e6735a2b669b97b62dcb11240264835e898cba85c0de2df57ae215f99113d752c4eadfdf1a1a6db14c939d42d8ec04c3c7df0caf472122fbc6e3abfe8e7d8ecd0874defac66b4874dd5e3c2a806defe037e64cd254e9e5c61cb35ce13b59f1dbb5dcba90081fb81f7940d87fd87a2ab9e07a75c91b6b7fc3feed61f3178c5ed25d32bd8c84000dd1ff2745c35b368af8e9000782d1231b36f558529ed2beb58a951e1f10fbf627138e8598205dd81e8baf55b81ed7478137c884fa590b507467c0bc605ecbcea776cb1f7f1bf81031a9466d557408d72fa437adc043ce6d2b581f2c1074e8daa21220167b993b9731a72a34a1d8b6b3c5cd49fa22d498946c24d5d3af99a29800c9fd471446cb10569880f313be3b2212383868fbfddefdbebff01afe9cc93af9434100401704f088c9f20d2723a8f1094b9442cf20d08c8f237dee12569794b98c58455d36d2e84c9185c096d74d1c5a098247ed4cc31c735a6e1dbbe6425b4812bf202cd1adc6dd48df2727db4329104a6912d0ba5df218b2ab78b138eb958eca85778cf995efb3077efe4c6ebaf2c58fc7f674b5b7d5d5d9e23dbce1066c7453bdd39e13d352796b81f78f0b480a44485f8264bc958f738f3682be50167ab79b9b6ac4ccec1970c741c57c4109967b6060e470fafe71ef2bf623d7aa57ae403076640d2af2ee809dc1dd2e57476a4f06e76ab4072e38cba7bc7dd6a004bb4e39ecfbc7408ace4111dfd5ad1217b020de534e5bfdc056920d65c7b6cdfc41fdbb356c1fda8358f2e9502378de127e275d3f2397cfdf46eda278ceeba83e5beda9f35d87edfdd1f9de928c3fe31b0ed695b6e78f24ff6d7ee86ab47e92b0e4f45581679c268570021fc71757368133ea92f2e7a7cc678056967acf2d491c3ecb943754a0769b310c95bd05cd2b4ea7cd2fae70d9ab03749c02e59f6fc6c84fc2a4f7930acd58af33e36ed162eff48cb6b3e447c2f03d890cbb0c034f79896f1000004e070a412c5ee939f228c844b166f737b83d42da36c62a57d427aaee39602260d4136d689b4c42aa7876245f3419f0fccfda17c2c658fa987863b76d1c9ef595ccace5f8c7043d4de8d7c7903f742762b396e22bf6d9165772ee31c723823e061451fec2aac303acd9a7a2bea63bb3266cbc34545caf25d981edc7d231adbf2ad0d21a7014a17caf1597b5fc7081dd46c41ac370a30ac60978313e2099a218e2486d32a3f87170f931eb80bb943b38fb1d85e516e34c9b2112b22d81392aeb70d6d0abcbf04b8f86cabed7deb934296569c155f55bae8089dfe60f43415ce3e03157f85a2f02270bf2db529372bfae2d2903293edf8e34bc65d4466700b5e605e70f4a7cecfed15c70e4fbea03493676ec50de62fcf59c6ee236ca2cd65470fdf5696520797ecda179b076f5aaa4dd68a744ab5f5d641f08c646578ad939cadccf3286d0d321c3794344ba15bb226fae23338c795ce52733e35ca92fae6763eca3d111abbeadeace6e6ad6985029bc7d081198ce34a452dece9cffb6ff746e17829be0c14be70841308c2171081691d7925f93fc913e0575886f9398cb80b0dd7ce8c0720db5409c975cc473b27fc59b1ff0756c75bea6efb574b6fa82e3fcb0bc05e003a238da5df8355e4e735c5d7737bb33265377a85c714982a1f49998e395969cf6ea3093aa8561a4ebf6bb8e71ed26fb9e68c90e9e649d8bad2aff4fa56346a566dc35a4812b932eada27a273dfce1a8011d1f3f034abe8b76e94a5b7e0786604f310fdf08d944c0bcff2e83890021c14d6100892b34005e303084cc3def29fec501d60f8d769753180e6fb677da5a2e4d9a37cf35f178539524655404ed2a210ba01aca1f0ac70b6f23dfc4d73bf749095cf088e6845fcccb8e8283526a5ae95a63b13fb9d4fc72c63b45058d0496d5d4990e83793f99f99b20a33ffaadd79431f5f70c36424ddf646ce50b01d98ec6e7f129b3623f03d35e08e6984e4d28eb6b4d6483ecf183bbdfe517ece499fbbfd3193b504733d4f2eabcd8ed6e4477793317e05060d1d76981953003b016c0dbd71238f648654719d47c45e8a73860ad984a5d1d77c6833428c7799942c6f4b4a0a46f091e67d84805411968b78f3b8b11d6279a260f3db159d167956b11dc19b55d5c17778a8d9751ab854bbdb58956a361bdc4fe827073c5790fb6d7d09f23d3a7205b96a03ca245187e2b13fdba4830f0dcf22d1c92cfe7d14525d1ae1ca4481019c060bfd16bcd67e552788ee557370faa64a470223620cebb8546cf30cda500e0518cdc150bb29f4e925e4ed5c48bd692b06182813347cf37d8f17212237c8298b90750747de9bba67905922c3f9203f1510fbbf36f72a53051a4f57280ac2720402b7d740256463605c1f9d9886d79adcd9c2499ea63ed6710dac7bf19d080888eb42f55f3feb2dea5f443d1c016191886024565eff6ad196cdf0a5b0fb75a77b8acad754ce84f5a7aaee7e8326ae6d9aa034cceee324f5a7f5a75e5060b255ca8c74bc783347729f9c36de7fead89e4fc8486606a49749a6b1a6a5fcdabb99dc382055c51b3dd42eab28e82bb7cc6cacd0a6aa5b24353b7970c24b36164bfb6464950e656b0527c65ed8d1cf46d86f5472f4ffa81cd1ed07b92eee113747bb79f48535256caac35321f971c370b535b8e69f9acc638d03a98be32e33215ace6fb5ab755dc31d60e4eb90a3a90c6a393f57bc2d0e1f75950d382451af9eb773dc50fe4d42b775283b5fe52ed8f741dd9373c7f503353d093631cec7b624804a9b8bbde3b346c6b32da81a50e1bad5d4ce72299d8ad8c36b84fd8a8a13abdfe8e7c10e16a3b61d50c9cd16e99023b068ee0527c92744dd2bd4d2b49a2e09f892f007d25a297f32dea4cc84ea3afe35fcbe723fafd9684ed789cd9e3be06b000d8c4489a0b511e9de00acaa4118727c33b372d1357852b18e8ad9b0d94504d206bcebe751ce784b1b920fbef53e92dfce5d631f56c76b0abcd1bb63ca9297e7bb8e884105d3dae29b30e9a667bd62de147ec05f2022d7186d4ec07b5d3fdfbaa143a25d7796c45d0b05e5d282dc2f8c75b520f08180ffced53fdb11996b1d75c83ac0a45b3ec13c73e70372655a9afcc7f9f62255cbd5e10bca01d85918caddbc5637ec9f49db1ccae635a3538e35e77b66bbf7ac05499a3a94dd630ae5a1cf43ab359dcaf75af35570590e498cdbff24af2a97290f3a258d97b9817312ce8b88da84899182feb45624280d351221022a963772e8e488cd9b772afb47920b99a948520168327bfe5fa763d99d09ea6062018b0528cfa8260829400e593d89e62d40b18196cf1c6cc58c88ffebff874c56b938be594b8e499d2671272cd1be91c853f599208d10b4d5a4d9ba681c8c1dfbfefed64da3db7b41ec4820c4e137e547a97e80d29aaf748822bb115a7393518ce6dca7334e274a9f83d77ff587214e178b5e9b91b6ff2e19696b134c17845bd8d0b5d0adfd910b59664fc152d211e291d6b1492c409eaa308da4d399870e97b3d5bc1a9998b595598bd7287af043d1813eb9072251aa0242ad67f8b1817e81aaa165f5404ceb9cda17f42cb16f3f1449cb7bd1f89466d948dd3aa97a2cd5ccba71ed5ff383742240c006ee95041deadeae31d9929d503f250af8ba340c92d2c93b6281cae92d640b26129928a2c43dc0cb1f87b43e3ff1b9ae2c550c86c6932a93feca8bf3443c92c659bb143834d45a996491c4e30956cb58a87c42c6bd7729a56c21171273b02635c4db9f6b1d4e49a60dd70f5669f9d851b4398138d5ea1365865589cd727046e251bfb9146e549cb80d79f8deeb8856350dca3bf446a1587b77437a17269dd6600d2b5ba794922a7551c8143a714c98e203ff6d64d7d84ddc274111d0c08141c552953941b7eaa8fb26ae6a2eed46a6e67c52c26cdab0e9895367f3183f1e8e3f69a324e9eea749ad03b57fa580865199d2c4d2ae17158a3eec6c1468a00d1d8ecc81d497aba6a25bca471e50098476202990f579d8d27cf2bb575d20a6a078acc83f01295d1f7d9bdb8c45aaecf5f82a8c3335e0aaa1c301135f4c675d4fd0f6592a8c0a1d82c9d588e0424db82fbb3fc295135e69487e3856b24ef9641bcc91904e57b68b77b7a90c8fbd6b735ff325151c6581ae817e52ca547a1bfbe6f3e0493f9004460d0edae3d3ed6b558e8b16dbe4090489bf315807480d54c342a0982f2adea0d209d4b3f87f0510206540ac79c2a13eb6b1768cf4426e5df3ab29e7cf06370c3bcd11858e63f3fdefb0973d47e79452cb58cb7d823014c1b5759f92fa0477585151607e54884998003c84cf6b8c4b2ead6d424d0613b65492c6cbd9d71dc66cd4fa16e452b5e3b6ea4c756587cb3c1011593a3b93639a721b101a49d65e2ece96c0e2fb2523798093fe16dd0c2b131ac342c644d83ae97859ebd335a0a5d44be32e9c3a38b4b23196ebf5636befe667a82599b2ac6f326cdd9a39e50cfd624774d2655c01a88cb8e8c2d7c6a94ae14c2200a25964471e6644dbea876426f74c27388b2ecaf4985bdfc0494f183987d904f4225aa38bee9316a603e2ea7223524786839e8e206fedcb7cbe819668a93941227cbee327a68a5b04a588d1f1ee674188f9c80ecccf28802340d59520601fc58f61d5fc18b59eee3308b98e1c4849a774e9b5e6f75d00220dfdeaa4fc5413a74b8bac653cd85f29e125452c826368a97f4b46da8713e39777e3f26e2505a10e4fa459024a30dda2c72f09110ecc24f1b4d0437e6b761ab50c5e5a55adf6bf12e4a9e57dd1a77b24d7fd6551201e1e4c0d0121c95cdf23f21fea68412137c9e3ffe4a48541cfbf07435536594e56240b495c7c05379f490a82ad1e9fc1c2837d6e7ad86ef21a798470e6c131b9f1e3b79325d031349853ae62dacf8428ea1e670499dae4fd0bcaf0a3d689b8e8b8c9a57eeec5a63ee981cbb8a0f15943f1cc7e2c1efef770eb81877ce9bac4f9590c6b6210c0bb177ac99d0aef6806e2099267852544d89fda65433ce4313845915dae0f36cf331f4c468118735bd981bd0fc96995b46df09d5a315a3e2ae82fe3275a3f3a50709a5162dc74d7ff849705d57b4886bb9a545d6335dc4ee997789fb29029d081464aade1225339ef3bb63f1bd6494a3662adf329b14b98f943f154ec7db3156b0e23465438eee736425a9895af4bbc90b3f3920fb7ad22d2cdc5447e16ba4b9916a0d559135bb2d989ad6856daacd59679e2bfeb3ce29f30db24db1448780cd370a287a23025d92ef6bd3bb683d5ea6f0b7a637c35f9dde43fdb870e1d467f16b0a9446d0efff7dae94e7767801707d85b3ba17bb6f986dfbccd617650f19f36e0b9a3075970e4b63ca39b1e3580a4218f1dacc380ced59dc0be74561b5a5209da20782e89a511488157d45dd650da026082252ae21ac008d717a12144c8236ae07f0a336613a98809294a4f462dacc437b19ab26810f6ede1c77e116c00cf2a6b85876939758d8024472370a24f62add8bfedc020143ba1a0e7038c3087c11623730555f77307cf1841083847d4288f0c12800e594263fb55e042f92b8634409c42f4bedd16306e3c2f944abc78f504bff982e6ca1b1c587669f04c97e8936300e2261883e65ae776b617862cee7c08a95d4462fe8e3665bb11fe64f4ea72ebc22453d7ffb052979c7fe0e5b857323b7fbae4d5b2e9c571e5970e9dac096e395122d47e086afacedc8e6be65f7eccce15e9c10b1cf0ac0381fbcfcf80248f3d8c7b7bdc32ec345404e4d7d682c437f985f1a49b839e18e7e7927ebf0f2442dd283cffab5e92e57388252549bfc2c66eff11bdfb54ddb8648291c922137b3211b38ee6c5f24e27f6566a2d420263b94f5145206e27a506ab1571c5c53756d448f598f18572526e586383d5feaed2f7a79abe3eed136a56216bf5265e8dacdc4d04811b56b5d3ba73ef55801274f057b6263a996e6120b7793fcf4533431201d8b16c451d2fa804d34855fa0febd7d71eb1d087209574dc040f0880a8ba8c59dcdb38ebc7c8b6b556c0845c1fc70db3218e1c1094fcec2370266be8f4b927d47068bcdcd517d58408821e60e32ea313f24f81eb0fa7ed1d0c78e730a1a0d5a69d770d950d352ce091c088d9c2642b6158da2bbe161bb65410320f698764e2811d01514f6ae048a85f656a04852e63029ea47e219e963dbcdb7e7a9ad66d8edf070807c8821fa80922d40d54418c70bbbbcfa2843ccf9cc8bcb295c20b61034c10a724bae3dfb93717407ffe79b5ca478f2575792a77ac9a8ef943e4e0dc6fb8516018d42b1be0833ec481e6ac3ca050e4e77855d6e49acf856847a1fac25d99a219ea1077a643f2c236c8557f7cfa9e288781714d2d2a99ad2cd68e6964dcb2a4ff3c57849ad7809bfe648c99e970d305dfc70270bfd8ebb73653d2e0f322895af5d67f7bcb3c0e6b4fea6ea26d3dd718b8e681b5ed53f0814a3b0eae475225a735e682759dfeeb4558168572f0335269b6f4f5fce790f093d782cfa89a521be6886a994b63e3d08353e2e8e31a2bec3651aca29337b3af79e5aac21ed54d54f45a5c0acd2a10aff182eda4120083382feae7ed7df58cc5a56edd08232336409356c21b1c21b3be300ca947fff81bdd91693ec307672b5ad8dbd558abaa2278a1f996e5d0141be69ac776fd7c317acc8a9ecff045e92ae18e515e730b87cd82c201b5cbce93ec15b4493f28ab12695dbb9400b2d1182903d61106b7c8c0c492fd5b892efc8d7df8506ae922e760b12abe167adfd34e4de683f33a00b26f4e40c9826fb8f45c661d05788cf566d9889fe16e5f94f1a91dd42276beca5ce3fe297be7f6c3976ce533a69a4dd4768d53f20b0745030837932f4913631c3a177693836e6465ceb9c3b0b4bc686b18f89e8a7f87e83f3fad65e93ee4978a88b1ad98c344318947935a1838febfffe8dfecfc4fce4d4ee7f4d7e4bd3ad9fd9bfde2cd0c07b689ad5eae0d3aefdf3d6cd9f7ca156887b9e282168c0e55827388180947dd27a0bfd6fb14bcee3ed734a32ef404680f704e7ad7c5ecd5e66183a2afd3c818e60d802ad050b3ad9b93f1681056f29d4a2576122aa00793ed18d38db35ffe9bbe965c57aad5b21e096581c5ca17adbb178b0cdd37af8fcaa100ae74ddba9d084e0787cc182dd74f92bfa5f6fa89ef1d949170ef50dcb2c7be80335959d165683c4f5c19a5a3e719b5670f3d8b6a694fd02c5c7f29ab3c05a0317712b232734f651ae60998319147200bbd7404477e6382dc50e4a5307a5d79b521fdd3a212e6e705c0d4b827cfb8b7008a1b6c5bf9dc63f03f4e70acf7e9ce68a4bdd5582bc01585dff9c11039934bc0515e609803a55cd7119e369b23ed4048cd83b33e871bebbb8c970cbecbf5b9579ba561512233a50bd5de693ec79a2ce241f8213df8b6957f7fe15aaaa181966f530e3c26a2fd77457e9f422158edb0aaa356f519f33568bf3099a1128fa2aeb05cabd1ea303d1d00518a1d5d7e78147cb4ba091f53a5d6c99bf32fa47857f2ded4ffa6d56741f09381ece5efbf9f4414ff56ce5edfa5257ac32ddbf012383849efaa8c7fd3272575105e371e7b136b82c3d4fe5a2385940b91e403ed9301dfe993bc4357f44022c0bd893d3c771e978a0b3cdf4dbea03f7355a0d85d1c7f6bd6c7dc12c444033dee0f0c9336c5969b94af1d59791f4ca95d9d88d0ff1e2f02d22d994a606a97fed8fe7e51e672d5fee374ba2ac80b48e70152785e8dd6bb3c98ff491bd7e1be3ab28a1db3a23362f8225d3b097a0cca121c031fdde4f505f6178b95f70d137c08daa122968bb12a0b52696c21db8b8873e0c2b3c41e61a6eaa569b5acbe090705c27dc23359d98449bc4b56ddbd6a63449572c77fb2c66b255b12b27134f346f632690b01b881bf59683e104e496cace8eabed36fd61f67dbb72ed1987c0730ea858e0de7834807866e5a629d340a0a2efdf2cc46d1ab6853f200437b6d6582f045d0827aba8dc4d9fb3f36a8e0fb2d48509daa0304a878d9803a09fd0e75b1c02d2e0fbac89083ce3ada64740250a717536f79a2545b7d015678203bd809b45fe8f908630ec57f5acc122dd311843695ff33609066093e8d14af98b55e214f6486946a53e2a0accb128d6cf3cb18ee8393ce314ffc899f93571fc872b7bad00721491c3c37aedc3b656597bd1ca3f5edf0c48706f82bedb6dadd354d789ba1e4f38e1d4b40d9ecb9cad25429f211cdf80c3e077f389f04bdbb01b8fbcd0b32dae3fc1f56f0c376ca75576222dd31612593050d1ea9227523c1e743e48b96579ab632402586b2558346c13fc604fe89104ff43db0cd600bdf0d6ebf05092e41bd87a51bbc38dec38d9a2039ba5bffe0bb307a45b6c33f9e78f94df76c5b9ce0a4d728a4952f4fea83987e177f0c26fe867d8e04f4bfc620ff177117b8dc67076217720943e1f373437bf7e3549fb4a24947d9d0501110f18033a7d3316a8a8d711dfeeb91bb4da2802d4cf714d4d9642a1044486e32c211db52eae0185e071b18f8b317c8551b8680a64b11b5525f42865342de21e210af2b86f871b244a8df5b85340d20e6d644d06b7a643788209bba88b70af9441e76755cc2c1bb92eda5633b00f795da50f6def89cbd08745e8290e0bbe243f887425ad3e3c685eaccad44ab7e2b783e63c64ade6039b91ba4a668361ce10c2eb9cf8d0357ec570ab3a3275d30f4a8604cb314fe8e91eb43ef520498cdbf54540aef25b04ea3ceb52966fa8f3ed481eacb6231d51a82686420ab569e00f4e3e445873fdc532e7de71d972de20a43a0a5c17724d9ecb81de880fd2cd9051df2bb16019bd2807107be38bb31039856d6e48078bb0da81c083339420baee3ef76830986c6b902eeef6a5998bc12e1a039ea0897f87b1f300b4e85179c45f83698f49e20a05c1611a7a00a8c2d70288a369e20eb208bc57f694f5ec27a6e657c7c2aa39c55a4298b40ce83c1bccdc99a9a5b2f9101efff05d48aded14e9a78a535d3e476308fd6ee6395e36a6294d3c03e9503971497f0d139550caeaed9eab817c438e5d5a46991f604fc0cf5ee20d0d38e3b780fac2c7771ec1244facad8797e5cb3ee9a7349d0bd0c7956cd269cd1c994993f8d07487ad8a052573d7f4dffe721206d58306b86381f8c455658af19705a1edb7ee7cb12c11ee03e80d5b997f0e686376fe19006fe6091ba59cba126fa539df5853faae6005322886cf4d2be098e838ff292eee4684dd2d39a026467b3515f037426c4295845a0e097418e58aad434b67e10b9d98ae111f92af0fe940bab76af88d5a3a26f3cce2f768efe8ad7c8ae672c6cfaeaa7299c5b8f908f40f2d34b6a15f263dd89fa88eab9e5d834e0bf23d39c74c36efec30760e4bc84ec56dd987ee8916a0ec289012ba6df7d53e6f245ed046fd764649c453fa611ee099bb38595ae71e8160773a278cc9afac5e7cf32695074c535027fd10b8e4b455a08b39ce8dc868aa3a701d53efd54ff87c618897035f3ada2f89a934b2a98149b9e644930380f835d94a1264f1b72a33c6e5eeb5f37340aeb140adf464dbfbb0a773971741836dcc1ae23c273f9c92c7144f77415c800d750cad5eeb97934e304f880ac9f977bf2e6e4f2dfa1b71967ad83c3402a35fdf865a1717b0de25504ca1d3b48c8fb908b652120d0c2d80a4256dfdaf27018e4487dcabb2a8d6f9f68092006cdaeb0757feb5c2a4879b2c372b1b902bffaaf5bff69ac30a312b82f626ac9bf5a5a5028029884e38a7e32e06a05da16170a2e4e64a29f92f5eb11c9aa1b207f1c71c73813fe0449e5c1e58fe059c5c8c14c1c2b5aadf55530141daa8a2caee72f8e4651e72b4e27125a80833c923024c9aeb3f735ab32f41f509938702ab9eab46786607a3a3b4b5c6862f2ff59d160800aa5421e50dca00d3f80ae9aa82ab15d04a3f2c67b991a2338df04d1684f59b981bf3a3266e7bbfc21da61a4e0869bb67a0d4b9a7d0de89f8a10f0340c1689bc29e13a9f320578a063c1e29708262ac76913b638d98f392322441f99a83ebe418d12925e5dc61ea0dba57141859ba8bef6b86ab42d9fe18fc3b5b2e1ece7594f7c563e728a6405ec19739c8725a4582183901b033ef30345fb1de3a93667bd2b4bdd497fb85c8017db2967d2b4c6a44ba08f723bee449988d406e7ce5a3b4fbb71282e2b97f56077fae7d96e376ef47b89d04a1fd8236dc431dd77459615534e4a15d477769aa9da3f4810969d62d7e020cbb0b0161e26e13c5abd3f117e3bc8663ee880a115462e5792edaebb03250ec2cbbe077741c3c908df428ddc03cf6b92263895d4c40b4f87553979f26fada005a322a16207f1e03d0a0b1e280454d92aae70f1bbde328033f0ad4de1c4ddd2ada75dd9d3a6811ada7b7b869ae82b7f1a3e71d3f113a06b73987acc8e58ef3b3ef0b9e54bd02c51ff5e490ae0e438f9ca4e80fcafd4aa9831abe0d5582e1eb60d9aab99f6c9044fe15b8a978c00e5c0e9d5e765bda59f22ab868a32be40fc1e3026690189eb9ab0feb186a25b856daad3e5497769b162c000c3e9018104dcf4fc7e0dda93a9afc30ddfbc1e05d05d91b23d1ee504a0d8efc9cfd54ce5af430c22903251402c7ec9d18682fa6c24a4f9d63a12da00ae9f6c52541ca33ee056b7f8c5530d752b1fcdfb53e0f57386965b7dbda7ae2958990b5e9988777dabf3503fb2d1dbb8e3911e270f14fabdb8911e5efe4e56e79ce7bea1d1ddefeff5ea9bfe104cc728e486e9402a008e47b2f460d9d609a154e506e714a1d18859dadae7c13a5aca588591a85ded4a778d924c1ce435a165369dc39394bb8a7f0f9bc071cca0378fe1ff19bb9c18317561ecb91c6353c96b820acad5e35d1aa2eceb0e314915ed6740eea32da8b8b3d26a17717dcef995a94e15e8b8bd3038f47ba3866644a3b77144bbaa52e5b85d95e1c2631860338b7a8656b9db88a3fc992e3fae488d9539b52e9146bdae750e347f88dffa4bbb7b23b51b1f2e8a58fa2332c27ef7cc0110811a3aa83f14b30c42c368d30b45b318820d83b0c85f099d734405064ecd8ded66eea9a6e5b864edcba2b507f9c3ae77e9539e095684164811839e24f0939f4b74afe13cf7656349d8ed734d62057869910c100ca818711d5a967e934839031fb99386fc13efa0b296155705abb951f486bae2b3ab3a75f5d863900c6b1b34249e8fc61ae5676c9fbb49da60fd4e6e99ec5f5153147ef9d036b88e4945da3d33803ec5552c7b49441b9206a26c17a213cc798c6b9872e7daa997162dca64b4290f5a23c3fa16e8724ae97c576663636cfc0d4431f2b924b291c47668346855f761192d8ae133b8c831c39954ce4098af5712d63152a2d0ad47f4751032d8f202fe9bd15a125743ce528d47d59a8f83bf6cb8e13c29d94043f3137bef707330560fc85825a2bc8d312c0df99ee62a8f2cfc8a5590d7b4083fff4278a1db140530bf520fe5bbb39c479eab2972be3bd03601df478adf4aa7d2b4f3e8412ea2addea990e3903895362ad19768228b2d05b1b18a733c7ccf969128d476a66ec0af2395bb038590743880fb6af28f267ef206f53b021e3b0f57ba418487692400eeb22fe5a3d65bf46f0b5561490ece3bf1d09f5278edf611bcd584ad27061394d487870c99738e15544a07e551ba27a219804bd555fa3b9006929b8f36ac542d6abb97620914befae393acccd6d5de9201551ba308c4b9d6f67e3c7beefbbf7c420c367eb90af4bb86a992599da3a48ced67603958e2658dd9466f8841291396ce2683ded5d76903b6538970414613d71cbce094c0e3a9a2afe0742e4d7a1902ffa121aef9acb7911cd5b0a059c71a74fa8a9d7ed84da3fa448c34ac2574bb6fdd80e23639d7b4362c4f88b0108fbc3d10a21a4efabeee7063bd0d6097d4a05f683e82d258b1f71b88d240a568d2274788dc1ed7306d3df04c512fb5b4b5cab8342901f499da5c5486290cadafe830b6b4c126596eea016ee0e9c9a8b4f5e946970ce68ab696812104259fa5cbabdb37db270a138f1bd54a1bcc3baef96aaf10f72c7b27dbf3b93dc4428cc2da41d54ebcdd043ed69cc79716c85ac27159a5bf6d68b7657252d750cbe2267546ebf30012699222ee21e6b0ac5b6abcdfa52a0e3227ae26ea39b55d6f07aae39d6275873a478cd9fb24d6acdbd853467755adb1f2a72df1f4948d378d84f7a64175797c0aebe03b1555ae7a2ae73f6fed6cdda67aa18d03a6d6968dc4022940275d72264e824f4c56ef3f8f99551726e252ee175d41fbfa6930d7f564472c7c23ca9cf3f97ae50b015926d8aa510a9d16f6e39f11df4205792d1a5dcf7792b95a0bef2a535fe62d6856a30f318fca3d9493a6659604e8d6b95a5c893bec900a5a225cbf1bbf053b2485469f2a7e3df95aff9d9756f57f0cabe86dc0ab3405e065d90378fbd55fa98794179c39a04af4209ad7653b81385d89f92718cb917460421039951175ff13c999f286d8538d4d68aa347149e2d26d1ece4111552b4d4f953a2505d27a08217eab0111f11230789747bbf060e55e947898ea252fd25ed9525de5ea73abca4ba252b555628f6b3fff5584a200ba127556c8c5976d99d7383d84ae7f565437a18f7947479dd4ee9d3e0edacd423944d97f53f73628fa23ba66174c555695ba1b27a9fe9ca8672fa9911f2a7da2cd1be23c897735c7cbeebc76be71fdcadbaa722c06f2af9bdaec28e50b6f58f1ab0aae2bbfb657f4335bf8e4941d1327355cf39dd006a230b5556723f6789965ab73beece48fac2398a5fd8dc7d47091955c41cfd0d687f51bbc99e73d1666632908906f3e7ce85d77d43f4dc93c0f1315a6c83fcef9cc663c41f4f3242f17630ade124d6914ef3fbce49db619042cdcb90cb4986c2dae944f6f00d244e49e289261625413bd8685c31bcfb7e135969f557f24acac77822a5482bc4434e656701d1dd07f05899bb13289afc523d417f744f5cefd89708fd3d6519e69dc96a4d9e0f6b7fb04876a6fd84f443bc3d19742b9a3e60035a1b28ad05353238f58385bb3c3f4290591cf05034392557edb881816f7b4bd11c84f8de74dfed8f4c6a07238c484c4e2b862b3db748239685a71a479d7f2f1d453c49501e518fa68e75eada3802fbe678496b7113c1e2534a6744feeb1df014befbf90cddaa0b96cd37be18f9021bd0990bcfe6952fd1e22d8fe0ab2c7f88ed94311c94ced8ffff433d103d4293713763bb23860146ff750af50f27d0e462b50c83f9e94e236912df0d9ea9e28d2e46306a350c4f54b6ff86e96c891b82c5059e2af33f8c9c78c7e11c73c2b496c6427e73951be1fca8b434e37c15d96861364932fe7b342c85e5df430c2aa95bbc76d1b3b832fbc243cab34b576e9d3f4ee7b41a74a6ea74b0c442d7078e68b3e5b3b18365502f9dc92285d57d752823a2978eabe7e9fca43999b8a98f871f36ad67533df9a3a68423417fbd1c1ff76cdb154ce8aefb9233bc99585cfd377c10954dd98d1f62a7dd1d8b9063e842a787353d1637784e3d2c07ef2fdfc2de26adb4105b931adcad541e531a056ada24b6009a173d058e9faff832197d45cf7cad6309f1f7828ec5332d5c1fc8dd5ab0b72bf36e6164fc86048674975fc0ecb2aa6f3af7c8eebcbd516bce51879a82b109e4ef3f86879b66f3f92b68b480e570f4c07c9c41485673edb5d1dc61e364a17941d2736bd27dec9bb0db4ba85058eddd0b16cb09d5ba819af1aeeda250a255c5d2217c6520e9326bd596b4913fda3276186b18a53f4993a985dc409bc2ee2b8a9bb35d54f5c4b9778e2b807f4e98ffdee1fc59d623699869ee72b9416608d67033653bf479fe85af51aa0879fc5919217ebe8a1e8519a10d6f4caa2978c4473e936c1f10b3effe5f0a64ee7dc158cc8cae7e3b62726ceb08a02b3da75396b2461871ca66eaf9d4d28f32d069885caf7363924b39e11b750a203e2c6631fbf35acf11dba3735edbb351cff92e68f3c3f27a15915072442eb8d35c800b5cb6afc21eadf2b589e28313e7f689e53297ee4051a599f19ec8cad54625bc8be4742f81581b14eb84fa8c3c5a45c9dc68fc31721324251464cda81613195607f808f12f9cbc1afe65ca4730d0766fa724d64a72a6f7d20bced88379c3e5cc78d756b1a69243d962c154db2532544e70d2dfc725e856465972aee6f4d657aa0e9e21a724b3f764b9675ef99c5ec6d4273ed16f40655aeb29a16f71852100bece6d2a4430f033487b5d6457ddd6282c315c8681472ca5e9ce399f699d98b5b3d0f123460d112675092c01fa1b942dca112ca4135d26905672ddf567f25a59937bedad5b3f4bc379ed81a690174ff0a26d88f1b23235b2a025ad69e47729527350ee77d4ae8b5fc45d459efa750c1d8f1ebeb8ae541e7635bb26e145cbd409144e903ff505bf0756b71d555ed3a35f9088c9a18d762d6c92810b5010114b79e881c4836a76482563be14f6786d9791b2c96b76efe949681bf8ba5a905904cd73808dc6d98d262592814e79ce4944193ce85e5f68e644848ae1ce7c4f32c28b928d80a9732fc09f82b14e2aa6e7993fb4fe6428d3c6058f721009720a75595f7a07976010fea795de296beddb1df0855cfed2051b83434f6d70cc9446b385609a0614b1dda728300e1946351246b69acdcfbe391d0a2ced85835d6c6c22cb220305462835e2141de3b71a7295e479b8b01123585804f1fd876130bfb2352f9a10780bb16756c492b34f939748556ccc07715dad10ee613c8e9379aeb8f3a70c6b0a44cd4a6a5f888bd08d7fe8d1bd53ec18770771ddcc0e6cfc42a00e2bb052f4eed3967b9c94bdca09a80c018870116ea213a99b585604a112e8cbe19b205ca80867d8d65dd8c1e6efbbee0d280bbccf25c4500688035f813d255638804ac06d678e178a170aedff2471dbda28303972e0024eea4b150fa861f659b2d5aa6cc83b4029e4839b34aeef30667e32a46f413fdbd282424db162d366aa74afa70c8773665430168fb687add511c127bee143d20df1594c2ca3f9f65c7dc97a64bacbecfa55cf1564a8512c56b34f22a2b9702bacb1f5d1853fa32ba3a2625bf90ede6c3f81fe8916aaf7a684f9452138e98b4db8713dce5f570394dc933532a967ad4033981cec79e1178a83c9cf47d9b6b9db6706ca307a5443cad3854b45cad855c369904d17a50d8135d6dd3d053ff26d52b35b19cb7318a222aa43e29a598d47a116d8a9170fb35d19c61e937bee178bd23102e63cf74511a555a7fb6a9a920a9df86cfcef5de476f680b84be79fb0b7cc93f3af2c3be9586ebd038b4ec2c47c371bd2bac76ad881d5c695cd3e307564b484942494100ac4691085b1c0e50bab21988e0f2548c6b7a98f813796c29ec3b886123369b66533c4067b25cd88070eedbbe517cd61ae42125fefebffa2d67e9d9bdea3dfa26a60a972395485b5c76401673a9e3379c9e6f54af7379e5bfbbfc17ca27498f920d152841d416f6caa97b86bf95c22219943be66656cfb1d8f2787831b50f538b61db82d9ddecd47a7af516334c1476bc46c76fe9f83d7442c8727293d58fa1de8f89cf0d8cc9cbbaac5f2bf631b66205c9ed5c69f1fc670e1967daa92797b210485f60a22617248cdc6cecf1865416286796926b4bbb5c0ac9293706f07a732b4d6ef77b126f7af0c58178f3a143647963d6cb75d3eeeb7b4b63bf994c5928bb8610f9aa7e89f75a3d3d3946c8541587aa4b6fc436b7ef790f5d2376d84e2464edf18860a2481c59db7110c4b579c705f196d48f3d1b5ea32f7f44ef5990b9c283cb7f18bd46ef3c9591d8516badb5a1cf209a5401f29a0e105a73996b362e345330586ba962d0c8ee0b836cb4356c7e8b6fa17c0e3ced3702e4c7dbba26ea537fda0aa3d3695f21fcba81e17e7da45601916f956dc31c9e33df968dfbb62b4b24f1b5014c029ad93db978ca3c373c3b93cd548473bf9011c6adafb77f05894d942f97754fcd9974840478ed34d64479f5e9271189ee9ea86a44c38127ed47ba8fa0f7dfa9026fa17a41d8e45143ed9485022599a8227c3679f4c91583463cd9390064ce6afaed53bd265c5ec752e357754dfa112c98547d60d8a12a97aaefe073ab6e08ce1be6b0d50ac4aad95ff88126cf891d96f7d5a1558df5b5bdc29af8a322638fd79409c43865a2f3cd7e8046be60e119bc799c953ce319c4882bf64560d28506d82c8f99c735a9f47506e0a61176b507904331240242287c65ce2d564f2571032730823b90146a9baff17886aac96dda1d5211f7928728f6226a57c2e93d6fda8786ab5bab62e815148c4b2da7eb674266593f50aac062fb59c7fdf7d8e8f771a1bb64baafe98f9204cab5854ad8fb08b4b289f04edbc18ce44f506f953fa0e09801604c36cee8d1254fffa76f4efd949b9be18947b87ea70563fea2ae5c0967cbe719454e0f26bc9ce06bc0ea6b1bbf0b5cbbafb39dfbe9334a2968874eec60027f50aa9e3d4dc190eb91a08d86e2c2bf8810f743e01f9de3e370cf50edabfa12b277b90964d475c5aee4fb53a9d71b110807048990de2e5115e51112d6f3c9f31375d481921bf369fc088e66f842d5a59e6200799671eefba4b7b7efeefaf4775541e8922900f06754b6fe057bd4ff4f3ec2d722f8cb8fb4d1147eb2a330c51f81541fcd6349d2907b1e2123883d669926cdedc7488da62e700a16b7e9efb06005bcd858f68c8f60217e417beae398fa5abb8006429c5c7fb7bfb81c746862b66b27b87e8e0eadfd158d3a90e59a491fd80ac1157bda02df74a490b8739224d65160118fbb621a0f2b15d623e6631b53f57395258c8d054803b0fa194069ea399630189a8f6b3664723907cef69fec94042f869d7c8c5daaf59a68d0773013f6855a7200697013c96461845f329631e9c3f101450c18ef12add9378853afe4a1fdd30e6f2586f7f36fc6c137697f9319d46448d38e0ea6fd6222aaff3cdae8e51034a025c0020358d81a8c4945b1248a90f0d41898400357656a007ca1e525de63ae96ef853f9634bfd47e12bfca4c26aaba0c6481b95336370e92ee493c075518291880caacc78bdc936877d0cb75ea2c450b48b4f6bcb14cf081c7383d0883760ee132769d1a6cb5da1d6b323ec62dae9931f8a551bda9ac4c2b6cea79f29d7803a502253c4daa4734a5814bff2f71e30c762de23809578134ec187f7c2860fd47aa5b57f67dc861b29591aa50c99168742d4a95f780e8774b1a00094b688855c6678d0971259ff7df9022ccaaee677f5d5d6e7ef794b4fc9872660ee0bfd10f6972fa8f160e7600aa9d4ef7aa553801c462f52cc9d277386e34f523e16a42f2e831a696655d0973c8e0e461a4977a1f94445361567c2f07a364fd307e9fa39063bbbbbe820882d079e06bf4e3429df8e2dafd1f3e1c0903a6ddceefaaa872d4538047d47a3222f8d09fa75d57e64d7417b88fadab7336baf175dd49e0971c766de4d92d3ab6a81485b4f87a48ebc8a457f492b96181fb986b35954be1f32e3390928f040aa6cf7b4c4d3bb6f59726548766d2a0dd142b1a3c1f389a704ef025a928b915d1c796d6d864a2c9e7fdb202f24ff48133622747f8826d145617e3b85688886535b063b0965203f7ac5ac57993368a74c80943f926be246099b65ec224efbe402645673521cd63f8623208bd6b81e2fcf5989801e4ff9580a581fdfc93342ce0259bf5c796b5cbcf5cef293abe5c0d8e61013c0411e4f56f1e2ecb72f483e98a180b9d5f628c8080a9f7068ce59afe81ad837145cf9ff98b1d790d84c7ddd52a20ade92cb96e63a54865b6d29042bacf6a03ec6a56c6dc0c7c74a97348fd3f659c67a9b60c430c05becfa1aed8011e6cce3a4beace68a4591881a7371196728fdce889f3df12d9cacdfcd6835f4c9a3279dc0d7b7aa2a9bd880783b2b9fc697c6878b820941ebf2cc61f9071a850853f4899e58603d905255c04a886f4a978b0727efdcab1147cb57b43c0e83f2e96f6eed3bb8e375e6980885ab9a2c7d2ee0e6180dbb2542686d8054e24b25ac4a40255efd449e0c09c2160bc1f6badaf8d51554cd12417e7702a478400d9b32d9fb1d564c30272005a92cb6adf2a6dae943518da49e8efbde2f77610c936031d1ddcb179df78e1884bbc39fdf99cadee8bdbbc074c92f485b606d5dd073f3083f3009b5434ad76c597f76e681ac38032e2365895901f4c0bce4573f7634e297c86ed611e0bad1e1e1caaf1ec2c4f04f50db50717c5035ed52fa03fbd1677ee53d008023506464bfab61037b6d8260bbe6c7cd9078f02efee4471dfb52703c6f20f301d7c2d64087f2fa6b8e762afb93ad34bec962e68df1b644f31f670d8ee085435eba8f5b67a97c86a0a8a7bbe38aad00421cffe7ca9a9e2d91d6fdd15d3c3444a7f45028f7bc7fd01d2362aa5704ed8a65daa4349dbde953b369bd29608ec2196e98994900d4a8ed5e1b3412dad2b8c49fd3d69c830760c9b0e9422e94bf97d50b6a092cfb0815c35b6ae7466b1d8a01f43691a62be013fa5a24b7d87ca0cf5923af602550a6136d98fa14abc2e42ffafa1ff9caa4118993363c30d2012fc803faed08f063e2ca6665fa1608d91d6313257130c147ddf394b181f76c971f85fb736dadd4f670864dbdc3f1841eba42fbc670b8e2a973b7f07da57462d1410c8c1e68f752b27ff899114d67d9c5d58fbbe20a3b0dfe9fd53f4b90f02d6aeca4c36290aba8b7928c816e8b9eb544fdaddc0d968323278a81375d44b277d8a7c3632688607fb184f7930de0456feb4ebe686d7336fa98775ab569c3163824f313c2fcf661c5b0c333f20bd4d5a3c9d409f2f44d0eb91b6270f8b859010d792b461f4bb5cad40fd62d52ca03332902fed0885a9d69712bfb9ad830c1fcadc5b9b880caee945dcca51a0a017fb348a1a4155ec9ac22e44634c49a863bbae4ec64aa4ff8bb3223a46f8c247ef9269acd9468a540cb2a296a66b079a51e8c5dd1e2aa9e044f987232b9bb966662bab3938edbf46bdfe59eea234c7211b77da0c8aa72e1c797b15499cb415581740d100c0a22c8b8dc1f4a6bc0e93997ed7fbf282f71e8f13ad237f75f24d2260705a4d931e12a8a27236cc4e541f74824b869c782fcc1cc644939d2612b131fcb8d3b0a32f49e2cd7fc857ac63b9ceb2af2413b5dc34666d33ee4887b30f0c4356cdabdd5e607cbdc28e1158a56d449f53e6dc79ad803624eaf911c88362dabf6a902981916e19002a982eb49e052e9fdd0d26ea8b6abbb363eee71f05d9531c2436bcedaf78ec44c85c26a7fc6aae5159f6086cf0c6cf6015a269c71719ea72bc16033acd8c7a1b163c84927a4964b0d152c3c9883506e3d7854d885dcfdeb2ab8d673f92aa5b1d86bffeb6662d3c7fa8585e8fce728a60ba03e1adc073e59e2356bb07cd776e542032377f7bcb8eb4ba09fedbe183d5197f95131806097f2573f3dbde3fdb0e0f44531e9c6b2af79b19b800de77945388bd6762250a62469644240b9a7f81292950be02a8a462e525f3f35a95c566000e842e2a34cd6ae585406a839f1a5458d7cd9349ed3a2fa66b8469b23bd11c293f154bc0c7187c81f5c69e493b1d55ca843c8c0587e1625007862396a4e2ff2165fdec33b05db7ef4c39cc6a7b2f73467f7520fa7ef788b43c14c35ea84b8268919a4f427df39919bb6403b2a9e660b3d586da81fffefb44fbb19e5192024a8c2063a3f9bede2eb4c7d71fb49b7ab0d23265cace5a30182af6adaf5890aa59bdbf18e4f9aa66e247c2c237692f9cf7a28c681bb3f3c032ddd7d0a0d059a5497b2ce19e7e8280ddf56990e3c294d652b29725705b99b39893f3df29520d34aea42e6baef9b52e1af0142ced54034fe93435054c9bb2e00d83b214ea83cbd2601e4559520fbe6398f3d2bac9420459d101f6994c5ca9d87e9558618adae80cea41263fa1f6ecfaddf024f8370e5ab00a5b79acc26c16828e070959b729afcdfa0ea66e6c4f396f483c39eaca0ded8e7d644758843764e752b0139e1914d412ce86cd1d05be73d0f24e205b770487a9d6ba1506ef4867b20a0fb50eb03e61846a8045c307ca3fd623f78813d8c71bd3380bd8473185528d58d3fec727ae3db25b65ed6fab0490a8f173048b091d76bc3bee82316af613c7a10d477e01dff78c3bd5be5fef4a41c9b9f1b37f79aea25c69668a04d74c16f125de2f6b99a9cbeef6f28b60c4719a60bb5266e4199a503a189b2a89b7c99c7915d77dabb5eb20038eba17a578048c021a4545e93825f72bdd185a0b97c89ea08bf75ec4d1ebfe62ffb01b0eb7d787778c4162e0376f85d17d7555a12cda81d2cfda032c4dde2794d824839e6feff800601631c334535c9defb67c83617a31cfbb64e22b585fc3af7023f35365c22679dfe1ad462e41da770bacaed2576cb8234ce5c601a51ffd11afa7d827edd906710ac6f0d07aaa95058da053822218696bf23613008e57596f24172c59fea065ee7c31da798e1d2b9027b244182180932cd61e1528fa359d668fdcb52b4bb15b3d95e3bd4122f8ece8faf261ffc2e6fae0c1c7de131c9b699002a018166b83c0dee3d6296d06ae85b033c53ac3ec93c0e0b77d560b40272af8361857c4fa2aeb186c4232b78f89d08212416c5bd06957dce97e9fb6f21b7006fbd5ce28112ed8fc9fe48cd3fa5076704581989e48677cf9fa51fad30d3b80fd29b30d31be87007e608ff51a8c5cad209b29da18c9d24ab3e7ef809ae8689fb4fc848c7446d61adfd9dd708265e964e87abcfe9bd81788f52696b8e51bed63ce9b581ea0233032238ea4db419fb656faef388af87dc26acd3e0e386feffd19907d0a55ab25e437690b5edbf16766771bae46c7952fba2671efc6ecb0dd200b2f787c0020ceb78ab4151ec129381984b9125a632ad7f970442ae972bc7ab6e7c9b3f0b6e9574409f3195223ad5367201c9e487a50b787b5ba93bedba170a45b0fded6728f5713d4bd76c73abdc4cbcd7f610202d9000f8b8b9e054fcccdffb1e1d5ea3d601363281187192d334d71573c81e7f2d2a0517719be17539b3f06c4d30422ecca0216e1a8cfd3d427d236d1cdd2ddbd66e8bdbae46ca2947555584dbff02634ca3a699930ceff17f6fa1462940aa40faf9739db804aee5480a3d1b755f583057c6a37492029a2cf7c964a55fcf8546554fce1cd1292991aa358c58ece6cea626d83832c463158b0f5c50c1f8f068dfbf8a0c3fee2376302b7020eeaacc5fc0c45ea6af30c1aa8265e8e2f7548c96cbb11b9fd0489cc046c50e82bf364f6abc2dae2a523a824d8fc557f1c07e59dfc7789e9288ea254c0d8cec570a134510bafe61b186f5f63ba81e41caab8a4632ab69e307741c9981f5a88d2f453690d8649032b173e585c2012eae605d1766aed30a20adf6347a9c36ceb8141b180a789e6939cb6084b74f92a427e69ad3c99a047748e423ff0558fa300e391a63fdabe73a49fa2c5321b7b6d08d147a8bf726b44a26c296119791f4989a31658e3ddc4729d5968abebc05a2de6e3331b11de991efb417f24d3f47ecbbf173459d8c4c2e9627c16e39803eb3ddb97bb732a9a7e421269cf6f40a5634502d33830a2d9f9028fab95332ebb3f7c07cd41b47ea7e436a6834ce182619a4447ff51678647a2c94603f36e4d2a6249d88fd7b347bba24ad09b5cba98bbd6ddfb35a9739c2eae1332d7fc0473d315db8bf1d95df921f9cbc47c613c0ad339539df22e7f7b819f4e625e071ebd83ede5a10e30a873c049bb5848a4382a6b411d7129a06bab51876124eed4384ad03604b4478b79af88f6d032c3f7666fd444450578ee8ae522eab6d02b6ade49a61aec6b0ddcd43a8faee372b0bb179205f73c377c559907b230ae9538a4d7d650db5a71731e09d99f91a23e3a01d75e4cdd62d3c98670b9b943c7ba77d22f8542e56ef377e8eb2e7f981cc690815668ac2b811bbf67c7e034297d689c67c56a50c71a02ec27fd3a8bafe71cc9610a5273bc07caf4eee9b6c7ae5c7d1ee91ad72fc0d40b18de4ff5cf29ca0610948fe1b6257ba363f123e020a1de06df21ae038a8270265b79d790b4ca40550d665dfc435dc9bf80377f4f830df4f4c0020d0441dc700ae325388039360e33978f137397c6fc72d9b5286b4a6a3b384e10a465c6dee93fb871a8505531f7f003d3affd8adbdcffce662f542aa446401bc943413e6d85059e43d64b10b3ce392b3889982d43e2548c959cbf3604dd709a69e44a0ab84c1f1b96de5bc95fcb6819394367f636f122827369ec3550f8dc4a20dd0d5a32e5840c841e05b00588b4ebe6eb70d5ddc80358243fd9b331775de8b0013576a10d143a42e4e6e5a64c800c232b65d06f55f6ac7442d9422eb17aa23e83b010774ebe4c08378b2919c3628d878a12d59e099bd6b4ca879e0505ecd0c2ba6cb619dbb1f8612273cae5663a569cce28732a63b68d2d8948f76d4ab75208dbad467da8e84361c7a0af348ca82efcf4bcbeeb27e6adb3fdd8e2522c61950a0e1cb9c22d9e9d2867e8b739029833f38f00f833e4fc467d2b1c44c5948592ccc1fa04f892715aab8c5e821be0bec443bac790ff2b5fb15255139046407413aedfcaa8f799b417d0597a5ea756db0fd091f6543d13d853ecf186cbae8a5f26735f814c26cd74145a73753f0894be3514cdd42073deb464d128e40af840767e2d9ee2b827f2c3af96b2ac2c047a128b3c1c0c2b76e4fd708f5a2a70c13606d1b89ba91fdbf1aed6b8d0411f2506e04f1af0dda330be778ec692dce1b0d0442975524d719d6c4269ae6fe53cb8776540ae08bf99b6f514ab73be80eca7b91626aa2bca76bc3bc8eb258a3557e80da31f421adff383f003e19a1b28c1787560d862fcd49f083fecc64c1b89849c40969b230edfea84dbf5c79d569ac1c38f4670e06b5642a96675e16876686321e270f54cde898493d780fefce6d78abf5d4495f7bb5762322be221bd7ecb3229a998608cadde8c23da0723b492ab1c2c679f5cfdadeae77f2a5bbba9dd19df07555bcf1d3613ef7c72e06315d9ee8b162cfd39d787d3c92978310a6c5ed6062aae7494642eca4b38fba7e2600f2c723b081f6aac1c4249dac9172c317a5a230d42450d8cc71eff4f7fcb3a1eee9b841a864c2ab19a50361097fc1216c50ac83b5432d3396edc41046197f0613baa2f87238679f2d2cdb19eda0302e60b7aae90fb052bd5cc673379b1453eb2b96d722d135fa4a81000e31d46d79e0111b2d833f0c9aef506e36daf1f59b496e73d1bcec990d73f241f38028d92aa978678a1be65de9616869f93e88a46c66522fd798dc2c6df0bfdab7fabcc21e33a9ce1555e07bd1dc20233ebce6d56d970ffe76d06fec85c526f92b7f5783f93156eac148702a92070ea00417f303c8b82137610d40a42c505b9ec2f4202a9dbe2c6a337f18ceec610b95146107e63c3e66111c439b0456075449b51873a7aacf9f8c79f307da6945037aa8d799a126063d8bd4181d808776c4266dfc3146951a131bcf8e679ab58005af9897963f471720ab510a12f5c21d3c89d26d9764e71cdcd5a30c6b135d9aa6645487dbf32df8e1b1b6a2a459682d509590a398220dd4abe6b6515c8069e95031394707c72c04249f5dd9794abbc457e19125cb97a1b44f437f0c79bc0d72caf54edaf0c39429ea98ff2ed93ac0e97bd7910138e861c918606ff6fabac00709c33847ca77d707aa8346d32826167cfd7900b8df60ac78271add85ddd7df830eb5762764a70305ef52837a4758916bed1547ebb603343e24e225785828da4abf182cdc447c04f75c613e635dbcd77c8db093b7856ff93e2fdf6b24c03413d5bf754f71327e08d73e69da9043245425270e9eef38a42552eb0c4b8bad0c7ed636148bf24911b1a3164a3f3369f290f1e6fdd77f02014b0dbeb5c952e1bd8402350389727da8374a1a44d589548b6b77135b2d8e150ff702c33b74b9da2d49002483b663d605e3d8f960f2edcffe3a07f287d4a8c45bf7e2bb47d6e5bab29f1415f991c6b458278812c3ac698e554518f4cc6c3a335f86548a86317302ed501242b4af549fd6a5510551b8f17df0d4127e56c2b49b34083ccb14e31fcda57440f0630acb7347ed53263413a204890a21d66eeec3d6ab4a5eddb196594c7b6f086d86969f3a8d56338364c787cf578aec84d642ada92b77fa3c6b3e058b350456974129d18866eea9c7db6e43c9f42350a4f4ba43022731d1f5e12524c7850da2c91967d8223bcfed458507bf7e0af510367db6f65cddaa7436264ea1f0f0678453e95487dff6928e4a50e921e95d71cc99c1a6bc93805f5b8b224c30f889c4a33590dc8e3e3daf74bedfe7487bf78bf80d938f5452afc237f322d7315668f62563d45f03d3520cef7a2fcdc02ac7c24c344180313edb5539e8961e1abca418cc0980039e61352ae5696f87dc30b47cbc473559c59336f7244f4b5bb13a98430cd44e3dfb6353993966a2ac3c8d09bc76a3cdbd3b6b27e3c143b3085dddbc8384427794a4fb2758ace15536e70235f05f352ce2549271b58bb5f5a88f1c1e7f1db2d219e8dd11b11767b010de822eff261ec800fbc6626aff1982a59c573ef60afdecd2772926f5779db7dc04c68af40e08a5d7d4444a157b9e810d26871eae4e3be27492b6a1775ea0e8214d2d2c4841565eabdaed1cd278503b4723dadd6f1822cf07c44e045f21696410be8213bdaba3577be6e43e1b06c026054a178567061f58e73408d530afe548071286edd5db53606b8d93e09b05cb120bf3028de6d491a1ac2dd8ac890f881fd72fa5a57985821cbff1e5f1cb3f8f6c27bdac843c4563ffb4d749028469c9294ab04586ad87e04425b14e99fd38d1addc7c629409a51eab65c90f3db8f7ee67bf09c4e70de26686baf10557485a47f9d3ef408700e1f0e5f2f60e2064efeb9312a048a858230bb4eea82e474444245889faea58cd12de67e78853ad4a64e7ed9f5d3e93988085dcffcd6aa76ec45a8561cfe34959d48fcfb4076a4144052e025f0938c6e10de367d93c053f045689b1a0221bae80a8fa10eab9ae253c8da2120ecaa488005b1e2266681216ca314f15229823a71bed33cba32b8412335fdf65cfea9b28325fa84c082fcb66b8d88cc73593daa6be00d8c22729904284e98755fb8dff15b6ce1e75386c4a3a2fb4a9f4ac4aa88fe2a9cbb3c92a4ccdd5994095f24470c4994fc951a874d9256c67fbc1dfa47c21a51c27d731cd97c57747355bc8a94ebf2e44a96f186a65cb6df4e5e8d9676970f6d627a1bbfa734d9538529d3ebce6baeaf86f9e144061636ba293f08ba0bc1b500e5a99f1bd07467af8849d1cc9b8dedbbcf95d5013c5524743a65f2d6282a7977c1c3e295230e1a7a849327f1ffca27ca4cfcbc1f81a3e56b5a972f735766752ba5143e408f0e5bd3d493ce6c2a7a6c0f414ab86222010cbe496ca9944fb67de48f918dfc825d258ad2906bac80e3e356ae48409ecb88d0238544c15a86212e07d7666e0ed29f2793d61612ab0e41d17e95394f30e7a91ee10ded4b68c488958a4ed320a4ae50e203fb3af5f08706f1f2e8a98804a7b9a97d95237edd9e916381707135266f662cfdfc5b16ddc0207bd6e37daff3d99a6b7e4485607fdb0e88e6105565dfb6bd89bc370e5be7c4010c249ef1bbc43fa220500c7dff1004e5e8a1e33ac3bc139e0b297c8f10d82c583a3ea7ebd27e7cafb0bf8275f746090e6c6182f06ea437e4e993a28e6cf7137703d9fba1cdf5e8acaf2820030aa90c23b35ed1db22bf8c9408db5f0876a69df6db6eb7d1363b4b2a6b55173c07bd53d54df1c00d1623f28d81e1a8618c5dc13caabf0825c2f7de72ae589d27b081e3017d1178d0d0dd794ee3740f247eceab7bf79861920a94583df358f0f813acf1bc2f16b6f7363fd8d4d6827f04ff5481e79af784e4ee168c05289417f97fa41d44edc43a52825043f4c9cfd8463139eb173c016904ba3cce827e2d15bf85d484ebef0fe982d5e9f632537052dfb61df006198c5754a8c54ab06d99738d75d6aeab0837efc6a6ee8b7211095668f9d8187caba02c171bc9447ad5b1ada5dac9ae7ff1859bb0d81391e141a00296f5e0c759bfd9d00e1126f14128ef3d8ffc706cbadb9d32cb21a7321d5677a120dd22767738af52bcc5f0643c6db46e83cbdafe6c785de7ce4d3015e19f460fc3a5db28e9f397a33626d8b965de41a7599ca65d9b972149ebba348a49bdcee071efc2c92e2bce4b39c5a73888a5e1383128557bc6329ebb828758775b3f4139938560faad8d51b7d5edcccb8c32775f500953e056623fd4d9ff773662e99f51ee62f4fc4aa72e35f3d27d2e2e77b65eae874da4d43ce71e5960d718fd6be9551b90533d150b64d0a80c9518eb62b7a99ae22d9dfe6b0f823e20a9acf45735eb4bc2d04b223aaa3d762810ef50fcf3d30a6bbfe4c8ea8580cafafedfd67a104e731b428363ece4cb7817ddf082732ba7980da0a0fb3d690fa0e0990c02bcc8e007cf85c771998249c3f2fd4c7816289b1e4aac55d1c6f71a5ca0e49e907fcb1df3a5c50828b7978d1c74171c832f7425f6aa4effeaef71cd53803d0d8015849d4d7f9d2f5073c61d588e05c1849db9d74748a14c7b142eef9cc4f8c61ca583d76cf9f4128194351923a92e2e7ffecf75305ba10846cddac772fe0243827b7fa5ee692dd5a09011baa9dc91acfbddcdbf072f31aabfed9445bbf8cec1709b92457257c097acaa5d0f7c850422200006b23e60c842912c9a3b4b5a37a750f81d61f6efb45c1ece9a2decebd8f6bfc9e75ce13e9dcd63974f7432c03dd88dd97a916252f1ecb951a9475c42a5290148be15aedb3042b7072ad3a8766523b5ce248fb3832bc342a8dbeafd542157f8b9af9b99ec90d2bd69743b50adc64efe8f2fd25075259c9efbe179f548a17d107eda96b2dac4fb35da60622445a13ec4a95e8cdc2af0137b5d3dc2aa50a724f9aa0ee67dec9c392d48e7179573edd68b1468a4c4cf572b08abfbd68b7b610d614437fdc337a14c919231a0401cc77f8f9b817bb3988cb67cc62f1aafabaa8116616e5536abef0b7c832d140893c884678eae2b8a48e3ee4e5619093ea2dc3b0b2459464ff66590bcccd24726d7ddc4993ca36802b955b486969aa873b60c276a9a027ce1076f634de200afd290433e6fac8e8ae4c9b8c76cc4dd23ca00674b8b0a727bacf13b8e61e8926dd8045456aff360577753b115bf29d37203a5662c00df8dd20230ea3cb07429a113eac74c6e901e186e64102cd4f99bbf9ac8ee33e1b883078282e63cf90c284b9c9aca953aa7e00e71252f248330170d3bbe3aad23d8b7f3499060f64cdcc6e1aaac5ec2d3e9e4a29ae604187717819abba41570e6760743b712e6da50581fd1259246400936fe031bc896c1a26cf9c65e6314b267621914e750897d43c43033a05eb44180a0ad5444d2a6e94746e2f375f8f14166ca08c9d34f4a2702f1a2f09dd11bbb9e34f6f564beec9483b279d167a9be115c8ce0982b0ec8c6e10836084cc28ee69e7ab235c0e6eb37e9a15986eb5b6ace724f61232ee9045d23335c01163f590f8dbdcfe4cfa3b5c327fbbe834b7f5d20bf8de54a01dbe1c49dfd0e488f589c50797634f51139d13b1fd2e11347ff39c834f11135a86d5442f360ff75851f79a5ac79db118d1f2b2f17dfe445ed2655272b676ccdb1a80b82b012e5728b3f5dbe9db2d6b87073fecbf6ddef28c00fbba91ad732fd50c2e705604469c08e8cd1487b816fcbb06014f3b9e12d9fb6fab82330ef3eac7c3abf7cbf98057956aa41f5d5f4d8ea94b76260560bcfb06df854da7119ad1e2fe456b69a21a3aaade04f4abb51924df00ace58f36d5421392810a493f5c0cde0061d2597be309fe2ab64c0fb293380ca63233c3b973a2ac21ce3613f995921009c5f29e66b60516ecd46e184efb09b789669e3182a49a268cb031b84d93f3eaa4aac83c22c0f94c0ca638ff7ad35163290da2399b2ad7f0c9e8717cb58a326cb50d9fbaf91bf0407512f6a44b8132e6cdde53e80afa698aa1fa9b3410770231097ffd7151de99635aa6a4a5c14a3baa6fb1053352f0d2340e2a8056b9c2455560cc6219a39d3bbb49fde89643be7660c8bdb1c50b3d53349b4267cad4a43b1b4a7bf46fcc27751fd424af7e0c03aea40e43fc80c75ce033e926dc6c4d41cfcf8e9273b86bc29db58a837ce9100e508e4534033b7011616c20647beec7147b8df00431b3d611a78a865e3a807c16f3fb04c4e47976d37a4783f090b6c6726c9520a5261f48d8f4ea84b445d4bc82f99ef7971db48064b32defe8b47c51cf6b763edc559fc34eb27f40bc4aa8ba137b3fc2226c68d2b28c273c9d9e80ccd3a80626824be65e8f64549f19fcbfead5eea2ebdf8d8585a80a08023ef2d22fc7c75fa7d74b9c6e3f022fb96255fab2b8b755107014de68cba3659cda807632bab3ce627df9c364e5465dc61e18979b20768b5e2d096c36fce65742d2595aa979df9174b56f3f20748b2233f5cfe0d532082f074127ba59673acdf8289e983da11a29a8f7aaf97072b68f3bb6cd450c8b128e8f510123f6abf5c16cd5e19d10a7f5aa5d02c155f776c906c6458ec03e1b1823722b0bcee8717570e07d78f51dd4a4b1d13c511713dbce34cdfe9c0d06fa32c1b99c43eff179cacb46f330a28ce1999025c05565039dfc232aa8b11f79a0b7d70e675df72e5cbb44866e94dcbde1da4833d6fd1590174c2eee942ff3db94590e21befe4b63efa74dd147d1a85a071b632358759278d15a1b59217d1ceaaae03a1061d9f7c27bfc2963950bdae19207bb228ee969b70f45afe960c8bb6439f3fb39eb8913e48c9879443e66dc18b48be8817eaa119322ee35ed29af3b215ac2a306a5214edc659a8345828dbe5e68be844c52f6f6d27194738c8e3a97cacae3a2beb82fc6ce65a0a236775f20edd2d690aa97d45112551b35f7c6b77a9f24e20ecff0b49577a81420243a8e3aa725bee9d3bfaa7cdbeb2de26cbce7092a9df76912146bcb365b565662fc1b13e827dbae8c393fd751d133f65768857eff7b753d44ea0667921ba1787bcdb319661e35fe3a46e948913ddcdba300af6207b29672c72c3893cb71b20b5d1b7519ff2bb4a9cdde20bc087939330ab285ac21b3a2e7285a8fddd5347e4d3c60b5a20dfe19c998586b5d7324fe5315205503b13894471c68b977430eba32eef6f1a2195e804295b64247db95bbcc077a22e9e2d9c76d33a1d8db4ebe1cf0115a7fc4b085b69109b7cb26c9ac41f51696efab96f43a4b9110766236c7625c08e8ca06c91bfcc50655f6ebbbc05569d1e02092cb98c06dd9658ec6beaff6d484c279b62c129890ed1890ca1a08141d3c9eb83a0213bc84434304672929fd52e62d409ca83f355ebbf7c02020bed994aa4ad7ab41281e15c088607673a545581d913d306a9a07db2c40bdb9b97ce44c582825f628a688d85efc6feda65514458efecce31bffdb795285728fc421c87410af5edcd991e070cdab9164e16521dbd6cb37788d854cebd005d12095db54e0f920f423f417d23840ab218dcc590f193d4379f40593e682404d98a1b23d9ea394c1682a67d72b24fbc0bc3be247af8e38308ba8edbb1f5fedde46d400a0f2561cce2aeccde4ad51925ef18f9fe99741ac9a234b4b264ba3118f40c6b85116ddc261f58bf4139c3071a2ea7894d558cc541f3b36d08e6153f5512f16ff22a801cf3e015e10ec24f6d1984fd756a71579b47b2b3f8987f5c3d782de8142c018cfbc501aafe7a4c6ab61273f9fd689166a0e849e98627a53b9556e68c1756b8a7fc810de10d1e75d29b0067d228504789958099d93e17c9d803819954038a0279500701af94a1ab5805f60d5846010491f4979e15e331aed8caec50de3e23daaa5f37394605b0c27af463fdc654ae70c9080a4c7fe41fb46abef3144c3530430edcde235c60c972e9aea53af643f1d7f697fd7eb85a3838049b6db04818315ffa81f4e1c5d07254bc6dbf5173998bb68829b1f67e0eadfea8267457c8c3d0e1c13a880eed38053540004772df9f23e27c4f575ecbc104c312564e30caf1ade1645e2dbd94df78fd7e91be3efb1d93732911a2a4c89ca5a8c34ea51755fa9d6db1b886f00f5f1b958c48570bdeedffa5213974663a2db8a3c6ca0bd828cd7a06c972f6948fbdc223a16ac7b1256f02e1c584ff415ac93e2c3da14c40e19e2871ab1e8f4fd9dc17909282ef5b2558cc4b2a390963aaa360f1d483e44f3f9963fd1ebcd8f5e40e3e33d74858a80e7daf703e25a9bb42b76fc30a71bf413312bde483fb104c464706468c487cf292b15e1183d73c256a90834bcb4419709815da7db7e906dfb432821e710b484981c9ffbf4162878f5a3938687daba0937ca4c132d5ed0063dfd151649e7e633508575dda858669b4b592a8d2b4fd37d8c6f3d851237eefbeec4eca6701175eaeadd86e0a0da95c3e7333078b4f8dc770e4bd75aab24c90f137084c400b9868458ff0df52dbb5eafbf657ac0b34c65ce0cbcef4714061ac7e75eadcf633d76f435188bd08b1c8f31ffa5288b2c7cd24ec798f0d4ef7d957470f1a26ccad1890a79e523542815dece124b5f9041a40b39da09d30f2855af0cf71c5693aa395da5bc503060e56efe2a3529a1e794bf99229b2c87c251299b3edb5b097fa24b0d8652a5825166ca34f50dec5595ef02f045e841ba8e3bebad0b7db133a9255e066c4ddf2b123ab1a3c582b0b4d403aaa823737c57162424f992a9613237e59f17c1058050ea61c23e04e70411308712c28e16975fa9415ae749f8cf87a8438a765e9c7e3c22d25d6f99f87e2a6f52af2ef72cd7875efdcae3c62adde4aa7d13547aa2c5c4eac911f21985029243e68f958798f6139d25d4d94c5574f6170972872c708454ddab378fb280311b5e34b4b94c008c84cfbb7a041c062a1c460c903e3ea5fea41b63d2cc98eb68621ebfb335969369d6b5b50683da43fa60256cf16dac3936bf2764b43556c9129abecb2a34be19ae373a5fdbaa2646ef6594fae81b25120bf3ada9a3147464629895547a26412d0dbcfe275df11de85b09b41e6648beb5905e339d6bf5734f6f9e28e51b040eeebee43bb282befe252898eaf411e4075b102fc9ca43bbab05e12dd93c866a749c6995d7ab1f0dc90769a5f3622dd511b104277ee2225b53060971fbc390f26376521329ab32b9e969aea99c6aa3479985480f5258ade39247b08e8819839d246709d5efd9a865d9eab1c256a7eff66f138d8d21631aeca8058ceb332d5fcaf022a588d7a4de25e9fb8278f2ab26a236a71dae2d4fd8beb572438d7c16db9f3cd79408eb37c53f685095a1459e23a7996893e70dd8b74ab6e9a7741e4a8c9d8f0a65a8a08986eda9524715e613fd9f0b9783eb3301c71519844084d770034113f68195eeeac3329b0868d90acb68488dcbbfa6168a840a7ae1ab81b7b116b71108a74395e3b6e7d567bb030cc5a3f4b0b20b67b8ed63e8b12fb9e1a675883725d2e3642d2abdc202f068d843a4fe3de75cc54b3c3fe8198800d4374c081814f0946e39a78eb83c027fbb1a656132ff264c3bbc5e00e734799fa3297799427a86115382d5b5e0764d052a2295cfca19b15ab93c5e56e2778575238d32b3d7f5f1800ae957ffd8e8923b66c7d695264f5e8c88f628f8034819dd730668d7bd0e96f01b73473e9315a3e918fbca10670e904293474c36b3f534b84331ba2b7759814e638cc930765dd0b02afe5136ab882112307f41209046184eea5a6aeec67660a658bf9b82d13246b7131d478093178b04f8c1eeed7961a485c00e5e3f5ddae56db1445fa7d45f5fae7c99ceedb6d4b42a98af824369e61c3a2f2fe5b98cb984e3a94e749821647ac665655602b1695ca7b928412adfd04fe0dfb33d4e7edbbd80f95ad9b1d06538e32c91a151479274ca1137320af56a1ce460ea6c34f4b75719f11cce55aac7bcbe8bf050f85cb95ff0b552832cb47585671993136344dcfa42132d0f336de5d8990fb14d4bc718e03a76a0303528217c1493d95d6f019bd32a335c23a68a9f8d99f4ed17350858e8398ea418c0fea2b7b9aa90c390d9ca63713c383830a6f9b3546e56e706d7a6c8a00684899c2b675a4d3587fd378e729caf066875e780f571047af4355d1dabfd64837522e4dbba8a39858e77b24f44a6afe0ba0a1f6be05e59b8a65a0580611f33821ec8ec2b366f1e1edab424c3d568aa68a0b4fd3520157d7f45a5f84d2ae7b0d70fb35a348349299b10a8f6c391e2f25c31fa3c3180873ad8fbe5542ed17f99bd91e34981648fc3d978d80a69a435816a2562110571b26154ad7277cc68c3c333bb96c1ab2accca4db65e6c30d453e12c7c7fe6575883ccd1c159549cb2206bf43b4d98d387b3fcbe27e98a6c82777c21fe2ab7b7df32a1399805cb2b2c12ea23de58d441ba37c1d736f0416bf5e84717e667af4e104040ca2931b300db6767c3863afc12a5ecfff5358e04ef9020f77b9c60c9b616fd16d7ec945a948e97e8229830b0e3c45acffb665f02920befaaff0bb1f337ca71bfec90e8ad9063bb965c7fc103995716b8abbdea41e027c88d2325a3e5662d8962d7d2c6b76a36db2cfd95d8fd6e33cff5456b64e8952fb3615330c64dfc1e8e512815895f7923bedb7a4443b0254492cac9568ed5d1595256d3a56becaa68051e36e871ccf5028ce5ea86d9c277c0ab4aba6811990ef6281abfc151ab80824cafc07cfb07bfd65a1dfe65baf5715617c2e922aa932a2d5d997e8c4e3d2aee6a8c26b5cbdddffdc5612db0a6b64837d4b815d4b1b10c3da36cc8c0cfd57f7cfece25e35be68d3611a12a0c580fe042145f0b960a897c4e39ed74abf83f67eeac1940a117d81d66a43907ca20047e48f5e3ff8a2434a2a8c519923703ae6c53a86a1000022ad644bcf9af9b464dfaac77d68833d7e0e1f4905a46cfd495362e957437a86324247966418620d8924792d44b3d538c559b0b404d1733e765d5c9cc3e2329a4abd97f5730fb697b0568863df0fae0cecf6efd24172bb52c00cc6b779e7b2b881b168dfc42569d16a12d92ed65b09559bcb90ca492582af68694ac542695127a4c6bee73558072e086b7513bb9352cf2248d182255152d042d36b325af05fa93ac9307c8b33e8bba2a53136589aa1e350fefade469cb5d6fbd21e5b0f7d9bd2d3784534fa9525e25cd96557095c9ae4d485e1fe9c16159ccd4faa3806268e251ba549cce5a651a1e2581e1d0cdc5f20eaa4fb1ee9354c871128fb323328c266226d9972c2d37cc511c1f72dbbe57f9889aaccd8c9d30b72062f7a169a9afe12a15c042ebe995cc493c7d02e22c5de6a65b3b2bac8cc388f8a2b4149c53578eb0cf36f09d9ddbb8ab6ce8f35603c4c8dbe545d9e53dae184afbf51b7aa51e7d8276bf0f16abc8ebfcdf85065c168a4a410bfdcba6e77b3e0cd684f92af5f3dda7f3ad84922b2104826c09c39ddb3d87df572a1f8a9dbdc8936b7577ecd8e369706c4edd8b0655f1c2aa6665f5e62e6fbcd21bfcc2462e7f445443083d2e128d642c98781280b92c7d55061a2dcd3735e98952ced11579452476e33ce2c5f3708ef7fb8a3800bda9bfb4b57acfead49c0b4376a02eb74dcf30744714376a9c11c84254b5c6ecfc283deeec24e51ed7e604dd2494c34c512f157defb1f691be6ac8f2deb2b9d4882911325639120493ba80c5f76b3521f62a6f54fb455e1048be2866cbc9ba17fe718a758a47e19159a1b24753bc6ce4b9489f09bfc4404a0dc1046c34c06eab34da06d6b1739cc1cbaf111d1b387fb183b3c2c5da23cbef79bb5432d59c1aea52704cd1f3cfcb50fce5abeb4f9259293fb51a0992fa4f518140f9f334f9a250ebd5e8441645ae63f5b447e1d6aeb51c234567a0caa85ac6b374fd3696ceb94c6470140201415a742b7c2fe1c530ca0e70f35ad44ec11b47291396b36696f3f38d047f75ddc11de7f6ef1ba859dbf64b3fd6590a2e0f4b5675a55c9c444d8df0e8c03316d21606d3b9d247092a7c51b64d7a5ff0e79ccbbecb17f9408f94ffdb1b01479bbae9890f613daad83376e2b63e263167d54801649ff752f4b18c4144515d51ff50b8f500db2d255d4aba439301c84deed02c655ae6f96103abadae9ca0728d654ad2972c93041d0dfc984a5695e30179c99ad19599cd9a5258039292c44205f2ae4522af3598ecc0ae71e5bed0128b4c78d2dfe5a68e63bbc9c241c2fbc853ee6f11b020f5e5a306798af4cfc0c67678e827423baae4f37359b23a828fec895fd90d548f89a2a64fff51bad763d050389585edd31b930fdc8d2711e0ddbd444693fe6cf6f34bb8aef590b4f505ab4c3a8b5c3837c47e95538a9e86e81e11d451868b69782edd70d096c3984232de3bea1bf35d93ae664d432a80c32a5ad6382c219f2da15c8740d02f91d998bc2a597b7ff338db6e5167faf59b49d126430983faddde87a8d4b903ab285362179423eede9f034c5e006ada58637899eb588425bd73fb4887902f6dc5c3d54168b569ca8000bd605e034c07d53139d0cd7f756783f3373bdb49b227288fe233a60738889c5ce7f52d5195a2499fafb3ac17177356337c24352062d6e9526839fbbc44340e70ea72d52178f41abab1f8e323ddc614038a471dbe04b709c4bf5c87ad34ce08f7b2ece28f72ca6112a4180208bd7696d714283e1a2110e199450c95dc73e358e17f1d827df80a1ed63a923c3d8487eaf048d6a21838feef17f5a27e246a74cb2877f95e086d9de9f84dab482e860f2bd43022da4a9edb4ec1862aa0652899d28e59d65e0d3a3c25c474aa9e90e44079d63762b5e131f6395e9f8ca0bb4fe887bb7a066762f390ca56a3307a3ab1ecc5f08b48db644f44c64ab8fab73641b48c8d1840f33d4322811d36a392962fc7f41d636c7f98135799a98abed49d50c8dedcdfceee1bead1a3bf1f7fe76c2b0a0ba01233d60d2a84d5e3a553962d0f47039c469d9b3225f33c18618468a43727a85a1c6847d310ab494eedda9ddaa4797a1f1f06fae025d05d5315024820678e2cf3687bdd681439afb496379606fc31998749d76c85098d1f2e6178e8a06d0ab4db9daed258c20341f750a13b8b6640878e947edc8ae8f0f6b55375ffadaa0d66e965e084768bc88231added9d68d261ac611f062a97a448f9d5f98741d323fadf2e7193dfc3dc1f740b06652b5e1ae054b2d18a411b5a0bbe41dbf2168fd5fb5d367d88e61ccd21118c6a21875413cc7a70d52298b8cf219605493b708c5204d6beb4489f693aa3cdb97d004d339f4d96d84a614e89b04c922eb9f74eaeee93e8f7a762a033bd8929d45efc56cfba04258c5ad60953ae827be74a7e4113860f1eec3327d51a1b9735978be4a3088da91d4aed448fcd9b8af1c56308d63fa9370209b1cae264176464d9449416881ea372ffbbd2894c4c7e5387f4ab699154cccb980365e9ad511cef6b6f20493c86b2586c1de5ad5d71f4007e55f0c92e4ddd5e883d2eb2115b7005498c6f2fcb87582c5aace2a91b2640786ef1d3187c8bb9a975e8b277ea4199aa86166e140bac8e29bce97e0fe8a9470d499b2f6feaffeb5aeb0d6906e1ee0290380f5a0492a5b1c3b9ffee0de95fce9b8f4f7bc3d3153d2460415bd06cf2908aaca33b96d27e278e260dc6cf2199aabf791540e9be97972c01d614aeb0972ea6a221e0dc1828ace7c80893bca90b5da5a7478458ffe2583a37d831fd0ee5b67145ad38fd00522faad71077b1787f4579c72519100eeede3c9f5f200cb447782fce544228536a36387c986d49b28e8c6ea579fc78688ccf445a1b62847243aed22339c6794f2bef2709924d6b6a7b3efe77fb5482e498818f3938017f88036f208f94392937ca459078b7399943bd3cbca10f1723818cea5bad936db3f2884242bf33f21ea7216240bf04e579b54ce1dae34ed484f75d42f15e26816cb4bde1d6c4c31adac3139365f98a07801c7633ce786a6bb7be8f14f60051aaab7fee1d5482aff3c071bfff210d342ca3887c1ec91170a095d7758f7359d691f5d567d4b4c3d28078bcb41db7280af35121cae37678883990b1572287f585f703b23037899c324f38c8b1472043e03d61f9d47d0bc705618fcd27d6ce00bdaf9a3a1fd80eb228fd713969d6cdf5cdb52171e8ce43ab017a2e3c1cbf970081d2e53f2f71b208280be88927dddad1521d7e6fb9097832ed56f688f53e99aebf8474aed4b5a7adcdd3656949449335aa0696a82e15b6b5b3feaa58212b8f30b7aa951d9e308830fec20dc4b01ef67cf9a7a83052001a669dc7efb5946c93bf001a74ed42de7fa84926977d452d2780bfb50a5af62e5b27b6269b13afc48487e8caab12cd523020a970a04816bbe52c2d4314f0eb9754e811123d8ac976aab91b9ad0c35af5a0d260660372240896e4cfba0b692874883f1ceb7658a2ae571b0a4c8b2434827aada201b409492880ce0c6ae25718974b0bd8f0a873b56e81d4a8192fd38d3ed7072a156bd92abee8c904bc14a4892e75ff659402b5bf2ca8e44b9ceca16becf71c8040cb34d9acf9dfa01fd35fdd2c571925afbce4d95628c01ce17418bc3b52f6630bd0c161fe9dcf5aa7c3439c0bc8197525f3174e6e27e35b329e75d252184cd1a6254b978cccdd65949d9462c36c3b48b1baca629776837a6ea1137beb4a021cc0b0ffd0741abb9b565110baa516db384adc0bf3590f9a6f53b6a8dbbab05eb0652afb8a3ee25b8fd3c764d8103db38d2e63bcb50329ca4b3602812f7dc5bf0484241f1a9efd58c2fd3a30a38987cde73f3ef7cf8ddd87d0aa1248eb47222451397cc2e492d088add4f737804724c83d9746a7f10f6261dca17089daa0b351fab703c3d62cad7f5f3ce37c6d7f4c6b5c06308d3696a72ef7464f66261220f421006993240ca24e5f727702890b6f49863a3eeeabca6330ea0f82fe4f8237b5f5a0ab8b0dfa4facfd920ee07501650bc44e3d8649080a6943e1ac402921b93115a607f03c5cb070a291dabb2749cff54b3a5528b6a4cf30e7e2e38456dc893f60b2aa54e5542cf8025e8ee6b875c3f68400538eb4b7af5b9f248458fa2dd0a591b7f9a74c436864f9611dbd9081547e58a7d6e01ee3b45b597f0c23aa24ab878516e340cedcd64a463e02f8e1fa6be7c699d7d0757d06e900359e310c0779698dcf482afb2f7944101fb9620205be24d064f84f18a71bcc8e17c6412009e848eb4ec1dd46756baa235b5da3eb28f379b7e6d91631d7304a6d156ecdefb51b6643b2e1b900d3f173d871251f0e2b0b5e7951824613e7fd15b777a4880a163eadbd6e6ae6ebe8b24c81ad91bac0a39697891738a49ef2b9ea187dd6f30f95a9b0d295eb95f8b7249f38ba9d3724749998e5360f2fef6635dcfe71f8e09a516d98a8a00cc6746d974fa465bef2ceacfe3cb810481642f9aed9dc6e4cf7c7bc0d6b2daf04fba744c0167295ac00c0ab3886a0c3e5caa614c6071f4d953299068d7d826057eb0a0036109c576108b4e4ff58e8ba0f72416c2dfa35ff1effba72172c91b68bed1fa22bbcf5b3d7411a4c3baa8833b871e4d6f842d2144ddd826def0beb8c2084f1d7bede5a3445663753c73208ac90bd9e467b8ff941353894572e93b91a0f67421b1c28e10e45a739353bf1f2fd94101ac8f7ae7e31870b707453d3e0574d1c3f5ddbe30e5b702f8a4d6b09329f1d4cc7ab03f7c257c6d721c431e5d94f5e85041f56d43a051830c69b9c38875651c5c0eeb831eb6eebb87fd22b26aae08bcefa98157d200664e42c87368760071ea59cf0853958fa2579c10c86295d6fdd7845fff57d7772ec1bd2cc92468b562c14176b87a70444f2e4fe08dc67328db6c1096ee58d3111e0b130999a8df333153a61c5e19f502d39d1f75fe54f3c4322d95cd8993b71c2f23d206da8b38be506900826e7b845da190629384e6e9b060b87357c58e65edb943cf79626700c0c583d197b5cbd51a86c4d39879ca6ff432256b0288a487df6abf6770648c231aff48f5b72815e789dc5f91356b5c7e6e91532d2e26a716b5877e21bc2a1e5f46c50fbed459b124ce902b461834e7037be619ccdf84a3eb07908e56768f994c168b50e1b02118bd49220a016494e784aab618223778cee825d9dbb4a018b854588116a5e00a6278781f0412934745d61632fd564a8ad20af511e24916664a80a5140c46a5bf88cf63034b1e215c654ce45130ab2933e0e6401008210c31dd2ed42fdcf78bd67fd77c3ec6d300ce0d3fd9a3a5d856087aa352dd0f7cfb4bb7bae21a4d1b08d78c2788f1a1a5720ffc3226261bd311fe4bede1ff34e45524c85ab75f560046a77e3fa25d9fcc1e9db918f5e75368d70495d786101da4a73d49694d8f1645978ed8e05665021669b62d3c7d1d73698975d2bd7193302b78c4c8cd77d8ce82b0e59c9857ebe0f7d516ddc5bfa0aba3a0a3672ed46da31dad8b1c442fb2ab2e45992c86c46aa1f3072053ae3d382ca448bb286132090fb44b78c8a50529a83306d62038f56100fa0b724a9c75960830d2e11e908e4acf83c65cef1f3c5e959f5f76bf52b2ce9fd0f5d3cbf7d127555d938cb2ed7de6682ee07359ed5d8a810c2f64b489679592e6f410356a964b9050e95cb49bfea22af9e2362c0ada992f6bb8973e4f7b28d7a5299fe8fd3ae14fb738a1e2d863d77e7d36ff1ea24ec8d6fcc6e142928e174a7e6f88815930aa705223f4a027939885abc08b371e946db22d316127906312037ebc50694e2083ad5ba90304b680296e896576352e6ea40e618fbdb71029e6af06bc70b3e242f20b855077b4461dafe0f640aa557816c0b07a3270077036e7b491df96ea012260fa1e8b26c9c95648dbd4712b81dee530d3a419ab9141367c9f5591e872b39560884ad4019613b8bab68c637a2dde4d5a22c530ff6397d43dc8e2cdc228eb30dbe4869e90180eccb57104b02fb6f31e73bfed73161de86f1de1960fbd8ebcb940ddca2cc9daba67d20ca8fcfc77698d905b2d956f93128416176ecf380f53b5c0025153a39f386c6b65954cc9de1a3b891018f833afb401a7aa910726aa0f205cd27e970270582f05fd4084002418c56ccdc9181f874783285c5d14413c07f8532e6ea301343a4d1dce7e911cd7e2a76f2c213127ff00886c2f840379efdcf1cd27e5b7d8b2873b3170fe2782e943ae0dfe9720c928bf3fae93f3efe07a7f40585ba86ff16fb3627c1647814908a3d4a283e2c492f0203dfddc364ee425aee8033512c2719969cdbce25ee683295e2d958cf80acdb82018aacde6ec5147e54667f23fb55326194ed5ba12e0bc7f97f4b518f6dde4ca5e47898a99322c5d8977e9f3be6e3fbe03c1d63217a2fc3b63b56e0a55367f285134c0ee1ac6bdee4b692ffefaa941af2f2455636114cdcd00fd59c2aa80ff5146b1238177029016a33367ae93428ad044d68eedcc828f24f72de0e984c43d132c4ebe35fcc567962b1c729ff803cbba578062f65ed6541cfcac1afa2beed62c4b1d9a2a3593480c1e753e2ae367a6639adbddaab14bd6f7860f522dbb327934d87d48e20606f751a7328855f09e1dac4f21f960d5939c9db1fafacb7f9e84e322418bd4f0922218abc901f0916e1bda91f78e107bbe0e9d6be059880679150658547ac91a3190afb5ee167bfb8b4af28ed7c15eef43cd210e72398f3ba137a763391b91a8f13e32bfe42e8af28fe456c8131a891e77e164b1fc4ae23db7fdd2ed44eda168940815f52c954fe7cbb657e048cc02b263d6dbb09f274d1cd711d49523a5583bcc704fdb58b685fe8e5e94c0179af20b2534d806f035ebf0a4998766acbf39f7d0e5d8e52c1701f2c8c67ae1b94511102579a02f63122a264b0f566f064c404d8b83044ae4edabf1fcaf91207c4358ccb0c9995be5b1d71261b96055fdb6c13405589d1f2c06739cb44a20725626b113a58d6acbc24edf500827e1ef73f50979d713fc2c89174e87dcf8ba5c2ea49bbdf2f89eab238aea290e9a55af1981279c7ed0e57be22a906f379b16e134e4413fc235eb6df763e841b901737d74c282a19f1a18a51a3475e37f98d88a7585c4fe1ed80d33920033c6e380f16fcc8b54e8915b705ded98f355c4b621e5a08e61c3584e0a00e53d79a7fbefccb29f87ed9a9345573772528ab6d8fcf764700e34c6e38d9e345693cc4e890fd1b406ffb96b0bcc89a95a417c21bb7c61b84700e21b090fd00faa20791b261a5944aa8c53be0dbb6453f6c69f23661e7d1fab7d9b1da4812436da97d52ad1061688ba2512a02285058d0e6ffe47eb385e31351c60d625fc576a53e451cbf0f3b91f32a3f44c0e751e5e279e0a9ce928fb576a44e221e87abfad3b3ad78b6eafe88d98c071a8a0bfdcc06df8a28e902c35b39b37cd5dc5ef0ef91b14a5bce51fc3696aee0b14c72f5be0569d99f16ef21914a30711094e79a622ae533725a01dbba395f28a5c00d33008a702f818cb0a99898ce2eb976dffb166b269022c4841e62884869cfd45bd70cc27cf2810aaf208309e1f3b65f04aaa236bc949b597a97239bbe3cb3241195fd96ab89be50dd978992301404fe4e24ae7bcaab4d85bd9478bf8c64261f773904b8424a1b9b4287f00f8756a97648bb9041df8042f63915ef83757f4760202e2f50d8f5770662d5a36a224c87da4e838c15990752a16cb5d5d4a0a99da1ccefb592ae80625feca9d1ba05daf1ed6cc71506a97a6149ed48c9065bef123a1695d94bc602da253db5a500962ce39f52797c9c029132c310346caf19006959ef78b5697881923abfae733134561e05b463766ae3ba8934f4bd4e9468ed1c627e337526daedc7e633c555e6f264a99431c29992d73e55242e0bdd469853729a0e08d9574d135b0e8b4dffcefabc2716ae6c6734cdc9fd1174968bc73b761eb1b77f799d28cbc752e1115dbb444a4bd04e5671b13e17fce0b7d02101ff16b00c89f47fdfcf9feee06de53032006205d3b7c2a72f50f9cf901033a33042372e247e12e2936df63cb45ad44fdb6a6b631b5cda71bf57b465a6aa3583a975d73fbebe09091d2b7d700382ef678c3894f28c0037de28a081db5c1dac2b411010e0cc1d06d207467ad736dac133f5954060557dc5f91dcb092248a635ccd8c9da31ca41a883ad192d3861b8ecfb1c9d6e1eb5c832054df2c059126572c49cb8cf4415e547e273c6a575815fcfd8d20672b11785552381d60e0c1d1e355bbff1993ec9969340029a0b020b96bc51add0845985a09085b5d4243da332b5c276394d61cf5d1eff58a0f9be199af88847351789a6f59688d1f45d19bb7c8625fa1f268393caf24973858a08a96c8451cbcb42c2fccb94fa18186da25414718cb820908369031c64aa33f30f513f04f4faa29afa21280eff3e72b59fb6abdfff96fc0557eee66b6e246d16e57b4eb26a0a14b0547d9c8e74f475ce34e52939ac94d45c257d1b056a5a85d38eade1a2a30786dc1ae5976c62386c7d5264573fab338ebd9c4190cea114c8a7f7036563cf5bfbb9b38b48937506aa98183cd2671fef17d1373fdc49b19f25401c3ddb9197b44ee7184dcc655e08b9016d3b55f8c22cca63fa1dc75625aca1f0c216416101777bb5f72f7e79c6db9eaa8d7dbb8293c38f1b768a69c69268dfa8a548fcc6e2f305a317ae6cda038c82c1d990d1f2cf40444749692bc59a59f6c564c4b8e7be1174b6ec703d2416d96ef293fadc86aba19792e2d3c84345ad612fd271fc7ed5756f9a249366872edd4031624344a2a8d76e2a99dc0cb776bcf422837e863928284ab0595539fa65116b48c8124ed89b517c0752c8083510f704672b23f7dd2d73ff57065b4eb5b53382ddf7df239a5e82cf4f17c44518f3f3dffd8302d4c866348c7222f6789227e34498c17edea3dd0768e83023f6d700e3195ecde8af190511df2fea33330455ef48efec5ab0c50b338d96bcce11d14b3ad6887c04ad9d37b074d1df71ce46592468594fa4665fc39fde1ee781d367ba2bbaefe1438e1c5b881c6e691eb643cd80fcb016d8025a41f1485aef4971583951933ba6c5e30772cd789c8c23b467c19732004a36281db00099fcf249b0d2ab4d1875f55d8a2988e3387afde3739edad1ce4c7beefae3abddd5ef41c2952627a3c93381e219b14ed66ba20a8822e638c0b6ef85bac1a55e6032667142a48acc0a21a7ba6f0022fd5286faa7382cfcfe04cb3516cde3c146fffcb78f9769e96627dfcd440589bb454e8cae5f61eac48c88b4ed98c00d46f8c2cc9c7118d4445bb0fd1bdb573334464ece896c69831c357c44768e4716aac7e87ca3edcdffad80226b7ceb7ec51a4bb8775524cc85f83c3bb472141542b1dfa842b387e2e98585f4ef1d420d64ee8d0d59207429c5abfe063a6ebb949131107b08a5770e82a6204d181304973eb8302c8c1f38cd466b0a6e08666e6066ba179ccbfc02b43be6280bce69c0879434cfaec5933643aa4cb631e3f0a83bd40a4c3cdd7295b7636bb4bdf9cfb6352352b53d1c4a4128c1096250616e90abfa995257610744887a2a95443fb7e970ea8a9d03569c1e0aa234506203a444141f0a14c2745e296af4303e33253149ac06781d1b9f67d217b1ccd0c2ca6555b6ce34117e5cc1e8c4c0857ca473584fd1f6df31f7bdc69b7d02a1f93281b75c74d797edf25c31bf63a9d96bb61bd4ff3a4ec5f2e9a538360072dab17d51368ef774ac47a75ecaf1e08e4cba949851756195bfb75b87cdd0328c5af2734ba45d83f25fad88c98b135f572a65a7d1936980bf6491004a0351bfe0c2c4768231ed39cf8bedbfb7feee4585c986411c9e15c67cfe10581bab7fe44b1123365289f90fd71103f38a2b111d80a87d3d21b15b1aaf0517893b38e4d2fb1fa307ebafed3e8cf8337f20a81e3a6f6566ba6c07df90a6f3399703ea886f52bf48d1765e301d1011886f257cc29c3ca650a03e546734dcfc8bcbe6de682a5a9dbd58c3f820b019ee0d8ce10195d4d0c01ac8d7e7442b6a04b059e6254af18f0c0ab4abce632689900a5b123a77fb809e94d25d175214dbbbfffcfee4c0aae3d804abd8821f0435f3a5ecd6c727bcd2ebbfaf1a08dc506deab7cf682ece2d30823caa3da55fa86d414f34143f96e7f5f11cf4579ab852715431d408439909ba92734b327ca364f8edd7042f5f71841b3c199a3d919d7ead4b146d2808a6ebf8ab5fff72375f105243ffe484b1cd46b7eb5cf30e6e88bd8199b56e2ab70996f16401c39d1446f1e03769e859bd13c0b1d9b84c060b03737f5a313634320efee7258e8ab0c51fa6b1cc93484c64d9d6d1feee766a6fec1549931459ac1b2a32d7f50ae86d3926b2d85a0a62dfdd893aea62962dddd15ef5e201ae663c0644f85e156ef5c8707b8c94d3f89d74e0348122b141d86f2738614eb27adff8f239edc6e9a39c51893957e7666e4984c06f4bc4d515779240e484dc32f65a68822af755af0e5b8bbc31408b7bf1852b4d575e13d51fcb3d4ebb27bac12eb2dd50154e7563a8f7645a610776462683726d5f9dfaf8bcaf0dd76b9ccbc94321f80cfeb5b8b589bc91540910657e1456e28863c3d93d66473170b9c2acbd0ce3d3225b423ee2970f4bae14fca9b874aaa2c43e9a5ca2f5da41aa9449f5a41835f215692be357a943ac3b9638aecc3fde940512907fa28696617e855c9915b7895d564c0db9438ac4c1973e9d8a258422e32513731838a63bd15fe8531825af90ff87b076d5b18cfd76edb12a951167224ad6098a63eba3b61c4480407b8390709456487fa18b43045866c4efb97b7eb8201ea9441a1dc700453fb2fa3ebd9441c8f8382ba3179fa90e9688356b8293306c581c225ac49321e1987666470c63d37d0c72c9e70b4f709eb7bada17dd946786087e88fa6821b089cf9f11e73da8d62335e2de93d98ed25cdbda6102c0b6aa2f606d72957869b2a177485e4b388fb149a6fad033673bc9f4688560dc8473a2accb156eab6a35481f5772c3a895a8e71a5883a1365820ebed26069e583023f0472ab2999e87ad3c255022c53236c25e00ea0e88d80cbaf487209de8b07127e2ca1333312110865fbc3bb508839c9a270bffc9af8de8cc9edfcf07a1736cfe4652bc7f984eced8ef94e28a269bbb4661d1fd3e9ddfd5bccef2b0e8fc406694e5486c8457c86423de1d9f2c66b2b4233349d9d168e9839bbd4994dc1c26f7c11649bc447b221438314808cb20a35ef02a10b3a922c06d9b20a6a32e9714c728e7caa4d68fd57385eae465254af4d7a689828c81611f425c71d8943a7634f1b53b19ee78f452d158189e00188bdc0a3c8975e388a158e1a42447a0276608b3094d1a24b197c7bce98fc32eca5758e80b7fce14bc3e6c165a73ded63b65f078a20d80775d93f3e2c4c371fd711fec2b07d682004a84de979354481bb6fe33a8cfa283c2990527e9fc27df8ad14ff3f2aab139267328872fd8c022f3ede0556123d4dc60db08dbccca8649d81503b0417f39814f12b52d3b7521d8007a36751927006a1f6a1a1ef587aac5921f4a57fe7efd87cf19c71d2636e4d4d3b843feeeaf948f07f438361b311f02ef3fab5cbe77aed2e83438393b6feb8ee752004e3f2c8d0ea8c42f0b568a3069a2d7c0c7fa3cc89dfa805626dd03e2929cc050f6e586257c71b28805f385cf18e1631f338ace3f6c26e933be77cac7ed97731149f87a7798dcb2cae962a9cb9a13a2c6ac6e855987f19f6bf01f11f7be8f6ec1df4367748c2afa5da54278a50854721bbf5bfdb791b242868ca88e35cef30a2849919c4b3d7686c7d9675dbfe92d697d9ba1cf440949e84357ab532a09f63a734ce64502e1eaebc82547c98ba8b55b9b6fc825214c012f2b71290f5a7430df123224529ac47a634ca75aa8bcdf06a05d81a28597e305da78f91629e1bd8a2d4ded47b281ad35d518c1d4ada671181a03df14db52defebc66734991e5a64125a7fe16274492da7d2c528b6d656f38e37481c9e430daaafc3f1b116fc4a8dd237a7d8f062c2f64db876c110b58d0fa0ef1d7c2b6e0cc061e8292c3630f38075336a02d7975b9110aff797f23136a4e4c7f2fcd6b47fad3ad3ae54949e6c2a68bee1bd113442824b5ab75d34fbf10bd2c7c00c5d3e573077a20f39907f889ac5da500dc884efea3bac0ef2e109afb9d4e99b55100a69ce352968a105ffaac4dfe15b789423a49c97f1ae54385b2f6fd5cefafc1a50646fb2510c1558a1c32714185899e07e1f689f21fafccd3a630b272289a0cd25698c37d4bd108969f31450cfa03ddc121d6cc706c227f4054ad943744978ca4ed0a5ce3087ae2e3270b37aae4a671fcfb95b61810c95094be365b249b861a3de254c2eb0a2ed852e1d94b8e67fdc4b0be98f9d009ee7da30edc3262c5ef7b4a0707527f4921c3be457771ef6ba814a6d2301d5583ea2f06af704b4191fe29b09ffca9466066da3a3bfc5764fc25ddd4138f1ca6c0c89dd1da97b630d3055e5904be625733798ee27e53ed31fbd163a0fcdf9d317cf06a52f8021bfd08cb3f4f79031a4d32cf5a771ad6094e1be93556a8c8f06d15576394ccd7362581eb4920cf7598e600bf2532731bb7b0a5d51af73a82b44834ddd84acd657c1aa9ff0e6cd44a767a34b05305ba9987d1c26b8b8551dea11e6baa38064a920b0cdf77b04a3e8d9f7f663da49dd1e5b47439bf28daf996a7482ba1000f67f75d4b2d4baf2c953a3fe655f70cf39a868742a402d0965a8bb18faf765c726f7826426a4f889e107bed6b5d1299a7ce80a17bd2f28f9394bfebcd739fb98e65003523ba7b3cac4656f7b0cfdd0c0189d3899504cbebf2060a29a5b919329bd4d79dc5d2e3b1fd6d82de772386d8bf5842f240f15bfe3bf94f214b4335b07969f75694c64d64800866065b5df22071e3147328556b99eb20634e3fcd839e71b5b8d354f3bea00e99cc41b0bdf15e0d728c70562a9ff6b70a1b91e81a54a3829d3c8271976fbfa98c2a7b440a1cb9ad9840e324e989063cccbb2542fd1d5765d335100ab5e7d90d2cbe7a501ff678099c5fa49999eaf9464722da50b0c6f1be096fbf6e0f84ccdf192c8873d8410a9d32fceaf80e27a3271b304ef4f22ae830abf3bc75efdf8de98d38901f991f7a9aa6e520d1097b6e46876b6789ea34422fea4feacc4d1a41c52e79116a6c971e6fa80c37bccecf970a85fe5d204cad3c819dbc029dddabd4629e3f60987d8a7a91fb5c5659b5b9d4e03e5a99a9dcc6d5d96d224254ed10e7d82f956ef6cc511bfb67b3f7046ceabebbc42c849974cd9643dad7b4cecdf14dd76e88810fd8b8ddc6bf46f43074105f3048428a6e097edd6859b617bb169431fe49a86f093add868e0f2272d6b483d687b4b9e92861f7ec7db0d8f024bc3c2fec867f3c1b2fdaa7f6f8fc3f6418befd40d68235d654c97e51d4f67e5ec91a1ddac8457c659f0fb3a4492ec8134b042980d941a7b211076d20a1d7b9d04a6bfadc5793118aa29fa626e5c94c250ff6f2ff031461c2ece47584785531b8a8c88e099fd468fce9a86508f29dc9a4b0719c4d2da3187081da186032185fc5963870b2dd1abfad8cc81e3dc44551c8c03017f031a17441228ffb3af37defaadfb78bdfb8c3285ebc904cd18124996ff12a9830c726f3d1e92d193b877a7fc88c0f674244420b6a42c01c13fcd09301598387224b06197e30768727fd229e6abb847b035f59988275fe644414634a1e41b0c486b8730b4b22530e612e5f11b435fba9b18b443c4e6ebf04a53ae7db0ba6852654b08efea9e5966e1a01bfe1e39fe4f71344dba4cb7322e9b8db26f5a726f34e5e59474ed30e6842f8c7f705eb9110e6bbcd1b0f11a71493b78dc83518e3782581630e2120a31cacde874e3673d89cf7a69675d86b8fb2cb5977175a4bd4b50666f1c76f3bcf1bde6884dfbd77492f2660ddfd9ae8d091ba07a6519386dbdf2f8f030f03c7076e0b03ef6e5992231518bb5764faa3320403da347aa58806c0990def3a0d35154de1cb34320e34afc55a28d52c4c264b4cc869bb3cb0ac065e9cc9eea6cc55e16cc523a0215eb16ee4ca18e1130b212d968e65e4522296aa33113838311e2c60cf0d768ccd15c22e61956dda2bc8ba25f020f9aec5de1addf945cc5a3a81220a757bcda43b4c2c07af3d1ac156fdce5d1567b5af94233a3557765e23bb7ff0483c90c3a4d54e3f7b2e29387210cafe954596298c3153c1cc408eeb0091bdb6566d1113b1a0bfcdaf80d90073f5ca0efced21b831ee1b12b57e929b854b14a2a611e9c1e1cd7046168b4edf881560d83390cd61bc8861fd1317ca4dd1620bedb1d86646384da1f6ed8e434ad35c5c44f639d5f6481466fe05c44cd999e4b520ce338c84dcda50b3e8bd2b860568c6baec20b700537f3e6e6eb52ac9a695a6c6288f84b4851334f4f51df863d7234c518aeee353859db55d809de6d0c81bb34d6e4e470066e6b1a62699f09cabc8963508c0b2a959df98dc96b6f01ad86ff823b4244330e051bc95b8bac7a7923a15ee02e7d689ef85e533d288b393e892c9b212ff4b122889bd398d3da49f98b20bbd6f66897598a106a93dab5bc4a263da5bd1a5e7c7b9a3e5956d8186eeb55b5e3490fd64cb55dd748aadf4ff951cca74b2c2bfeefad8c54b7e4778fd4fee8df3bb1a4eb7e0822de16e95683d366daade4a741864f9ba5d29622f2b2e4f6972b7b21152f7785ed3038a1cfb39d05a060c8d14e21b58d0ae216f6ccf283970b6b24eff8b7b9845c5c0afae14a6480e8c9ebde51c963978fdd731925d8babc43b90cb388da0a23ee11a5acf0cde04f4b43cb0a3f2f4aea1ba12955c6335055657505f458cdf676364fde46a9b02524f9b2b46f249942b29a6a7cb0d830c66ef7c8e88e973bdec90b931211f1dc0b743e260d428a0a02cc64a81dff14c3f77fd66ae2d1333d6092200418373c468df122d977590fff08e2dc2b3558a45b150a27c7c3152da4ef5d512d683a32fa88779ebeb73683c704c7f47b3c5bb550d5b2455caf3e1824c355b045ca3c8098463cf984e222a8cd814615055b1cb43a4af191c9a586f62472ee12559bce8c30694b3c4bd86816d9ac378248d81876583cbd841c47b0a0de9fc6a3cdddce27a8bdc86a88a0a028129c21f2f9a4c5f91221497d58123b8d6d04e74daf8e6d1919faa67de853736a7fce65a13972b571580d89ee74c58142367e7b6d8ab4b2f6021c1f4880d9102e820ee9bfc83b0980675742fff2fc7db6de38c3250beaef5d3a9ef0538577fce43575157f7ecb8199db7806be5d4c25691170be9745934bf50a300cfe9c1d6f58b227ec5cde9d31b46660af67b24de86527f94962774634650281aa74bf6f8d8c1b7f45c8f7cc41f6b0d9668e5473ba8012203865c9df5e83824a5aea5401e0199c5630f002cd6f6181c2b8d6cf8c997ea3c8a1fc572fd0d17571785ba1273f165331f32434a842277454da02427a491b1872d4ece503c0b2f5870aee7a7e364928a220ea27b8eda24003d782cfca7493c5ee3af36b712a737545fa70b2ce251cfc635cc512e1e20c54aeadec9c46f2d580b425b79b3f3e1090c9de62411398188124e18a8cb4f637486dcf17a854deb18e5eac8d3eddd071d945b20a71c8b2cec74353119f8c0e72111404a2a22b98082e19fee3c00fe3aa83dce61d508c9a4e78d1e9c7111fc46d83e797466f22ee1a6dc6550594b8935336cf6d34c5480bf9735a7caaa7c2cb5e666c58461957ae3af1996d5d16c54a155d989867c7b63ebcc70db2ac7704c1c576c672b47e03f5f5567b299542b4b5662c6a1bff739e3834dfb542e8e835d87407b0a0c1cbcf0c293a31472f2e136abf3a5d2c57c01fb7939df84b01155f427f12907375777eacf51bdae9dd2e7bc56cb53e08be580e3c8a1e3c43375334d4f929ab0b5d07276e2939be5d90f93d46df2b1e21f2bc677180339e2c3bc71255ea72052868fb91c6279d826255366e0b9523bdf015c96f8dd11d885119cd40eb96c32d0bc895cda27ad559eda2d48202a3abfd8bfe38dd39e001ddcc6da43d5871b5c18967d880e046176f7252e2299eca555cde413e954d3999c58c31f101f6c3c330699a5af7939923767dbf433a796171b044160d663a599f60eb4b0bd352eeefe19c0dffe0503e8b6e4340fe1e8861d13f2ac81bb8106c84a4e877f92c37ad665be7d202649031a35c91958ccd267e921f000258ee95549a701b5a4f2ec05207ba2d927fcd97e5cb6294160626c9cc94b7fc4748c5112dfa0efaa2e78a2363b83f8bd705d6a187c06fa6ca2908290649cb063adbbeeb8f4d725a342a9079ee61a204d05d9b75063fcfbd6323dc1e8957f0c0df0d41aa16ca13c8427c9cd9b5c4778dc9e75dbc53e8cca9c8480261af20d7b4b7e45438803e1de32c2ca7c2c3d188b925eee97da5eb501f0171e7bdc3a72ad4f615f55fffcc76632338df9ba9c7ff064c74aae61e7f1e906c6c37ee422be044c4ad73045634365b5f5fafdc2a26be0403352ca684773ecd7f060f77507cf3e8ed1208cc80d324db36174e10661fbb207914e1ab6b3ac24248d526e6d0dc056e50d4d9b2d06f9648d223b6ddcef6eeec29a8bf82101346ab064117eb677c5bf9c0105120097108814b3b7f44717d4959d27f25650fae57ba2bd1a05724d866ab225e0213da57a8bf0fa533316b31fb26cb0a7f0e530d8fb362974dbde4b898029b7d1531120aba967b453b78cffdd1acceb574dc92a2a4c608c33bdb67679e3b7bd6610bb1318bdf22a5f1b5f73a87b9de0e816fde96940abb86181accf1b3740cc76087fe7814a6f3243424d3c4739a23b6c08e387c0502197661fe96ebace0ad0b32af433e9051820d194249d7d24c780c345fca0e6c04b63dda9a28309a76db09551f9898f8bd29dec697074bee0adc48bddb31f54415655e9bd8b45544b32d2f2f9f712a1660d10d6d39a84ae05ee2b3d58a845212c070d48c03a45100f58e7876974625d6b07c63473bd849d93b4420e54beb5c54c0221cdd3289f22741a6bcde5be4ddefd3ca25228c5d59c8d45f3309061ba3d37f612f068bc538bb381eba2e83aefeeda5767d9100474aba78d01a9c4e89d82016b78da57a32e1e82e9d64dedb1186da7300c7d0b6bb9c9045951c41788c2dc08cd30c9bf12866e3966ecce40348840701a8525a7bb90b3eecd61cb51da91f4d8f2af7a215becaa46ac2ffb25d64700ef9e1d86fadc0d367264277979e7d7087133f4d55a2323836311f3c941ea6f9f1796f7e78028445c08a697f5ec1096fa08d89ac8e82aa964ff64dc5222f41c0687acfd554c1004bdebac6043c10dc2cd2cd36e2fc5d644a482427d4955179d5b5eb7c3d3f758f3307d5f4bcaa57d08a7711d3deea6fa5880c73260af04a57b3dc6177f7165a8e1897bcc1605e678c08cbac83398e14553e94b82bcaca3e8bab50d60d43266506ee2d6223d4921046bb2a311536a8fabd3b13a9ca33354c6da6b4cf03a382c5853474616b0b936a97469c4194355ddfaacbe0d9a0002504c8fee569bc2c0e80adab9fff4751ac822c5d375ed4f7e664e7f45e7744de761a97dffb671bb395342ef21b9bcd7662a5aabaa14ac0c0a38c28d9471497f77967125fd0d64441dcee15a5d65a22794d59e14260acbc303d513bc17562342c91c8f1d87b696681268f7fbee7a73c1a3049444e3c9a81bc881f9301e23f486fcced7c4668650649f6468243226e3a889ba49c7835585fed3b092b2e501766a3757791b44a98599f5a75d19cec0138b1de4e2181a6fd5c31389a64188ff7a777adbb70116f2ade9cbe715acff1aa767c5d8a5581a499264e21b38ba6e918e506d72c3c6cda6b47bc949727c29dc6b90b31f3398982adb25ed786d035e847dbc805fd9132607c6d2250da0a0090724585efaee031a537c233090d8124f11ddfcbd5d9fc907dfbf938472a766b3aaa92d6bfac5219e693479f4bc258d805a736dc4f869dec5c56e0365ac1b650c4d9401ee103e751cb150abd95146398502cf5379a3c5a5e28d170586c325f6a993ef0ba31a9eb843f374ef8b8941b123032437a622c3e239146d6ce17388c51ea2e716c24ace40ff1d0b03794a779dce5265299a0fd7fb75874e6d032f46b8914030854e7de213fdcaca2afeeddd0343c0d9dc93cbe7a5e27d3032155dc2685cd392d871cba29da43289d1bda5dd10a24a220da878b89afded437037c87c66de7a49bb99da0574bbc7cda657374881416d38ca68120b71fc058c2e54be34d70fc31cd95aede348039b6c5e824926374134399d81a68a1ceb7cdfa8ea0ec3d766437654f9703f78e5d62e1efa04a7c2fa91220b2f736c186825d33a817e22a1f7559941876cd648526831f4e4d62bdeaf037eaf7efec377eda2eb23b7f207eae0d275102adfc948e82731cd608770d3fbd9e18ca76f626836527bb30897beb5196f535645fdfa7cc4c183d1273fb4f0641612f918390970db153159b2a4f0f465279dd94cf7795452ad5c344e13289941e790401c34d3111520bb891d31e0199ad2f055009473be94a02465efe37fa169da83304bd0e72ea8e9fb1cec437f56a1cde84866dd088eef83b20ca36c20cf87018cb5cef3e4260c95b65d13bf5266580d8f3bda3caddab18c529e28cd3963dc4fc07a76213539be6e1085ea9f50e49159a0bfdc1257a32ac974f001bf1de254a45c3c2fe7951f20a619d5e14ee28ccdc56cf2f76732773e65d50d39d062cb9919a9ace094346b231502c27fded921ad2ddbe939f33ee751a21fdd52546f6f926203cdfcc1f2c34427218f5ddcfd8ebf26956b91d10135f65e627385a0d56f6b374cc3a433db708fd79f0f734e207559d3059b29e5f18478163d505c7d8d064cfb361db2ef65dd389d1fac048eaccfae72afdf5f89e0dee284514ebc6aff4fe4291cfe72591515f5fb5f6f0dcceeaa28df66859d58eefc5473a0c256b9bc16740289c8c705254e1057202b7d617f93c45a7c1b4f2e5d951bad815ed17e5373d1d54060a1c254654d1bd4e42ca11de4d64516ccd76fa590e18f1dd300b17afc5866af35ab668c376ce2a6bd6c4115d84643856e3417a997648a8848c4f7073423351c4331940641db871b9d620a60efa2864e45de1309845071403c76631d867dae61fa433fb9fb9f4402e61fb747b8a5a5ace86f0332f9a1e0d54e4ec92d155d04841f8e58aa462ece659cc25656dd4cd1041346f6ad84f30cdb35ea31565c26ef41ef5986b35cef8bad7407714d908347e6c42909b9332610c44ea96c47296e95911b8db1ad1833ce91448a27e471bde56685bd697356857453df2afbbc7020e481af11c9ab6b290c43e891e375eab64f536211244d529f381f93331a0f7e88a7b3b1929a519f5790c1b4df75d05eb44c68b4a141b647d00745af2db13b60333843fbf74ba6bfaab91e75a09e1efe3227558a7a9df46753ac2c1041f9dba067b8f360282b4e025d5744b1f53851bdc05a1109a786c6d115d2ae09a69af60494b2eb04a01b7028e66d69e7ef37e4a52652637e94a4c3a604e5d5c2abdfabf9e8dca5300a1b347e3fa509ecafdcb7e9ecc1564c831dfee397e90c76bf01fe7a461245bc459049ce9f012c210ee8f41ee592410121e36f220076ee4f026f089b36b23f968f73e81d8bb13c133a9d3ca459e37ecb9aa977c66f44624079c4f82709903c26f20a562864955b2a06a491a9276f5d9a91e92e171a8da3c32f06c1239bad5183ac32a5094b2a73b8cbebafd99ad8a9783e8fae3929de439ea6f61f44e2f8aab0a00a3fb2ff4960d0bfa616605647cc9a65cd62a2dab91f1a81549f839b8c073d80d73100aa1f8e14479a73cbbe9bd504ecd686fd59e879080aa1130afebcb7eee22b445af471c8da7de8e2012eb1cd7049dce75f1bb5b82996fe7485bb3b5de9c2f4a7e6030652e2b4c867c2cd693e233ed599bf8ff99bae41f45cae4f0d56a5e972aac506f4469fc40f28a6e1ecc280c7f66745c850023428a0ebde8596de9b603c00cd5609aa4e1805c26f67e0abd2b33fa5183c7b7e882f80b03a575345f3f280ee1326eb7e43f631d835495255a9ea8465ae6bf810749678d8853914feae239d8a3fbee7737b92fcd391f24be875c234bd686b1f6848edcb1e4777f7de2a42dde2730816b72c29aadf10fda7664f1fae85c630b5b1d9c6bfe9416fd36d9a3658979d9f0e3ddb2ea597b8dd1820f950aebe24e298a19ec8ece390cf223c413cee03a15937bd756a2fdcb9258c4a6f8ff11be415120cbae8580204ba1405394a3248cd4c309fda65191918b07080fd21a256b2cfcf7360a720e6d17a268aa221e460a235e97eab38ab08b59b71f68bc0642a6f771aed1d1698ed0644a7852c670f48af54632b0f5e9ee4f663587566d348b273e3665ba6c9dda1400baa8fe6c51f6f0551da7e5ca4aa9858d3827323dc3c3a82b8ffd13a31bed71c461cb1562b8ecc2dfc0363b1292ba4ebe06022ac06b67f22711b6f90763b8571ba7b193f297d04acc1fa19280279570bd50a9dfea954deef27f820fdd9825bc367d396ee56f9774838f7389b6c0d67854057ffe8df7deccb890cfd3ce2d16686851abaa0af6dbefdb8c890f4b4c4d10864a1a7e431f2932304a780d1693716b4f249b3d59c6498bcf646c26e6c423071cddb0f5d0b86fb93bb5ae4a26455f8504849909712078165fd06165bff17f30ffb430415c07b59e329d39473cf63502982e11efc2465ac759c20e7d02a8bd996a73de4bfa7324e113972310d6d2687c2cd4b29dcb3d52f418b82631b69fc1c1434f8c463bd64a5172a0e7c96e03443882c642d2f363140875cf570ea14c27c12b1fe4a5eb5e59f6627827a539dc6ae87d9f107789b15d602c2be3f4abf8813c1387ca5e6498a7079d2969d37beefc877e6d57bde68032b0baeb5985a242dbb007d84ccb1f4cb724037db994a0c301c4e4afa843d71a9012d5b83a3db0407c99c0b42f3b067f609c090f57eb9f4b7ba1b7bdf5c6be30c2355b20558aa24ec361e9e339fb7d841fadbbecce30cc357fd1b6eefd7ba2a00e134b8d8e0005641d6ac67639155f133258fad1230ef091b7e696855249688e5b83cfff58303de8eb35aed233bc363b14652b54f256a77fa39808128b269979fd16f3707caca0671217e83c5d945550f6801951f36a27f393efec0396d1927f578a74279bb86aa69114ee36d222b8d29066cd8dca707bb67ea1910d3e5e4743d898faab9c55fb0746c2d9e7198860483a632d2dc5b132054e5b7e571ff9079d03dca0423f21ecc6aaccfd9171a36fa6ee3279f3063e62dcfe6af73b544fec7122e233b04442c1c4ce6ad08dee33fb6fa8052dcaa962e08afb7cbf1f1c8eaef6b69b5bd0965a5d05e07ee95370edf20a8289082df5efa0d7160e62ccc88f17aefea9cf74352d700da0e24a0d9c21fa8ae31623b1fd6c617a6ed9b5836124686503298f183f523209215f9d96e7049418f1648578124728c38a7ffb1d7a2797ea6ca8c71d7568dc281d4399d612e1385c226164668011b74f445d2dad71140b9098b8709385fdb9c51ec2faa9ab54ac7f61a4d6cf9fa999b189a63944725c0674d639d65ecac9407634e25dfb528299eb337040382a897b4b8725c74cb6b7621cf86d3ef6fa4ca165f93ac5b8881bc23cb41ce99853dbe9047630cadff4be92d71d39cf079ac518d9a23e875a333ca3ae91cae1cdcc577fe7f5555cc6552536dc39daa6ee0ce1e55179144de9e07bda0df8ccf802c9328d4215519e672509518d168d62c4ae9847413a2171c54fcdb378f656959c66fa42410fc68d12ae2ff1d2b87ee800819ae36c050413f004287a3436c051aac48937b0ff0540026f5280092e9c50436fc83798ac2ea8610f87baaaf8be9e40597878dbf834784bd7acf99faff0d32beba9dd1b1e99512c904e56cf88b860d074fa56c40aa85b49f091e50832749e09054e6967357b97b3e8d812efe4c912fe4a35093ca63926048f0e8809aeded663e342f4646d96d2e64fca4ee8eaf036a7caad718b455e2762c171c46c72bc123ee6ab13cbea55260bac58aa3339d9596d9afc0a998e694d22ed06081bd05dd1dfeb6dd483ae5b9d8e838424e2c6ac8cf0a347fe470fe365708b3a888d36113d2cbb3b456a35832264d303a3d6d1ae9a7c7b97d27c579167983e4172bf7e85abe09214ac54815a52ee8b496930b3bfd3f6c6fb76a3a7052833f7c5a4753025159ab34ab7ff19bd919a5be1fa484f4b5db0ad48c512e3224f94b0f5e2835ac4c992d645a1bed2c041372e61d4abd0c962c104c09d8a07b0ebb4965063e47dd05bec8b0251ab5cde208754371414362df905aa3a9ee08b11714ea0ad3731a2f590bd3f448bfa045f9677028bae8d56a2cabc6d82dc14acb3ce030ff7af1a44e974a573d5d5eea632e0c55c0a6874c932f120c37d64d8e35379cde42fafb6239989c2c0d763578f8184ae1c56379e3cfcf3d4aabc614a8d382313fedddc040a46a91713eeb44d64e1332a72c0a0fec3b52c73f4c6107c7057017f1137fa538f4487a63cc88875b019c70bd63aa107c22a7e6a39ead13b3560d1fe433d1a170a68a35d07871aee18e6dae24929513c35569628867d9eec02559a18b6508668b1c9800468a949d98944847d5c1216f5c3ff4c1dfae474db02e2882b10b906c4d4b42d019a4c555f1dc83537a285e6e570a8c306fbcd9e6bf2f3fc29423eebe08b86f927b7ef8bbe7b5d7d4f107b3b36498f0891e5aa64d44722561d4be61ce34b44aee676acfeefe841fcafd3231a2be60ebab35f3254de9b9fb9c48d52435670fb7b4550e25e9fc4350fb4856783a800b1b678859e8e4c4e46b91d3c630bc0592e63f5f3874ef4206a6ba1f2da053a60b8934458d8a65218173f87d684bf1d4d5d05903dcab55c6ee6e6c02162ff4383e18fce3d901d63df2638a0991122525038c0d4dbd80a91fe340aa5185403b87bb60f54df1b668ea56362cd3c524aed0fd35f011cc59527a3173f3ae0fbc993eb1bc75002867357824787980f3c3ecfdc840b09d39cb69c5fc6bb7dc3414cff7309edd2d3b049633daf7014e7c700ecc558a1a3f62a9e3de17f4676ba6877f007a188aa569df7cadfa009440ad2fea1c8135e499b7be327877d6b6c455f85a14426e2b2582e779d7bda1e2972239f784221387bc4d3f06dcba15631105dd253c633ea1f410a7f90071f6b5a2c49c95e8cc710ba15dd4a6870c6df4f6261d2b89997c598619c233bdf94ef23f21ff8f099717ddf02fbc3c19ceeb6a59a5623a5d80778d2789a8a6a47e44763afb3eb17d6681c3a34d2dbfa218a35571a9f609593b47f53dd0d40b42d5b28bf2e434f1599e577d96e03e046319e9cfcb40bbd816bffaf3f14c07537709bea830da4005449a6b7b59d37677ebf19b2b66c80dba47aac1107bb9b2b1277bafdcf792e3880a8331d27ca95f471320036fdc13f52d5105a5667fbe91fcd91fe4c5a180a12537c3e20f8f4d9c66c7dd8b5cee8067c5dfd520d7182e61dd45de7112f39b7e396ea1be30f3736bf59cab13882d9a9eb817deca73642c851090d6b1abe3ca4a79a7fb0818ffcd1b7b09c41e63d8fb7fa94e89e5143e28f3a7ffffcfbc3f8a87d2ce019975cc799b9d3720b2ab29e34a7c757b77af83e4adbf14cbfed6d12b0eed7010d2f3eebb8898f30f101089df6cd06a57f91cb27ac5898cf3167be9a7909802a099723338903a099650cdf4e2a10a3a9dfdb85839e3e449dcd4bc6433e1f12f91d2c6221ee19b8e9a51e30749ab37d877efaeac118271ea8ba66205287165d822d438cd206fb388d99878f81b8d9d57bebab7d66db6af552e0d97fcbe949f2eaf85e0e8fe3e66fe54342de7eebaecca440ebec3e969e635d57fb7995abfbbe7cd213bfdabbc37cb6e70f6edcf9aeb3088acbc9c39916224c3cc3f130ca13a70f29242039658879a88eeaea64817db7d35f63a1a714e4492e67eb3717657eed8731d3ddb4d5884be890e78032d0f222e31efdb69d8777e760d69cec9369a85d375a11350f9a0e245e490eef899cfd9392a3a4ee4ffea6c8964953cf4fc57c4fb79e0b54fca070697af3c0d53f6a2922327b85119420068e0b50ff5c06720c7c6ebd7e80906253a1d8a15d378f34405496a9d45e097fccbe23e8906fc97fe7d66e260c4f46d363b8d8d1ba2d5afd3f347b7b2b89dc1dd6ec46e133dd5d07b0e36bf36fa9f99fb352f4052380e36631358b650e6ab696815dd6401ba2ca65186a0ee8b5339ffcc80cc42f87d29b866726f80d3333cfff2f1d05a84f243850347312a473076de62ad7fae1d5f13318f34bb4ee6f6a76636ebe9f92a86cd7417d536d54a76adddcaa6e623df79ab4850bacb48d6438ffdcb76a9d48944061cdf36d4756897cd6bfa2fe8fc54f1886cecf30d744f72cb47630bc4774bf5c075ea26063c3cc623b037859a4bb1c84ff5c096fdc1ca0d77b98101f0669e47f98d23719976c9f8eadcb9b6d88ac18bf358377a0191bd0455cdce5f42a676cfc9a20463e2a94017d621df5fdb848c14d83493ef8d5a597c10389867b30fb0955df0ff7bade8b52a1a15cff134bb4bde14c6aacaf923e95fdc4ecabd63217a8560b2092c1b53e4dad9f6561724c30832b7aaac8562369645905b80222d6ec536c0178231266e9d6c0945113d1034ba237d93f083ae48eb2ca28202d8e71c9e5c99601f34960ab9e7e5c26a3b42ba856213e9c641f4d867d16ac291ab3eb64c18c0eb4a33e6a8bd8c5d2c7e5aa74f5f8e662281edf9d3667e586a9d41bbfa32501436a2ce7fa1cebdafa05e770bda87f559b78767c2752a9247d240efe5f904b3931e801d37f57a50ba319cad5edca4aae7b947bc052cd5b0c7245537edb0791e3b5b8d563ff5b461dc2f624fc01a76305eae48e521a98bddfc8b2bc05a5b305c6df4f7b1a054ba784b87a9b1982aae7f92f73d1770dde035c2c077cb0396171abbc8b26275eb2aa345d0b9f2e05f8840d6ee2429b77c8a24b1edddfc81eb5e691234005f84574a74278c91413380090a59db02ca80908266fb846e62eaeff0d5575c2a4041b9a5099b8a7b6ba1c3b8e8831321ba5552df484e1eac068aabd1457f84fb18491c86de0daa6ebc1883618ef7707c5ad0e5790013e5dcf6ab6aaa117d0fd6ad72f8c2cd303f9e38edd234bcca4b64a2b4b04e1b108c33422828208a41b381c8baf4ac326b1fa0ac7211afa820d7e65607aadd59c8e629203a10b88440855e682453068a5884a69375cd7715f691345cd74df55da866f7c6e6bad5cc5b24d9ffeb57b6a4a88e777e4fd2500bc14a25fbdec9210eaa121fe8a7b6e5baa3192dbd0543e766dc818c33d7ea0e5876f9645947b700eaae47062badd159d2719be4a526408d7ba6949967e4b04c5ce41198e6cf8dc005bc84213b12ff363fee52c2788278040fc941dfd522204bfb3d332794e5b3b356bae5827c4c3620646f7fb72254ce4434ec80fb8221383766a4eaf854f98ce9c597c4b7f558e00b2e440913ab7a8d4f4253999c0860e4f55d3a7b33baf9311bc92b53b591a4436e215f67e52e5f3d32144b64dbe1c9c58417fabc44d63e39e7d4e6cdd61a52b6245f155929547f57911bc16df74eb902b9a07eceda6f0c6544d1e4131b7f6dba280e78a365a61617d73e713a12847d147d09144a2c8c729fce08476b28664779acd7193f903b0fe0accfd8b837ad3b419dd6c442f5a2fa85094faff53110eddfc15d9162b50c1de7dbae65e9a9d040b083c9790e4e093ca0bbae4de2973866095f8f41239256b1ae84f6ff6770c0eaecabcc64b0762897b5630ac11b633a57760aeb88ac5178f5613afbe9f5962cf41ea7b7926faa1f752a10de097a5ade948579e7b582fda5121d12085e54c2e5a7297788c42b5a4358d6bffdcb86e404327f12c816933619af0f97aed5c881aaea904795e6dcacf61759b3100f6cf386927c1d2c18ad8e7148e26016fd15c56f462a30431e3fe208179cab6c34592715f613b93cfed3595579b8c41273ad23d63d8c9234a03ee396b96d03ba904f328599f9dca4fa11db78551c79f8ba3cabd4522590eba56fc5168e5ef6239299d0e2de020368e74124b73e8b092b068c7436e2a5b9ea78d694fa21e56236240dd01565e3e04f19d62d406a84b4546047e5fef4103ce391b12b4c949e7bf45306a2a10edf950beacb53c11768d1554a4a971f42ba56be2d4a1344105334a826bb1b31344933fcdcd8d556ca930014a1dca87b6d7c794e3233f1e28d8cb815579e1bf3ea3ea11c9c6a3f5c61375a0659861f902fba79cd37047d74c0361076fa247df1cb4942c693ca9725cbbb8189ff8ec2719f2f4decd0400d1429d0708141b9abf1648a471285e6f421ca59af279b78a4e691ea7c6974eecbef601a438913a49d29fd68c61a4331eddeb3c5e61df4c18d3432666e3d5038955178eb8230afa98d34f9dc6f725e9b0bd960ab19711dc374a491d9ffe580b197df8b6c8d53ace8e46cdf6f3eebc15900634b06a382f6d543fe7862a3e43496aed23e4f401fd84d4370d8c4220e7c5224f9c2684aa78ca503ea62df1993a2753d8a8b119f9d0847367f8c678a8ff8be386a7b04295a61792130e5a48d5c4d87edee99853c19fce1d89b68db47a78bc530382aa15f1da7460562670b035e1afc438dded238979d341de8ff6c510218a8d51bcd24cd0685c95421a8bbad0b3aa0ba3332bbab2019f52318e8f8bc67e3295577303401d14585b3e0671fc6cdc47123eb7665ed5e7142ace440285e748f0d345d7334a41c72c002c74fcc650b0239621d4611947dac0958cf6187907e189743224ac741ea18c10a7949979ad0ff3354c445a93bf8cc4f479c89acd5b0f2e94049c3480714125f7ca68269cb3119831b2a0f2909ea340597cb960a847a36909e72841af56a07509496a8efaf000df7d043460b7cb8431177679490c10fe0d26011216acefbc06fc60d2fa0158d0a3ac385b3d3255a1c6455fbcea3ea28f457b9429c4566dfc1f860554c3595d57ba0b41d4782d44b5fc020deee5daa0462b348b84b29d748b5b9ef571b2a25e684b88c814c977aeeabb856ca04aefb0f263d6f1fd3ee25e8cc30c24a6402731a45b04c724a287d3bb74444b30142dcf3d31dc17418e9d3e84698629d9d13c99dbc2e54009ea1251851459f700938f2207ed771f7ee71622044b04f75b7a1e3565f36a1c516545bd28734f966fb00553f4b62a1de7a2a8abb6d24fa2b1361727efb1aa1d3d697071a7de2d53d3f64f87ab00bc3f90bcad4929a25ef54cc4cd7ec348c1b6406c0e43b5390abc8cde6dc3774e31f8f2cbfed6e9080c18a096e6d74d4d7cac4166a1a183abb182e66745b730fabfb1d4018fb791125c7f2866b57dc89e519c2beb578e309086763fb6698157c38940e4a54738c5be4909418f8bbc1cef13b0a0b9507106ab41c02cbc23a0f6707b0743883dba1c18fbc15945fe33ee95a411277aa7cc36b11b2d0c858df3af3f6e1964ea7411095e8cae8d96b09b874f4b815fd0ae194f198ab5006c8952b05f07efbbb10f985f07d59d2265ff4c4fe23e8921661c83b4557afe04f523fb740f03ca06d643595d215fc6a5724611411ec71f5a3e4014155f22cce58a341e5aa7c8ec80bc9957be2660c1feaf0138096d104edd7e19b4f8da38bada4f7848f099931a63c5bcf75b6987b24488625b88f48b65fa0f8c285450bdd9b7a157633664a9c6a27e2342a65bbd2f4f42237997c825c8cebdb82e32e2fbda17c4557702fe9fa39adf522fabd7c2cefd9c0e5642fef2d3cbd2ded94d69ef396098fd4c1a0af71ea1f0788512db102369da094eb2ebfd14c1e8aa515332432c6388f1c8984029ba1385ddea0545e51575d5b7c1a6b779c2ac0bc416206168d1c382b4e6d63072c945e3f355414bcb9c87763c3a731ef7a46bc3abf7d6badfbabecd474a18694eb0a1060c7d45d6e5df808a7c59b570cd22d14e660974e1a4996aeac7591a863812acb17ec099281ee6552d467bcb4890c6326020ee316f0178c60681d961c80e38e361cb048c5fcb395bf276bd70f44dce62cd5fb53f8b1f38a07c0497fe6bcddf3428a20273e58f2510464b914c809e527dff53ab19e7557ef4279d098de1f742fec3eccc77d9eae382537af45b820209b6c3571bb29c1e6a043c69107ae7b5cda1e52622affc689d249f731f15fc4822f47a3dbfa7b31213047797b2f5fafc09fadc41e0c6d1276cb2e9e44ef3b398aa33a243eaa0dea1d3fdf9d1e9400561dfcd1c94c28db2e313be1fc376916af84c441b03f6de3d226a0dc4143e5cf40ad5356bf9453f52e52b403ba8105580ebe6a3f8a7a121d2539ad76bbb38306ed4ef6a84802a23fd5b8007bd5a56c5d8d83d0a8d56e7ba37d176ddf982d5cc4fb20e390edc816de88a20e19df851b76ffdfea76b55806312212e62784d33afe18a5f8691ec0931079c996adfd927f30528de8959afa80de57d8200964a9788e9e0505222c76502727b8e3bde2a50af6d6939a9d70d04a2029686460deb5d271e7cdf501e026e763fbb97fda9b785a230f9c4adcdcc946c2f5e840a7a691521ef0f0eff2349faa248dbb56276288884bd3f0e0ad8df1c1e593491ff8ccc0c050bccb65d03731087fd9d42e47a12eb02c579c140adda0820942e1195f070237a4b7afe1696d20d16047c45f2c381209365544fbd593a191d05f8d7731a5e6115f31275dac6faa9d29689854ff62472ce9f3efce093bee1e63f9e500d7dd12fa8622257e9b05d8f6b928da562acd04e0586ed6dfce36e5305e568b95dcd2679970af9d3d5f2f857fcbc0a98bdeed9a9192a14cea2d719e881284fe2dd25f568e887fe7e0250f9eccf5d5e6d36f640a68001e03cf98468c87ed9481183b0cdc5211a4c4db92c5070919bbd7d5bfe29e6b660b4920038d1c8b29ec5351b7c4a3824d35ef55e0c2ce35a7341a9fecf31c0fe914e8bb0f5800df633df4552a8cb84243e7fe452dbbb66f52eb711b78fbf4fef1197cca30998a62292279e955f4a1c2d3b966b17da670f75ed267aaed61740292333258aae9d5baa220882c0141723f3ca451e37cd6588567038569716043c7861eee220ac97a6ab18075c3df7e20c0c8afd87e41aeab68315496fcc192b6479f3519bd0814eeea3fff7a2fc087fdfaf6bfd0230f11d1a32034b6963471e4c75286498ac6f9fab6279c270f942feede6b7dc226296d352fce4c8cc6e8bbbd715a2958f01c38d3a464512264f77ea85ddf6ee224906dcde745cb8de2617c952a3653655c34fa665dc30e20280c7d6d9278f51a749bb11966266ba573a1ab2e73fe835c81d3ad3dc36b8e111d2134373b44d994c5b36aa5d24792a3cfcfc77b40bc85dadeaed5b2b272e6db71f876766ef8f7f8235db950eb050cbc167d886745f6e40b56fb6e923e9bf3d3e802af31129f380580ae86ac9eeb91ea417f81e9053b0451ec67f375bf7d73f14a39b54923ca3cf4b77f38848a4e50170c33a964b09a0e164754768f8174c39929fa011c64c8e06ea8323b73a6ee9416517d4d03dc4deb526ff8b0b0a767bd800e72d8c5d66b3a2f7cace5f47e33a4e99753f683eb799d76ec65ff242275ba1595defa4da850909270de0653550dcc48fee9d24e20f9168a9bc39cdfa1c5557f99a505dd50da2a7746e48a26fc6fb99c20066a5094bdabcb16599b45c4d6bcc2f8b38986a79097f651d9ebf21a9b6b881d1b400dc80cc5ce760203c6e056f391fafd7460203612a7f1ea8208d717f842a6d7a9557f38f3ae7074c3a1262b0ff7164058f9a15781c9dec09a0c58b8520fde6a800935c43e8c2bab9c7b085582d604cfe47519b273e407f3f5f4b5472b148d64bb6c0d58e524d0073e7a81d0ff9531c2aa1b091dfa9a7fe6f9b21ad7a3357926791c3624375739559171101ccc62eedf62cfd57ab9cb77475753d85d13ec586d05b38ee559ac4c79fcc156ba97e9a096aea3a7bd32f1cb35042b4fe9a0e6e2a12721f5e981232b0428818426556e44bd1c2c38b87febf1fc2b9d68318d7730239b89aa6e4a7ee2f1cd94f3dbedb4c8fbc79d6b428f3406ecf989f0c0098721e8ea6a7f7804141ad832548e0a19c4145bc61e01f592975b63da277ae2d4d3e8d67a1f01651937e0f52e481452619b8837430f6182e8ab4dd67b754049b23903be2d32e2a271d74e99561f3a816c7d9b65057b37bc46a5b6c8ec0f9651f76699b38f8b24e3c6bc1c08da406f3fa12e31d71bcc223071dd7710e76a42a7dbfcd6bd08614f8586038450f4a672645af01b45db8fc76537b538f1d0721689f849653ee08f939a8c63e1b2f848d48a9bb322e93b6cf0b0c65dd02a6bffebbff3e2e1a5af2daf8c167bee240ea6aec05c98b8ba752a3bdf380694d85995abbc5cc0ec1edec0a9a429e61f31c25e6de7f5cc5a0c235cc46c5070ecedaacba9b0939140e48e4888a869ee92a8e58f597d70498c566aeaab691bb736e7b5a07645f3f3aa17dc6e6a43e1719619089c64348284ffa43c64223124e30103b2f71022473ddd5440fff2570a186e281b6b42a1c416ccd0efe94a57ea5e1c9bf1596faf34dada4a541db35674e01ed4dd9c532591c9df84b4c0700c30fefcc6bc0e6800594de9046818402c778aa15f3fb74fbf7d3dbeb6508e760f6e2e7dfd8d6de96560e48a649aaee30a325da752a8c967a84909efcaa50cb765cf9d98e88ac752a6a90b366de2a1c1b7f257b0181b2bc556354f16cb6590a4c681ef8778b755ead0cae05488c7aeef0759a5fd51bb8c10a7e74281f6404669a75c4c43294d91e2e1f44f2c19f70fe9a949fd479946fe667887cde5b60163dbd891fc71dbf3dded55f4aacea43dfb53eb55693f11129b48cacabc527a0b9c93f3645b7f4ef7b97985334e14be7c932089555b74ef5e620a8c2f71b5ef5e593ba4007a05681a6428a5e63ec419a7e3ab784b0591d02b13bbb67e40e238f7b10cc2ed37823b9431fcf8df976a16eea924078558b6ba723b51aa19ef49cbb35013f728aa75ddaa86792fd1c2d5557be24713dcba06435f5ff5369607036777a937921da897ff1aa9f49021a7b2bab1f74ea2291b047d3c6493f0f9abe9f82c9c7c1055e537f8235654e1441be2f188a2b0c93c227da915306401fa75ea5c25989864e163a0802c8cecf6bfe39e164e03a9a05bd4f2f2ac6ae4843d5e01f085c0baafbe6a33d35b3264274de4f60c0cd5e55621ca67934e7f50144d4f672b6939cc908a5bfe3add0f217b3c9f40287e6f397a52eb2c3cb6c48168a18723ac77d8418955b31997eeae2ff14dde700e2e68f2b4f742d4c089eb1454f42e7fd3521361916ee99c464358e6198959d6dcc219af9d9c0a54ea3d4a7b16f8095188e68eca29e77116adb94b4460b7b6e7a30bf848a6cfb1326224f0454e741d49e7f085d90752da744d3b69bfc106707fbafe9b28a87d23e3f021d50196445a767a77c374f48b4bb6eaaa23b0e8305e7d6b254191babc3a31c5aa96fab18ff539b79008001edd44c64ffe969954d41667a4007b64ef05199b57d9c54752b8689e4ac4def553c503da5d43f290a32355cbed5b08f4caa50a3de92ecc5b49f68eec6f7d2ba993308618980fbab7e491581bedcad30c498beb89c4e4ace387f49413fb95c712e9613da8c62d5d73282e4ee53e20b1ff0716d8ed9aeb4c6bddbe862bf5ef6538f116499a4b238950d83097d4bde31476b4830475f225</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-wave">      <input class="hbe hbe-input-field hbe-input-field-wave" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-wave" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-wave">文章被加密了, 请输入密码查看.</span>      </label>      <svg class="hbe hbe-graphic hbe-graphic-wave" width="300%" height="100%" viewBox="0 0 1200 60" preserveAspectRatio="none">        <path d="M0,56.5c0,0,298.666,0,399.333,0C448.336,56.5,513.994,46,597,46c77.327,0,135,10.5,200.999,10.5c95.996,0,402.001,0,402.001,0"></path>      </svg>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">🔒各种各样性能优化的奇淫异巧</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="性能优化" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="加密文章" scheme="https://blog.liukairui.me/tags/%E5%8A%A0%E5%AF%86%E6%96%87%E7%AB%A0/"/>
    
    <category term="性能优化" scheme="https://blog.liukairui.me/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>一些 React 的 Tips</title>
    <link href="https://blog.liukairui.me/article/%E4%B8%80%E4%BA%9BReact%E7%9A%84Tips/"/>
    <id>https://blog.liukairui.me/article/%E4%B8%80%E4%BA%9BReact%E7%9A%84Tips/</id>
    <published>2023-02-12T16:00:01.000Z</published>
    <updated>2023-02-12T16:00:01.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基础">基础</h2><ul><li><p><strong>修改数组类型的 state</strong></p><ul><li><p>💩拷贝-修改-回填</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">addItem</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// push 会修改原数组所以必须复制</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> items <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>👍️合并-回填</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">addItem</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">items</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token comment">// concat 并不会修改原数组</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p><strong><code>state</code> &amp; <code>props</code>异步的</strong></p><ul><li><p>💩直接使用 <code>state</code> &amp; <code>props</code> 做更新</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>increment<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>👍️使用函数更新</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  <span class="token literal-property property">counter</span><span class="token operator">:</span> state<span class="token punctuation">.</span>counter <span class="token operator">+</span> props<span class="token punctuation">.</span>increment<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p><strong><code>useState</code>初始值何时采用函数作为入参</strong></p><ul><li><p>当初始值需要被计算时</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">+</span> cur<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 💩 在每次渲染组件时, reduce 都会被计算一遍结果然后被丢弃</span><span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>  props<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">+</span> cur<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 👍️ 在每次渲染组件时, 都会声明一个匿名函数, 但是函数不会执行, 不会计算 reduce</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>初始值是很复杂对象时</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>k1<span class="token punctuation">,</span> k2<span class="token punctuation">,</span> k3<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">,</span> k1000<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 💩 在每次渲染组件时, 都要花大力气一个很大的对象, 然后丢弃</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>k1<span class="token punctuation">,</span> k2<span class="token punctuation">,</span> k3<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">,</span> k1000<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 👍️ 函数的声明耗时与函数内部的代码量不相关</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p><strong><code>useState</code> &amp;<code>useRef</code></strong></p><ul><li><p>区别: <code>useState</code> 的值在每个 <code>render</code>中都是独立存在的, 而 <code>useRef.current</code>则更像是相对于render函数的一个全局变量, 每次他会保持 <code>render</code>的最新状态. (<code>useRef</code> 相当于创建了类组件的成员变量)</p></li><li><p>场景</p><ul><li>变量维护 UI 状态, 更新时需要刷新 UI: <code>useState</code></li><li>变量不维护 UI 状态, 更新时不需要刷新 UI: <code>useRef</code></li><li>变量不更新: <code>const [foo] = useState(initValue)</code></li></ul></li><li><p>陷阱: 不要使用 <code>ref</code> 非幂等(增量)的更新<code>ref</code>. 在 StrictMode 的 Dev 环境下, 组件会被渲染两次,以检查组件的幂等性, 并且不提供 Warning...</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">ref1<span class="token punctuation">.</span>current <span class="token operator">=</span> ref1<span class="token punctuation">.</span>current <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment">// 💩 会执行两次相当于 + 2</span>ref1<span class="token punctuation">.</span>current <span class="token operator">=</span> someState <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment">// 👍️ state 连续渲染两次值并不会变</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul></li><li><p>不要吝啬 <code>setState</code></p><p>与 Vue 不同, React 并不会在数据被 Set 后同步刷新数据, 而是会合并更新,所以同步的多个 <code>setState</code> 不会造成性能问题</p></li><li><p>不要在组件中过度使用 <code>useEffect</code></p><p>将这层逻辑抽离成自己的 <code>Hook</code>, 方便复用, 方便阅读.否则光读 <code>useEffect</code> 都读不完, <code>useEffect</code>也可以让代码更加工整, 可读性也更高</p></li><li><p>强调数据流向, 单一事实来源</p><ul><li>尽量让响应式数据的数据来源变简单</li><li>没有了自动依赖手机, 要理清楚状态发生变化的原因,数据变化会引发哪些状态变化</li><li>强调数据的提供与消费, 我向外暴露什么样的数据,什么组件会消费我的数据</li></ul></li><li><p>在 <code>setState</code> 的时候注意有没有 Effect 依赖于这个<code>State</code>, 是否会造成循环更新(还是数据流问题)</p></li><li><p><code>useEffect</code> 的 <code>shadow</code> 比较</p><p>在写 <code>useEffect(()=&gt;&#123;&#125;, [])</code> 时第二个参数是一个数组,当数组内元素变化时会触发重新执行,但是这里检测变化的方法是对数组中元素<strong>进行 shadow 比较</strong>,并不是像 Vue 一样进行依赖追踪, 例如 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token parameter">vals <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vals<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>vals<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre> 每次渲染时传入的<code>vals</code> 都是新 <code>vals</code>, react 在对比时就会发现<code>vals</code> 不同, 触发 <code>rerender</code></p><p>可以通过如下方法修复这个问题 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> vals<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每次对比的都是 vals 数组内部的值</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>vals<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p><p><strong>千万注意 react 只是对数组进行 shadow 比较,不是对我们传入的变量做依赖追踪</strong></p></li><li><p>Hook 的闭包陷阱</p><p>只要是要在 Hook 中使用外部的东西就要注意陷阱, 例如</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">function</span> <span class="token function">consoleStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    <span class="token function">consoleStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>跑起来没毛病, 但是如果后期将代码改成</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>store<span class="token punctuation">,</span> setStore<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token keyword">function</span> <span class="token function">consoleStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>    <span class="token function">consoleStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>就完蛋了, 因为 useEffect 拿到的永远是最开始定义的<code>consoleStore</code>, 其中的 <code>store</code>也永远是第一次渲染的 <code>store</code>. 为了防止出这种问题,一定要装这个包 <span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvZXNsaW50LXBsdWdpbi1yZWFjdC1ob29rcw==">eslint-plugin-react-hooks<i class="fa fa-external-link-alt"></i></span></p></li><li><p>减小 <code>useEffect</code> 的体积</p><p>俺理解 React 所谓的函数式并不是严格的函数式, 而是形式上的函数式.如果我写一个组件, 里面没有 <code>useEffect</code>, 只要事实来源不变,整个 View 就不变, 事实来源变了, View 可以符合预期的变化. 当然,不可能所有的组件都是纯函数的, 我们可以用一些 Hooks 在 Hooks 内部加入<code>Effect</code> 代码, 但是向外部表现为一个自动化的事实来源,当状态发生变化时对 View 做一定程度的精修. 在外层组件看来,代码并没有副作用, 外层组件也可以忘记 Hooks 内部存在副作用,像着纯函数一样使用. 例如这样的函数式组件就看起来很舒服</p><pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span>display<span class="token punctuation">,</span> disabled<span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 事实来源是 props</span>  <span class="token comment">// working 是一个额外的属性, 但是他不是事实来源, 只是算出来的数据</span>  <span class="token keyword">const</span> working <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span>display <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>disabled<span class="token punctuation">,</span> <span class="token punctuation">[</span>display<span class="token punctuation">,</span> disabled<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// useLocalStorge 是一个 Hook, 内部通过 useEffect 获取数据, 同步修改</span> <span class="token comment">// 但是作为视图层, 我完全可以忽略这个问题, 从我的角度看这就是一个 Storgae 的事实来源, 从外部看这就是一个 state, 就是一个数据来源. 函数副作用这些脏活, 已经被 Hook 实现时候帮忙处理掉了</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>storage<span class="token punctuation">,</span> setStorage<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useLocalStorage</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'cookie'</span><span class="token punctuation">,</span> <span class="token string">'tocken'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">  </span><span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所以, 俺觉得, 好的代码的事实来源一定是 <code>props</code>,<code>useXXHook</code> 而 <code>useMemo</code> 只是做状态桥接的,<code>useState</code> 只是帮忙存储数据的,并不是发生变化的事实来源</p></li><li><p>增加一个 <code>useEffect</code> 依赖的时候要想:这个依赖会不会在每次 render 的时候变化造成循环依赖,这个依赖变化的时候函数内部产生的内容应不应该变化</p></li><li><p><code>useState</code> 可以传引用类型</p><p>如果 <code>useState</code> 传入一个引用类型, 在 <code>rerender</code>时候引用值<strong>并不会变</strong>, 例如下面的代码会一直输出<code>false</code></p><pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">let</span> demos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储每次 rerender 时候的函数</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>demo<span class="token punctuation">,</span> setDemo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 传入一个函数</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>foo<span class="token punctuation">,</span> setFoo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 传入一个常量用于触发更新</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token comment">// 每秒钟 rerender 一下</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setFoo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>foo<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  demos<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>demo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将每次 rerender 的函数放在 demos 中</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>demos<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d <span class="token operator">!==</span> demos<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检查函数引用是否发生变化</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>App<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">&#123;</span><span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">&#123;</span>foo<span class="token punctuation">&#125;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>useMemo</code> 的使用场景</p><p>当成 Vue 的 <code>computed</code> 用, 能用 <code>useMemo</code>就不要用 <code>useState</code>, <strong>减少可变数据, 减少数据源,尽可能减少事实来源</strong></p></li><li><p><code>useCallback</code> 的使用场景</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>deps<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>对于 <code>foo</code>, 每次 rerender 时候 <code>foo</code>的引用值都会发生变化.</p><p>对于 <code>bar</code>, 每次 rerender 事后, 只要 <code>deps</code>不发生变化, <code>bar</code> 的引用值不变.</p><p>那么 <code>useCallback</code> 有什么用呢? 可以节约函数定义? 因为只要<code>deps</code> 不变, 返回的函数不变. 看起来我们没有定义新的函数,但是</p><p><strong><code>useCallback</code> 并不会节约函数定义的开销, 因为在调用<code>useCallback</code> 之前, 我们已经声明了这个函数</strong></p><p>为什么用 <code>useCallback</code> 而不是直接定义, 或者使用<code>useState</code></p><p><code>useState</code> + <code>useEffect(()=&gt;&#123;&#125;, [deps])</code>当然可以, 但是 <code>useCallback</code> 显然简洁</p><p>直接定义并不会影响当前组件的调用, 但是如果该函数作为<code>props</code> 传给了其他组件, 其他组件使用了 <code>memo()</code>,只要 <code>props</code> 不变组件就不 rerender, 但是你传给组件一个函数,这父组件每次 rerender 就会导致函数引用变化, 就会导致子组件一直<code>rerender</code>, 这时 <code>useCallback</code> 就变得很有用,所以</p><p><strong>给向外提供函数的时候尽量 <code>useCallback</code>一下</strong></p></li><li><p><code>StrickMode</code> 严格模式</p><p><span class="exturl" data-url="aHR0cHM6Ly96aC1oYW5zLnJlYWN0anMub3JnL2RvY3Mvc3RyaWN0LW1vZGUuaHRtbCNpZGVudGlmeWluZy11bnNhZmUtbGlmZWN5Y2xlcw==">奇奇怪怪<i class="fa fa-external-link-alt"></i></span></p></li></ul>]]></content>
    
    
    <summary type="html">菜菜子</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="前端框架" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="React" scheme="https://blog.liukairui.me/tags/React/"/>
    
  </entry>
  
  <entry>
    <title>WebAnimation 与 FLIP 技术</title>
    <link href="https://blog.liukairui.me/article/WebAnimation%E4%B8%8EFLIP%E6%8A%80%E6%9C%AF/"/>
    <id>https://blog.liukairui.me/article/WebAnimation%E4%B8%8EFLIP%E6%8A%80%E6%9C%AF/</id>
    <published>2023-02-08T16:00:01.000Z</published>
    <updated>2023-02-08T16:00:01.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="web-animations-api">Web Animations API</h2><p>类似于 CSS in JS 的 animation 实现.</p><ul><li><p>基本使用</p><ul><li><p>定义关键帧</p><p>使用对象数组的模式定义关键帧</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> aliceTumbling <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span> <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token string">'rotate(0) translate3D(-50%, -50%, 0)'</span><span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'#000'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'#431236'</span><span class="token punctuation">,</span> <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0.3</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span> <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token string">'rotate(360deg) translate3D(-50%, -50%, 0)'</span><span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'#000'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用 <code>offset</code> 指定关键帧出现在动画位置的百分比,首尾对象默认 <code>offset = 0/1</code></p><p>若不指定 <code>offset</code> 则直接选取中点作为 <code>offset</code>,例如</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span> <span class="token punctuation">&#123;</span><span class="token comment">/*...*/</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- 第一个元素, offset = 0</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0.4</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- 手动指定, offset = 0.4</span> <span class="token punctuation">&#123;</span><span class="token comment">/*...*/</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- 未指定, 均分为 0.4 + (1-0.4)/3*1 = 0.6</span> <span class="token punctuation">&#123;</span><span class="token comment">/*...*/</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- 未指定, 均分为 0.4 + (1-0.4)/3*2 = 0.8</span> <span class="token punctuation">&#123;</span><span class="token comment">/*...*/</span><span class="token punctuation">&#125;</span> <span class="token comment">// &lt;- 最后一个元素, offset = 1</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>定义动画执行模式</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> aliceTiming <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>  <span class="token literal-property property">iterations</span><span class="token operator">:</span> <span class="token number">Infinity</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>执行动画</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> anim <span class="token operator">=</span> elem<span class="token punctuation">.</span><span class="token function">animate</span><span class="token punctuation">(</span>aliceTumbling<span class="token punctuation">,</span> aliceTiming<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul></li><li><p>Hooks</p><ul><li>下面的 <code>anim</code> 就是 <code>elem.animate()</code>的返回值</li><li><code>anim.play() / anim.pause()</code>: 执行 / 暂停动画. 注意,动画在 <code>animate()</code> 的时候回自动执行, 如需手动控制需要立刻<code>pause</code> 一下</li><li><code>anim.playbackRate</code>: 动画执行速率(可以为负数),可写属性</li><li><code>anim.currentTime</code>: 动画执行时间, 可写属性</li><li><code>anim.effect.timing.duration</code>: 动画持续时间, 类似属性见<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvQVBJL1dlYl9BbmltYXRpb25zX0FQSS9Vc2luZ190aGVfV2ViX0FuaW1hdGlvbnNfQVBJ">MDN<i class="fa fa-external-link-alt"></i></span></li><li><code>anim.finish()</code>: 动画结束</li><li><code>anim.cancel()</code>: 终止动画</li><li><code>Animation.reverse()</code>: 反向播放动画</li><li><code>document.getAnimations()</code>: 获取全部 Web Animation注册动画</li><li><code>anim.onfinish(callback)</code>: 动画结束回调</li><li><code>anim.oncancel(callback)</code>: 动画取消回调</li></ul></li></ul><h2 id="flip-技术">FLIP 技术</h2><p>当我们需要对 DOM 的位置做调整但是又不知道目标位置的具体时可以用 FLIP实现带有过渡动画的位置调整.</p><p>例如, 有 <code>a b c d</code> 元素, 我们希望将元素变为<code>d c b a</code>. 可以直接通过 DOM API 调整位置, 但是无法实现动画.FLIP 的做法是先将元素的起始位置记下来, 再调整到目标位置, 再通过 CSS将元素调到原为止, 最后通过动画完成过渡</p><ul><li><strong>First</strong>：在任何事情发生之前，记录将要转换的元素的当前（即第一）位置和尺寸。您可以使用<code>element.getBoundingClientRect()</code>它，如下所示。</li><li><strong>Last</strong>：执行使过渡瞬间发生的代码，并记录元素的最终（即last）位置和尺寸。</li><li><strong>Invert</strong>：由于元素位于最后一个位置，我们想通过<code>transform</code>修改其位置和尺寸来创建它位于第一个位置的错觉。这需要一点数学运算，但并不难。</li><li><strong>Play</strong>：元素反转（并假装在第一个位置），我们可以通过将其设置为<code>transform</code>来将其移回到最后一个位置<code>none</code>。</li></ul><p><span class="exturl" data-url="aHR0cHM6Ly92Mi52dWVqcy5vcmcvdjIvZ3VpZGUvdHJhbnNpdGlvbnMuaHRtbCNMaXN0LU1vdmUtVHJhbnNpdGlvbnM=">vue2 文档<i class="fa fa-external-link-alt"></i></span>中提到的效果</p><iframe src="https://codesandbox.io/embed/github/vuejs/v2.vuejs.org/tree/master/src/v2/examples/vue-20-list-move-transitions?fontsize=14&amp;hidenavigation=1" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" title="vue-20-list-move-transitions" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"></iframe><h2 id="动画实现的比较">动画实现的比较</h2><p>动画的实现方法:</p><ul><li>纯 CSS (animation / transition) with GPU</li><li>纯 JS (requestAnimationFrame &amp; style)</li><li>WebAnimation API</li></ul><p>其中</p><ul><li><p>JS 实现的动画会被同步代码阻塞. 但是更加灵活</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token comment">/*...*/</span><span class="token punctuation">)</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;- request 卡死</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>不使用 GPU 渲染的 CSS 动画会被同步代码阻塞, 采用 GPU 的不阻塞.只要动画涉及的属性不引起 reflow 动画的采样就会交给 GPU 处理.</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">#alice_css</span> <span class="token punctuation">&#123;</span>  <span class="token property">animation</span><span class="token punctuation">:</span> cssRound infinite 3s linear<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token atrule"><span class="token rule">@keyframes</span> cssRound</span> <span class="token punctuation">&#123;</span>  <span class="token selector">0%</span> <span class="token punctuation">&#123;</span>    <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>  <span class="token comment">/* &lt;- left 会引发重绘, 此时动画的渲染是由 CPU 完成的, 如果执行 while(true); 动画就会卡死*/</span>  <span class="token punctuation">&#125;</span>  <span class="token selector">100%</span> <span class="token punctuation">&#123;</span>    <span class="token property">left</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">#alice_css</span> <span class="token punctuation">&#123;</span>  <span class="token property">animation</span><span class="token punctuation">:</span> cssRound infinite 3s linear<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token atrule"><span class="token rule">@keyframes</span> cssRound</span> <span class="token punctuation">&#123;</span>  <span class="token selector">0%</span> <span class="token punctuation">&#123;</span>    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span>0deg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* &lt;- rotateZ 不会引发重绘, 此时动画的渲染是由 GPU 完成的, 如果执行 while(true); 动画不会卡死*/</span>  <span class="token punctuation">&#125;</span>  <span class="token selector">100%</span> <span class="token punctuation">&#123;</span>    <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">rotateZ</span><span class="token punctuation">(</span>360deg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因此, 能使用 CSS 动画的就不要用 JS 动画</p></li><li><p>WebAnimation API: 通过 JS 的方式定义动画, 最终会将动画效果通过CSS 动画完成, 其对同步 JS 代码阻塞的表现与 CSS 动画一致</p><p>这个 API 既保留了 JS 的灵活性(控制动画执行, 动画执行观测, 与JS交互),同时使用类似 CSS 的方式执行动画, 减少了同步代码对动画的影响</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> aliceJs <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'alice_js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> aliceRoundJs <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span> <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token string">'rotateZ(0deg)'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- 同步代码阻塞也卡死</span>    <span class="token punctuation">&#123;</span> <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token string">'rotateZ(360deg)'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> aliceTimeJs <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>    <span class="token literal-property property">iterations</span><span class="token operator">:</span> <span class="token number">Infinity</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  aliceJs<span class="token punctuation">.</span><span class="token function">animate</span><span class="token punctuation">(</span>aliceRoundJs<span class="token punctuation">,</span> aliceTimeJs<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> aliceJs <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'alice_js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> aliceRoundJs <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token punctuation">&#123;</span> <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token string">'0'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- 同步代码阻塞也不卡死</span>  <span class="token punctuation">&#123;</span> <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token string">'300px'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> aliceTimeJs <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>  <span class="token literal-property property">iterations</span><span class="token operator">:</span> <span class="token number">Infinity</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>aliceJs<span class="token punctuation">.</span><span class="token function">animate</span><span class="token punctuation">(</span>aliceRoundJs<span class="token punctuation">,</span> aliceTimeJs<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
    
    
    <summary type="html">一些动画相关的魔法</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="动画" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/%E5%8A%A8%E7%94%BB/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="性能" scheme="https://blog.liukairui.me/tags/%E6%80%A7%E8%83%BD/"/>
    
    <category term="动画" scheme="https://blog.liukairui.me/tags/%E5%8A%A8%E7%94%BB/"/>
    
  </entry>
  
  <entry>
    <title>Chrome DevTool Console APIs</title>
    <link href="https://blog.liukairui.me/article/ChromeDevToolConsoleAPIs/"/>
    <id>https://blog.liukairui.me/article/ChromeDevToolConsoleAPIs/</id>
    <published>2023-02-02T16:00:01.000Z</published>
    <updated>2023-02-02T16:00:01.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="console-apis">Console APIs</h2><blockquote><p>来自: https://developer.chrome.com/docs/devtools/console/api</p><p>以下插件可在 JavaScript 代码中使用, 非 DevTools 专有 API</p></blockquote><ul><li><p><code>console.assert(assertion, obj1[, obj2...])</code>: 传入一个boolean 若为假则抛出异常</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">assert</span><span class="token punctuation">(</span>number <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">number</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">errorMsg</span><span class="token operator">:</span> errorMsg<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p><code>console.count([label])</code>: 输出 label 被放入 count执行的次数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// default: 1 (不写 label 就是 default)</span>console<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token string">'coffee'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// coffee: 1</span>console<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token string">'coffee'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// coffee: 2</span>console<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// default: 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>console.countReset([label])</code>: 重置一个 count</p></li><li><p><code>console.debug / info / error / warn</code>: 与<code>console.log</code> 用法相同, 但等级不同</p></li><li><p><code>console.dir()</code>: 打印对象</p></li><li><p><code>console.dirxml(xml)</code>: 打印 XML 对象</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">dirxml</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p><code>console.table</code>: 打印表格</p></li><li><p><code>console.group*</code>: 一系列打印可折叠日志的方法</p></li><li><p><code>console.time([label]) / console.timeEnd([label])</code>:计时</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> square <span class="token operator">=</span> i <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>console.trace()</code>: 打印当前调用栈</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">first</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">second</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token function">third</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">third</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token function">fourth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">fourth</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="console-实用-apis">Console 实用 APIs</h2><blockquote><p>内容来自:https://developer.chrome.com/docs/devtools/console/utilities</p><p>以下 API 在 JS 中不可用, 仅限 DevTool 下使用</p></blockquote><ul><li><p><code>$_</code>: 返回最近计算的表达式值</p></li><li><p><code>$0-$4</code>: 返回最近 1 - 5 个 Element面板选中的元素</p></li><li><p><code>$(selector, startNode)</code>: 选中一个元素, 相当于<code>document.querySelector(selector)</code>, 其中<code>startNode</code> 为检索的根节点. 注意<strong>这不是jQuery</strong></p></li><li><p><code>$$(selector, startNode)</code>: 选中元素, 相当于<code>document.querySelectorAll(selector)</code>, 其中<code>startNode</code> 为检索的根节点. 注意<strong>这不是jQuery</strong></p></li><li><p><code>$x(selector)</code>: 通过 <code>xpath</code> 选中元素, 例如<code>$x("//p")</code></p></li><li><p><code>copy(object)</code>将指定对象的字符串表示形式复制到剪贴板</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">copy</span><span class="token punctuation">(</span>$0<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p><code>debug(fn) / undebug(fn)</code>: 调试函数,当函数被调用时中断执行并跳转源代码面板</p></li><li><p><code>dir / dirxml / key / value</code>: 和<code>console.*</code> 一样, 只不过是做了 preclude</p></li><li><p><code>inspect(object / function)</code>: 若为 Element 则在Element 面板选中元素. 若为 function 则在源代码中显示函数</p></li><li><p><code>getEventListeners(element)</code>: 获取 Element的所有事件监听.</p></li><li><p><code>keys(object) / values(object)</code>: 获取对象的 key /value</p></li><li><p><code>monitor(fn) / unmonitor(fn)</code>:当函数被调用时输出函数名与调用参数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">monitor</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// function sum called with arguments: 1, 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>monitorEvents(element, stirng[] | string) / unmonitorEvents(object[, events])</code>:监听对象的事件被触发, 触发后输出事件与 <code>event</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">monitorEvents</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"resize"</span><span class="token punctuation">,</span> <span class="token string">"scroll"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">// resize Event &#123;isTrusted: true, type: 'resize', target: Window, currentTarget: Window, eventPhase: 2, …&#125;</span><span class="token function">monitorEvents</span><span class="token punctuation">(</span>$0<span class="token punctuation">,</span> <span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p><code>profile([label]) / profileEnd([label])</code>: 开启 /关闭一个 JavaScript 性能分析. 关闭后可在 DevTool 的 JavaScript性能剖析器查看分析内容. <strong>支持同时开多个分析器</strong></p></li><li><p><code>queryObjects(Constructor)</code>:返回一个构造函数的所有实例的<strong>类数组</strong></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">queryObjects</span><span class="token punctuation">(</span>Promise<span class="token punctuation">)</span><span class="token comment">//Array(20)</span><span class="token comment">//0: Promise &#123;&lt;pending>&#125;</span><span class="token comment">//1: Promise &#123;&lt;pending>&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
    
    
    <summary type="html">一些 Concole API 以及一些只有在 Chrome DevTool Console 下可用的魔法</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="DevTool" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/DevTool/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="DevTool" scheme="https://blog.liukairui.me/tags/DevTool/"/>
    
    <category term="调试" scheme="https://blog.liukairui.me/tags/%E8%B0%83%E8%AF%95/"/>
    
    <category term="chrome" scheme="https://blog.liukairui.me/tags/chrome/"/>
    
  </entry>
  
  <entry>
    <title>奇怪的 DOM API</title>
    <link href="https://blog.liukairui.me/article/%E5%A5%87%E6%80%AA%E7%9A%84DOMAPI/"/>
    <id>https://blog.liukairui.me/article/%E5%A5%87%E6%80%AA%E7%9A%84DOMAPI/</id>
    <published>2023-01-18T16:00:01.000Z</published>
    <updated>2023-01-18T16:00:01.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="node-element">Node &amp; Element</h2><ul><li><p><strong>两者关系</strong>: Element 是 Node 的子类</p></li><li><p><strong>区分方法</strong>: 一个简易的区分 Node 和 Element的方法是: <strong>所有按照标签语法书写的元素都是 Element</strong>.依照这个规则,</p><ul><li><p>以下节点都是不是 Element 而是 Node</p><ul><li><p>Text Node: <code>"I am a text node"</code></p></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvQVBJL0NEQVRBU2VjdGlvbg==">CDataSection Node<i class="fa fa-external-link-alt"></i></span>:<code>&lt;![CDATA[  &lt; &gt; &amp; ]]&gt;</code></p></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1Byb2Nlc3NpbmdJbnN0cnVjdGlvbg==">ProcessingInstruction Node<i class="fa fa-external-link-alt"></i></span>:<code>&lt;?xml-stylesheet type="text/css" href="rule.css"?&gt;</code></p></li><li><p>Comment Node: <code>&lt;!-- I am comment--&gt;</code></p></li><li><p>Document Type Node: <code>&lt;!doctype html&gt;</code></p></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvQVBJL0RvY3VtZW50RnJhZ21lbnQ=">DocumentFragment Node<i class="fa fa-external-link-alt"></i></span>: <code>#document</code></p></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvQVBJL0F0dHI=">AttributeNode<i class="fa fa-external-link-alt"></i></span>: <code>class="dmeo"</code></p></li></ul></li><li><p>以下节点是 Element</p><ul><li>Element Node</li><li>Document Node</li></ul></li></ul><p>可以采用 <code>node instanceof Node</code>,<code>node instanceof Element</code> 判断节点类型</p><p>也可以采用 <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvQVBJL05vZGUvbm9kZVR5cGU=">nodeType<i class="fa fa-external-link-alt"></i></span>判断</p></li><li><p><strong>property 区别</strong></p><ul><li><p><strong><code>childNodes</code> &amp;<code>children</code></strong></p><p>后者只能获取子 <code>Element</code> 不能获取非 Element 的 Node.前者返回的是 <code>NodeList</code> 后者返回的是<code>HTMLCollection</code>. <code>HTMLCollection</code>没有任何数组方法, 例如 <code>map()</code>, <code>find()</code>,<code>forEach()</code> 等等. 但是NodeList确实有 <code>forEach()</code>方法. 这是它唯一拥有的数组方法. <code>HTMLCollection</code>总是实时更新.</p></li><li><p><strong><code>firstChild</code> &amp;<code>lastChild</code></strong> 返回的 <code>NodeList</code></p></li><li><p><strong><code>getElement*</code></strong> 返回的是<code>HTMLCollection</code></p><p><strong><code>query*</code></strong> 返回的是<code>NodeList</code></p></li><li><p><strong><code>tagName</code> &amp;<code>nodeName</code></strong></p><p><code>nodeName</code> 为 <code>Node</code> 的方法,<code>tagName</code> 为 <code>Element</code> 的方法</p><p><code>nodeName</code> 结果全大写, <code>tagName</code>全小写</p></li><li><p><strong><code>innerText</code> &amp;<code>textContent</code>:</strong> <code>innerText</code> 是<code>Element</code> 的方法, <code>textContent</code> 是<code>Node</code> 的方法</p></li><li><p><strong><code>setAttribute</code></strong> 是一个<code>Element</code> 方法</p></li><li><p>CSS 选择器只能选中 Element./img</p></li></ul></li></ul><h2 id="innertext-textcontent"><code>innerText</code> &amp;<code>textContent</code></h2><ul><li><code>innerText</code> 是 <code>Element</code> 的方法,<code>textContent</code> 是 <code>Node</code> 的方法</li><li><code>textContent</code> 会把所有子元素的文本连接起来并返回, 但是<code>innerText</code> 会返回一个"人类可见&amp;可读"的文本,它不会返回不可见元素的文本(例如<code>&lt;style&gt;</code>、<code>&lt;script&gt;</code>、<code>&lt;span style="display:none"&gt;</code>).就好像你用鼠标选中这段文本后再 Ctrl+C 得到的文本.</li><li>也正因为上面这一点, 所以在读取(或修改)一个元素的<code>innerText</code> 属性时会为了计算 CSS 而造成一次重绘(reflow),所以它的性能比 <code>textContent</code> 低.</li></ul><h2 id="样式与属性">样式与属性</h2><ul><li><p>增加样式:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Ele<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> xxx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>增加 class</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Ele<span class="token punctuation">.</span>className<span class="token operator">=</span><span class="token string">'aaa'</span>  <span class="token comment">// 设置元素的class为aaa ，如果元素上原本有class则会覆盖</span>Ele<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span> <span class="token comment">// 给Ele新增aaa</span>Ele<span class="token punctuation">.</span>className <span class="token operator">+=</span> <span class="token string">" aaa"</span>  <span class="token comment">// 给Ele新增aaa</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>包含 class</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Ele<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>增加属性</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Ele<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"data-id"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>删除属性</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Ele<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">"data-id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>获取属性值</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"data-id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><blockquote><p>以下内容来自: https://juejin.cn/post/6966062224892756005</p></blockquote><h2 id="尺寸相关">尺寸相关</h2><ul><li><p>尺寸示意图</p><figure><img src="./img08.jpg" alt="img01" /><figcaption aria-hidden="true">img01</figcaption></figure></li><li><p>获取实际屏幕宽高</p><figure><img src="./img01.png" alt="img01" /><figcaption aria-hidden="true">img01</figcaption></figure><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">W</span>  <span class="token operator">=</span>  window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>width<span class="token keyword">const</span> <span class="token constant">H</span>  <span class="token operator">=</span>  window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>height<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>获取浏览器宽高</p><figure><img src="./img02.png" alt="img02" /><figcaption aria-hidden="true">img02</figcaption></figure><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">W</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>outerWidth<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token constant">H</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>outerHeight<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>获取当前窗口宽高（浏览器视口宽高）</p><figure><img src="./img03.png" alt="img03" /><figcaption aria-hidden="true">img03</figcaption></figure><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">W</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token constant">H</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>获取元素布局宽高</p><figure><img src="./img04.png" alt="img04" /><figcaption aria-hidden="true">img04</figcaption></figure><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">W</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>offsetWidth<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token constant">H</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>offsetHeight<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>获取元素内容宽高</p><figure><img src="./img05.png" alt="img05" /><figcaption aria-hidden="true">img05</figcaption></figure><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">W</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>scrollWidth<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token constant">H</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>获取滚动后被隐藏页面的宽高</p><figure><img src="./img06.png" alt="img06" /><figcaption aria-hidden="true">img06</figcaption></figure><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">H</span> <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token constant">W</span> <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollLeft<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>获取元素距离顶部和左边距离</p><figure><img src="./img07.png" alt="img07" /><figcaption aria-hidden="true">img07</figcaption></figure><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> top <span class="token operator">=</span> Ele<span class="token punctuation">.</span>offsetTop<span class="token punctuation">;</span><span class="token keyword">const</span> left <span class="token operator">=</span> Ele<span class="token punctuation">.</span>offsetLeft<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h2 id="事件相关">事件相关</h2><h3 id="鼠标事件">鼠标事件</h3><ul><li><p>单击事件</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Ele<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onclick"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>双击事件</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Ele<span class="token punctuation">.</span><span class="token function-variable function">ondblclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"ondblclick"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>右击事件</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Ele<span class="token punctuation">.</span><span class="token function-variable function">oncontextmenu</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"oncontextmenu"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>鼠标按下事件</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Ele<span class="token punctuation">.</span><span class="token function-variable function">onmousedown</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onmousedown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>鼠标移动事件</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Ele<span class="token punctuation">.</span><span class="token function-variable function">onmousemove</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onmousemove"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>鼠标抬起事件</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Ele<span class="token punctuation">.</span><span class="token function-variable function">onmouseup</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onmouseup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>鼠标进来事件</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 鼠标移动到自身时候会触发事件，同时移动到其子元素身上也会触发事件</span>Ele<span class="token punctuation">.</span><span class="token function-variable function">onmouseover</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onmouseover"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 鼠标移动到自身是会触发事件，但是移动到其子元素身上不会触发事件</span>Ele<span class="token punctuation">.</span><span class="token function-variable function">onmouseenter</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onmouseenter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>鼠标离开事件</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 鼠标移动到自身时候会触发事件，同时移动到其子元素身上也会触发事件</span>Ele<span class="token punctuation">.</span><span class="token function-variable function">onmouseout</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onmouseout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 鼠标移动到自身是会触发事件，但是移动到其子元素身上不会触发事件</span>Ele<span class="token punctuation">.</span><span class="token function-variable function">onmouseleave</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onmouseleave"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="键盘事件">键盘事件</h3><ul><li><code>keydown</code>：当用户按下键盘上的任意键时触发，而且如果按住按住不放的话，会重复触发此事件。</li><li><code>keypress</code>：当用户按下键盘上的字符键时触发（就是说用户按了一个能在屏幕上输出字符的按键keypress事件才会触发），而且如果按住不放的，会重复触发此事件（按下Esc键也会触发这个事件）。</li><li><code>keyup</code>：当用户释放键盘上的键时触发。</li></ul><h3 id="表单事件">表单事件</h3><ul><li><code>submit</code>：表单提交</li><li><code>reset</code>：表单重置</li><li><code>change</code>：值发生改变</li><li><code>blur</code>：离焦（不会冒泡）</li><li><code>focus</code>：聚焦（不会冒泡）</li></ul><h3 id="window">window</h3><p><code>window</code>事件指的是浏览器窗口本身而不是窗口内的文档对象。</p><ul><li><code>onload</code>：当文档和资源加载完成后调用</li><li><code>unload</code>：当用户离开当前文档转而其他文档时调用</li><li><code>resize</code>：浏览器窗口改变</li></ul><h3 id="其他事件">其他事件</h3><ul><li><p><code>beforeunload</code>：关闭浏览器窗口之前触发的事件</p></li><li><p><code>DOMContentLoaded</code>：文档对象加载完成之后就触发的事件，无需等待样式、图片等资源</p></li><li><p><code>readystatechange</code>：document有 readyState 属性来描述document 的 loading状态，readyState 的改变会触发 readystatechange事件</p><ul><li><p><code>document.readyState === 'complete'</code>页面已加载完毕</p></li><li><p><code>document.readyState === 'loading'</code>页面正在加载</p></li></ul></li><li><p><code>pageShow</code> 和<code>pagehide</code>：每次用户浏览关闭页面时触发</p></li></ul>]]></content>
    
    
    <summary type="html">易混 &amp; 易忘的 API 们</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="JS" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/JS/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>一些@&lt;svg width=&quot;32&quot; height=&quot;32&quot; viewBox=&quot;0 0 24 29&quot; style=&quot;vertical-align:bottom&quot;&gt;&lt;path fill=&quot;currentColor&quot; d=&quot;M19.877 1.468L24 2.534v18.942l-4.123 1.056V1.468zM6.53 10.898l4.115 1.064v8.978L6.53 22.003V10.896zM0 2.572l4.115 1.064v16.736L0 21.428V2.572zm17.455 5.62V19.3l-4.122-1.064V9.257l4.122-1.064z&quot;/&gt;&lt;/svg&gt;的东西</title>
    <link href="https://blog.liukairui.me/article/%E4%B8%80%E4%BA%9BByteD%E7%9A%84%E4%B8%9C%E8%A5%BF/"/>
    <id>https://blog.liukairui.me/article/%E4%B8%80%E4%BA%9BByteD%E7%9A%84%E4%B8%9C%E8%A5%BF/</id>
    <published>2023-01-17T16:00:01.000Z</published>
    <updated>2023-01-17T16:00:01.000Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="抱歉, 这个密码看着不太对, 请再试试." data-whm="抱歉, 这个文章不能被校验, 不过您还是能看看解密后的内容.">  <script id="hbeData" type="hbeData" data-hmacdigest="11f8d5f51b1f47ca30d91e4dbfd7df90f2a35ae2a730d05d3ff53dff65265051">34e85ffb0b6d2d12b6c2e177fdc7251e7292bae7e81645cf9a3bcb831b55e8cc88bdb9fee83aaedf03f728c5eae46c29a9c8995b7a2cce5ac17cad16f25e8ba844b4de052198c04f952f42f020fac630225c4be6b68123b5e693ff50e8ff3adbbf11fb5ac5d7e44a46b0b472269efaac6b8afa19c5b49b58b79050b28bfabb03149f3ba01cfecee10ed700e0f52254a86a076ae19414fa0989d8af440ffc64f6efa0386ed2fe946b29ab837e4d9a04bc2499de75859052c482712069f314d64fcf5680672f88fb399cd6e4fd07cc77a0ad582f2009072772d139adbc30779ae6107a628d608ad8c19e8b600051082833e85ed80b2875f7b0c445e2d434cdc50c9f88ad4f6aa7985853a4e458476868c2017a0eb7874eab63f155c5cfb15b1df504fc98ce58a13c6890f014a67f7e6d33dc7bcbc0e171336ccc3b9af6ca575be42539d9deca428c7348d3dcd11c766f875f4847d8c78f6f1dc397e3fb4926f263b25c97dde09a6b13308a2e532f76b16796acee809ba8332f91f72b200e1074b55826ba65139411b92f49187cef659fb3c9789fb92561f88eaa1d213811eebe5ca2c3e215602c89222e2660571344df6f641f970d4a8743f1d0949f379633b61c194209406d1e473153a8e7bf25072dc9a39ee3a4e2b82d7842d64fa9d51da924518f2a62eef55ce67e6ec3e7e1d0e0d1b07bf741d37f5ea801725f41d636363e7cb97d9aff1a1f8a5dc136eca16bed234e4f97ec578a2ed61b2adf9355b933941386184b1edae360bb3782b65f0c2078e0e4f95091b9fdbfb013f5c01a632c7259644329c141c49a2ada531a53ed77902e58d61e4e116dda68187e19d3fe77021aacebff0e5a12485869d11fbe4c8eab05773caee89a4a131f2401a1dc47dffa803d95ed7726b3b95ce8e99ff0137163cd7e884a3166c0d22312105cf058ba0afd2660d6b748516455d3474bdba1a954ee1d3648fafd465985114682a0a83aaa797e57e745457872afd8692492d43845cbd5a53770d4043eb1f3e316200caae7f9cd9239a9a03c1ca278796ac16cbeb98f62d760020ed0b513d849ff703f8ed10f6160fa5143a12fe73ab0b1b72f9b763f1f51b3da4874204e3a1073506ea90a36060ca43f90393c6bcfc4c650373f1b46b0484680b4817a988d04ab7a46408631503379ac24335abe0c42ecb7cda1f4e7320324df9f2322f60f41976d0149fdca862297b529dd3c5ea47551f0a7f8f9f8495a95e333fa4a5ecfbc6119361683f366e33ab01d39b690912021f37714e0643945d8ae7f671a33bd0015baa65b55a7d953df71599314cb4856f8e57f875df99390e655ee7f6ee5b5a0ba26911d582af1cab15ec09a7f28007ff88b4eb34b87fd9a44f3e0bb6d0ce79be8b4a05501ba472edc3d69cbfc1266641fbef4dfadcc6764aa3dc5145639b5ac8685831e9ac8fc76ddefaadf8abea9f8bc3ebebd188944f9ed7e56d2a327f09ad0d19946039dc12c2ebb7d7fd14f6f427a51fec6f2ef6635e928b6782d25c4e28a22c638a5087b13e8cb80ee22e19168855205e4406efeaf3392bfffab869369122027a755f53e17a818761affc64817728a1c928df7a46cf05c6799706823ef45096bd3f7fa0af23aae792d865001826a1777257b61868746017aee403bc347d20e334913791a5ce421e28a36c723eba838c7666de359468584bdeb42de699e4661ab45897f5cc2cd8d10ea7f04b292d3059d326ccd83a5bacd017bf1438ad3f3e97752a77baa8bbbbb8e875d2f1fc7749604f8f428da885a166fda20d9d85d469bf31b50adf7d5cf3a933d7de9044999cf782c9dc854b92303606be40b8d4c1d0c517c4cb3881218a5cfbd9e22c182a8da966be425de6f08f2e5412bcca3e066a58badf55667ee7f9a5e20d037e46a1261f9cd72d79da4678bacc5e42351ccc1874670a6340995ddc840091ccecd97511b8fac0fc098b66a14ef25e9271a656572cad8bbcc4ef5d0c9835dc39c1cc5825e959e647c4cc9b8064a948270de7920c1ef8992a54c48419c00e1af120d686e73be4ca55a26cc123f4bdfd2a1eef685a9965bc8a407d8c57fd417d681ab2959b6be414ef9455fff9bf20d35791dc147de1da61cff11e85a7c6fa52b750b551397c41677955e1db96462b126bc204571b0beb7d2fc2b7ffc328df3a861740d550a4a17dd28af26c0bd46f7ee06bce7de40dac47d6a24c7409b3a7fe0d62669a3d7dcd1544aecc3f4637415ce593826610b92c804cd8dc42099e591aa35c2b96b913510ea6cec1b0685a647a13d8adc5b7868705110bf99394ca97ec299a34c925feb7307a92730354692821c584b860f1e965cadb03048967902621fd0b9e15232bdfb399248b155434a3e4e4e2017e4b55c9ed4b7d28074220a1d02e4be49562c212e6fb142573ea7e7525975193aaa6b4be8b48cd7d2e43f7fcd42fdfdb323555469b2ead5e453de4486008ac9ba0c6aa6ed878c4b6f8ecb6399b8ac6648d87f3c279f714c79fed98bbebb3d8d0c775eccdc71f859ab953c9fce02095ae49329c6933933a515984f5e766dfb2e9bf1ad69b50653ec267b016fe87c9e24aeafb9fa7628c3d59ad1ce4d6f7b95f6dc05cf1eba8bd093d3fdbc45adfc94d4949689c362e85ff3dc5b9911cd2d98affa13e171cca1ad7d363538c6d6fa0e009489bc62366e2a8f81690223a4ef5f044c9eb63ab7ea1e628d65ce45f8531d2b1abcc1622d7f048552e26941e4859c1139b68b67da2f28933dec154cefcd3bdf44e10bda9a8e238527ed5e074e3b73b5348cb024102d9bd30c5169e817744bec8640a865812a48c526a1152ef544a8912759635c891936f0b31311568414d60e46f6eda35f86b64dd738cb24d1ca7086e55ebd22c87bf985eda9bb5b5b33f0fc69fa351e52637dc0480bf3c6bf27d1c0d261b25e3723a67dd21f8d71239a59679ada2cf65f241809689fd3e9d955774bbc5284fba672b2195629fba0f629a07efbffbe96f9a61b31d47cb774ab27d8216a7118ba9424119b94ea117f8e7ea9cdde994fc2e1be36351e2c7edce4718a208e1c3629601405e38c16a45b379bef76b6f454df4bb9c7a9a1bfdacdc5dccdc6a72c7381ba23f28625450eb2422f53788afcd2727722963a481c1ef9dcf3f7a0537089c2f8182609ed9b7ab444937478e4f1defc9bcc403d69fdc5d217eca8c0633fb9909823e52523c424a723c47f045828e3b9ff7ea801f741119392c07ee5ef337bd14085bba6034068987f88212598d4e0792a5ce026f1e6f84a576bd3e026ebb354b217ae1cb8a9f351f6eeb80232aa9b75251f82c5b966ac2262ae968a625ae41321fcaa39ac1aee339e0bdb12619a43cddb7607e87d241470b2e7bc6608c814e0acf9c4bfd10f197ae05e1705ee34b167a938e0548b8ec4e09ecbf9e73191533faa7c9dcd4d41db4f4faa1cfbf4fa963ad17cf14b408c0fa196115a18128b2cd85e863062160e81e862ce0c6bbeafc4333451435d50f77aa083deced7a7f789241df9f1372fee04a8f7106af889a08571f0d000764a45b6c311f29e2f162e655723df65638ca6c957ed1292f85e3f20fb4cd568b575aaee9b33c0db461fb81113f9173fb090b33274a512166c4fd04f4a9c9e76589a902728d13c47f093968c3efd7c3d78efa12ec5eea6f1040fed58f6b2e3a4c53c719552f7e7d8acd9f26d9740108d36b8e35cb224a3e5055c871c3cfd7604bf775bf9a491e1543b9f9f8871692eb305e8abc91965d6f48da981d6484734bf2895e1d1af07188183d4afcc230891eb7498be3d27386a7f78b181b973e09ef12287aa74d0d4600ba780f8b592519375b518927563f2daa8baaced99d99483f640c1f9c560991c25266964eee3ad4cbad75c3cb57754c6922a73ec50fc021dcc0751ac586318eadc22b784f2829865544596cdd25ca5d1bc74700bd01afe2dbeba09ae2db5fe7be4adeef1752964bf34cbbc2c13b78b8b28942c254c3f67db99dbb5a0f486c95c309261c5ee3dddda4deb2f2f53a4d0e9ec791772d2dfdb269987d55c9427b0dbed9635225b4783e0e8ff8c47e5dd0611d40cf20c80ed5488452e8637a1e34d34d8404c23e7104f11a6c675d74af8f2ab450ff8e9e857b5f3cc2570e282f038303f69a1830b83c9359bb7ac0977c0c30b038843bc860771bdab255295c52536c0599f95ea8240b40c074107494b50fc33c19871e74a7ef5403da23998c28340f457421c69983af6a899992dae2a592cc81a6a7294db9fa38d569aeaf9bd387b21219ed478dcb105605c2ad1a3013c41bfd89fbc851660e56aecd7df190138160bbd982f09e6338a8771eca4564412bb3027470164b1d8c9bc0f986fd1a47721eeb8dfef8a185aee0899890ec5e3930caf0cf9bc14d9e18e6cd02a74159be363e3d4af30d9e1b63857a0d8c7de9a461167e46393c569c46361191d4f98ea87719948a67b43b7f11412cafe8707cfebabc273522789e8027f759ae532b7b4cabf688782b12f9911837aac64915c439c58cede08cef5cc6edb6d4c03d2b90745cd15ae0840779872b7e1a792b335d605379d9ce3b15484d2402751c1d0bf640dc93d174fe2c1b307132648b06c8b898fa9c121843ec8c80b29395fd012fef42c86b746974d5c70d14dedebfc23c46ec1d842b4890e876134a35520fec99fb520a39f02938b4f7bdc55c11d81a161e59fe0aaa9db176b5edd1d2e9c3c704e0d65fe33259622d277648424f15962ebea9466c85bec2e96fb15b61701896b4de540e170c495a50b183741e0a484e65a79d1ec9df0db49fc61d72d5baf65eab408c6a4448a0bad9cb118ff1ec7067c17df2986d98105df8d6b1f4ddd793abc497dfb3f1ce6890b38a3212c0d15f041d2ebba373c787eaf27939b7a6db5b17088fff5219acc2eaf18263e4d3c339e675bb2b659aa034543c2d0280d33d4e531660c29e9d32432947449db0cb279efbfbf8f7b105d2cc45fd7b1698d004fdeb96eee892206f4714dfa811f6ebe7b80b3b8524a018cf5442bf48f6ee8be0da5a7270a898dba47a6a9a114df563af51fea63bc47cfd81603de72b0e96dca380b050fe110d27f9365485f9a2ba644f19fe3226b523bfbf5fef83bddcdbe0651edb595e365401475dd6f449fbbe10750de35e52bb8c4008e9dc77ec688eb45ef9e1d41b9746b4b65adbb1eec1f2d864a36b5c45518d1ee9ab5821cd83ca18301c24f7f70c3851315328c8bb3910da7033a6da720bbec9f12cc8c0a07a652ab7b1662b534082640b9d46e69fd6bdfcefa67b6a8982a55c12abeef4d6a5861ec191c0ad9c1b607bfa14f95224205f637f28b1faea9e539496501386fa2912a9984d3199e250735a14af5f1e21f23d8658cc424b049f49cc23d39d42bfcfd2e1b2541a748063e3fe2a397a8327e4b65adec0848f0537d1047159cbb7ae6ea23316438fb1266020e4a3401bb0f295218a9e3b7cc377fe050b150dcfeac9f16d03b7cb05305c9f65015d8457e85494f6cbd660fcc10943e867e760410dd6b38d3d024b73cf091335fc616101ca4437b90c68d15b1cf6f47a302e8cf626a94ba7d1daa3a248b59ac0bc53528d4bcedec67149356bfd045802cc3aab3d217dbe4a1c9311bfb2f6fc612814ce5b27d9dc78b72fa339aefc7aae42d01c78cefb7a83c469916cfea5ab38e6ab920a92a3a655c601d75e20faa11891ef5d8adc35f4163f73d727d0e2775d061a08b2b5b30f726ef9a2341d9bfd193000f1936b12792104d653bd485aca0a0194e58ff23307ba3e4384335d7399623e1bf2a98b6a8b8d93867d8bd91bd4ad223e65656056417a7cf21622cad826513ba8707f74ff69fec98aa6621d168a722c16e4089f18b3212bbe1d318eb0984254ac34db8c30a446524f3751e3a86adc4af7121e19f6e50db00135114b536af2957aa0fc1be939a72cdeb251a6dd9d2060092f9f6b87fc5f8c0e0a40caa716b281200db70490583ac3f8839b77ed8284e9dd74269ac2c28e60c10a6f24d258dbf120e5a56fa4ef0b0b6e0373a31aaed8a9d45785eff02060538ed25590fd2dd482f5e3f7dee21ac57c83f9ec95ef25cef2d54d7fbb00dbddc7cefcc059a8aa5460a0f5a4ecc055fb390f4b288651ea3717585bee68f4cdaa24e034f87a7f347c57dbb1136c5df821058546f5d22363b13540d183555943b70fa1b052f8771d552e5742510f032aed06aaf85ac328b7b22e42b54269c38867dc9b956c338c233b5ddc96aba24a1b9fdbb4012073a94cb7eb543474b409d132c416afc43eac08790577455b362467cac0841ed7fb1b2236ac351b72ec8897669c138a4ab1f24aaa65da1270feb82ed5212590443b38880f58245e65e3e0f7a84e4e2565b18712bba162531656f167708f2a62dcb8773324d3a09048174d63a344dd03a58d5a2158f0d7f79ed052abc83e1c851d00dd18b215615853e6c2910cfbe9d0815555387fcf7994d55f73877fcecef80dd98e2580e2878e9219d107d1cd9cc60717fa87aa69a22ddffa4130f96d0508af2b7d01752dcbf57bb014f7e21d0aba53cdd988aae32ce5b2838849d8098cbf42dd5ac862d89a3b0d4499228d6ccb9a337507824ff63ff15a834fb110cede6905b57bfc4755b4327a72c372b54c72d84f948ab36aec3ad5f8d008f9dba4519ccf2624266f5e9b7cf163f8cf0a53e2fdeaf8de8020859a3445ff90aa4c52c5ecd64a9252f9bcee95239fe970564d8d21564deb98eedcdc9aa8ce4d821e3bfc730028388920d6ed1deb231d8a3745d0bd6a22a2ba75587558a0aaed139766146c0355add46cddca139ce1e247595614db2d17df42dca5e5caba9049ccbcd98bbb3ac0fc4107a907a1db85b9aa800e5ba6f9323529d78286095c22deda89e4b229ddd0facc9addabe93793797c36c7f80a50904e61e5e11c0a45241179d095a7a0dd1ded8a384ec39067b872f46399355abcce02b01506fd66f161b350059a07f08e391d4d01cae9d8b7674f811623b712e655325f43d1f4df98bc14eda255de4ebdab48dee57bfb8ff10aae7baf4933e3b244d724cc5daacdb7418c9dc44bc6c7fae7e7ba93f8e70fee6c8d47a718a8f314aaea69632a7e33eb6d6a2dcfd14325a05d04904c2861fe6f41fd78142feb3d2583a760903a9df9f9404d95bceb259477d1506e7ac02fbab134e391d69dd8f478aac9a76cfc4fb9bdcaf8c0f38d964d3d99d01c8b2d3cff73bc4098d7ce03c3e56aedce0a5900574842d5241c36de11c1deb09e8410a894ddc4a158db726fae362eca9917a09dab87c21834be828491fdc3ff40d6fa05101803c75ebff09676114c8702da2455bd33e223b5b16e7aa296b486922c719fca64115b1f52bcb114852b4adce19eeb1eb8d856b70b034fe6f477789ec3d2a0d8032aaedfc157471a4c40b4ff442f40beecc0653b5ed6800b8b607c77a5453242a9ab7fb420a7b2663b62e93713165dbc446f29d386693b6e9f3b5ff030113aa7add44b975707e9336a2ad3a36dea3f28843bb25c8f994f643362fc7497e51d70346a0d993f7728b290c5851656cf451e2a4ecdb81e8f9ef2ede4c79003875453057cdf43c4d3ec43a7536e71770b7ac7554263750544fc0ffdc1d1a16c5865bc8a2a15dc5207a438d4a59d7e8a0e44a89941f5e998a07d626ee8d3d30aa8f731469b65c71d5f1f27a02cc2ece7cf89d3296490ec09027ee7e6f1e4065f1406a531bf723968bf4879d16821e4a2090eb9eda86516142c2e1f0e41c2712e7ed2bc4e6aef83cb83825a96129407d6eef271b2714151697f1d178495b847a933a3b92f478f5106232d232ebb0f186204ff323ce97a40e81a6500d31018b25ec671eb4600d15ffd7f6c87b123b2f6c9d3c8ceb029714fb18dda08d8e5b73e895f0c51db6e2475a99ce08e2285620a6fdf5a6fff83e12aa95cb68ba5807ce04f2f4dbf8507702020991645c9b07db86de7de8e599c285cb1fa6cf73daf52fb58045a6fc65c849d802ce2a287edc6ed905d7d57e643976d47034f266783b3b25c9c71be9fd70da56f608b251c4e87aa25667bb824b844d9fdbec822e57fd23a30311cace6c9b890b135c4c63c14e5c82e1751773626e87743bb8f7e8e04bd6cb09194ac4594b50d0ea143f67e82d90c69235336b48934de274d86655c0bac44b115df91fcdcc8ae50632b3581ba7d00f7b471e198448d87b69608305faac66b542e1f561d44f4494f37fde571ee88485897f5c17c9fb1cbbd427953a22276ec05c21ca23f102c7ae92b0a66d2ce23332c302833f39f4fdca035038838f766b9d1d662e974f9b94f28b65ae9f9cb13ccad2052c59addaa7e4a79ee64ddc30c3515727272d78152f85f26615169e33b7eb15a1f5bd47af95addf104eebd9c9b56ddb0f6eb0670f6b824167859ea8844633ad454f74ffae78656c8f54e7adc0ebedc35ffe643e3a9b8da02a5b0a6eb2809e7f320633a82924075410e5139e6426252cdfbe6501b163925a3fbc7690168990f6764076b1c067402859e66bf738048c18b9be49e03802de954bdc3f01bd59e892a719b30cd1468bce549ac31f1ecda8b1900421c94e7566a5ef8de2a098a74abe1fe6dd01a75ed387808bd535ac3216f04e974d56caba5dcdfe52202a11dbaa146c1c22867195ffa5d900c1d2b3b7d05fe1caf0cf8b3dca1df737f01c5e5c52c838811d54fa9109c74322263e05ca3b1d393122f26f2ea0aa8b9e86cc96e2f487ef2f8cb51067b88ae5978ff751b91509d13b2740f94b9cf481325581854723d85444ee38cac9561687264c91b7feab9944dfc2752d1dfb634835d06cf778817dc34f52be2fb45969393381a8a646495acbec22c688cf9338f8e5a0647a115ac61070c9a50d09f76cc53a014d476e22866fe75659b34a7013931cd87200db8424bbfb85bec3fbd35c47dcd1921c5f944227a9480202d312fac5e3d88b1db32526d07d33d6ed9599ea6f1ad1987c3a161efd5353f62fadd9f06473f0252e4e0c2b6f104d0b75eb44f6ca33346796c1d12cd8a87c7836afc46793bb8492a7d56c37a4196cd3e7413c8298a21f9282a9bb63ec865c72ee6caffe85bf60c915752c3bec398182175da5acf6f47cf6cb316d09ffbfffa11f5ba8e30846ef57531d27e22821dd9d39a8ba54decc96552210ea6e4d73bb443d9fb33d515209983645d5810aa50ac3e1bf51cb4c823c9d07460fd4f70b8d5126931cb452f4b54a180a7c50cfefcf7ae3f36cfbf19570d9f3fa6846a867f7397712a967f44ab3c33b83d3f14abc00d56ebca786045c50e43e4cf567a55b43dbc105f8ff4bccc2299e5299ed51026419914f51c2c4d374980dcb248f9c64cb82e16f5048d74303f4c8f538496b29f850ab08f1784d52e3fb7aa9f315e00f1226943e4accfb4d9bb0119a6016fe41522121397b9803850421545e74a8e53d10b3c3b91ec362a72578b72d3be6eea12de36c0ecdee837690f4a1cd16f02b31c4a34deddac88ba95386e677edc995d7462a3e21689f6961976d06765b88d8cf67595794b7c2dc84dc49f6c2f612ecb7f75ccfd1d1b817a529e2191a06b4aa485ea13a79e9c830e4c1a09e14f1497f1b868d51b917950f69468c7cd6a17947211dd706813c7c5e4dd495b2705e39c2f93b03e6c7ce2c1a629c1d098f92b338df44f91be5e46ffd77fb0b2816cc443fd243fd79580d31788bb70a801fac8fd01ed1c49636297e5ee65dc74b5e8cab3f0e6f284c0a867c0e8469b12514570e6c0e36165266406bf4359a4e03b4c871c3a8508b2f3c5f91905178cf74825f174488040def81fb015170fc2031f54c5a7a2a68b6f5d3617f7885bcd304d533f3e69c936c1ab6ec4fce0cbbefa195d422af21e1855ec266f7abddb3a9c8d4e119475a1a4eb15f958bfdad28bbb187ec0549084bf4ab15d06bb168020411bc8935224a8dee4c9daf2085d28a5e8bda8e155d7fe8d5d3c0dc4b237e794ece436389d8ad0976e8875ad0eea4a0c7dd0d9344002b65f006cb94780f730b9779aa935a6b2d90b64b09fc70c0fcee104b69e64c7c1974952d33aacf4b8e4da8dccba7f0ffeddff7d0f2f00a16e73715ac6c0d36d6740b64d9fb5d5831441c606ddff2b20d38b93650eabc45dda26117c32f36c44d81be27908f1734e240a3cab62455728463bdc0af1951049742d68753c69bb96b6f1377aa716d5d9cf37a125afe474c864a71134158cd72fdd8dbed61e43a5af045369adf4b052bdc990cec1dd6487eb83464bd687e2881b0db27bba997fd51a25e294cd52a6e2df2b31bd275026e78487124a1280e89e7e32a9f23e0a07ac6184d23922a87c9e2ec24cba68d9700a601d776013af3a78b4789e11a07ee4738fa224f773b86ab2d90b7872ca459269bfbccaa729561cf8139dd12874d1166f13918cd4d37c991863b0538fb7196c30c496ae0430fbb9852c4bb63173e466e66eadc8b07a0435466f708af47806abab73f62721c64f5f8c8af4e8d7af951b52d98a64420062a554bb55a7be6dfb36488681afe088815ed41954c2e0e0b512e3b2fd3e6459ffb9bdd1889311e6515e9670295b7eb87dd4e3d11fb4412e6f8887ac760dbb425ef4987aff3dafe40133dd9e212ac7ccaf4c5d2670ee9360f47d45c1788a53731ffe5b7332689549ae401538a60498dcc0bebb50f1e32c13eb1dfb30b27051571aaf07ae8172902d575ef2dbd821f3f6d55f08124da00697ad1e27a54441aa57bf35f9926118340f6d01155e206251b181b69a6f7d6b844c3016c4d36d0bf1f91a9e4cb01a92ed2d7a42b9f2db83dc2374d21c564b5a3f957a5b6c0da500f245cb54736a4e82f726cab8682673e3ef370a587ee322531ea9c418d4d926d9acfc0993a45a78ee22a797611abe438707d77f95f08869cee9f6eb1da37cb3bc7e4ff58529b84cb1bbc5a211fdba97d1017c87b43564f0978491792344acc97dd22c512ef982ffe2cb17876602dfcb3273ca5104db58c462ccd03ff72d74dc4d9eb598916c224cfcce42d4c68a4b718cc8c6a2c81885971fb6201dbe12f3f562aadd92a95ff06a36d5b33dcae4fe1444d3b672f5c2a50660bc770174ba0647d41f6416f78f3dce104352c068f082bc90d2dbe44666019b219452a67c55cba91fe22407a4980b91be739cbbe2ec72828a78b09545efc82e43910d14930bff7e0f1f0a8a2d5bf6d063102911bfb3bac0e92c3d8971f93fea13ae572b9c04e7c1a01a06bfea1ed7236f3ca682af67a7e2b4927f5324567aa582042c2b9e4e7a61f940855919231315ce5f3e7deecbf37a52042a6ec5938825a4e412aec2f2f95a5eeac9caf6c0ddce90f587634689feec52a469bd03b8fa24b1a4276b5c862c9f8d0b6f978025285dfeb3e03f29999fdfe965379f46d3139639d2b68fa7ea06c1ed218c632792f684d685ab74742908a4b314b7335389308e927181f6d5b1db44c5cefad69b208bca439be3272b402642c7b48053b92b4ef4022ca5f6cf9525b06f4c0a4bb46a30ebd38b2ce280d6216a3861067518b3953f49e07ff9934fbc02c70971cb259d94edf50d8773ee31f63424151bcf5159d257308e87e110c419f2a4bcd0e7e74e23bd4dd3b4833ef97b3e1db348ca87941cfc8ed5538c9bf576d19756e7591758048012b314ac151a34933529c08c1e2618881511c138da2e3b8861565cc102b50205e5f2f9d4384277c3bd9397ace6ed13577ddb6609c1e698c315692e93c99b931fb40136628d0f009daac34b64ea8b0406ea3af1b1c100f15d4cc5523bbcace42a00c9f2babde4bcf4283feaf6eaa21799b00f55744429876b3deea70064beae43d8328a2236d80c84081eb79bd6c4e48d428b6f1d54d4b5f26701667c116a70cb314e8df9441a42381d952bde70eb53d54bf06246826fdb97faa54f0511565209f47c7fd4dfc3f8af4e18dbc0437abb757ccefe65bbc685a700fe3c527a982c54185714f1c8735f18785dd939996f23e2c2bfe7dba44814c6e4e3e70d3b28a3c63e14fa1b25f39c139a5e58f69dd9a740a0db6aca52c3d2e27094323faa39b33d508023100eab1aed4d97be3c605e730d771d2579131bf0106cab557013b78868d60b9a9f1d304bd87a3f42eb5b320e41857915a8008c38f4ec692dbfa7ae60798bc913b08717536f0904fdd0995018dfaddcba89a4b0b8b5b5751da9affa1ab3d7f320ee837d96dffe60aaf2c863f9b68e348c74f135bb9ef09d130cdbabde9134c14a4fd146e94386195e4beaec0a288a02c9e7f4fd6c78a1ed8a7f5534d295029025c1baff8ac70704396a556ea8dd4faed619369b19e66ec3fdd3a6dfb0888a1eb78a9f334fe178f9bdd3a1a39fc0ba8c1079b0a81dd1fc8c3b5ec2fb269e83e562f6e68aaf8df527e7a43b0e2a1538e3956c300ff5879fd0c1931b0ad9ede83d5544679836552eab8d4298afafbe3944705b3e27bb308a1e2dc1164e99a3400cc0e89a3d91f0237f908587388157c0798c0564fcba765111e0c6db45bb5fa11e8f0b8fd3885193cea902d9ff9fd215c277f69dfdb49aa8dcab59bf5bf1ff260ee468dc4c4591c75746f397b24b35dfe765f68f33af1546e1629899eb1ad92e38c5c714b1cf76a3271d06f54e3a4ed8a725f9c780a34fd8f87cec841b0f781425258fa6379d511217c75262e5145a3b29f29661b4fd35af9724b04fb62b63e87023759534a2111b15fa5687ed8eea07eb74a1cd86c48fcd10212e1e1ff3812d2b83cbb429a04bc860164ef4195c662fcde868ff2299e87c7adba8238fb3324f35303334b1fc5ec5ad9e274fb2c091f6a821765699a48b19b4f1f60cfb6b64d4d02ca8c7cc90148f978708bc53f06d48838354b8da7616346fc1a41257e0f54b424bd0ce1692451e8e091f9008bc48470aeb1f7ce3fe1b44042fb74816395b3a19eb5c3e09436346915a72318b3d9a94d6ba07e04969f2ddc2c60900b80b9b84a612a0aae777e19815a428402bb9cc94ccdb92d6e9622c82d7677718be036140209a35816fcb5c93894f9cf2fc4493a28bed585c74eacdb8ceebe22b29648bc854bc8b6d52abb320bdf295ddbd91ba9fdc314da01fd07d9b9a05f66fec9d82f9ed6b4973ad3b2b510aa2287b8a3a6f37a52f4bd572bf4d0fe946ea91946b2ce61ef596ef17263c0c2e18faf06fe88e1ecb4b1b4f06f0412a3e90f5e5cf852882166e11d44185def804bc8520e31f5bc6222a42e12af744dc0e83f0409c1aa0e61d6f1f1b36140dc441c477e168046161f8b850751eed00e6a8a525b814858eaeccd5ac2dd4d69e9ababfd1941f5847bfc5269468404edb887a56ac55d25a6f15aa3f0c7e381f3bb1e2b5ff21647c842ab5f197905b8c9ea4a49eefd51e07fb3758c23c0d79805f41781299dd0ff6c8ad93b3042a990ebcec83e8bb4b23ddcf412dfd9c4c656c8e4704845d475d459cf404f997753d4729aab0a20b98999b1d052d2c32b11b8d6a73bed147a4b06202908cba84ed283d410ea5554013e818197f98c0de7acb54cbf3279b4dfff8d67021a7344862c296a19dc0e264b71ab184352dd8ad1d14f1c83e4128d35ec5e58e5239917f3b29429c6b6d7e10cf2826e3aecd1a569b2f11c2a3af159ea6e9da3a4a41289bedde64e271fe81cbc30c743dfa85455b39c885b8389c2ae0aa9ba57eb97e03eb99b4356fbc814ca4e06a2f25f69c5b22b4482e8c07d6cbc8c4d6d6fb7da33c892e698ec19c9db462f1b04ed8c49f10a755a65c054b8126aa583c5601a068695ad47153c63f2a816127cceef7335902fc9bbdcf730131513e1cdb8ca36b49ea54c6d619a16a343f9169c04a20654caf2d46dacd12b4d9528b961acd99ee9b90d46e07a3c51ad909376236b72d7a7d62028186c03343a706b927f18556062541d01186cb28c8c40e286cfb5473054d6ef0badebc1b8f8a4bf1648963dcd01a7ef85dce415086a217fba54dff08a1020f42b14c838e7c48d8b932381f387a8f9403b534b5b9d3b548c8f45450884eb7785846129c551f37afbf4378a73e4134dbdd81038fd79e897858435de968b7235223adc786caded6426d0ca3610daa839b7562e6e89e7f81ea58498673c74e6850ec4a8e00b4dc03c17f439a357188bdee70c53756b633871ff2f86c0775267bc3362633c679b922adbb4fa624c1098141822e14a8b1ce1729b0cb6939fe6a0a943ed1b50dae5116afdd87cec0e6ce6260beb3357a4b0098eb7a3b0c119d015c80c4838d40d91173fbcad524bf9242ef0f43e47b1bd2c9820191618400abe85ef2972084c02810fedc1ef823f706cc4bfd059888f0e76c6aec3ef4f732baf3c3ba1c10391f68c125851fa606d466943d0f6c95edce247a0f555efe8dcef255067fff1b3b613310694842227ac3e5d461b96a92e5d3c193d00b690416928a485fb8228a0ae0d6ad328b5692a40e7fa1db4d84d941d2876bf2923016922090a5aac4710845ae19bf76c550d18cc1b9d9ceab8abc27f8abaccec8dd251bb725548b07ec636b23fd0702cb4fe6cc694be2684002f4c9eb83ef094ea6f55b4fa6e1254815f240a900f805054b8530764c5a410a60ffd9ade2a0f76ea9ba22053ff81879aa1a5328150b01287e1d445df669ee0cb91518de59309f5994e4afeeab84e449f6a13a36897cfc8a824293cc3e5bd074d1c23a5da4fd8a44f4ef554a7bd3908964a283337044b51f99cc744ab2f05bc61fd9bbe6d2d6b65ef4b844daa1c7a2e67099b0977c62e879d05f81b9aa3928e89a6db525edc3b1df328b1ee5d687a0a838a0077d82853a29be8c0e50123e9ff7324db724cd4fa1081df11cf820d0f3aea494f44fb2194b6375bc09993b077bf9bf6094fd029284898501775519b3691979886876bd2c61326f2d81a81d2abeb36e5843875fa7b1181857df208f044802b7ccab9569784b07fb705659d4aaee8e9ac59490cc873c0770ff492a1d53c2853737818d63ea611c8e9a3603594883cb32b1922782d59636255bcb720c5a623dcdcc4c0bff2c2f057ec32ac6491153ce5c87ccafc20a5da860cb56be77364668c566d4a76fb8bdbaa74ef029b0a29ba43771397a4b42e3729d2023b765a65e1e411e5dc019c600d7eb6a20127837d9ad822382f559bff41936e4af79bb392c9159598b886cf51780dcfb5287411ed585e12008422c5e48cfc2640e62a4a31b3381764bc48488f6071a5c005be4e3f472b396b9b765cab7e582681f221520b5928c2d3a4498ca8cc2d1a6e5d590cf7d9ef5f341970cd97766c64fc075731b5573406edc91854d2bab20fd8b326e589dc6f0cdaafbb30dc3b65086b3a56eb6820357b3668c2d7a5648c3c7d25a87a97cd79581663dbd2398df03914c31768e98a01201613c5b49472cf1c95899913745db30ab3558f22dcd479f886feefd720b90caca313dffb80a97fd9597b4de1f15824ff15ef5a393df39316be81b85c39d0458c1f54201e3963ef0478e4f67dfd8ebea3350183d469e8a4e91ca585d157dcf811beab141823a7df51317f0d3b89a7c4b2a91015e576f45498200f489d4d919f6471c9149494a7f001b90854056d8771b5afaabc5f1b5ccef6fd3eb2815ead26927102298c9dbc284e26e646435faeb2bfbd43174f421a01b96c0e2e6e56da63c170acc43cb438eb3ee3cdaaeb4d636372bc855332ed853c9eb47c86aa2bc62efa2bdae74fa19703f0a43cb847cae00d036e733358d0c7bb6463fb30d9b64c965557aa541b572e175934ba5d5235476dd267d8249b18e9bb609343d384d9dc4dfb5ed77aff062b392da68933637760c5eff542fea747e59619bfb4d5edcc03d51478d2078f5410bdfb8f411e3def4876b54a6ab1dc63c6925afae2d3c0e30d0ffd10bf111bbec345a6c24a1b0b13ad0b18ad3844904c5b18b68bfd4439a2dbfdc585c3c53d7a7aa22419922b45923ed483cdaa0df447269e404999a7e8edea9e469c2cdc533bb3a359057c60f754222a9c31f3c0943470d63f3789a2d188f7b0b110691a50118e57ac7694d58bf40c825ea7da97c2c12125db6766cf4421cf1d1487818724cb10e70d7315078bc479ca3240acaa208940e437ace1117749a64de8684a7a29b136b8ae71decf06cc18dc03367e7037330464a7fac2db472166fe23dfb41aa8e060bbe892ef9bdfc1a0ce94e58fb3306ca3fad257459a153835b60d88032d514dc14143fda7113436007065cdbcc42349204365886a7a87d89fa5b5af604c75fcbf470ebca40dad9a657011b6a54e61d5ea891992f34c39535a18ccefb4c7ecf838995abfd99a0dd22c6dd4ba74ee5a85df797faa566583781f8cfae1d28d982f902b9a1c43f9f6f03cb37187b60ff4fd1e0dae1b38b21ecb52e81f3493ea41349362d5566f3b613c627833f176dda161d6cc2569cf0a3562d9b347411fc00d4bd0e2f842b607e8cc7bc022bac783fbe50ea2dbcab31a5173ff3683d54348112e0fc3bbc0eae300d873f5111f34c37117b4816f76aaceef4efcab70d74367b7552dac0ded0ca9b73d72dae0d6d3138c2e0a5c4e0dfe5ff10a67d241c3920deb8749dd555abb31a2c55c571ddd98dbb51ef9e350850d2880debc19a70bc4c777687f3ff2c23979cb9fee8421e6662f37847eeb4d71864b82ddb0fd7b2e308f49b21dcc5b6f976e2b0676b11ea5682dd4bcb87d4718f56adac50e2dc8c53826738253d6cefa6209a69a190f7e0e7cc31e590dd1b004f7aed34ddd5a5bc214f1eccf350abf8302688aa57071d20aa66751b5d1bc5435efaad121903583755f14e6642d9087ce28009ba7beacd2ff8d6d7f50fb6ab237b3754b314ca32db3b224fffce5f10ed4e54312d73bc35aad0574b66e71b37ac34a5127ce3500b4ab76a20ee1befabb3668c179818c48697778be97e0e80883a02d025437cb04e2c5a681d952fdd04ec44de56d2ea6f6ffc4090ed534f93e73e85a2766f51a49b18f60a0ca5086b763f15cb270223d92c5215802e1f8252817805cab11891275252de05b6dfbfe7620c8174dfa578aa47ebb21148ca9610ee95899b384587ae6b49957eb36ff0a1ffc7fc3db6c3f6382ec54b7f29da78cbd0e77469e642320aac32f8b8435510272b930f80db11646a8d1ba909efc9f6f97e171373b76c9edcc62395b74e8550be0350d947a1955f9346fb453fbe0fb4ed84a497b72af656d73320d91852612624851e5160a4806066a92a04aa44286978124a4ee8e5790d6ebb30a448ff784d631164e32fb00ce1a0018e91df647d3305d0cd721ae85caff1ddfdda5682f0c826120b35444c144a003becd1cd6eb7f707e904183d9729bfc4f7ffa78865775afa0cf9a766baae45e9be00096a5320e0968a25c81372e936ed7ccc0ac4c8b510a04bb8b2d5ab4e6d21df0b98996cea4c40505b6fb9958e9d95f85900f7e585e7914d362fb60d8c3971cf230d6e76671913d745affe0493adb29b4791bb0f70eb52835ecf9a68877ac9149a97675425a647e1495a057809fef272d7a28618f6f0bcd9d7778c72b1d9b7db7f927547274e0288c76260350ed1772e8786e69c2326d0bf931706f1611f6d83dae1aee2ebe62d5f09bfe7fc77bed0793e018970d0cb15a78231ce9a86fdb8c046851a117713e7331827d8f6976f901f9cae7e5a44f813d988e9c1f41f9b1aedacd3327c7bbfc7c15bff0ba2a3c8f6cffbf112a92e1b443f7eb87da972e1ebc2e2d1ad1a11c6d60fbffa6d7410b8cb3ce642b72b1a010649f7dbf16c1f2d274e22dad801eb4a593288dbdc3e6af0ff2a62e685ee72cdd21dad569c04c2b5a762a0a85e3a8f216edd0c24db8ab9fa6968b22046488c2470dacedc27c237a67726a2d9d7376d9f9c844cba1f2febe78727cad061248dabaa4623f3f8591306a4ca3d2fc878e50ece05e72b18527d007f62188edee33a6c4807c95527e644e19997a1c42198a805ff411025bdc87e1c4d28e79d81fecc365bfe88f4026ea4c193b4dabda6c75da0b9c7e9544f0f655815b0930f4386b96aab872c0728692cbc9434b758d28611f0a906b68e137284d4b8b417c14957fbe2ca14c7f5899325ce68188c9d0e5686f1dd3043b2330959b90378abefececac8153e1daad4b8c4ed4c8105dcbaeaee700729d401acaab0ad92ef76cd6210054ed556cbc6dc558092685630e1b8f1c45e02b6ccdf30eed74f84b0a2a981b9778fdd65cb67827a44120e58d2a11dedf1b9cf5c4d9cf91e362d9e5ae6165c2957acd952af2c37cb897accf56eb0847e986c8c154e60ecfe6890d3ab2dcc0d11f4174477dedaf8e4409283abba3cc5b88dece133e5ce32a8cdf6b9846e5217616569e5e65393a031fdb98420ffa421b91aec1622b4d3a3e1a6717527e593c0fc861d731df305423ffe6a63e139e305fd6a6a259e0694bf2c7acbe51cbcc0c32d9f369350e2206984395ff24bef6816952f8f965653244fb97002ce4974690b915497b807396023181d4292df6765949ae8de579701837ee331c2f6db77dc7bf1118b2720582b47f57d9b08e26c0034101347232ba450a482a7efe01129dbb32a7096c0c801483fcedb71388bdaf306742dd0fb0f61a74093d654e15dc16b0cc955545b27877e1c5e29c600b96b20347a225c010b3a1289879c6f960592bbcf7eee3ed1508b7a6340af1478705bfff3dab2c5ffa2e1e6d0cc9e57b53c17545e55b2d6d9514bed5629d004a4f8f97f65c3df577f142d927e71fd4af71b7a789de71eca7b03f6d006aac2b4bca359e2b72631ec05c10bb904f5f91b8669d0fdadc670ed7d0357970d5a080225d3d4ba819c3be1a85b84eb9722620b99489445f44c2ede2b1f9b3dfbddb3ce6d681040eb4b0b915b0d18943cdee38580c8257540c125768fd295643d2d9d5428863f4fb95df9cde93f8e34630575394c770213ae32376519b59370a739e913624d4a9675e710293514491e38cd880055fe1c4d41d6b6beca8b7c42324a73059e54ccaf3f2e022a63553ca89dfcbc3ba218537373cc8ac4ed70f5055bfdc4515db51222ed6c4b5b0715624d269de54348a0f9a8e7c2c2027e01314c56d28a00408bd2761859ca1d0ace67c5fb88c76177829c531bbe39ba9fae8af01e8e5581d436857d0f9bb591d842055ace083d237a7ea397c0737157f3b2a6c27d6b0db35390df1e6934a6ee2456ec3cf95820a8f8a2dae4e47ae8572a42800185545a64f58ea15a33336c35986cbd99a4b6dc5d47664d43fccb72f5bf3788de70f1572140e245a806bedbb95dac24f0a2ed96c114ee4f004d4b96e16d9b2a9f1c24c9f5b3e3d756c253c7a0c12344ebb6147270f4b25e38610e500b6f85faf8785b655a68a8db40d4426978d23ff9890807d2825796343c36334c4a94f343ef87d056585ba1b52a5ce8886e596aeb969391278027ec4e61f33707a195e64f91379a68fa9fbb21195951e8c026323203a217aa0ec55bb9cf9d6a63dff8191c5d1bed100f129f90c78366a85969a1e1bbe9921721d4579e5b4046ed4e1421b6460a6cf01cd14808a1bf08ae80315e5499e02999c3bfd52f9d4fe64c63deda749f04217eed30b801124c5d0b300b6b500959ee169cc19ce238bcbb34d995a1510f062672ab0660dcba4bd7868cbe691fd4d155f1b11693f0cbce88cbbb2dd65061eaf050fbbf9a3660381df67175c8b7d678f04b797318b241701c23a39642e3188bbb917875de44b1e351af45be1e2849463f1093af905b32b9ee369d6990722e7863af8bc626b8b5b691368358ee0e92ca31ebd0fd4647354ab55480797162e2582f7d1543e4d9247959841b3067b7836fd4861985b5835e66d32601863b12c9fda61e4f0bf43e521c9507cd63fdb9eb26e5304ebbf93ff3d1218c1e37836fac0d66f97b0845945355e453a8514cf8389cfa604e842957d17a60b9988c9b03e874217b690ec51a4d0d731d7766cd42e2deb2908d84f9f75df914a966f41aa6b297320b895951d47ea36d1ec58fba30b84a92f76fbed0a8ef8fba4d211d8ffc4dc76d19f0e95e5a62c44ff41b4ac9246f91b1004b7ce5925c483e21bc53b7f396f4e112f91ec0d1ecf87c11644dbec16a6633142e8571d2e28a3cd4dac0305bf858a9e69efabfaf24bddd2a7c50cb23fe6c85b7029ec5ae251a77909d2946d1e57abfb61e9ad91f9c1cf6827b91027dd45bcf168fc3e386db8c9798a3bda8487b20c5993607ca1db184f65629bade5ed2eb4a712a065b9e3789da03ee30f1571a961a53d6a09cc71bc0e40d24e079cb39c70f1f1677f5c329636eb49e7a896463c39b0481610aef9bf8541f0ac8beb08cac8258a54a3eaaf1d10dc1c4b4044b3b69e361ed3424e9112672398587183f2e6c89eb0d671c44e4e4c8a2090897a5e77257c0af2a9a30ae88967b8b925b3f8f6af739bfc02d9810183608b54727789816e4cf16a0c060f385db42f3d372363afa3aed2befa1a1c1b26eddd05dd2826277a27e94339320f6ba73106ee0beb5ed4db529ae609bb275f829d9a2c628ffabd02d14ee8c3b8b3860ef712a68f53a068cf1d824e137efe204c0a563e5b71cfff332df646453dbb8b78d52efdb21ea3debc7c8babbb80e71d8956dbf474400717c2dc0cc9059d649efce56957915eb14f200703964602be6c8b17fa3482ad5db19ca377a2af76d9da7aed7090beac70c144e9392c3c8e3e16d924232e6e7d044b4db8170871587a755c56aebf7783a780c0f1562988f78b973992a540cc787fc97d5b0069b536d3001dc5353e93b00a0eae3ed0b0d8563eb6efd89d479e88d136a7034ab98d79366552ea9a64a586f878d025ecd6e071b2ae5e9d892ff7d98810388faa02d2a2947b892917c1f7f25c5f2627f0170179f1c8679c5626c29583bdfc4786dfd020e12c25a973b7cdf808e1feeccbe2c3377d29372d575f3768ad4886e5059f3391b2e0f17eaa36028e1a76bf1444228984f0caada6f401e75565497c62728b4e12899f8072732143c44f8ce2eed558c4497ea2670aecc9d2ae3b3fe6e5dbe6437fe706f329a796ca2d8ebbf2d1998cef34b756c8580aebb0a879526a60b4139c70d574cb1076698b3ebe55d75d47e4db7d7f058eae14b37728d5ef494048fe703e7d8481af6a194526b0ba061d09befc828c6cf171580837be1adf4ba3cac56404de0c832ebd57ff25a0c38b82809d6283989e537fa99b6a104aafb8189a601ed086931dd2f0ce0e76f653f931ffdf983d12642b59272bb11b3f4050e70668fa5c775d011f528ba65b462db0f57b3d28abbb962effb45fc34d6191d9c50984bd56e383c0693ede216a7ee1968b672b4efdc6ebcb2096827525714979b76f191a1a5dada4f68085420947cc3c7faca57f88bdd8b11bdd58b7c4a6a390a47fd617ecfdb2d5a8913d21b1b4d2cbf73b74647bf8d3a9d27a72027d6c90b100fcf2055db29a3b8459cc6220e4d00ba6f0d10dff701c19b455a2e93ed9b4f11d93490c15b0ecd7c5d322f7c35bcb372a9efcb333fbe5044b15855cfc0eedfcfee732723945bebfe0ced0cf52bdf6f81dfcf34a491948609a02e4afc58385401c24a508010bdbeb9a2eac54c59f9c33786ef297bf83cb66453ae09ca41c94df2b97751c3223e11c762f848ef486c13baf7efaf8db4bbcdf9cfc879db2590b84e2ec06d5c4d2736c141cc332a14457f578b3ac4918034aa719598b54b6d6c9d6c0d55e381118a71dbd4c6b0528c88b8837b0d0a2d0f5893631fc13338d25623bcb9bbac5cdb6d3f2bf415ea4868058857b2c891a3b3692ea767dc0f3df99e822a9cb138d542321096f27c97746f0097d7870436166d4a38471b5bfcd2f74f5c75d211c7328871231eb0e7f230392ab0c9d7186430b7eb462febd7f7fcfc2fa5511e678f8a35e54943c990b27608ee776f35bbc044650d8e5a74b5b43e353324ab0b8d06252d63fe74689cbd4eda75c8eef061d5b53085158c564aca3836cea2d737eca0631ea06453b834067cfce38253358a751f102ad7b444c58ec3916f569a7ae8ff15b75c2a80851b91fa18eac0af7197da586f1506dd3bcff43fbf2a9f97d8f9bd62affb535bfbf80539a34511be864d806cb0a6f649fcd0c040b6df6abd6f8e4cdd8d75c4b278e242b53f603c8aa024f79e394e8d0e66e8876276a80c2183e652c6e81e930a4497bda8678df1231daaa63dc148326f1401ab981958f5333522016c1f536d85089a749e0a486c9db026519cdf0ff6aa54dc4d0099398a2197d7108e2c394704452981c17c9c50ae161ace3ddf3e536648699d463c312914e2a203887b0cd57fa9bb7d56ed93057b413f06863690b730e98ba18abf6bae31e89c57dc96611bd576d15c4a11b62f1c84109853ac09bb491baf2581ef787dd00276780d564e38190bfc15287d6237b47842abc9a43c0cbcfa19c947af0ea50a28013973f528b1724d854bb55ca4f62cfdabac0b54ad52b99463f673e1f91f959c64644f0036c8aadc9e3a1b7e9450eb751989533d3b0c80bcfad10c688e11e9ad65a1e86d847c9a19e187285e93f700f8c59736310935fb20aeaff5e4fa5cb070df4dd7a9127d86e15d23e5464854084662a069b82fb90cd5a48590f2d457c6e56b5d0c2c63c0a32f2252d8fde1ca1b1b8fff0498a9da1a01e1e9d37110cb7b082b770b2c0a57c114149479087cb5cfa71c411a1104f6a2a33631b79e9820fd3bd95e9fa74b4624da4910b04918157e8d241d87f73f5f415978e2a6d7633e15194a3d7249381c3335a4ea7b8d4df1a4433453d254c60cfd5e6b9ae4eef274a1fb6c360568446a51dea80d50de05ead57405508218cd65a51fedab55e0c6ec6c6fe8069e8d41b9a313160b9f8839223fa896b098e3818795ad459f349c30d8862cc54cf4f1a1ab9c3ce3221ac27cb16742ad94b40188c9a5fe1c8a58b8e238507e3cac2cc3a2bebafd2a540d5dba49617700eae39a9f298c3ff0d76426b2795e628fed3f03175a07fd04dfec6f266eff59361aa9f665d97a1a6c3169c6d7a32f4d0933da5b172875495f50994251c5781c065b81a53daa29a3e6ef2a8325b839b9fdcdf31408a5f50e3becc919e824666a63690eb02fe4b5511138d4eabf497a42df712507382f69db2e630f46a2d175f24eea8ee6c5491bec447956fcfbd152de5c560ade0e8afcc9ab10769ce1e6788cac0fe644ae1e2cec9365d855d7bc36c60371c02001b15040c97cd61b4838d7670d564035806178170a65f53b58623c62445b6b73c4ef45f9b9ee9bfa9facf03f79ad548894b762c09bfb845d846506ec26bc1d4437955d5554cfc84fb52fd25e7c87f6f5b5cc64a57fc72ace25f557dd7f3f09d2aca149b71072a9edbd18370dbc18357e478ed59303577a12547f855051ed07defdfe72e6aee5fb491f81086ac3a85171f5f2a0db7bc538d787c61877abff859efc96cabc14dacf3becfbb9e3e34318ea4fac160f71bb74c596fadf9d9aa7b09dd542a98ab4f565b8c4598262dbc6821d99642d0afe99c55c0fc532633ca5161974371f913a9ebf5df6e9254d3e331e81fa192115d176a0b32119162ed8bd368d66eb44ff08a6b770b2376b89b42a7dd102d79803c163d57ed812db947b51d9a427d30220c1094142365e04b509dbdec50bd369b1671e3ecbfb12417962394823928f68b14b32412dfbff89bf6eea0f6029e94347ffea36073ea58d99ea12bc6302beb16e6b5d35251408f31b7d668bf2ec34f3a76b005ad28a8aba79003995ea8e20fd94ee75f36802e7277dabd1c48234cb3c807ee5422458981c7a6a2b566596edf0eb2c4624aab25033b45d4e50a3700e10bb7ba0ab3362b579aca4a99341dfa768fbcb04bdcc0c6c5124f226519c47fed0aa7655f80082fbc68f1e541f255e9fc0be141b7e50ff8e3b77c22afb7b066b236d970abd7992e84b564b523c7ee61a0703d485c2f205bc9f70bd750ea28dc644cf40e9d2a80d88b176ba38c5986ab34f0fa3e92e27be6708ae8d7648372f2bc4d7d26ef0b01807f1ca03188ad21a9f064412d15913c408bc2427552f9bbfae3e02ed98feb32f4e1afdf95916afb248b2a45b68fb7e3ffd91cb937cf147ba4ec56408ebbfc3c6ee58b765067c38903289bfe776fb0c28a7b8d6db60d8fc7c478047efe07b6b854e280bad4e19aa59d0668747a5b5e89f1809264f72813b829954f56ce7af2d34ae0328db3b6d048694af8ec96fa465c241e159b4a2fcdcf3f053f7e5cbd9d01ea4ab429166e6cc6e96e3f5de807b3301ab0a10e755a84ed2145a17903114ff8b21aba94d05582fb828db8a9967c60996f0297b32920da3cd32c4edee8d02b3e78aa4816593afab51c3b0f7b7ba6a28e3432b8868cea77f17d0db2c55c7b7e4c0e1d60039411c2ced01d5dd912703f94d1d48f601e48b170cd712e257aed0601ecaf257d0ee884901b3b78b3a5e4142ffc065c8369774c5d359c99187b4b7f16de1c50730d89e0cf1deca24c75468ea62c1f55375fc371682d4685d090a0fd1f5e0c3f8e9cc96c8e65ce3e25e94db7a9a79bb80c59df6a8112979ad48e08efaf673e507d630e39a2331180577fd78c3c4c0a2fbc17334cc60ab28949b268cbe2d68a566858e9b4d5352284f07732db424cd6c47a28c6a43f6bebc6590581062ff9b11aea1c04a92fd68fa6913893a261388c3ab208d1e626955afef7ca6ec8e527ce53d10da4746bd94dd0b12886813d9401cd481e0d75412d112cbfbed6294ae135fffaf74ce528328d0b85aa8ec87a21d288ca5aafa5a23c318a235a11517da6bb9064d4edf831953b0596b6642525020e937d099308dfe25ecc7ec79d5cfbc153d034e50ccb820bdbc08752253f595327928c4800ad96d01f63c14d8eead47da5e74adf12b097458d02eb08bbf4fb510770ae873a4ff4d17bd4c3e10e7392f3ca32c6302058d7ae093bc1095253fc92097985b5ece85035c1389750f887f547d79e8a3de96d68ecc8d8f44df36fac4a2021df4fb8f4ad836148d81af2d0194035c0d842f560b7e8ae1c6c67a7d350f378d6ddad0fc0b650db95aa553a06451419959b6884d34bdd358a42d144be20cfd7fd389564aed0106040107cdb86d9fd771c1d82ddaa5a30e1288de74ff9692cbe159ec658fb7557cf3dc3916024fd4e4600699198685ffd5e3e4fc34e72b523ce682e2d66be27739fa73131868be9d1406b16b49678494a9ccc7eb6a2b4140dd32162493c5cd78597f1d610776a1fb6650d428f414e46ac80d468b8c4ed412cdb8b7f19797fc96b2ec8663b05f0a6b259563baf043b3256a790b17b875ceacfad430c371a87587b77c1668f2be168e5f67875dc0c51fde29acfc6f7d9992fe7c5d99a8276d8a208af70ec0d55040ee7959644d6835b3abf1cf28b350e6f0ff3e74aadb79ece4289be3cf96c51c6925b730bc787897829aa159c811e1adb1de8a872d56cac1e7c90dede0db788c70ca97938643aee3612237b13b682130d315e2ce7454285843050d2c43023ef6170c88ce2bcf897ad731138272fe5318ec8dfeb1e8d10ec8930a1b01c1b047ddae879b7ce503c2921fe9ff5842b47c4bb7304a10f891db256640fa44439b2331c4c3427d8f6cc6172f03945284cc9e1001105587e918b7a43953b9b334083f75af1154c6a68eaa8e8fbd1b2fe89eb5f79c94124b4bf5683ed3e8823b5a7bc3ff54306927e4fb7a53562339673bc27fe837852c108235fdabb8e8e81389a088f06685fb1a35512454eca6cb060d8fda6a91c4df1164751b2d498cc8f9bf796c8ea312826ac67916a5b31efa068185f696c19376609db06f2efe1934229284bd04d24310506498039f35abf099e935a2f553b7f45d5de5e15cde52abff1a7f83d035c82caec2cc3377ff3ab4ffaa4cfcb5382d0143dfdb4e2b5d3bffb012668b6fe660a4de2034cd7a62e7dff52de9b04b9fca48e72079ae6167ddb9087dd88cea5b5f50831abac83f6971cdd3310ee0e5c58a1c87013db89a3731e2c37d0722cca482b664fb45129ef0d387d65737427746a7a72de1f0ed1faf3a53840ab416757750f9dc168e57e9bd69227f7e0e548cbebb92ec06d0d8e4d2994379eb6839fdcbaace5f7a75b8cca3744fbab11561fd9c4bf94355f4c71a0e138365da6f2b8e3457145623623ebe861399fbf0516a00a41f85a222a2530d3fd65c8653f3ef97fef4d36bde3858aa58a8f9e5ea41bfc6218ad0c9a0338bb81df409c90297a651f4a958c079ab5c01ff90e163876a415d4928a44bc43ad1fbb18caf0e0b5b1d0f712adcc51cf7436848bf286e1493a81312c8f12f9893ca6c9cb0e2008c1c0b3ab1cc7474f96e4a95b038522d9b887b7efe228d0046e599df2514b4037b76f2a7590dbd2ac25b32f3314ec07ae517a64a2440eda853b97eda45db24960f03714d1df553469cb88319a55f61b4592286d033c75d9dbe67600b41d4d8940728ef86f7f999287e6ce4045bc7c65d47ee92e10ff6b2a709e4969fbf3b9088017a476d60c91a34c828e54699f66ccc972b8c15b3ecf154a51b9d828e280b9dc7583e3ce77b1a42063f5afb4ae5c04ba28ab8e13daaa4bb3c78e3024111761f0b75c0dbc427f8f841ca0fe11f98c97e9a9e57d2c3f6e04b08059bbf9c1f6f816769545db7ede00f5c081ff0cf9b7b07e651fdb07e12e4a8546a96856a425b054d48efb1dcee1455a7ab1c628a033cfef40be042e57048ff3f5375344c962a16d63666f81082e1455be95fc52201b0f6a6dd0c86bbb21c7c462bd7d738bd8a91f82580134b167bcb2e2c96408c6b581085f0f5416c923936e5d5b2fd637fa3c971300d5db7f9948597d6de1a7325211dc075dca2110a140d704f69c589af1b0c71517ede34e8a618b6f21f86159a469d8d09e3562b4fe7ed45b24516def02346902bb5c5d56d9996ba1d024a76ef98a12c3359d29d1567544aaf3f977d07f0ff9fbfb2eea1bd7cd97327145b21d5b8848fab64f44b13e0f310772dfce73bffd2faed149e5c03e47a0bdf28003485be72829e7297c8cb1b37636c851158d7a89ae2e1c756bf5db52042559e834ecefda0a9b4d41af3913b9020ddb84f95a11918462edc501e35b6970d473f8e12f9f5d803223826d0c91afc7b86b8c654020971729303ffaa763f8abdc88d887cf36ea3ec579d9989e052442352c15350d578e6362e60a84ae1a2487aba58f2db790c83c36e61de3db8260d74d94f5db152a6c7bd3d837e19d29d49f50c6207043f1d24b67a1fd3d0e8ada8d87cb41c1be04569e0d0d20752e41f7d8d1560107626d8774bcd69502af6647f81e7f9f15b2deb8cbf7a95b62e1f35a73252cd66821c85ce164638d1e6007dcd93fcd72bf311696d7d82a4ac45358f92c2b11706c0cfdedb08e551cc23a3d4ae457bbfb444fe9b91e5d5a0acbb764fbc46d9784c585175811ef76288102f5d1e5f1b4d5f74292dbca19fbbe4d5537a781f90ca9f8287c9110139b845e081bd2f24f291817bf0e843fbbdcee7da5b03841386a9902b20d7ebed569e89324ba6dff132ad8e3cad077b502b42d28e32c1149fa692bf7d9734ba610b2c04a5f98b6ea681987b23b1b3a77d9ca8a63c14f62e6fb850479a1414f8040b9128be6a2105ddf74121bbc336f7f4c7718163ae9daeda2e63e9bf03c878ab4586e58b0e3a647f70b35138921d84902c9cebd1763e91e01aebfde2885fca99c3541ecad60d261bbac3c41f8cc318d6c91b13e956b246d2d37d4343f36fa228c1d0c02c6315781fe724eca4ba4b034f5a9e71e9c78bf62bd84e27fba9a442fa0ec0047867b38dffbeccc03ff55dcb1ee879d64d6ebec1c84cc5f41056e5bf30a1cbe5ee4db7a1540dfc01b80a49db2747b76fc476262e69ec63034a6281937450873af3c8fd599e64402bfc485062c83186b6ba943c916b03409b78d083de212a72d27a59c9791354d72c53b0a5af7a100f362de6c567e01cb7f660ec940ee1fb79446fa1050672cfe731412c8f92e18523ee2807991522e2048c18a7153fd9a500712f5c981df1b44c5b243c899770c656639dcbf48dcd65268aa659b53575ba5f358d130ea33fabeb4c2af13a31c9b366dd550099496ed1a469e4c7bab3ebf8b5bde3667bce66be07843275a607f97fbbce41a9c1a7359fe33158eda7e5f0e10d5680732c006f570cb2356c0b922b61d5b609f067479138e38076049149fd3fd626e537c2f153d45d02d6f17e90c709947cc4be490168de397888970f37449574d1d703d1d0ad02691801cabf894b9b04dade0c8853f4f23d5e923580528bdcbc938bae0484888bf3e5f6be9be63195b739af11e1687c942be54a1fc92b6d6c36dc0eb43809a5f33103ad2d8acd9a81f511103d11e059ffb381e0badef773d079e2b0f6512a575bf4341866d1ed528a9b5bdd242fe7e966dff7f515b62ba2e26315309c2b4ddfe27a2d521af222ea87845871fd6d604dd8b131b86ba562af0663a998a321601cf4a1b72a738fee59ab70cfcb928ebc43cb16b388b6b4db5e552d3429e96def123dba445884982876bf13b1025d16ebf00d217b613db91be17b87e9ccece992af93dd356c5d73f70dcd958667fa44a58feecaf3d0e12aebd5cf727639f7912fd14bffe7f3c526398a463fe3c393a8123fc195b1ca7caad16579a5ecabe796ec502071b7a2dd9dd4b2c012ce33ee204a473383b99c460cec1178c681a3dc70cad42dbcac043014be14166cb4292cc44688fe63acb6c03ba3edcb7657941a987b9247e0c752b9fb3c6024ca33f8a0647c07f0be67bd2d36fd2132737e0a74ca1e6f41f21245fa4c03f022235527ad34db04cbda4340d6611e087108d4d39701059a2569f10deb635e56468b557fdc52392ffefb1e9213707a85bd9fd072c53d78a8f0ec31ea034bd92b1929aeda37768857ea68a655626a6c9c5b6a4442b3692f49674be7d51f0cfb89b7aa804b4d9398cae088beb94e597de8ffdca5068f9310d8cf9db75492b84ad88d2ed9797ea3a88c39f5bd4b6c0ee6a7e42fe1b4ec298254129e8b36878009604d2080ddd5a0dbd90b72ddb93ab16ef778d5f4125496697f0ee722455533a738bc6e22314146035058200f33661700be036762c5dfbcc78aab2b109ecd96d1303f7ab092475574ef681650aa759535e2002ea7625a0c933aeb0793609b9ef960da067f83dda26a572c003f60df6368257f1797d742dd33a91f1d6a9397f565d54db9b52fd35de34d516f09f2093bf850c5fac0c1cf2a38081475d48710168baa4610e6343afe4ab2e4dfe02f0a839ac77d07d2a05338e2134b2a0c1625b7bac4616ab3aef64f7c1b7617b83d8a13c16800fb5965fda02326566965f5dc454142d7980f85cb95435b60f78cc44ed398dc06ae20caa6f832dedc0bfb2872a28f2fe8d54cec051cc363c8d6e03aa33d94c902196568150eb0fd2bd702dfc93f4c7e2c1259f28204ac2944a3669adde4f9c676b9f5d6b066c4d4f54cd7933a4901738b04ec3a9df0e07784b304611b357bda1c6aff9171787eb48b24dd1cce504933b46ec378ec911808360e4e6f189b7949c373c8f65a27f970682ff776d7ae6e5e5070d89725a1c4ddc8897ae0d39161337396d32d0845a9bbc4a6e7ed7d673627a8473f02312afaf434697021701b9c1b8c427983fca6588fd7dc7fd886b23b1a155fe697f19ee865c803046621b0c7231b01777ac2236caaf6f42b7bc85c7c908ebf785ce85eb3b5c439648eefad1547e368e2a8a7888934e18b9209abf09b0cfa12e9ec530931d7565d0e280fb00cc53e9da8162badd735fa91e473a571f9fedd9b69245d038add1176e63a7c4d336bd5cae5a0935cd96a80c2744b3d2f553c1f97a0785003db2077591ffd5a8ad5a0396561c6ae931496e6661c2abc1c2505debf9bf6dd29fbf1735f5658257f2c5c137b19c5c6dd20a33aab1d5ba2d044dd9e91a478a603c4b789d6e6f0884ddc4c8fa834b6438b6f6063c09215f0dfee18273afbbfc0f22f28c59b11c3a16de314268fc8bbc2ed609d3f8e46973c188e120d24aeb3e2838bdd72195a1d9eb88053770b59e3020d850bf08c5af5d89fd61c97b88a19c82474c682482c1b6a371b6e025f643788f86d7a852d0136fb736dd7a6f0d7a4f96857667d07e697d8e2a4e7875707dcedfbc5706cec5aa5e08e4ff5b3405acea2879be6d56e1a2c433f61c01dd9d0188538e96a7181d4f13343ea1edb40f81023b0e4dd440f6b72337c38202b25bd97899d82f72e1cb0975812d4cf98b5cc23549a117f3a1864bd6f37c903e482b2eadff569cb6e9a12356c0fb981278fe54e6446e038fb63093710321f2af278e044bd16e1a3277ae687aab51ec0d3a66278ae18609a2bf7592382a5a70930a62d07e1b64d5657e3452b13cd91237bd9fde7bde4660322c9476838d2fcc6f30b0e439e0a3563ce17ebd1f6054d086a23eddcef1108ded0bc9df408d286f20c4fe9723fa3165dd8e7cea9cb63b0ae7735f2a4bfa11fea435034166d71c4ae936121b85ab947697421a798b0f6e1a69ad34590829a3fe67ffdb5a3accda44c1c363d6d9fdaba16bca9473e3148a8f2b74ca6bbe403bc21e96fe52ddebe88a0cf8ea87153b17c79fe88fa0c48007210e99d58d6c962c3fbe1214e0ff8d9ba0cdd275ac1d77218e2dd0e96038db59e035c2d6d9b24f330dbf8ae2c17f97b5cfdef10aa929fdb73815c5aa7935b68204b6ddf0b41880aff5ccfac9c4129848fa92614b60fb838838758f4c14b5ad3c56815ad613b678bd6c0795e0c6a6bcd5995de0d87e7fb6cd94bfc9cc3958e2b27a5b004fa3d858c3d85fa37b4a72bb5b40b5857716bbb7dbc8e0aef53ead071285528146d799f105a85a16cd159b4f8425a271d13f1a45ea144a8a0df363291f9b2307585aa7d39ccc61c143dc2709f1e588a122292859c0d3a0e28fdabfcf4979e1f6adb37cc8348aa683f7bbf811f562184ad035deb015aae6416086fa484c3f7f4b65ae6e13808ddc18dc514e29bfc15f1819a5d7e10d0dc9b86e9ffa45b4ed4de6753c3900fae8811e1041aa5c65517bfa719045d9b63c9c92de51c7ef3d306bd3ff94c62dc8c8952017923248288d1895f7fc71a665b59a66f7e89ee539a193f4d2ee5df002defe0022a52f47d785a368e61d972f17893ab0e2121228d2b7e1c024b15d209926f4366020df80636e16024d47678c2cb6f65ad66021e6630551196b8a4ca5de729ab4238616d4f3a48fb06627fe5652244c4ae3de2e98308662e92eed387cd1a91fdead60c4d9503494795c0f880819fdbc312bab102d87d2f9252c8d829d8417ab59c8c03a1f8cc2e5fe17c587158f24d978e30b151caafdfeace064b0fa74fd797f08c1754cf47acc20a968bfc8ecf84d1dfc2628e31689192697fc405e7f72115f17bcc41c2083daffe7a544b3144e8dcacecd622ae32ae0badaf7cabb52e48eb1fa950f355284d34c23f37324e951024a1fc32a21ee26f5eb7302f912436551994d919c90c13356d665f36e383fb786d912693560689f0ae2d20644405f2c3acdc6a3d840598b76507b8b9f24b3b0c9cb95fbc95e612ebc32410e7093da478c590788d9239a54c869fdb53d3a7c401f57eba6593caa26d99c3bb3c903aea7e3c5a6040aa7fb855ffa35eb2380aaf7638e0ab8354eee2509656c79d6f0d6310aee7a14c85f15f73c00346efb25115aac91e8e1ab0ae51e5975722ab70c308b30b8bad4e2df018e23669c8ca397a83fffecc33f650671297692234cadd085b548c58afecc582628400cc1437f7b7c65ad3e44b9e641f3017f39f40ad4846a5c808367a7cf08b66eb3cd7779a122b7b5747901cf301e6fc643b08c2c293a4d63bd80f61f899d8b2edcdab6b17e1b464321006f9602a6ad992ab0a11fd67b44e4030e92e527e12b3420c67a5223912d5c96320634440007a8f66538aca1d35302087b65d56a8074330509727f18df42f92870d3d91c3e81f342569e6e973626e9248da4f8c32988ffb45724a4a967adfbd7498992666f76754121211ba25a8e39a6c7a3513e5e87205fc517429fa4daeaf40f1a2cd6d16312c2a8006cd8c8f51f13d87ce2d88dfd6b1eeda9ad79bdf9705a64a4fd79a6685cce8b237d71fb977b1ea2ae199f7ab05eda8e0ec873a464a0e3edf138933d95ce5920195a1ef247c68f86cf49a62a2f0e30c931f0ed2719b5b0538fe0765b30ebd3b71681498d6abad84632e6b07e9328c39fa187b856ccfc34175cf25b669be987649265e1127fffc8c862ddd1dff4a3e3084839421f3c3dfe4b2d7fb14c8840adac7e94e729c4cc96b70510df17b14e045969567c99a54d80ebaef90008c8798b17c6dfefad857f0f4a27d1240cd9a063d0a71fb09481e8a593b2b834af9fc618b500dbe36c35a25d20d2bd6f5b27d0e717e3b245b223776e9acfb6d9e2631caa7ad32201f27385801cbc1e6818068e5649df9f37765d4e82284574caf0b51839ed5a44fec3ddcdaf0ee68bbfd291e67d222bf86c0b24df311814a0ee52efc4839234a14e1232b45856c052cd33c0543127c88032c6e93a74279941f129204c8aa3a4c544de217070452328b2c6cba29483a4bbd8366a10067439faac1377f31cb6d16cb6e51758658657d6fd09b8fae9e1476104a8bba42b121ee399f1ef09d7f8fecb60ced475dcb299a0e2dc7fc09b7c81603a14067f33d659020b75267eddbfe8027245e9c66d5c1dfd5e28f7513eb81fe98bb1b8b6e1e5bb647282896f0b879d51d5103099a8eb2f55ddfd946006bd0427c3cb1b16852bed9154ad8da37651f23cb2417809abc2d4821f50951112e1df4df6f3d8a267bc918b7653996cfcd5edbbd9be8a8c2721aa60875f414ef0dac7c8f143d889534fe720b1627ea7a1bd4debfa57950af8ad9ee24b37c78c70e9468ec226662079e34f42fb828c8c1ed341a6dde27ba2ea17a6bbe58dd306aec1e8bbff36430ea39e3b9adc44b5b27ec3713d1435110be2f32d4c90b6d0f5c25e285bf8086ed6181a157cf597ea68d4a8093781cd1b0eb55129c2f8b6d9435052f5c15a9f472fbfa128390608532cf6e2e3e6a86d5589129bf7f426799d21d255bd76f523c4f42602fcaef77205340d1edd935dc4c5a902dd495eef0e03aeecdedfb507a91c3f186c22b9c554481037fefb0d766d8251a2900bd706b866ac181998000b762dae09335fbbec7c6b2868eef7c75f2cd53540b1b11597027f5e1b7bd276e61f0ae356d46e0145514be5c769727e11a5412d06fb6a08d51920e495c7d5d521f0fcc13af69bc3773b685b0700a81b38496785cd4c3e5b6831a3f276d5696b5588896dc9e8a4b41d107f6011e2747e7de51df4801fc5b8111883067242b5c95b5b99fef83041315c9839496b277d7cc11c5dbbad32462680429e68f2456be84c7992e78db6b8a0c609252a58ebe1d00b54ef49a35b4f071461342aacefb2814368dfb99ba3f66311f28bcadd4506974204b41b1bd4637b3c962862294d9e93d524b84e6706e633bd190d4aae9e4daf3e119e2344bf0c39c12af8c18926e3385b664b085a93b2c938cdc53f130b629406d23b26aa3847469db8e10e4ed4aafa81d78fdec1524ca70d1b5d06a6ac9471054a5fffabdc5dc27a75acb8f3fc5a64d270edcfd60397f4b7818e9811a144b487d391a2fda7c101c577fa44aec1beef0e056ee5e263119419e56ac579e9d2c5997634dd55b196fdb37ab08bc0f9e8f4ad22dcf5867e1de3baaa20e03ca66e460908c23b635150230dfa54080d75d78741ace61b2df15ba3d4cb16b5ccc90140d0f2034db40a83a7f8f570b26eaa8779aa844e054f1d32e038b3bde8c0a3f2bfdf5d69fd389dc0e7e436b4c104b5546f64054806412827d88def804f9d9012b34ad3a5c584531d3b55e03585f79a602d322603d62aa125fc35d4b8ce2d00d482c0210446c6539c6a379f281e48e23a133e0552a892d84f1439a30fa12396d50d6e76b216a6224d3b10d8a28abed0fbd246b9deb4b35c7dd6ea5aed9b76a39378d04853d3f1834d7d75c7c0d4b31495434f102e0e146ecad86e3ebf21c3de8269bfa1dfa0d2dedcc939f58fe5f8438765736b2ac4ab7feaff2de754aa9048b55b79f61e5f349883167ff1d3118381b718e51cf524043c767dbd3878463c1830b57a9bc964ff073f1ef6fa343aeaf6101971d501c6e65367b28cab84411138fbb5d1cc2ef2b567a5e43ff6dbd74ea017e6c9c3acf5445187fc488f587f3dc8bb66f7953f377b4ff173ee3b5d6206f0f1a3e4e534ec329d7e73183af351d9fdc33111fc0c578dd9a65d8659f7b44d6b741c9963cc4c201a208b330bb15e3593a013c231509509237a784f6621a1eabd72cbb1be60f11b4723aad2118900bf54345ed16d229a8210b8df17880c34b4af58a7cfb2beb0132c1fd6db16b296a886cc4e6b66ea3bc06c1b3124c367ef4e037ea58eef38c944cbf2f8b108251fa8b8052cdbb9abb2625deb1f6f2df570cdc60f938fce017fe8c206cac0d44e936c9e0059bc20526b21a84fcbf68a21aaa0473cf6a85d2b6a62fd8ed5b49c636ecd2083f0190821c08397cd31a43e3c7e07a9002c5ccc3693fa31ae4077d82ab5d8a4c04561abb4aefd1fc92a43d8a3a01acd4cd90e10caa1ee2640fe66aaa2b13c8e085bc96e99abbd496d03eada1fc20386b11b1827e5e6bd798e0f94af6050a72b6c4155cfda216251d91e9b3746a22ecd9597e6452de7963fc71311f3138bb45b9adb7d7c6ab131c18d403e3f9fcbfdfd74d01a257916159bf45511b2b6cc1f9133ad8eb40665b7ccdf69d4c1217a345612f51e4b83fb802a64e0e072a1d79c0f1cfc85085814272fef0c143666a009c21dbb86e69189495e4a8ab21c6ae165a05c87db61ba11c3b15d199c33bc980d8f77dbe195843faeefda4fc8e843852899c4225400ddccb27f0f1ae43ae7759495a32f57afe4aef277d6927bd4567398b1197075a78616e839eef33c717178cb423489ceb6a3bdc48e7758ef732f1558d6a7d2b250566889aeef414862872e2e40d50fb72f88c045fe70e6526fb1403442abb47da5dbc499a5bfd15040f5cb40d9b88ca2a3fda9d60d75b1d9d5e8ace1f22f2e33ffa2939a1fc288eda49ec9a9d5634c210cc1c4fc8b56ef33436d1f5aae229599f38233c36213eab179c0671f6f624678511c1c029efd2af890e0c4dbb62ad77dd8ae8bd9bbf1d4af5a7158c579d0c42e94acbcfd8f72fecd41be4d10a8aeb373e78f3252b020793128e1346188696874cc30ffeca21e167c6db38998f0d56a987f4ebf32063c7015ef947d2b7d3c9334acc12799fe7683bebb819894739c7d0fac4115fbd0be14965251e05815d216f16c641c79c03c606e4a3c99ffa3e057e7f212575d17c67d6ed06cf606a8233b1f9941ec27f13021be0d5f19706ae045c05cca1ccb4dd01735032aca91e80f514a293fbe84e25cf3d16960d650a5741a9da4a94655bfa852742bf010368d20e16a3acccc704aaf72c0a0dcf2e4451a144ceadec8f327767d1ee9332217f5a5ee3f95e77f7d4869b7c54955db8aa90e3e9f2c7adab71d0431b61563224890a7fe424fb1dd20b1376fabe8885d163488e329c27d53472ffe6bb31b93c2837487569bf4d546a5d1eee0e04bca18a7a9f531e599fbdd923e8e97d2f20dd260d2720c95ac65561529f08e495b87d3763c02d68c0d60c8cf357dee21c408867508ef7cd1708f264feb747bc0c1743543371c22740636df3dd95ee0e9ae87e0630ede23f17225d64e4c782eeca9039fc8eb0b676fc12d5ca3424aba71827e4c9686d17b184e83bd73a3dd2234d2e19a2b95baff76a14d56aeb27c43633ec81164386cc96925d82048eb496144c9297638f606abdfdbc97ada977603607142c460b355410f44d5c227eea1343eaa17119b069acebed82d4b81ec0345bdc5249579ee60c48b2a1a0443c7a18fdb8ba4d6e482f4cdab0e2985ae60f04c5a214a0df202915be1336504d66faf28fb0fe99b6eeba4f44b729e5c734fd4226bb6d07878f0c797ec705f68190293b17611aa29198ed9117ae43109bc2fbfb5189be32077d574c9fcc892978c285f3df65111ca5cfb61a10e3f597fbfb0974881dad6fdbc4f17d20cf6991aede682f2caa2dbe5a4e7956f9c1e4e165940a4ad481dee52c40c3174594f018217b629ad86269a19456389eb8e6ced5bddfb5eda1ae0e5c90d2939b9301461c5e2e83e96f8396ed15f61d6673083bf6fd210d3c0ac5a766f5207b27e49c167603e2475055feb894b14bc8ac86ee61fce0d1b7be78643f690383c945840d029d2acedac4205b0c3aa50f75b104bd224954ef5455227b15a4287388d1b69244c850759c699cd15c6e69d356c675a54df60584a238423a780094e871f9b37a5da4b54d2b2e1614a8706b19bcd768079321e44911d5fc7dc28b8311edbe16e5c647e5b3b8f7f2b5674cf66fa79a004a6f924b01525b55cee890217829e6ce0a3831594de93e74d3f2b83e34461e984170dd269886ee56aae130ebac96f6441bf0c5ae803609e21793d0b0cd0808da2f4b6f912e57174e1678ba443b8572107db316074d6504e5533c0a141b394acb4b192734f0e609a5b8fd78b77ae8fb0f3a19b9752a3e0ed1d832c6b627ef5f6ca7608ebcbf914e02b4599fcff250b7422979a87f2d8e3af2b866aa74eb971823573206e5a81a9da71421bf17d361a072d6a4ad12bfe58d08a7e24353e395d2de38b23ae6834343d62581b346c3d26b1e1b680cbff3a184433629ea437fd0473085c829dfa43b069e33a96034af7219dfc1703f9030615b6a420da7feccbbf101c9753629c765aa7c7ead8a935aafa4ce4b9e42fc5c621a46e9da0a51ef54ebf8eb9d4c17480b9124ac1a37ab147926b59f6b339795ff5b81e57216e9c66308089900165c86cbcf745e932f0820c02b71d20bc9d9fff7839a0470bd5016394bf0db0b26b48b48123877bd19ce164a5a781edaf8b8a69e45f3040c53c8e7f16cc1553dea0955ab7535d5a08703cab183297ede8b6956f51d38266ca05d990311935c493b0667d7ed1ade10c99db3bfc028d0fd6ca58f3456b99b33d1f45ff3d68707bfe91765f7f9c5645c0c55f0753b36b332dcdbda4ec1a6e37429ddf995b252bf7c8ed7579a4eb4d2ba3eb6db57e71a2526712737ea34260538aac1d99f83fbe6c3bbbbe468b4a329ff77161c4011423154bc7b06a5414ef3da8f3c3a6b4b7fb02ff5509f9d670820f831510b5ee1342b79da2905b2b05acd29afa95cbc7a3002dfa234934ae29e2982457fe9e4fd0a6e9646667d01b6ce3bc62934341193d4ca9f1da4cd430fc02d392a0300513a7865fa12d0cd74198872125c44d7bd93c81b26f0d033c1203183ddcdbe3b3cfa06148b7d807229bb4686caf40fe397e68d129495d4dacc5af2c1f766ca5bc53cb9b803dbb170a6913110b33a877c44498ecd65a275f61c2ce59fde18b48efc8b487922cc0020dff54169afdde66409ba839ca9eb55eeb64c63dbebe8e825b74010e327aa8bc2045f04831e3997ee1c2f3c608aa7929ba8d4b9c56aa61e2e01ca6c0cfc9a11e66650373536e61fe4204e15a45c83710e5dcdf5e2ab6ec64deec90a0357d983442087df6345f12190606bb12eb6b50bc4fb8163ac5c2844ad4db999789c551d8d8dfe93e3c76e4e0c97c6d06dc0743bda0244f75ae35cff05905518a785eba1f35cb3541cb62ffc241845141eb79416adbfa6d4c6bfcd01243a4d32c8ab6e2ec27e51b8f6ee205877c3c724f92a47c4c9a7a4d6b4d62ae87bc8b0c7fbb48ccf2424a6e3e8a3ab6837f1e9127204b1d06b14625a2459e794af8267835790a7ad965d24332cfdd03cc5ba9fb222bd96ece5af73e98779fe0646ec0ca634aa60d98f3e24401b298034ad17bc6d8c323334ecc3e39b859dea0116ea6d17228446e05031e07e6a9fcc2f33101e36f20ecb2a8004f7eb30473e46a4748648322844b7b26be93a48a2533086d94b49a08b8bb0e49eb282b29a3d57c2749c9aff56a191758bc2b5ec837a86640f47b208df31601c3a8fdadc9e09975b4ef4b746105b1aaba820c33737c410402ea773d684d11696666da2c2ea4a9997a965e1af54839a311d5462c185b900a84632dae6eaf282e00adbb88c7500928d1c7ec2d5f91fbf169b5d13206d3e5b466b0dbc9c39e0ac5336bd2669b4b60d659f2f11d63eed84b473342b5f1d126f5f86e5f06b418b652a0565fe46b262abcc177f89691c93e75479ab4b155ffdd1aa6dbe085feb2598bc42247cbd43f50ee1f441bd80226b00562c87ae0bf28d14553513ade1d545e125530cbb1b76764c20723be6ec76b4a06ce08813045934ee7552796003d3d20ee211a220cd0bcd817f8aa723a4e2c34e48f8ce7c7b97bc30aad3b74943c19e7075ff7fe66f1b69ee5aca2ef5d3dc566b6ca7a12108b61e45b3ea4d75f658d82d1fc27b5cb17e25f187a0d3a3f8ca61394dfd29e0c23c71cd73e244fc39f2ed1911adfc25d378e84679cdf4c6498fdd35559e7f480ade4ecf9957750be2d5e48a1cceaa8278aef81cbee43c731e8ae7389ca657f73f0f7db8f931b261876c7ccf49cbbbb75e5ba07cecd50dcf95f67298225ac76b639cad67f3f0c409430e783106b37177e11d8be6535c0d1d6650781e28b6bf332dedb0e7d096e13a133ea4261acc04b2c22d5b87834cf6cb47b90af514c145880d4709ea1cc5baf808ba6c8e07dc453f97e4ad778550ded487be2a8bd7a8c8497c07f444d11d8b9400dd3a05fa3f024ec12dbf705ead863a365226ec406b367fd0825139961a8ed84ac59fb9030bc3bd47b815dd51df0e51a7056eae09afcd15d8ca41fc5f2191abd9eb726493f647e8277eccafc91ce1b8d87cdc8be14748a4b6f305ba8df4bfd99aeed2bb4248f72ef38627e4706de288086f6c8db0c875d3e9e7bd9225cd197e2883e638bc6fdbdbff9eb802f2f02c5e6772b61c78009f66f18d73c9a43f52b511ce2468805d8177f406c3164a217436f2a33af7463c501a8809c976643ef3d3a67c5a6f584cd6c70bad747e0e374f0cc8a340dad3cd5d07d4c3cd16a8812630619ad956e8fc141082ac8953083ab977349641b22b000cc9188f07021806820e7b842220eb6d71b1a5cac1ddf0c94c6f17910a545d60b4785f73ed69c2043efe9968ba642c140e1a8350561262ba934d7472093c5283b46645960e6e67b69949178426bab529b393d52c37e2b5957f991a40a1b6072a6b71f9b4f7ac7e437c983ec601b9396fd8ade351b3e21f3bf9b2124d6b58ff1a97b860b0f7c4f27f6e03c0b6f38e4981bc4d4aaf2e856a30109a88c4462e92ac7a49286f6a14aabba69dcb31f2ce5f20661f75a5fe5431078d66c80598f2556c9f562e675569e7ccacab53e25a75b3fbfeb6fcd2e5b560aac07ee6f473c0d5a696703a47f817e6066759e940046e855195f639a57dd06fb838c9622d5fc7d96a2d925a9d49ba99e3877c1f3780fe379fcb9701b1781d705fdfd9a510cfa566bd5f0f572e81022f117b80c82cd07b9cb46b1db54343e8defa4e7aae09c0d8b40a15d601670707bd13379a504f5f00481ad9ccaf59dbbc7828544dc290652ae3cd4eac151810424b1f2ac502f06c65e65279b3f90281aa71e77b3affcba717feca1bfa263afb7dee6e88ad99374c1d33092c7677931080424e141a0bca06675749822947a1871b99902b81ffe6c0d7a47a191a5f1878a15f8c623fac55605f3193388649d16dc029e6b8a9cc12b3a065c7faef65ae639525f8a378935db2bc15ac6c5a2c061878a9d9be69656b92623174ae9c5078dddaaeae1890e3156abe5bd79dd10ec5bd9fa5597d471ee897cdddf86eca8774fefc4e229c99e311c4a8142179e4066f334c69f81c9f15ac32fe2324f6cf8301914cb70cb8db4a1bf045cd61a39343ed5b64bbc5cfc47cdbe8df642ca39082fae7ab6774aaed71101866f8a21929fd77de26ad1c51a690245133038924f1d0a0ccdb1a54035b5159cec1e57683db365362b978fd2d3e16fdc8e2a3eeb0561ad110853f5b6606c672368925e61f5577af128439f81b7fb7b7f2cbae2e33c05f0b124eba73c57f7cf1d9e54869f41e2bb5ed12e8a4ee7238ec99b0c367e3a20f417dc81524a37dc15523586b369e1be674f1cc33b9c52c38dd721fe722033773c408686b4e9e5ec80a49f90622267fec1f2e08568272c8736b7d066106e8922e7275af4708e007bf039db20e7e460f7fb340b2efb480e8bd508bf2eeb2421581d67b5768d2196ac0e9db6905f4bd9b694bf2b5364f215012cddf9975227b2526bd60fdc6f4563e04b0575bbf7b299d825736ed91cfe84a3e6fdd13d4bf2e213ab9d9d983b96d3b38f31618f1f6c6d25a0388dd734d0e4b3881f238d5f9db32fd8f84d6439b873b1986a91f756d119f46721de99e655f9632fddecd716e04f55d0aa92fd05e9e9a80ed29eaf13d2ff93254f95be99802e9c6bfee392171eb725c73d6de0c36656d3c7c3c2d4a784baec4680d8ab74f4ddf53d2db7a22f36d7101d068e984dc93c17c9a2b5baecc857e339e0f372d3bddc698692ee43b285c7d74db7c394fff0c9b595dcc8e84b89c49ce3361181e3236c6a9b09e1d1cd8be62a84a89cce76378166eb7efe2444791b11b4eb0bbe03f9e36148a7231064d8b5e5e37a97e78ea2f2d89d49a27c01910d2dd70ad2518eeb9b5ac6629c99668229d693bd0b931306c789e06fb28262cd17f69834100bce1a300038364d3c926550318e816cb1362a1506a0a834d8cefd92783507417d31db6f16c11e6cf7d67b0f8ee0d2e4097637fdbe6b984f0c7d03bfd95cd02167d1edc6f6586d3785bd84f757e88d7e5951721b324cfeeb11e347eb3d57d253fe1b2c365b9842d54a6b2b52256a268792dac78c13815dbd6514b6fa5771512cb8ff194cf270278a20bc39f4b8b2dfa7069173d0c6112b78a98208e7d9affc2e76dafa96b9ff38d58cc2d90e0bfd0e467ef3608eaf19853d359b75c6b1190a840d1512f0e662b91244e355d403e769b3c6b240b04e7b1074de5cc7af178098bccac4a598020e17cccee6473f4c3be4b383a74f3be9fe73d7f83ddec552d40ea4206dde1a4a2b3b25fd3f5cec9365f8382978f0d47e048d8302e514e333d3746e5e70ee1180a3c541d4c592de3804863d33790e85f9db715159fe9ea3cf89145e4e5e28ee9f7d384739abe14333cc491914ff252c0aa01ec0546971d3f96c54a70071429ac91d325d45f6e85fb14993eb752031ae40b7d11172c1f0809f9f26c57f61746c8cfb58a4f303ca05618ccfd46139b29e4aca8ad32321c6c2b0617a44d8d064544d24fb743ae59526f90ebb595a0bb03c734c150a0c3e95bee8fb82a9557a5a18ac7b05adb549eed92903093d98dee54bd60ee633a384844f25d837cf39fa8569ad748afc08093574a03814e9d9fffc0ff1949ec4b4dc563e5c401f4ce3d3432ce301b467acbd415801a88cd4bd9a3e95566c67c95af6191e321292b9b3a7db44cb4f6411dbc9dbb54c4517be73d189995eb2e670c0ecd823969ebde1dad60c272307a9623bf305a406e3dd5863084effa699cd240c90c39f9aac9412fe30f9c791b7db88aa0b2cf9beb1b249645195625ea5bd4b7f0f9d4b9e412d827af399483a9bd7eeed2b1eaeb1c8734a4d7fc6dab627cdcc495e7a38a648525b585f6de66787fe23fd22d6364ebed5140c4196e9cceab228f4d224735db761b7de7ca9a461cae95e6fd51027c0eafea04dae3c09c99ed11d1eb9102d53d364e34faa392551252f12445062a5bb6d97db56dd5e763bb2898e5b1ffa131318b0ff62c4ead4f46a1cb9953d501a6f403095453414521d563d69b9f21fbb4bf4c96012eb74a2fd3404e5626465e3efbfde141b1c188302edde56da87b262223f8eead1edd9f344e99f78494e527567882eaf2257619913dca08004efd7b7c4faba00c11961e5127f5a6c36f1db7ac576b845d6ebb4bd243696e9529296e96cb25e8472858dee5b7976cc0eadffc3173d8bbd69fdffa702261236be691ea560e774ea0fb9913fa112cb16556526e10112f5a235185baa09c8d18681207691fc3b50becf508a72e432cc65185d4481b7337f9591f58f4afa32aee227bb96b728640e362423037a13b8a57436bf5a7b6b8792c7e53fedb908b5e8e9d1ecbd9340eb9aaadd769d4ad98b3d7b358dc340253b252d98c3a4491d44a84795b2e0dbf45b07864d2e5920b47f9e3c32f9709c3120af63932fa8c7d3fb727ce5d35c7c1c2fd0de8b0b2e4498d2b9996d9f111006d6105fbf08a820a77104439186098386e5ce4271635aa951d50116664d903ea147666297fea170ef3bfd679a110191df0bd2999426a70cf09639947a92a08d23a30805739c048914d112957366398128a1438ea867b529f1c7ed323ab0984dce8fe5e6598e11adc7de4d2cb0dbff2d3c9014a8c5a9327661a6ecfd460502ca15e172ac713186a520d0c31d16457777a0a9a45da56890d3150211d7644e43a5e715bad6817e4309e6391cd235306057d0618215268253e6fbc575115362f6815792f6fc10b84ee62b59bcb90b40f0bd22816a54ae41c2d24a03777dacfb1912150ac3a8097b9058524abdbf5d20fb5accde48fc47e1436b987b2ba1428b6eb95ad349a7d580772fb242a774494ded57cc51a1df6b04f1e2ed1c2f6d12ae9f8a92670706132c86d39984d5b3f45455996afbaa4c39e8e150443e507ddc967e8f9bcbbe59b944f0d3240fed2e9c43dd3fe482527fac4fe048a9a1967f984a9e701b3ad05e0dc5804350010c20a27e3d926d0d17652bbfdb05baaacde78d77f6ba1293712a46c1bc0df6bce1504b5e834f1196eef3caf6c1a2b43b78eff1df77287608e8e2a2f8fed266146324c880050b0c6198f3dccace130c0165e22c8461fced401ddbe39da4b56be03dac5160f59c5d9c71cc6d8918552f974c37566142914dac4cdb992b639dc9a72e42743625d195e419ba614d2b40d5faa1f4ce0a3060b2bb1b70d00954735e1d6698c34eb276fa051efc12c2b6fcc8c82abec0824950dfda94333136fa362faf2d35e618b5200b0b4279ce1a5358bd6f33f668fcea6e7b0410bdfb9f67603b5e894753943be81ec75679bebdf95d7efc027acef5f45ccfd7ebde622a56734d32bba87f8db94be428965ebfc4829712a479812fac1c0cf723f738e582d0e8ef953439e38990be651a4f254947135160b57952ec9c09c9fc4a24419cc4c2dc699e445697c3f2b037670a458002bc32d7967f3a13491a05ef6b9bb78e6c051bd7c9e71deceb7fb68fbb8285d729324870b868a51d430eb8384bc8be1d57e543ad3f141757a5a447332cf70ba281b6152cc9c8857f83de00257507693eacc83e32fd8e6e7a69b5a6534d9f1ee0ff3066dbb4eb4c86b23c408318baf684c6cee272a67498b0a510c5e129e1b9b3a09f8950049476bd6de1f6cae7986add82dd76c91e9a9210bb80d6939b69643604105a03db90afa3f2f9555120ba6aad0282200550321dac6c0968634259899b8038c8802469b89e99364daf2dd786945230ad09b16b0dce6a2f7f88fdbf02837fab88faf88df57182830eb77cf682d8bb00a59816b357714195cfc5b41724d6f900ef45c666128d8f854b6a38ea5c37ca9cdaa8044e253dce4bfd67f959bce03236783752f0b7bcfc8adee1354040415ee66ba274b437dbd1e429b5f455703f5c0ad636b06680822427058640e64b69c4efbfbc85100cdedb81ebd75ed016395cf8150ba738f5a63cd0d545228ba49fb5ee3aeed995366f61fec5403c879d8ce70fbf766894d635aadda7e43c1e125f6450b2cbc70f81e3d3226bcb83ba7586bb5d6988f07056c569cdedb39c553f9b159e6dd91615c082214d7822b1ccfa618e0b8baf107ea28cbfd63ac4b664d3921b491660e2eec5b9f8fe149b631e1623e696170dd1d04bee3355a84d8ed78942c93d5c0251fa1062edbbc381d20c2845f0a26c35bdf23aa50f0a9e68d8ab607a36704785dd3b33d6dba6e5ee77f0b1991de52b5c7d7ef4b82c58702f2200701e9b597cd864ae1218424c3a0b76e6fe4c376fd927d0f1d6d845f39ae4963cb5eeb43ec555f04053c81a88027aa866421f5cf4f36f4f1476bae219a09da0a3cf0517552a3592aee67ea73224f046ec0ec11dd2303f67e3c936cbe7ebc7984de63b9e3f37fc12481b58b71205744e2e740a0d35c40d1b745273a1388f3c787a4221c32d4c7e7317d2d0920be8d20e10ee9f24e51e8a69b83165a9e5212089877b8671cf92ea009dfcaaebe14869300dc79b631a929e4bb0f5003cf202b6edb9f8853b5da0900edd88d4aecfc8a2f5a5d7008230d4fb86ff1ee97b124d901d27bea92be2a2bbdd20306e85e75420be218d19e5126edd87809a06a3fab4e5f7f569ce076c240785946772061df73e85c0d3c8945e66f88d138068b2b231590688d9859da1a4532545dde4a9e7e29c87378136e70022611aee66fd4f9613a7d457ef9899c5cc887822ea5a0c3973d9af0ebb1ce3a7fa221c5467b95dd87804458706828ff0aa954c315dbbc5c6181ba02ab03662255d606559ef105647b5e36d50c903be53be07820dcac573f555b17d23d1c9ebe3ea5156072db9a5785a46ad67b7183b4ceae10deeba4028b106cf82aeb662258d4dfb923488e8b5933b76fba6609800ce3c445a0444ab0b339ef2adc2d018800be0d3e30be663439637e2915dc288a0533a9adcfa80f8cedf9c2ba6f18d024377f273cf0c3cd6d3386b72ddcd3d2fad3f4eb8260b2420742bf02ca8d887938c4b3fa730a36e21a8d30d13ad4508d907bd17af149c7f9711d6828ea52f293c9ed8286a2a2219807fda9834d536021f5254d5a8214617c80f05012ac5baf82ddf700cdf1ad09e4e2d1ad48930c673211a2ef4b1f480b81be15a2b22101bba307a0e9fc93ec3702dc882241f8d9fe7ff543d785a539b5bd220772a2cc40c4f55e69cc4592c4995819e1434f3343916fd3f33810170273cd6ee20df23ecf7ac4e32101a8dedab8d02b9c0065bb1de5a450a90fb65e322bd9e51030435a468e540ed08f468dd674dbb66eebe1c4264e36499d4f38506493f9ba3b6135307c3061f797250dd06215148d969198c42984bd7c38982d7de7c0b278bfbf68c163274676f0a3a638cded56693309d598b623bf20a2cab40bff20dbe53c47d774c899c964d9e53a6ce0206cc71456767ab4bf325cbc825e2e550116bf6725d180dc6b79f665f0afd398c7f614044e2cf83b8e99d1c8c8c1cec6644b564b54c63940b284ad0aac4637f102aeca2ba5c63b91a0f89244753fe5c12bf1b6e82d3bafd9440f5d638d853af88cdec7a49ded042476004065282b7df115da2be6964c5283b4a5d0463c7095a32bccc81315134d93fac6d988b9941a4177785b2ac3c54c99e028295e1294d2dd44425d49bcea3c15e84141ac2a07f369337d99cd9f1b1f908f8890d457d912776848a8d4c54e99e7753f8ce80d0bd6be58d741b2553b8e12a28e6ceb06a6fd67399cda354b0dbbed3ef89fc0fd9f825c7d8a302a0c628260936ba000a2518d7657cbf8f421890b5e9fee4129489734588f9fb0276d1b0cd515ec66daa9edaec4d849351be6c6c9e2ce279052c02032e70448d8955f1515ec08bcfe7e7613ed39598fbb8dd0f61beba524a94eede2b971485011a7c274b123297faa6d9daf826ae76e527a54dbca42b9c9ba90d75f5e72504f37a8634bba932a2027ad98b26c57291ba8f4e56e132e367a19e44abb1d53b76b069644188d0cc5ce2dedfb869b4cf4c67cd52d210766df8173d954ac7916bddb37f3be9f1c7e8eb473b022d07668d1792b044b8c9497dccd6d04a2e98c63eb7a485adcc739b4e0102a0b24c36944581b9c7f6ac59e8a940e015a0aedaf1550d02a78ea75fea824dc29c9d073527c04bdae59593d012dfe77d278a6f563d563066cd744ec8cb6c100e3732c4fed503cc7b439bc6c20eadbcb5ad5ced824a8412c6009dbf5de51585faaa7174af6e1e8387aeccb6b72fe8605a35bfed596a093ca201b72bbdcb0f06047f0cf1972cddd6c751f229157d439544360c7cdec70df224c016f43163136e23b461d1e296181b675922d962d423e09f1e65c4f068b4a3a7737dd52be28a8cf1058e19bcc03e8344f8fdde4ade363d30dbb1924acccdaf49f9a011cbc8b73391e098ca2c6813a325b89a3b5aaae7223d9d67ceee0c82cc13e184ae81e46b6403fdf70b7637dc937485b501d28d1e2b0c2ca74b57b1df7c13fab5947afad05b247128c7822f263b9669ca0371ad4402533d904d630fed2d69e7c7b6956d33db5f0834770c5b8a6dfaaec5473dd86b68123c9fa83f0411e733fa9be91fe140669b792009ba75a0dfb66575c3b83c1181a256647e56d56d41a285021612274d18b8402f49c45a4aafa4f64068eb54ff02bea4e2095833814dc68650ea2a66828edf76759516d6cc1d72c21f7aaf74192a8b8662df4d1e079a00060ff725ab3efc7371347c32d51669368c47dcd8399fa77b2d9a6f50e90d398c1d3b6379f6e5210551ca9349fc22f81119f9b95ee664019e696b5dad73c3e84e7bd7b900a234a611d0d04013ea08a2cb8c3a237e1caf376c28005577fb3d29e1a402d13f2dddaf211102580f4f5647de0573bf08432d708367d405d6f4bc24fd6560c524941a77ced339db146bbf635b8e5d7cfbd1069897ccc097d46a4a408c8b7c7667aadc7b56f2e3600db47b9bfae5bfc300467dc7187d8233068fc3e013fc0b65fb5c01c9ff6339123af22eb9448aef272451fd8e51a1e28a68b87d9af76bfd7e372764bd9596e2317aa6f52a0000487676bce24072b6b3d5e9a63d86fa3b4694d46badd0c532442be98caf75b00c4fdc510da4e10617e6cbe04a19248dbfa8980635390c0d7fccb611288d26e866cecf7cd8848bb2858d9d1b978885fc7dae4db2b92805753667eb3ef9c33f8ea76ae36dabb86c5f6cf501fdb4d197cce37d4b4212e7d94fbe5e735ab2aac7f445c4638a5a397bb0de8683a0540fb2aa2dc4a5a426c6cd61804f3e88f54997fad174a5ec90dd5f7989a9b207fb73f4ef3b9a7c2b50da0f45c004023307983279c106fe6cfeccc58f4da2f2d17a4a07374ca3d6b1e4296803e14fdbe2e97047ce6013e29f68d93acddaa55e52112534e4d175825fa87bcb3a7e5c970fcbcdfe10995d60cec1cf83d714ad54a0bc456730901a2528de403152d9271c3fdb0572658d6033c9591ed0a63162417d1dfc7c4c6d26699c90d376c7698a991aa7844f46c3feb99fd36300866210fd9bf3780df8904e319424c908586cb4b7933e7319acac6753784ac2ea872e41778c7688814df5326cfee008f20bd854964b10734257bb6486074a4c49a16674f2e61d4b833d5cc39ecf228c941168539031ea66e4e6f3182055e4632bbb71ba92a896b33d14278957793d7e9a3501a86486bc317a0588a5b6c5bc7224b3c3239be388fc9002516ee6545a270dbc5096227267eafda67685ea02455e786163f6070c3929fecf94614124c39d079bd4376c2ce85c8976b7bc6c802fa99c166628c0aee9f089e9acefaa20441c4523fb9174570a5ac7d9863bdcf684b424c06a76433ddf6b0fab1bbe94f904e03d12889a470b62a38b4491d374d47b81151f98fd817fdbfe10e8a63e9adb62b17a7f251223e345bbda273356e8e58ffc683c101e7ff435257e0ad9644c23fca372b58250be03159913004d26ca350b092660081f9319deecd392455fd14fd20791e35697ab0b1bd98690b47f9346d5939728ec80d58d8764207b8e3fc4ebc5d7f70c81889b8f8c1370dd17096f22e39cad8f40c728ecf4234575305cc9d70fea2070744ed28a3e76d160533b217f9c831b80266b9e7510125e1a8046479eb4ad33a8b3bfa7e320fa4e9aa9fc4539b7f77d6c8edded34016814a8a2aaf9ce166fc40b21020b7788a371a01a7c203df16efc099cb05a61382c470f1c5fb0e64bf350d5955d93a83b17825f25db5daef9fac2e15cb2210addd6158c24973d9f73663d217b46a05aab5c658375155893e9a4ea4ae9f01006cc05d8bcbf1dc645eb5d2eb8a29a878258fe1a7263eff331211b654efd39c1e890e90084231ee413030be117fd91cd8308e7e55088a151e80ebb777211031815e6ec417eca8c7ea6c322ca1a6b37a148b90860f8a9351a2ff1b6c0a2c90d5554cc49e0972c8504e91ac73a02b762e44bdc46b06f7dc0b6458b9cffbc7cae944cc8d966f389e1f9859782566155d8b00aab30fd21dc95a2e3ffc3e3739378ad7f64436be5c9eca561c38ed15903b0ebfc58680daeefc451b42b998c7d3ab04dc403284748fb21528d5785919e490a811b944219be1e2d79439bdc04fe5eafdeb30b90c2ff8a2bfe6bf5b127f73f924b85f89a692544a51d5e96c2aada34ee941401b7cd42aa2af099499573fe064872e4bef545b8e992f3f7b3f6e880207d9c630e7753962619c2d9c24ec5a6b30e9c3b4c35d0fd33832e07c6dec0835d6a27c69834e4da0300570a15ae9302b0a347cc2bcc601483b20ed89120540c1f6b35a51cc6f7a2a688f85fe465893ad50967db832f3b48d7de677e9009ab9458a1f870d2622f923e8d8ccd95b5a1dca7250538046377ac736dff6ecc717fcac4b819c4f36073272750c8ed5164cd69955d7eaa484360d8db2574094724cc85866c6c750e469d9ba6cb3c28934bed6351f8a8d3fe17cad3a70b56f5cca195c2689636a445c12dd65f4d51952a0ac0370a073afdd5184d1442689437d982ed8bb2538f328409be497031b51dbcf1b8990ee5403ec220ffcf2dbe8a804169e4ac6f78065972665b6bde35e7af4e6e1719548a70e0904598e6f1921437181452cc1c23dc4a8dc469a964549d3d9f98453d1c2e6ab08ca428b820f92e8d799b4a051a2e759a6c5c2c38915d403c80d24438abbf62dcadb5b333ede068f01125409a4b441327fc3ad89d5a432b1921271eb531d36b9ea741ad6b5ce971739a823fe347d43b8f3ee7f2be74260c3b07d3a0cdb3226a473b5da3646bb253c4bc46383ec1611d974c2fbe93be6bde8af79aa8098e126db924a0914f14cf8f9eaaa7545c30f58edbd746c62495d1ddd6d24e94e2d15f85ae08b14db6e355e4fea9bf33a099f23f9d6d9b2b43bfbed46929c72a54704e2b6d197da4687f206e7a02402506eeceba6d55c17e80f1690f4c38ab0f91a6319cc45b88b3684a601e068a43ca15d0f6235420c4ae240e02dd4a38d74df9376d9cd7b5d9e7d2af35a3fad6f2646eb146bdf5bfcae7bc303a25ad832ad1aee563942566ed89ef960bf4c04a91c19f92c33b604dc3fc820eedb25bec8f6724c2c22ee1c7136e228a556fc5f4051de81be4372f166b372bd03f6ecf3e68fc6f16adc0e21b20ae55470e8cce0b322076ec742f2e28bca15969ad9321a474d299abdde1f030825cc8f14d5b91803bbfad69b24f79c061b5468a0ab5c34830297597b8ae60903e51528ee9578b61616e0d67d2f91f334b0c13f606ea63c45affa54d88abb380d456c95192ef85658092d526ac7cb3a278166a1203fb0301fcccf362c7e5f8185397311cb960e4d0c2c30f9d79c9970c4f7e92dd64c8f14caf5af78ac5b791665d649c5d48522ece7110a93e678925d1e3ea6ef2b87943b7b6f9c985e31ed93170c0d2d1ca982b52deb9c87fdb064760c0ff6d12617460e26acb7fbe576b66aedbf379bc6b384b7833113bcec6bea0e0eea229141b01bb8f225bfa6191f304f008c588e8ece32e12bdf4e7f3bed10691d9f099f9e97da62ae7d84c57c76010f34830999995cbb4ec83935618107b2dcb59c7621d7f0d823ed7bea8478209f9fa178711c6d209016c9a8a9e1d2c590b2509b05ed5f1110774b6805e8f977d0ab2d45d4ec10b1b7de567348e0a2063807ac657dd395a1d2fe6f6296957a27e4995cc7fecf0b7875eb594a5fd90a5ccc2cc824dca880698733bb6dbe13986a3400d355f82202b85907695021c42a41c9824444682748586b7b81062772e6d9090228c6eef820a7678e5858accd4d899dc321a2eca7257a0b9d50d4bef1aaca231e80eeab1b498fcb8b2833707a1b616f90cbb3ec4eb6a540b43c980750332131325697be5f4430e28767b14192a885a088bd1d784fa710c07832a0d57d6c2cc37c3872855569873110e7e46a46f2bd91afe0eafebf6eae0ba3f1a0678e814e10e1e3f7b28c35eaa95c47ca21bd5fa8fb76d1b1ccf58ab9920555230aae345bdee2b3c1fd3d3b30a157e6b95da40e6cbd990138a17ed0a236dcdd66c37d5a148989782dd48f411127aed830ad3f1d115c651a191251f62bf5cf4a7aca2022c2d96703bab241d2e2c5f9d613650a0b955d6a530bdff7b15477aa23922ed5beb18ee7dd6c69501e2867a6d9814adb88dfd809b55d806e0bc4895811902b619046f25cfb379146c23bea5ab6bc2abaa7ca773b97a147fad3c4ad6411c01907d386d3c7a85b4aabf2279785ffc26aa51e764437508d09ffed64aec7ac2274f5871c09bce2188893d8f8c58ff1d3c356953bf46c057314d572c7034a8d7e5ad800f3d83dc6cc62f835a7ee2ff666e6d98758e4dce36fc1bdbc2194b46ee13fbbf5834316220334083ae3811ec81b851e4d1c12d98b5a2e7e7680b14c0560acf99539be200ee31bf769b6039ce5fa2ff16a2890e2f83d1a0d6c0fb04cec3a33653bcb46e3b911812c93f826818c3b61d6cbaaf071a64ca90b61047513c7953613505daaa43edd0c2c8cff637b6ccb835aced0445fd3cf7536196cbd90cfcc677385a3cab2041a2cf9e73067f62ed6c9b2d336c95438d5cdf813f2192ef45573676c841c34012ef792f5a4a1b4574f478b44eea47d4747f66785df19116e0b68b5b1ebe8d8f1a433e4d3d706e49cb346c0af49795d579f8f3b7ed9cc03891d0088d1b3384089f9da36eb8d60dbe96ef70a6ccd9c5a45b429e00ccc1b67762ce6ab18b92aa58478181a6a278aaec1729d48aa2ba0896e6fecd91edd809d62430b1ad75034b60d2def806c58a9fce43f4d9e4cb7ac47d508ed7693ce2592b5d936eab4aa9e109ff3321af8dc90c084f88d455eca9ba10f22ceb4ae4886174dfb7cedae2a4ed52407e67651dde5d009bc57448eb3f0ca119db694f1daeccd9071a80bd2630fced3bf9cdb0011f3ee6eda64c83e95a1b5bcafb8e7186904c0c1c7073e66e5610007bc7cf93ff9daba938bc1aa84bd9cc169219af680b17d75d5a9a728540ce31bead5ccb97c21a78c9cf431942b787027f29ea03d5859c1e319b25c56603d7d3f96515a0a9e9eac4c65c9c802ee56d944a178bd94e02f59ec238a3a724091358998db0a50961fb18f8ac69c13c8a88f3e4d8b45ba707c34ea445bce15aba39981b053ac06b9189cf3d1454a5f79106a4c7c0edfcf6d6768b84eb37a859e515bef328c9a3a7e14cae3e917a74c9180dd7baf920324ffb52b237ce7f24af2c2241ee32d9683f89fe7602001aedcf91753f0d532b1eeeafaef27ebf642349462aff61f65a50c8ca413460ba304d17cb964aa669a96228615feb650a4622b4fc048ad4b9c14c6fb841f3659d208558cbacd4eb02bee016596599a67456d484a5ce581d624adccf43170774409744e8c75c5d4bdd3ece1db03c21c162a6c1192c67a30470a38205b93a8245f03edd944c530b49901eda938c3119b0e1b2847b2ddaa4000b4905cc63cf8b1bf19c0a53001ecc6fbbb361c93e343e9a852943edbb6940dabbe19bb6e8d33a9e2acce59d46152f881fd962159d0f7345ebd26d0ff7227e4a36d5f7594cabcd48ffe4761f8169ed2a11b4e228469bbd94cd0ee554b211c348fd33e79470a01c95d953bea8157ca3cf3282f07bbc7782cea44363692afa93871691ed66a61d19f70e5fa5de880fcdabd9feec87afe86fb38b3e97d3e1e07bcf6808cf87fa69cec781565a5384b34c828fe2bb8606b3001d26111780f26f8ab97f73dd81b7968242d746023d43e98a240c65a4f4ccf408a786dab6b3e48636ae9b83450d325e08160e393c2a2a480f7e4b4747752d1169bd13b0eec5731f8d1eb2020d3684e10ba0c2379dab4d8a004db88bdff38254d7bfc1ad1b0d406e1fd447206f7a8141b13cb0e03822dd0bf44d387c9d742d1a13fb81393e3ab3fbecac713bc6ae6a590f2f7ce56b8c4e55e780fb0d5475f4b42ececa9fe4defc9bb11b08fbce5923f4707aa794a69cff78447d893f1fe4ef542226f0282d616dbf3db145543da01fdb90b8323e8a2cb5badd544a0e49eb2c86d47ae1b6a747c65b5467c0bbfc373f98957b29fb72e6129d719b0b28c4bc60a61ca69a558e86c6099ad6c2755da1b532103010b329d558a16d6cde4031c60b1f63de0dd22910e7888035d048d698077842dfd658e88c6c853690a7f3bd8c6ea3c05861955505ec085ad82646d505cdcbb062a77aeb73cfffb783bd51537d8c7a7dd93071ee0d624e6ea097fef55815e96b5e3b0c000e6182286e23a4be319fe2b28de7aaf97ccc4816959a427ee8c795593afa7001fb3faa942ed9abe04924edaa4db79b40b73afd7d870f572de7b23f86794fc67117625f47187ecb83ded710be50dbc43e5ea30cb74beb418d5cbb0e92fa8ff25ee7d03b0db577805e61536ce2017f389f144f6903f34ddf58fd71a749805e890c724dcdcd639731d2ec914a1f00997f61002dc8f5d4c3ce1fc26426bf029d9116e55d023fc3925c68802bffad7bd7ff6390245e95f51c1596b7983adf1fe6b76ec9593410a044240e58f78a521f45e262137d0c1b6459232677462fd1b57de825cda6d908e49f3c5a83aaaa5ff344084a81a96e7326d71583d4fda716e4f3af5a2f68562f93bff6185cad6046ba7e8dc840834180c0510a6b634d42101baef249819849b991c125f65df0f82674b0d1b5ea71521d4b25fb0c058d0bf4d90580afa174e255427a3711f4ed1d9c1ab43fa51828e40b1ab09f4cb4b7369b294673de4fb56f683701026d4df1b546075260aec8146af3cbfee7489c81b1e7b587940f47e55d7b9a971934198363d8af7fd906bdce7f91e9805ae6ce7917c5aa0c344731c735b1a1e7a657fe9a39b4b15d5aa3a64090f2b829579ef5b0f9fee4ebb1b11a4f1f38146d2645002a7f006811550d5ccd91469436e9a79f0fda9b947cee331df6c45180aea04cc9152ec4f3c3dfe579f0015c587db9f312489039cd3e864713ed5983d0e3ab11c7ba33d263c481d575b0f6ffc0ab8149a1c7f3167b83c94f572957efd9c9fe5010b9a91791e8293ed90ae9f806faf500492322902d2b26c26c0a577189aca78caab31ef5ef3b7ffc4d7cecdd14972e6db75de2944ecd8036f9083b26aca0662a8015b904e1f82f593cdbb825006c8187962715f058ee46ee80d08a4280cb65a72a48d3ec4b01d3ce9d64aebd86462b086d2f6648dda841493efc84714bf3774c40ffc70b6ca0e948f8104a66455e3323e2fd451951c31ba01f595dd0e3c87b05545a6be7554108e736392fd83e5c2d29e7bd4724cc9607d887a4ded67417112904d0a878bcb6052bf9694867fbae55145219558886a1b0b58a9a97b27a4654455dcb0bd4a77c0268108568481bb665a8681437c0703b28221fded4d32907dc842a1393cf30cff3801588af07e600369cee3921ee2524457375a7c134d4a5d8d1226b72e2f43ee58053ee9695f9e452d95a7279d520ea9d2cbe8512cafb736ba6d9306572f7719b0591cc9090433493c41bec8f58eb30308b1482872e83125fa1f703a60c2c181f4ca335ad0048123c5b80e6f76d2543e134c4aa822c0a07b2084dfebc865e391511bc1c02e59e59c38a07b48ca7297a5d2e431c4f31499c8202dc9ecf5a52d489271689d7bfdbf699d3bae0378db623c379a703b4ac33283bf1db80cf9a81da5bcb22a67ca003d69017cae6edd4be19309716b95fc10f5da4513ff0883e1c154ed085956272f52211384db92a24f08acc4ad69228fa6f14a5168676bdf69bfbf6b66a1d2b16ed7136b2235751e91645724a01e256fc07d6c439b43c2d80f87dddebac8b72c0f8cf3dc86f3ecf46be64459838d41b83be2521f8a245b299b5cae1aee76586dc642bde3fe5453a518f639b700750efc6baae81b365a408cbd4d5381738b37c78df38733e5c592b439390542c3ef0af7f38678d24fb181b3f4b4a17f5145ab9da891a0b3eb29015ed7bb06506447f5c47af172471a92b613e07159e96cec0bc3c1bb3c48b99e497a0bca7021e329231bdf7e51f6b355888dae2ae2644d48c5ebbf489e54d4ec05ca721043348cdababbe3ce3166f292094ccfad2a07eeb1c53df942c931023384aeb9c8434e3fdc550c65e694814fb952199d6984bea377cea37162bd25c2c569d09509dc4789d0546b0f019abd00559fd9f0aadf420f7bf4c0025beabc552e674a943b0c2eaea592d40f754468b77d671d9912183ad13de952b0a87a97f395459c8f307b133efc53f0574e25123ad98f20aceda55f4b2a71c65e6cc26c2e7213006e95fd47de91a62a3e879576ca77d5e0975613c5eacccac7e302f859842efdaa0f18dc13dcd88be19e6cc819ed5d91c164cb41775e1ab208a9e0a7bc964107139d9877b4e8216821822884932ea77fc2af93f6c058660d4100ae419418a23e3889354d7ec0229fd4adb6151d96bfbcc6d8a6568c032d2315d975711dddcacdfaf00e67c3132148a32fe567d1788ad0049f3dc5972d9482366a8077fd954c915b5f3b9e9c9b7b0f011d04d085dfc50d65c063078be8a88991467f6508f212f2975b482ff3a9d132c61f7b956aa591599570f74e9bbb29b86ed4b6308cd5fe08e46dcbe5e56cbb55551cb8b8c2fc6aa314fd2db5f1a354ebc8be755dad300ef158d2c7a4434d2c98569228729346cff56c65471079419f7441b668601161567c8560c600b2155d44d2e951257ba214d1235308062172cfb6e5b95ab79ed3b5bd938c503755b597e0a5cb1f4cc1fa57b936e72706b4098c06f2db0af269737a5a8c908d5f6584cc3f0996d10f7ff9d14758f5570f900369c2eb424ad67a7333aba136ef857742abf75005b0d8e022f135c764497795254e02fe2043b4343dfdf50177108c1f489bb121de3a09002b2f190c4eb2feaf05576909b385a202924aa1c9113d9cca200d3eb3fa744c3e643393c3aac5ebc28fed5490dd6eda8152cde17159b6a104a679ecd66a92b321ebb89afd55938ee5f5e0efacb43b111413a5d246ffca19108f9a995a4ff08e79d4a41a84f044e002d36df0c24aa3d753663c701e9ecb58111d25b3309ed5785105015bf567d3c546dc4722ff9eeae0fb2605e7d154c92435bad2256c82c3f22daa798d796b9f8506974fa94416de507b3b0c6c9cdb567d7b05f4db3d5b7a6512ce3c39b3dc74a64c25948107d071ba11cb8f2e7f67d16a5d6effbd7a0612a3f1f46d883a6ebe5a771c116ddc14136328a0dfe699162a98985bd8c7fe014811278985514358959819b666b9554b8a8cc8463664829701b863e74fb90f9626515194589143e8ac5bb3ef06922b731984c3654d524d411993ec833135eec5e8dd63c0ae3fb5292ddc6e72fb850f29eb183121479621109fd91db3396a7a1bd3edd2a1757115e5bc858a0e320ff84f123ce0329494a2e2f235dfa29b81727abee7e595a33cc6e5cf181ad044ecade0bf13000e783266efb3fdf55cde8a006b788a2aaaaa9221e1ea0d61a10e1f62395c57e84e33a8454afd107d6a21850b839714e243d9e093238d8c07358b97723c41db451957034a913b43c10cb35859f6c77de5835b9ff666fa59347bccd5bd3a3c0678546230dc79aa475fa41452528b9fbd41829cedcb1dddc36ecf6bc938aec508bb8490dc2fc5c6424b101aabb06d4874e54d61294432b08851d28f25342717bb387f495ab02910b5625830a07c50b2ccf8a69c44495ded878f8199cb1d83c481593bb30998649e8e92464b94896721cc3cfd826b0115e19fe1299f9de7a0e7da5f4bf2eea9f91efc5fe392f590602dbe197bb2723b20d7e6ecdac86d54269900cb09cf0959e5c5c92760b4574bebb023819cb66a40a93b2c1b7e1104b8626a995fbc41fea96ef95cfaacff99017af6a4d50b411a25eba86a9a2e1a5a901709a5d23878d251d2b2999ed349d1ff055fd009fea4aa26c0e7782e613fb85eb4567c147fc39c3caa2a9966fa2bc552860e6d2cb07544f55314ef8f5c67cd62c70d3b4fbbfb9a8038b7f7fea1fe3e6e9b870aaae2ddd2c17fb309a690f0e1c4731d21726e0c40193e97c0baf397b55652755a26297e40cb24e8d23f9614d5f748afd405b033480195fc0525fae589c8e636adce9256c6993ff0b767989d2e5deccbc3c91bec5c6d094c8b695d801770e54e16a213c890ec40800b43be0b456f843406c0c5e8f19e2682b98f4e76cbb77ff74fe88fd9c876d64694d273c62fcb98c01f3ead65b0036b794cea70f42f6a5c7d4df9194dadc3606b8093228e3d6f43e77aaf21fa84205f0a14ef41dcc5f4e8cdb2f4e5a17876b5797b0d8aa1e1ac2ce2c077c29998bf9321ab5fbddf12b663446d4767400a18a5918c7e664792b8cd72feff61a1afb5d0fc5456b8a39d86e97f3b7cb2ad438afa6ed5bb4dfe310cfe39db6833212b4ac5167d3c7f6a7bb163b065cda33b6ed72b0e48083fdb2b6df75f566ed6fdffca55e0fcece27fe127a64063041c84573d0e570ef65c15261e2e1b5168b5a1600e1a4eddc1093c5007f1c2fb48d815844fc3ebeeef7970ec24d9b27ce9f5aedf99a81e6e41022d50105928718c102c51964f33d23d09637510583957a19467b41fbb76c6dc4dc1c15d5b634d4c206a9dcd5182c1e7e0873b80234cec73b2733404b37cb4a4f675545c06c75463dc01f050b5bdac86a6871e00b74a057fc33d8e2760442adf459ffc0c251b093a9621f175bc4d4b76e4a807db2db83da3cb3d4118bab1ef1cf478c182523509d39205b1e3c2921e5c483001ce4d6b4b0ee11f488efaa647e9800ff591720ff19554164bed4dc1944e4f263d74a8c5ccf1d7614f3a99e832a8a27e2b124f443fa217d1ac737586a40e1be58763a92a673f76f2f18b01e33ec1bc36958b02eaf27fae26985fdf938dfa4fc1ac991f52ddb23c5141c2813fe194ab63e47b1550e44c708037f618c695b9205d09a06a935090bc504470d992366a193089ba8a307ea036bfc6a01cea89a3acbad1d45915e0cd5126aac45ecd83ac67c25cc7cef040272bda4fc0d47647d2b9e423f36e1625bd8a6a4228fa1af6119c6f069ad1bbf8d5ec0e42d31543ec3f414c1870fffb38f9a5dbffa1ed07491471310ef274c8b0b272ef36149a686bcac75e14a38061062d3387c2f3193f7c6f149c7082f4e10d12df424f35564fa188c10ff4820a0ad189fbb09c5f27cc6cf239cff20d50d6ce65e846e9629cecbccd711406047110fa0a363e1263687e3b0a270fc89555c80eb61a5dfa3cc376e6fd0f678a2923111bc9691ef52f9fc594a260d7188a7c41792706f4b280324b127c976008b22d8804711b3d1b6e6b91063d84b950e5f4ad5fd5dd5109c9d0b1d404e7bd51434037c2b19cdd561bdf43512ba3dce04296313f21e361099f5e1d1839c0478322672701470217a943d9f03c155feb7835d535272d6cc05bde7d160a24134f6cc05f3046ce9ca1c765ada67dcda2c1d59d247db3292c386abc6e02799f2458ff296aedf8693ea15a7f584ad08568ab90a1f63faeed9164dfe933e61d9694a63c939f3ccd97c2ffc73b9c39ab49e6dc39f9b5db0869912051fae8c5e8731bbbde5a2ac97b19b9085c9c0f0178133ff1dc2644c59dc2eb18e25cac3b017e321115a7ad76e359bbd48dad4173e9a42a9c4edcda0bd8e4339bc5164ead1fd5b9856697269585bc10e02732177ab915350c7a580305a6b1bcde51279334dc6506e0e8b39250c8091191f02428684be0fbb5a520d845ce98b82e342b4d988d1fab43382cf05a6fe093006389dcd1863435649d640fb3b2ace92d28e610263097bb65ba36a8180c9816a5b6f1fed2f6af65e14cd0945f780074c886bceadb9de69c80905c276e39f6d64a7c2d96f3906c90615584429cd5a5f64b186e935b32c73718bdb58315db31c955a700c4998e4edb2ed344ad9858652c235fd90facff16a9d50682ed25631a3c9f0abe4c5bd7e0d0e2933c8cf0151766be4df7a9b82a0fb581bfc869ae8288a5eac488d5a25817fa2a95ce3378ec4e70a50002df7f0ed62580c0de78d377da7bd86ff0d2e68884c60245f0b604cbdbf75e105862f871d627c29eb86ade0f5fb920817d8240c1e30e2c760a101af6e88225600cb01a9c6d740f44b57cb0096dc6802f40ef468e8c854a49c69e7f4dcfc937237c83dc0f64a35e6e64471ad22570ec1666ee45ef53a71a17872df492ad71024f87add68260d7c9a4ee89aa49d78d21c9885ac91e2b23455d0eb102c1572015fd474ab5b5d91c6a1541d151638e3a814ff37d36832e56e97d7872f391d2128e9bac37c612f4af0ccf82638f3bada00841f6e6e59593aa7f7d734f04b77189139e7eb3b0e9f7696cc5bb6e040b95be3cd82020779fd4e84ec8310100cd0693ae1347affd6d24cf445be14944bd2dc3131d3a0af0d9d0cdefa2c701664fadd3e89d05840cc06b1ceb19455f4492ef255b989fae5a1742a76d94c0e4f67d47dfd0f5d07ea70ffe5cf1813354fc903f50eb5ca9601bcee16ed2db8a6e75eec5e497818817f491c93887697e7abf49883a9801a3113d7f4fce2de77e564c37c330deadb5711c22ba6064f814e5713c381d18a8b2e2507e039fe45ac3770047f63c50d77d1461c60af4494e8f598f921313ae3f9f2aaa3b356186c9bef9387c50c06861b76ad780164cb8de23848f58f326824c6951c6d0c9d8a48c6bcb65c8a933ce2954c2dae47a8cbe1346404125881ddab8d9051cf2db15d73c52d35d83015b0d3353597bd73e4e197ca98b20105cca4163a3ce77886284fab0829e9142e66521fb7cfa228fe8aede9ec3de2acf387aa8de84373153c57669a8174e03d4a3e8722e51daa380089791bc59d9b11ce5801e85b12dbe0cbafe05735e48c6cb69e5820c971f095c970ca71e37572bbfa04bbf4c06352ae9be5c364c4d11e2fdd2ee205a1327c8a4a393cd63496c5619e82c38d1edad8809a04f29e4963a88942777736f12ca295052d49fb2e6450b7e91dac4e5122975083c7d5bad4b74834dacf2c0a7eab3620460aeb48fcab292d9142a89e6f5a700cc9e9732091dec4766b9c1932b29ade972ca66df52cc07da0eb49d24e7675c2b1e28e24a1459e9760892f1d8fd16cfaad4173d117025c75ad8dbe45e0002c79f7f2b55923dbd083b6d6beb7f12ea490ecb0ab42c8bd13de9ea9243c15677845dd7709849e382d063631ddeb5e19ff94792297a177aa0b12f06de9eeb2d4bc64a2268e7bb28cf9bb5c6ef34c7990e0afaf35a8c37e5a650110aff1b5545e68261558b1484b95f484bd6b5eaa83b53e53d692f3ce52aad87b590b2fec0cb7bda8bda8880fa4c5e7598ec9ec8a0911a53848eb0e915494f6395ab5c598575dbc41bb7416d806811e9643fb21ff690dd5de5fdd25de8a9ef2d587f672f5afc0b9b57b2d505b60eb8ff689b08693df89bb2acede8a9afbb77252450361a55d7ca34ba70860aaad9339a4c16d1c8abfcb05adbc5fc7d6fd13523e88e4b44a4e4cdc784a61587fb81f0f5ea8efc95cad693dd67d66cbf09083c4b9953aeaf955657a13302da2f11cb1c5ac75b22df76abe1affe335601ad2f155b089303f02fe8a08fea0fc97e7f7600143b00bf1cfe7987f6640a69744c1855e0ce40984328bd924daeb1bb9d3d9b6025b9a37c1756780be14adb7eb745c1f0fcd06b75c9f709bcd0f290623f414a4f731b7a86cd73df4163486eeb5be4b8c77e1536dfda6bec828e2bfce3c28834feb8bc639dbe297806e5a4680cf863cd4ff52df2205220e6cb2872d0d021c6d777ecedf4beb077e7698a8dd263e661ae031ab839752256f01471c75021e53ef2df1f8e4cc6a76157915d3149e6ac1a54f568d5b2f48728d7ef4ab737bd5267153d22dee808e81abf6c1023f24d3e62074af10b0a730b0f6ef5f27c26c87355c18ec682cdd66a2b31f74e312ff65975d85ae25fabfed22903b7a3eb8f7d220e9a7300a3134ace1353aecd7d52d15dc7746402d71a6af1e03e27468476f9dfe19ab7ec50db3be30831dc9309964cc4462fbc499374a4c0327e0e823ea6f7fcf3d59372997b7ad21b9ae5d34cc7e5754a61b3dcf0d980bdae390bd8a30174041dcf20527928d794539c1039acbf2593c03c22f1070c626558f344c94f868e1002c198a29156d5450c91859dee19adb6c572b27f24c5d2df05f8efc81ade1d29151907f8b0ce62f2c1082d8ac1f6b4b2f402f80fe0cd8642720bdc861069d3082296dc9197b41ec8eff7de193fac887165200f27a3d80db7ffd0b7c38a72fcb4cc47a4db2c57b1c1c39b64bbb47cdc86992d46b027e9ec49052df51055a503725c8186b919681c26e97488ae2e6148ffea1192fbe2f4abd6eff463ad5d51979be40be1697f5a1abbc7b3a80d224566c052510c4bfd1489baad0a25210a2c8001b800a8057c04a20c18a06f90a01bda597c04fd4990602eed54380a68175f894622b9f3bccd9f99a1fae95256a275dc70631b40fa4cd143e18a9914b139934caf6158a789b7b1d532ef40e129a02b0d1b3abc85969d61a0b55046843773de1d46e5ca28a550ea61e8d6d7fa8756265cc251f860124cd739be734e0a075454f59d9b6c756a673745ec755df9a7207d9c27d8467d34be517beea8e9baa17dee35bf83122fefbdc4fea649f7d7c8f54a59b2d21b4b8a307d76eaed2544f5c122ae3a8827b140da2ba6cba979339a6a6092fa0a56193b16e1a04c955b3e3a3e71ed88f6266e536edf004cffc1ff33ed07f6fa2b5ba107221d84a5403a061629e5a744d85df930af71a62c247e71a63eb2d403734bdaf18d08daa63fd76e83b43112840bb96320655e36243d79c692b9594d127d88f5412eb8903361e059bf5a3ede577e561c1e7f88fec8dfe97f746298c6e44a7fde482b0f226c877a4631fa269f3b46de0cff5168b8fd4082862f286703d55cfec3df5d002634af661c7ef6a883f16411452961f924fefd41a652fc05565c7ae2ef140d6330e14cb7a6f6491f598e27c3cd41402ab4326ae798e139ac60d53ef68290c31376011f3601bc3484e06fdbae41dfc65698cd9d8f199a41635bf32924d0481be4fafe3b6853e929c740b4a27c3db4deb9791f69f2a6e1f5a8e2776912bae665e827b4470b3b067f868e986d86067580512b9655ea80087af9a5d47c1af62cf74fbecb43443bdbdd2cb5d5b537a0c6ecd62ffdb5df61aca1970abb37ab361cb938eeca4466a08ea86796d7b9702bbba6bbf1fd748fb66a028b0670c4743a9759b11d0ba0531f409f82835debce666a4178e26f0d82b59b400ef3963e34c74befe463813243ecaec08a98279521859b60dcbbd6c2cc3baad20629852a30c3ce6aaeed375f4a2eb215070e45bc2442662278052284b64ac1342df30ea5a7efb8921d165263e561c1d375c3ebe7da40876b8b3fc8460973ace1f61e85058c25874927fb798a8b731caaa6fae789b1c52fbfd33fcfe5a8f2ee939f3ad21db9a8f9a16e3c1f2d6d28eb1f855d05a9163175ea9a1d32fb26488de836321d91fede0ea3a6ec1955da8fe322ffb65ba044f7b843aaec73a2df5c5b198ff742a5a5e7b50d4ae9ff87edacdf8d65cff99eab8bb1e6d50892a26662da2f629a5ea7b32fdce95f6f3d3636de3c2168c2be73bf0868ce7016d2dfc7340d823f9f1b69321eab3df549bc53e6d0440c70bbfa532ac19cb2b5859a23c2af3bfd14917d47c1c15578d5bc13e1b7a5fee4bb166e6e2623785c11fc0a470ee6f2eccf0feb1275f6082519da41b11f2e6739f81c9818ef62360a0c3521e15c16f417201a06ae866e6e140dd170acb1f923e616311a480c57c0f9da711b3e177a216d33cf570ce25a017f68549c1fa0c5427535d86f62b40aa4483ff7bb9aba489e150ff8d7985642f0ae8928f5ccb09bfbd34768a4bd8da9a499fe228791c214eacc47ccc3d9fdef78ca26b5c237e57650ed2d6cfbf1e5c42abb2f90901a5b33f4cf587c6ffcc751ebcd4e077aaef30e7f452f6dc17c9705dcbd7e33ac88c707f834dc9f89d7a90e33045143750faad0688a145c3d107c33e0da2f35accbbc91b3e8bc7de588ca06a5f834824345bdacb12c9e696279f57f8ac0b2a27916b406e05515a007aafcbb9849de22db368e482f0569ab123f27aa9026d584ba184081057cde6e4236ac25bace027cbbe22812689865832c9736e6aa5bf4da058f13bf503db6a49f95ad6b1ad3f475f63f0a6619af1776ed4334fb8fa5ab793ab1c7f187c7dedd0a1d6cc41fe7c7680a29617c8d7d7f75d96bbf1f3cd6172fb0fc10b0a24e09c80d0ecba17d84004f13f83b92d00c1e55aa9450e06478dcab3e43f8ff199919e16d62cf2dc6429ce7e201ba7133d5dc1f974d4f1c8228c31b4b69c648c16f461017e79eb59db6ff1240c2c4d9124ac4974a78cb8e8f3d47ddaddab68bf8005de7137fb77643b2a4ae10aa06cd188e431705848327078c8793a50920e719f75a0f3bf7f8e40956e5ed88fa2849ca264a7fcfc5a5ff9d40f6f138809b857b03aef1ca44cbdd8c42bc138399822358a5ad05ad3d18e2c915af2f7ab9718892688f59ca5c77a112e0bbac0f68974910fd79ecb1b9ccb3185dfbccb783c68ee5831221ab5eff615fea95d954d7ea59b92d43409c42291f9c3cda163492002ddaa8fb59d164cc980ef94283a8064ea9b85a98faa8cd1c19074554bac503ee4e449ba8e547c971fdbe10ebc97b5ea85adc2abc56bcdb9a21f46a43dfa1dfe5df7ad574df8935c1c104d239366cc061e90c681315a5757a421d68e721067124856d7fc5dfdfbb202010eb4c80ff38911a14492464efe1bd800f9cdd7470bee05c5511384c21ac2a3704bc06a6aefe373245308e9c4b9386076a7e97457aa902fb3800c3b4543b1d3fa26a9e04889aa47d9bf143029738e2510ba4dfc2a4c2ebf3d8a449e9aeabdfd235f6c9db599cf3a858fb77d0d5aed2bfc3349406cad085de1ca7402791789fe4dbace4491743920347c7ff0351708637538e70af33533387a3377ccb6ddbb0e80d5bb6c442dcc994851a1025a4ecb78956d9f9dd52b57c1099f1b8de14703ad91f954be63b3f665baa0de46ca630eeacd7f1eade53770d42e740d0fc0ad5118fec50a957dd18d3eafe28869db34992db48f466f8dc250482f0afa7ce5173f1d524a336b866d9b24507731de27db7e07e263256eeddcc8e2db5bb45296fbf70e6ecd1ba76c574b4e7ab0a9bec04fbc9de08161146a1ea29d36c5345b7115320fe1fec3ec4c2e45fbd679a4719e21d2289a6287d007dbe64734ee758881b45fe5251e70faac41d6493e58a4c40f3a93a67bdc1a2b7de55ef46806cb9982f1340d5b601305efaa6561f2cc5294b119666d297dba4bf41e835386daf7258ac192f1828f917344d5692ed6f3f599e6a6f8852e4488d21cb708aa083b0177e8b1827b27f8cd5ee1f75d67dcbacdb3a814d27876c7ed2fe4435219a2ff9b87d30818261d6acebd0bda8588c9d11a0ad93bcebc9fb2283a9414fffa6bab43cdc2e3632038ebd6edf5a07143bb0699f50ed329fe8d14572523e54e59fc3a2b6b23df4e818fc62378784a8851d9d3a78410d32c8069d17edd07153ec1941244b8c420a44d3ea63848ca30efc11ea751aff6b168a7f9b82d4f1f8539c142ae76b06066cfe3747b39eb707f7a1fb56ecd247cf8723c170d1c172f56b9963d93aeb6171bc9bd2a4487ae5eb398b29d53308644285b64bf80072a30733827704e4e40841466030454b4021e3dbc48a69d799e3f543ec35d5b004e36a166dbd81a8c2ac91b71b91a0cfa1a20998326535bc317d05c79c350d6a273d8249b1fb5b0733a666e3e2ae9dfb931cde535630bc2836c5c0a7be1d4eb493b44da8709cd54e9c12c0daa297bac7b7d73ef13c023777c13c004e50377cadcfcaef67431cb3cf19ef884916911dbccb334edfdc7193548619392440daf54d5297c67140a36617a29824f35a69d7d3ca938da9b7ad625fd813a823b5165228d91fa14e0ac279a58e42a2a580a95c0d677665cc59368915d407c876039a00b112e5fe09c4869834733102858ce8d1bbdea2587dfcce15324f132ca95804497ba4204a830346dee4d68f8f77bf88bccefd48d67e6b73b6a37a40a1603b769a0976560c6279ed52a51504444677f18223ca59554b8ba5636b6d213bd994dcd63c6ddda9716b8d5673205b269925a8220b9fc45b1f3df75534a224abf4a4c552114a55743dfed048e580e440448ba63ad674e9320208f403cac330a82a6f958ba4dd24dbd5c06717720b9ac77bf04e0ce30b74884d76da601b38e0f008580c18df19523d97591cbd796c96d265a846fded45016ac86f674655db1143e4bc77f1e4cd46efe106077d6dfa017a80dfdc6d0d200805a110dac56d1d3b86762be15d7425e3070bb393c93647f3b3a32a7331348a0e28c3c4f59a0d17d6e32d62c2c9aeb5c55068417b41e3b2521a4da9d15440e31461b93314932c71e43f95fbfda2a9c59e13af63cf9d4ce578084c7a791374554729e78ce0dc83a78c8a9171901cba8f966d7eabbbc46fe34de79c97e4f78518c66c857fcf69297fdc157b5e39c2a88c66a5097fbb94351ad8ab9a7dfc09a463946a3355387144832e74f952a75a2a59dbe1770c05ce9a6e1668e3aaf32d717bde2adf52062518c2f081f78b8130aa839c402638962b1c8475f8a563c444b1aac636f95aa7392267e60722b8cd86098426039778f4b8d208ccbab344fed2fa912e1c8151f016705e1517be9fb8e092748d3013705a6bb570d0dcd3985fee573159a7d1ff2b7e6f64e8a49a7431b7121aadf9b2027303e5a7792af245345241332396decb22a71e4f93724cec3699d57b21aad33eb845e489bea8b6015c6919cbad898ecea5b6e9321845628fe5e9b498062858d55c177f8f98609c1b5bc3e684e3329d6b5313604e9a3111f66dd6d41f418a5dbe022e3685176f6e8e50dde7284003d660aea6f8beef67ae5215e92f01d213ea17aa19ae757894325186f3c6e93802f9968d7f69b73c68d7655b4ce5cc4b0df3c6ecbe31a8380f08a3de5d9fd8688825b5646888be172d36b74fa1542883e400d990d0462a9165818937cf0390328f9ec37551ef8885e3788b680cc4d94f3ff3ba7067fd52ddd95fecb5da7bb1d2770d4ab568155f6e9aae4ac99b2f3127b5a8e30ac55ab6497b315bc17b35b72b9a2ad413752dc3eaa09b9a0ed651a8c0924ddf4dae888d39cb8325982a350d53e707688cd95da4e05aa6f14add9b5e9a430044c07ea62a87c333aec31041b9a7881437a12d60fd6a000ee07507d931d504fa408d36719ab8562db0a07b4d147b934af04b0b157296cd31b3e540b558c3c0f51938f4a34e1550d1ba66304d5ab1bbda250302f7f2eed263cd48a00b5bee0520d6de09bfab235e69ee2a7e87e46814c17ac62b774dae46b91b7a238c9266b6f7a7bcf5e079ccf7b0a1b303d69c480182676dc8c323384b4190d45f92e1269cb6fe295f5f3a90fa29ec9ee877bda380455003f8e3bcb3d85747c059de9e6831653a5d2f5949488c1a7124276ababdd70adf202dfe47d58bd7e1b5bef116cd055aef6b3f7d3823b84371f6ffc965c2a3402ec322c13b293f4a1c946224fd2db6cb2aa21408a5bee05581282b3c45d05ae4edc6bf1d1df5e21abc35b5ff635c34583dc711ce3340a4795c999c09422d7dfef59b6b8d9b57b1c9dcb226e9e0898b164e3320da640a03e732f48af889c083de40c020c595655f32c685ae065f1fdb3798ffea76bcbd6d4195876fafe383188dbb1902c38766a99ae496202c9443f69923807c4750211773d21d28eec8c69890165e193a6eaa1e367e0e4e1968d8efcce41135491c60e4049d3d69b4257f8624792139aede14a73575b152cbb60a316e3e083ee3fb455a73fe890b000673ce8bfe3b8021b29f6d165df918b5c6cb0a8cc7a397f3fbeaf00c2a5e8c3d74493614b77df3b58b144158e99d82beda49aa815a9da8d0dbcb08170d5217f0163fa76c3ebc9dce4c830537565a2b480fbcf108da8b121f028d7f61f7e12da54782f4aa033f02c2bee47a03d1e72e04039d9bb713c35d287b8e5fee3a3d75c7e6fb07dee51572f20330f0e5221de88b7485947f7d5335d3c3a52d1ce70a1485242be30a241c427b85e6281b48a64b971c18ddf820f9fc28c103c907c4900a72f61df21393f47e424d1d574a301bcbd6b1a8dce6a087a9234dd23d9b509d9de60b6c7d10970a9641a0f708b6df95e98533032b327e18c46bcc13030c7bb478d9239118b7d40ff52e60d058d61c678cfead5284fb305d6b41938464d60fe100914a7363e0330131bf714a8378cd33dfb7f48004379d261e49a76f5acfdf4743a52e15390fdf875613730b909cc37577aa7121aaf3dc62ae94fec19441aac23c7103c7d51c327ce90c74c90e3d5d99ca0e781bca2b995d3dab405ef47e9d786d2a094053889a4c19d732274971b9d6656fb4cf2632522aa1ba9fb6f6546a023ef036525419a9ba3c333ebe7cac3b5a833325394cd3993eacfe2285edef50a94b85a1986246a998fccd050038cc2bc8bafdb734ee962536c66ae1e1d0e711911098954ac4766a3d0a521d42499e51bcdc6f953a5f3f52222621f2dd7ce348fed6a9e92605dfa3fbbb11655b70f0178f6bd7f2ca7d94069f9dc27bb31981728850ec7c53f27ea3c5c10bc640f5f208233ce60f55715624e42e56f530277ceba3210fdcb0760a30f759d1a85401e62520c7b8ef984b890b7d0e07661ebe45b54943bae3cb3b14d04c2c970508d598c500e8346edb83116d17a978fdc0dd2719f57d873c1cae8580631c21e0193abdb3bab331ce6546837aa68d5823b3be69cf90165996b0aa83f35ec59b30e1669c0d65a6d397a7da4199bdbd457e4d348e3aa2082536c923064079bf3ca3fcfde70fbea32cb0035758e4a90adefd029e2963a476860f3b92032c7d39f063fe85fe2f89c4413337c88b054aa54d61c5178d802938e99558f1dd3f66c3a0a28ddee76fd5dfa3fe3df51a9bc8d87c8de9df5c9bf374d026fb56850c668243c6c7319dea8a0ffdec97289123d2bec314bfa6b1dde3c3dedef4c09c28d1e64305ff8a488974f3e746bd23e372c19f9f68bcd99e13624090a3e0b48bcd44674e8490b23d078420bdb2345f52bd40d405cb127ec07ae82df0ac137f558d94237b7de8b9ca0f145696248b0287cd5f93ab56ef95cdff204a3538bdcc10ae16d469196d64cee08ea5c0c95e697e68ee1ff5852cf8b6b17607e92f107431818c49faae15a00abc36ac48816509930ce0171db01f05fca6b93aea977ce36c9dd267ba15d4cc7183ce3a8c901089ac7a2e246c64694ffbfed8c9de14ce1cf08dc132af98cdc7f74a3bc9d4ae00d17c3e0501647d8bf9587cf416b0043ffc26033f883d3cd5e43e0befe51297a514829fa7576ab568e7e73b99ffd78e1248c9b23bb3489776ce28b3f3e6a61f21cd3c048aeb0c451ee131513a074f8d3a4ada8f842fdba329fdc5597d14053b3941557c5c4105aef63ff056fe9b85cd1109db2ba214db8ab3aba0f69c33db8ad4369d340b7681418bfd386b33478105abaf80f96e0b467af6caae8bcc7a8196a4c8418bb94625f3cfcf40d04ea56e27f0336ddcf26d5bf32654f550c6dc07f1092f72f457053c5eeea66120c76a8d6c1d1fa5fffed2086002c59a35737ef4dba3bc3c0c00dcc9b28b790b68499dac7a8fe23fb8fcf3ccd14c296bcf5484e30703e1b20d0d5d98795ec471ecd692582a83ae7535102f180fd8b3f42a9a342bb81835806956744f21f68cde4a77c8f86fc11c60a3e5c9a422ed018dd909bd25684b3637aceb9e4ece37d901683f8926c62104c4b12feb995df160515af0524a9bd45a5d75564758db8b94c74d36ce282ec478f3a66ea093dd58f7eacf45bccf8b0c978e27a09bebf5eee106362260457ff5b84c6d2a88884f1853e322fef2d7605031f3ed98a36e5cdd6d328a9fed0989c967880b9da3c750e5dad621459c7e8cd2a6890ae33241a523aab7b4fd17e6e6ae55285a9503c1412a6c2cf004c9fbc59dfac687331c186846b21877a55048292e313b72a62fe25ad4c98a2309ccb83af2ab155060ca4b144238b9cdb9556524c0fd5a07fd87584fc5777474435bb3587905c657ed9bc709338858d189f58277c790ba394f22e2e0cf000dc589b7a79a628c720d84fc0dd0a51c01aaac30ef3b89ac68a43d190c2f61ad49901844458355b098bb3c9104ca6dee42b2eea1254d5b9f9fe555f95c378b3c1ab1ed8214f7e5a1328491e63ba31a2daa13ba381046b12eb9c9ef056f17edf621b08d07d6bdc85fe97a73865b18d7b4351545f18f2d3fe84320e0c1a55203c7ce93a97ef93e49e15473807161bf11d38ab1ce2af16e513e1a9836228140ea07ac1b62f8da3f35dcb24e69e6d6e67b922859bf95c7eb3e5056c344b6ce926a77b4494d5c1da4190d545753e88240bc4686e7a05cea381eb4cb7985391dd837362d9db69c84fe3ceabea870eb503ea4b12a20423edbffa5d854b6c06a6c079f1c48504c872fa59c19607d3018ccd223ca150518b1f4b872213fd88c6221fc77ce179495e02365e15a374f896f4b677da5e34ca16b2392cc322d3d6323f9f2ce78e49c0bdfd9fe316e032cf0fd545be4b9ef2a524001d8a532185ea37e80dcc9a3307e17a56910436f020d01fa8fab97f12fde1c3e51a81bb4071cb9db12687412e24747a3af78ed7499b0093c8c4ec4287d844dba5040c9d58fd90f7a70e1042a519698750bae378e1cdf3387d1bf1e0c46dabfcfe89256131911ec446a549ef013d39acfaee315cee1f5a8cbb1fd7f969f47ef150a4b8d641176e628669000afaef5d4420b185cea23d3dea122bc64317e244f1ac90e43539036e1464d1075ac053855f9477cc710e45e05a2d7e5191b85f10716386efbf1adc92f385a10a52d5750a96fb6f29c83f0a0fd1b75b66c8158ec97af3ac362ad3c4cdc868db73c037179d80947e3c3398227b24e911f0f635bdd37e7a42723d08aeec474a29e1935389b0a80e0f612bb016f0a100a44ea3b0c2235e2d186162b8b5fb537191b006fd05c666e901d31f87c263ab982d68f71eb8ad8853f68013a09d144054672ca47f4032e094f60b84e3b4b5d47de4775a8fde51040378629d2f34d3d4d490d56d40902df63f2e56e170ca3a93a838eda08d5228a7677c99455de0c12a6386dd2c6ed6988cd5be4a7b7bd9162a1aa06cf3e71508bd2cec17f17535d34ed9736eb5e663b22704459dd202932f9af4bbdd8fc39b71c9a057bd88c14e2fac1f27fefd8eee1f4c8fd41e50a9586601145b5684ef8d638ee1d44b208df6a6fb0dc2052252989a84e9aab7ddfb631e0d7b844d826e029f9cc24bd37f89fd05e8fc37c0f1a4e4459726fe943096c89908ed32ffbd905392ada794fb958578a03d78660e1e4fb185e994afb41ba1a32d6f1d584ec1eb90ba19b90649570906f0c1942e78984c9b6955ee151108f357995ee549b535598cd7465135edd84a9080769e2b50308a35b326cd879f21ebae10d585316972598baad1bb8ef91fda34217269e6c4e91ecee41920cf82974561c50a6a953b28a82a5d6a33f93a11e9aa1a193b4cd521c2118115bef6ff0d935cfd68a33b70deca85178e43d9de6c282729dce8d1690ccf4fa688dd4736113068822bfc6236314323d0baeaaf0b503b80ee6ea8bb163f3b50b9c1694c7497218c21f942dbcb4e6b0ce1e7b1f72782140cbb26da7294e5fcbee8bfd738742b851a73bc29b2e587db8adab05562cc890db0775273d32f4c339e2a8ea9715133d9ddfcc85e76f9a48904aac1ed0dda08575db1b183562919ab72851e851aee0bffd0d00036e648981d8b1138dbdffbc73c85c780deb6cd79dc3aac24f4bd02ab00f043c23224a5f4c3da60b5b5ea1f753bbc894f9c0f20bd770e395c88317508d862c88af452a72100dea4c292269f24b77beb7cb982179c83bf43e478773ee86935104c45ba420f3764ed51071322d6f07f6a5f28c768b066e771408fde1b31ef645ce4771cdc5efb51a69aa928e71b2aa9a41c622f11b0e0d064de089d6734443dce9aaaca4fc104eeb874b2bb5242605da7bae48c4c4a1d3cd9be76b205212ecfcaf72d0ce65b239aead122f7718dfa4d2dfd301425a8b80689cbe9c566d7385b3cd3cb546e1f9f3c2c464f1370293056683251fc02ba978a32398ab752e4a87173259ae6dffbf0558d739f2e3841d84572c5600a284a0a24a36f1d8784b2e834c18d2ae242eb667a0bc6ac8b7424abbb4a76c5079f940141e5e13582451014a5c9537c42aef3f11a5c197e9707f01e4f6acbcca4c0cf29d881651e16fdc204017bd6e70d262fc01576a7b24c2c267e50bafd881ed885296f32f466340c3ac9ffef879716cdf268afdd82bab17ec37311b8a8ecf3a1bad083d99669b9d55badf7509daebc57b30289a822a0aa2a4d74834eef960483ec19845a0defe52d65a38d33ddf59bc994d815481e4ede90f518196a382c812bf0e96ea51566011e06d94b11a3197af518ce4cc245f235119dd6c30b29d184bb0f52b5230beaea45edeb39159358497f191bab407a770fbfdd7d3594cb9ff75b78b8edb1cab9d44d477dfc7e59d4440453e83a1cddadc4436897ea5a4dbc22a5d28b56f739fa551447f83c6db464085a9bcb7c5ca4cdeb212cddd176e23025538537f3ccec870ece1b6903782cd823b737b4c2cea42d60e55678c43616176d49eb2d061676f57b192b072820b8d2b25df6a3715defb3c7fbcaad462efcd35f02b3e4570caec43f7f3bed774f075237d2ac926e3d95230c5b3c2e7deef323cad7a981eaa7dc65db53f548a37f86b31d7fa7ed6a3a9496917f7e6cd37a3644bbe03bed18919fe8106ccb15fc078e2cefb1fbc80b0e5d5a85ad8657951e1445b409b8d187bcdc90e12ca1bb2a4cb61024cc594e0eccdf79d67754a0986b4bdafb2c595a03b31c07833bc6f7ad6ae3a5c963195bee12174bee6dea804da3b9e317e195474354dec59659be746c1a0cc82a2b9027e09166205919528ad3f1b217bcc66b73d9d4f87e3230dc248755bb32014fa24fb6b07e607ee227b1f84ba4fdebe49edcd04b72501f39f3007045e6f4ffb162ca243f853a7dd4c702a403a61a1350c7ed17d2a97e55c846e97798f551a5d857cf12c78befb606966ae2725eb53b47fbe34ae8b119ee321271f7cc0816fe833195c86980698bd21f3cd86ca2fa610e807c533c4808ecfbcb7e01e5cf889d75facee9f3505bb50453004a2d78655e5cbbcdb2fc7d5b953cc457ba1bdb4b8d0846cee54ac7b58850d115631af4f2b260323e100204312e37ec33c7a139bf31c6b974560afc7f3edb37e50496cb4f12183e04bcfa00f61664c2f91d97ca6a94f5c895ad78534f82d46a1dec0cf3734277ab8ebf5f1d21f9147fed3aa1182bed9917a098bafd7210004509aa6f1c0ed25b5442d87f6ce7adc246c7295ccbaf4ad790a89dfcb32428afd95dbf8fffba4782db9ea824a63f1f4b9fba57bfab6dd1c90a03eee64ad45af3bd0024ca94a094dc5b16904a902caffa81f2bebf5ec1728ec6594146c3b608598a77f2fc3399cfab3f11c79f6eb53d2e4d2273c78401b1262eeeb1878b1e1d805723575e0f0fc074140764851f838e45921e9aecd7b459c506aea39feffd75df9b5a74230e6d0572df57520e82d46c5706195ae9b878b3fc4bd934bd9c1bb0eaded28ce0a5f3f210ee7bda15bca88c7f94e9296cfbd5808c42a2a135824aa8134e716352ca96ff08cbe6440fcb7d61eb84551cf4c6b8b26ed4346cb0b97afdebf25a5612e6e284dbf8ddcc266a6495e54e3a6e1b6e9594d8fc8abbe758386c185387e37d2f828ed50756a0bb09d01ddc50d41c46e6edac7e79deba3d36d480d32839cf2ade3ba91fb539da610bdbcc32531c19a2bc851bfd8ee4c98286b55e3f2f809ab07faacfd51da57d791c5251c774e5c6567c87791576eeac00375b38a54cc662e7e242f549ebfc69455f64c6af57ad2a57ba69abab3add49c7df99a88fce2e780edb5b97858f4fe75d18ce82ae7f5ab064a64337167cc6e5987927fe9efb2f7600c4c6a98a60c2f8e3d9c58eaadfd4e7c7adb814ba5d53a53acd50e67959909158c4c229aaccc0f170e03836ff9af179ccb8c70baa422d5034eb001bab3147d8f0413b4717075e793e4826fc8dafd9c6dbf26b0314265621f21efd1a151be73d025ad3c3d4a39ce42adf3e935322209efc9787b722229b6a51a09e69addeea6b660486a897ae71dee9e744c8e930b2b94d246444ba8db27085c34df0f94d9f9668f7204fecc5fab918fbc789f02d8e74e17eb7a16856e27472fda0369ef83ae964341ef48dc83ef4ace2c0329996f29f122ba5ef9eaf44032a56cd4967aee0c3de4909b25803da1f5181d2eae9193de4f3e96371facf93d5893ec43180de08a9cfa59ab0895954d6fd755d4c1a0eb3c8c1a5fa8844642b1b2f20b39f73a499742719c2b43496e055442e08483098a17f0c5abf263d7c71ed20bc0f19f48770831c951a616d315c0d7e095781f4e418d8739af7800f24af6eb3bf7f582470be33797d447ca4a76bbc3d7fc5544b8aca95b72b3c7cf1c6e11d00b858920140ba244ee67fddfa0417a7fa0b447db9a2c5b52d3952dd5c297c850f9c567eb20df6f60c8fa013ab7fdd2283c5c1df0356f72a8dd85aff6af61d604f64a738e6d40091369355af4363805b3e8a4ad06da381924b28d909c7bb331053e4bc34706783429cbf33b4b5a52e1bda94bbeb1fcc10bada8a10bbb07ccfd0ad4db1eec46ad68966779b468d3da93ba9a32c55618c10239d4900b0463b8409ecc74847fe650e95e639b5f6a3190c7a49b68f5e6fc63037b57d8fff3eab17548b357e642f9923202c8cdf59039ccbc4555e5369c846464b473c63c8c25b0672bfbff800f65726961db3f48cbeca136324022671f6125f9e2ce87a5e046ff9887cc4173c7a8fdd7dc6fddd6fb801de3afeaa598cd0fbba3707169ac8efd3de1de6147b1f3c6d49c2a6e162b31a1c71167da617fc138e70f96efa3d83becfdbe9ca250ea6eb50a0387d2b0bcd20c84eb81e20cbef4c45c784cd235551e7223ed29a33ea556c6c01a9bf44cc0ed1f40c28177080564</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-wave">      <input class="hbe hbe-input-field hbe-input-field-wave" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-wave" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-wave">文章被加密了, 请输入密码查看.</span>      </label>      <svg class="hbe hbe-graphic hbe-graphic-wave" width="300%" height="100%" viewBox="0 0 1200 60" preserveAspectRatio="none">        <path d="M0,56.5c0,0,298.666,0,399.333,0C448.336,56.5,513.994,46,597,46c77.327,0,135,10.5,200.999,10.5c95.996,0,402.001,0,402.001,0"></path>      </svg>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">🔒这可是好东西啊~</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="加密文章" scheme="https://blog.liukairui.me/tags/%E5%8A%A0%E5%AF%86%E6%96%87%E7%AB%A0/"/>
    
  </entry>
  
  <entry>
    <title>VueConf 2022 - Vue 的进化历程</title>
    <link href="https://blog.liukairui.me/article/VueConf2022-Vue%E7%9A%84%E8%BF%9B%E5%8C%96%E5%8E%86%E7%A8%8B/"/>
    <id>https://blog.liukairui.me/article/VueConf2022-Vue%E7%9A%84%E8%BF%9B%E5%8C%96%E5%8E%86%E7%A8%8B/</id>
    <published>2022-12-12T16:00:01.000Z</published>
    <updated>2022-12-12T16:00:01.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="库阶段library-2013-2015">库阶段(Library) 2013-2015</h2><p><strong>库与框架</strong>: 库更像是一个小模块嵌入于在大项目中,而框架则定义了一套自己的工程实践与配套工具</p><p>库阶段实现了基于 ES5 getter/setter 的响应式系统, MVVM, 模板数据绑定.并没有对构建工具等做出限制</p><p>此时 Vue 的组件与响应式系统强耦合, 没有编译过程, 直接将模板实例为 DOM并遍历实现数据绑定</p><h2 id="框架阶段framework-phase-2015-2016">框架阶段(Framework Phase)2015-2016</h2><p>实现 Vue 1.0</p><ul><li>引入了 Vue Router(SPA), vue-cli, Vuex(状态管理) 此时 Vue更像是一个框架了</li><li>引入了 <code>v-bind</code>, <code>v-on</code>, <code>v-for</code>及其缩写</li><li>实现了热更新与 Scoped CSS</li></ul><h2id="通用框架阶段universal-framework-phase-2016-2019">通用框架阶段(UniversalFramework Phase) 2016-2019</h2><p>完全重写, 实现 Vue 2.0.</p><ul><li>引入了模板编译 Virtual DOM</li><li>引入了基于 Virtual DOM 的服务端渲染</li><li>引入了基于 Virtual DOM 的跨端渲染</li><li>手动实现了 TS 定义</li><li>扩展了 vue-cli, 完成了工具链与 vue 的解绑</li><li>2.1 引入了作用域插槽</li><li>2.2 引入了基于路由的代码分割(SSR)</li><li>2.3 引入了基于路由的资源预加载(SSR, 基于 webpack 生成的 manifest文件分析资源引用关系)</li><li>2.4 引入了异步组件支持与编译输出(SSR)</li></ul><h2id="编译运行时混合阶compilerruntime-hybrid-phase-2019-now">编译/运行时混合阶(Compiler/RuntimeHybrid Phase) 2019-now</h2><p>Vue 2 的编译与运行模块是完全解耦的, 两者互不通信息,这导致编译器与运行时无法协作优化.</p><p>Vue 3</p><ul><li>实现了基于编译优化的 Virtual DOM 性能策略(Block Tree,PatchFlags)</li><li>提出了 Composition API(当时也提出了基于 class 的 API, 但是因为 class的装饰器语法不稳定, 最后选择了 Composition API). 切换 Composition API 后<ul><li>可扩展性得到了显著提升, 逻辑易于重组, 抽取, 复用</li><li>TS 更加友好</li></ul></li><li>实现了完全优化的 SSR 编译输出</li><li>开发了 Vite, 将 vue-cli 功能部分剥离到 Vite.</li><li>实现了同一份模版,不同的编译输出<ul><li>浏览器: 高度优化的 Virtual DOM 渲染函数</li><li>SSR: buffer + 字符串拼接</li><li>将来: Vapor mode (无 Virtual DOM 的渲染代码)</li></ul></li><li>单文件组件语法糖<ul><li><code>&lt;script setup&gt;</code></li><li>CSS v-bind()</li><li>Reactivity Transform</li></ul></li><li>3.1 引入了 Migration Build</li><li>3.2 引入了 <code>&lt;script setup&gt;</code></li></ul><p>现在的 Vue3</p><ul><li>core: 运行时, 编译器</li><li>文档</li><li>工具链 (create-vue)</li><li>SPA 路由 (Vue Router)</li><li>状态管理 (Pinia)</li><li>浏览器开发工具 (vue-devtools)</li><li>IDE 支持 (Volar)</li><li>TypeScript 支持 (将 tsc 扩展为 vue-tsc 以支持 sfc 检查)</li><li>静态分析 (eslint-plugin-vue)</li><li>单元测试 (<span class="citation"data-cites="vue/test-utils">@vue/test-utils</span>)</li></ul><h2 id="未来">未来</h2><ul><li>短期<ul><li>Reactivity Transform / Suspense 稳定化</li><li>SSR 水合改进 (lazy / on-demand / server-only)</li></ul></li><li>中到长期<ul><li>Vapor mode (受 Solid 启发的模版编译策略)</li></ul></li></ul>]]></content>
    
    
    <summary type="html">尤雨溪</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="前端框架" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="前端框架" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/"/>
    
    <category term="Vue" scheme="https://blog.liukairui.me/tags/Vue/"/>
    
    <category term="VueConf" scheme="https://blog.liukairui.me/tags/VueConf/"/>
    
  </entry>
  
  <entry>
    <title>一些字符编码规则</title>
    <link href="https://blog.liukairui.me/article/Unicode%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/"/>
    <id>https://blog.liukairui.me/article/Unicode%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/</id>
    <published>2022-12-11T16:00:01.000Z</published>
    <updated>2022-12-11T16:00:01.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="unicode-编码规则">Unicode 编码规则</h1><blockquote><p>以下部分转自: <span class="exturl" data-url="aHR0cHM6Ly93YW5nd2wubmV0L3N0YXRpYy9wYWdlcy91bmljb2RlLmh0bWw=">一文彻底搞懂Unicode编码问题<i class="fa fa-external-link-alt"></i></span></p></blockquote><h2 id="ascii">ASCII</h2><p>最基础的编码格式，打字机时代的产物，共128个字符，其包含键盘上每一个可显字符，可应对只有英文字母场景下的编码需求。</p><p>ASCII编码，共128个字符，编码范围为0~127，每个字符占用一个字节(8位)，但ASCII实际7位就够用了，所以第8位可用于保存额外的信息，早期多用来做奇偶校验，目前都是填充0。</p><p>其中第32到126的字符( - 7E)，共95个，为可显字符(printablecharacter)，为空格、数字、字母、标点符号、和几个特殊符号(例如脱字符^)。其中：</p><ul><li>32()，为空格</li><li>48-57(-)，数字0-9</li><li>65-90(-5A)，字母A-Z</li><li>97-122(-7A)，字母a-z</li></ul><p>前32个字符和最后1个字符(0到32和127)，共33个字符，称之为控制字符(Controlcharacter)。</p><p>每个控制字符除了通过ASCII编码表示，还有另外的「脱字符表示法」(Caretnotation)，第0个为<code>^0</code>，后续26个为<code>^A</code>~<code>^Z</code>，剩余的为<code>^[</code>，<code>^\</code>，<code>^]</code>，<code>^^</code>，<code>^_</code>，最后一个为<code>^?</code>。在JS中的正则表达式中，用<code>\c</code>来替代脱字符匹配控制字符，例如<code>\cJ</code>代表<code>^J</code>。另外，有几个特殊的在现在编码中仍然有用的控制字符，还有「转义符表示法」(escapesequence)。如下表所示：</p><table><colgroup><col style="width: 10%" /><col style="width: 17%" /><col style="width: 17%" /><col style="width: 26%" /><col style="width: 14%" /><col style="width: 14%" /></colgroup><thead><tr class="header"><th style="text-align: center;">十进制</th><th style="text-align: center;">脱字符表示</th><th style="text-align: center;">转义符表示</th><th style="text-align: center;">名称</th><th style="text-align: center;">名称简写</th><th style="text-align: center;">作用</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">0</td><td style="text-align: center;">^@</td><td style="text-align: center;">\0</td><td style="text-align: center;">Null</td><td style="text-align: center;">NUL</td><td style="text-align: center;">空</td></tr><tr class="even"><td style="text-align: center;">7</td><td style="text-align: center;">^G</td><td style="text-align: center;"></td><td style="text-align: center;">Bell</td><td style="text-align: center;">Bel</td><td style="text-align: center;">振铃</td></tr><tr class="odd"><td style="text-align: center;">8</td><td style="text-align: center;">^H</td><td style="text-align: center;"> Backspace</td><td style="text-align: center;">BS</td><td style="text-align: center;">退格</td><td style="text-align: center;"></td></tr><tr class="even"><td style="text-align: center;">9</td><td style="text-align: center;">^I</td><td style="text-align: center;"> Horizontal Tab</td><td style="text-align: center;">HT</td><td style="text-align: center;">水平制表</td><td style="text-align: center;"></td></tr><tr class="odd"><td style="text-align: center;">10</td><td style="text-align: center;">^J</td><td style="text-align: center;"></td><td style="text-align: center;">Line Feed</td><td style="text-align: center;">LF</td><td style="text-align: center;">换行</td></tr><tr class="even"><td style="text-align: center;">11</td><td style="text-align: center;">^K</td><td style="text-align: center;"> Vertical Tab</td><td style="text-align: center;">VT</td><td style="text-align: center;">垂直制表</td><td style="text-align: center;"></td></tr><tr class="odd"><td style="text-align: center;">12</td><td style="text-align: center;">^L</td><td style="text-align: center;"> Form feed</td><td style="text-align: center;">FF</td><td style="text-align: center;">换页</td><td style="text-align: center;"></td></tr><tr class="even"><td style="text-align: center;">13</td><td style="text-align: center;">^M</td><td style="text-align: center;"> Carriage Return</td><td style="text-align: center;">CR</td><td style="text-align: center;">回车</td><td style="text-align: center;"></td></tr><tr class="odd"><td style="text-align: center;">27</td><td style="text-align: center;">^[</td><td style="text-align: center;"></td><td style="text-align: center;">Escape</td><td style="text-align: center;">ESC</td><td style="text-align: center;">换码</td></tr></tbody></table><p>显然128个字符对于英文表达足够了，但是明显不适用中文，以及其他非英文表达的语言，所以中国后来有了GBK编码。ASCII编码在早期遇到编码不够用的时候，也有一些扩展和变体，例如「扩展ASCII」可表示256个字符。不过由于后来有了Unicode编码格式，这些都没用了，所以就没必要去了解了。</p><h2 id="unicode">Unicode</h2><p>Unicode编码标准，可表示目前全世界所有语言的所有字符。同时兼容ASCII编码。</p><p>Unicode的前128个字符编码和ASCII是一致的，即向后兼容ASCII，对于使用ASCII编码的程序可以直接使用Unicode规范。在Unicode中，对于每一个字符编码的值，叫做<code>code point</code>。例如小写字母a的<code>code point</code>为97，对应十六进制为<code>\x61</code>。下文为了方便对<code>code point</code>称作「码位」。</p><p>在Unicode中，码位的总范围为<code>\x0</code>到<code>\x10FFFF</code>，共1,114,112个码位。2048个用于编码代理(UTF-16)，66个非字符码位(例如BOM)，137,468个预留给私人使用，最终剩余974,530用于普通字符分配。</p><p>码位的最大值为<code>\x10FFFF</code>，对应二进制有21位，我们将2<sup>16个值分为一组，则Unicode总共可以分为17份，每一份称之为平面(Plane)，每一个平面有65,536(2</sup>16)个码位。</p><p>为什么Unicode的最大值为<code>\x10FFFF</code>？因为对于<code>UTF16</code>编码，双字节最多可编码2<sup>20个字符，单字节可编码2</sup>16个字符，加起来共17个平面的字符数。</p><p>下表为每个平面详情：</p><table><colgroup><col style="width: 12%" /><col style="width: 18%" /><col style="width: 10%" /><col style="width: 58%" /></colgroup><thead><tr class="header"><th style="text-align: center;">平面编号</th><th style="text-align: center;">码位范围(十六进制)</th><th style="text-align: center;">名称简写</th><th style="text-align: center;">名称</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">Plane 0</td><td style="text-align: center;">0000–FFFF</td><td style="text-align: center;">BMP</td><td style="text-align: center;">基础多语言平面(Basic MultilingualPlane)</td></tr><tr class="even"><td style="text-align: center;">Plane 1</td><td style="text-align: center;">10000–1FFFF</td><td style="text-align: center;">SMP</td><td style="text-align: center;">补充多语言平面(SupplementaryMultilingual Plane)</td></tr><tr class="odd"><td style="text-align: center;">Plane 2</td><td style="text-align: center;">20000–2FFFF</td><td style="text-align: center;">SIP</td><td style="text-align: center;">补充表意语言平面(SupplementaryIdeographic Plane)</td></tr><tr class="even"><td style="text-align: center;">Plane 3</td><td style="text-align: center;">30000–3FFFF</td><td style="text-align: center;">TIP</td><td style="text-align: center;">第三表意语言平面(Tertiary IdeographicPlane)</td></tr><tr class="odd"><td style="text-align: center;">Planes 4–13</td><td style="text-align: center;">40000–DFFFF</td><td style="text-align: center;">- (未分配)</td><td style="text-align: center;">- (未分配)</td></tr><tr class="even"><td style="text-align: center;">Plane 14</td><td style="text-align: center;">E0000–EFFFF</td><td style="text-align: center;">SSP</td><td style="text-align: center;">补充特殊用途平面(SupplementarySpecial-purpose Plane)</td></tr><tr class="odd"><td style="text-align: center;">Planes 15–16</td><td style="text-align: center;">F0000–10FFFF</td><td style="text-align: center;">SPUA-A/B</td><td style="text-align: center;">补充私有使用区平面(Supplementary PrivateUse Area planes)</td></tr></tbody></table><p>BMP为基础平面，目前收录了全球范围内大部分的字符。剩余的16个平面均为补充平面，用于进行新的字符的补充。其中私有平面，用于给个人做编码扩展，Unicode不指定字符编码。比如我编写了一个英雄联盟相关的程序，然后定义某一个字符代表一种游戏里的操作，就可以使用私有平面。</p><p>Unicode中还有一个概念：对于逻辑上属于一类的字符，称之为块(block)。例如:</p><ul><li><code>C0 Controls and Basic Latin</code>块，<code>\x0000</code>-<code>\x007F</code>，就是从ASCII继承来的前128个字符。</li><li><code>CJK Unified Ideographs</code>块，<code>\x4E00</code>-<code>\x9FFC</code>，包含大部分的中日韩文字，</li><li><code>Halfwidth and Fullwidth Forms</code>，<code>\xFF00</code>-<code>\xFFEF</code>，用于英文字母/数字/日文/个别符号等一些字符的全角-半角相互转换。</li><li><code>Miscellaneous Symbols and Pictographs</code>，<code>\x1F300</code>-<code>\x1F5FF</code>，<code>Supplemental Symbols and Pictographs</code>，<code>\1F900</code>-<code>\1F9FF</code>，包含大部分emoji表情</li></ul><p>另外还有一个比较重要的块<code>General Punctuation</code>，码位在<code>[2000,206F]</code>，包含一些符号以及一些特殊的分隔符、连接符、空格符等，这些符号不一定是可显字符，而是告诉解释器该如何操作当前字符。对于所有块，<span class="exturl" data-url="aHR0cHM6Ly91bmljb2RlLm9yZy9jaGFydHMvbmFtZXNsaXN0Lw==">可通过该链接查阅<i class="fa fa-external-link-alt"></i></span>。</p><h2 id="半角全角">半角/全角</h2><p>对于全角字符，在展示上占用的宽度是半角字符的两倍。每个字符都在Unicode标准里定义了是全角还是半角，对于不需要精确计算的简单业务场景，也可以简单的认为码位大于128的都是全角字符。</p><p>半角和全角，对应英文为halfwidth，fullwidth。半角全角对应的是UI显示的概念，对于定宽的字体，全角字符占用的宽度是半角字符的两倍。Unicode中每个字符都有一个<code>East_Asian_Width</code>属性，用于指示当前是全角字符还是半角字符，<span class="exturl" data-url="aHR0cHM6Ly93d3cudW5pY29kZS5vcmcvcmVwb3J0cy90cjQ0L3RyNDQtMjYuaHRtbCNWYWxpZGF0aW9uX29mX0VudW1lcmF0ZWQ=">具有以下值<i class="fa fa-external-link-alt"></i></span>：</p><ul><li>A， Ambiguous，根据上下文决定</li><li>F， Fullwidth，全角</li><li>H， Halfwidth，半角</li><li>N， Neutral，中立，作为半角</li><li>Na， Narrow，半角</li><li>W， Wide，全角</li></ul><p>在<span class="exturl" data-url="aHR0cHM6Ly93d3cudW5pY29kZS5vcmcvUHVibGljL1VDRC9sYXRlc3QvdWNkL0Vhc3RBc2lhbldpZHRoLnR4dA==">EastAsianWidth.txt文件<i class="fa fa-external-link-alt"></i></span>中列举了已显示声明<code>East_Asian_Width</code>属性的字符。对于不在该文件内的字符，符合下列规则的为<code>W</code>(全角)：</p><ul><li>the CJK Unified Ideographs Extension A block， 对应区间：<code>\x3400</code>..<code>\x4DBF</code></li><li>the CJK Unified Ideographs block， 对应区间：<code>\x4E00</code>..<code>\x9FFF</code></li><li>the CJK Compatibility Ideographs block， 对应区间：<code>\xF900</code>..<code>\xFAFF</code></li><li>the Supplementary Ideographic Plane， 对应区间：<code>\x20000</code>..<code>\x2FFFF</code></li><li>the Tertiary Ideographic Plane， 对应区间：<code>\x30000</code>..<code>\x3FFFF</code></li></ul><p>其余未列出的，默认为<code>N</code>(半角)。</p><p>在一些编码集中，有的字符既有全角形式也有半角形式，Unicode为了实现与这些编码集之间的无损转换，在第一平面的最后，<code>\xFF00</code>到<code>\xFFEF</code>区段，定义了用于半角全角转换的字符，如下所示：</p><ul><li><code>\xFF01</code>–<code>\xFF5E</code>为ASCII的<code>\x21</code>到<code>\x7E</code>的全角形式。其中空格没有纳入进来，因为全角空格已通过<code>\x3000</code>定义。</li><li><code>\xFF65</code>–<code>\xFF9F</code> 为半角的日语字符。</li><li><code>\xFFA0</code>–<code>\xFFDC</code> 为半角的汉语字符。</li><li><code>\xFFE0</code>–<code>\xFFEE</code>包含了一些符号，有半角有全角。</li></ul><p>对于在JS中判断字符是全角还是半角，目前下载量比较多的一个npm包：<code>is-fullwidth-code-point</code>。<code>string-width</code>依赖<code>is-fullwidth-code-point</code>计算字符长度。不过实际测试，<code>is-fullwidth-code-point</code>没有完全覆盖所有全角字符(<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NpbmRyZXNvcmh1cy9pcy1mdWxsd2lkdGgtY29kZS1wb2ludC9pc3N1ZXMvMTI=">issue<i class="fa fa-external-link-alt"></i></span>)，不过对于日常中文场景的开发够用了。</p><p>在日常开发中，对于UI展示的场景中，会比较关心字符宽度的问题。但是在涉及存储的时候，更关心的其实是存储该字符占用了几个字节。所以在涉及存储的场景下，关注点就不应该是全角/半角的概念，而是字符编码所占用的字节数。对于<code>UTF8</code>编码，码位小于等于128的使用1字节存储，大于128的会根据需要，使用双字节，三字节或四字节存储。所以多数场景下，为了简便，前后端都可以通过码位是否大于128来判断全角/半角。</p><h2 id="htmlxml实体转义">HTML/XML实体转义</h2><p>我们常说的HTML转义，实际正式应该称之为HTML实体引用。对应有两种引用方式：数字字符引用(numericcharacter reference) 和 字符实体引用(character entity reference)。</p><p>先说常见的字符实体引用，语法为：<code>&amp;name;</code>，name必须小写。例如：<code>&lt;</code>表示小于号<code>&lt;</code>。</p><p>可以进行引用的实体，称之为命名实体。命名实体有两种，一种是语法中内置的，另一种是在DTD中显示声明的：<code>&lt;!ENTITY name "value"&gt;</code>。</p><p>数字字符引用方式：</p><ul><li>十进制：<code>&amp;#nnnn;</code></li><li>十六进制：<code>&amp;#xhhhh;</code>，x必须小写。hhhh大小写可以混用。</li></ul><p>还是同样的例子，小于号<code>&lt;</code>如果使用数字字符引用的方式，为：<code>&lt;</code>。</p><h3 id="html">HTML</h3><p><span class="exturl" data-url="aHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvbmFtZWQtY2hhcmFjdGVycy5odG1sI25hbWVkLWNoYXJhY3Rlci1yZWZlcmVuY2Vz">通过该链接查看目前HTML5中支持的命名实体<i class="fa fa-external-link-alt"></i></span>。</p><h3 id="xml">XML</h3><p>XML规范中，有5个预定义的实体，如下所示，如果需要使用更多的实体转义，需要在DTD中声明。</p><table><colgroup><col style="width: 5%" /><col style="width: 5%" /><col style="width: 16%" /><col style="width: 14%" /><col style="width: 9%" /><col style="width: 47%" /></colgroup><thead><tr class="header"><th style="text-align: center;">名称</th><th style="text-align: center;">字符</th><th style="text-align: center;">码位十六进制</th><th style="text-align: center;">码位十进制</th><th style="text-align: center;">标准</th><th style="text-align: center;">名称全称</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">quot</td><td style="text-align: center;">"</td><td style="text-align: center;"></td><td style="text-align: center;">34</td><td style="text-align: center;">XML 1.0</td><td style="text-align: center;">quotation mark</td></tr><tr class="even"><td style="text-align: center;">amp</td><td style="text-align: center;">&amp;</td><td style="text-align: center;"></td><td style="text-align: center;">38</td><td style="text-align: center;">XML 1.0</td><td style="text-align: center;">ampersand</td></tr><tr class="odd"><td style="text-align: center;">apos</td><td style="text-align: center;">'</td><td style="text-align: center;"></td><td style="text-align: center;">39</td><td style="text-align: center;">XML 1.0</td><td style="text-align: center;">apostrophe (1.0: apostrophe-quote)</td></tr><tr class="even"><td style="text-align: center;">lt</td><td style="text-align: center;">&lt;</td><td style="text-align: center;">003C</td><td style="text-align: center;">60</td><td style="text-align: center;">XML 1.0</td><td style="text-align: center;">less-than sign</td></tr><tr class="odd"><td style="text-align: center;">gt</td><td style="text-align: center;">&gt;</td><td style="text-align: center;">003E</td><td style="text-align: center;">62</td><td style="text-align: center;">XML 1.0</td><td style="text-align: center;">greater-than sign</td></tr></tbody></table><h2 id="unicode-encoding-forms">Unicode Encoding Forms</h2><p>Unicode字符编码格式(Unicode EncodingForms)，简写为:UTF，即：将一个Unicode字符保存为字节序列的格式规范，用于文件存储、数据传输等。Unicode标准支持3种编码格式，如下：</p><ul><li>UTF-32: 使用4字节表示一个Unicode字符。</li><li>UTF-16:变长的编码格式，码位大于<code>\xFFFF</code>的字符，使用4字节存储，小于等于<code>\xFFFF</code>的字符，使用2字节存储。</li><li>UTF-8:变长的编码格式，码位大于<code>\xFFFF</code>的字符，使用4字节存储，小于等于<code>\xFFFF</code>大于<code>\x07FF</code>的使用3字节，小于等于<code>\x07FF</code>大于<code>\x007F</code>的使用2字节，小于等于<code>\x007F</code>使用1字节。</li></ul><p>Unicode标准支持3种编码格式，<code>UTF32</code>/<code>UTF16</code>/<code>UTF8</code>，用于映射码位为<code>\x0000</code>到<code>\xD7FF</code> 和<code>\xE000</code>到<code>\x10FFFF</code>的字符，即除去高位代理和低位代理的所有字符。至于什么是高位代理和低位代理后面会讲到。</p><h3 id="utf32">UTF32</h3><p>是一种定长编码格式，使用32位(4字节)表示Unicode中的一个码位。由于Unicode的码位实际只用了21位，所以多余部分前导0。例如字符小写字母a，对应码位为<code>\x61</code>，存储的字节序列为：<code>\x00000061</code>。</p><h3 id="utf16">UTF16</h3><p>变长编码格式，按平面区分，位于第一平面中的字符(<code>\x0000..\xD7FF</code>和<code>\xE000..\xFFFF</code>)，使用16位(2字节)存储，使用和码位相同的值。位于其他平面的字符(<code>\x10000..\x10FFFF</code>)，通过高位和低位代理使用32位(4字节)表示。</p><p>对于位于第一平面的值，即小于等于<code>\xFFFF</code>的值，使用2个字节就足够表示，所以直接使用两个字节表示其码位的值，如下所示：</p><table><thead><tr class="header"><th style="text-align: center;">code point</th><th style="text-align: center;">UTF16编码后实际存储的值</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">xxxx xxxx xxxx xxxx</td><td style="text-align: center;">xxxx xxxx xxxx xxxx</td></tr></tbody></table><p>位于其他平面平面的值，即大于<code>\xFFFF</code>的值，使用4个字节表示，如下所示：</p><table><colgroup><col style="width: 41%" /><col style="width: 58%" /></colgroup><thead><tr class="header"><th style="text-align: center;">code point</th><th style="text-align: center;">UTF16编码后实际存储的值(wwww = uuuuu -1)</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">000u uuuu hhhh hhxx xxxx xxxx</td><td style="text-align: center;">1101 10ww wwhh hhhh 1101 11xx xxxxxxxx</td></tr></tbody></table><p>位于其他平面的值，即<code>\x10000</code>到<code>\x10FFFF</code>的值，二进制最高使用21位。将其拆分为两部分，即前11位和后10位，前11为用<code>hhhhhh hhhh</code>表示，后10位用<code>xxxxx xxxxx</code>表示。其中，前11位中，前5位是用来表示位于第几个平面，所以这里也特殊标注出来，用u表示，即前11位为：<code>uuuuuh hhhhh</code>。</p><p>由于这里前五位的有效值为<code>\x1</code>到<code>\x10</code>，所以可以减1，让有效值从0开始，则有效值变成了<code>\x00</code>到<code>\x0F</code>，即4位，减1后的值用w表示，从而前11位可以表示为：wwwwh hhhhh。</p><p>将前10位前导<code>110110</code>，后10位前导<code>110111</code>，即<code>UTF16</code>对于大于<code>\xFFFF</code>字符的表示如上述表格所示。</p><p>这里,二进制<code>1101 1000 0000 0000</code>为<code>\xD800</code>，二进制<code>1101 1100 0000 0000</code>为<code>\xDC00</code>，从而，该规则简单描述如下：</p><ul><li>假设某个字符x位于<code>\x10000</code>到<code>\x10FFFF</code>之间，将其减去<code>\x10000</code>，得到x'，x'的范围为：<code>\x00000</code>–<code>\xFFFFF</code>。</li><li>将x'分成两部分，前10位和后10位，用w1和w2表示，其范围为<code>\x0000</code>–<code>\x03FF</code>。</li><li>将w1加上<code>\xD800</code>，得到w1'，范围为：<code>\xD800</code>–<code>\xDBFF</code>.</li><li>将w2加上<code>\xDC00</code>，得到w2'，范围为：<code>\xDC00</code>–<code>\xDFFF</code>.</li></ul><p>将w1'和w'2转换为二进制，即<code>UTF16</code>下x存储的字节序列。</p><pre class="line-numbers language-none"><code class="language-none">x&#39; &#x3D; yyyyyyyyyyxxxxxxxxxx   &#x2F;&#x2F; x - 0x10000x1&#39; &#x3D; 110110yyyyyyyyyy      &#x2F;&#x2F; 0xD800 + yyyyyyyyyyx2&#39; &#x3D; 110111xxxxxxxxxx      &#x2F;&#x2F; 0xDC00 + xxxxxxxxxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="utf8">UTF8</h3><p>变长编码格式，是直接兼容ASCII的编码格式，对于能在1字节内保存的，直接保存为1字节。否则进行类似<code>UTF16</code>高低位代理的方式，最高位使用4字节。</p><p><code>UTF8</code>中没有减1的逻辑，只是简单的增加前缀，具体规则如下:</p><table style="width:100%;"><colgroup><col style="width: 26%" /><col style="width: 30%" /><col style="width: 10%" /><col style="width: 10%" /><col style="width: 10%" /><col style="width: 10%" /></colgroup><thead><tr class="header"><th style="text-align: center;">范围</th><th style="text-align: center;">码位(二进制)</th><th style="text-align: center;">第1个字节</th><th style="text-align: center;">第2个字节</th><th style="text-align: center;">第3个字节</th><th style="text-align: center;">第4个字节</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"> .. 007F(7位)</td><td style="text-align: center;">00000000 0xxxxxxx</td><td style="text-align: center;">0xxxxxxx</td><td style="text-align: center;">-</td><td style="text-align: center;">-</td><td style="text-align: center;">-</td></tr><tr class="even"><td style="text-align: center;"> .. 07FF(11位)</td><td style="text-align: center;">00000yyy yyxxxxxx</td><td style="text-align: center;">110yyyyy</td><td style="text-align: center;">10xxxxxx</td><td style="text-align: center;">-</td><td style="text-align: center;">-</td></tr><tr class="odd"><td style="text-align: center;"> .. </td><td style="text-align: center;">zzzzyyyy yyxxxxxx</td><td style="text-align: center;">1110zzzz</td><td style="text-align: center;">10yyyyyy</td><td style="text-align: center;">10xxxxxx</td><td style="text-align: center;">-</td></tr><tr class="even"><td style="text-align: center;"> .. 10FFFF</td><td style="text-align: center;">000uuuuu zzzzyyyy yyxxxxxx</td><td style="text-align: center;">11110uuu</td><td style="text-align: center;">10uuzzzz</td><td style="text-align: center;">10yyyyyy</td><td style="text-align: center;">10xxxxxx</td></tr></tbody></table><p>在<code>UTF8</code>中，</p><ul><li>如果字节序列以<code>0</code>开头，代表当前字节本身表示了一个字符。</li><li>如果为<code>10</code>开头，则代表当前字节为多字节字符中的一个字节。</li><li>如果当前字符以<code>11</code>开头，则前面<code>1</code>的个数，代表当前字符所使用的字节数，2个<code>1</code>代表使用两个字节表示一个字符，3个<code>1</code>代表使用3个字节表示一个字符。</li></ul><h2 id="byte-order-mark">Byte order mark</h2><p>字节顺序标记(Byte ordermark)，指预定义的，放置在文本流开头的，一段特殊的字节序列，用于标记当前文本使用的哪种编码格式(<code>UTF32</code>/<code>UTF16</code>/<code>UTF8</code>)。具体规则如下：</p><table><thead><tr class="header"><th style="text-align: center;">编码格式</th><th style="text-align: center;">文本流开头的字节序列</th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">UTF-8</td><td style="text-align: center;">EF BB BF</td></tr><tr class="even"><td style="text-align: center;">UTF-16 (BE)</td><td style="text-align: center;">FE FF</td></tr><tr class="odd"><td style="text-align: center;">UTF-16 (LE)</td><td style="text-align: center;">FF FE</td></tr><tr class="even"><td style="text-align: center;">UTF-32 (BE)</td><td style="text-align: center;">00 00 FE FF</td></tr><tr class="odd"><td style="text-align: center;">UTF-32 (LE)</td><td style="text-align: center;">FF FE 00 00</td></tr></tbody></table><p>例如Windows的记事本应用，将文本保存为<code>UTF8</code>格式时，会在文本内容的开头添加<code>\xEF</code>,<code>\xBB</code>,<code>\BF</code>3个字节。记事本应用在读取一个文本文件的时候，发现前三个字节为<code>\xEF</code>,<code>\xBB</code>,<code>\BF</code>，则认为接下来的字节流通过<code>UTF8</code>形式解析。</p><h3 id="endianness">endianness</h3><p>字节顺序(endianness)，这里特指当保存一个数字类型数据时，存储的字节序列的顺序。分为大端序(big-endian，简写BE)和小端序(little-endian，简写LE)。</p><p>假设当前要将一个16位的整型数字<code>\x0A0B</code>指向内存地址。</p><p>对于大端序的CPU，随着内存地址的增加，认为其存储的值的重要性是递减的，所以大端序的CPU会在100的位置上存储<code>\x0A</code>，在101的位置上存储<code>\x0B</code>。</p><p>对于小端序的CPU，随着内存地址的增加，认为其存储的值的重要性是递增的，所以小端序的CPU会在100的位置上存储<code>\x0B</code>，在101的位置上存储<code>\x0A</code>。</p><p>所以反过来，假设现在在内存中，地址100的地方存储了<code>\xAA</code>，在101的地方存储了<code>\xBB</code>，假设有一个<code>int16</code>变量指向，对于大端序CPU会认为该变量的值为<code>\xAABB</code>，对于小端序CPU会认为该变量的值为<code>\xBBAA</code>。</p><h3 id="byte-order-mark-1">Byte order mark</h3><p>因为各个系统之间的字节顺序不同，所以在传输和交换Unicode文本时，要告诉对方当前是以什么顺序保存的，从而接收方才能有效的进行解析。</p><p>字节序列标记(Byte ordermark，简写BOM)，特指<code>\xFEFF</code>字符。在文本的开头，添加<code>\xFEFF</code>字符，用于标识当前文本的字节顺序。</p><ul><li>对于<code>UTF8</code>编码格式，该字符会被保存为<code>\xEFBBBF</code></li><li>对于<code>UTF16 BE</code>编码格式，该字符会被保存为<code>\xFEFF</code></li><li>对于<code>UTF16 LE</code>编码格式，该字符会被保存为<code>\xFFFE</code></li><li>对于<code>UTF32 BE</code>编码格式，该字符会被保存为<code>\x0000FEFF</code></li><li>对于<code>UTF32 LE</code>编码格式，该字符会被保存为<code>\xFFFE0000</code></li></ul><p>所以，解析程序通过判断BOM即可确定接下来的文本所使用的编码格式以及字节顺序。在Unicode中，<code>\xFEFF</code>是专门用作BOM的，如果该字符出现在文本中间，会被当做「零宽非换行空格」(zero-widthnon-breakingspace)，其实就是跳过的意思。同样的，对于它的一个镜像字符<code>\xFFFE</code>，如果出现也会被跳过。</p><p>BOM可以省略，不是必须的，因为：</p><ol type="1"><li>在某些场景下已经预设了编码格式或字节顺序，例如W3C的HTML5规范中，如果指定charset为utf-8，则会默认按照utf-8解析，而如果文件流指定了BOM，则会优先使用BOM指定的编码格式和字节顺序。</li><li>当BOM被省略时，大部分解析器都会对文本流进行推算，推算出编码格式和字节顺序，但是这个推算并不是绝对可靠的。</li></ol><p>当使用<code>UTF8</code>格式保存文本时，Unicode标准建议，如果原文本没有BOM，则不要添加BOM。因为：</p><ol type="1"><li><code>UTF8</code>是单字节存储的，不存在字节顺序问题。</li><li>解析器会默认使用<code>UTF8</code>解析文本。</li><li>因为ASCII和<code>UTF8</code>是一一对应的，如果不添加BOM，则ASCII和Unicode可以相互兼容，如果加上了BOM，就打破了相互兼容。</li></ol><p>不过当前很多系统或平台并没有按照规范来，在解析文本的时候会要求<code>UTF8</code>要有BOM，以及在保存文本的时候会加上BOM，例如windows系统的记事本。</p><p>而对于<code>UTF16</code>和<code>UTF32</code>，要添加BOM，不然在解析的出的文本可能就是乱码，因为解析器在对字节顺序的推算上，并不能保证完全可靠。</p><h1 id="组合字符">组合字符</h1><p>Unicode有一类字符称为组合字符，它可以附加在前一个非组合字符上，从而使整体看起来像是一个字符。Unicode组合字符设计上，并没有加组合数量限制，这样使我们可以无限加这类组合字符,例如汉语拼音字母「ü」上面的两个小点，或「á」、「à」字母上面的音标。</p><p><strong>组合字符有两种</strong></p><ul><li>组合字符:将组合字符置于需要修饰的目标字符后边，使目标字符被渲染（或打印）成相应结果。</li><li>预组合字符:事先将字符组好并赋予码位。字符串中有可能同时使用组合字符和预组字符。这导致了若要比较两个unicode字符串时，需要先运行unicode字符的等价性。</li></ul><p><strong>组合字符在 Unicode统一码中存在多个区块，编码范围主要有：</strong></p><ul><li><p>组合用附加符号（<span class="exturl" data-url="aHR0cHM6Ly91bmljb2RlLm9yZy9jaGFydHMvUERGL1UwMzAwLnBkZg==">Combining DiacriticalMarks<i class="fa fa-external-link-alt"></i></span>）：区间从 <code>U+0300</code> 到 <code>U+036F</code> 共 80字。</p><p>它常与字母组合，修饰字母的读音。但其实它的定义比较宽泛，不但包括了拉丁、希腊及西里尔系文字中的变音记号，也包括那些不是变音但不占据宽度的附加标记。例如<code>&amp;#x61;&amp;#3655;&amp;#3655;&amp;#3655;&amp;#3655;&amp;#3662;&amp;#3662;&amp;#3662;&amp;#3662;&amp;#3657;&amp;#3657;&amp;#3657;&amp;#3657;</code>为 a็็็็๎๎๎๎้้้้</p></li><li><p>组合用附加符号补集（<span class="exturl" data-url="aHR0cHM6Ly91bmljb2RlLm9yZy9jaGFydHMvUERGL1UxREMwLnBkZg==">Combining DiacriticalMarks Supplement<i class="fa fa-external-link-alt"></i></span>）：区间从 <code>U+1DC0</code> 到<code>U+1DFF</code> 共 64 字。</p><p>它常与一些符号组合，用于渲染和修饰符号. 例如:<code>&amp;#x1DD0;&amp;#x1DD0;&amp;#x61;&amp;#x1DC4;&amp;#x1DC4;</code>为 ᷐᷐a᷄᷄</p></li><li><p>组合用记号（<span class="exturl" data-url="aHR0cHM6Ly91bmljb2RlLm9yZy9jaGFydHMvUERGL1UyMEQwLnBkZg==">Combining DiacriticalMarks for Symbols<i class="fa fa-external-link-alt"></i></span>）：区间从 <code>U+20D0</code> 到<code>U+20FF</code> 共 48 字。例如:<code>&amp;#x6587;&amp;#x20dd;</code> 为 文⃝</p></li><li><p>组合用半形符号（<span class="exturl" data-url="aHR0cHM6Ly91bmljb2RlLm9yZy9jaGFydHMvUERGL1VGRTIwLnBkZg==">Combining HalfMarks<i class="fa fa-external-link-alt"></i></span>）：区间从 <code>U+FE20</code> 到 <code>U+FE2F</code> 共 16字。</p><p>多个附加字符可以叠加到一个基础字符上. 例如<code>&amp;#xFE20;&amp;#xFE2D;&amp;#x61;</code> 为 ︭︠a</p></li></ul><p>组合字符也可以用于 Emoji, 例如 <code>&amp;#x270B;</code> 为✋, <code>&amp;#x270B;&amp;#x1F3FB;</code> 为 ✋🏻</p><h1 id="零宽字符">零宽字符</h1><p>零宽字符不可见，不可打印，主要作用于调整字符的显示格式.</p><p><strong>零宽字符主要有以下几类：</strong></p><ul><li>零宽度空格符 (zero-width space) U+200B : 用于较长单词的换行分隔</li><li>零宽度非断空格符 (zero width no-break space) U+FEFF :用于阻止特定位置的换行分隔</li><li>零宽度连字符 (zero-width joiner) U+200D :用于阿拉伯文与印度语系等文字中，使不会发生连字的字符间产生连字效果</li><li>零宽度断字符 (zero-width non-joiner) U+200C :用于阿拉伯文，德文，印度语系等文字中，阻止会发生连字的字符间的连字效果</li><li>左至右符 (left-to-right mark) U+200E :用于在混合文字方向的多种语言文本中（例：混合左至右书写的英语与右至左书写的希伯来语），规定排版文字书写方向为左至右</li><li>右至左符 (right-to-left mark) U+200F :用于在混合文字方向的多种语言文本中，规定排版文字书写方向为右至左</li></ul><p><strong>零宽字符可以用于:</strong></p><ul><li>数据防爬:将零宽度字符插入文本中，干扰关键字匹配。爬虫得到的带有零宽度字符的数据会影响他们的分析，但不会影响用户的阅读数据。</li><li>信息传递:将自定义组合的零宽度字符插入文本中，用户复制后会携带不可见信息，达到传递作用。</li><li>传递隐密信息:利用零宽度字符不可见的特性，我们可以用零宽度字符在任何未对零宽度字符做过滤的网页内插入不可见的隐形文本。下面是一个简单的利用零宽度字符对文本进行加密/解密的</li><li>隐形水印:通过零宽度字符我们可以对内部文件添加隐形水印。在浏览者登录页面对内部文件进行浏览时，我们可以在文件的各处插入使用零宽度字符加密的浏览者信息，如果浏览者又恰好使用复制粘贴的方式在公共媒体上匿名分享了这个文件，我们就能通过嵌入在文件中的隐形水印轻松找到分享者了。</li><li>加密信息分享:通过零宽度字符我们可以在任何网站上分享任何信息。敏感信息的审核与过滤在当今的互联网社区中扮演着至关重要的角色，但是零宽度字符却能如入无人之境一般轻松地穿透这两层信息分享的屏障。对比明文哈希表加密信息的方式，零宽度字符加密在网上的隐蔽性可以说是达到了一个新的高度。仅仅需要一个简单的识别/解密零宽度字符的浏览器插件，任何网站都可以成为信息分享的游乐场。</li><li>逃脱敏感词过滤:通过零宽度字符我们可以轻松逃脱敏感词过滤。敏感词自动过滤是维持互联网社区秩序的一项重要工具，只需倒入敏感词库和匹配相应敏感词，即可将大量的非法词汇拒之门外。使用谐音与拼音来逃脱敏感词过滤会让语言传递信息的效率降低，而使用零宽度字符可以在逃脱敏感词过滤的同时将词义原封不动地传达给接受者，大大提高信息传播者与接受者之间交流的效率。<strong>开发时只过滤<code>\u200b</code></strong> 就够了</li></ul><h2 id="emoji-中的零宽字符">Emoji 中的零宽字符</h2><p>零宽字符可以用于 Emoji 的组合, 例如</p><ul><li><p>在构建 👨🏻‍🦳 时</p><ul><li>👨🏻‍🦳 为<code>&amp;#x1F468;&amp;#x1F3FB;&amp;#x200D;&amp;#x1F9B3;</code></li><li>👨🏻‍ 为 <code>&amp;#x1F468;&amp;#x1F3FB;&amp;#x200D;</code></li><li>👨🏻 为 <code>&amp;#x1F468;&amp;#x1F3FB;</code></li><li>👨 为 <code>&amp;#x1F468;</code></li></ul><p>其中</p><ul><li>👨 - U+1F468 - 基础字符</li><li>🏻 - U+1F3FB - 组合字符，表示肤色</li><li><ul><li>U+200D - <strong>零宽度连字符</strong>，表示上下相连</li></ul></li><li>🦳 - U+1F9B3 - 基础字符，表示发型</li></ul><p>零字宽字符连接了发型与颜色</p></li><li><p>👩‍❤‍👨 为<code>&amp;#x1F469;&amp;#x200D;&amp;#x2764;&amp;#x200D;&amp;#x1F468;</code>,其中</p><ul><li>👩 - U+1F469 - 基础字符</li><li><ul><li>U+200D - 零宽度连字符，表示上下相连</li></ul></li><li>❤ - U+2764 - 基础字符</li><li><ul><li>U+200D - 零宽度连字符，表示上下相连</li></ul></li><li>👨 - U+1F468 - 基础字符</li></ul></li><li><p>👩‍👩‍👦‍👦 为<code>&amp;#x1F469;&amp;#x200D;&amp;#x1F469;&amp;#x200D;&amp;#x1F466;&amp;#x200D;&amp;#x1F466;</code>,其中</p><ul><li>👩 - U+1F469 - 基础字符</li><li><ul><li>U+200D - 零宽度连字符，表示上下相连</li></ul></li><li>👩 - U+1F469 - 基础字符</li><li><ul><li>U+200D - 零宽度连字符，表示上下相连</li></ul></li><li>👦 - U+1F466 - 基础字符</li><li><ul><li>U+200D - 零宽度连字符，表示上下相连</li></ul></li><li>👦 - U+1F466 - 基础字符</li></ul></li></ul>]]></content>
    
    
    <summary type="html">闲来无事仔细了解一下 Unicode 编码规则, 并尝试实现一些 &amp;#x6709;&amp;#3655;&amp;#3655;&amp;#3655;&amp;#3655;&amp;#3662;&amp;#3662;&amp;#3662;&amp;#3662;&amp;#3657;&amp;#3657;&amp;#3657;&amp;#3657;&amp;#x8da3;&amp;#3657;&amp;#3657;&amp;#3657;&amp;#3657;&amp;#3655;&amp;#3655;&amp;#3655;&amp;#3655;&amp;#3662;&amp;#3662;&amp;#3662;&amp;#3662;的&amp;#x7279;&amp;#x20dd; &amp;#x0333;&amp;#x0333;&amp;#x308;&amp;#x303;&amp;#x6548;&amp;#x200b;&amp;#x0333;&amp;#x0333;&amp;#x308;&amp;#x303;</summary>
    
    
    
    <category term="瞎折腾" scheme="https://blog.liukairui.me/categories/%E7%9E%8E%E6%8A%98%E8%85%BE/"/>
    
    <category term="编码规范" scheme="https://blog.liukairui.me/categories/%E7%9E%8E%E6%8A%98%E8%85%BE/%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/"/>
    
    
    <category term="编码规范" scheme="https://blog.liukairui.me/tags/%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/"/>
    
    <category term="Unicode" scheme="https://blog.liukairui.me/tags/Unicode/"/>
    
  </entry>
  
  <entry>
    <title>WebRTC基础</title>
    <link href="https://blog.liukairui.me/article/WebRTC%E5%9F%BA%E7%A1%80/"/>
    <id>https://blog.liukairui.me/article/WebRTC%E5%9F%BA%E7%A1%80/</id>
    <published>2022-12-03T16:00:01.000Z</published>
    <updated>2022-12-03T16:00:01.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="webrtc-是什么">WebRTC 是什么</h2><p><strong>WebRTC 是什么</strong></p><ul><li>WebRTC(Web Real-Time Communication)是一套旨在实现互联网浏览器之间实时通讯的免费开放API.</li><li>WebRTC 主要包含了两种不同的技术: 媒体捕获设备和点对点连接</li></ul><p><strong>WebRTC 不是什么</strong></p><ul><li><p>WebRTC 用于实现实时数据双向通讯,但不适用于直播等大规模单向数据分发.</p><p>由于需要做到双向数据传播, 所有用户需要连接到同一个服务器,即使像声网这样的企业级 SDK 也只能做到 32 人实时连麦,百万同时在线(单向数据分发).</p><p>直播(RTMP, Real Time Messaging Protocol)只需要做到单向数据传输,我们可以部署大量服务器与 CDN 实现大规模数据分发.</p></li><li><p>WebRTC 不是 Web 应用专有的, 其可以运行在浏览器, 桌面应用,移动设备与 IoT 设备上</p></li></ul><p><strong>WebRTC 组成</strong></p><figure><img src="./img/1-1.png" alt="WebRTC Architecture" /><figcaption aria-hidden="true">WebRTC Architecture</figcaption></figure><p>WebRTC 是一套 API, 可以根据 API 的使用对象分为</p><ul><li>Web 开发者需要使用的: W3C 定义的 WebAPI</li><li>浏览器厂商需要实现的: WebRTC 的 C++ 层, 实现了 W3C 定义的WebAPI</li><li>浏览器厂商可以自定义重写的: 音视频捕获播放与网络IO</li><li>WebRTC 实现核心模块<ul><li>会话管理: 用来管理音视频, 非音视频数据传输, 处理相关逻辑.</li><li>音频引擎: 编解码功能, 音频缓冲 buffer, 回音消除.</li><li>视频引擎: 视频编解码器, 视频缓冲 buffer, 图像增强.</li><li>数据传输: SRTP传输协议, 多流复用, P2P.</li></ul></li></ul><p>## WebRTC 通话原理</p><ul><li><p>媒体协商: 在通信前需要先使用会话描述协议(SDP, session descriptionprotocol)通报通信终端支持的编解码格式,并确定出一个共有的编解码格式用于通信.</p></li><li><p>网络协商: 在通信前要找到一条可以相互通讯的链路.将网络协商所需的信息称为 candidate</p><ul><li><p>在没有 NAT 时, 可以直接通过公网 IP 实现 P2P 连接</p></li><li><p>在存在 NAT 时, 可以通过端口映射连接则使用端口映射实现 P2P.</p><p>由于通信终端不知道自己在 NAT 转换后映射的端口, 通信终端将请求 STUN服务器, STUN 返回该终端的外网 IP 与端口.</p></li><li><p>若端口映射(打洞)失败, 中断将连接到 TURN 服务器, TURN服务器作为中继服务器负责之后通信</p></li></ul><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NvdHVybi9jb3R1cm4=">coturn<i class="fa fa-external-link-alt"></i></span> 是一个开源的STUN 与 TURN 服务器实现</p></li><li><p>信令服务器: 一套包含媒体协商与网络协商的服务器实现,在实现两种协商的基础上还应该实现其他管理功能(如: 房间管理, 用户管理,用户校验...). <strong>信令服务器并非需要实现一套固定的标准 /API</strong>, 只需要按需开发即可. 以一对一通信为例</p><p><img src="./img/1-2.png" /></p><p><strong>连接</strong></p><ul><li>连接双方与信令服务器建立连接(不指定连接协议),先连接设备作为房主</li><li>双方获取自己的媒体流</li><li>双方加入房间, 先加入者为房主, 后进入者加入后信令服务器通知房主,同时将房主信息返回给加入者</li></ul><p><strong>媒体协商</strong></p><ul><li>房主创建 RTCPeerConnection, 绑定 onXX 回调</li><li>房主创建 Track (相当于本地媒体流的句柄以供对方将来使用)</li><li>房主创建 offer, 生成浏览器的 SDP</li><li>房主发送 SDP(offer) 到信令服务器, 信令服务器将 offer 转发给对方</li><li>对方创建 RTCPeerConnection, 绑定 onXX 回调</li><li>对方创建 Track, 通过对方 track 获取房主码流句柄</li><li>对方记录房主的 SDP, 生成自己的 answer, 生成自己的 SDP</li><li>对方发送 answer 到信令服务器, 信令服务器将 answer 转发给房主</li><li>房主记录对方的 SDP</li></ul><p><strong>网络协商</strong></p><ul><li>房主与对方同时发起网络协商, 发起 ICE 请求到 coturn 服务器, coturn服务器返回 Candidate.</li><li>双方将 Candidate 通过信令服务器发送给另一方</li><li>另一方记录 Candidate 并尝试发起连接</li><li>由于打洞地址可能变化, 所以某一方可能会收到多个 Candidate,其应该逐个尝试直到成功连接</li></ul><p><strong>离开房间</strong></p><ul><li>离开者发起离开房间命令, 信令服务器删除用户并通知对方</li></ul><p>从这个过程中我们也可以看到, WebRTC 只是提供了一套 API并没有提供实时通信的详细实现,详细通信逻辑还需要信令服务器设计者实现</p></li></ul><h2 id="webrtc-相关协议">WebRTC 相关协议</h2><h3 id="rtp-协议">RTP 协议</h3><p>我们一般不直接将音视频数据流通过 UDP 传输,这是因为音视频数据中一帧数据量远大于 UDP 的MTU, 在发送时需要拆成多个包.若直接通过 UDP 传输, 我们需要手动维护 UDP 包的顺序并重建帧. RTP协议实现了音视频传输对帧的维护.</p><p>RTP(Real-time <strong>Transport</strong> Protocol)实时<strong>传输</strong>协议为端到端的实时传输提供时间信息和流同步,RTP并不保证服务质量, 服务质量由RTCP来提供.</p><p>RTP协议格式:</p><pre class="line-numbers language-none"><code class="language-none"> 0                   1                   2                   3 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+|V&#x3D;2|P|X|  CC   |M|     PT      |       sequence number         |+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+|                           timestamp                           |+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+|           synchronization source (SSRC) identifier            |+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+|            contributing source (CSRC) identifiers             ||                             ....                              |+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol type="1"><li><p>V: RTP协议的版本号, 占2位, 当前协议版本号为2.</p></li><li><p>P: 填充标志, 占1位, 如果P=1,则在该报文的尾部填充一个或多个额外的八位组,它们不是有效载荷的一部分.</p></li><li><p>X: 扩展标志, 占1位, 如果X=1,则在RTP报头后跟有一个扩展报头.</p></li><li><p>CC: CSRC 计数器, 占4位, 指示 CSRC 标识符的个数.</p></li><li><p>M: 标记, 占1位, 不同的有效载荷有不同的含义, 对于视频,标记一帧的结束；对于音频, 标记会话的开始.</p></li><li><p>PT: 有效载荷类型, 占7位, 用于说明RTP报文中有效载荷的类型,如GSM音频、JPEM图像等,在流媒体中大部分是用来区分音频流和视频流的,这样便于客户端进行解析. 可以通过payload值知道音频的类型, 视频的类型,有些公司可能会使用PT值扩展自己的类型；譬如附加类型(字幕, 贴的小图片,画的框框)</p></li><li><p>序列号: 占16位, 用于标识发送者所发送的RTP报文的序列号,每发送一个报文, 序列号增1. 这个字段当下层的承载协议用UDP的时候,网络状况不好的时候可以用来检查丢包.同时出现网络抖动的情况可以用来对数据进行重新排序,在helix服务器中这个字段是从0开始的,同时音频包和视频包的sequence是分别记数的.</p></li><li><p>时戳(Timestamp): 占32位,时戳反映了该RTP报文的第一个八位组的采样时刻.接收者使用时戳来计算延迟和延迟抖动, 并进行同步控制.</p></li><li><p>同步信源(SSRC)标识符: 占32位, 用于标识同步信源.该标识符是随机选择的,参加同一视频会议的两个同步信源不能有相同的SSRC.</p></li><li><p>特约信源(CSRC)标识符: 每个CSRC标识符占32位, 可以有0～15个.每个CSRC标识了包含在该RTP报文有效载荷中的所有特约信源.</p><p>如果扩展标志被置位则说明紧跟在报头后面是一个头扩展, 其格式如下:</p><pre class="line-numbers language-none"><code class="language-none">0                   1                   2                   30 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+|      defined by profile       |           length              |+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+|                        header extension                       ||                             ....                              |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="rtcp-协议">RTCP 协议</h3><p>RTCP(RTP <strong>Control</strong>Protocol)实时传输<strong>控制</strong>协议, 同RTP一起用于数据传输的监视,控制功能.</p><p>当应用程序启动一个 RTP 会话时将同时占用两个端口, 分别供 RTP 和 RTCP使用. RTP 本身并不能为按序传输数据包提供可靠的保证,也不提供流量控制和拥塞控制, 这些都由 RTCP 来负责完成. 通常 RTCP 会采用与RTP 相同的分发机制, 向会话中的所有成员周期性地发送控制信息,应用程序通过接收这些数据, 从中获取会话参与者的相关资料,以及网络状况、分组丢失概率等反馈信息,从而能够对服务质量进行控制或者对网络状况进行诊断.</p><p>RTCP协议的功能是通过不同的RTCP数据报来实现的, 主要有如下几种类型:</p><ol type="1"><li><strong>SR</strong>: 发送端报告,所谓发送端是指发出RTP数据报的应用程序或者终端, 发送端同时也可以是接收端.(SERVER定时间发送给CLIENT).</li><li><strong>RR</strong>: 接收端报告,所谓接收端是指仅接收但不发送RTP数据报的应用程序.</li><li>SDES: 源描述, 主要功能是作为会话成员有关标识信息的载体,如用户名、邮件地址、电话号码等,此外还具有向会话成员传达会话控制信息的功能.</li><li>BYE: 通知离开, 主要功能是指示某一个或者几个源不再有效,即通知会话中的其他成员自己将退出会话.</li><li>APP: 由应用程序自己定义, 解决了RTCP的扩展性问题,并且为协议的实现者提供了很大的灵活性.</li></ol><p>RTCP 协议通过 RR 和 SR 报文交换来获取自己的网络质量, 结构为</p><pre class="line-numbers language-none"><code class="language-none">        0                   1                   2                   3        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+header |V&#x3D;2|P|    RC   |   PT&#x3D;SR&#x3D;200   |             length            |       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+       |                         SSRC of sender                        |       +&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+sender |              NTP timestamp, most significant word             |info   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+       |             NTP timestamp, least significant word             |       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+       |                         RTP timestamp                         |       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+       |                     sender&#39;s packet count                     |       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+       |                      sender&#39;s octet count                     |       +&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+report |                 SSRC_1 (SSRC of first source)                 |block  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  1    | fraction lost |       cumulative number of packets lost       |       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+       |           extended highest sequence number received           |       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+       |                      interarrival jitter                      |       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+       |                         last SR (LSR)                         |       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+       |                   delay since last SR (DLSR)                  |       +&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+report |                 SSRC_2 (SSRC of second source)                |block  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  2    :                               ...                             :       +&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+&#x3D;+       |                  profile-specific extensions                  |       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>SR 包使用了</p><ul><li>版本(V): 同RTP包头域.</li><li>填充(P): 同RTP包头域.</li><li>接收报告计数器(RC): 5比特, 该SR包中的接收报告块的数目,可以为零.</li><li>包类型(PT): 8比特, SR包是200.</li><li>长度域(Length): 16比特,其中存放的是该SR包以32比特为单位的总长度减一.</li><li>同步源(SSRC of sender): SR包发送者的同步源标识符.与对应RTP包中的SSRC一样.</li><li>NTP Timestamp(Network time protocol) SR包发送时的绝对时间值.NTP的作用是同步不同的RTP媒体流.</li><li>RTP Timestamp: 与NTP时间戳对应,与RTP数据包中的RTP时间戳具有相同的单位和随机初始值.</li><li>Sender’s packet count: 从开始发送包到产生这个SR包这段时间里,发送者发送的RTP数据包的总数. SSRC改变时, 这个域清零.</li><li>Sender`s octet count: 从开始发送包到产生这个SR包这段时间里,发送者发送的净荷数据的总字节数(不包括头部和填充) . 发送者改变其SSRC时,这个域要清零.</li><li>同步源n的SSRC标识符:该报告块中包含的是从该源接收到的包的统计信息.</li><li>丢失率(Fraction Lost):表明从上一个SR或RR包发出以来从同步源n(SSRC_n)来的RTP数据包的丢失率.</li><li>累计的包丢失数目:从开始接收到SSRC_n的包到发送SR,从SSRC_n传过来的RTP数据包的丢失总数.</li><li>收到的扩展最大序列号: 从SSRC_n收到的RTP数据包中最大的序列号,</li><li>接收抖动(Interarrival jitter): RTP数据包接受时间的统计方差估计</li><li>上次SR时间戳(Last SR,LSR):取最近从SSRC_n收到的SR包中的NTP时间戳的中间32比特. 如果目前还没收到SR包,则该域清零.</li><li>上次SR以来的延时(Delay since last SR,DLSR):上次从SSRC_n收到SR包到发送本报告的延时.</li></ul><h3 id="标准-sdp-协议">标准 SDP 协议</h3><p>SDP 描述了</p><ol type="1"><li>音频编解码器是什么,这些编解码器设定的参数是什么</li><li>使用的传输协议是什么</li><li>以及包括的音视频媒体是什么</li></ol><p>标准 SDP 规范主要包括 <strong>SDP 描述格式和 SDP 结构</strong>, 而SDP 结构由<strong>会话描述和媒体信息描述</strong>两个部分组成.其中,媒体信息描述包括了:</p><ul><li>媒体类型</li><li>媒体格式</li><li>传输协议</li><li>传输的 IP 和端口</li></ul><p><strong>SDP 由一个会话级描述(session leveldescription)和多个媒体级描述(media level description)组成</strong></p><ul><li>会话级(session level)的作用域是整个会话,其位置是从 v=行开始到第一个媒体描述为止。<ul><li><code>v=</code> (protocol version): SDP 的版本号</li><li><code>o=&lt;username&gt; &lt;session id&gt; &lt;version&gt; &lt;network type&gt; &lt;address type&gt; &lt;address&gt;</code>表示的是对会话发起者的描述, 格式为<ul><li><code>&lt;username&gt;</code>:用户名,当不关心用户名时,可以用 “-”代替</li><li><code>&lt;session id&gt;</code>:数字串,在整个会话中,必须是唯一的,建议使用NTP 时间戳</li><li><code>&lt;version&gt;</code>:版本号,每次会话数据修改后,该版本值会递增</li><li><code>&lt;network type&gt;</code>:网络类型,一般为“IN”,表示“internet”</li><li><code>&lt;address type&gt;</code>: 地址类型,一般为 IP4</li><li><code>&lt;address&gt;</code>:IP 地址</li></ul></li><li><code>s=&lt;session name&gt;</code>, 表示一个会话, 在整个 SDP中有且只有一个会话</li><li><code>t=&lt;start time&gt; &lt;stop time&gt;</code> (time thesession is active)。描述了会话的开始时间和结束时间。其中,<code>&lt;start time&gt;</code> 和 <code>&lt;stop time&gt;</code> 为 NTP时间,单位是秒;当 <code>&lt;start time&gt;</code> 和<code>&lt;stop time&gt;</code> 均为零时,表示持久会话。</li></ul></li><li>媒体级(media level)是对单个的媒体流进行描述,其位置是从 m=行开始到下一个媒体描述(即下一个 m=)为止。<ul><li><code>m=&lt;media&gt; &lt;port&gt; &lt;transport&gt; &lt;fmt list&gt;</code>(media name and transport address): 表示一个会话<ul><li><code>&lt;media&gt;</code>: 媒体类型,比如 audio/video 等;</li><li><code>&lt;port&gt;</code>: 端口;</li><li><code>&lt;transport&gt;</code>: 传输协议,有两种——RTP/AVP 和UDP;</li><li><code>&lt;fmt list&gt;</code>: 媒体格式,即数据负载类型 (PayloadType) 列表。</li></ul></li><li><code>a=&lt;TYPE&gt;[:&lt;VALUES&gt;]</code>(zero or more mediaattribute lines): 用于进一步描述媒体信息, 常见的有 <code>rtpmap</code>与 <code>fmtp</code><ul><li><code>a=rtpmap:&lt;payload type&gt; &lt;encoding name&gt;/&lt;clock rate&gt; [/&lt;encodingparameters&gt;]</code>:RTP 参数映射表<ul><li><code>&lt;payload type&gt;</code> : 负载类型,对应 RTP包中的音视频数据负载类型。</li><li><code>&lt;encoding name&gt;</code>: 编码器名称,如 VP8、VP9、OPUS等。</li><li><code>&lt;sample rate&gt;</code>: 采样率,如音频的采样率频率32000、48000 等。</li><li><code>&lt;encodingparameters&gt;</code>:编码参数,如音频是否是双声道,默认为单声道。</li></ul></li><li><code>a=fmtp:&lt;payload type&gt; &lt;format specific parameters&gt;</code>:表示格式参数<ul><li><code>&lt;payload type&gt;</code>: 负载类型,同样对应 RTP包中的音视频数据负载类型</li><li><code>&lt;format specific parameters&gt;</code>: 指具体参数。</li></ul></li></ul></li></ul></li></ul><pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; 会话级v&#x3D;0o&#x3D;‐ 7017624586836067756 2 IN IP4 127.0.0.1s&#x3D;‐t&#x3D;0 0&#x2F;&#x2F; 媒体级: 一个音频,一个视频。m&#x3D;audio 9 UDP&#x2F;TLS&#x2F;RTP&#x2F;SAVPF 111 103 104 9 0 8 106 105 13 126...m&#x3D;video 9 UDP&#x2F;TLS&#x2F;RTP&#x2F;SAVPF 96 97 98 99 100 101 102 122 127 121 125 107 108 109 124 120 123119 114 115 116...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="webrtc-的-sdp">WebRTC 的 SDP</h3><p>WebRTC 对 SDP 标准做了调整, 可以将 SDP 按功能分成几大块:</p><ul><li>Session Metadata,会话元数据</li><li>Network Description,网络描述</li><li>Stream Description,流描述</li><li>Security Descriptions,安全描述</li><li>Qos Grouping Descriptions, 服务质量描述</li></ul><pre class="line-numbers language-none"><code class="language-none">                                                +---------------------+                                                |        v&#x3D;           |                                                +---------------------+                +---------------------+         +---------------------+        &#x3D;&#x3D;&#x3D;&#x3D;    |   Session Metadata  |  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;  |        o&#x3D;           |        |       +---------------------+         +----------------------        |                                       +---------------------+        |                                       |        t&#x3D;           |        |                                       +---------------------+        |        |        |                                       +---------------------+        |                                       |        c&#x3D;           |        |                                       +---------------------+        |       +---------------------+        &#x3D;&#x3D;&#x3D;&#x3D;    | Network Description |   &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;        |       +---------------------+        |                                       +---------------------+        |                                       |    a&#x3D;candidate      |        |                                       +---------------------+        |        |        |                                       +---------------------+        |                                       |        m&#x3D;           |        |                                       +---------------------+        |        +---------------------+        +---------------------+        &#x3D;&#x3D;&#x3D;&#x3D;     | Stream Description  |  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D; |      a&#x3D;rtpmap       |        |        +---------------------+        +----------------------        |                                       +---------------------+        |                                       |      a&#x3D;fmtp         |        |                                       +---------------------+        |                                       +---------------------+        |                                       |      a&#x3D;sendrecv..   |        |                                       +---------------------++---------------+|    SEMANTIC   || COMPONENTS OF ||     SDP       |+---------------+        |                                       +---------------------+        |                                       |      a&#x3D;crypto       |        |                                       +---------------------+        |         +---------------------+       +---------------------+        &#x3D;&#x3D;&#x3D;&#x3D;      |Security Descriptions|  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;|      a&#x3D;ice-frag     |        |         +---------------------+       +----------------------        |                                       +---------------------+        |                                       |      a&#x3D;ice-pwd      |        |                                       +---------------------+        |                                       +---------------------+        |                                       |     a&#x3D;fingerprint   |        |                                       +---------------------+        |        |        |        |                                       +---------------------+        |                                       |      a&#x3D;rtcp-fb      |        |                                       +---------------------+        |         +---------------------+       +---------------------+        &#x3D;&#x3D;&#x3D;&#x3D;      |   Qos,Grouping      |       |                     |                  |   Descriptions      |  &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;|       a&#x3D;group       |                  +---------------------+       +----------------------                                                +---------------------+                                                |       a&#x3D;rtcpmux     |                                                +---------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>安全描述与服务质量描述是新增的属性描述, 例如</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; 安全描述 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x2F;&#x2F; 进入连通性检测的用户名a&#x3D;ice‐ufrag:1uEe &#x2F;&#x2F; 密码,这两个是用于连通性检测的凭证a&#x3D;ice‐pwd:RQe+y7SOLQJET+duNJ+Qbk7z&#x2F;&#x2F;DTLS 指纹认证,以识别是否是合法用户a&#x3D;fingerprint:sha‐256 35:6F:40:3D:F6:9B:BA:5B:F6:2A:7F:65:59:60:6D:6B:F9:C7:AE:46:44:B4:E4:73:F8:60:67:4D:58:E2:EB:9C ...&#x2F;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; 服务质量描述 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;a&#x3D;rtcp‐muxa&#x3D;rtcp‐rsizea&#x3D;rtpmap:96 VP8&#x2F;90000a&#x3D;rtcp‐fb:96 goog‐remb &#x2F;&#x2F; 使用 google 的带宽评估算法a&#x3D;rtcp‐fb:96 transport‐cc &#x2F;&#x2F; 启动防拥塞a&#x3D;rtcp‐fb:96 ccm fir &#x2F;&#x2F; 解码出错,请求关键帧a&#x3D;rtcp‐fb:96 nack&#x2F;&#x2F; 启用丢包重传功能a&#x3D;rtcp‐fb:96 nack pli &#x2F;&#x2F; 与 fir 类似<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="candidate">Candidate</h3><p>在网络协商中 Candidate(候选人) 用于传递网络信息, Candidate 并不唯一(例如: 一个 peer 可能因为有多张网卡对外提供多个 Candidate). 面对多个Candidate 其他 peer 会优先尝试本地地址(内网地址), 再尝试映射地址,最后尝试使用中继服务连接.</p><p>在进行 P2P 连接时, WebRTC 将尝试 <strong>NAT打洞(P2P穿越)</strong>在打洞前, WebRTC 会先判断 NAT 类型, 然后再打洞. NAT 类型有</p><ul><li><p>Full Cone NAT（完全锥型NAT）</p><p>所有从同一个私网IP地址和端口（IP1:Port1）发送过来的请求都会被映射成同一个公网IP地址和端口（IP:Port）.并且, 任何外部主机通过向映射的公网IP地址和端口发送报文,都可以实现和内部主机进行通信.</p><p>这是一种比较宽松的策略,只要建立了私网IP地址和端口与公网IP地址和端口的映射关系,所有的Internet上的主机都可以访问该NAT之后的主机.</p></li><li><p>Restricted Cone NAT（限制锥型NAT）</p><p>所有从同一个私网IP地址和端口（IP1:Port1）发送过来的请求都会被映射成同一个公网IP和端口号（IP:Port）.与完全锥型NAT不同的是, 当且仅当内部主机之前已经向公网主机发送过报文,此时公网主机才能向私网主机发送报文.</p></li><li><p>Port Restricted Cone NAT（端口限制锥型NAT）</p><p>与限制锥型NAT很相似, 只不过它包括端口号. 也就是说,一台公网主机（IP2:Port2）想给私网主机发送报文,必须是这台私网主机先前已经给这个IP地址和端口发送过报文.</p></li><li><p>Symmetric NAT（对称NAT）</p><p>所有从同一个私网IP地址和端口发送到一个特定的目的IP地址和端口的请求,都会被映射到同一个IP地址和端口.如果同一台主机使用相同的源地址和端口号发送报文, 但是发往不同的目的地,NAT将会使用不同的映射. 此外,只有收到数据的公网主机才可以反过来向私网主机发送报文.</p><p>这和端口限制锥型NAT不同,端口限制锥型NAT是所有请求映射到相同的公网IP地址和端口,而对称NAT是不同的请求有不同的映射.</p></li></ul><h2 id="调用本地媒体设备">调用本地媒体设备</h2><p>可以通过<code>navigator.mediaDevices.getUserMedia(constraints)</code>获取本地媒体信息 (<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvQVBJL01lZGlhRGV2aWNlcy9nZXRVc2VyTWVkaWE=">MDN<i class="fa fa-external-link-alt"></i></span>),其中</p><ul><li><p><code>constraints = &#123; audio: true, video: true &#125;</code>,分别控制是否获取视频与音频.</p></li><li><p>更多用法</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">constraints <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">audio</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token literal-property property">video</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">1280</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">720</span> <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>constraints <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">audio</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token literal-property property">video</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token literal-property property">ideal</span><span class="token operator">:</span> <span class="token number">1280</span><span class="token punctuation">,</span> <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">1920</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">776</span><span class="token punctuation">,</span> <span class="token literal-property property">ideal</span><span class="token operator">:</span> <span class="token number">720</span><span class="token punctuation">,</span> <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">1080</span> <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>constraints <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">audio</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token literal-property property">video</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">ideal</span><span class="token operator">:</span> <span class="token number">1280</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// 理想值</span>        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">ideal</span><span class="token operator">:</span> <span class="token number">720</span> <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>可以指定视频大小, 但是对浏览器版本要求高</p></li><li><p>该方法的返回值是 promise, 成功后传入媒体流, 失败传入错误信息,常见的失败有 <code>NotReadableError</code> 该错误会发生在 video源被占用时</p></li></ul><p><strong>在浏览器显示本地声音与视频</strong></p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video<span class="token punctuation">"</span></span> <span class="token attr-name">controls</span> <span class="token attr-name">autoplay</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>开始捕获<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">    <span class="token keyword">function</span> <span class="token function">getLocalVideo</span><span class="token punctuation">(</span><span class="token parameter">videoElem</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      navigator<span class="token punctuation">.</span>mediaDevices        <span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token comment">// 开启音视频</span>          <span class="token literal-property property">video</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>          <span class="token literal-property property">audio</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">stream</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>videoElem<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> stream<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 成功后将返回流写入 video</span>        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 失败输出原因</span>    <span class="token punctuation">&#125;</span>    document      <span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>        <span class="token string">'click'</span><span class="token punctuation">,</span>        <span class="token function">getLocalVideo</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'video'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">因为疑似要被转岗到 WebRTC 相关岗位, 简单学一下相关知识(面向 JD 的编程了属于是)</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="WebRTC" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/WebRTC/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="WebRTC" scheme="https://blog.liukairui.me/tags/WebRTC/"/>
    
    <category term="WebSocket" scheme="https://blog.liukairui.me/tags/WebSocket/"/>
    
  </entry>
  
  <entry>
    <title>一点设计原则</title>
    <link href="https://blog.liukairui.me/article/%E4%B8%80%E7%82%B9%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/"/>
    <id>https://blog.liukairui.me/article/%E4%B8%80%E7%82%B9%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/</id>
    <published>2022-11-06T16:00:00.000Z</published>
    <updated>2022-11-06T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="单一职责原则">单一职责原则</h2><blockquote><p>一个对象 / 方法只做一件事(只有一个引起他变化的原因)</p></blockquote><p>一件事是逻辑上的一件事, 不是一个函数(比如创建 xhr 与发送 xhr完全可以放一起)</p><p><strong>应用</strong></p><ul><li><p>代理模式的单一功能</p></li><li><p>迭代器模式迭代与执行分离</p></li><li><p>单例模式中工厂方法与传入方法分离</p></li><li><p>装饰者模式动态添加单一职责</p></li><li><p>优点: 降低对象粒度, 降低单个类 / 对象复杂度,提升对象可复用性</p></li><li><p>缺点: 增加代码复杂度</p></li></ul><h2 id="最少知识原则狄米特法则">最少知识原则(狄米特法则)</h2><blockquote><p>尽量提供简单的接口, 减少对象之间的交互, 从而减小类之间的耦合</p></blockquote><p><strong>应用</strong></p><ul><li>中介者模式</li><li>封装</li></ul><h2 id="开放-封闭原则">开放-封闭原则</h2><blockquote><p>软件实体(类, 模块, 函数)应该是可扩展的,但<strong>不可修改</strong></p></blockquote><p><strong>应用</strong></p><ul><li>发布订阅模式</li><li>模板方法模式</li><li>策略模式</li><li>代理模式</li><li>职责链模式</li></ul><p><strong>如何开放</strong></p><ul><li>通过回调</li><li>通过钩子控制宏观流程</li><li>找到容易变化的地方, 通过多态将变化的部分封装入多态</li></ul><h2 id="里氏替换原则">里氏替换原则</h2><blockquote><p>如果对每一个类型为 S 的对象 o1, 都有类型为 T 的对象 o2, 使得以 T定义的所有程序 P 在所有的对象 o1 都代替 o2 时, 程序 P的行为没有发生变化, 那么类型 S 是类型 T 的子类型.</p></blockquote><blockquote><p>通俗点讲, 就是只要父类能出现的地方, 子类就可以出现,而且替换为子类也不会产生任何错误或异常.</p></blockquote><ul><li>子类必须完全实现父类的方法</li><li>子类可以有自己的个性</li><li>覆盖或实现父类的方法时, 输入参数可以被放大</li><li>覆盖或实现父类的方法时, 输出结果可以被缩小</li></ul><h2 id="依赖倒置原则面向接口编程">依赖倒置原则(面向接口编程)</h2><blockquote><p>高层模块不应该依赖于低层模块, 而应该依赖于抽象. 抽象不应依赖于细节,细节应依赖于抽象</p></blockquote><ol type="1"><li>模块间的依赖通过抽象发生, 实现类之间不直接发生依赖关系,其依赖关系是通过接口或抽象类产生的</li><li>接口或抽象类不依赖于实现类</li><li>实现类依赖接口或抽象类</li></ol><p>即</p><ul><li>每个类尽量都有接口或抽象类，或者接口和抽象类两者都具备。</li><li>变量的表面类型尽量是接口或抽象类。</li><li>任何类都不应该从具体类派生。</li><li>尽量不要重写基类的方法。如果基类是一个抽象类，而且这个方法已经实现了，子类尽量不要重写。</li></ul><h2 id="接口隔离原则">接口隔离原则</h2><blockquote><p>不要对外暴露没有实际意义的接口</p></blockquote><h2 id="重构原则">重构原则</h2><ul><li><strong>抽离函数原则</strong><ul><li>当函数过于臃肿时</li><li>独立部分可以被复用</li><li>独立出的函数拥有更好的命名(语义)</li><li>独立出的函数可以被重载(重写)</li></ul></li><li>对于条件分支<ul><li>尝试将条件抽离为函数以提高语义</li><li>提取重复部分而不是在每个分支都执行</li></ul></li><li>对于较长的硬编码<ul><li>使用循环完成硬编码</li></ul></li><li>对于函数参数<ul><li>尽量减少参数数目</li><li>参数数目过多可以采用对象传入而不是传入参数列表</li></ul></li><li>链式调用不利于调试, 应该将其应用于逻辑稳定的场景</li><li>使用函数代替冗长的 <code>if-else</code></li></ul>]]></content>
    
    
    <summary type="html">随手记一些设计原则吧~</summary>
    
    
    
    <category term="计算机理论" scheme="https://blog.liukairui.me/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%90%86%E8%AE%BA/"/>
    
    <category term="设计模式" scheme="https://blog.liukairui.me/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%90%86%E8%AE%BA/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
    <category term="计算机理论" scheme="https://blog.liukairui.me/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%90%86%E8%AE%BA/"/>
    
    <category term="设计模式" scheme="https://blog.liukairui.me/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    <category term="设计原则" scheme="https://blog.liukairui.me/tags/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/"/>
    
  </entry>
  
  <entry>
    <title>一些JavaScript高阶函数</title>
    <link href="https://blog.liukairui.me/article/%E4%B8%80%E4%BA%9BJavaScript%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0/"/>
    <id>https://blog.liukairui.me/article/%E4%B8%80%E4%BA%9BJavaScript%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0/</id>
    <published>2022-11-04T16:00:00.000Z</published>
    <updated>2022-11-04T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li><p>函数柯里化</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">currying</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 收集传入的参数</span>  <span class="token keyword">const</span> <span class="token function-variable function">curred</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arguments<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没有参数再指向</span>    <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> curred<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> curred<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> <span class="token function-variable function">plus</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">+</span> cur<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> plusCurred <span class="token operator">=</span> <span class="token function">currying</span><span class="token punctuation">(</span>plus<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">plusCurred</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">plusCurred</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">plusCurred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>将函数附加在 Function 上, 实现一步转为柯里化(骚操作)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">currying</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 收集传入的参数</span>  <span class="token keyword">const</span> <span class="token function-variable function">curred</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arguments<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没有参数再指向</span>    <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> curred<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> curred<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">plus</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">+</span> cur<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> plusCurred <span class="token operator">=</span> plus<span class="token punctuation">.</span><span class="token function">currying</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">plusCurred</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">plusCurred</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">plusCurred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>反柯里化 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">unCurrying</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> push <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>push<span class="token punctuation">.</span><span class="token function">unCurrying</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> t1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">push</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 1, 2, 3, 4 ]</span><span class="token comment">// 定义 length 的对象都可以用 Array.prototype.push</span><span class="token keyword">const</span> t2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>t2<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123; '2': 4, length: 3 &#125;</span><span class="token comment">// unCurrying 简化了调用</span><span class="token keyword">const</span> t3 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">push</span><span class="token punctuation">(</span>t3<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>节流</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> interval <span class="token operator">=</span> <span class="token number">500</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    first <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 首次不卡</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 在 interval 内还有其他函数在执行</span>    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>      timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>防抖 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> wait</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>      args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>      timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// test</span><span class="token keyword">var</span> debounceRun <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> debounceRun<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>注意防抖不要被饿死(抖死), 尤其要防止与时间相关的元素打交道,比如我设置了 500ms 的防抖, 结果有一个视频播放模块要调防抖,这个视频播放模块每 24ms 就要执行一次, 直接抖死</p></li><li><p>装饰器</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">before</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">after</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> res<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">f1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">f2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> f <span class="token operator">=</span> f1<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2 1 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
    
    
    <summary type="html">柯里化, 反柯里化 ... 再和原型链结合起来~</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="JS" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/JS/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="JavaScript" scheme="https://blog.liukairui.me/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>一些JavaScript设计模式</title>
    <link href="https://blog.liukairui.me/article/%E4%B8%80%E4%BA%9BJavaScript%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    <id>https://blog.liukairui.me/article/%E4%B8%80%E4%BA%9BJavaScript%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</id>
    <published>2022-10-25T16:00:00.000Z</published>
    <updated>2022-10-25T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>设计模式: 对特定问题简单且优雅的解决方案.</p><p>设计模式的应用场景并不是相互对立的,同一个问题运用不同的设计模式解决时代码上可能有较大的重复,我们应该关注的是某个模式可以应用于什么场景, 解决什么问题.</p><p>设计模式并不一定需要手动实现, 很多语言自带了一些设计模式实现的特性.可以说学习设计模式实际上体现了编程语言在某些方向的设计缺陷与不足</p><h2 id="设计模式之于-javascript">设计模式之于 JavaScript</h2><ul><li>JavaScript 是动态类型语言,我们可以直接调用某个对象上的方法与属性而不需要提前检测对象的类型.</li><li>JavaScript 的类型是鸭子类型,即不关注对象是不是某个类型的(IS-A)而关注对象有没有某些特征(HAS-A)</li></ul><h3 id="多态">多态</h3><p>JavaScript 鸭子类型意味着无需向上转型即可直接实现多态,我们可以在函数实现上实现多态, 也可以在传入对象上实现多态</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 在函数实现上实现多态</span><span class="token keyword">function</span> <span class="token function">makeSound</span><span class="token punctuation">(</span><span class="token parameter">bar</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'duck'</span><span class="token punctuation">)</span><span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'GaGaGa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'chicken'</span><span class="token punctuation">)</span><span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'GuGuGu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">&#125;</span><span class="token function">makeSound</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// GaGaGa</span><span class="token function">makeSound</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Chicken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// GuGuGu</span><span class="token comment">// 在传入对象上实现多态</span><span class="token keyword">function</span> <span class="token function">makeSound</span><span class="token punctuation">(</span><span class="token parameter">bar</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> bar<span class="token punctuation">.</span>sound <span class="token operator">&amp;&amp;</span> bar<span class="token punctuation">.</span><span class="token function">sound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token function">makeSound</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Duck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// GaGaGa</span><span class="token function">makeSound</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Chicken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// GuGuGu</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>多态背后的思想是将 "做什么" 与 "谁去做, 如何做"分开</strong>, 显然第二份代码更优雅, 更有弹性.</p><p>在实现多态时我们也要注意如何将 <strong>"做什么"(不变的,<code>makeSound</code>)</strong> 与 <strong>"谁去做, 如何做"(变化的,动物发出什么)</strong> 两者分开</p><h3 id="封装">封装</h3><p>可以借助作用域隐藏私有变量</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Chicken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> language <span class="token operator">=</span> <span class="token string">'GuGuGu'</span><span class="token punctuation">;</span> <span class="token comment">// 私有</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">sound</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 公有</span><span class="token punctuation">&#125;</span><span class="token keyword">new</span> <span class="token class-name">Chicken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> duck <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> language <span class="token operator">=</span> <span class="token string">'GaGaGa'</span><span class="token punctuation">;</span> <span class="token comment">// 私有</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token function-variable function">sound</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>duck<span class="token punctuation">.</span><span class="token function">sound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="原型模式">原型模式</h2><p>JavaScript 选择了基于原型的面向对象系统, JavaScript 并没有类的概念.在创建对象时, JavaScript 不会找对象属于什么类, 而是会寻找对象对应的原型,然后克隆这个原型对象得到目标对象.</p><p>可以这样对比, 假设我们需要制造一支红色的笔</p><ul><li>基于类的面向对象系统: 找到 <code>Pen</code> 类型, 为构造函数传入<code>color = 'red'</code>, <strong>构造</strong>对象.(类更像是一个模子, 对象就是这个模子浇铸出来的铸件)</li><li>基于原型的面向对象系统: 找到 <code>Pen</code> 对应的原型对象,<strong>克隆</strong>这个对象, 得到一根笔, 将颜色改为红色.(原型对象就像一个没有分化的细胞 (基础的, 默认的对象),创建对象就是让细胞分裂一次, 分裂出的细胞可能不符合要求,我们可以让新细胞继续分化, 使得其符合要求)</li></ul><p>JavaScript 利用原型链实现了方法的继承与委托</p><h3 id="javascript-创建对象的原理">JavaScript 创建对象的原理</h3><p>JavaScript 中的函数既可以当作函数也可以当作构造器使用, 通过<code>new</code> 创建对象时, 函数会作为构造器参与构造.如果构造器返回的对象, 那么该对象会作为 <code>new</code>的结果取代克隆的对象</p><p>JavaScript 会先克隆构造器对应的原型对象(绑定 <code>__proto__</code>),然后对对象执行构造器函数,最后检查构造器函数的返回值决定返回哪个对象作为构造结果</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">newOperator</span><span class="token punctuation">(</span><span class="token parameter">ctor<span class="token punctuation">,</span> <span class="token operator">...</span>params</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 校验构造函数</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ctor <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> ctor <span class="token operator">+</span> <span class="token string">'is not a constructor'</span><span class="token punctuation">;</span>  <span class="token comment">// 设置 new.target</span>  newOperator<span class="token punctuation">.</span>target <span class="token operator">=</span> ctor<span class="token punctuation">;</span>  <span class="token comment">// 克隆原型</span>  <span class="token keyword">var</span> rtn_obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ctor<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 传入参数、绑定this、获取构造函数返回的结果</span>  <span class="token keyword">var</span> instance <span class="token operator">=</span> <span class="token function">ctor</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>rtn_obj<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 判断构造函数返回的类型</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>    <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> instance <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span>    <span class="token keyword">typeof</span> instance <span class="token operator">===</span> <span class="token string">'function'</span>  <span class="token punctuation">)</span>    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>  <span class="token keyword">return</span> rtn_obj<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="单例模式">单例模式</h2><blockquote><p>保证类只有一个实例, 这个实例全局可见</p></blockquote><p>在 JavaScript 中实现单例的简单方法就是将对象附着在<code>global</code>, 但是这会污染全局作用域.虽然可以采用诸如命名空间的方法规避污染问题, 但是这种单例模式过于简易</p><h3 id="javascript-的通用惰性单例">JavaScript 的通用惰性单例</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">getSingleFn</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> instance<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> instance <span class="token operator">||</span> <span class="token punctuation">(</span>instance <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 只有调用时才执行函数</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">getData <span class="token operator">=</span> <span class="token function">getSingleFn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="其他应用">其他应用</h3><p>惰性单例不仅保证了全局唯一, 还保证了传入函数只运行一次, 可以实现类似<code>once</code> 功能</p><h2 id="策略模式">策略模式</h2><blockquote><p>当待解决的问题需要通过大量 "可替代" 的 "算法"实现时可以考虑策略模式</p></blockquote><h3 id="应用场景">应用场景</h3><p>假设某个插值函数 <code>lerp(time, st, ed, during, method)</code>提供了很多插值选项 (line / ease-in / ease-out...)如果要在一个函数中实现所有功能, 那函数就变为了</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">lerp</span><span class="token punctuation">(</span><span class="token parameter">time<span class="token punctuation">,</span> st<span class="token punctuation">,</span> ed<span class="token punctuation">,</span> during<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'line'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">/* ... */</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'ease-in'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">/* ... */</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'ease-out'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">/* ... */</span><span class="token punctuation">;</span>  <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样的函数缺乏弹性且违反了开闭原则: 当我们需要新增一个插值模式时,我们需要再增加一个 <code>if-else</code></p><p>可以发现, 这个函数的代码中涉及了<strong>很多平行的<code>if-else</code>,每个分支内部的算法很类似且目标相同(可替代)</strong> 可以考虑策略模式</p><h3 id="静态类型的策略模式">静态类型的策略模式</h3><p>定义一个策略类与环境类 (Context), 将每个算法封装为一个策略类,将数据配置到环境类, 在需要计算时调用环境类请求配置时指定的策略类</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 策略类</span><span class="token keyword">class</span> <span class="token class-name">LineLerp</span> <span class="token punctuation">&#123;</span>  <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token parameter">time<span class="token punctuation">,</span> st<span class="token punctuation">,</span> ed<span class="token punctuation">,</span> during</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/* ... */</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">EaseinLerp</span> <span class="token punctuation">&#123;</span>  <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token parameter">time<span class="token punctuation">,</span> st<span class="token punctuation">,</span> ed<span class="token punctuation">,</span> during</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/* ... */</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">EaseoutLerp</span> <span class="token punctuation">&#123;</span>  <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token parameter">time<span class="token punctuation">,</span> st<span class="token punctuation">,</span> ed<span class="token punctuation">,</span> during</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/* ... */</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 环境类</span><span class="token keyword">class</span> <span class="token class-name">Lerp</span> <span class="token punctuation">&#123;</span>  <span class="token function">setEnvs</span><span class="token punctuation">(</span><span class="token parameter">time<span class="token punctuation">,</span> st<span class="token punctuation">,</span> ed<span class="token punctuation">,</span> during<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">=</span> time<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>st <span class="token operator">=</span> st<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>ed <span class="token operator">=</span> ed<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>during <span class="token operator">=</span> during<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> method<span class="token punctuation">;</span> <span class="token comment">// 策略类, 这里需要向上转型一下</span>  <span class="token punctuation">&#125;</span>  <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>st<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ed<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>during<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 环境类调用策略类</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 测试</span><span class="token keyword">const</span> lerp1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lerp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建环境类</span>lerp1<span class="token punctuation">.</span><span class="token function">setEnvs</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LineLerp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 配置环境类</span>lerp1<span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="javascript-的策略模式">JavaScript 的策略模式</h3><p>可以定义一个对象存储所有策略</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 策略类</span><span class="token keyword">const</span> lerps <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">line</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">time<span class="token punctuation">,</span> st<span class="token punctuation">,</span> ed<span class="token punctuation">,</span> during</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function-variable function">easein</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">time<span class="token punctuation">,</span> st<span class="token punctuation">,</span> ed<span class="token punctuation">,</span> during</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function-variable function">easeout</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">time<span class="token punctuation">,</span> st<span class="token punctuation">,</span> ed<span class="token punctuation">,</span> during</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 环境类</span><span class="token keyword">class</span> <span class="token class-name">Lerp</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">time<span class="token punctuation">,</span> st<span class="token punctuation">,</span> ed<span class="token punctuation">,</span> during<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">=</span> time<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>st <span class="token operator">=</span> st<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>ed <span class="token operator">=</span> ed<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>during <span class="token operator">=</span> during<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> method<span class="token punctuation">;</span> <span class="token comment">// 策略</span>  <span class="token punctuation">&#125;</span>  <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> lerps<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>st<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ed<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>during<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 环境类调用策略类</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 测试</span><span class="token keyword">const</span> lerp1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lerp</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'line'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建环境类</span>lerp1<span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="其他应用场景">其他应用场景</h3><p>实际上只要我们的<strong>算法业务目标一致,具有可替代性</strong>就可以利用策略模式</p><p>例如: 表单验证</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 定义策略</span><span class="token keyword">const</span> strategies <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">isNotEmpty</span><span class="token operator">:</span> <span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">''</span> <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">,</span>  <span class="token literal-property property">minLength</span><span class="token operator">:</span> <span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> minLen<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> minLen <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">,</span>  <span class="token literal-property property">isMobile</span><span class="token operator">:</span> <span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^1\d&#123;10&#125;$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 定义环境类</span><span class="token keyword">class</span> <span class="token class-name">Validator</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> rules</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 添加策略, rule = 策略:参数...</span>    rules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> strategy<span class="token punctuation">,</span> errorMsg <span class="token punctuation">&#125;</span> <span class="token operator">=</span> d<span class="token punctuation">;</span>      <span class="token keyword">const</span> <span class="token punctuation">[</span>rule<span class="token punctuation">,</span> <span class="token operator">...</span>params<span class="token punctuation">]</span> <span class="token operator">=</span> strategy<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>strategies<span class="token punctuation">[</span>rule<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token operator">...</span>params<span class="token punctuation">,</span> errorMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token function">i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">userName</span><span class="token operator">:</span> <span class="token string">'hihi'</span><span class="token punctuation">,</span>  <span class="token literal-property property">passWord</span><span class="token operator">:</span> <span class="token string">'hi'</span><span class="token punctuation">,</span>  <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token string">' '</span><span class="token punctuation">,</span>  <span class="token literal-property property">tel</span><span class="token operator">:</span> <span class="token string">'222'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> validator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Validator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>validator<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span>userName<span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">strategy</span><span class="token operator">:</span> <span class="token string">'minLength:2'</span><span class="token punctuation">,</span> <span class="token literal-property property">errorMsg</span><span class="token operator">:</span> <span class="token string">'Username >2!'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>validator<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span>passWord<span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">strategy</span><span class="token operator">:</span> <span class="token string">'minLength:4'</span><span class="token punctuation">,</span> <span class="token literal-property property">errorMsg</span><span class="token operator">:</span> <span class="token string">'pwd >4!'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>validator<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span>address<span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">strategy</span><span class="token operator">:</span> <span class="token string">'isNotEmpty'</span><span class="token punctuation">,</span> <span class="token literal-property property">errorMsg</span><span class="token operator">:</span> <span class="token string">'add nn!'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>validator<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span>tel<span class="token punctuation">,</span> <span class="token punctuation">[</span>  <span class="token punctuation">&#123;</span> <span class="token literal-property property">strategy</span><span class="token operator">:</span> <span class="token string">'isNotEmpty'</span><span class="token punctuation">,</span> <span class="token literal-property property">errorMsg</span><span class="token operator">:</span> <span class="token string">'tel nn!'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#123;</span> <span class="token literal-property property">strategy</span><span class="token operator">:</span> <span class="token string">'isMobile'</span><span class="token punctuation">,</span> <span class="token literal-property property">errorMsg</span><span class="token operator">:</span> <span class="token string">'NOT A TEL!'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>validator<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="代理模式">代理模式</h2><blockquote><p>提供一个代用品以控制外部的访问</p></blockquote><p>实现代理的原则</p><ul><li>透明代理: 代理 API 设计的与原 API 一样,当我们不需要代理的时候可以直接移除代理代码而不需要大改 API</li></ul><h3 id="保护代理">保护代理</h3><p>相当于一个防火墙, 每次触发时有选择的执行或阻止触发事件</p><h3 id="虚拟代理">虚拟代理</h3><p>将性能开销大的事务延迟到可用时执行</p><ul><li><p>图片预加载 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">MyImage</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>imageNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>imageNode<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">setSrc</span><span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>imageNode<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">setImageProxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> src<span class="token punctuation">,</span> srcLoad <span class="token operator">=</span> <span class="token string">'http://预加载图片地址'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 临时图像对象</span>  img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> target<span class="token punctuation">.</span><span class="token function">setSrc</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当临时图像加载完成后为目标赋值</span>  img<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span> <span class="token comment">// 要求临时图像加载</span>  target<span class="token punctuation">.</span><span class="token function">setSrc</span><span class="token punctuation">(</span>srcLoad<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 目标图像先放 loading 图</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> imgNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setImageProxy</span><span class="token punctuation">(</span>imgNode<span class="token punctuation">,</span> <span class="token string">'http://大图地址'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>合并请求</p><p>对于少量多次的请求可以做请求合并</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">getFetchProxy</span><span class="token punctuation">(</span><span class="token parameter">interval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> timer<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    cache<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>      timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://example.com/'</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      cache<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> urlProxy <span class="token operator">=</span> <span class="token function">getFetchProxy</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">urlProxy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token function">urlProxy</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>惰性加载</p><p>类似单例模式的惰性加载</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">getFetchProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://example.com/'</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  cache<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> urlProxy <span class="token operator">=</span> <span class="token function">getFetchProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">urlProxy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">urlProxy</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">urlProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="缓存代理">缓存代理</h3><p>缓存请求参数即可</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">getMultiProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 计算乘法的代理</span>  <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> k <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>      cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>        k<span class="token punctuation">,</span>        args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">*</span> cur<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="其他代理">其他代理</h3><ul><li>防火墙代理</li><li>远程代理: 代理其他内存区域中的数据</li><li>保护代理: 实现权限控制</li><li>智能引用代理: 在指针基础上提供了一些回调方法</li><li>写时复制代理: 惰性复制, 只有要修改原对象时才赋值</li></ul><h2 id="迭代器模式">迭代器模式</h2><ul><li>内部迭代器: 迭代器位于函数内部, 只需要传入对每个对象的调用方法</li><li>外部迭代器: 需要显式操作迭代器(<code>next</code>,<code>isDone</code>)</li></ul><h2 id="发布订阅模式">发布订阅模式</h2><blockquote><p>又称观察者模式, 用于维护对象之间的<strong>一对多</strong>关系,一旦对象状态发生改变, 所有依赖(订阅)于这个对象的对象都会得到消息</p></blockquote><p>当某个对象需要在其他对象发生变化后变化, 最简单的实现方式是 RR,但这势必会造成硬编码与强耦合. 我们希望采用类似 DOM 中<code>addEventListener</code> 的方法实现事件注册并在触发后自动执行.模仿这个过程就可以得到发布订阅模式与观察者模式.</p><h3 id="javascript-的观察者模式">JavaScript 的观察者模式</h3><p>观察者模式中存在观察者与被观察者, 观察者发生变化后通知被观察者</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//观察者类</span><span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token comment">//观测到变化后的处理</span>  <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">ob</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ob<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Observed</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>observers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//添加观察者</span>  <span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token parameter">observer</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//删除观察者</span>  <span class="token function">removeObserver</span><span class="token punctuation">(</span><span class="token parameter">observer</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>observers <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token operator">=></span> o <span class="token operator">!=</span> observer<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//通知所有的观察者</span>  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">observer</span><span class="token punctuation">)</span> <span class="token operator">=></span> observer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Teacher</span> <span class="token keyword">extends</span> <span class="token class-name">Observer</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">st</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">提交了</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">作业</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">extends</span> <span class="token class-name">Observed</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">submitHomeWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> students <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> teacher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Teacher</span><span class="token punctuation">(</span><span class="token string">'t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>teacher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>students<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2提交了t作业</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="javascript-发布订阅模式">JavaScript 发布订阅模式</h3><p>在订阅者模式中, 当被观察者发生变化时被观察者会直接通知所有观察者.在消息订阅模式中, 消息发布者(被观察者)可以自定义发布消息类型,只有订阅了此类消息的人才会收到消息.</p><h4 id="非全局消息中心">非全局消息中心</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">installEvent</span><span class="token punctuation">(</span><span class="token parameter">sender</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  sender<span class="token punctuation">.</span>eventType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  sender<span class="token punctuation">.</span><span class="token function-variable function">listen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sender<span class="token punctuation">.</span>eventType<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> sender<span class="token punctuation">.</span>eventType<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不能用 set 万一有重复就寄了</span>    <span class="token keyword">const</span> fns <span class="token operator">=</span> sender<span class="token punctuation">.</span>eventType<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    fns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  sender<span class="token punctuation">.</span><span class="token function-variable function">trigger</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sender<span class="token punctuation">.</span>eventType<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> fns <span class="token operator">=</span> sender<span class="token punctuation">.</span>eventType<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    fns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">d</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  sender<span class="token punctuation">.</span><span class="token function-variable function">cancel</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sender<span class="token punctuation">.</span>eventType<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> fns <span class="token operator">=</span> sender<span class="token punctuation">.</span>eventType<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> idx <span class="token operator">=</span> fns<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d <span class="token operator">===</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">~</span>idx <span class="token operator">&amp;&amp;</span> fns<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> sender <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">installEvent</span><span class="token punctuation">(</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ev1 #1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sender<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'ev1'</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>sender<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'ev1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ev1 #2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sender<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'ev2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ev2 #1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sender<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'ev1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ev1 #1 ev1 #2</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sender<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'ev2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ev2 #1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sender<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token string">'ev1'</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>sender<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'ev1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ev1 #2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h4 id="有消息缓存的全局消息中心">有消息缓存的全局消息中心</h4><p>我们发现订阅者者要在注册事件时需要显式的指定发布者,这也造成了一定程度的耦合, 我们可以定义一个全局消息中心,订阅者向消息中心请求订阅消息, 消息发布者发布消息到消息中心,由消息中心通知订阅者.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> Event <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> eventType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eventType<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> eventType<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不能用 set 万一有重复就寄了</span>    <span class="token keyword">const</span> fns <span class="token operator">=</span> eventType<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    fns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">retrieveCache</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eventType<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">addCache</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> fns <span class="token operator">=</span> eventType<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fns<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">addCache</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    fns<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">d</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">function</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eventType<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> fns <span class="token operator">=</span> eventType<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> idx <span class="token operator">=</span> fns<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d <span class="token operator">===</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">~</span>idx <span class="token operator">&amp;&amp;</span> fns<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">function</span> <span class="token function">addCache</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cachedArgs <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    cachedArgs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">function</span> <span class="token function">retrieveCache</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    cachedArgs <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>    cachedArgs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">trigger</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token operator">...</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> listen<span class="token punctuation">,</span> trigger<span class="token punctuation">,</span> cancel <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> sender <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ev1 #1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Event<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'ev1'</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>Event<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'ev1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ev1 #2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Event<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'ev2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ev2 #1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Event<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'ev1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ev1 #1 ev1 #2</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Event<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'ev2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ev2 #1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Event<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token string">'ev1'</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>Event<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'ev1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ev1 #2</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'---'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Event<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'ev3'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Event<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'ev3'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ev3 #1, ans = '</span> <span class="token operator">+</span> args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=></span> pre <span class="token operator">+</span> cur<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ev3 #1, ans = 10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="应用场景-1">应用场景</h3><p>某个对象改变, 使依赖于它的多个对象得到通知, 且希望解耦两者.发布-订阅模式适合更复杂的场景(发布者的某次更新只想通知它的部分订阅者)</p><h2 id="命令模式">命令模式</h2><blockquote><p>当我们不清楚请求的接受者是谁也不知道请求的具体操作是什么.我们可以将命令封装为对象, 让命令对象在程序中被四处传递</p></blockquote><p>命令模式的三个组成部分: 发起者(不知道自己触发的命令有啥用,也不知道谁最终接收命令) 命令(一个被拿来拿去的对象)传递/接收者(只管传递/接收命令)</p><p>可以类比餐厅点餐:</p><ul><li>命令: 一个包含了如何做菜的指令对象</li><li>发起者: 客户, 客户发起做饭的命令,但是客户也不知道做饭的命令最终接受者是谁, 他只是发出了一个做菜命令</li><li>传递者: 服务员, 服务员将客户发出的做菜指令传递给大厨</li><li>执行者: 大厨, 大厨只管执行命令, 他也不知道是谁点的餐,他只负责执行</li></ul><p>可以看到, 在这里我们完全做到了发起者, 命令, 接受者的解耦</p><h3 id="静态类型语言的命令模式">静态类型语言的命令模式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 为发起者绑定命令的方法</span><span class="token keyword">function</span> <span class="token function">setCommandDOM</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> command</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  dom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 实际功能的实现</span><span class="token keyword">const</span> showTimes <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">showYear</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function-variable function">showMonth</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token function-variable function">showDay</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 命令类</span><span class="token keyword">function</span> <span class="token function">ShowCurrentYearCommand</span><span class="token punctuation">(</span><span class="token parameter">receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>receiver <span class="token operator">=</span> receiver<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token class-name">ShowCurrentYearCommand</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">execute</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>receiver<span class="token punctuation">.</span>innerText <span class="token operator">=</span> showTimes<span class="token punctuation">.</span><span class="token function">showYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">ShowCurrentAllCommand</span><span class="token punctuation">(</span><span class="token parameter">receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>receiver <span class="token operator">=</span> receiver<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token class-name">ShowCurrentAllCommand</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">execute</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>receiver<span class="token punctuation">.</span>innerText <span class="token operator">=</span>    <span class="token string">''</span> <span class="token operator">+</span> showTimes<span class="token punctuation">.</span><span class="token function">showYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> showTimes<span class="token punctuation">.</span><span class="token function">showMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> showTimes<span class="token punctuation">.</span><span class="token function">showDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">ClearAllCommand</span><span class="token punctuation">(</span><span class="token parameter">receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>receiver <span class="token operator">=</span> receiver<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token class-name">ClearAllCommand</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">execute</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>receiver<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 构造命令(命令 -> 接收者, 接收者不知道是谁发起的)</span><span class="token keyword">const</span> showCurrentYearCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShowCurrentYearCommand</span><span class="token punctuation">(</span>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> showCurrentAllCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShowCurrentAllCommand</span><span class="token punctuation">(</span>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> clearAllCommand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClearAllCommand</span><span class="token punctuation">(</span>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 发起者发起命令(发起者 -> 命令, 发起者也不知道这命令是干啥的)</span><span class="token function">setCommandDOM</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> showCurrentYearCommand<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setCommandDOM</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> showCurrentAllCommand<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setCommandDOM</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn3'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clearAllCommand<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>实现命令功能</li><li>实现命令类保存 context 实现 execute</li><li>构造实例对象, 完成 命令 -&gt; 执行者的绑定</li><li>将命令绑定给发起者</li></ul><p>撤销执行: 将指令调用保存到栈, 需要撤销时候弹指令即可.同时在指令上定义 undo 方法实现单条指令的撤销(因为每条指令只需要实现execute 的逆, 不用考虑全局变化, 所以不算麻烦), 例如</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">ClearAllCommand</span><span class="token punctuation">(</span><span class="token parameter">receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>receiver <span class="token operator">=</span> receiver<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>last <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">ClearAllCommand</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">execute</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>last <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>receiver<span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>receiver<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">ClearAllCommand</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">undo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>receiver<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>last<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="宏命令">宏命令</h3><p>可以将多个命令组合起来形成一个宏命令,执行宏命令等于执行宏命令下的每个命令</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">buildMacroCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> commandList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">command</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      commandList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      commandList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token punctuation">[</span><span class="token operator">...</span>commandList<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span>undo <span class="token operator">&amp;&amp;</span> d<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们尽量让宏命令和普通命令 API 保持一致,这样可以保证宏命令对发起者透明</p><h3 id="智能命令与傻瓜命令">智能命令与傻瓜命令</h3><p>命令执行与执行者无关的称为智能命令(例如 <code>alert()</code>),和执行者有关的(例如 <code>receiver.innerText</code>)</p><h3 id="应用场景-2">应用场景</h3><ul><li>不清楚请求的接受者</li><li>不知道请求的具体操作是什么</li><li>命令要被四处传递四处传递</li></ul><p>命令模式与策略模式在形式上有点类似, 但是命令模式的命令传递更加灵活,且实现了命令发起者与命令的解耦. 在 JavaScript 中, 命令可以是一个函数,但是函数在 JavaScript 中是可以随意传递的, 所以 JavaScript天生就直接支持命令模式</p><h2 id="组合模式">组合模式</h2><p>采用尽可能相同的接口定义对象, 并使对象具有嵌套能力.这样我们就可以通过对象的嵌套实现功能的组合.</p><p>应用: 宏命令就采用组合模式的思想, 宏命令与普通命令的 API相同(<strong>形式一致</strong>), 宏命令可以嵌套宏命令与普通命令,也可以通过 <code>execute</code>执行自己包含的子命令(<strong>功能一致</strong>).命令调用者无需区分宏命令和普通命令, 只需要无脑调用 <code>execute</code>即可.</p><p>应用场景:组合模式将对象以<strong>部分-整体的模式组成树形结构</strong>,并要求部分与整体具有<strong>功能与形式的一致性</strong></p><p>特性:称这种模式为组合模式是因为<strong>不同对象之间可以方便组合拆分对象</strong>,快速形成一个树形结构, 而调用者只需要关注树根即可调用整个对象,且不需要关系调用的对象是嵌套对象还是基本对象</p><p>注意: - 嵌套对象与基本对象接口设计不可能完全一致,如果用户对基本对象调用嵌套对象会造成引用错误,可以尝试在基本对象上定义相同 API 并抛出错误 -组合模式的对象应该是严格的树形结构, 如果出现环,就意味着我们可能无法控制环中对象调用次数, 如果产生了环可以考虑采用策略 /责任链模式解决问题</p><h2 id="模板方法模式">模板方法模式</h2><p>在抽象类中定义算法的宏观运行模式与可复用的子算法,由子类实现具体每一步的算法</p><h3 id="静态类型的模板方法模式">静态类型的模板方法模式</h3><p>实现制作饮料算法, 其中</p><ul><li>制作咖啡: 开水 -&gt; 泡咖啡粉 -&gt; 倒入杯子 -&gt; 加糖</li><li>制作奶茶: 开水 -&gt; 泡茶 -&gt; 倒入杯子 -&gt; 加牛奶</li></ul><p>可以抽象制作饮料的算法: 开水 -&gt; 泡水 -&gt; 倒入杯子 -&gt; 加料</p><p>实现制作奶茶 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">MakeDrink</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">temp</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">consist</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>cup <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// 公共算法提前实现</span>  <span class="token function">boilWater</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">.</span>temp <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// 私有算法不实现</span>  <span class="token function">brew</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'需要实现算法'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">pourCup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>cup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">addCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'需要实现算法'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">boilWater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">brew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pourCup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cup<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">MakeMilkTea</span> <span class="token keyword">extends</span> <span class="token class-name">MakeDrink</span> <span class="token punctuation">&#123;</span>  <span class="token function">brew</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">.</span>consist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'tea'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">addCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">.</span>consist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'milk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> makeMilkTea <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MakeMilkTea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>makeMilkTea<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123; temp: 100, consist: [ 'tea', 'milk' ] &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>我们还可以在实现抽象类的时候加入钩子函数, 实现流程控制, 例如:默认加配料, 但是支持使用钩子函数传入是否加料</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">MakeDrink</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// ...</span>  <span class="token function">needCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 默认加料</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">boilWater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">brew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pourCup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">needCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cup<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">MakeCoffee</span> <span class="token keyword">extends</span> <span class="token class-name">MakeDrink</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">need</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>need <span class="token operator">=</span> need<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">brew</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">.</span>consist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'coffee'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">addCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">.</span>consist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'sugar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">needCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>need<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> makeCoffee <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MakeCoffee</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>makeCoffee<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123; temp: 100, consist: [ 'coffee' ] &#125;</span><span class="token keyword">const</span> makeCoffeeWithSugar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MakeCoffee</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>makeCoffeeWithSugar<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123; temp: 100, consist: [ 'coffee', 'sugar' ] &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="javascript-的模板方法模式">JavaScript 的模板方法模式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">MakeDrink</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">temp</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">consist</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>cup <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">// 先尽力去取</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>methods <span class="token operator">=</span> params<span class="token punctuation">;</span>    <span class="token comment">// 公共算法内部实现, 如果以及提供就不实现</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span>boilWater <span class="token operator">??=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">.</span>temp <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token comment">// 私有算法不实现</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span>brew <span class="token operator">??=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'需要实现算法'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span>pourCup <span class="token operator">??=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>cup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span>addCondiments <span class="token operator">??=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'需要实现算法'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span>needCondiments <span class="token operator">??=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function">boilWater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function">brew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function">pourCup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function">needCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function">addCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cup<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> makeMilkTea <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MakeDrink</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  <span class="token function">brew</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">.</span>consist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'tea'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">addCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">.</span>consist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'milk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>makeMilkTea<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123; temp: 100, consist: [ 'tea', 'milk' ] &#125;</span><span class="token keyword">const</span> makeCoffee <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MakeDrink</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  <span class="token function">brew</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">.</span>consist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'coffee'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">addCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">.</span>consist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'sugar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">needCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>makeCoffee<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123; temp: 100, consist: [ 'coffee', 'sugar' ] &#125;</span><span class="token keyword">const</span> makeCoffeeWithSugar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MakeDrink</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  <span class="token function">brew</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">.</span>consist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'coffee'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">addCondiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>water<span class="token punctuation">.</span>consist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'sugar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>makeCoffeeWithSugar<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123; temp: 100, consist: [ 'coffee', 'sugar' ] &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="享元模式">享元模式</h2><blockquote><p>运用共享技术尽可能的复用对象</p></blockquote><p>将对象上的属性分为内部属性与外部属性</p><ul><li>内部属性属于对象内部, 可以被外部共享</li><li>内部属性独立于场景, 不会随场景变化变化(在共享过程中保持不变)</li><li>外部属性取决于应用场景, 不会随场景变化而变化</li></ul><p>对象剥离外部对象成为共享对象, 在使用时传入外部状态组成对象</p><h3 id="应用场景-3">应用场景</h3><ul><li>相似元素多次调用</li><li>元素体积较大, 多次创建会造成较大开销</li><li>多数状态为外部状态</li><li>同时使用对象量小, 可以用少量对象完成大多数场景</li></ul><h3 id="使用-javascript-实现对象池">使用 JavaScript 实现对象池</h3><p>享元模式只是一种思想, 没有具体的实现, 对象池是享元模式的一种应用</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> <span class="token function-variable function">objPoolFactory</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">createObjFn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> objPool <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>objPool<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> objPool<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> <span class="token function">createObjFn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">recover</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      objPool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="职责链模式">职责链模式</h2><p>请求者发起请求, 将请求传递给中间人,中间人一直传递直到遇到一个可处理者</p><p>很类似于拦截器</p><h3 id="javascript-的职责链模式">JavaScript 的职责链模式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">processState400</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">>=</span> <span class="token number">400</span> <span class="token operator">&amp;&amp;</span> code <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error 400'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">processState500</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">>=</span> <span class="token number">500</span> <span class="token operator">&amp;&amp;</span> code <span class="token operator">&lt;</span> <span class="token number">600</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server 500'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">processState200</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">>=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> code <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ok 200'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">processStateUnknown</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'unknown code'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Chain</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>fn <span class="token operator">=</span> fn<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>successor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">setNextSuccessor</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>successor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chain</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>successor <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>successor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> processCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chain</span><span class="token punctuation">(</span>processState200<span class="token punctuation">)</span><span class="token punctuation">;</span>processCode  <span class="token punctuation">.</span><span class="token function">setNextSuccessor</span><span class="token punctuation">(</span>processState400<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">setNextSuccessor</span><span class="token punctuation">(</span>processState500<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">setNextSuccessor</span><span class="token punctuation">(</span>processStateUnknown<span class="token punctuation">)</span><span class="token punctuation">;</span>processCode<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token number">210</span><span class="token punctuation">)</span><span class="token punctuation">;</span>processCode<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token number">310</span><span class="token punctuation">)</span><span class="token punctuation">;</span>processCode<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token number">410</span><span class="token punctuation">)</span><span class="token punctuation">;</span>processCode<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token number">510</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="利用-aop-实现职责链">利用 AOP 实现职责链</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">after</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">===</span> <span class="token string">'nextSuccessor'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> res<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">processState400</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">>=</span> <span class="token number">400</span> <span class="token operator">&amp;&amp;</span> code <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error 400'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token string">'nextSuccessor'</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">processState500</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">>=</span> <span class="token number">500</span> <span class="token operator">&amp;&amp;</span> code <span class="token operator">&lt;</span> <span class="token number">600</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server 500'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token string">'nextSuccessor'</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">processState200</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">>=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> code <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ok 200'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token string">'nextSuccessor'</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">processStateUnknown</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'unknown code'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> processCode <span class="token operator">=</span> processState200  <span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>processState400<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>processState500<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>processStateUnknown<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">processCode</span><span class="token punctuation">(</span><span class="token number">210</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">processCode</span><span class="token punctuation">(</span><span class="token number">310</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">processCode</span><span class="token punctuation">(</span><span class="token number">410</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">processCode</span><span class="token punctuation">(</span><span class="token number">510</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>与组合模式相比, 职责链模式可以手动指定执行的起点, 职责修改更灵活</p><h2 id="中介者模式">中介者模式</h2><p>中介者模式与发布订阅模式类似,都是实现解决内部状态改变引发外部行为改变.</p><ul><li>发布订阅模式只支持发布消息, 消息中心触发订阅者对应事件.消息是单向传递的</li><li>中介者模式的中介者功能更加强大,中介者拥有<strong>智能</strong>处理事件的能力(不仅可以传递消息,还可以在收到消息后做一系列动作). 同时, 中介者模式不区分发布者与订阅者,所有对象都是中介服务的对象, 对象之间平等.</li></ul><p>在中介者模式中, 中心的工作能力大大增强,所以中介者模式也被称为调停者模式</p><h3 id="javascript-的中介者模式">JavaScript 的中介者模式</h3><p>命令定义类似策略模式, 接口定义类似发布订阅模式. 实现一个玩家中介,玩家可以换队伍, 同色队伍全死后对方队伍成员收消息.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 中介者模式</span><span class="token keyword">function</span> <span class="token function">Player</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> teamColor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'live'</span><span class="token punctuation">;</span> <span class="token comment">// 玩家状态</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>teamColor <span class="token operator">=</span> teamColor<span class="token punctuation">;</span> <span class="token comment">//队伍颜色</span><span class="token punctuation">&#125;</span><span class="token class-name">Player</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">win</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">': won'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">Player</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">lose</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">': lost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 玩家死亡</span><span class="token class-name">Player</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">die</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'dead'</span><span class="token punctuation">;</span>  <span class="token comment">//给中介者发消息，玩家死亡</span>  playerDirector<span class="token punctuation">.</span><span class="token function">reciveMessage</span><span class="token punctuation">(</span><span class="token string">'playerDead'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 移除玩家</span><span class="token class-name">Player</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">remove</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  playerDirector<span class="token punctuation">.</span><span class="token function">reciveMessage</span><span class="token punctuation">(</span><span class="token string">'removePlayer'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 玩家换队</span><span class="token class-name">Player</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">changeTeam</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">color</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  playerDirector<span class="token punctuation">.</span><span class="token function">reciveMessage</span><span class="token punctuation">(</span><span class="token string">'changeTeam'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">let</span> <span class="token function-variable function">playerFactory</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> teamColor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> newPlayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Player</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> teamColor<span class="token punctuation">)</span><span class="token punctuation">;</span>  playerDirector<span class="token punctuation">.</span><span class="token function">reciveMessage</span><span class="token punctuation">(</span><span class="token string">'addPlayer'</span><span class="token punctuation">,</span> newPlayer<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> newPlayer<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">let</span> playerDirector <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> players <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// 保存所有玩家</span>    operations <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 中介者可以执行的操作</span>  operations<span class="token punctuation">.</span><span class="token function-variable function">addPlayer</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">player</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> teamColor <span class="token operator">=</span> player<span class="token punctuation">.</span>teamColor<span class="token punctuation">;</span>    players<span class="token punctuation">[</span>teamColor<span class="token punctuation">]</span> <span class="token operator">=</span> players<span class="token punctuation">[</span>teamColor<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 如果还没成立队伍，就新成立一个队伍</span>    players<span class="token punctuation">[</span>teamColor<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加入一个玩家</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  operations<span class="token punctuation">.</span><span class="token function-variable function">removePlayer</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">player</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> teamColor <span class="token operator">=</span> player<span class="token punctuation">.</span>teamColor<span class="token punctuation">;</span>    teamPlayers <span class="token operator">=</span> players<span class="token punctuation">[</span>teamColor<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//该队伍所有玩家</span>    players<span class="token punctuation">[</span>teamColor<span class="token punctuation">]</span> <span class="token operator">=</span> teamPlayers<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> item <span class="token operator">!==</span> player<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//移除玩家</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  operations<span class="token punctuation">.</span><span class="token function-variable function">changeTeam</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">player<span class="token punctuation">,</span> newTeamColor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    operations<span class="token punctuation">.</span><span class="token function">removePlayer</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从原来队伍移除</span>    player<span class="token punctuation">.</span>teamColor <span class="token operator">=</span> newTeamColor<span class="token punctuation">;</span> <span class="token comment">// 改变自身的队伍颜色</span>    operations<span class="token punctuation">.</span><span class="token function">addPlayer</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加到新队伍</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  operations<span class="token punctuation">.</span><span class="token function-variable function">playerDead</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">player</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> teamColor <span class="token operator">=</span> player<span class="token punctuation">.</span>teamColor<span class="token punctuation">,</span>      teamPlayers <span class="token operator">=</span> players<span class="token punctuation">[</span>teamColor<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//玩家所在队伍</span>    <span class="token keyword">let</span> all_dead <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> player<span class="token punctuation">;</span> <span class="token punctuation">(</span>player <span class="token operator">=</span> teamPlayers<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>player<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token string">'dead'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        all_dead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>all_dead <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// 全部死亡</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> player<span class="token punctuation">;</span> <span class="token punctuation">(</span>player <span class="token operator">=</span> teamPlayers<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        player<span class="token punctuation">.</span><span class="token function">lose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 所有玩家失败</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> color <span class="token keyword">in</span> players<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>color <span class="token operator">!==</span> teamColor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">let</span> teamPlayers <span class="token operator">=</span> players<span class="token punctuation">[</span>color<span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token comment">// 找出其他队伍玩家</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> player<span class="token punctuation">;</span> <span class="token punctuation">(</span>player <span class="token operator">=</span> teamPlayers<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            player<span class="token punctuation">.</span><span class="token function">win</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 其他队伍胜利</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> <span class="token function-variable function">reciveMessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    operations<span class="token punctuation">[</span>message<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    reciveMessage<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> player1 <span class="token operator">=</span> <span class="token function">playerFactory</span><span class="token punctuation">(</span><span class="token string">'小明'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  player2 <span class="token operator">=</span> <span class="token function">playerFactory</span><span class="token punctuation">(</span><span class="token string">'小乖'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  player3 <span class="token operator">=</span> <span class="token function">playerFactory</span><span class="token punctuation">(</span><span class="token string">'小宏'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> player4 <span class="token operator">=</span> <span class="token function">playerFactory</span><span class="token punctuation">(</span><span class="token string">'小白'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  player5 <span class="token operator">=</span> <span class="token function">playerFactory</span><span class="token punctuation">(</span><span class="token string">'小黑'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  player6 <span class="token operator">=</span> <span class="token function">playerFactory</span><span class="token punctuation">(</span><span class="token string">'小牛'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// player1.die();</span><span class="token comment">// player3.die();</span><span class="token comment">// player2.die();</span><span class="token comment">// 小明: lost</span><span class="token comment">// 小乖: lost</span><span class="token comment">// 小宏: lost</span><span class="token comment">// 小白: won</span><span class="token comment">// 小黑: won</span><span class="token comment">// 小牛: won</span><span class="token comment">// player1.remove();</span><span class="token comment">// player3.die();</span><span class="token comment">// player2.die();</span><span class="token comment">// 小乖: lost</span><span class="token comment">// 小宏: lost</span><span class="token comment">// 小白: won</span><span class="token comment">// 小黑: won</span><span class="token comment">// 小牛: won</span>player1<span class="token punctuation">.</span><span class="token function">changeTeam</span><span class="token punctuation">(</span><span class="token string">'blue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>player2<span class="token punctuation">.</span><span class="token function">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>player3<span class="token punctuation">.</span><span class="token function">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 小乖: lost</span><span class="token comment">// 小宏: lost</span><span class="token comment">// 小白: won</span><span class="token comment">// 小黑: won</span><span class="token comment">// 小牛: won</span><span class="token comment">// 小明: won</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="缺陷">缺陷</h3><p>我们引入消息订阅中心是为了方便实现信息交流,避免硬编码与因实现通信导致的对象臃肿. 但是随着消息中心功能变强,逐渐演化为中介者, 中介者对象也会变得越来越臃肿</p><h2 id="装饰者模式">装饰者模式</h2><p>装饰者模式又称包装器模式, 就是将一个函数包装在另一个函数里面.</p><h3 id="javascript-的装饰者模式">JavaScript 的装饰者模式</h3><p>JavaScript 支持高阶函数, 所以天生支持装饰者模式. 例如, 我们想为<code>window.onload</code> 绑定内容但不知道 <code>window.onload</code>是否以及绑定了函数, 我们可以写</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> _load <span class="token operator">=</span> window<span class="token punctuation">.</span>onload<span class="token punctuation">;</span>window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  _load <span class="token operator">&amp;&amp;</span> <span class="token function">_load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 我们自己想绑定的</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用-aop-实现装饰器模式">使用 AOP 实现装饰器模式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">before</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">after</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> res<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">f1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">f2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> f <span class="token operator">=</span> f1<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2 1 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="应用场景-4">应用场景</h3><p>装饰器模式可以为函数<strong>动态的</strong>加入新的职责与行为,当一个函数的具体<strong>功能无法在运行前确定</strong>时或需要<strong>为函数加入非主线任务的工作(AOP)</strong>时可以考虑装饰者模式.同时, 考虑到其可以客观将代码分开,当我们想要将不同层级代码从同一个函数中分离时也可以考虑这一模式(例如在表单提交中将合法性检查与提交请求与DOM 刷新分开, 者也可以看作是一种 AOP)</p><h2 id="状态模式">状态模式</h2><blockquote><p>将事务的<strong>每种状态</strong>都封装为类,与当前状态相关的行为被直接封装到状态类中, 而在调用者看来,对象似乎可以根据状态的不同调整行为</p></blockquote><p>假设我们要实现一个支持三档切换的电灯(关-弱光-强光)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 定义状态类</span><span class="token keyword">class</span> <span class="token class-name">OffLight</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">light</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>light <span class="token operator">=</span> light<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// 不同状态在按开关时行为不同</span>  <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span>weakLight<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'变为弱光'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">WeakLight</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">light</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>light <span class="token operator">=</span> light<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span>strongLight<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'变为强光'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">StrongLight</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">light</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>light <span class="token operator">=</span> light<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>light<span class="token punctuation">.</span>offLight<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'熄灯了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 定义上下文类</span><span class="token keyword">class</span> <span class="token class-name">Light</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 手写每一种状态</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>offLight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OffLight</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// new 语句中 this 指向构造对象</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>weakLight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakLight</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// new 语句中 this 指向构造对象</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>strongLight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StrongLight</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// new 语句中 this 指向构造对象</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>curState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offLight<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">setButton</span><span class="token punctuation">(</span><span class="token parameter">dom</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> dom<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>curState <span class="token operator">=</span> state<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>curState<span class="token punctuation">.</span><span class="token function">switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">new</span> <span class="token class-name">Light</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setButton</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'switch'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到上下文中包含了所有状态, 关联行为统一定义在状态中,上下文类只负责调用</p><h3 id="使用有限状态机实现状态模式">使用有限状态机实现状态模式</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">delegate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> delegation</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token function-variable function">buttonWasPressed</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// 将客户的操作委托给delegation 对象</span>      <span class="token keyword">return</span> delegation<span class="token punctuation">.</span><span class="token function">buttonWasPressed</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">var</span> <span class="token constant">FSM</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">off</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token function-variable function">buttonWasPressed</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'关灯'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'下一次按我是开灯'</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onState<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token function-variable function">buttonWasPressed</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'开灯'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'下一次按我是关灯'</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offState<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">var</span> <span class="token function-variable function">Light</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>offState <span class="token operator">=</span> <span class="token function">delegate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">FSM</span><span class="token punctuation">.</span>off<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>onState <span class="token operator">=</span> <span class="token function">delegate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">FSM</span><span class="token punctuation">.</span>on<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>currState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offState<span class="token punctuation">;</span> <span class="token comment">// 设置初始状态为关闭状态</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">Light</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  button<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'已关灯'</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>button <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    self<span class="token punctuation">.</span>currState<span class="token punctuation">.</span><span class="token function">buttonWasPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">var</span> light <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Light</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>light<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="优缺点">优缺点</h3><ul><li>状态及其对应的行为被封装在状态里,非常方便后期新增状态与状态转换</li><li>通过独立状态类避免了 context 类变臃肿</li><li>使用对象表示状态比用字符串更一目了然</li><li>不同状态之间的行为独立</li></ul><h3 id="优化点">优化点</h3><ul><li>动态创造 / 销毁状态而不是全部定义在上下文类中</li><li>共享状态</li></ul><h2 id="适配器模式">适配器模式</h2><p>当两个部分代码由于接口不同不兼容时可以采用适配器模式将不兼容的接口转为兼容接口</p>]]></content>
    
    
    <summary type="html">随手记一些设计模式吧~</summary>
    
    
    
    <category term="计算机理论" scheme="https://blog.liukairui.me/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%90%86%E8%AE%BA/"/>
    
    <category term="设计模式" scheme="https://blog.liukairui.me/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%90%86%E8%AE%BA/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="JavaScript" scheme="https://blog.liukairui.me/tags/JavaScript/"/>
    
    <category term="设计模式" scheme="https://blog.liukairui.me/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>理解Vue</title>
    <link href="https://blog.liukairui.me/article/%E7%90%86%E8%A7%A3Vue/"/>
    <id>https://blog.liukairui.me/article/%E7%90%86%E8%A7%A3Vue/</id>
    <published>2022-08-15T16:00:00.000Z</published>
    <updated>2022-11-08T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="总览">总览</h2><h3 id="vue3-的基本结构">Vue3 的基本结构</h3><p>采用 Monorepo 模式(多组件放在一个 Repo 中), 在<code>/packages/</code> 中存储所有的模块.</p><p><strong>模块分为几类:</strong></p><ul><li>编译时(<code>/package/compiler-*</code>)<ul><li><code>compiler-core</code>: 与平台无关的编译器核心</li><li><code>compiler-dom</code>: 基于 <code>compiler-core</code> 解析<code>&lt;template&gt;</code> 标签并编译为 render 函数</li><li><code>compiler-sfc</code>: 基于 <code>compiler-dom</code> 与<code>compiler-core</code> 解析 SFC (单文件组件, 通俗理解就是<code>.vue</code> 文件) 编译为浏览器可执行的 JavaScript</li><li><code>compiler-ssr</code>: 服务端渲染的编译模块</li></ul></li><li>运行时(<code>/package/runtime-*</code>)<ul><li><code>reactivity</code>: 实现响应式</li><li><code>runtime-core</code>: 基于 <code>reactivity</code>实现运行时核心</li><li><code>runtime-dom</code>: 基于 <code>runtime-core</code>实现针对浏览器的运行时. 包括DOM API, 属性, 事件处理等</li></ul></li><li>其他<ul><li><code>template-explorer</code>: 用于调试编译器输出的开发工具</li><li><code>shared</code>: 多个包之间共享的内容</li><li><code>vue</code>: 完整版本,包括运行时和编译器</li></ul></li></ul><p><strong>依赖关系</strong></p><pre class="line-numbers language-none"><code class="language-none">                                 +---------------------+                                 |                     |                                 |  @vue&#x2F;compiler-sfc  |                                 |                     |                                 +-----+--------+------+                                       |        |                                       v        v                   +---------------------+    +----------------------+                   |                     |    |                      |     +------------&gt;|  @vue&#x2F;compiler-dom  +---&gt;|  @vue&#x2F;compiler-core  |     |             |                     |    |                      |+----+----+        +---------------------+    +----------------------+|         ||   vue   ||         |+----+----+        +---------------------+    +----------------------+    +-------------------+     |             |                     |    |                      |    |                   |     +------------&gt;|  @vue&#x2F;runtime-dom   +---&gt;|  @vue&#x2F;runtime-core   +---&gt;|  @vue&#x2F;reactivity  |                   |                     |    |                      |    |                   |                   +---------------------+    +----------------------+    +-------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>学习路线</strong></p><p>根据模块依赖关系, 路线为: <code>reactivity</code> -&gt;<code>runtime-core</code> -&gt; <code>runtime-dom</code> -&gt;<code>compiler</code>. 重点是 <code>runtime-*</code></p><p><strong>代码分析步骤</strong>:</p><ol type="1"><li>查看单元测试(位于<code>packages/**/__tests__/</code>)</li><li>根据单元测试了解模块实现的功能</li><li>跟着单元测试的了解模块功能, 了解模块功能时: 先看导出(模块是什么),再看模块被谁导入(为什么被需要),最后看导出部分对应的实现(怎么样实现)</li></ol><p><strong>参考 repo</strong></p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2N1aXhpYW9ydWkvbWluaS12dWU=">cuixiaorui/mini-vue<i class="fa fa-external-link-alt"></i></span>:用来学习</li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z1ZWpzL2NvcmU=">vuejs/core<i class="fa fa-external-link-alt"></i></span>:用来验证</li></ul><h3 id="reactivity-的基本流程">Reactivity 的基本流程</h3><p><code>Reactivity</code> 模块是运行时的最底层, 负责实现响应式, 位于:<code>mini-vue/packages/reactivity</code></p><p><strong><code>reactive</code> 的基本流程</strong></p><p><code>reactive</code> 是 <code>Reactivity</code> 的基础.负责实现对象的响应式, 并向上提供调用时方法. 基本思想就是借助 ES6 的<code>Proxy</code> 自定义 <code>get &amp; set</code></p><ol type="1"><li><p>转到 <code>mini-vue/../__tests__/reactive.spec.ts</code>,发现测试的主要目的是看 <code>reactive</code> 构造方法.</p></li><li><p>转到 <code>mini-vue/../src/reactive.ts</code>, 发现定义了<code>reactive</code>, <code>readonly</code> 等方法, 这些方法都交由<code>createReactiveObject</code> 处理.</p><p>观察 <code>createReactiveObject</code>, 可以得到三个调用参数意义:</p><ul><li><p><code>target</code>: 要被代理的值</p></li><li><p><code>proxyMap</code>: 不同类型的工厂函数有不同的全局<code>proxyMap</code>, 这意味着该变量可能会存储所有代理的某类型变量.根据</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> existingProxy <span class="token operator">=</span> proxyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> existingProxy<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>可以验证想法, 其在 <code>createReactiveObject</code> 的目的就是持久化<code>Proxy</code> 防止重复创建代理</p></li><li><p><code>baseHandlers</code>: 根据</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>得出该方法就是 Proxy(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvUHJveHk=">MDN<i class="fa fa-external-link-alt"></i></span>)的 <code>get &amp; set</code> 对象. 不同类型的 Proxy 有不同的<code>baseHandlers</code></p></li></ul></li><li><p>转到 <code>mini-vue/../src/baseHandlers.ts</code>发现模块主要是提供不同的 <code>get &amp; set</code> 而这些都是由两个<code>create</code> 函数实现的, 尝试理解</p><ul><li><p><code>createGetter</code> 应该返回一个<code>handler.get</code>(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvUHJveHkvUHJveHkvZ2V0">MDN<i class="fa fa-external-link-alt"></i></span>)实现. 可以看到这个函数上有一堆类型判断的方法, 然后做了两步</p><ul><li>通过 <code>Reflect.get</code>(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvUmVmbGVjdC9nZXQ=">MDN<i class="fa fa-external-link-alt"></i></span>)获取属性</li><li>通过 <code>track</code> 进行<strong>依赖收集</strong>,这部分后面再看</li></ul><p>最后返回获取结果. 整个 <code>get</code>感觉和原生方法相比就是多了个类型判断和 <code>track</code>,大部分的响应式都是依赖这个 <code>track</code> 实现的</p></li><li><p><code>createSetter</code> 更加简单, 看起来就是在实现<code>handler.set</code>(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvUHJveHkvUHJveHkvc2V0">MDN<i class="fa fa-external-link-alt"></i></span>)的基础上多了个 <code>trigger</code></p></li></ul><p>到目前位置这个只有 <code>track</code> 和 <code>trigger</code>是不清楚的, 这两个函数在 <code>effect</code> 等部分做依赖收集的,可以先不管. 其他部分就是原生功能调用与权限管理</p></li></ol><p><strong><code>effect</code> 的基本流程</strong></p><p>如果让我实现 <code>effect</code> 我会怎么实现呢?我先想到的是利用编译原理等魔法对代码做静态分析, 找到所用响应式对象,在响应式对象的 <code>set</code> 上挂上函数. 但是, JavaScript是个动态语言, 这完全没法挂啊! 只能在运行时动态解析.</p><p>Vue 的实现就比较流畅. 既然我 <code>effect</code> 要立即执行一遍函数,那为啥不在执行前后做下 Flag, 一旦 Proxy 的 <code>get</code> 被调用, 让<code>get</code> 检查一下是不是在 <code>effect</code> 执行阶段,若是就把函数注册到这个响应式对象上😎</p><ol type="1"><li><p>转到 <code>mini-vue/../__tests__/reactive.spec.ts</code> 看到<code>effect</code> 的主要功能是立即执行函数并在响应式数据发生改变时,去执行 <code>effect</code> 注册的函数</p></li><li><p>转到 <code>mini-vue/../src/effect.ts</code> 看<code>effect</code> 函数的实现. 看到这里有熟悉的 <code>effect</code>,<code>track</code>, <code>trigger</code></p><ol type="1"><li><p><code>effect</code> 函数将传入函数包装为<code>ReactiveEffect</code> 对象, 合并配置, 执行 <code>run</code> 函数,构造 <code>runner</code> 并返回(用于后期调用)</p></li><li><p><code>ReactiveEffect</code> 类</p><ul><li><code>active</code>: 根据 <code>run</code>, <code>stop</code>函数和测试文件中的 <code>it("stop")</code> 断言可以推出其是用来开关<code>effect</code> 功能的</li><li><code>deps</code>: 根据 <code>track</code> 与 <code>trigger</code>对其调用可以判断其是用来记录函数对应依赖的</li><li><code>run</code>: 对 <code>effect</code> 注册函数的包装,在执行函数前后打入 <code>shouldTrack</code> 标记, 并将<code>activeEffect</code> 标记为要执行的 <code>ReactiveEffect</code>好让 <code>get</code> 知道哪个 <code>effect</code> 在跑</li></ul></li><li><p><code>track</code> 函数: 在 <code>reactive</code> 的<code>get</code> 中调用</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>track</code> 发现自己处于 <code>effect</code>阶段时会先检查自己所在对象有没有创建 <code>attribute</code> -<code>effect</code> 函数heap 的 <code>map</code>, 如果每就创建, 然后看<code>map</code> 上有没有记录当前属性, 如果没有, 就建立依赖的<code>set</code> 并交由 <code>trackEffects</code> 加入并在<code>ReactiveEffect</code> 上也做记录.</p></li><li><p><code>trigger</code> 函数: 在 <code>reactive</code> 的<code>set</code> 中调用</p><p>先找到对应 <code>attribute</code> 的 <code>effect</code> 依赖, 去重,根据配置延迟或立即支持 <code>effect</code></p></li></ol></li></ol><p><strong>总结</strong></p><ul><li><code>reactive</code> 的流程: 传入对象, 持久化, 绑定<code>baseHandlers</code> 做权限管理与依赖收集</li><li><code>effect</code> 的流程: 将传入函数包装为对象,立即执行函数并做好标记, 在执行时收集依赖. 每当 <code>reactive</code>被调用时就 <code>tigger</code> 收集的 <code>effect</code>,并二次收集依赖</li></ul><p><strong>问题</strong></p><ul><li><p>所有的依赖收集都是基于 <code>get</code>, 这样的<code>effect</code> 存在问题</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should observe basic properties'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> dummy<span class="token punctuation">,</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">num</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      dummy <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  counter<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Except 2, Received -1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>不只是 <code>mini-vue</code>, <code>vue/core</code>的单元测试也存在这个问题. 但是在 <code>Vue</code>代码中并不会出现无法追踪依赖的问题,看来还有一些隐藏的优化没有找到</p></li></ul><h3 id="runtime-core-的基本流程">Runtime-core 的基本流程</h3><p><code>runtime-core</code> 依赖 <code>Reactivity</code> 为 runtime提供服务. 可以通过观察 Vue 文件的运行观察 <code>runtime-core</code>的基本流程</p><p><strong>文件基本结构</strong></p><ol type="1"><li><p>转到 <code>mini-vue/packages/vue/example/helloWorld/</code>的文件夹了解 vue 的基本工作流程</p></li><li><p>转到 <code>mini-vue/../helloWorld/index.html</code>, 只有个<code>div#root</code> 和 <code>script</code></p></li><li><p>转到 <code>mini-vue/.../helloWorld/main.js</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createApp <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../dist/mini-vue.esm-bundler.js'</span><span class="token punctuation">;</span><span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.js'</span><span class="token punctuation">;</span><span class="token keyword">const</span> rootContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span>rootContainer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>引入了创建根组件的 <code>createApp</code> 与根组件 <code>App</code>,查找了 html 文件中声明的挂载点, 然后通过 <code>createApp(App)</code>打包根组件再将打包后结果挂载</p></li><li><p>转到 <code>mini-vue/../helloWorld/App.js</code> 发现定义了两个vue2 风格的组件对象</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'App'</span><span class="token punctuation">,</span> <span class="token comment">// 组件名</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// setup 方法</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 渲染方法</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">tId</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'主页'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span>HelloWorld<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>前面有提到: <code>compiler-dom</code> 将<code>&lt;template&gt;</code> 标签解析并编译为 render 函数.在这里为了不追踪 <code>compiler-dom</code> 的行为, 我们直接将<code>render</code> 给出</p></li><li><p><code>h</code> 为渲染函数, 参数分别是: 组件的<code>ElementType</code>, 配置, 子组件数组, 可以看到,这里第一个子组件是一个 <code>&lt;p&gt;</code> 第二个是一个组件</p></li><li><p>可以在对象中使用 <code>render</code>, 也可以让 <code>setup</code>返回 <code>render</code> 方法, 即</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'App'</span><span class="token punctuation">,</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">tId</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'主页'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span>HelloWorld<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p><code>createApp</code> 调用关系比较复杂, 直接使用 dev-tools观察执行过程. 打开一个 http 服务器并转到 dev-tools下, 找到<code>createApp.js</code> 并打下断点</p></li><li><p><code>createApp</code> 方法接受根组件配置对象 <code>App</code>直接包了个对象, 有</p><ul><li><code>_componment = App</code></li><li><code>mount</code> 方法, 看语义, 这个方法接收挂载点, 将根组件创建为<code>VNode</code> 并挂载到挂载点(<code>main.js</code> 中的<code>rootContainer</code>), 执行完后 <code>main.js</code> 就结束了</li></ul><p>我们需要继续分析的就是 <code>VNode</code> 的创建过程与<code>render</code> 的挂载过程</p></li></ol><p><strong>组件初始化过程</strong></p><ol type="1"><li><p>单步进入 <code>createVNode</code> 发现其声明了个<code>vnode</code>.</p><p>将传入对象(<code>rootComponent / App</code>) 作为<code>vnode.type</code></p><p>在 <code>vnode</code> 上合并对象并配置 <code>shapeFlag</code>用于标记类型</p><p>之后调用 <code>normalizeChildren</code> 并返回对象</p><ul><li>进入 <code>normalizeChildren</code> 看起来是作了 <code>slot</code>特判</li></ul></li><li><p>单步进入 <code>render</code>, 其接收了处理后的 <code>vnode</code>与挂载点 <code>rootContainer</code> 然后将参数直接交给<code>patch</code>, 可以猜到 <code>patch</code> 会是一个很通用的函数</p><ul><li><p>单步进入 <code>patch</code>, 其接收 <code>n1 = null</code>,<code>n2 = vnode</code>, <code>container</code>.</p><p>解构出了<code>n2</code> 的 <code>type = App</code> 与<code>shapeFlag</code>,</p><p>通过预定义的 <code>Symbol</code> 判断对象类型, 进入<code>default</code>,</p><p>通过位运算判断 <code>shapeFlag</code> 类型, 被识别为组件 (而不是像<code>h('p', &#123;&#125;, '主页')</code> 一样的 Element) 执行<code>processComponent</code></p><ul><li><p>单步进入 <code>processComponent</code>,</p><p>函数做了一个判断: 如果没有 <code>n1</code> 就认为 <code>n2</code>还没有被挂载就挂载 <code>n2</code> 否则更新 <code>n2</code></p><ul><li><p>单步进入 <code>mountComponent</code>, 其接收了 <code>vnode</code>与挂载点</p><p>将 <code>vnode</code> 转换为实例 <code>instance</code>, 执行<code>setupComponent</code> 处理 <code>instance</code></p><ul><li><p>单步进入 <code>setupComponent</code> 发现其只是处理了<code>prop</code> 与 <code>slot</code> 然后交给<code>setupStatefulComponent</code> 继续配置</p><ul><li><p>单步进入 <code>setupStatefulComponent</code>, 其接收<code>instance</code></p><p>将 <code>instance.ctx</code> 配置了<code>PublicInstanceProxyHandlers</code> 代理(后面分析)</p><p>提取 <code>Component = APP</code>, <code>setup = APP.setup</code></p><p>如果 <code>setup</code> 不存在就直接<code>finishComponentSetup</code></p><p>否则用 <code>setCurrentInstance</code> 打标记, 为 <code>setup</code>传入参数并获取执行结果, 执行 <code>handleSetupResult</code> 处理结果</p><ul><li><p>单步进入 <code>handleSetupResult</code> 该函数对<code>setup</code> 结果执行判断</p><p>如果是 <code>function</code> 说明是导出了 <code>render</code> 函数,将 <code>render</code> 赋值到 <code>instance.render</code> 上</p><p>否则导出的对象存入 <code>isntance.setupState</code></p><p>最后执行 <code>finishComponentSetup</code> 与无 <code>setup</code>的情况汇合</p></li><li><p>单步进入 <code>finishComponentSetup</code> 其接收<code>instance</code></p><p>若 <code>instance</code> 上没有 <code>render</code> 就尝试从<code>template</code> 编译结果上获取并存入<code>instrance.render</code></p></li></ul></li></ul></li><li><p>单步进入 <code>setupRenderEffect</code> 发现其定义绑定了一个<code>componentUpdateFn</code> 函数</p><ul><li><p>打断点并进入 <code>componentUpdateFn</code> 函数</p><p>如果组件没有被挂载, 获取子节点, 获取 <code>instance</code> 的 Proxy,构建子节点 <code>subTree</code> 并递归 <code>patch</code>, 当<code>patch</code> 到 Element 时调用 <code>processElement</code>挂载节点</p><p>否则更新节点(后面分析)</p></li></ul></li></ul></li></ul></li></ul></li></ul></li></ol><p><strong>组件更新过程</strong></p><p>为组件创建响应式并将 <code>reavtive</code> 导出到全局</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'HelloWorld'</span><span class="token punctuation">,</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">tId</span><span class="token operator">:</span> <span class="token string">'helloWorld'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello world: count: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 dev-tools 中修改 <code>count.value</code> 根据输出来自<code>effect.ts</code> 进入文件并为 <code>run</code> 函数打上断点,再次修改值, 发现 <code>run</code> 函数实际上就是执行了当时的<code>componentUpdateFn</code>, 为 <code>componentUpdateFn</code>中已挂载的判断部分打上断点</p><ol type="1"><li><p>在断点处查看调用栈, 确定函数就是因为 <code>ref</code>修改而引发的</p></li><li><p>在执行修改前先判断有没有 <code>nextTrick</code> 需要执行</p></li><li><p>获取新节点的 <code>vnode</code></p></li><li><p>将老节点子树复制到新节点</p></li><li><p>触发生命周期函数</p></li><li><p><code>patch</code> 新节点</p><p>单步进入 <code>patch</code>, 接受老节点 <code>n1</code> 新节点<code>n2</code> 这次更新的是一个 Element 于是进入<code>ShapeFlags.ELEMENT</code>, 进入 <code>processElement</code></p><ul><li>单步进入 <code>processElement</code>, 这次老节点已经挂载,直接走更新程序<ul><li>单步进入 <code>updateElement</code> 该函数分别对比了<code>props</code> 与 子节点并更新</li></ul></li></ul></li><li><p>触发生命周期函数</p></li></ol><p><strong>总结</strong></p><pre class="mermaid">graph TBinit((初始化组件)) --> createAPp[将App交给createApp, 将App包装为vnode] --- norm1[将vnode应用normalizeChildren配置, 交给render渲染]  --> renderdispatch[render直接交给patch] --> check[patch检查类型] --为组件--> processComponent[交给processComponent判断状态] --为新节点--> mountComponent[执行mountComponent挂载vnode: 构造instance, 运行 setup, 获取 render] --> effect[注册render的effect] --> run[执行effect, 检测是否挂载]  --没有--> patch2(递归patch子节点)update((reactive更新)) -.-> run[执行effect, 检测是否挂载] -.-挂载了-.-> newvnode[构造新vnode, diff检查, 复制属性] -.-> patch2 ==> checkcheck ==为Element==> mountDir(直接修改DOM)</pre><h2 id="实现-reactivity">实现 Reactivity</h2><h3 id="环境搭建">环境搭建</h3><ul><li><p>目录结构</p><p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">.</span>├── jest.config.js├── package.json├── packages│   └── reactivity│       ├── index.ts <span class="token comment"># 入口文件</span>│       └── __tests__ <span class="token comment"># 测试文件</span>│           └── index.spec.ts├── README-EN.md├── README.md└── tsconfig.json <span class="token comment"># tsc --init</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>依赖: <code>typescript</code> / <code>@types/node</code> /<code>jest</code> / <code>ts-jest</code> /<code>@types/jest</code></p></li></ul><h3 id="实现基本-effect-与-reactive">实现基本 <code>effect</code> 与<code>reactive</code></h3><p><strong>TDD</strong></p><p>TDD(Test-Driven Development), 是敏捷开发中的一项核心实践和技术,也是一种设计方法论. TDD的原理是在开发功能代码之前,先编写单元测试用例代码, 测试代码确定需要编写什么产品代码.TDD虽是敏捷方法的核心实践.</p><p><strong>实现基本的 <code>reactive</code></strong></p><p><strong>需求</strong>: 最简单的 <code>reactive</code>,输入对象并输出对象的代理. 代理对象修改时原对象同步修改</p><ol type="1"><li>测试 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Should different'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输入对象并返回代理对象</span>  <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// observed 和原来的不是一个对象</span>  observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 两者同步修改</span>  <span class="token function">expect</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>实现 只需要为对象配置一个普通代理 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 就是给一个对象, 返回一个 new Proxy</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 语法见 https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/get</span>    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">// 语法见 https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/set</span>    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 唯一的难点就是<code>Proxy</code> 语法</li><li>重构: 无</li></ol><p><strong>实现基本的 <code>effect</code></strong></p><p><strong>需求</strong>: 1. 输入函数, 执行函数, 当函数中被<code>[GET]</code> 的响应式对象发生变化时重新执行函数 2. 返回一个函数<code>runner</code>, 当执行 <code>runner</code> 时执行<code>effect</code> 传入的函数</p><p><strong>需求分析</strong>: 1. 为什么是函数中被 <code>[GET]</code>的响应式对象变化时重新执行函数, <code>[SET]</code> 不行吗? 不行,响应式对象被 <code>[SET]</code> 后如果执行了函数, 响应式对象会被重新<code>[SET]</code>, 那么上一次 <code>[SET]</code> 就没用了.同时如果函数中其他变量不变只有响应式对象被 <code>[SET]</code>此时执行函数并不会使得函数中变量值发生变化(毕竟变化的响应式变量没有被<code>[GET]</code>), 不会产生 sideEffect. 2. 执行流程: 开始执行函数-&gt; <code>[GET]</code> 响应式对象 -&gt; 结束执行函数 -&gt;当响应式对象被 <code>[SET]</code> -&gt; 执行函数可以发现只需要让响应式对象知道当自己变化时哪些 <code>effect</code>需要执行就可以了, 至于 <code>effect</code>知不知道响应式对象是谁那无所谓. 可以在函数执行期间执行依赖收集, 为<code>[GET]</code> 的响应式对象注册 Effect Function,在响应式对象修改时执行其注册的 Effect Function.</p><p> </p><ol type="1"><li>测试: <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Effect test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Should sync'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> bar<span class="token punctuation">;</span>    <span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      bar <span class="token operator">=</span> observed<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// origin -> observed</span>    <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 立即执行 fn</span>    observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 修改有 [GET] 的响应式对象</span>    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 响应式对象变化</span>    <span class="token function">expect</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 原对象变化</span>    <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行函数</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Should return runner'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span>info <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 劫持 console.info</span>    <span class="token keyword">let</span> bar<span class="token punctuation">;</span>    <span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'I RUN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      bar <span class="token operator">=</span> observed<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 立即执行 fn, console.info 被调用 1 次</span>    observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 响应式对象发生变化执行 fn, console.info 被调用 2 次</span>    <span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 手动调用 runner, console.info 被调用 3 次</span>    <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>实现 利用 <code>targetMap</code> 实现响应式对象 -&gt; Key -&gt;Effective Function 的映射. 导出 <code>track</code> 与<code>trigger</code> 用于收集与触发依赖 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// target: Object => keyMap:(string=>Set)</span><span class="token comment">// keyMap: string => Set</span><span class="token keyword">const</span> <span class="token literal-property property">targetMap</span><span class="token operator">:</span> Map<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>EffectReactive<span class="token operator">>>></span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> <span class="token literal-property property">activeEffectFn</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">EffectReactive</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">runner</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> any<span class="token punctuation">;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>runner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    activeEffectFn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// 全局注册当前正在收集依赖的 Effect</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行函数</span>    activeEffectFn <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// 取消注册</span>  <span class="token punctuation">&#125;</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 考虑到 effect 上动作很多, 我们将其抽离为 EffectFunction 函数</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EffectReactive</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">.</span>runner<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 依赖收集函数, 由 `[GET]` 触发, 该函数检查是否有 active 的 Effect, 有就收集依赖</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>targetMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> keyMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> keyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> dependenceEffect <span class="token operator">=</span> keyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>  dependenceEffect<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 触发函数, 当响应式对象被 `[SET]` 时尝试触发其收集的所有 Effect</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> keyMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyMap<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> depSet <span class="token operator">=</span> keyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depSet<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">[</span><span class="token operator">...</span>depSet<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 在<code>Proxy</code> 上同步修改 <pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">export function reactive(origin) &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> return new Proxy(origin, &#123;</span><span class="token prefix unchanged"> </span><span class="token line">   get(target, key, receiver) &#123;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     track(target, key);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     return Reflect.get(target, key, receiver);</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;,</span><span class="token prefix unchanged"> </span><span class="token line">   set(target, key, value, receiver) &#123;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     // 这两行顺序反了就寄了</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     const res = Reflect.set(target, key, value, receiver);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">     trigger(target, key);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     return res;</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;,</span><span class="token prefix unchanged"> </span><span class="token line"> &#125;);</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>重构: 上面这个代码有点问题, 我们只在构造 EffectFunction时收集了依赖, 但是并不能收集全 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'dym track'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observe1 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> origin2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observe2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>    ob <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      ob <span class="token operator">=</span> observe1<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      ob <span class="token operator">=</span> observe2<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    cnt<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>ob<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  observe1<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>ob<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  observe2<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>ob<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 这个测试就无法通过, 因为<code>observe2</code> 理论上应该在 <code>observe1.set</code> 调用<code>run</code> 的时候收集依赖, 所以应该修改构造函数和 <code>run</code>为 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> fn<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// ...</span>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  activeEffect <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 我们知道, 所有的依赖收集都是通过 fn 中对 reactive 的<code>[GET]</code> 实现的, 我可以保证只要执行 <code>fn</code>在其前后都加入了依赖收集的 flag 就可以. 调用 <code>fn</code>只可能发生在</li><li>构造函数</li><li>手动执行 <code>runner</code></li><li>reactive 执行 <code>[SET]</code> 触发 trigger</li></ol><p>这三部分要执行的都是 <code>run</code> 我们可以保证只要执行<code>run</code> 就触发依赖收集</p><h3 id="实现-effect-的-scheduler-选项-watch">实现 <code>effect</code> 的<code>scheduler</code> 选项 (<code>watch</code>)</h3><p><strong>需求</strong>: 为 <code>effect</code> 传入第二个参数,参数是一个对象, 其中包含 <code>scheduler</code> 函数, 当构造 Effect时执行传入的第一个函数参数, 当响应式函数变化时执行<code>scheduler</code> 函数. 这与 Vue 3 的 <code>watch</code> 类似</p><p><strong>需求分析</strong>: 在构造 Effect的时候传入配置并在触发的时候判断是否有 <code>scheduler</code> 函数</p><ol type="1"><li>测试</li></ol><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Shound run scheduler'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> bar<span class="token punctuation">;</span>  <span class="token function">effect</span><span class="token punctuation">(</span>    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      bar <span class="token operator">=</span> observed<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span> <span class="token comment">// 传入配置</span>      <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        bar <span class="token operator">=</span> <span class="token operator">-</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一次运行 fn 函数</span>  observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第二次运行 scheduler 函数</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><ol start="2" type="1"><li>实现</li></ol><ul><li>修改 effect 函数, 加入配置项 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EffectReactive</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">.</span>runner<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li>修改 EffectReactive 的构造函数加载配置项 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">EffectReactive</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">runner</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> any<span class="token punctuation">;</span>  <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> any <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> fn<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>scheduler <span class="token operator">=</span> options<span class="token punctuation">.</span>scheduler<span class="token punctuation">;</span>    <span class="token comment">// ...</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>修改触发函数 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// ...</span>  <span class="token punctuation">[</span><span class="token operator">...</span>depSet<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>scheduler <span class="token operator">?</span> d<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> d<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li>重构: 无</li></ul><p><strong>什么时候尝试抽离函数 / 对象</strong></p><ol type="1"><li>函数上有很多动作</li><li>函数作用范围广, 语义差</li></ol><h3 id="实现-effect-的-stop-与-onstop-选项">实现 <code>effect</code> 的<code>stop</code> 与 <code>onStop</code> 选项</h3><p><strong>需求</strong>: 1. 定义一个外部函数 <code>stop</code>. 传入<code>runner</code> 让 <code>runner</code> 不再被响应式对象 trigger 2.<code>effect</code> 中加入 <code>onStop</code> 配置, 在<code>stop</code> 时调用</p><p><strong>需求分析</strong>: 只需要将 EffectFunction从响应式对象的依赖表中删除即可. 但是我们之前就没记录有哪些响应式对象将EffectFunction 作为依赖..., 所以需要开一个 Set 记录这些响应式对象. 同时,我们不需要记录依赖的对象是什么, 只需要记录 KeyMap 对应的 Set.</p><ol type="1"><li>测试 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Should stop trigger'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> bar<span class="token punctuation">;</span>  <span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      bar <span class="token operator">=</span> observed<span class="token punctuation">.</span>foo<span class="token punctuation">;</span> <span class="token comment">// 立即执行</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>bar <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> bar <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 如果首次调用置 0</span>        bar<span class="token operator">--</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 立即执行</span>  <span class="token function">stop</span><span class="token punctuation">(</span>runner<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 停止后第一次执行为 -1</span>  observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// reactive 变化也不调用 fn</span>  <span class="token function">stop</span><span class="token punctuation">(</span>runner<span class="token punctuation">)</span>  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 反复 stop 不反复执行 onStop</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>实现 修正 EffectReactive <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">EffectReactive</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">runner</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// effect 只返回 runner, stop 函数需要根据 runner 找到 EffectReactive, 所以要在函数上加一个属性记录一下</span>    <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">;</span>    effect<span class="token operator">?</span><span class="token operator">:</span> EffectReactive<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token function-variable function">onStop</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> any <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// stop 回调</span>  <span class="token literal-property property">deps</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>Set<span class="token operator">&lt;</span>EffectReactive<span class="token operator">>></span><span class="token punctuation">;</span> <span class="token comment">// 收集了这个函数依赖的变量的依赖表集合</span>  <span class="token literal-property property">active</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span> <span class="token comment">// EffectReactive 是否运行 (stop 时置 0)</span>  <span class="token comment">// ...</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> fn<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>runner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>runner<span class="token punctuation">.</span>effect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>onStop <span class="token operator">=</span> options<span class="token punctuation">.</span>onStop<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token comment">// ...</span>  <span class="token punctuation">&#125;</span>  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 如果用户手动执行 runner 那么只执行 fn, 不追踪依赖, 放置依赖追踪给已经解除依赖的元素再绑定上依赖</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    activeEffect <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> res<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 修正依赖收集函数<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//</span>  dependenceEffect<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 为当前正在依赖收集的 effect 的依赖上加入这个 key 的依赖表</span>  activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependenceEffect<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 实现 <code>stop</code> 函数 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token parameter">runner</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 不反复执行</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>runner<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  runner<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 找到所有收集过 effect 的变量, 将 effect 从依赖表中删除</span>  <span class="token punctuation">[</span><span class="token operator">...</span>runner<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>deps<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>effect<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 执行 onStop</span>  runner<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>onStop <span class="token operator">&amp;&amp;</span> runner<span class="token punctuation">.</span>effect<span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>重构: 无</li></ol><h3 id="实现-proxy-的-readonly">实现 <code>Proxy</code> 的<code>Readonly</code></h3><p><strong>需求</strong>: <code>readonly</code> 与 <code>reactive</code>类似, 不过不支持 <code>set</code></p><p><strong>需求分析</strong>: 一个元素不支持 <code>set</code>也就不可能触发依赖, 所以也没有必要做依赖收集. 所以只需要精简一下<code>reactive</code>. 可以发现,不同权限的变量只是在构造的时候采用不同的 <code>[GET]</code> 与<code>[SET]</code> 策略. 可以将 <code>[GET]</code> 与 <code>[SET]</code>抽离出来</p><ol type="1"><li>测试 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Happy path'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span>warn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将原始对象包装为只读对象</span>  <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最开始不报错</span>  observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 修改, 静默失效, 报 warning</span>  <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// warning 被调用一次</span>  <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// readOnly 静默失效</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>实现 抽离 <code>[GET]</code> 与 <code>[SET]</code> <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// reactive 的 [GET]</span><span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// reactive 的 [SET]</span><span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">getReadonly</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">setReadonly</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Can not set readonly'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 要返回一下设置结果, 如果返回 false 会抛出异常, 而我们只希望静默失效</span>  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">const</span> proxyConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  get<span class="token punctuation">,</span>  set<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> proxyReadonlyConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">get</span><span class="token operator">:</span> getReadonly<span class="token punctuation">,</span>  <span class="token literal-property property">set</span><span class="token operator">:</span> setReadonly<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>抽离对象创建函数 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span><span class="token parameter">origin<span class="token punctuation">,</span> readonly <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>readonly<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> proxyReadonlyConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> proxyConfig<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre> 重写 <code>reactive</code> 实现<code>readonly</code> <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>重构: 上面的就是重构后的代码</li></ol><h3 id="实现工具函数-isreadonly-isreactive-isproxy">实现工具函数<code>isReadonly</code>, <code>isReactive</code>,<code>isProxy</code></h3><p><strong>需求</strong>: 实现工具函数, <code>isReadonly</code>,<code>isReactive</code>, <code>isProxy</code>(前两个函数二选一).</p><p><strong>需求分析</strong>: 只需要在 <code>[GET]</code> 上特判即可</p><ol type="1"><li>测试 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'isReadonly test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReadonly</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'isReactive test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReadonly</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'isProxy test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isProxy</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>实现 构造个枚举 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> ReactiveFlag <span class="token punctuation">&#123;</span>  <span class="token constant">IS_REACTIVE</span> <span class="token operator">=</span> <span class="token string">'__v_isReactive'</span><span class="token punctuation">,</span>  <span class="token constant">IS_READONLY</span> <span class="token operator">=</span> <span class="token string">'__v_isReadonly'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre> 实现函数 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isReactive</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 要转一下 Boolean 因为非 reactive 对象会返回 undefined</span>  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>value<span class="token punctuation">[</span>ReactiveFlag<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isReadonly</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>value<span class="token punctuation">[</span>ReactiveFlag<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isProxy</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">isReactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isReadonly</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 修改<code>[GET]</code> <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> reactiveFlags <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">[</span>ReactiveFlag<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span>ReactiveFlag<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> readonlyFlags <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">[</span>ReactiveFlag<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span>ReactiveFlag<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reactiveFlags<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token operator">=></span>d<span class="token operator">===</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> reactiveFlags<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">getReadonly</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>readonlyFlags<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token operator">=></span>d<span class="token operator">===</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> readonlyFlags<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>重构: 无</li></ol><h3 id="实现-reactive-readonly-嵌套">实现 <code>reactive</code> /<code>readonly</code> 嵌套</h3><p><strong>需求:</strong> 若 <code>reactive</code> /<code>readonly</code> 内部 value 为对象, 那么该对象也应该是<code>reactive</code> / <code>readonly</code></p><p><strong>需求分析:</strong> 我最开始的想法是在构造<code>reactive</code> 的时候遍历所有属性, 然后为这些属性配置<code>reactive</code>. 然而, 这无法将动态添加的对象转为<code>reactive</code>. 考虑需求, 我们希望让内层对象支持 reactive,实际上是希望让内层对象也支持依赖收集等 <code>reactive</code> 功能,而这些功能都是在对象被 <code>[GET]</code> 的时候被激活的.也就是说我们最晚可以在首次访问属性的将内层对象转换为<code>reactive</code>.</p><ol type="1"><li>测试(只写了 <code>reactive</code> 的) <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Should nested track'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observe <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observe<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observe<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observe<span class="token punctuation">.</span>bar<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>实现 只需要在 <code>[GET]</code> 的时候判断属性是否是对象,如果是对象那么返回包装后的 <code>reactive</code></li></ol><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reactiveFlags<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d <span class="token operator">===</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> reactiveFlags<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取结果</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果结果是对象, 将其包装为 reactive</span>  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">getReadonly</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>readonlyFlags<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d <span class="token operator">===</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> readonlyFlags<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取结果</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">readonly</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果结果是对象, 将其包装为 readonly</span>  <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 在 <code>packages/share/index.ts</code>中构造工具函数判断输入是否是对象 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> v <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> v <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre> 3. 改进:我们并没有实现内层 reactive 的持久化, 也就是说每次 reactive的结果是不同的... 实现内层对象持久化 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> reactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> readonlyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reactiveMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span>    reactiveMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> reactiveMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>readonlyMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span>    readonlyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> readonlyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p><strong>注意</strong></p><ol type="1"><li><strong>JS是动态语言, 不要尝试做静态代码分析</strong>:我们在实现功能的时候应该考虑什么时候完成工作不晚,不遗漏而不是相静态语言一样想什么时候可以操作数据</li><li><strong>实现功能时想想这个功能希望我们对外表现为什么样子</strong>:思考是什么而不是怎么做, 比如内层 reactive的第一版代码并没有实现将对象转为 reactive 并附着在对象上,而是考虑如果一个内层对象是 reactive, 那么我们应该在 <code>[GET]</code>的时候表现的与原始对象不同. 这就启发我们只需要在 <code>[GET]</code>的时候处理数据就可以而不需要在构造对象的时候实现这一功能.</li></ol><h3 id="实现-shadowreadonly">实现 <code>shadowReadonly</code></h3><p><strong>需求:</strong> <code>shadowReadonly</code>就是只对对象外层实现 readonly, 内部对象不管, 不 Proxy</p><p><strong>需求分析:</strong> 实际上就是不支持嵌套的 readonly</p><ol type="1"><li>测试 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Happy path'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">shadowReadonly</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span>warn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 外层禁止修改</span>  <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  observed<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 内部不管</span>  <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isProxy</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>实现 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">getShadowReadonly</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>readonlyFlags<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d <span class="token operator">===</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> readonlyFlags<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 其实就是不支持嵌套追踪的 readonly. shadowReadonly 的元素一定是非 reactive 对象, 所以直接返回</span>  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">const</span> proxyShadowReadonlyConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">get</span><span class="token operator">:</span> getShadowReadonly<span class="token punctuation">,</span>  <span class="token literal-property property">set</span><span class="token operator">:</span> setReadonly<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 实现 shadowReadonly <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> shadowReadonlyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span><span class="token parameter">origin<span class="token punctuation">,</span> readonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shadow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>shadow <span class="token operator">&amp;&amp;</span> readonly<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> proxyShadowReadonlyConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>readonly<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> proxyReadonlyConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> proxyConfig<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">shadowReadonly</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shadowReadonlyMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span>    shadowReadonlyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> shadowReadonlyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>重构</li></ol><h3 id="实现-ref">实现 <code>ref</code></h3><p><strong>需求</strong>: 实现 <code>ref</code> - 如果<code>ref(value)</code> 输入的是不是对象, 那么可以 - 通过<code>.value</code> 访问值 - 通过 <code>.value</code> 更新值,如果赋值时新值与旧值一样则什么都不做 - 支持类似 <code>reactive</code>的依赖收集与触发 - 如果 <code>ref(value)</code> 输入的是对象, 那么可以 -在上面的基础上对要求对象支持 <code>reactive</code></p><p><strong>需求分析</strong>:</p><ul><li>我最开始想到的是 <code>ref = (value) =&gt; reactive(&#123;value&#125;)</code>但是如果只是这么简单实现, 那么 <code>ref</code> 的非 <code>value</code>属性也将变为 <code>reactive</code>. 同时可以预见这样实现的<code>ref</code> 性能不及标准 <code>ref</code>.</li><li><code>ref</code> 的特点是<strong>外层有且只有</strong><code>value</code> 一个 <code>key</code>, 这意味我们在实现时<ul><li>不用使用全局 <code>targetMap</code> (只有一个depSet)</li><li>不用像 <code>reactive</code> 一样实现一个 Proxy, 可以只实现一个<code>[GET]</code> &amp; <code>[SET]</code>.</li></ul></li><li>考虑到 <code>ref</code> 的<strong>输入可能是对象或非对象</strong><ul><li>我们能不使用全局的 <code>targetMap</code>, 否则两个值相同的<code>ref</code> 会被判定为同一个 <code>keyMap</code></li><li>若输入为对象, 在对比赋值时新值与旧值一样不能简单的比较<code>_value === newValue</code>. 若输入为对象, 那么<code>reactive(obj) !== obj</code>. 我们还需要保存输入的原始值</li></ul></li></ul><ol type="1"><li><p>测试 <code>ref</code> 非对象时 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should be reactive'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> dummy<span class="token punctuation">;</span>  <span class="token keyword">let</span> calls <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    calls<span class="token operator">++</span><span class="token punctuation">;</span>    dummy <span class="token operator">=</span> a<span class="token punctuation">.</span>value<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构造 EffectFunction 执行一次</span>  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  a<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// ref 也支持依赖收集与触发</span>  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  a<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 同值不触发</span>  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> <code>ref</code>对象时要把内层对象变为 <code>reactive</code>, 对象也可以变为非对象<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should convert to reactive'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> dummy<span class="token punctuation">;</span>  <span class="token keyword">let</span> calls <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    calls<span class="token operator">++</span><span class="token punctuation">;</span>    dummy <span class="token operator">=</span> a<span class="token punctuation">.</span>value<span class="token punctuation">.</span>foo <span class="token operator">?</span> a<span class="token punctuation">.</span>value<span class="token punctuation">.</span>foo <span class="token operator">:</span> a<span class="token punctuation">.</span>value<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构造 EffectFunction 执行一次</span>  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  a<span class="token punctuation">.</span>value<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// ref 也支持依赖收集与触发</span>  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  a<span class="token punctuation">.</span>value <span class="token operator">=</span> origin<span class="token punctuation">;</span> <span class="token comment">// 同值不触发</span>  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  a<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 同值不触发</span>  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  a<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// 变为非对象</span>  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>实现</p></li></ol><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 与 reactive 直接返回一个 Proxy 不同, 我们只有 value 一个属性, 所以要手动实现一个对象</span><span class="token keyword">class</span> <span class="token class-name">RefImpl</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 这里我们不使用全局的 targetMap 原因是</span>  <span class="token comment">//   - 我们这里的 Key 可以不是对象, 两个值相同的 ref 会被判定为同一个 key</span>  <span class="token comment">//   - 只存在一个 Key: value, 所以没有必要使用两个 Map, 只需要一个 Set 就可以存储所有的 EffectReactive</span>  <span class="token keyword">private</span> <span class="token literal-property property">deps</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>EffectReactive<span class="token operator">></span><span class="token punctuation">;</span>  <span class="token keyword">private</span> _value<span class="token punctuation">;</span>  <span class="token keyword">private</span> rawValue<span class="token punctuation">;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>rawValue <span class="token operator">=</span> value<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// 只需要 value 的 [SET] [GET] 就可以实现</span>  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">trackEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 依赖追踪</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 重复赋值不触发, 考虑两种情况</span>    <span class="token comment">//   - this._value 不是 Object, 直接比较</span>    <span class="token comment">//   - this._value 是 Object, 此时 this._value 是一个 reactive, reactive(obj) !== obj, 必须使用原始值比较</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rawValue <span class="token operator">===</span> newValue<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>rawValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token function">isObject</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token operator">:</span> newValue<span class="token punctuation">;</span>    <span class="token function">triggerEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发依赖</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RefImpl</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 在这里, <code>trackEffect</code> 与<code>triggerEffect</code> 相当于不需要查 <code>Set</code> 的<code>track</code> 与 <code>trigger</code>(因为只有一个<code>Set</code>). 我们可以将原来的 <code>track</code> 与<code>trigger</code> 拆开</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>targetMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> keyMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> keyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 抽成一个函数</span>  <span class="token function">trackEffect</span><span class="token punctuation">(</span>keyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trackEffect</span><span class="token punctuation">(</span><span class="token parameter">dependenceEffect</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 本来只需要在 track 上判断 activeEffect 但是这个函数可能被 track 或者 RefImpl 调用, 所以还需要在判断一次</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  dependenceEffect<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>  activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependenceEffect<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> keyMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyMap<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> depSet <span class="token operator">=</span> keyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depSet<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">// 抽成一个函数</span>  <span class="token function">triggerEffect</span><span class="token punctuation">(</span>depSet<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">triggerEffect</span><span class="token punctuation">(</span><span class="token parameter">depSet</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">[</span><span class="token operator">...</span>depSet<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>scheduler <span class="token operator">?</span> d<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> d<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="实现工具函数-isref-unref-proxyrefs">实现工具函数<code>isRef</code> &amp; <code>unRef</code> &amp;<code>proxyRefs</code></h3><p><strong>需求</strong>: - <code>isRef</code>: 判断输入是不是<code>ref</code> - <code>unRef</code>: 返回 <code>ref</code> 的<code>value</code> - <code>proxyRefs</code>: 模拟 Vue3 的 setup 函数,通过该函数返回的对象中的 <code>ref</code> 在模板字符串中无需<code>.value</code> 即可访问与赋值. 简单来说就是输入对象,在访问对象中浅层 <code>ref</code> 的 <code>Key</code> 时无需<code>.value</code> 即可访问</p><p><strong>需求分析</strong>: - <code>isRef</code>: 加一个 flag 即可 -<code>unRef</code>: 判断是不是 <code>ref</code>, 是就返回<code>ref.value</code> - <code>proxyRefs</code>: 构造一个代理,在读写是判断读写目标是不是 <code>ref</code> 如果是就返回<code>ref.value</code>. 同时, 在 <code>[SET]</code> 时, 如果新旧值都是<code>ref</code> 那么直接替换掉旧 <code>ref</code></p><ol type="1"><li><p>测试 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'isRef'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> origin2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed1 <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>origin1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed2 <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>origin1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>observed1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>observed2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'unRef'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> origin1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> origin2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed1 <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>origin1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed2 <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">unRef</span><span class="token punctuation">(</span>observed1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>origin1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">unRef</span><span class="token punctuation">(</span>observed2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">unRef</span><span class="token punctuation">(</span>observed2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">unRef</span><span class="token punctuation">(</span>observed2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token function">reactive</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'proxyRefs'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">sampleRef</span><span class="token operator">:</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">sampleStr</span><span class="token operator">:</span> <span class="token string">'demo'</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> proxyUser <span class="token operator">=</span> <span class="token function">proxyRefs</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>sampleRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>proxyUser<span class="token punctuation">.</span>sampleRef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>proxyUser<span class="token punctuation">.</span>sampleStr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">(</span>proxyUser <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>sampleRef <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>proxyUser<span class="token punctuation">.</span>sampleRef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>sampleRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  proxyUser<span class="token punctuation">.</span>sampleRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>proxyUser<span class="token punctuation">.</span>sampleRef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>sampleRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>实现</p></li></ol><p>打flag <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">RefImpl</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">public</span> __v_isRef <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre> 实现 <code>isRef</code> 与 <code>unRef</code><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">unRef</span><span class="token punctuation">(</span><span class="token parameter">ref</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">isRef</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token operator">?</span> ref<span class="token punctuation">.</span>value <span class="token operator">:</span> ref<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isRef</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>value<span class="token operator">?.</span>__v_isRef<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 实现 <code>proxyRef</code> <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">proxyRefs</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> proxyProxyRefConfig<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">getProxyRef</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 不用这么麻烦</span>  <span class="token comment">// if (isRef(target[key])) return target[key].value;</span>  <span class="token comment">// return target[key];</span>  <span class="token keyword">return</span> <span class="token function">unRef</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">setProxyRef</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 只特判 ref &lt;- 普通值</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">const</span> proxyProxyRefConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">get</span><span class="token operator">:</span> getProxyRef<span class="token punctuation">,</span>  <span class="token literal-property property">set</span><span class="token operator">:</span> setProxyRef<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 3. 重构: 无</p><h3 id="实现-computed">实现 <code>computed</code></h3><p><strong>需求:</strong> 1. 输入一个函数, 返回一个对象, 可以通过<code>.value</code> 获取函数返回值, 当函数内部 <code>reactive</code>变化时, 返回值也要变化. 2. 支持 Lazy, 即: 1. 在 <code>computed</code>内部 <code>reactive</code> 变化时不触发 <code>computed</code> 传入函数2. 在 <code>[GET]</code> 时才触发 <code>computed</code> 传入函数 3.若内部 <code>reactive</code> 不变, 重复触发 <code>[GET]</code>不重复触发传入函数 3. 返回值也是一个 <code>reactive</code> 对象, 即<code>.value</code> 变化时要触发依赖</p><p><strong>需求分析:</strong></p><ol type="1"><li>测试 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should reactive'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    cnt<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> observed<span class="token punctuation">.</span>foo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Lazy</span>  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Lazy</span>  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Lazy</span>  <span class="token function">expect</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 返回值也可以收集依赖</span><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should trigger effect'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> cValue <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> dummy<span class="token punctuation">;</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    dummy <span class="token operator">=</span> cValue<span class="token punctuation">.</span>value<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  value<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>实现</li></ol><ul><li>构造一个 <code>old</code>, 当内部 reactive 变化时修改,如果内部不变就直接使用原 <code>_value</code></li><li>类似构造 <code>ref</code> 的 <code>dep</code> 收集<code>.value</code> 的依赖</li><li>我们希望在第一次 <code>[GET]</code> 的时候收集依赖, 这可以使用<code>EffectReactive</code> 实现, 但是为了实现 Lazy 我们又不希望每次内部<code>reactive</code> 变化都触发依赖. 我们可以采用<code>scheduler</code> 解决, 每次内部 <code>reactive</code>变化时候打下标记(<code>old</code>), 并通知 <code>computed</code>要触发依赖了. 如果 <code>computed</code> 没有依赖那这次就 Lazy 过去了,如果有那在触发依赖时其他函数会调用计算属性的 <code>[GET]</code>此时完成刷新</li></ul><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>  effect<span class="token punctuation">,</span>  EffectReactive<span class="token punctuation">,</span>  trackEffect<span class="token punctuation">,</span>  triggerEffect<span class="token punctuation">,</span><span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./effect'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">ComputedImpl</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">old</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>  <span class="token literal-property property">fst</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>  <span class="token literal-property property">_value</span><span class="token operator">:</span> any<span class="token punctuation">;</span>  <span class="token literal-property property">dep</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>EffectReactive<span class="token operator">></span><span class="token punctuation">;</span>  effect<span class="token operator">!</span><span class="token operator">:</span> EffectReactive<span class="token punctuation">;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>old <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>fst <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">trackEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 为啥人家的代码没 fst 呢? 因为人家的 EffectReactive 每在构造函数的时候 run. 人家可以在构造函数里面注册这个 effect</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fst<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>fst <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EffectReactive</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>old <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>          <span class="token function">triggerEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>old<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>old <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>effect<span class="token punctuation">.</span><span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">triggerEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Can not set computed value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComputedImpl</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> - 重构: 考虑修改 <code>EffectReactive</code>构造函数</p><h3 id="小结">小结</h3><ul><li>实现 <code>Reactivity</code> 的核心就是一个 <code>Proxy</code>.通过修改 <code>[GET]</code> &amp; <code>[SET]</code> 实现不同权限</li><li>时刻谨记 JavaScript 是动态语言, 对象上的属性随时在变化,不要想在某一个对对象上的属性做特殊处理, 很容易遗漏,我们可以想想什么时候外部需要我们特殊处理的特性, 在出口处"围追堵截"</li><li>注意我们应该在什么时候抽象函数<ul><li>语义上可以抽象时候</li><li>功能重复时</li></ul></li><li>当函数功能部分重叠时要敢于拆分函数</li><li><code>ref</code> 相当于是一个整体功能弱化的 <code>reactive</code>,所以我们没有使用全局 <code>targetMap</code></li><li><code>computed</code> 的实现比较巧妙, 运用了一个 effect 的配置项,我们在实现工具函数的时候也可以想想是否可以通过配置项将两个功能类似的类合并成一个类.</li></ul><h2 id="实现-runtime-core-的-mount-部分">实现 runtime-core 的 mount部分</h2><h3 id="搭建环境">搭建环境</h3><p>runtime-core 直接参与页面实现, 我们需要利用打包工具打包代码.在打包网页时一般使用 webpack, 而在打包模块时一般使用 rollup.js. 安装rollup 及其 TypeScript 依赖</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">pnpm</span> i <span class="token parameter variable">-D</span> rollup @rollup/plugin-typescript tslib rollup-plugin-sourcemaps<span class="token comment">#         ^ 本体  ^ typescript 支持          ^ TS 支持依赖</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>配置 rollup</p><ul><li>创建 <code>/package/index.ts</code> 作为整个项目的出口</li><li>创建 rollup 配置文件 <code>/package/rollup.config.js</code><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> typescript <span class="token keyword">from</span> <span class="token string">'@rollup/plugin-typescript'</span><span class="token punctuation">;</span><span class="token keyword">import</span> sourceMaps <span class="token keyword">from</span> <span class="token string">'rollup-plugin-sourcemaps'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">'./packages/index.ts'</span><span class="token punctuation">,</span> <span class="token comment">// 入口文件</span>  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token comment">// 2种输出格式</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span> <span class="token comment">// 输出格式</span>      <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token string">'./lib/micro-vue.cjs.js'</span><span class="token punctuation">,</span> <span class="token comment">// 输出路径</span>      <span class="token literal-property property">sourcemap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'es'</span><span class="token punctuation">,</span>      <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token string">'./lib/micro-vue.esm.js'</span><span class="token punctuation">,</span>      <span class="token literal-property property">sourcemap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">typescript</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sourceMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>执行 <code>rollup -c ./rollup.config.js</code> 打包</li><li>根据提示将 <code>tsconfig.json</code> 中<code>"module": "commonjs"</code> 改为<code>"module": "ESNext"</code></li><li>在 <code>package.json</code> 中注册包的入口文件, <code>main</code>对应 commonjs 包, <code>module</code> 对应 ESM 包 <pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"lib/micro-vue.cjs.js"</span><span class="token punctuation">,</span><span class="token property">"module"</span><span class="token operator">:</span> <span class="token string">"lib/micro-vue.esm.js"</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h3 id="构造测试用例">构造测试用例</h3><p>我们构造一个简单的 Vue demo 并尝试实现 vue-runtime主流程使其可以将我们的 demo 渲染出来, Vue 项目一般包含如下文件</p><ul><li><code>index.html</code>: 至少包含一个挂载点</li><li><code>index.js</code>: 引入根组件, 将根组件挂载到挂载点</li><li><code>App.vue</code>: 定义根组件</li></ul><p>SFC 需要 vue-loader 编译才能实现. 而 vue-loader 的作用是将 SFC 处理为<code>render</code> 函数, 在此我们只能先将 <code>App.vue</code> 处理为vue-loader 编译后函数. 定义</p><ul><li><code>index.html</code>: 只构造一个挂载点并引入 JS<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>micro-vue runtime-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./index.js<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>model<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><code>index.js</code>: 先不管有没有这些函数, 平时咋写就咋写<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createApp <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../lib/micro-vue.esm'</span><span class="token punctuation">;</span><span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span><span class="token punctuation">;</span><span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><code>App.js</code>: <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../lib/micro-vue.esm.js'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"222"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><code>App.js</code> 默认导出了一个配置对象, 该对象应该包含 SFC中导出的 <code>setup</code> 与 vue-loader 编译得到的 <code>render</code>函数. 其中</p><ul><li><code>setup</code> 函数的返回值可以是对象, 也可以是渲染函数</li><li>在解析 SFC 文件时, 如果用户手动通过 <code>setup</code>返回了渲染函数那么 vue-loader 就不编译模板,如果没有返回则编译模板并构造渲染函数 <code>render</code>.<code>render</code>函数描述了<strong>这个组件里面</strong>应该如何渲染</li><li><code>render</code> 中的 <code>h</code> 用于表述一个组件/元素,语法为: <code>h(type, attr, children)</code>.<ul><li><code>type</code>: 描述元素或组件类型, 如果希望将目标渲染为 Element那么 <code>type</code> 为标签名, 如果希望渲染为组件那么<code>type</code> 为 组件配置对象</li><li><code>attr</code>: 描述元素或组件上的属性(例如:<code>class</code>)</li><li><code>children</code>:<ul><li>如果待渲染的是一个元素, 如果这个元素下面没有子元素或者子组件, 那么<code>children</code> 为元素的 <code>innerText</code>,如果下面还有子组件或子元素, 那么 <code>children</code> 应该是一个<code>h</code> 函数返回值数组</li><li><strong>如果待渲染的是一个组件, <code>children</code>属性将传入插槽而不是子元素, 这一点与模板设计是类似的</strong><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>111<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>222<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 的 <code>h</code> 函数 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre> 对于组件<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Comp</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>111<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>222<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Comp</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 的 <code>h</code> 函数 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">h</span><span class="token punctuation">(</span>Comp<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>设计上是统一的.</li></ul></li></ul></li></ul><p>上面这个例子描述了这样一个组件:</p><ul><li><p>首先默认导出的是一个组件配置对象</p></li><li><p>这个组件被编译为了 <code>render</code> 函数, <code>render</code>函数返回了一个 <code>h</code>.</p><ul><li><p><strong>诶, 我要渲染一个组件, 为啥 <code>h</code> 的<code>type</code> 是 <code>div</code> 而不是配置对象呢?</strong>一定注意, <code>render</code>描述的是组件<strong>里面</strong>应该如何渲染, 这里的 <code>h</code>是说, App 组件里面有一个 <code>div</code>, 如果我们这里写的是<code>h(demoObj, &#123;&#125;, '111')</code> 这个意思是 App 组件里面有一个 demo组件, 这个 demo 组件里面啥也没有, 他的 innerText 是 '111'</p></li><li><p><strong>诶, 那我们在哪里定义了 App 的 h 函数呢?</strong>我们没有用 <code>h</code> 函数定义 App (是利用 createApp 定义的)至于这俩函数有什么联系后面再说</p></li><li><p><strong>诶, 那难道组件内部只能有一个一级子元素?</strong> 是的, 在Vue2 中我们就规定 <code>template</code> 下最多只能有一个一级子元素, 在Vue3 中我们用语法糖解除了这个限制. 你可能会想到对于 App 下的某个组件(如demo), 我们通过这样的方式让这个组件有多个子元素</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// App.js 的 render</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>demoConfig<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"222"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是错的, 数组将作为插槽传入 demo 组件, 组件的子元素是在组件自己的<code>render</code> 中定义的.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">demoConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"222"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// App.js 的 render</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>demoConfig<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其实我们的疑问就是到底是他妈的谁构造了根组件 <code>App</code> 的<code>h</code> 函数</p></li></ul></li><li><p>App 是一个组件, 这个组件内部有一个 <code>div</code> 这个<code>div</code> 又有两个子<code>span</code>, 内容分别是<code>111</code> 和 <code>222</code></p></li></ul><h3 id="构造主流程">构造主流程</h3><ul><li><p><code>vue-runtime</code> 的主流程</p><pre class="mermaid">  graph TB根组件配置对象 --createApp--> 一种特殊的vNode --挂载根组件--> 根组件特殊使命结束,成为普通的组件 --渲染--> 进入patch函数 --目标是Element--> Element处理函数 --新Element--> 挂载Element --没有子Element --> 写入innerText挂载Element --有子Element--> 每个子Element --渲染--> 进入patch函数Element处理函数 --老Element--> 更新Element进入patch函数 --目标是组件--> 组件处理函数 --新组件--> 新建组件 --> 应用配置 --> 运行render --> 每个子组件 --渲染--> 进入patch函数组件处理函数 --老组件--> 更新组件</pre></li><li><p>可以看到 <code>createApp</code> 输入配置对象, <code>h</code>函数输入 <code>type</code>(可以是string可以是配置对象),<code>props</code>, <code>children</code>. 虽然两者输入不同,但是他们都返回了 vNode. <code>createApp</code> 的输入可以看作是没有<code>props</code>, <code>children</code> 的 <code>h</code>函数的组件输入, 而 <code>createApp</code> 的输出可以看作是具有特殊功能的<code>h</code> 输出. 实际上 <code>createApp</code> 与 <code>h</code>在底层都依赖了 <code>createVNode</code> 函数.</p></li><li><p>vue 渲染中对象发生了如下变化:</p><pre class="mermaid">  graph LR组件/元素配置对象 --> 虚拟节点vNode --> 实例对象 --> DOM</pre><ul><li>组件配置对象包含了 <code>render</code>, <code>setup</code></li><li><code>vNode</code> 在配置对象的基础上加入了部分属性</li><li>实例对象又在 <code>vNode</code> 的基础上加入了属性</li><li>最后挂载为 DOM</li></ul></li></ul><p><code>vue-runtime</code> 对外暴露函数只有 <code>createApp</code>我们从这个函数入手</p><ul><li><p><code>createApp</code> 创建了 app 组件 <code>vNode</code>,同时这个的 <code>vNode</code> 还应该有 <code>mount</code>函数(唯一特殊的地方)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/createApp.ts</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createVNode <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./vnode'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> render <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./render'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token parameter">rootComponent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">_component</span><span class="token operator">:</span> rootComponent<span class="token punctuation">,</span>    <span class="token function">mount</span><span class="token punctuation">(</span><span class="token parameter">container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> vNode <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>rootComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">render</span><span class="token punctuation">(</span>vNode<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>createVnode</code>: 收到配置对象, <code>props</code>,<code>children</code> 将他们作为一个对象存起来(API 与 <code>h</code>函数一样)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/vnode.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token parameter">component<span class="token punctuation">,</span> props <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> component<span class="token punctuation">,</span>    props<span class="token punctuation">,</span>    children<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>render</code> 负责渲染 <code>vNode</code>, 但是<code>render</code> 什么都没做, 只是调用了 <code>patch</code>.这里多此一举是为了方便之后部署子元素时递归方便</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> vNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一次创建没有老元素</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>patch</code>函数收入更新前后节点与挂载点(新节点的挂载前节点为 <code>null</code>),针对不同节点类型调用不同处理函数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">processComponent</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token function">processElement</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>processComponent</code> 处理组件</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span><span class="token keyword">function</span> <span class="token function">processComponent</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">updateComponent</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 老元素就 update</span>  <span class="token keyword">return</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span>vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  新元素就挂载</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>updateComponent</code> 暂时没有必要实现</p></li><li><p><code>mountComponent</code> 挂载组件. 首先明确组件自己是没有 HTML标签的, 挂载组件实际上是挂载组件中的子元素. 而组件存在的必要是其导出的setup 函数中存在子元素需要的变量与函数.</p><p>我们实现组件实例在上面记录组件需要的上下文</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span><span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>vNode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建实例</span>  <span class="token function">setupComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 配置实例</span>  <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>render<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 部署实例</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>createComponent</code> 用于创建组件实例,为了方便我们将组件的 type 提到实例上</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componment.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token parameter">vNode</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    vNode<span class="token punctuation">,</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> vNode<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token comment">// 图方便</span>    <span class="token literal-property property">render</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>setupComponent</code> 用于创建实例, 配置实例, 包括初始化props, slots, 处理 setup 导出的变量等. 这里我们先不处理 props, slot,忽略 setup 导出的变量后的归属问题, 只解决</p><ul><li>如果有 <code>setup</code> 就执行 <code>setup</code>,如果执行结果是对象就将导出对象绑定到 instance 上, 如果是函数就把他当成<code>render</code> 函数</li><li>如果没 <code>render</code> 就从 <code>vNode</code> 的<code>type</code> 上读取 <code>render</code></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componment.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupComponent</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// initProp</span>  <span class="token comment">// initSlot</span>  <span class="token function">setupStatefulComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 如果有 setup 就处理 setup 函数运行结果</span><span class="token keyword">function</span> <span class="token function">setupStatefulComponent</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span>setup<span class="token punctuation">)</span>    <span class="token function">handleSetupResult</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  finishComponentSetup<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 处理 setup 函数运行结果</span><span class="token keyword">function</span> <span class="token function">handleSetupResult</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> instance<span class="token punctuation">.</span>render <span class="token operator">=</span> res<span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    instance<span class="token punctuation">.</span>setupResult <span class="token operator">=</span> res<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 最后兜底获取 render</span><span class="token keyword">function</span> <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  instance<span class="token punctuation">.</span>render <span class="token operator">=</span> instance<span class="token punctuation">.</span>render <span class="token operator">||</span> instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span>render<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>实现 <code>instance</code> 之后需要将中的子元素挂载出去, 递归<code>patch</code> 即可</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componment.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span><span class="token parameter">render<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> subTree <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// render 只能返回 h 函数的结果, 所以一定是一个 vNode, 直接 patch 就行</span>  <span class="token comment">// !</span>  <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>类似的实现 Element 处理功能</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span><span class="token keyword">function</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">updateElement</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">mountElement</span><span class="token punctuation">(</span>vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>实现挂载 Element</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span><span class="token keyword">function</span> <span class="token function">mountElement</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement<span class="token punctuation">;</span> <span class="token comment">// 构造 DOM 元素</span>  <span class="token comment">// 添加属性</span>  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=></span> el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> vNode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 有子元素</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    vNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 递归挂载</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vNode<span class="token punctuation">.</span>children<span class="token punctuation">;</span> <span class="token comment">// 没子元素</span>  container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>最后写下 <code>h</code> 函数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/h.ts</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createVNode <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./vnode"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> h <span class="token operator">=</span> createVNode<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="实现组件实例-proxy">实现组件实例 <code>Proxy</code></h3><p>我们想要让组件可以引用自己导出的变量</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'micro-vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'hi '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是因为我们直接调用了 <code>render</code> 函数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/component.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span><span class="token parameter">render<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> subTree <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所以 <code>render</code> 的 <code>this</code> 是 <code>global</code>,我们希望 <code>render</code> 的 <code>this</code> 包括<code>setup</code> 导出的对象与 Vue 3 文档中的<span class="exturl" data-url="aHR0cHM6Ly9jbi52dWVqcy5vcmcvYXBpL2NvbXBvbmVudC1pbnN0YW5jZS5odG1s">组件实例<i class="fa fa-external-link-alt"></i></span>,所以我们需要构造一个 Proxy 同时实现访问 setup 结果与组件对象</p><ol type="1"><li>处理 setup 导出</li></ol><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/component.ts</span><span class="token keyword">function</span> <span class="token function">handleSetupResult</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// ...</span>  instance<span class="token punctuation">.</span>setupResult <span class="token operator">=</span> <span class="token function">proxyRefs</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><ol start="2" type="1"><li>在结束组件初始化时构造代理对象, 将代理对象作为一个属性插入实例<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/component.ts</span><span class="token keyword">function</span> <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 声明代理对象</span>  instance<span class="token punctuation">.</span>proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> instance <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> publicInstanceProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>  instance<span class="token punctuation">.</span>render <span class="token operator">=</span> instance<span class="token punctuation">.</span>render <span class="token operator">||</span> instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span>render<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 将 <code>target</code> 定义为 <code>&#123; instance &#125;</code>看起来很怪, 为啥不直接用 <code>instance</code> 呢? 因为在 DEV模式下这个对象内部应该还有很多属性, 只不过我们没有考虑</li><li>定义代理 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/publicInstanceProxy.ts</span><span class="token keyword">const</span> specialInstanceKeyMap <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">$el</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> publicInstanceProxy <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 如果 setup 导出的对象上有就返回</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>setupResult<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>setupResult<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 从组件属性上导出属性</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> specialInstanceKeyMap<span class="token punctuation">)</span>      <span class="token keyword">return</span> specialInstanceKeyMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> target<span class="token punctuation">.</span>instance<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>实现 <code>$el</code></li></ol><p>有很多组件实例, 我们暂时只实现 <code>$el</code>. 挂载点应该是<code>vNode</code> 的属性, 所以我们将挂载点记录在 <code>vNode</code>上</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/vnode.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token parameter">component<span class="token punctuation">,</span> props <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>    <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> <code>el</code> 作为组件实例在组件挂载后在 vNode上更新即可</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/publicInstanceProxy.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// ...</span>  instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>el <span class="token operator">=</span> container<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="实现-shapeflags">实现 <code>shapeFlags</code></h3><p>可以将组件类型判断抽出为一个变量, 通过位运算判断组件类型.我们目前需要判断的有:</p><ul><li>是否是 <code>Element</code></li><li>是否是有 <code>setup</code> 的组件(也叫 stateful component)</li><li>子节点是 string 还是数组</li></ul><p>实现</p><ul><li>修改 <code>vNode</code> 定义 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token parameter">component<span class="token punctuation">,</span> props <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">shapeFlags</span><span class="token operator">:</span> <span class="token function">getShapeFlags</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// ...</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>判断函数 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isObject <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../share/index'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> ShapeFlags <span class="token punctuation">&#123;</span>  <span class="token constant">ELEMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token constant">STATEFUL_COMPONENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token constant">TEXT_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token constant">ARRAY_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getShapeFlags</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 注意, 这俩不是互斥的...</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> res <span class="token operator">|=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span>setup<span class="token punctuation">)</span> res <span class="token operator">|=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> res <span class="token operator">|=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> res <span class="token operator">|=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>同步判断 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">setupStatefulComponent</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span><span class="token punctuation">)</span>  <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">mountElement</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement<span class="token punctuation">;</span>  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=></span> el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> vNode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span>    <span class="token function">processElement</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="实现事件注册">实现事件注册</h3><p>我们可以为 Element 传入 attribute, 但是无法传入绑定事件, 例如传入<code>&#123; onClick: ()=&gt;&#123;&#125; &#125;</code> 在渲染到 DOM时可以发现渲染结果为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>div onclick<span class="token operator">=</span><span class="token string">"()=>&#123;&#125;"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><code>onClick</code> 的小驼峰命名没了</li><li>value 应该是一个函数调用, 而这里只写了一个函数,这样点击时候并不会执行函数只会右查询一下这个函数</li></ul><p>所以我们要手动实现这样的功能: 在挂载 Element 时, 若传入的是事件,手动绑定这个事件</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">mountElement</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement<span class="token punctuation">;</span>  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 通过正则判断是否为事件绑定</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>      el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>        k<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on([A-Z].*)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        vNode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>k<span class="token punctuation">]</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> vNode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="实现-props">实现 <code>props</code></h3><p><strong>需求:</strong></p><ol type="1"><li>将 props 输入 <code>setup</code>, 使得可以在 <code>setup</code>中通过 <code>props.属性名</code> 调用, 同时 <code>props</code> 为shadowReadonly</li><li>在 <code>render</code> 可以通过 <code>this.属性名</code> 调用</li></ol><p><strong>实现:</strong></p><ul><li><p>在 setup 时构造</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupComponent</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// ...</span>  <span class="token function">initProps</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>通过第二点我们就知道我们需要将 props 加入componentPublicProxy</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> publicInstanceProxy <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> target<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token keyword">return</span> target<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// ...</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>参考 Vue 的API, 对于第一点需求我们只需要修改<code>handleSetupResult</code> 的调用, 传入时加入 shadowReadonly</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">handleSetupResult</span><span class="token punctuation">(</span> instance<span class="token punctuation">,</span>      instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token function">shadowReadonly</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>为 setup 传入参数即可</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> emit <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    props<span class="token punctuation">.</span>foo<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// warn: readonly value</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>我们为啥不把 shadowReadonly 写入 componentPublicProxy 呢?这样岂不是可以保护 <code>render</code> 中调用不会修改原值? 没有必要,我们只需要保证浅层 readOnly, 而 render 是直接拿属性名的, 不会修改 props上的属性定义.</p></li></ul><h3 id="实现-emits">实现 <code>emits</code></h3><p><strong>需求:</strong></p><p>通过 props 传入一堆 <code>onXxxXxx</code> 函数在 <code>setup</code>中可以通过 <code>emit(xxxXxx)</code> 调用函数. 其中<code>emit</code>通过 <code>setup(props, &#123;emit&#125;)</code> 的方式传入.</p><p><strong>注意, 这里就是差一个 <code>on</code></strong>.你说为啥他妈的你要差个 <code>on</code> 啊, 我写 Vue 的时候也没有差异啊,这个应该是 vue-loader 为传入的 <code>emit</code> 名加上的 (如:<code>&lt;comp v-on:doSth='xxx'&gt;</code>, 可能会被 vue-loader 转为<code>&#123; onDoSth: xxx &#125;</code>)</p><p><strong>那么, 难道 <code>props</code> 上的 <code>onDoSth</code>不会被注册成事件监听吗?</strong> 怎么会, 我们的事件监听是为 Element绑定的!</p><p><strong>实现:</strong></p><ul><li><p>实现 emit 函数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> event<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> eventName <span class="token operator">=</span> event<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">-([a-z])</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>eventName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 如果是 xxx-xxx 命名法, 将其转换为小驼峰</span>    eventName <span class="token operator">=</span> eventName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">-([a-z])</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> lc</span><span class="token punctuation">)</span> <span class="token operator">=></span> lc<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[a-z].*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>eventName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 如果是小驼峰命名法, 将其转换为大驼峰</span>    eventName <span class="token operator">=</span> eventName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> eventName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  eventName <span class="token operator">=</span> <span class="token string">'on'</span> <span class="token operator">+</span> eventName<span class="token punctuation">;</span> <span class="token comment">// 加入 on</span>  instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>将函数加入实例对象 <code>$emit</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> specialInstanceKeyMap <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">$el</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span>  <span class="token function-variable function">$emit</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">emit</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> publicInstanceProxy <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token comment">/*...*/</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里有个比较绕的点, Vue 要求 <code>emit</code> 调用方法为<code>emit(名字, 函数调用参数)</code>, 我们这边多了一个<code>instance</code>, 所以我们在定义 <code>$emit</code> 时为函数 bind第一个参数</p></li><li><p>传入 <code>setup</code> 的调用参数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">handleSetupResult</span><span class="token punctuation">(</span>    instance<span class="token punctuation">,</span>    instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token function">shadowReadonly</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">emit</span><span class="token operator">:</span> instance<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>$emit<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="实现-slot">实现 <code>slot</code></h3><p>之前已经梳理过组件的 children 存储的是 slot. Vue 有三种 slot</p><ul><li>默认 slot: 直接作为子元素写入, 在子组件中会按顺序写入</li><li>具名 slot: 指定元素插入什么地方</li><li>作用域 slot: 为具名 slot 传入参数</li></ul><p>先考虑组件的 children 应该传入什么样的数据类型(<code>h(comp, &#123;&#125;, children)</code>)</p><ul><li><p>如果只支持默认 slot, 我们大可将数组传入 children 并将 render函数写成下面这样</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> HelloWorld <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 假设 $slot 表示父组件传入的插槽数组, 让子组件在渲染时直接解构上去</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>$slot<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'APP'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">h</span><span class="token punctuation">(</span>HelloWorld<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">'hi'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM LEFT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM RIGHT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>如果需要支持具名插槽, 我们可以传入数组, 并在每个元素上打上<code>name</code>. 但是这样每次放入元素都需要 <spanclass="math inline">\(O(n)\)</span> 查找. 可以考虑将传入的<code>children</code> 做成对象, Key 为具名插槽名字, Value 可以是 vNode数组也可以是 vNode.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> h<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> renderSlots <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../lib/micro-vue.esm.js'</span><span class="token punctuation">;</span><span class="token keyword">const</span> HelloWorld <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>      <span class="token comment">// 由于 this.$slots[key] 不知道是数组还是对象, 我们用一个函数辅助处理</span>      <span class="token function">renderSlots</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">,</span> <span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">renderSlots</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">,</span> <span class="token string">'right'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">renderSlots</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 调用默认插槽</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'APP'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">h</span><span class="token punctuation">(</span>HelloWorld<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">'hi'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM LEFT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// left 插槽</span>        <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM RIGHT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// right 插槽</span>        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM D1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM D2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">// 默认插槽</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里 Vue 引入了 <code>renderSlots</code> 函数,我以为其作用就是找到插槽并转换为数组, 就像下面这样</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">renderSlots</span><span class="token punctuation">(</span>slots<span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">'default'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> rSlots <span class="token operator">=</span> slots<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">?</span> slots<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">isObject</span><span class="token punctuation">(</span>slots<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span>rSlots<span class="token punctuation">]</span> <span class="token operator">:</span> rSlots<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>但是实际上这个函数的返回值是一个 vNode, Vue 会直接将一个或多个 vNode打包成一个 vNode 返回从而规避数组解构</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componentSlots.ts</span><span class="token keyword">function</span> <span class="token function">renderSlots</span><span class="token punctuation">(</span>slots<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'default'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> rSlots <span class="token operator">=</span> name <span class="token keyword">in</span> slots <span class="token operator">?</span> slots<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    rSlots <span class="token operator">=</span> <span class="token function">testAndTransArray</span><span class="token punctuation">(</span>rSlots<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> rSlots<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>不知道为什么要这么做😟</p></li><li><p>继续考虑作用域插槽, 为了实现作用域变量传递,我们需要将插槽定义为函数, 并在调用 <code>renderSolts</code>时传入参数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> HelloWorld <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>      <span class="token function">renderSlots</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">,</span> <span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">renderSlots</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">,</span> <span class="token string">'right'</span><span class="token punctuation">,</span> <span class="token string">'wuhu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 作用域 slot 传入参数</span>      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">renderSlots</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token string">'wula'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'APP'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token function">h</span><span class="token punctuation">(</span>        HelloWorld<span class="token punctuation">,</span>        <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">'hi'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">&#123;</span>          <span class="token function-variable function">left</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM LEFT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token function-variable function">right</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">foo</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">foo</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM '</span> <span class="token operator">+</span> foo<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM D2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>只需要在 <code>renderSlots</code> 中判断 value是对象还是函数并分类讨论即可.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componentSlots.ts</span><span class="token keyword">function</span> <span class="token function">renderSlots</span><span class="token punctuation">(</span>slots<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> rSlots <span class="token operator">=</span> name <span class="token keyword">in</span> slots <span class="token operator">?</span> slots<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 防止给无效 Key</span>    <span class="token comment">// 如果是对象 / 数组就不管, 函数就调用</span>    rSlots <span class="token operator">=</span> <span class="token function">isObject</span><span class="token punctuation">(</span>rSlots<span class="token punctuation">)</span> <span class="token operator">?</span> rSlots <span class="token operator">:</span> <span class="token function">rSlots</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 尝试转为数组</span>    rSlots <span class="token operator">=</span> <span class="token function">testAndTransArray</span><span class="token punctuation">(</span>rSlots<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>typeSymbol<span class="token punctuation">.</span>FragmentNode<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> rSlots<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// @packages/share/index.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">testAndTransArray</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">?</span> v <span class="token operator">:</span> <span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>至此, 我们实现了插槽的渲染, 再实现一些外围方法</p><ul><li><p>实现 <code>initSlot</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componentSlots.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initSlot</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  instance<span class="token punctuation">.</span>slots <span class="token operator">=</span> instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>添加 <code>$slot</code> 定义</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componentPublicInstance.ts</span><span class="token keyword">const</span> specialInstanceKeyMap <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">$el</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span>  <span class="token function-variable function">$emit</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">emit</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function-variable function">$slots</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> instance<span class="token punctuation">.</span>slots<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="实现-fragmentnode">实现 <code>FragmentNode</code></h3><p>在实现 <code>renderSolts</code> 时我们为将多个 vNode 打包成一个 vNode采用 <code>h('div', &#123;&#125;, rSlots)</code> 将多个插槽放入了一个<code>div</code> 下. 然而我们希望在 HTML 中不现实这个多余的<code>div</code>, 此时就需要 <code>Fragment</code> 标签, 它相当于 Vue插槽中的 <code>&lt;template&gt;&lt;/template&gt;</code> 标签,永不会被渲染. 其实现的原理就是在 mount 时不挂载父节点,直接将子节点挂载到 container 上</p><ul><li><p>先用 Symbol 定义标签名</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/vnode.ts</span><span class="token keyword">export</span> <span class="token keyword">const</span> typeSymbol <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">FragmentNode</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'FragmentNode'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在 <code>patch</code> 时特判 <code>Fragment</code> (因为<code>Fragment</code> 与 component, Element 判断条件不同,我们没法把他们放入用三个 <code>case</code> 中)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> typeSymbol<span class="token punctuation">.</span>FragmentNode<span class="token operator">:</span>      <span class="token function">processFragmentNode</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 特判 Fragment</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span>        <span class="token function">processElement</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">else</span> <span class="token function">processComponent</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">processFragmentNode</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">mountFragmentNode</span><span class="token punctuation">(</span>vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">mountFragmentNode</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 不挂载父节点直接将子节点挂载到 container 上</span>  vNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>修改 <code>renderSlots</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componentSlots.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderSlots</span><span class="token punctuation">(</span>slots<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> rSlots <span class="token operator">=</span> name <span class="token keyword">in</span> slots <span class="token operator">?</span> slots<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  rSlots <span class="token operator">=</span> <span class="token function">testAndTransArray</span><span class="token punctuation">(</span>rSlots<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>typeSymbol<span class="token punctuation">.</span>FragmentNode<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> rSlots<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//       ^ 小改一下</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="实现-textnode">实现 <code>TextNode</code></h3><p>我们还希望在 HTML 中不使用 <code>span</code> 就写入文字, 就像</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>我想写 span 就写 span<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>  想直接写就直接写<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>除非使用 <code>FragmentNode</code> 我们无法不渲染一段内容的标签, 但是<code>FragmentNode</code> 标签的 <code>children</code> 也必须是 vNode,所以我们还需要定义一个特殊标签, 它本身会渲染为 TextNode</p><ul><li><p>定义类型</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/vnode.ts</span><span class="token keyword">export</span> <span class="token keyword">const</span> typeSymbol <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">FragmentNode</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'FragmentNode'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token literal-property property">TextNode</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'TextNode'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>特判类型</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> typeSymbol<span class="token punctuation">.</span>FragmentNode<span class="token operator">:</span>      <span class="token function">processFragmentNode</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> typeSymbol<span class="token punctuation">.</span>TextNode<span class="token operator">:</span> <span class="token comment">// 特判 TextNode</span>      <span class="token function">processTextNode</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span>        <span class="token function">processElement</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">else</span> <span class="token function">processComponent</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">processTextNode</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">mountTextNode</span><span class="token punctuation">(</span>vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">mountTextNode</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> elem <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过 createTextNode 创建</span>  container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>向外部暴露接口</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/vnode.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createTextVNode</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>typeSymbol<span class="token punctuation">.</span>TextNode<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>使用</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>        <span class="token function">createTextVNode</span><span class="token punctuation">(</span><span class="token string">'im text'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="实现工具函数-getcurrentinstance">实现工具函数<code>getCurrentInstance</code></h3><p>该函数用于在 setup 中获取当前 setup 所在的 instance.只须在全局变量上打个标记就可以实现</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/component.ts</span><span class="token keyword">let</span> currentInstance <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">setupStatefulComponent</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    currentInstance <span class="token operator">=</span> instance<span class="token punctuation">;</span> <span class="token comment">// 打个标记再执行</span>    <span class="token function">handleSetupResult</span><span class="token punctuation">(</span>      instance<span class="token punctuation">,</span>      instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token function">shadowReadonly</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">emit</span><span class="token operator">:</span> instance<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>$emit<span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    currentInstance <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// 删除标记</span>  <span class="token punctuation">&#125;</span>  <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> currentInstance<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="实现-provide-inject">实现 <code>provide-inject</code></h3><p><code>provide-inject</code> 机制允许组件在 <code>setup</code>函数中调用 <code>provide(key, value)</code> 设置一个变量.在若干级儿组件中通过 <code>inject(key)</code> 获取值的信息传递机制.同时该机制遵守类似内外层作用域同名时的内层变量保护机制, 例如有如下provide 关系</p><pre class="mermaid">graph TBA:provide-a=1  -->  B:provide-a=2  --> C:inject-a=2A:provide-a=1  -->  D:provide-b=1A:provide-a=1  -->  E:inject-a=1 -->  F:inject-b=undefined</pre><p>也就是说当组件在父组件上无法 inject 属性时会向更上层 inject 属性.</p><p>我们可以在组件实例上定义组件的 provide与该组件的父组件然后实现递归查找的 inject 函数. 但是 JavaScript的原型链本身就支持递归查找, 我们可以指定通过指定某个组件 provide 的<code>__proto__</code> 为父组件的 provide 实现.</p><ul><li><p>在 instance 上加入 provide 属性记录该组件所 provide的所有键值对并设置 <code>provide.__proto__ = parent.provide</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>    parent<span class="token punctuation">,</span> <span class="token comment">// 父组件</span>    <span class="token literal-property property">provides</span><span class="token operator">:</span> parent <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>provides<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// 组件的 provide</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们要求在 <code>createComponent</code> 的时候提供<code>parent</code> 属性, 那么我们也要在调用该函数时加入该参数,该函数依赖关系如下</p><pre class="mermaid">  graph TBrender -.-> patch --> processComponent --> mountComponent --> createComponent((createComponent)) -.-> renderEffect -.-> patchpatch --> processElement --> mountElement --> patch</pre><p>为了让 <code>createComponent</code> 有参数我们需要让其前置函数都带parent 参数, 所有可能调用其前置函数的函数也要带参数.其中存在两个特殊函数.</p><ul><li><code>render</code>: 该函数用来渲染根节点, 根节点的父节点是<code>null</code></li><li><code>renderEffect</code>: 该函数是用来渲染组件<code>instance</code> 的子组件 <code>subTree</code> 所以 parent 参数就是<code>instance</code></li></ul></li><li><p>实现 API</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/apiInject.ts</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> getCurrentInstance <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./component'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">provide</span><span class="token punctuation">(</span><span class="token parameter">k<span class="token punctuation">,</span> v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> currentInstance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> any<span class="token punctuation">;</span>  currentInstance<span class="token punctuation">.</span>provides<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> defaultValue</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> currentInstance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> any<span class="token punctuation">;</span>  <span class="token keyword">return</span> currentInstance <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> currentInstance<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>provides    <span class="token operator">?</span> currentInstance<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>provides<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token operator">:</span> defaultValue<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>测试外层屏蔽与跨组件传递</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @App.js</span><span class="token keyword">const</span> ProviderOne <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'F1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'B1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">h</span><span class="token punctuation">(</span>ProviderTwo<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> ProviderTwo <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'F2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'baz'</span><span class="token punctuation">,</span> <span class="token string">'Z2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> i_foo <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> i_bar <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'@ provide 2:'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'foo: '</span> <span class="token operator">+</span> i_foo<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'bar: '</span> <span class="token operator">+</span> i_bar<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">h</span><span class="token punctuation">(</span>Consumer<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> Consumer <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> i_foo <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> i_bar <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> i_baz <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'baz'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'@ consumer:'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'foo: '</span> <span class="token operator">+</span> i_foo<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'bar: '</span> <span class="token operator">+</span> i_bar<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'baz: '</span> <span class="token operator">+</span> i_baz<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'App'</span><span class="token punctuation">,</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'apiInject'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span>ProviderOne<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果</p><pre class="line-numbers language-none"><code class="language-none">apiInject@ provide 2:foo: F1bar: B1@ consumer:foo: F2bar: B1baz: Z2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="小结-1">小结</h3><p>到目前为止我们完成了组件挂载部分. 那我们折腾了点什么呢?我们就是实现了 <code>h</code> 函数的不同功能. 在实现 API的时候我们也要牢记 API 是为谁实现的.</p><table><thead><tr class="header"><th>参数</th><th>对于组件</th><th>对于Element</th></tr></thead><tbody><tr class="odd"><td><code>type</code></td><td>包含 <code>render</code> 与 <code>setup</code> 的对象</td><td>标签名</td></tr><tr class="even"><td><code>props</code></td><td>组件实例的 <code>props</code></td><td>包含属性与事件的对象</td></tr><tr class="odd"><td><code>children</code></td><td>slots</td><td>子元素 / 子组件</td></tr></tbody></table><p>可以发现, 这个 API 设计的非常对仗工整.</p><ul><li><p>对于 <code>type</code>: 分别传入对象与标签名, 无话可说</p></li><li><p>对于 <code>props</code>:</p><ul><li>对于 Element: 传入一堆 attribute. Element 是会被直接渲染的,我们直接将 Key-Value 写入标签即可. 在实践中我们发现做事件绑定时, 由于value 是函数名, 我们无法直接将 <code>onXxx</code> 写入标签.所以需要手动处理事件调用</li><li>对于组件: 传入一堆 props 与 emits. <strong>难道就没有类似<code>onClick</code> 的事件监听或者类似 <code>style</code> 的属性吗?没有! 组件本身是不会被渲染的! 不可能向组件标签上绑定什么东西.组件能传入的只有用于 setup / render 的属性与 emits 事件</strong></li></ul></li><li><p>对于 <code>children</code>:</p><ul><li><p>对于 Element: 传入一堆子元素 / 子组件, 挨个 patch 就行</p></li><li><p>对于组件: 传入 slots, 将 slots 在添加到元素上</p></li><li><p><strong>为啥不让组件的子元素也写入 children 呢?这样看的多工整!</strong></p><p>组件的子元素在组件的 render 里面, 不在 <code>children</code></p></li><li><p><strong>为啥不让Element的子元素也写入 render 呢? </strong></p><p>人家 Element 压根就没对象存子元素的</p></li><li><p><strong>这尤雨溪懂个锤子 Vue, 设计的 API咋还要分类讨论啊!</strong></p><p>实际上这个 API 设计的很有趣, 看看我们在 template中是怎么书写的(从前面再抄一遍)</p><p>对于 Element</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>111<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>222<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>h</code> 函数写法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>对于组件 <pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Comp</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>111<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>222<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Comp</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> <code>h</code> 函数写法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">h</span><span class="token punctuation">(</span>Comp<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在结构上是对仗的. 这 API 设计的太伟大了</p></li></ul></li></ul><p>此外我们还实现了特殊的 <code>Fragment</code> 与 <code>TextNode</code>这俩都是魔改 patch 实现的. 我们还实现了 <code>provide-inject</code> API,这里借助原型链实现功能也很有趣</p><h2 id="实现-runtime-core-的-update-部分">实现 runtime-core 的 update部分</h2><p>在实现更新逻辑时我们也要对组件与 Element分类讨论并谨记当前实现的是组件还是 Element</p><h3 id="基本思想">基本思想</h3><ul><li><p>update 事件的触发者是<strong>组件</strong>.响应式对象修改后会触发函数, 这个函数一定是组件上的函数, Element上存不了函数</p></li><li><p>响应式对象变化后最后应该触发的是依赖组件的 <code>render</code>函数, <code>render</code> 函数重新执行并生成新的 subTree.</p></li><li><p>我们不能直接将老的 subTree 删除掉替换为新的 subTree,这样性能损耗太大, <strong>我们希望尽可能对比新老 subTree, 根据两个subTree 之间的变化刷新 DOM</strong></p></li><li><p>我们对比的是 vNode, 存在 Element 与组件两种 vNode,我们要分别对不同类型 vNode 讨论更新方法</p></li><li><p><strong>如何判断两个 vNode 是 "同类型" 的</strong></p><p>这里的 "同类型" 是指两个 vNode 可以通过修改对应 DOM 的子元素, 修改props 实现更新, 而不需要卸载DOM.</p><ul><li><p><code>type</code> 不同的 vNode 一定不是同类型的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">oldVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'呀哈哈'</span><span class="token punctuation">)</span>newVnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'克洛洛'</span><span class="token punctuation">)</span>newVnode2 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>HelloWorld<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>三个 vNode 的 <code>type</code> 不同这导致 DOM 标签名不同,铁定无法不卸载元素更新</p></li><li><p><code>props.key</code> 不同一定不是同类型的</p><p>在 Vue 中我们可以指定元素的 key 作为元素的 id, 不同 id的元素一定是不同型的</p></li></ul><p>综上我们可以通过<code>vNode1.type === vNode2.type &amp;&amp; vNode1.props.key === vNode2.props.key</code>判断两个 vNode 是不是同类型的</p></li><li><p><strong>如果两个 vNode 是 "同类型" 的如何更新</strong></p><ul><li><p><strong>vNode 是 Element 型的</strong></p><p>Element 型 vNode 被实实在在的渲染到了 DOM 树上,我们希望尽量不卸载挂载 DOM 元素, 而希望在原 Element 上做更新.我们需要更新 DOM 的属性与 children</p><ul><li><p>更新 props</p></li><li><p>更新 children</p><p>children 可以是字符串也可以是 vNode 数组, 我们需要分类讨论</p><ul><li><p>Text 型到 Text 型:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">oldVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'呀哈哈'</span><span class="token punctuation">)</span>newVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'克洛洛'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>直接更新 textCont</p></li><li><p>Text 型到 Array 型:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">oldVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'呀哈哈'</span><span class="token punctuation">)</span>newVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'克洛洛'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'卓'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>删掉 DOM 的 textCont, patch 新 vNode 进去</p></li><li><p>Array 型到 Text 型:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">oldVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'克洛洛'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'卓'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>newVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'呀哈哈'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>删掉 DOM 的所有 children, 写入 textContent</p></li><li><p>Array 型到 Array 型: 最麻烦的, 采用双端对比法,找到节点发生变化的区间, 删除新 vNode 中不存在的节点, 加入新 vNode中独有节点, 调整节点顺序</p></li></ul></li></ul></li><li><p><strong>新 vNode 是组件型的</strong></p><p>??</p></li></ul></li><li><p><strong>如果两个 vNode 不是 "同类型" 的如何更新</strong></p><p>如果是这种情况我们就束手无策了</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">oldVnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'呀哈哈'</span><span class="token punctuation">)</span>newVnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'克洛洛'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>但是这种情况是不存在的. 若两个不同类型 vNode 要求更新,那么前面一定调用过 <code>patch(vNode1, vNode2, ...)</code>,在更新时哪些情况会调用 <code>vNode1 !== null</code> 的 patch 呢?组件更新, 同类型 Element 的 Array to Array.不同类型的节点会被双端对比算法视为不同节点而被删除 / 增加掉.所以不可能让不同类型节点 <code>patch</code> 在一起.</p></li></ul><h3 id="更新-pipeline">更新 pipeline</h3><p>让响应式对象支持依赖收集与触发依赖. 将整个 renderEffect 装入 effect,这意味着每次响应式对象发生变化都会重复调用 renderEffect.同时我们要区分是 mount 还是 update, 我们可以让 instance 记录更新前的subTree 并默认为 null 实现这一功能</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/component.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> subTree <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">patch</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>subTree<span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//    ^ 第一次是 null</span>    instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>el <span class="token operator">=</span> container<span class="token punctuation">;</span>    instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> subTree<span class="token punctuation">;</span> <span class="token comment">// 记录当前 subTree</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同步修正一下 <code>createComponent</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span>    <span class="token literal-property property">subTree</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>之后需要实现:</p><ul><li>Element:<ul><li>更新 props</li><li>更新 children</li></ul></li><li>组件<ul><li>更新??</li></ul></li></ul><h3 id="element-更新-props">Element 更新 props</h3><p>给定更新前后的 vNode 与目标 DOM 对象, 实现 props 更新.</p><ul><li><p>实现测试用例</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> attrValue <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">attrValue</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>cnt<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      attrValue<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">attrValue</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token operator">++</span>cnt<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> attrValue<span class="token punctuation">,</span> htmlValue <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">attrValue</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>attrValue<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>先实现 <code>updateElement</code> 函数</p><p>由于 <code>vNode2</code> 没有被 mount 所以 <code>vNode2.el</code>不存在, 但是两个 vNode 对应的是同一个 DOM 对象, 我们可以将<code>vNode1.el</code> 直接给到 <code>vNode2.el</code>. 同时我们定义<code>patchProps</code> 用于实现功能</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> elem <span class="token operator">=</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>el <span class="token operator">=</span> vNode1<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">patchProps</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> vNode1<span class="token operator">?.</span>props<span class="token punctuation">,</span> vNode2<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>实现 <code>patchProps</code></p><p>首先要明确我们需要 patch 什么样的 props.</p><ul><li>空值当不存在: 如果 props 是 <code>&#123;key: undefined / null&#125;</code>我们就不 patch 这个 key</li><li>value 可能是事件监听: 我们可以借助 mountElement 中的 props 实现</li></ul><p>先实现辅助函数判断 key 是否在 props 上. 如果 value 是 null /undefined / NaN 也当 key 不存在</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/share/index.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isUNKey</span><span class="token punctuation">(</span><span class="token parameter">k<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> k <span class="token keyword">in</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>实现 <code>patchProps</code> 函数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">patchProps</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">elem</span><span class="token operator">:</span> HTMLElement<span class="token punctuation">,</span> oldProps <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> newProps <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 获取所有 props</span>  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>newProps<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">;</span>  props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 假设 key 是事件监听, 尝试将其转化为小驼峰</span>    <span class="token keyword">let</span> ek <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>      <span class="token operator">?</span> k<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on([A-Z].*)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>    <span class="token comment">// 如果 key 在老 vNode 中存在, 在新 vNode 中不存在: removeAttribute</span>    <span class="token comment">// 如果 key 在老 vNode 中存在, 是事件监听: 解除 防止监听函数变化</span>    <span class="token comment">// 如果 key 在老 vNode 中存在, 不是事件监听, 在新 vNode 也有: 不管</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUNKey</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> oldProps<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isUNKey</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span> <span class="token operator">||</span> ek<span class="token punctuation">)</span><span class="token punctuation">)</span>      ek <span class="token operator">?</span> elem<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>ek<span class="token punctuation">,</span> oldProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> elem<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 不管老节点有没有, 新节点有: setAttribute / addEventListener</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUNKey</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">)</span>      ek        <span class="token operator">?</span> elem<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>ek<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token operator">:</span> elem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>为什么叫 <code>patchProps</code> 不叫<code>updateProps</code>?</p><p>实际上这个函数也可以用于 <code>mountElement</code> 中 props 处理(令<code>oldProps = &#123;&#125;</code>), 并不是 <code>updateElement</code> 专用的.修改</p><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">function mountElement(vNode, container, parent) &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const el = (vNode.el = document.createElement(vNode.type) as HTMLElement);</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> Object.keys(vNode.props).forEach((k) => &#123;</span><span class="token prefix deleted">-</span><span class="token line">   if (/^on[A-Z]/.test(k))</span><span class="token prefix deleted">-</span><span class="token line">     el.addEventListener(</span><span class="token prefix deleted">-</span><span class="token line">       k.replace(/^on([A-Z].*)/, (_, e) => e[0].toLowerCase() + e.slice(1)),</span><span class="token prefix deleted">-</span><span class="token line">       vNode.props[k]</span><span class="token prefix deleted">-</span><span class="token line">     );</span><span class="token prefix deleted">-</span><span class="token line">   else el.setAttribute(k, vNode.props[k]);</span><span class="token prefix deleted">-</span><span class="token line"> &#125;);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> patchProps(el, &#123;&#125;, vNode.props);</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="element-更新-children-前三种情况">Element 更新 children前三种情况</h3><ul><li><p>Text to Text</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">T2T</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> ot <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      ot<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ot <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ot <span class="token operator">?</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token constant">T2T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>只需修改 DOM 内部 textContent, 如果内容不变就不修改</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>children <span class="token operator">!==</span> vNode1<span class="token punctuation">.</span>children<span class="token punctuation">)</span>     container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vNode2<span class="token punctuation">.</span>children<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>Array to Text</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">A2T</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> ot <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      ot<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ot <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ot      <span class="token operator">?</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span>      <span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将 DOM 中所有 Element 都删除, 写入 conteneText</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span>      <span class="token punctuation">[</span><span class="token operator">...</span>container<span class="token punctuation">.</span>children<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 这里合并了下代码, 如果是 Array to Text, 那么 Array !== string 一定成立</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>children <span class="token operator">!==</span> vNode1<span class="token punctuation">.</span>children<span class="token punctuation">)</span>      container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vNode2<span class="token punctuation">.</span>children<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>Text to Array</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">T2A</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> ot <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      ot<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ot <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ot      <span class="token operator">?</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>      <span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>删除内部 textContent 插入 vNode 数组</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span>      <span class="token punctuation">[</span><span class="token operator">...</span>container<span class="token punctuation">.</span>children<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>children <span class="token operator">!==</span> vNode1<span class="token punctuation">.</span>children<span class="token punctuation">)</span>      container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vNode2<span class="token punctuation">.</span>children<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>      vNode2<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> element<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>为 Array to Array 预留函数调用<code>patchKeyedChildren</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span>      <span class="token punctuation">[</span><span class="token operator">...</span>container<span class="token punctuation">.</span>children<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>children <span class="token operator">!==</span> vNode1<span class="token punctuation">.</span>children<span class="token punctuation">)</span>      container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vNode2<span class="token punctuation">.</span>children<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>      vNode2<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> element<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>children<span class="token punctuation">,</span> vNode2<span class="token punctuation">.</span>children<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="element-更新-children-的双端对比法">Element 更新 children的双端对比法</h3><p><strong>基本思想</strong></p><p>分别从左边右边对比元素, 找到发生变化的区间, 例如前后两个 Array分别为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span> a b c d e f g h <span class="token punctuation">]</span><span class="token punctuation">[</span> a b e d i g h <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>从左边找找到只有 <code>a b</code> 是相同的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span> a b <span class="token operator">|</span> c d e f g h <span class="token punctuation">]</span><span class="token punctuation">[</span> a b <span class="token operator">|</span> e d i g h <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>从右边找找到只有 <code>g h</code> 是相同的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span> a b <span class="token operator">|</span> c d e f <span class="token operator">|</span> g h <span class="token punctuation">]</span><span class="token punctuation">[</span> a b <span class="token operator">|</span> e d i <span class="token operator">|</span> g h <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>最后我们找到变化区间(<code>[c d e f] -&gt; [e d i]</code>)</p><p>将老 vNode 独有的子 vNode 移除(<code>[c f]</code>), 将新 vNode独有的子 vNode patch上(<code>[i]</code>), 调整子 vNode 的顺序. 可以使用<code>insertBefore</code> 调整顺序.</p><ul><li><p>删除老 vNode 独有子元素</p><p>为新 vNode 变化区间上的元素编号, 建立 <code>key -&gt; index</code>的映射. 遍历老节点, 如果没有查到 key 就删除节点</p></li><li><p>创建新 vNode 独有的子元素: 在调整位置时一并处理</p></li><li><p>调整位置</p><p>可以通过之前建立的 <code>key -&gt; index</code> 映射一股脑的将 DOM调整到正常位置, 但是调整 DOM 的代价太高了, 我们希望尽可能少的减少<code>insertBefore</code> 操作.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span>l1 l2 <span class="token function">l3</span> <span class="token punctuation">(</span> a b c d e f g h i <span class="token punctuation">)</span> r1 r2 r3<span class="token punctuation">]</span><span class="token punctuation">[</span>l1 l2 <span class="token function">l3</span> <span class="token punctuation">(</span> i a b c d e f g h <span class="token punctuation">)</span> r1 r2 r3<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>如果采用一般方法, 我们需要分别将 <code>a - h</code> 移动到<code>r1</code> 前面. 这明显不如将 <code>i</code> 移动到 <code>a</code>前面划算.</p><p>我们可以在原 vNode 的子 vNode 数组中定义一个稳定串,保证稳定串中的元素相对位置符合新 vNode 设定, 我们只需要遍历新 vNode的子元素, 如果该元素没有在老 vNode 中出现就创建并将其 patch 到指定位置,如果在非稳定串中出现我们就将其 <code>insetBefore</code> 到指定位置.考虑到我们只有 <code>insertBefore</code> 没有 <code>insertAfter</code>函数, 我们还需要保证一个元素在 <code>insertBefore</code>前他后一个的元素已经就位了. 所以我们需要倒着遍历新 vNode.</p><p>在上面的例子中, 可以将 <code>a b c d e f g h</code> 视作稳定串, 调整<code>i</code> 到 <code>a</code> 前即可</p></li><li><p>将 vNode patch 到指定位置</p><p>想要将 Element 调整到指定 Element 前面, 我们可以采用<code>container.insertBefore(elem, target)</code>, 如果<code>target == null</code> 就将元素调整到 container 尾部.</p><p>但是如果想将新 vNode 调整到指定 Element 前面就需要调用 patch 了,我们需要为 patch 加入一个锚点参数指定将 vNode patch 到哪里:<code>patch(vNode1, vNode2, container, parent = null, anchor = null)</code></p></li><li><p>寻找稳定串</p><p>寻找稳定串其实就是寻找相对位置正确的尽可能长的子串,我们又已知道老节点对应的新节点有一个 <code>key -&gt; index</code>的映射, 在新节点中, index 严格递增, 所以可以获取每个老节点对应的 index并查找 LIS. 例如</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">oldIndex</span><span class="token operator">:</span>  <span class="token number">0</span>  <span class="token number">1</span>  <span class="token number">2</span>    <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span> <span class="token number">10</span> <span class="token number">11</span> <span class="token number">3</span>   <span class="token number">12</span> <span class="token number">13</span> <span class="token number">14</span><span class="token literal-property property">oldVNode</span><span class="token operator">:</span> <span class="token punctuation">[</span>l1 l2 <span class="token function">l3</span> <span class="token punctuation">(</span> a b c d e f g  h  i <span class="token punctuation">)</span> r1 r2 r3<span class="token punctuation">]</span><span class="token literal-property property">newVNode</span><span class="token operator">:</span> <span class="token punctuation">[</span>l1 l2 <span class="token function">l3</span> <span class="token punctuation">(</span> i a b c d e f  g  h <span class="token punctuation">)</span> r1 r2 r3<span class="token punctuation">]</span><span class="token literal-property property">newIndex</span><span class="token operator">:</span>  <span class="token number">0</span>  <span class="token number">1</span>  <span class="token number">2</span>    <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span>  <span class="token number">10</span> <span class="token number">11</span>  <span class="token number">12</span> <span class="token number">13</span> <span class="token number">14</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>可以得到 <code>lis = [a b c d e f g h]</code></p></li></ul><p><strong>特殊情况</strong></p><p>可以针对部分特殊情况特殊处理避免计算 LIS</p><ul><li><p>新 vNode 只在最右边加了一堆元素: 只需要 patch 多出来的部分</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">old</span><span class="token operator">:</span> <span class="token punctuation">[</span>a b c<span class="token punctuation">]</span><span class="token keyword">new</span><span class="token operator">:</span> <span class="token punctuation">[</span>a b c d e f<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>新 vNode 只在最左边加了一堆元素: 只需要 patch 多出来的部分</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">old</span><span class="token operator">:</span> <span class="token punctuation">[</span>      d e f<span class="token punctuation">]</span><span class="token keyword">new</span><span class="token operator">:</span> <span class="token punctuation">[</span>a b c d e f<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>新 vNode 只最右边少了一堆元素: remove 多余 vNode 的 DOM 元素.注意这里 remove 的不能是 vNode, 这样不管子 vNode 是 Element还是组件类型的都可以一键卸载(因为 ELement 或 组件类型的 vNode 对应的 DOM树都一定只有一个根 Element)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">old</span><span class="token operator">:</span> <span class="token punctuation">[</span>a b c d e f<span class="token punctuation">]</span><span class="token keyword">new</span><span class="token operator">:</span> <span class="token punctuation">[</span>a b c<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>新 vNode 只最左边少了一堆元素: remove 多余 vNode 的 DOM 元素</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">old</span><span class="token operator">:</span> <span class="token punctuation">[</span>a b c d e f<span class="token punctuation">]</span><span class="token keyword">new</span><span class="token operator">:</span> <span class="token punctuation">[</span>      d e f<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><p><strong>我的部分实现</strong></p><p>定义</p><ul><li><code>c1, c2</code>: 更新前后 vNode 的 children 数组</li><li><code>anchor</code>: 锚点</li><li><code>i</code>: 变化区间的左边界(包括)</li><li><code>e1, e2</code>: 变化区间对应 <code>c1, c2</code>的右边界(包括)</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span><span class="token parameter">c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>    e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>    e2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 从左往右看, 如果类型不同或者 key 不同就退出, 否则递归更新子节点</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">!==</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">||</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>key <span class="token operator">!==</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token function">patch</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// 从右往左看, 如果类型不同或者 key 不同就退出, 否则递归更新子节点</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> e1 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> e2 <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> e1 <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">,</span> e2 <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">!==</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">||</span> c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>key <span class="token operator">!==</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token function">patch</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 右侧有新节点</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> c1<span class="token punctuation">.</span>length<span class="token punctuation">)</span>    c2<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span>      <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> i <span class="token operator">>=</span> c2<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 右侧有老节点</span>  <span class="token comment">//     传入的是 vNode 要加上 el 找到 DOM 对象</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> c2<span class="token punctuation">.</span>length<span class="token punctuation">)</span> c1<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 左侧有新节点</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>e1 <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> e2 <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    c2<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span>      <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> c1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 左侧有老节点</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>e2 <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> e1 <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> c1<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 中间</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> newRange <span class="token operator">=</span> c2<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> oldRange <span class="token operator">=</span> c1<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> k2iNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span>newRange<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">,</span> i <span class="token operator">+</span> idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> k2iOld <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>oldRange<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    oldRange<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>       <span class="token comment">// 新的有, 老的有 直接更新</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>k2iNew<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">patch</span><span class="token punctuation">(</span>          d<span class="token punctuation">,</span>          c2<span class="token punctuation">[</span>k2iNew<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token keyword">as</span> number<span class="token punctuation">]</span><span class="token punctuation">,</span>          container<span class="token punctuation">,</span>          parent<span class="token punctuation">,</span>          anchor        <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 新的没有, 老的有 直接删除</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>k2iNew<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        d<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        k2iOld<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 新的有老的没有 新建到问题区间的尾部</span>    newRange<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>k2iOld<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">patch</span><span class="token punctuation">(</span>          <span class="token keyword">null</span><span class="token punctuation">,</span>          c2<span class="token punctuation">[</span>k2iNew<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token keyword">as</span> number<span class="token punctuation">]</span><span class="token punctuation">,</span>          container<span class="token punctuation">,</span>          parent<span class="token punctuation">,</span>          e2 <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> c2<span class="token punctuation">.</span>length <span class="token operator">?</span> c2<span class="token punctuation">[</span>e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el <span class="token operator">:</span> <span class="token keyword">null</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        k2iOld<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ... 调整位置</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>存在的问题</strong></p><ul><li><p>在中间对比时: 新的有老的没有的情况可以合并到调整位置上</p></li><li><p>为只用四个 if 考虑了特殊情况, 没有考虑特殊情况的的扩展</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">old <span class="token operator">=</span> <span class="token punctuation">[</span>a b c d e f<span class="token punctuation">]</span><span class="token keyword">new</span> <span class="token operator">=</span> <span class="token punctuation">[</span>a b     e f<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>既然从左往右看 <code>[a b]</code> 一样, 我们可以假装消掉<code>[a b]</code> 把 <code>[c d]</code>看成只有左侧有多于元素的情况此时直接消除 <code>[c d]</code> 即可,类似的还有</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">old <span class="token operator">=</span> <span class="token punctuation">[</span>a b     e f<span class="token punctuation">]</span><span class="token keyword">new</span> <span class="token operator">=</span> <span class="token punctuation">[</span>a b c d e f<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>如果可以特判这种情况就爽死了</p></li></ul><p><strong>别个的实现</strong></p><p>mini-vue 的实现和原版的差不多</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span> <span class="token parameter">c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentAnchor<span class="token punctuation">,</span> parentComponent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> l2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length<span class="token punctuation">;</span>  <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> e2 <span class="token operator">=</span> l2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token function-variable function">isSameVNodeType</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> n1<span class="token punctuation">.</span>type <span class="token operator">===</span> n2<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> n1<span class="token punctuation">.</span>key <span class="token operator">===</span> n2<span class="token punctuation">.</span>key<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// ... 求 i e1 e2</span>  <span class="token comment">// 人家在这里是比较了 e1 e2 i 的关系, 这样变相的 "消除" 掉了前后置元素</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> nextPos <span class="token operator">=</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextPos <span class="token operator">&lt;</span> l2 <span class="token operator">?</span> c2<span class="token punctuation">[</span>nextPos<span class="token punctuation">]</span><span class="token punctuation">.</span>el <span class="token operator">:</span> parentAnchor<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> parentComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>      i<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> e2 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">hostRemove</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>      i<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ... 中间对比</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个明显不如四个 if 来的直观, 但是顺道处理了特殊情况的扩展情况.有一说一 vuejs/core 在这一段中代码的注释中也没有提起这种情况,但是通过这个泛泛的判断条件我们确实捕获到了这种情况.看起来这是一个无意为之的优化?</p><p><strong>最终实现</strong></p><ul><li><p>实现 diff</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">c1</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">c2</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>    e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>    e2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token function-variable function">isSameType</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v1<span class="token punctuation">,</span> v2</span><span class="token punctuation">)</span> <span class="token operator">=></span>    v1<span class="token punctuation">.</span>type <span class="token operator">===</span> v2<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> v1<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key <span class="token operator">===</span> v2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">;</span>  <span class="token comment">// 找到区间</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSameType</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token function">patch</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> e1 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> e2 <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> e1 <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">,</span> e2 <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSameType</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token function">patch</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 特判</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>e2 <span class="token operator">&lt;</span> i <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> c1<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e1 <span class="token operator">&lt;</span> i <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span>    c2<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span>      <span class="token function">patch</span><span class="token punctuation">(</span>        <span class="token keyword">null</span><span class="token punctuation">,</span>        d<span class="token punctuation">,</span>        container<span class="token punctuation">,</span>        parent<span class="token punctuation">,</span>        e1 <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">>=</span> c1<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> c1<span class="token punctuation">[</span>e1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el      <span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 中间</span>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> newRange <span class="token operator">=</span> c2<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> oldRange <span class="token operator">=</span> c1<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> new2oldIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 新节点 index -> 老节点 index</span>    <span class="token keyword">const</span> key2indexNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span> <span class="token comment">// 新节点 key -> 新节点 index</span>      newRange<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">,</span> i <span class="token operator">+</span> idx<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 如果老节点在新节点中存在 构造 新节点 index -> 老节点 index</span>    <span class="token comment">//                     不存在 删除老节点</span>    oldRange<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>key2indexNew<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        new2oldIndex<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key2indexNew<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> vnode<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> lis <span class="token operator">=</span> <span class="token constant">LIS</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>new2oldIndex<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构建稳定序列</span>    newRange<span class="token punctuation">.</span><span class="token function">reduceRight</span><span class="token punctuation">(</span>      <span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> curIndex</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> oldVnode <span class="token operator">=</span> oldRange<span class="token punctuation">[</span>new2oldIndex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>curIndex <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 对应老节点(如果存在)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lis<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>curIndex <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 处于稳定序列就只更新</span>          <span class="token keyword">return</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> prev<span class="token operator">?.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>new2oldIndex<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>curIndex <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 不在就移动节点</span>          container<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> prev<span class="token operator">?.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> prev<span class="token operator">?.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> cur<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> prev<span class="token operator">?.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没有老节点就加入</span>        <span class="token keyword">return</span> cur<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      e2 <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">>=</span> c2<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> c2<span class="token punctuation">[</span>e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>实现 LIS</p><p>定义 <code>low</code> 数组, <code>low[i]</code> 表示长度为<code>i</code> 的LIS结尾元素的最小值.对于一个上升子序列，显然其结尾元素越小, 越有利于在后面接其他的元素,也就越可能变得更长. 因此, 我们只需要维护 <code>low</code>数组，对于每一个 <code>s[i]</code>，如果<code>s[i] &gt; low[当前最长的LIS长度]</code>，就把 <code>a[i]</code>接到当前最长的 LIS 后面，即 <code>low[++当前最长的LIS长度] = a[i]</code>对于每一个 <code>s[i]</code> ，如果 <code>s[i]</code> 能接到 LIS后面，就接上去. 否则，就用 <code>s[i]</code> 取更新 <code>low</code>数组。具体方法是, 在 <code>low</code> 数组中找到第一个大于等于<code>s[i]</code> 的元素 <code>low[j]</code>, 用 <code>s[i]</code>去更新 <code>low[j]</code>. 如果从头到尾扫一遍 <code>low</code>数组的话，时间复杂度仍是 <span class="math inline">\(O(n^2)\)</span>.我们注意到 <code>low</code> 数组内部一定是单调不降的. 所有我们可以二分<code>low</code> 数组，找出第一个大于等于 <code>s[i]</code> 的元素.总时间复杂度为 <span class="math inline">\(O(n \log n)\)</span></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/share/index.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token constant">LIS</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> low <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>s<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> len <span class="token operator">=</span> s<span class="token punctuation">.</span>length<span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> cur <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      j <span class="token operator">=</span> res<span class="token punctuation">[</span>res<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> cur<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        low<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>        res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">let</span> u <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">let</span> v <span class="token operator">=</span> res<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>u <span class="token operator">&lt;</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token punctuation">(</span>u <span class="token operator">+</span> v<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span>res<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> cur<span class="token punctuation">)</span> u <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> v <span class="token operator">=</span> c<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">&lt;</span> s<span class="token punctuation">[</span>res<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> low<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        res<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">let</span> u <span class="token operator">=</span> res<span class="token punctuation">.</span>length<span class="token punctuation">;</span>  <span class="token keyword">let</span> v <span class="token operator">=</span> res<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>u<span class="token operator">--</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    res<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>    v <span class="token operator">=</span> low<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>为什么要用双端对比法</strong></p><ul><li>双端对比法的理论性能可能并不是最优秀的, 但是其用于前端 vNode list的对比很优秀, 因为前端 DOM 的修改很少涉及全局修改,一般都是一两个元素的增减调换, 双端对比法可以快速锁定修改区间,忽略不变部分, LIS 可以保证在较少插入次数下实现位置调整</li><li>为什么要讨论特殊情况, 明明可以直接利用最后的通用算法求解.首先这个特判会让单次 update 快很多, 同时考虑前端应用场景, update单个头尾 / 中部元素比较频繁, 这个特判会被特别多次调用</li></ul><h3 id="组件更新">组件更新</h3><p>组件 vNode 更新时 <code>setupRenderEffect</code> 会触发<code>patch(组件vNode, ...)</code> 最后 <code>updateComponent</code></p><p>不管组件有多复杂我们更新的都是组件挂载的 DOM, 组件的 render返回的是一个 <code>h</code> 也就是说组件最多有一个根 DOM,我们可以直接更新这个 DOM.</p><p>我们更新的时候拿到的是 vNode, 但是为组件传入的 props 还在 instance上, 我们需要为 vNode 绑定 instance (使用 <code>.component</code>属性)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span><span class="token keyword">function</span> <span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  vNode2<span class="token punctuation">.</span>el <span class="token operator">=</span> vNode1<span class="token punctuation">.</span>el<span class="token punctuation">;</span> <span class="token comment">// 绑定 DOM</span>  vNode2<span class="token punctuation">.</span>component <span class="token operator">=</span> vNode1<span class="token punctuation">.</span>component<span class="token punctuation">;</span> <span class="token comment">// 绑定 instance</span>  <span class="token comment">// 判断 props 一不一样: 一样就不更新 (说明是父节点触发了, 递归到子节点)</span>  <span class="token comment">//                      不一样就重新渲染这个组件下的 vNode</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameProps</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>props<span class="token punctuation">,</span> vNode2<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    vNode1<span class="token punctuation">.</span>component<span class="token punctuation">.</span>vNode <span class="token operator">=</span> vNode2<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 我们要手动触发这个唯一的子 vNode 的render, 所以还需要保存每个 vNode 的 render 函数</span>    <span class="token comment">// 保存在 `.runner`</span>    <span class="token comment">// 同时记录 .next 为新 vNode</span>    vNode1<span class="token punctuation">.</span>component<span class="token punctuation">.</span>next <span class="token operator">=</span> vNode2<span class="token punctuation">;</span>    <span class="token comment">// 调用老 vNode 的渲染函数</span>    vNode1<span class="token punctuation">.</span>component<span class="token operator">?.</span>runner <span class="token operator">&amp;&amp;</span> vNode1<span class="token punctuation">.</span>component<span class="token punctuation">.</span><span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>判断组件是否有必要更新(<code>props</code> 一不一样)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/component.ts</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isSameProps</span><span class="token punctuation">(</span><span class="token parameter">props1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> props2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>props1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>props2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=></span> props1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">!==</span> props2<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在挂载组件时同步记录 instance</p><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">// @packages/runtime-core/src/render.tsfunction mountComponent(vNode, container, parent, anchor) &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const instance = createComponent(vNode, parent);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> vNode.component = instance;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> setupComponent(instance);</span><span class="token prefix unchanged"> </span><span class="token line"> setupRenderEffect(instance, container, anchor);</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在重新渲染组件时迁移 props</p><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">// @packages/runtime-core/src/component.tsexport function setupRenderEffect(instance, container, anchor) &#123;<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> instance.runner = effect(() => &#123;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   const subTree = instance.render.call(instance.proxy);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   if (instance.next) &#123;</span><span class="token prefix inserted">+</span><span class="token line">     instance.vNode = instance.next;</span><span class="token prefix inserted">+</span><span class="token line">     instance.props = instance.next.props;</span><span class="token prefix inserted">+</span><span class="token line">     instance.next = null;</span><span class="token prefix inserted">+</span><span class="token line">   &#125;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   patch(instance.subTree, subTree, container, instance, anchor);</span><span class="token prefix unchanged"> </span><span class="token line">   instance.vNode.el = container;</span><span class="token prefix unchanged"> </span><span class="token line">   instance.subTree = subTree;</span><span class="token prefix unchanged"> </span><span class="token line"> &#125;);</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="实现-nexttrick">实现 <code>nextTrick</code></h3><p>我们希望当 Reactivity 发生变化时组件与 DOM 是同步更新的,这可能会带来不必要的资源消耗, 我们希望组件更新可以变成异步的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> cnt <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> cnt<span class="token punctuation">.</span>value <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> cnt<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里会触发100次组件更新</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> cnt <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'HTML Context:'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如何完成异步更新呢?我们可以将更新任务放入微任务这样只有在同步代码执行完成后微任务才会执行.这也是 Vue 中 <code>nextTrick</code> 的实现原理</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>更新实际上就是执行 renderEffect 的中 effect 的 runner. 可以利用effect-scheduler 实现首次触发执行 runner 之后触发执行 scheduler. 在scheduler 中我们可以将更新事件加入队列. 并注册更新队列的微事件</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token literal-property property">jobs</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>any<span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 任务队列</span><span class="token keyword">function</span> <span class="token function">insertJob</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  jobs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不重复添加</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>jobs<span class="token punctuation">.</span>size <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 确保之注册一个微任务, 防止创建不必要的 Promise.resolve()</span>    <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token operator">...</span>jobs<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> jobs<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  instance<span class="token punctuation">.</span>runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">componentUpdateFn</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 将更新内容提出为函数</span>    <span class="token punctuation">&#123;</span>      <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token function">insertJob</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>runner<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当 Reactivity 发生变化时, 同步执行 insertJob 同步 add Set,注册一个微任务用于在同步代码都执行完成后执行所有刷新函数</p><p><strong>测试</strong></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> cnt <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> cnt<span class="token punctuation">.</span>value <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> cnt<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 此时还没修改 还是 1</span>        <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 此时变为 100</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> cnt <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这也告诉我们, 如果在 Vue 中触发了组件变化,如果还需要同时获取组件的状态应该使用 <code>nextTrick</code></p><h2 id="实现-runtime-dom">实现 runtime-dom</h2><p>我们的 Vue 默认是渲染在 HTML 上面的, 如果我们向将组件渲染在 canvas上(DOM 标签变为 canvas 上的一个元素)就需要重写所有 DOM API相关的函数调用.</p><p>我们希望将这些 API 抽象出来 (例如 <code>document.createElement</code>抽象为 <code>create</code> 函数). 当我们需要将 Vue 组件渲染在 HTML时只需要为 runtime-core 传入 <code>create</code> 函数即可.</p><p>至此我们的组件依赖关系由<code>vue &gt; runtime-core &gt; reactivity</code> 变为<code>vue &gt; runtime-dom &gt; runtime-core &gt; reactivity</code>,runtime-dom 就是为 Vue 提供 HTML 渲染能力的组件</p><p>实现 runtime-dom API (将 runtime-core 中调用 DOM API的地方全写出来)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createRenderer <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../runtime-core/src/render'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isUNKey <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../share'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createText</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">remove</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token operator">=></span> el<span class="token punctuation">.</span>parent <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">insert</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token operator">=></span> parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">setText</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> text</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>nodeValue <span class="token operator">=</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">setElementText</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> text</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patchProps</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">elem</span><span class="token operator">:</span> HTMLElement<span class="token punctuation">,</span> oldProps <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> newProps <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>newProps<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">;</span>  props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> ek <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>      <span class="token operator">?</span> k<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on([A-Z].*)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUNKey</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> oldProps<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isUNKey</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span> <span class="token operator">||</span> ek<span class="token punctuation">)</span><span class="token punctuation">)</span>      ek <span class="token operator">?</span> elem<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>ek<span class="token punctuation">,</span> oldProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> elem<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUNKey</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">)</span>      ek        <span class="token operator">?</span> elem<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>ek<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token operator">:</span> elem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们还需要将 runtime-core 接入 runtime-dom, 因为我们要为 runtime-core传入刚刚定义的渲染函数, 调用这些渲染函数的文件只有<code>render.ts</code>. 之前 <code>render.ts</code>是通过导出函数向外暴露 API 的, 但是因为我们也要传入函数, 我们只能将<code>render.ts</code> 外部包裹一个函数, 让该函数传入 runtime-dom定义的渲染函数最后返回原本需要导出的函数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> renderer<span class="token punctuation">;</span><span class="token comment">// 创建可用 DOM API 的 render</span><span class="token keyword">function</span> <span class="token function">ensureRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    renderer <span class="token operator">||</span> <span class="token comment">// 如果创建过了就不重复创建</span>    <span class="token punctuation">(</span>renderer <span class="token operator">=</span> <span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>      createElement<span class="token punctuation">,</span>      createText<span class="token punctuation">,</span>      setText<span class="token punctuation">,</span>      setElementText<span class="token punctuation">,</span>      patchProps<span class="token punctuation">,</span>      insert<span class="token punctuation">,</span>      remove<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 创建可用 DOM API 的 createApp</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createApp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">ensureRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createApp</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'../../runtime-core/src'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改 <code>render.ts</code> 的构造方式</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span>  createElement<span class="token punctuation">,</span>  createText<span class="token punctuation">,</span>  remove<span class="token punctuation">,</span>  insert<span class="token punctuation">,</span>  setText<span class="token punctuation">,</span>  setElementText<span class="token punctuation">,</span>  patchProps<span class="token punctuation">,</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// ... 将调用 DOM API 的地方改为调用传入的渲染函数</span>  <span class="token comment">// ... 将原本所有 export 的函数改为 return &#123;该函数&#125;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    render<span class="token punctuation">,</span>    <span class="token literal-property property">createApp</span><span class="token operator">:</span> <span class="token function">createApp</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> render<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>createApp</code> 函数需要 render, 但是我们的 render也是动态构建的, 所以我们只能为 createApp 传入 render, 并在<code>render.ts</code> 中先传入这一参数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token parameter">render<span class="token punctuation">,</span> rootComponent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">_component</span><span class="token operator">:</span> rootComponent<span class="token punctuation">,</span>    <span class="token function">mount</span><span class="token punctuation">(</span><span class="token parameter">container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> vNode <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>rootComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">render</span><span class="token punctuation">(</span>        vNode<span class="token punctuation">,</span>        <span class="token function">isObject</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>          <span class="token operator">?</span> container          <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后修改导出</p><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">export * from './reactivity/src/index';<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> export * from './runtime-core/src/index';</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> export * from './runtime-dom/src/index';</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>测试</strong></p><p>实现一个 <code>runtime-PIXI</code>, PIXI.js 是一个基于 canvas的游戏库, 完成了对 canvas 的封装. 我们希望通过对 PIXI.js API的二次封装实现利用 Vue 操作 canvas</p><p>我们希望实现执行 <code>test</code> 修改正方形位置</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> y <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">x1<span class="token punctuation">,</span> y1</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      x<span class="token punctuation">.</span>value <span class="token operator">=</span> x1<span class="token punctuation">;</span>      y<span class="token punctuation">.</span>value <span class="token operator">=</span> y1<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> x<span class="token punctuation">,</span> y <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了将测试代码写在一起, 我们将 runtime-dom 完全引入了测试用例并重写runtime-dom. 这样做可以免去将重新编译 Vue</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// modify to export createRenderer (cause the export level is different from vue runtime-dom)</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createRenderer <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../lib/micro-vue.esm.js'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'../../lib/micro-vue.esm.js'</span><span class="token punctuation">;</span><span class="token comment">// 创建元素</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PIXI<span class="token punctuation">.</span>Graphics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  rect<span class="token punctuation">.</span><span class="token function">beginFill</span><span class="token punctuation">(</span><span class="token number">0xff0000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  rect<span class="token punctuation">.</span><span class="token function">drawRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  rect<span class="token punctuation">.</span><span class="token function">endFill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> rect<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 插入</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">insert</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token operator">=></span> parent<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 修改属性</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patchProps</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> oldProps <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> newProps <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>newProps<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">;</span>  props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    elem<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> newProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> renderer<span class="token punctuation">;</span><span class="token comment">// 与测试无关的 API 直接给 NULL</span><span class="token keyword">function</span> <span class="token function">ensureRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    renderer <span class="token operator">||</span>    <span class="token punctuation">(</span>renderer <span class="token operator">=</span> <span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>      createElement<span class="token punctuation">,</span>      <span class="token literal-property property">createText</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>      <span class="token literal-property property">setText</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>      <span class="token literal-property property">setElementText</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>      patchProps<span class="token punctuation">,</span>      insert<span class="token punctuation">,</span>      <span class="token literal-property property">remove</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createApp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token function">ensureRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createApp</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 创建 game</span><span class="token keyword">const</span> game <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PIXI<span class="token punctuation">.</span>Application</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">640</span><span class="token punctuation">,</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">360</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 挂载 canvas</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>game<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在 PIXI 中 canvas DOM 不用于挂载元素, 新元素是挂载到 game.stage 上的</span><span class="token keyword">export</span> <span class="token keyword">const</span> el <span class="token operator">=</span> game<span class="token punctuation">.</span>stage<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="实现-compiler-core">实现 compiler-core</h2><pre class="mermaid">graph LRstring(输入string) --> parse(parse模块) --> ast1(输出AST树) --> transform(transform模块对树CRUD) --> ast2(输出AST树) --> CodeGen(CodeGen模块) --> render(输出render)</pre><p>构建相关模块</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">@packages<span class="token operator">/</span>compiler<span class="token operator">-</span>core├── src│   └── index<span class="token punctuation">.</span>ts└── __tests__<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>并导出模块</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./reactivity/src/index'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./runtime-dom/src/index'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./compiler-core/src/index'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="实现-parse-模块的插值解析">实现 parse 模块的插值解析</h3><p><strong>需求</strong></p><p>我们希望可以解析 <code>&#123;&#123;message&#125;&#125;</code> 为 AST 树,插值语法的 AST 为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>  <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>  <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'message'</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>实现</strong></p><ul><li>定义枚举 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">@packages<span class="token operator">/</span>compiler<span class="token operator">-</span>core<span class="token operator">/</span>src<span class="token operator">/</span>ast<span class="token punctuation">.</span>ts<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> NodeTypes <span class="token punctuation">&#123;</span>  <span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>  <span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>实现编译 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">@packages<span class="token operator">/</span>compiler<span class="token operator">-</span>core<span class="token operator">/</span>src<span class="token operator">/</span>parse<span class="token punctuation">.</span>ts<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> NodeTypes <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./ast'</span><span class="token punctuation">;</span><span class="token comment">// 构造上下文, 之后源码都从 source 里面取</span><span class="token keyword">function</span> <span class="token function">createParserContext</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">source</span><span class="token operator">:</span> content<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 构造 Root 节点, 其只包含子节点属性</span><span class="token keyword">function</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    children<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 如果代码中包含 '&#123;&#123;' 就执行解析</span><span class="token keyword">function</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">as</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token keyword">as</span> any<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'&#123;&#123;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> node <span class="token operator">=</span> <span class="token function">parseInterpolation</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>  node <span class="token operator">&amp;&amp;</span> nodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> nodes<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 找到一对最近的 &#123;&#123; &#125;&#125;, 提取插值, 删除这个插值代码</span><span class="token keyword">function</span> <span class="token function">parseInterpolation</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> closeDelimiter <span class="token operator">=</span> <span class="token string">'&#125;&#125;'</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> openDelimiter <span class="token operator">=</span> <span class="token string">'&#123;&#123;'</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> closeIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>    closeDelimiter<span class="token punctuation">,</span>    openDelimiter<span class="token punctuation">.</span>length  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">adviceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> openDelimiter<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> content <span class="token operator">=</span> context<span class="token punctuation">.</span>source    <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> closeIndex <span class="token operator">-</span> openDelimiter<span class="token punctuation">.</span>length<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">adviceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> closeIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>      content<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 推进操作(删除已解析代码)</span><span class="token keyword">function</span> <span class="token function">adviceBy</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> length</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  context<span class="token punctuation">.</span>source <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 解析器入口</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">baseParse</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">content</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createParserContext</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="实现-parse-模块的-element-解析">实现 parse 模块的 Element解析</h3><p><strong>需求</strong></p><p>识别 <code>&lt;xx&gt;&lt;/xx&gt;</code> 的代码并解析为 AST 树,其结构为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>  <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>实现</strong></p><ul><li>定义枚举 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> NodeTypes <span class="token punctuation">&#123;</span>  <span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>  <span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>  <span class="token constant">ELEMENT</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>实现解析函数 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/compiler-core/src/parse.ts</span><span class="token comment">// 识别条件 &lt;字母模式, 这个定义看起来很宽松, 但是却是标准定义</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;[a-zA-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> node <span class="token operator">=</span> <span class="token function">parseElement</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">parseElement</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> tagMatch <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;([a-zA-Z]*)>.*&lt;\/\1></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> tag <span class="token operator">=</span> tagMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token function">adviceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> tagMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>    tag<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="实现-parse-模块的-text-解析">实现 parse 模块的 Text 解析</h3><p><strong>需求</strong></p><p>将不满足两种规范的代码识别为 Text 并解析为 AST 树, 其结构为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>  <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>  <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'bulabula'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>实现</strong></p><ul><li>定义枚举: 略</li><li>返回 AST <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">parseText</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> content <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">;</span>  <span class="token function">adviceBy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> content<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>    content<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="同时解析三种类型">同时解析三种类型</h3><p><strong>需求</strong></p><p>将 <code>&lt;div&gt;hi, &#123;&#123;message&#125;&#125;&lt;/div&gt;</code>解析为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>  <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">,</span>  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'hi, '</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">,</span>      <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token punctuation">,</span>        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'message'</span><span class="token punctuation">,</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>实现</strong></p><ul><li><p>修正 Element 使之可以解析 Element 标签内部文本</p><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">function parseElement(context) &#123;<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> const tagMatch = context.source.match(/^&lt;([a-zA-Z]*)>.*&lt;\/\1>/);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const tagMatch = context.source.match(/^&lt;([a-zA-Z]*)>(.*)&lt;\/\1>/);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const tag = tagMatch[1];</span><span class="token prefix unchanged"> </span><span class="token line"> adviceBy(context, tagMatch[0].length);</span><span class="token prefix unchanged"> </span><span class="token line"> return &#123;</span><span class="token prefix unchanged"> </span><span class="token line">   type: NodeTypes.ELEMENT,</span><span class="token prefix unchanged"> </span><span class="token line">   tag,</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   children: parseChildren(createParserContext(tagMatch[2])),</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> &#125;;</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>修正 Text 解析使之可以在遇到插值 / Element 前导时停止解析</p><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">function parseText(context) &#123;<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> let content = context.source;</span><span class="token prefix inserted">+</span><span class="token line"> if (~content.indexOf('&#123;&#123;')) &#123;</span><span class="token prefix inserted">+</span><span class="token line">   content = content.slice(0, content.indexOf('&#123;&#123;') );</span><span class="token prefix inserted">+</span><span class="token line"> &#125; else if (/&lt;\/?[a-zA-Z].+/.test(content)) &#123;</span><span class="token prefix inserted">+</span><span class="token line">   content = content.slice(</span><span class="token prefix inserted">+</span><span class="token line">     0,</span><span class="token prefix inserted">+</span><span class="token line">     content.length - content.match(/&lt;\/?[a-zA-Z].+/).length</span><span class="token prefix inserted">+</span><span class="token line">   );</span><span class="token prefix inserted">+</span><span class="token line"> &#125;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> adviceBy(context, content.length);</span><span class="token prefix unchanged"> </span><span class="token line"> return &#123;</span><span class="token prefix unchanged"> </span><span class="token line">   type: NodeTypes.TEXT,</span><span class="token prefix unchanged"> </span><span class="token line">   content,</span><span class="token prefix unchanged"> </span><span class="token line"> &#125;;</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在一次解析并推进完成后继续解析剩余代码 <pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">function parseChildren(context) &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const nodes = [] as any[];</span><span class="token prefix unchanged"> </span><span class="token line"> let node = null as any;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> while (context.source) &#123;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   if (context.source.startsWith('&#123;&#123;')) node = parseInterpolation(context);</span><span class="token prefix unchanged"> </span><span class="token line">   else if (/^&lt;[a-zA-Z]/.test(context.source)) node = parseElement(context);</span><span class="token prefix unchanged"> </span><span class="token line">   else node = parseText(context);</span><span class="token prefix unchanged"> </span><span class="token line">   nodes.push(node);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> &#125;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> return nodes;</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li></ul><h3 id="实现-transform-模块">实现 Transform 模块</h3><p>希望为 transform 传入一个函数组, 对每个节点执行这些函数.我们只需要做一个 DFS 即可</p><ul><li>DFS <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> NodeTypes <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./ast'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> <span class="token constant">TO_DISPLAY_STRING</span> <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./runtimeHelpers'</span><span class="token punctuation">;</span><span class="token comment">// 创建上下文并遍历</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createTransformContext</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">traverseNode</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>  root<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>context<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 创建上下文</span><span class="token keyword">function</span> <span class="token function">createTransformContext</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    root<span class="token punctuation">,</span>    <span class="token literal-property property">nodeTransforms</span><span class="token operator">:</span> options<span class="token punctuation">.</span>nodeTransforms <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token literal-property property">helpers</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">helper</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      context<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> context<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 遍历节点, 如果是插值节点就调用 helper, ROOT 与 Element 就遍历子节点</span><span class="token keyword">function</span> <span class="token function">traverseNode</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> any<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token literal-property property">exitFns</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">of</span> context<span class="token punctuation">.</span>nodeTransforms<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> onExit <span class="token operator">=</span> <span class="token function">i</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>    onExit <span class="token operator">&amp;&amp;</span> exitFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onExit<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token operator">:</span>      context<span class="token punctuation">.</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">TO_DISPLAY_STRING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ROOT</span><span class="token operator">:</span>    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token operator">:</span>      <span class="token function">traverseChildren</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">let</span> i <span class="token operator">=</span> exitFns<span class="token punctuation">.</span>length<span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> exitFns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 遍历子节点</span><span class="token keyword">function</span> <span class="token function">traverseChildren</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">context</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> child <span class="token keyword">of</span> node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token function">traverseNode</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>定义枚举 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">TO_DISPLAY_STRING</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">toDisplayString</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">CREATE_ELEMENT_VNODE</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">"createElementVNode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> helperNameMap <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">[</span><span class="token constant">TO_DISPLAY_STRING</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">"toDisplayString"</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token constant">CREATE_ELEMENT_VNODE</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">"createElementVNode"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>为 ROOT 打上 tag <pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">function createRoot(children) &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> return &#123;</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   type: NodeTypes.ROOT,</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   children,</span><span class="token prefix unchanged"> </span><span class="token line"> &#125;;</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="实现-compile-模块">实现 compile 模块</h3><p>需要将 AST 转换为代码字符串. 可以将 AST 分为四类</p><ul><li>Text</li><li>插值</li><li>Element: children 只有一个元素 (e.g.<code>&lt;div&gt;as&lt;/div&gt;</code> =&gt;<code>h('div', &#123;&#125;, 'as')</code>)</li><li>Element: children 有多个元素 (e.g.<code>&lt;div&gt;as &#123;&#123;her&#125;&#125;&lt;/div&gt;</code> =&gt;<code>h('div', &#123;&#125;, 'as' + her)</code>), 称之为复杂类型</li></ul><p>处理最后一种 AST 需要在内容中解析出的每个元素之间用 <code>+</code>连接</p><ul><li><p>加入枚举类型 <pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">export const enum NodeTypes &#123;<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> INTERPOLATION,</span><span class="token prefix unchanged"> </span><span class="token line"> SIMPLE_EXPRESSION,</span><span class="token prefix unchanged"> </span><span class="token line"> ELEMENT,</span><span class="token prefix unchanged"> </span><span class="token line"> TEXT,</span><span class="token prefix unchanged"> </span><span class="token line"> ROOT,</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> COMPOUND_EXPRESSION,</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>代码生成 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isString <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../share'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> NodeTypes <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./ast'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>  <span class="token constant">CREATE_ELEMENT_VNODE</span><span class="token punctuation">,</span>  helperNameMap<span class="token punctuation">,</span>  <span class="token constant">TO_DISPLAY_STRING</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./runtimeHelpers'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createCodegenContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建上下文</span>  <span class="token function">genFunctionPreamble</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建依赖引入</span>  <span class="token keyword">const</span> functionName <span class="token operator">=</span> <span class="token string">'render'</span><span class="token punctuation">;</span> <span class="token comment">// 函数名</span>  <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'_ctx'</span><span class="token punctuation">,</span> <span class="token string">'_cache'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 函数参数</span>  <span class="token keyword">const</span> signature <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 函数参数字符串</span>  context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>functionName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>signature<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">)&#123;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 连接函数头</span>  context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'return '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">genNode</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>codegenNode<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成 AST 对应的内推</span>  context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">code</span><span class="token operator">:</span> context<span class="token punctuation">.</span>code<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">genFunctionPreamble</span><span class="token punctuation">(</span><span class="token parameter">ast<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> VueBinging <span class="token operator">=</span> <span class="token string">'Vue'</span><span class="token punctuation">;</span> <span class="token comment">// 引用自的变量 `import &#123;...&#125; from Vue`</span>  <span class="token keyword">const</span> <span class="token function-variable function">aliasHelper</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>helperNameMap<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>helperNameMap<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// 引用代码生成函数</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 生成代码</span>    context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">const &#123; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>ast<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>aliasHelper<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> &#125; = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>VueBinging<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'return '</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">createCodegenContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将拼接代码功能写入 context</span>      context<span class="token punctuation">.</span>code <span class="token operator">+=</span> source<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token function">helper</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>helperNameMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> context<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">genNode</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> any<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 分类生成不同 AST 对应的代码</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token operator">:</span>      <span class="token function">genText</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token operator">:</span>      <span class="token function">genInterpolation</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">SIMPLE_EXPRESSION</span><span class="token operator">:</span>      <span class="token function">genExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token operator">:</span>      <span class="token function">genElement</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMPOUND_EXPRESSION</span><span class="token operator">:</span>      <span class="token function">genCompoundExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">genCompoundExpression</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">context</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> child <span class="token keyword">of</span> node<span class="token punctuation">.</span>children<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token function">genNode</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">genElement</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">context</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>context<span class="token punctuation">.</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">CREATE_ELEMENT_VNODE</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">(</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">genNodeList</span><span class="token punctuation">(</span><span class="token function">genNullable</span><span class="token punctuation">(</span><span class="token punctuation">[</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">,</span> node<span class="token punctuation">.</span>props<span class="token punctuation">,</span> node<span class="token punctuation">.</span>children<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>  context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">genNodeList</span><span class="token punctuation">(</span><span class="token parameter">nodes<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nodes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> node <span class="token operator">=</span> nodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token function">genNode</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> nodes<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">genNullable</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">args</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token operator">=></span> arg <span class="token operator">||</span> <span class="token string">'null'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">genExpression</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">context</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>node<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">genInterpolation</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">context</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>context<span class="token punctuation">.</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token constant">TO_DISPLAY_STRING</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">(</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">genNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>content<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>  context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">genText</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">context</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  context<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>node<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>创建根节点的入口节点 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createRootCodegen</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">context</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> children <span class="token punctuation">&#125;</span> <span class="token operator">=</span> root<span class="token punctuation">;</span>  <span class="token keyword">const</span> child <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span> <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span>codegenNode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> codegenNode <span class="token operator">=</span> child<span class="token punctuation">.</span>codegenNode<span class="token punctuation">;</span>    root<span class="token punctuation">.</span>codegenNode <span class="token operator">=</span> codegenNode<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    root<span class="token punctuation">.</span>codegenNode <span class="token operator">=</span> child<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>Element 生成函数 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createVNodeCall<span class="token punctuation">,</span> NodeTypes <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"../ast"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">transformElement</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token comment">// tag</span>      <span class="token keyword">const</span> vnodeTag <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>node<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>      <span class="token comment">// props</span>      <span class="token keyword">let</span> vnodeProps<span class="token punctuation">;</span>      <span class="token comment">// children</span>      <span class="token keyword">const</span> children <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">;</span>      <span class="token keyword">let</span> vnodeChildren <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      node<span class="token punctuation">.</span>codegenNode <span class="token operator">=</span> <span class="token function">createVNodeCall</span><span class="token punctuation">(</span>        context<span class="token punctuation">,</span>        vnodeTag<span class="token punctuation">,</span>        vnodeProps<span class="token punctuation">,</span>        vnodeChildren      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>生成表达式 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> NodeTypes <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"../ast"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">transformExpression</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    node<span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token function">processExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">processExpression</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  node<span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_ctx.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>node<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>  <span class="token keyword">return</span> node<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>生成文本节点 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> NodeTypes <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../ast'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isText <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../utils'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">transformText</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> children <span class="token punctuation">&#125;</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>      <span class="token keyword">let</span> currentContainer<span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> child <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isText</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">const</span> next <span class="token operator">=</span> children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isText</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentContainer<span class="token punctuation">)</span>                currentContainer <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>                  <span class="token literal-property property">type</span><span class="token operator">:</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">COMPOUND_EXPRESSION</span><span class="token punctuation">,</span>                  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>child<span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>              currentContainer<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">' + '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              currentContainer<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>              children<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              j<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>              currentContainer <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>Text 节点与 string 判断函数 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">isString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isText</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">INTERPOLATION</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>type <span class="token operator">===</span> NodeTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li></ul><h3 id="让-runtime-core-调用-compiler-core">让 runtime-core 调用compiler-core</h3><p>runtime-core 会在确定 instance.render 时调用 compiler-core. 如果setup 不返回函数, 组件没有自带 render 函数, runtime-core 会在有 template时调用 compiler-core. compiler-core 会返回函数代码, 我们需要根据代码获得render 函数</p><p><strong>测试代码</strong></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> h<span class="token punctuation">,</span> ref <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../lib/micro-vue.esm.js'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'micro-vue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'hihi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> message <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div>hi, &#123;&#123;message&#125;&#125;&lt;/div></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>实现</strong></p><ul><li><p>构造 compiler-core 向外暴露的函数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> generate <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./codegen'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> baseParse <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./parse'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> transform <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./transform'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> transformExpression <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./transforms/transformExpression'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> transformElement <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./transforms/transformElement'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> transformText <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./transforms/transformText'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">baseParse</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">transform</span><span class="token punctuation">(</span>    ast<span class="token punctuation">,</span>    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>      <span class="token literal-property property">nodeTransforms</span><span class="token operator">:</span> <span class="token punctuation">[</span>transformElement<span class="token punctuation">,</span> transformText<span class="token punctuation">,</span> transformExpression<span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在 runtime-core 中加入编译 template 功能 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  instance<span class="token punctuation">.</span>render <span class="token operator">=</span> instance<span class="token punctuation">.</span>render <span class="token operator">||</span> instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span>render <span class="token operator">||</span> <span class="token function">compiler</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></p></li><li><p>为 patchProps 加入兜底功能 <pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">export function patchProps(elem: HTMLElement, oldProps = &#123;&#125;, newProps = &#123;&#125;) &#123;<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> oldProps ??= &#123;&#125;;</span><span class="token prefix inserted">+</span><span class="token line"> newProps ??= &#123;&#125;;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> // ...</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>导出 createElementNode <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token punctuation">&#123;</span> createVNode <span class="token keyword">as</span> createElementVNode <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p></li><li><p>解决循环依赖问题: runtime-core 需要从 Vue 获取编译函数而 Vue需要引用 runtime-core. 为了解决循环依赖, 可以让 runtime-core 暴露一个SET 函数, 当文件加载完毕后调用祖册函数为 runtime-core 注册来自compiler-core 的编译函数.</p><ul><li>在 runtime-core 中暴露注册函数 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> compiler<span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">registerRuntimeCompiler</span><span class="token punctuation">(</span><span class="token parameter">_compiler</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  compiler <span class="token operator">=</span> _compiler<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>在最外层引入 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./reactivity/src/index'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./runtime-dom/src/index'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> baseCompile <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./compiler-core/src'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> runtimeDom <span class="token keyword">from</span> <span class="token string">'./runtime-dom/src'</span><span class="token punctuation">;</span><span class="token comment">// 将文本转换为函数的函数</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compileToFunction</span><span class="token punctuation">(</span><span class="token parameter">template</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 代码</span>  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> code <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// compiler-core 编译的函数形如</span>  <span class="token comment">//   import &#123; createElementNode as _createElementNode &#125; from Vue</span>  <span class="token comment">//   return _createElementVNode(...)</span>  <span class="token comment">// 我们希望获取 return 结果, 将这个代码段构造为函数</span>  <span class="token comment">//   function ff(Vue)&#123;</span>  <span class="token comment">//     import &#123; createElementNode as _createElementNode &#125; from Vue</span>  <span class="token comment">//     return _createElementVNode(...)</span>  <span class="token comment">//   &#125;</span>  <span class="token comment">// 只需要传入 Vue 作为参数并获取函数运行结果即可</span>  <span class="token comment">// 无需 eval, 用 Function 即可构造函数. 并传入 Vue 即可</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'Vue'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">(</span>runtimeDom<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 将这个编译函数注入 runtime-core, runtime-core 即可拥有编译函数</span>runtimeDom<span class="token punctuation">.</span><span class="token function">registerRuntimeCompiler</span><span class="token punctuation">(</span>compileToFunction<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p>编译后的函数需要两个参数, 传入相同值 <pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">function componentUpdateFn(instance, container, anchor, patch) &#123;<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> const subTree = instance.render.call(instance.proxy);</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const subTree = instance.render.call(instance.proxy, instance.proxy);</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> if (instance.next) &#123;</span><span class="token prefix unchanged"> </span><span class="token line">   instance.vNode = instance.next;</span><span class="token prefix unchanged"> </span><span class="token line">   instance.props = instance.next.props;</span><span class="token prefix unchanged"> </span><span class="token line">   // ...</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li></ul>]]></content>
    
    
    <summary type="html">尝试理解 Vue 的设计思想与实现, 参考自: mini-vue, Vue.js 设计与实现</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="前端框架" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="笔记" scheme="https://blog.liukairui.me/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="前端框架" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/"/>
    
    <category term="Vue" scheme="https://blog.liukairui.me/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>《你不知道的JavaScript》学习</title>
    <link href="https://blog.liukairui.me/article/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84JavaScript%E5%AD%A6%E4%B9%A0/"/>
    <id>https://blog.liukairui.me/article/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84JavaScript%E5%AD%A6%E4%B9%A0/</id>
    <published>2022-07-02T16:00:01.000Z</published>
    <updated>2022-07-02T16:00:01.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="作用域与闭包">作用域与闭包</h2><p>作用域是一套根据名字查找变量的规则,作用域维护了所有声明的变量并确定变量的访问权限.</p><h3 id="作用域在编译中的交互">作用域在编译中的交互</h3><p>JavaScript 是一门解释型语言, 解释器有三部分构成</p><ul><li>引擎: 负责整个解释过程</li><li>编译器: 进行词法语法分析与代码生成</li><li>作用域: 维护了所有声明的变量确定变量的访问权限</li></ul><p><strong>引擎请求</strong></p><p>在解释过程中, 引擎会不断的向作用域发出 <code>LHS</code> 与<code>RHS</code> 查询. 可以认为 <code>LHS</code> 查询是在查询左值,<code>RHS</code> 是在查询右值(或者理解为非左值). 换而言之,当变量要进行赋值操作时, 引擎会执行 <code>LHS</code> 查询,这时引擎不关心变量的值, 而关心变量的位置. 其他情况下引擎执行<code>RHS</code> 查询, 这时引擎只关心变量的值.作用域收到请求后根据请求标识符返回值. 例如,在下面这段代码执行时发生了如下查询:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol type="1"><li>将 <code>function foo(a)&#123;&#125;</code> 看作<code>var foo = function()&#123;&#125;</code>, 引擎执行 <code>var foo</code>时发出 <code>RHS</code> 请求查询 <code>foo</code>, 查询不到, 遂创建<code>foo</code> 变量</li><li>引擎执行 <code>foo = ...</code> 时发出 <code>LHS</code> 请求查询<code>foo</code>, 查询到后分配变量</li><li>引擎执行 <code>var b</code> 时发出 <code>RHS</code> 请求查询<code>b</code>, 查询不到, 遂创建 <code>b</code> 变量</li><li>引擎执行 <code>b = 2</code> 时发出 <code>LHS</code> 请求查询<code>b</code>, 查询到后分配变量</li><li>引擎执行 <code>foo(2)</code> 时发出 <code>RHS</code> 请求查询<code>foo</code></li><li>引擎执行 <code>foo(2)</code> 时发出 <code>LHS</code> 请求查询<code>a</code>, 查询到后隐式分配变量</li><li>引擎执行 <code>console</code> 时发出 <code>RHS</code> 请求查询<code>console</code></li><li>引擎执行 <code>console.log</code> 时发出 <code>RHS</code> 请求查询<code>console</code> 下的 <code>log</code></li><li>引擎执行 <code>console.log(a)</code> 时发出 <code>RHS</code>请求查询 <code>a</code></li></ol><p><strong>作用域回应</strong></p><p>作用域在收到引擎的 <code>LHS/RHS</code>请求后会在本作用域下查找并返回对标识符的引用</p><p><strong>引擎的处理</strong></p><ul><li><p>若作用域没找到标识符:</p><p>引擎会请求上一层作用域直到全局作用域.若在全局作用域中还是没找到标识符</p><ul><li>若发起的是 <code>RHS</code> 请求: 直接抛出<code>ReferenceError</code></li><li>若发起的是 <code>LHS</code> 请求: 在非严格模式下会直接创建变量,在严格模式下会抛出 <code>ReferenceError</code> 异常. <strong>注意,这种情况针对的是诸如 <code>b = a</code> 的情况, 如果是<code>var b = a</code>, 那么引擎会先执行 <code>RHS</code> 创建<code>b</code> 再执行 <code>LHS</code> 赋值</strong>.</li></ul></li><li><p>若作用域找到标识符</p><ul><li>若是 <code>LHS</code> 请求则进行赋值操作</li><li>若是 <code>RHS</code>请求则继续判断是否对右值进行非法操作(如对非函数变量执行函数调用)</li></ul></li></ul><h3 id="词法作用域">词法作用域</h3><p>作用域有两种常见的模式</p><ul><li>词法作用域: 大多数语言(包括JS)采用的</li><li>动态作用域: Bash/Perl语言采用</li></ul><p>简单的说,词法作用域就是在<strong>程序执行之前的词法分析阶段</strong>确定的静态作用域.编译器会在词法分析阶段根据<strong>变量的位置关系</strong>确定直接确定作用域.</p><p>引擎请求作用域查找时, 作用域只会查找一级标识符, 例如: 查询<code>console.log</code> 时, 作用域只查询 <code>console</code>,在下一次查询时候才在 <code>console</code> 中查询 <code>log</code></p><p><strong>遮蔽效应</strong></p><p>对于存在嵌套关系的作用域,引擎在查询时会优先查找内部作用域而忽略外部作用域中的同名标识符.全局作用域中的变量会被自动加入全局对象(<code>window/global</code>),可以直接通过 <code>global</code> 访问全局作用域变量,这也是忽略内层作用域的唯一方法.</p><p><strong>欺骗词法作用域</strong></p><p>词法作用域是在词法分析进行的, 这意味着程序员无法在运行时修改作用域,但是存在几种方法可以动态干预作用域</p><ul><li><code>eval</code> 函数: 动态的为 <code>eval</code>传入参数可以对当前作用域做动态修改</li><li><code>with</code> 函数: 相当于手动创建了一个作用域,<code>with</code> 的参数会被"解构"作为作用域中的变量</li><li><code>apply/call/bind</code>函数.</li></ul><p>动态干预方法存在诸多弊端</p><ul><li><p>性能下降: JavaScript 在执行前会执行静态分析与性能优化,但是无法分析 <code>eval/with</code> 中的动态作用域,亦无法进行性能优化.</p></li><li><p>严格模式不可用:</p><ul><li>在严格模式下 <code>eval</code> 函数内部有自己的作用域, 此时<code>eval</code> 函数无法干预原作用域</li><li>严格模式下 <code>with</code> 不可用</li></ul></li><li><p>污染全局变量: 例如</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">with</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    a <span class="token operator">=</span> v<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> obj1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">foo</span><span class="token punctuation">(</span>obj1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">foo</span><span class="token punctuation">(</span>obj2<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// &#123; a: 1 &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// &#123; b: 2 &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 2 发生泄漏</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>动态作用域</strong></p><p>JavaScript 使用的是词法作用域模型, 但是部分语言在采用动态作用域</p><ul><li>词法作用域:词法分析阶段根据<strong>变量的位置关系</strong>确定直接确定作用域.</li><li>动态作用域: 作用域在运行时<strong>动态变化</strong>,动态作用域的作用域链一般是基于调用栈的(这与 <code>JavaScript</code> 的<code>this</code> 特性很像)</li></ul><p>例如, 对于代码:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>静态作用域: 在执行 <code>foo</code> 时, 引擎发起 <code>RHS</code>请求 <code>a</code>, 找不到, 向外直接查找全局<code>a = 2</code></p></li><li><p>动态作用域: 在执行 <code>foo</code> 时, 引擎发起 <code>RHS</code>请求 <code>a</code>, 找不到, 顺着作用域链(调用栈)直接查找<code>bar</code> 中的 <code>a = 3</code>, 看起来很像 JavaScript 的<code>this</code> 机制</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="函数与块作用域">函数与块作用域</h3><p><strong>函数作用域</strong></p><p>函数内部的变量与方法位于函数作用域中, 无法被外部访问.</p><p>利用函数作用域可以隐藏代码的部分内部实现, 从而实现</p><ul><li>最小特权原则</li><li>规避变量冲突(其他实现规避冲突的方法有配置命名空间, 模块化管理)</li></ul><p>在实践中, 实现函数作用域的方法有</p><ul><li><p>直接在代码内部定义函数, 并在定义后调用函数</p><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">// 上文<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> function foo()&#123;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   // 保护起来的部分</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> &#125;</span><span class="token prefix inserted">+</span><span class="token line"> foo()</span></span>// 下文<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这种方法必须声明一个具名函数, 然后在调用, 不仅繁琐,具名函数还无形中污染了外层作用域</p></li><li><p>使用函数表达式代替函数</p><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">// 上文<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> (function foo()&#123;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   // 保护起来的部分</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> &#125;)()</span></span>// 下文<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>JavaScript 在解析句子时, 若发现第一个关键字是 <code>function</code>则会将这句话判定为<strong>函数定义</strong>,遇到其他符号(例如这里的<code>(</code>),则会将这句话当作<strong>表达式</strong>. 可以通过<code>(function foo()&#123;&#125;)()</code> 的方法定义函数. 此时,不仅不用显式调用函数, <code>foo</code>标识符也<strong>不能被外部访问</strong>, 不会污染外层作用域</p></li><li><p>匿名函数</p><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">// 上文<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> (function()&#123;</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   // 保护起来的部分</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> &#125;)()</span></span>// 下文<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>缺点: 难以得知函数语义, 调试困难.函数内部无法通过函数名调用函数名上的变量(如:<code>callee</code>)</p></li><li><p>IIFT</p><p>实际上有两种IIFT的写法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>两者在功能上完全一致, 任选其一即可</p></li></ul><p><strong>ES6的块作用域</strong></p><p><code>ES6</code> 中的关键字 <code>let</code>, <code>const</code>都支持变量块作用域, 其实现的原理是:在声明变量时<strong>隐式</strong>的将变量劫持在所在的块作用域上.但这两个关键字不支持变量提升, 在实践时最好将变量声明在作用域首部.</p><p><strong>ES6之前的块作用域实现</strong></p><p>在 <code>ES6</code> 前的时代, <code>JavaScript</code>只有全局作用域与函数作用域,伟大的程序员们利用部分特性实现了部分块作用域</p><p>实际上在 <code>ES6</code> 前有部分语法"支持"块作用域</p><ul><li><p><code>with</code> 为内部代码手动创建了一个作用域,内部代码可以认为是包在 <code>with()&#123;&#125;</code> 产生的块作用域中</p></li><li><p><code>try-catch</code> 方法的 <code>catch</code>分句会创造块作用域. 利用这个特性, 部分 JavaScript 的 polyfill转译工具会将 <code>ES6</code> 的块作用域翻译为 <code>try-catch</code>语句, 例如</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>翻译为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token keyword">throw</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>注意</strong>:</p><blockquote><p>早期 JavaScript 要求统一作用域下的不同 <code>try-catch</code> 语句的<code>catch</code> 分句中不能使用相同的标识符声明错误, 即<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>是错的, 需要将 <code>error</code> 改为 <code>error1</code>,<code>error2</code>...</p></blockquote></li></ul><h3 id="函数与变量提升">函数与变量提升</h3><p>对于 <code>var</code> 与 <code>function</code> 声明的标识符,存在变量提升. JavaScript 引擎会在编译阶段进行静态代码分析,获得词法作用域, 完成声明.</p><ul><li><p>对于 <code>var</code> 声明的变量或函数: JavaScript只会提升变量定义, 在正式定义前, 变量是 <code>undefined</code></p></li><li><p>对于 <code>function</code> 声明的函数: JavaScript会提升函数函数声明与定义.</p></li><li><p>若作用域中同时存在 <code>var</code> 与 <code>function</code>声明. <code>function</code> 优先, 例如:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 1</span><span class="token keyword">var</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>相当于</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// funciton 优先</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> foo<span class="token punctuation">;</span>         <span class="token comment">// var滞后, 于是这个就废掉了</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="闭包">闭包</h3><p>当函数在自己定义作用域以外的部分执行时, 函数会保留对原作用域的引用,这个引用就是闭包. 换而言之, 一旦使用了同步/异步的回调函数,就产生了闭包.</p><p>函数可以保持对闭包的引用, 但是无法保证闭包内的值并不变. 同时,闭包可以阻止所在函数作用域的垃圾回收.</p><p><strong>实现模块化</strong></p><p>JavaScript 的模块化就借用了闭包实现, 以下是一个模块化的基本模式</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">onemod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> attr1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// do sth</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>        method1    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在函数内部定义变量与方法, 通过 <code>return</code>将需要暴露的变量导出.</p><p>函数每次调用就会导出一个全新模块. 但是, 也因为函数可以传入参数,编译器无法对此类模块做出静态分析与优化. 在 <code>ES6</code> 中,每个模块被定义为文件通过 <code>import/export</code> 导入导出,此时编译器可以在编译阶段对模块进行静态分析.</p><h2 id="this-和对象原型"><code>this</code> 和对象原型</h2><h3 id="关于-this">关于 <code>this</code></h3><p><strong><code>this</code> 不是什么</strong></p><ul><li><p><code>this</code> 不是函数自身</p><p>无法通过 <code>this</code> 获取函数作为对象的属性.若想对函数对象操作还是需要使用<strong>函数标识符</strong>或在函数内使用<strong><code>arguments.callee</code></strong> (已弃用)</p></li><li><p><code>this</code> 不是函数作用域</p><p><code>this</code> 不指向函数作用域, 作用域在编译阶段就生成了, 但<code>this</code> 是在运行时动态变换的. 作用域是存在于 JavaScript引擎中的"对象", 无法在代码中被引用</p></li></ul><p><strong><code>this</code> 是什么</strong></p><p>this是函数调用时被调用函数上下文中的一个属性,其具体的指向取决于函数的调用方式</p><p><strong>为什么需要<code>this</code></strong></p><p><code>this</code> 提供了一种让函数调用隐式传递其对象引用的模式,在函数被调用时, <code>this</code> 作为函数上下文中的一项被传入函数</p><h3 id="this-的指向"><code>this</code> 的指向</h3><p>分析 <code>this</code> 的指向首先要分析函数的调用位置,也就是分析调用栈的第二项</p><p>我们将先从易到难的介绍各种规则, 然后规定规则的优先级</p><p><strong>规则</strong></p><ul><li><p>默认绑定</p><p>当函数被直接调用(如: <code>foo()</code>)时, <code>this</code>会被绑定到 <code>global/window</code> 对象. 在严格模式下,<code>this</code> 无法指向全局对象, 其会指向<code>undefined</code></p></li><li><p>隐式绑定</p><p>若被调用对象被其他对象在<strong>形式上</strong>包含,<code>this</code> 将指向被包含对象.可以从下面几个例子中理解形式上的包围</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">window<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// SITUATION 1: 包围</span><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>foo<span class="token punctuation">.</span><span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1, 没问题, 调用时是 foo.demo(), demo被foo包围了</span><span class="token comment">// SITUATION 2: 形式上包围</span><span class="token keyword">function</span> <span class="token function">demoGlobal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">demo</span><span class="token operator">:</span> demoGlobal<span class="token punctuation">,</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>bar<span class="token punctuation">.</span><span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2, 虽然 bar.demo 引用自全局函数, 但是在bar.demo中demo被bar包围了</span><span class="token comment">// SITUATION 3: 形式上包围</span><span class="token keyword">const</span> demoFromFoo <span class="token operator">=</span> foo<span class="token punctuation">.</span>demo<span class="token punctuation">;</span><span class="token function">demoFromFoo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0, 虽然 demoFromFoo 引用自 foo.demo , 但是在这里并没有被包围</span><span class="token comment">// SITUATION 4: 回调函数</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>demo<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0, 可以简化调用过程为</span><span class="token comment">// function setTimeout(fn, delay) &#123; // 这里其实进行了一次函数的赋值, 与SITUATION 3 类似, 于是失去了包围对象</span><span class="token comment">//   sleep(delay);</span><span class="token comment">//   fn();</span><span class="token comment">// &#125;</span><span class="token comment">// SITUATION 5: 包围陷阱</span><span class="token keyword">const</span> baz <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">(</span>baz<span class="token punctuation">.</span>demo <span class="token operator">=</span> foo<span class="token punctuation">.</span>demo<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0, 赋值语句返回的是目标函数的引用, 相当于就是一个 function()&#123;...&#125; , 但是在这里并没有被包围</span><span class="token comment">// SITUATION 6: 只关注前一层包围</span><span class="token keyword">const</span> outer <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">inner</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>    <span class="token literal-property property">demo</span><span class="token operator">:</span> demoGlobal<span class="token punctuation">,</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>outer<span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3, 只关心包围的第一的外层元素(inner)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也将 SITUATION 3&amp;4 的情况称为<strong>隐式丢失</strong></p></li><li><p>显式绑定</p><p>JavaScript 中改变 <code>this</code> 指向的方法有<code>call / apply / bind</code>, 对于 <code>call / apply</code>,这两个函数可以直接修改 <code>this</code> 的指向. <code>bind</code>函数可以返回一个修改 <code>this</code> 后的函数,可以将其实现<strong>简单的</strong>理解为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> self</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>部分 API 自身就支持改变 <code>this</code> 指向, 如<code>Array.prototype.forEach()</code> 支持修改回调的<code>this</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>array<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>d<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined undefined undefined</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>array<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>d<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 2 3</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>若传入 <code>this = null</code> 那么 <code>this</code> 将变为<code>global</code></strong></p></li><li><p><code>new</code> 绑定</p><p>使用 <code>new</code> 新建实例时, 构造函数的 <code>this</code>将绑定到创建的实例</p></li><li><p>箭头函数: 直接绑定非外层非箭头函数的 <code>this</code></p></li></ul><p><strong>优先级</strong></p><ol start="0" type="1"><li>箭头函数</li><li><code>new</code> 绑定</li><li>显式绑定: 注意, <code>new</code> 的优先级高于 <code>ES6</code>实现的 <code>bind</code>, 那个 <code>bind</code> 与前面简化的<code>bind</code> 不同</li><li>隐式绑定</li><li>默认绑定</li></ol><p>讨论 <code>new</code> 绑定与 <code>bind</code>绑定的优先级是有意义的, 如下</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//...</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> initAs12X <span class="token operator">=</span> <span class="token function">Foo</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">new</span> <span class="token class-name">initAs123</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">new</span> <span class="token class-name">initAs123</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们确定了构造函数的前两项为 <code>1, 2</code>, 希望在<code>new</code> 的时候只指定第三项, 就可以这么写, 先用<code>bind</code> 为函数传入前两个参数, 并绑定 <code>null</code> 作为<code>this</code>, 然后又用 <code>new</code> 覆盖 <code>this</code>.</p><p>在 JavaScript 中, <code>bind</code> 函数可以用来实现函数柯里化.</p><p>最后, 引用来自掘金小册的流程图</p><pre class="mermaid">graph TBwhereisthis(寻找函数中的this) --箭头函数--> outerthis(包裹箭头函数的非箭头函数的this)whereisthis(寻找函数中的this) --普通函数--> ways(函数调用方式)whereisthis(寻找函数中的this) --bind/call/apply--> fstparam(第一个参数)ways --new--> instance(this被固化在实例上)ways --其他方式--> form(函数被调用的方式)form --foo--> window(this为window/严格模式下的undefined)form --bar.foo--> obj(this为bar)</pre><p><strong>陷阱</strong></p><ul><li><p>无用 <code>this</code>:</p><p>有时函数的 <code>this</code> 并不重要, 但是部分回调函数需要指定<code>this</code>(如通过 <code>bind</code> 实现柯里化,<code>forEach</code>函数). 我们可以传入 <code>null</code> 占位,但是若函数的 <code>this</code> 为可选参数且默认值为 <code>global</code>,填入 <code>null</code> 会让 <code>this</code> 指向 <code>global</code>,这可能会污染全局作用域. 解决方法是实现一个人畜无害的对象, 将其称之为<code>DMZ</code>(Demilitarized zone, 非军事区) 对象, 可以使用<code>Object.create(null)</code> 实现, 这个对象比 <code>&#123;&#125;</code>更"空",</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> empty <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>empty<span class="token punctuation">,</span> <span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>隐式丢失问题</p><p>在实现 vue 的 runtime-dom 时我曾写过</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> create <span class="token operator">=</span> document<span class="token punctuation">.</span>createElement<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但是在执行 <code>create('div')</code> 时出错了</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token constant">VM67</span><span class="token operator">:</span><span class="token number">1</span> Uncaught TypeError<span class="token operator">:</span> Illegal invocation    at <span class="token operator">&lt;</span>anonymous<span class="token operator">></span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这是因为 <code>document.createElement('div')</code> 时<code>this</code> 指向 <code>document</code> 但是调用<code>create</code> 时 <code>this</code> 指向 <code>global</code>.解决方案就是</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> create <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h3 id="对象">对象</h3><p><strong>构造</strong></p><p>可以通过<strong>字面量</strong>与<strong>构造函数</strong>两种方式构造对象,在字面量构造对象时, <code>Key</code> 有多重写法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> pre <span class="token operator">=</span> <span class="token string">'C-'</span><span class="token punctuation">;</span><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 一般模式</span>  <span class="token string-property property">'A-1'</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// A-1 会被理解为A减1, 放弃简写, 将Key用引号引起来</span>  <span class="token punctuation">[</span>pre <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 可以用[]实现计算属性, 结果相当于 'C-1': 1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 JavaScript 的基本类型中, 只有 Object 是对象.<code>typeof null === 'object'</code>, 这是因为</p><blockquote><p>在 JavaScript 中二进制前三位都为 0 的话会被判断为 <code>object</code>类型, <code>null</code> 的二进制表示全是 <code>0</code>, 自然前三位也是<code>0</code>, 所以执行 <code>typeof</code> 时返回<code>object</code></p></blockquote><p><strong>访问</strong></p><p>可以通过<strong>属性访问</strong>(<code>obj.a</code>)与<strong>值访问</strong><code>obj['a']</code>访问元素,两者效果相同</p><p>当属性访问的 <code>Key</code> 违反 JavaScript语法时(如<code>a.1</code>)可以用值访问替代. 值访问中,<code>[]</code>包裹的表达式可以是非 <code>string</code>,但是在最后都会转换为 <code>string</code>, 例如</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>obj<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>obj<span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>obj<span class="token punctuation">[</span>obj<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">'2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">'true'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">'[object Object]'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>虽然后三项都不是同一个 <code>object</code>, 但是他们转换为<code>string</code> 后都是 <code>'[object Object]'</code>,应此映射值一样</p><p><strong>复制</strong></p><ul><li><p>浅拷贝</p><ul><li>对于<code>JSON</code> 安全的对象:<code>JSON.parse(JSON.stringify(obj));</code></li><li><code>ES6</code> 下: <code>Object.assign(obj);</code></li></ul><p>这两个方法会将所有<strong>可枚举对象</strong>拷贝出来, 但是<code>JSON</code> 方法拷来的对象的属性描述符(如: writable)会被抹去,<code>Object.assign</code> 来的对象的属性描述符会保留</p></li><li><p>深拷贝</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 深拷贝</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">deepCopy</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> copyedObjs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 此数组解决了循环引用和相同引用的问题，它存放已经递归到的目标对象</span>  copyedObjs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">fromTarget</span><span class="token operator">:</span> source<span class="token punctuation">,</span> <span class="token literal-property property">toTarget</span><span class="token operator">:</span> target <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">deepCopyFunction</span><span class="token punctuation">(</span><span class="token parameter">sourceItem<span class="token punctuation">,</span> targetItem</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>sourceItem<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>        <span class="token keyword">typeof</span> sourceItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span>        sourceItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span>        sourceItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span>      <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        targetItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> sourceItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> copyedObjs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>copyedObjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fromTarget <span class="token operator">===</span> sourceItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            targetItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> copyedObjs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>toTarget<span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        targetItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>sourceItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> targetItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        copyedObjs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>          <span class="token literal-property property">fromTarget</span><span class="token operator">:</span> sourceItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>          <span class="token literal-property property">toTarget</span><span class="token operator">:</span> targetItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">deepCopyFunction</span><span class="token punctuation">(</span>sourceItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> targetItem<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token function">deepCopyFunction</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>属性描述符</strong></p><p>可以用 <code>Object.defineProperty(obj, attr, config)</code>定义对象的属性与属性标识, <code>config</code> 结构为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>    configurable<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span> <span class="token comment">// 是否允许修改属性描述符, 默认 false</span>    enumerable<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span> <span class="token comment">// 是否可以枚举, 默认 false</span>    value<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token comment">// 值, 默认 undefined</span>    writable<span class="token operator">?</span><span class="token operator">:</span>  <span class="token comment">// 值是否可修改, 默认 false</span>    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>显而易见的是: 将 <code>configurable</code> 改为 <code>false</code>后无法改回, 但是, 即使 <code>configurable: false</code>, 仍然可以将<code>writable</code> 从 <code>true</code> 改为 <code>false</code>,且无法改回.</li><li>可以使用 <code>delete</code> 删除属性(但并不意味着会被垃圾回收,因为被删除对象可能会被其他对象引用)</li></ul><p><strong>属性不变性</strong></p><ul><li>配置 <code>&#123;configurable: false, writable: false&#125;</code>即可创建常量属性</li><li>调用 <code>Object.preventExtensions()</code>可以让对象无法再添加新的属性(添加会造成静默失败, 在严格模式下会造成<code>typeError</code> )</li><li>调用 <code>Object.seal()</code> 可以让对象无法再添加/删除属性,无法重写属性描述符</li><li>调用 <code>Object.freeze()</code> 可以让对象在 <code>seal</code>的基础上 <code>writable: false</code>. 如需冻结整个对象,该需要递归冻结每个属性, 同时,引用这个属性的所有对象的该属性都会被冻结</li></ul><p><strong>getter与setter</strong></p><ul><li>访问对象的属性实际上是在对象上的 <code>[[Get]]</code> 方法, 默认的<code>[[Get]]</code> 方法会先查找对象上是否有该属性,若是对象上没有该属性, <code>[[Get]]</code>就会顺着<strong>原型链</strong>向上查找, 都找不到则返回<code>undefined</code>. <strong>这与作用域的查找不同,作用域查找失败后会向外层作用域查找, 都找不到则抛出<code>Reference Error</code></strong></li><li>为对象设置属性等操作会出发 <code>[[put]]</code>,<code>[[put]]</code> 会先检查属性是否存在, 在检查是否定义了属性标识符,若是则直接调用 <code>setter</code>, 再检查属性是否是<code>writebale</code> 的, 如果是则会造成静默失败或<code>TypeError</code>, 若不是则会设置值</li><li>可以在 <code>defineProperty</code> 时指定 <code>getter</code> 与<code>setter</code> 接替默认 <code>[[Get]]</code> 与<code>[[Put]]</code>, <strong>若定义了 <code>getter</code> 没有的定义<code>setter</code>, 在设置属性时 <code>[[Put]]</code> 不会赋值,而是直接忽略赋值且不抛出错误. 所以最高成对定义<code>getter/setter</code></strong></li></ul><p><strong>查找</strong></p><ul><li><code>in</code> 可以判断 <code>key</code>是否在对象或其原型链上(包括不可枚举的属性)</li><li><code>hasOwnProperty</code> 可以判断 <code>key</code> 是否在对象上,但不检查原型链</li><li><code>for-in</code> 可以遍历对象上的可枚举元素的<code>key</code></li><li><code>for-of</code> 可以遍历有迭代器对象上的所有值</li><li><code>Object.keys()</code> 可以返回对象上的可枚举元素</li><li><code>Object.getOwnPropertyNames()</code>可以返回对象上的所有元素</li></ul><h3 id="混入">混入</h3><ul><li><p>显式混入</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">mixin</span><span class="token punctuation">(</span> <span class="token parameter">sourceObj<span class="token punctuation">,</span> targetObj</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> sourceObj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 仅拷贝非既存内容</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> targetObj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   targetObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> sourceObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">return</span> targetObj<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>寄生继承</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// “传统的 JS 类” `Vehicle`</span><span class="token keyword">function</span> <span class="token function">Vehicle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>engines <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Vehicle</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">ignition</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"Turning on my engine."</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">Vehicle</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">drive</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ignition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"Steering and moving forward!"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// “寄生类” `Car`</span><span class="token keyword">function</span> <span class="token function">Car</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 首先, `car` 是一个 `Vehicle`</span> <span class="token keyword">var</span> car <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vehicle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 现在, 我们修改 `car` 使它特化</span> car<span class="token punctuation">.</span>wheels <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// 保存一个 `Vehicle::drive()` 的引用</span> <span class="token keyword">var</span> vehDrive <span class="token operator">=</span> car<span class="token punctuation">.</span>drive<span class="token punctuation">;</span> <span class="token comment">// 覆盖 `Vehicle::drive()`</span> car<span class="token punctuation">.</span><span class="token function-variable function">drive</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">vehDrive</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"Rolling on all "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wheels <span class="token operator">+</span> <span class="token string">" wheels!"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token keyword">return</span> car<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> myCar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>myCar<span class="token punctuation">.</span><span class="token function">drive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Turning on my engine.</span><span class="token comment">// Steering and moving forward!</span><span class="token comment">// Rolling on all 4 wheels!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>隐式混入</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> Something <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token function-variable function">cool</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>greeting <span class="token operator">=</span> <span class="token string">"Hello World"</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>Something<span class="token punctuation">.</span><span class="token function">cool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Something<span class="token punctuation">.</span>greeting<span class="token punctuation">;</span> <span class="token comment">// "Hello World"</span>Something<span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token comment">// 1</span><span class="token keyword">var</span> Another <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token function-variable function">cool</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 隐式地将 `Something` 混入 `Another`</span>  Something<span class="token punctuation">.</span><span class="token function">cool</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>Another<span class="token punctuation">.</span><span class="token function">cool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Another<span class="token punctuation">.</span>greeting<span class="token punctuation">;</span> <span class="token comment">// "Hello World"</span>Another<span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token comment">// 1 (不会和 `Something` 共享状态)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="原型">原型</h3><p><strong>尝试理解原型链</strong></p><p>首先要明确, 虽然人们致力于通过语法糖让程序员像写类一样写 JavaScript的"类"与"继承". 但是, 实际上 JavaScript 的继承是基于原型链的.</p><p>原型是为实现继承而提出的,可以尝试将对象的原型理解成<strong>这个对象是基于什么样子的玩意魔改出来的</strong>.注意, 基于什么<strong>样子的</strong>玩意,不是基于<strong>什么玩意</strong>. 以下面这个继承关系为例</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Father</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>f <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Son</span> <span class="token keyword">extends</span> <span class="token class-name">Father</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最开始, 我以为, 原型就是告诉实例对象,他是基于<strong>什么玩意</strong>构造出来的.</p><p>如果不考虑继承关系, 可以这么想象 <code>Father</code> 与<code>Son</code></p><p><img src="./你不知道的JavaScript学习/2-2.png" /></p><p>有两个独立的框框, 框中, 左边的圆是构造函数, 中间原型,右边是其构造出的实例. 按照刚刚的理解, 原型是一个神秘的<code>object</code>, 当我们要构造函数的时候, 只需要将执行<code>构造函数.apply(原型)</code>, 然后我们就得到了实例, 看起来不错.要是知道原型是什么就好了.</p><p>那, 如果 <code>Son</code> 的原型是 <code>Father</code>的实例会怎么样呢? 不错诶! <code>Son构造函数.apply(father)</code> 得到<code>son</code> 看起来合情合理!</p><p><img src="./你不知道的JavaScript学习/2-3.png" /></p><p>将原型链扩展完. 还是很棒! <code>Father构造函数.apply(&#123;&#125;)</code> 得到<code>father</code> 看起来也合情合理!<code>Object.apply(一个奇怪的东西)</code> 得到 <code>&#123;&#125;</code>看起来也合情合理! 至于这个奇怪的东西, 我们只知道他的<code>__proto__</code> 是 <code>null</code></p><p><img src="./你不知道的JavaScript学习/2-4.png" /></p><p>世界线收束了? 不对劲, 这么我们在直接操作原型呢? 这么一串搞下来,我们直接魔改了 <code>Object</code> 的原型 :(</p><p>实际上不是这样的, 原型是一个对象,他就像一个指路牌一样描述了构造函数(<code>.constructor</code>)是谁,原型链的上一层是谁<code>.__proto__</code>, 这个类上有什么方法.</p><p>看看 <code>Son.prototype</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">constructor</span><span class="token operator">:</span> <span class="token keyword">class</span> <span class="token class-name">Son</span>         <span class="token comment">// 构造函数</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Prototype<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> Object          <span class="token comment">// 原型链上一级</span>    <span class="token literal-property property">constructor</span><span class="token operator">:</span> <span class="token keyword">class</span> <span class="token class-name">Father</span>    <span class="token punctuation">[</span><span class="token punctuation">[</span>Prototype<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> Object<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="./你不知道的JavaScript学习/2-5.png" /></p><p>但是, 对于创建对象来讲, 这足够了! 一旦我拥有了原型对象,我就知道了其构造函数与原型链的前一级, 在创建对象的时候,我递归让上一级帮我创建父类的实例, 然后将哪个实例喂给这一级的构造函数,对象创建成功</p><p><img src="./你不知道的JavaScript学习/2-6.png" /></p><p>这就解释了 <code>Son.prototype.__proto__ === Father.prototyp</code>,原型链即使这条蓝色的链表, 红色的就是其构造的过程:)</p><p>看起来没问题. 但是, 为啥要把类上的方法存储在原型上呢?因为这样所有的子类就访问父类的同一个方法.这与基于类的继承的实现方法不太相同, 但是 JavaScript本身就是基于原型链继承的而不是基于类继承的.</p><p>于是, 这个经典的图就可以理解了. 无非就是加入了<strong>Object&amp;Function 既是函数也是对象</strong> 的想法</p><p><img src="./你不知道的JavaScript学习/2-8.jpg" /></p><p><strong>基于原型链的继承</strong></p><ul><li><p>差异继承</p><p>回想 Java 等基于类继承的语言. 子类在实例化时只会执行父类的构造函数,并不会实例化父类, 父类的属性均会实例化在子类上.</p><p>但是 JavaScript 是基于原型链继承的,构造的过程实际上是一层一层的的调用构造函数并一层一层的构造实例.这意味着在构建子类时父子类实例都会被创建, 继承关系只是在原型上通过<code>__proto__</code> 维护子对象与父对象的关联,子类实例上只维护其与父类的差异. 也称这种继承为差异继承.</p></li><li><p><code>prototype</code> 与屏蔽</p><p>对象的<strong>赋值</strong>会触发 <code>[[Put]]</code> 操作.<code>[[put]]</code> 查找对象失败后会顺着对象的原型链查找标识符,于是产生了一些奇怪的规则.</p><p>假设执行 <code>foo.bar = 1</code>, 且 <code>foo</code> 上没有<code>bar</code></p><ul><li><p>原型链上找到了标识符且标识符 <code>writable: true</code>,<strong>会直接在 <code>foo</code> 上创建 <code>bar</code>, 然后赋值.称其为屏蔽属性</strong>(WTF!!)</p></li><li><p>原型链上找到了标识符且标识符 <code>writable: false</code>,<strong>会静默失效, 在严格模式下会抛出错误</strong></p></li><li><p>原型链上找到了标识符且标识符有 <code>setter</code>, 直接应用<code>setter</code></p></li></ul><p><strong>上面的规则都是针对 <code>=</code> 赋值的, 使用<code>Object.defineProperty()</code>就不会产生这些破玩意</strong></p></li><li><p>什么是所谓的构造函数</p><p>实际上, 构造函数就是普通函数, 构造函数也可以像普通函数一样调用.但是一旦函数前面加上了 <code>new</code>, <code>new</code>会劫持普通函数并将其当作构造函数调用</p></li><li><p>原型上的 <code>constructor</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">C1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>v <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token constant">C2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>v <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">C2</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token class-name">C1</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span><span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">C2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// C1 &#123; v: 2 &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>constructor <span class="token operator">===</span> <span class="token constant">C2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>constructor <span class="token operator">===</span> <span class="token constant">C1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对象上的 <code>constructor</code> 并不是对象的构造者, 因为<code>constructor</code> 是在对象的原型上, <code>constructor</code>原型的构造函数</p></li><li><p>手动原型继承</p><p>这是一些继承方案</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">C1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">C1</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sayC1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'IM C1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token constant">C2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token constant">C1</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将C1的变量定义继承到了C2</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">C2</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">C1</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 👍 将C1的方法继承到C2可行方案1(ES6前)</span><span class="token comment">// Object.setPrototypeOf(C2.prototype, C1.prototype); // 👍 将C1的方法继承到C2可行方案2(ES6)</span><span class="token comment">// C2.prototype = C1.prototype; // 👎错误方案1</span><span class="token comment">// C2.prototype = new C1(); // 👎错误方案2</span><span class="token class-name">C2</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">sayC2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'IM C2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">C2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// C1 &#123; x: 1, y: 2 &#125;</span>c<span class="token punctuation">.</span><span class="token function">sayC1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IM C1</span>c<span class="token punctuation">.</span><span class="token function">sayC2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IM C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>继承变量没得说, 直接 <code>apply()</code> 就行,但是有四个继承方法的方案</p><ul><li><p><code>C2.prototype = Object.create(C1.prototype);</code>这是在ES6之前的方案</p><p><code>Object.create()</code> 方法用于创建一个新对象,并使用参数对象来作为新创建对象的原型</p><p>一个简易的 <code>create</code> 实现</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">function</span> <span class="token constant">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token class-name">F</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> o<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>Object.setPrototypeOf(C2.prototype, C1.prototype);</code>:<code>ES6</code> 新增的解决方案</p></li><li><p><code>C2.prototype = C1.prototype;</code> 会造成修改<code>C2.prototype</code> 时直接修改了 <code>C1.prototyoe</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">C1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">C1</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">say</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'IM C1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token constant">C2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token constant">C1</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将C1的变量定义继承到了C2</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">C2</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token class-name">C1</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span><span class="token class-name">C2</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">say</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'IM C2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> c1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">C1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> c2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">C2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>c1<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IM C2</span>c2<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IM C2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>C2.prototype = new C1();</code> 不推荐这个方法, 原因是</p><ul><li><code>C2</code> 的原型上会有 <code>C1</code> 的变量</li><li>调用 <code>new C1()</code>构造函数可能产生副作用(如修改全局变量)</li></ul><p>如下是两者对比</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token constant">C1</span> <span class="token punctuation">(</span><span class="token class-name">C2</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">C1</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>版<span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span>Prototype<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> Object    <span class="token function-variable function">sayC1</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'IM C1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>    <span class="token literal-property property">constructor</span><span class="token operator">:</span> ƒ <span class="token constant">C1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">[</span><span class="token punctuation">[</span>Prototype<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> Object<span class="token constant">C1</span> <span class="token punctuation">(</span><span class="token class-name">C2</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">C1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>版<span class="token punctuation">)</span>  <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span>Prototype<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> Object    <span class="token function-variable function">sayC1</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'IM C1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>    <span class="token literal-property property">constructor</span><span class="token operator">:</span> ƒ <span class="token constant">C1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">[</span><span class="token punctuation">[</span>Prototype<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> Object<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><p><strong>对象关联</strong></p><p>通过继承可以让两个对象关联起来. 如果只是想实现跨对象调用方法,这就显得比较麻烦了(因为要维护 <code>constructor/__proto__</code>),我们可以利用 <code>Object.create()</code> 实现两个对象的关联.实现关联后最好不要使用外部委托的调用模式, 即</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token function">sayF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> bar <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>bar<span class="token punctuation">.</span><span class="token function">sayF</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 外部委托</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而是采用内部委托</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token function">sayF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> bar <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>bar<span class="token punctuation">.</span><span class="token function-variable function">doSayF</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sayF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 内部委托</span><span class="token punctuation">&#125;</span>bar<span class="token punctuation">.</span><span class="token function">doSayF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样可以提高代码可读性与安全性</p><h3 id="面向委托与面向对象的设计">面向委托与面向对象的设计</h3><ul><li><p>传统的OOP编程:鼓励在继承时使用方法重写(和多态)覆盖父类更加抽象的方法</p></li><li><p>委托编程: 要求将两个对象当作协作的兄弟,当某个对象上没有方法时会要求另一个对象帮忙实现,此外委托编程还有一些特点</p><ul><li>变量直接存储在委托上: 因为被委托者只是将原型上的属性连接到了委托者,不会带被委托者的属性</li><li>被委托者方法创建的变量会直接存在委托者上: 调用时候一般是<code>委托者.方法()</code>, 此时 <code>this</code>被隐式绑定在了委托者上</li><li>不鼓励重写方法, 鼓励在委托者身上定义更加具有描述性的方法名:JavaScript 的原型链<code>[[put]]</code> 机制让重写很麻烦</li><li>不关注类与类之间的层次关系而是关心对象与对象之间的相互借用关系(拿来吧你🖐)</li><li>不得循环委托</li></ul><p><strong>反类化</strong></p><p>有的时候, 我们不需要类, 只是需要类上的方法,此时我们可以在用委托机制在不实例化父类的情况下使用类上的方法</p><p><strong>内省</strong></p><p>检查一个对象是不是一个构造函数的实例</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">/*...*/</span><span class="token punctuation">&#125;</span><span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype<span class="token operator">...</span><span class="token keyword">function</span> <span class="token function">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">/*...*/</span><span class="token punctuation">&#125;</span><span class="token class-name">Bar</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> b1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token string">"b1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 让Foo和Bar互相关联</span><span class="token class-name">Bar</span><span class="token punctuation">.</span>prototype <span class="token keyword">instanceof</span> <span class="token class-name">Foo</span><span class="token punctuation">;</span><span class="token comment">// true</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token class-name">Bar</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span> <span class="token comment">//true</span><span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span><span class="token class-name">Bar</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// true</span><span class="token comment">// 让b1关联到Foo和Bar</span>b1 <span class="token keyword">instanceof</span> <span class="token class-name">Foo</span><span class="token punctuation">;</span><span class="token comment">// true</span>b1 <span class="token keyword">instanceof</span> <span class="token class-name">Bar</span><span class="token punctuation">;</span><span class="token comment">// true</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>b1<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token class-name">Bar</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span> <span class="token comment">//true</span>Foo<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>b1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// true</span>Bar<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>b1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>还有一种更加脆弱的内省模式，但是在开发者上面用的很多</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span><span class="token punctuation">(</span>a1<span class="token punctuation">.</span>something<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> a1<span class="token punctuation">.</span><span class="token function">somethinf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="利用原型链的有趣写法">利用原型链的有趣写法</h3><h3 id="es6-的-class-语法"><code>ES6</code> 的 <code>class</code>语法</h3><p><strong>优点</strong>:</p><ul><li>通过 <code>supper</code> 基本杜绝了 <code>prototype</code>,并实现了多态</li><li>简洁的继承定义</li><li>不能声明属性, 只能声明方法</li></ul><p><strong>缺点</strong></p><ul><li><p>反词法</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> LoginController <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">errors</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 无需function</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>这是个语法糖, 编译后变为</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> AuthController <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">errors</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token function-variable function">getUser</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>编译后 <code>getUser</code> 引用了一个匿名函数, 这意味着</p><ol type="1"><li>使调试时的栈追踪变得困难</li><li>使自引用（递归，事件绑定等）变得困难</li><li>使代码（稍稍）变得难于理解</li></ol></li><li><p>存在变量名与方法名之间的屏蔽, <code>supper</code>造成的隐式屏蔽</p></li><li><p>可以通过修改 <code>prototype</code> 的方法在 <code>class</code>定义后修改 <code>class</code> 定义</p></li></ul><h2 id="类型与语法">类型与语法</h2><h3 id="类型">类型</h3><p>JavaScript 是有类的, 但是 JavaScript 是一个动态若类型语言,我们没法说变量属于什么类型, 只能说变量对应的值是什么类型的.</p><p>内置类型有<code>null, undefined, boolean, number, string, object, symbol</code>,可以用 <code>typeof</code> 判断值的类型</p><p><code>typeof</code> 判断类型是存在部分特例</p><ul><li><p><code>typeof null === 'object'</code>, 这是 JavaScript 的一个小bug. 若确实需要检测 <code>null</code> 可以使用<code>!foo &amp;&amp; typeof foo === 'object'</code> 判定</p></li><li><p><code>typeof function () &#123;&#125; === 'function'</code>, 虽然函数是<code>Object</code> 的子类, 但是 <code>typeof</code>会特殊的返回<code>function</code> 而不是 <code>object</code>. 同时,函数的 <code>length</code> 是其形参的数量,形参的数量不包括剩余参数个数，仅包括第一个具有默认值之前的参数个数。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// fun1.length = 1</span><span class="token keyword">function</span> <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// fun2.length = 2</span><span class="token keyword">function</span> <span class="token function">fun3</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// fun3.length = 3</span><span class="token keyword">function</span> <span class="token function">fun4</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// fun4.length = 3</span><span class="token keyword">function</span> <span class="token function">fun5</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// fun5.length = 0</span><span class="token keyword">function</span> <span class="token function">fun6</span><span class="token punctuation">(</span><span class="token parameter">a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// fun6.length = 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>typeof 未定义值 === 'undefined'</code></p></li></ul><p><strong><code>undefined</code> 与<code>undeclared</code></strong></p><ul><li>当我们访问一个已定义但是没有赋值的变量时, 会返回<code>undefined</code></li><li>当我们返回一个没有定义的(undeclared) 值时,<ul><li>若在是访问对象上的标识符, 会返回 <code>undefined</code>, (对象上<code>[[Get]]</code> 的保护机制)</li><li>否则抛出 <code>ReferenceError</code></li></ul></li></ul><p>但是 <code>typeof</code> 的保护机制会让 <code>undefined</code> 与<code>undeclared</code> 均返回 <code>undefined</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> a<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这种保护机制可以让我们轻松的判断全局作用域上是否有某个属性, 方便外部JavaScript 模块加载时检测全局环境, 实现选择性加载</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> foo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong><code>void</code>关键字</strong></p><p><code>void</code> 表达式永远返回 <code>undefined</code> 值, 例如</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong><code>undefined</code> 与 <code>null</code></strong></p><p>一般用 <code>null</code> 表示空值, 用 <code>undefined</code>表示没有值.</p><p>比较特殊的是: <strong><code>null</code> 是一个关键字, 但是<code>undefined</code> 只是一个标识符, 他的值默认为undefined</strong>,所以以下代码是成立的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">const</span> demo <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>demo<span class="token punctuation">.</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>demo<span class="token punctuation">.</span>t <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false, 因为 undefined 标识符对应的不是 undefined 值</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>demo<span class="token punctuation">.</span>t <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true, 因为 void 0 返回的是 undefined 值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="值">值</h3><ul><li><p>数组</p><ul><li><p>删除元素:<code>delete a[1] / a.splice(1,1);</code>伪数组转数组</p><p>常见的伪数组有 <code>DOMList</code>, <code>arguments</code>,伪数组没有数组上的部分方法, 转换方法为(假设<code>foo -&gt; bar</code>)</p><ul><li>遍历伪数组元素</li><li><code>bar = Array.prototype.slice.call(foo);</code></li><li><code>bar = Array.from(foo);</code></li><li><code>bar = [...foo];</code></li></ul></li></ul></li><li><p>字符串</p><p>字符串不是字符数组, 两者身上的方法有差异</p><ul><li><p>字符串不可变</p><ul><li><p>字符串的值不可被外部修改</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token string">'123'</span><span class="token punctuation">;</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '123'</span><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token string">'123'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'0'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ['1', '0', '3']</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>字符串上的方法不得修改字符串的值(换而言之,调用字符串的方法只会返回新值, 而不会修改字符串原值)</p></li></ul></li><li><p>字符串可以使用部分字符数组的方法:</p><ul><li><p>字符串可以通过 <code>Array</code> 原型方法访问<code>Array.prototype.reverse.call(s)</code></p></li><li><p>若访问的方法会修改原字符串, 那么该方法将无法调用</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token string">'123'</span><span class="token punctuation">;</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TypeError: Cannot assign to read only property '0' of object '[object String]'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>可以先将字符串转换为数组在调用方法最后转回</p></li></ul></li></ul></li><li><p>数字</p><p>JavaScript 只有数字一个类型, 没有所谓整数小数之分. 数字全部使用 IEEE754 的 64 位版本实现</p><ul><li><p>简写规则</p><p>在书写字面量时, 可以省略前导与后继 <code>0</code>, 例如<code>0.12 === .12</code>, <code>12.0 === 12.</code></p><p>受简写规则影响, 部分方法调用是无效的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 👍 有效</span><span class="token number">0.12</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 👍 有效, 第二个点不可能是小数点</span><span class="token number">12.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 👎 无效, JS会其为 (12.)toFixed</span><span class="token number">12.</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 👍 有效, 第一个点是简写, 第二个点是链式调用</span><span class="token number">12</span> <span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 👍 有效, 注意数字与点之间有空格</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>格式化方法</p><ul><li><p><code>toFixed</code> 指定小数位数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42.59</span><span class="token punctuation">;</span>a<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "43"</span>a<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "42.6"</span>a<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "42.59"</span>a<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "42.590</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>toPrecision</code> 指定有效位数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">42.59</span><span class="token punctuation">;</span>a<span class="token punctuation">.</span><span class="token function">toPrecision</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "4e+1"</span>a<span class="token punctuation">.</span><span class="token function">toPrecision</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "43"</span>a<span class="token punctuation">.</span><span class="token function">toPrecision</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "42.6"</span>a<span class="token punctuation">.</span><span class="token function">toPrecision</span><span class="token punctuation">(</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "42.59"</span>a<span class="token punctuation">.</span><span class="token function">toPrecision</span><span class="token punctuation">(</span> <span class="token number">5</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "42.590"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p>运算误差: JavaScript 自带 <code>Number.EPSILON</code>作为运算误差, 这个值一般为 <spanclass="math inline">\(2^{-52}-1\)</span></p></li><li><p>整数检测: <code>Number.isInteger / Number.isSafeInteger</code>可分别用于整数, 安全整数检测</p></li><li><p>参与位运算: 虽然 IEEE 754 允许最大安全整数为 <spanclass="math inline">\(2^{53}-1\)</span>, 但是, 在执行位运算时, 只有后 32位数会参与运算, 其余位将被忽略. 借助此特性, 可以通过 <code>a | 0</code>将 <code>a</code> 转为 32 位整数</p></li><li><p><code>NaN</code>: <code>NaN</code> 是一个数值类型, 但不是数字.当出现 Number 运算结果无法返回数字时就会返回 <code>NaN</code>. 所以,<code>NaN</code> 可以用来提示数值运算出错</p><p><code>NaN !== NaN</code>, 这是 JavaScript 唯一自己与自己不等的元素.判断 <code>NaN</code> 可以采用以下方法</p><ul><li><code>Number.isNaN(a)</code>: 利用 ES6 的新方法判断 <code>a</code>是不是 <code>NaN</code></li><li><code>a !== a;</code>: 反向利用其反自反的特性判断 <code>a</code>是不是 <code>NaN</code></li><li><code>Object.is(NaN, a)</code>: 利用新方法判断 <code>a</code> 是不是<code>NaN</code> (后面解释实现)</li></ul></li><li><p><code>0 &amp; -0</code></p><p>部分场景需要使用负号表示方向, JavaScript 中有 <code>0</code> 与<code>-0</code>.</p><ul><li><p><code>-0 === 0</code></p></li><li><p>可以通过字面量, 非加减的表达式, 类型转换产生<code>-0</code></p></li><li><p><code>-0</code> 转为字符串后会失去负号</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p><code>'-0'</code> 字符串转为非字符串时会保留负号</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token string">'-0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token string">'-0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'-0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>判定 <code>-0</code></p><ul><li><p>手动实现方法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">isNegZero</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> v <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token number">1</span> <span class="token operator">/</span> v <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">Infinity</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>Object.is(-0, a)</code>: 利用新方法判断 <code>a</code>是不是 <code>-0</code></p><p>这个 <code>is</code> 方法看起来很神奇, 其实就是特判了<code>NaN</code> 与 <code>-0</code> 的 <code>===</code></p></li></ul></li></ul></li><li><p><code>Infinity</code></p><p>设有限正数 <code>a</code></p><ul><li>与有限数加减法: <code>Infinity (+/-) a === Infinity</code></li><li>与 <code>Infinity</code> 加减法:<code>Infinity - Infinity === NaN</code>,<code>Infinity - -Infinity === Infinity</code></li><li>与有限非0数乘除法: <code>Infinity (*//) a === Infinity</code>,<code>Infinity (*//) -a === -Infinity</code></li><li>与0乘除法: <code>a/0 === Infinity</code>,<code>-a/0 === -Infinity</code>, <code>Infinity / 0 === Infinity</code>,<code>Infinity * 0 = NaN</code>,</li><li>与 <code>Infinity</code> 乘除法:<code>Infinity * Infinity === Infinity</code>,<code>Infinity / Infinity === NaN</code></li></ul></li></ul></li></ul><h3 id="原生函数">原生函数</h3><p>在写 TS 时会遇到一个问题, 描述类型的时候应该用小写(如:<code>string</code>), 而不能用大写(如: <code>String</code>),因为大写的是构造函数.</p><p>JavaScript 内建的函数(原生函数)有:<code>String, Number, Boolean, Array, Object, Function, RegExp, Date, Error, Symbol</code>.</p><p><strong>封装</strong></p><ul><li><p>对于基本类型非 <code>Object</code>类型(<code>String, Number, Boolean, Symbol</code>)的值</p><p>基本类型值与通过构造函数创建的值不同.通过构造函数创建的值是一个对象</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> s1 <span class="token operator">=</span> <span class="token string">'aaa'</span><span class="token punctuation">;</span><span class="token keyword">const</span> s2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// aaa</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [String: 'aaa']</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1 <span class="token operator">===</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同时对象永远为 <code>true</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> b1 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token keyword">const</span> b2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Boolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>b1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>b2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b1 <span class="token operator">===</span> b2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b1 <span class="token operator">==</span> b2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看起来基本类型值与对象还是有区别的, 对象中封装了基本类型值.基本类型值本身只是一个基本类型值, 上面没有方法(如:<code>s.length</code>),但是当基本类型值要访问其对应原生函数对象上的方法时, <strong>JavaScript会自动将基本类型值封装为对象</strong>. 封装为对象当然要耗费时间,但是<strong>不要为此故意将字面量声明为对象</strong>, JavaScript引擎会对代码做性能调优并决定在什么时候封装对象.</p></li><li><p>对于基本类型为 <code>Object</code>类型(<code>Array, Object, Function, RegExp, Date, Error</code>)的值</p><p>使用字面量创建(如果可以)与使用函数创建是完全一样的</p><ul><li><p><code>Array</code></p><ul><li><p>创建 <code>Array</code> 时可以不带 <code>new</code></p></li><li><p>通过 <code>Array(n)</code> 可以创建包含 <code>n</code>个空值(<code>empty item</code>)的数组</p></li><li><p>直接改大数组的 <code>length</code> 会导致产生空值</p></li><li><p>空值不是 <code>undefined</code>, 不同函数对空值与<code>undefined</code> 的处理不同 <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">]</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ &lt;3 empty items> ]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 0, 1, 2 ]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p><code>join</code> 不考虑空值的存在, 直接通过 <code>arr.length</code>遍历每个元素. 而 <code>map</code> 在处理空值时会直接跳过空值</p><p>应此, <code>Array(n)</code> 创建的空值数组是危险的, 可以使用<code>Array.apply(null, &#123; length: n &#125;)</code> 创建长度为 <code>n</code>的 <code>[undefined...]</code> 数组</p></li></ul></li><li><p><code>Object, Function, RegExp</code></p><ul><li>不建议使用构造函数构造这些对象,可以直接使用<code>&#123;&#125;, function, //</code> 构建</li><li>对于需要修改的正则表达式可以使用 <code>RegExp</code> 构建(但是<code>RegExp</code> 的效率不及 <code>//</code>)</li></ul></li><li><p><code>Date, Error</code></p><ul><li>无法用字面量创建这些值</li><li><code>new Date()</code> 不带参数默认使用当前时间</li><li>不带 <code>new</code> 的 <code>Date()</code> 无论参数如何,都返回日期字符串</li><li>若只是想获得当前时间戳可以使用静态方法 <code>Date.now()</code></li><li>创建 <code>Error</code> 时可以不带 <code>new</code></li></ul></li></ul></li><li><p>封装对象的 <code>[[class]]</code>: 所有 <code>typeof</code> 返回<code>object</code> 的变量上面都有一个 <code>[[class]]</code>,表示对象的"子类型"</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Boolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//...</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [object Number]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [object Boolean]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [object Array]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>拆封</strong></p><p>可以使用 <code>obj.valueof()</code> 获取对象封装的值</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Boolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// aaa</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1, 2, 3]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="强制类型转换">强制类型转换</h3><p>JavaScript 强制类型转换只支持转化为基本类型值</p><p><strong>抽象值操作</strong></p><p>抽象类型函数是类型中内置的一些个怪方法, 在类型转换时 JavaScript会调用这些函数实现对应类型转换</p><ul><li><p><code>ToString</code> 转换为 <code>String</code></p><ul><li><p>普通对象: 对象的 <code>toString</code> 默认返回对象的<code>[[class]]</code> 值</p></li><li><p>数组: <code>Array</code> 的 <code>toString</code> 被重新定义过,等价于 <code>return this.join(',')</code>, 注意: 没有<code>[]</code></p></li><li><p>JSON对象:</p><ul><li><p><code>JSON.stringify</code></p><p><code>JSON.stringify(value[, replacer [, space]])</code>有两个可选参数</p><ul><li><p><code>replacer</code> 若是函数, 每个属性都会经过该函数的转换,若是一个数组，则只有包含在这个数组中的属性名才会被转换, 若是<code>null</code> 或者未提供，则对象所有的属性都会被序列化.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> unSafe <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>  <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// &#123;"a":1,"c":[1,3,null]&#125;</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>unSafe<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">k<span class="token punctuation">,</span> v</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>k <span class="token operator">===</span> <span class="token string">'b'</span> <span class="token operator">||</span> k <span class="token operator">===</span> <span class="token string">'2'</span> <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>space</code>: 若为数字则为每级缩进指定字符, 若为字符串,则将字符串前<strong>十</strong>位作为缩进字符串</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// &#123;</span><span class="token comment">//   "a": 1,</span><span class="token comment">//   "c": [</span><span class="token comment">//     1,</span><span class="token comment">//     3,</span><span class="token comment">//     4</span><span class="token comment">//   ]</span><span class="token comment">// &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// &#123;</span><span class="token comment">// 123"a": 1,</span><span class="token comment">// 123"c": [</span><span class="token comment">// 1231231,</span><span class="token comment">// 1231233,</span><span class="token comment">// 1231234</span><span class="token comment">// 123]</span><span class="token comment">// &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'1234567890-='</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// &#123;</span><span class="token comment">// 1234567890"a": 1,</span><span class="token comment">// 1234567890"c": [</span><span class="token comment">// 123456789012345678901,</span><span class="token comment">// 123456789012345678903,</span><span class="token comment">// 123456789012345678904</span><span class="token comment">// 1234567890]</span><span class="token comment">// &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p><code>toJSON</code></p><p>在 <code>stringify</code> 时, 若对象中存在非 JSON安全值(<code>undefined / function / symbol / 循环引用</code>)会忽略或报错,若忽略值在数组中则会采用 <code>null</code> 代替</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  <span class="token literal-property property">norm</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token comment">// 正常</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token comment">// 跳过</span>  <span class="token function-variable function">b</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 跳过</span>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 跳过</span>  <span class="token literal-property property">d</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 正常</span>    <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token comment">// null</span>    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">//null</span>    <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// null</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token literal-property property">e</span><span class="token operator">:</span> t<span class="token punctuation">,</span> <span class="token comment">// 报错</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了让调用者可以自定义非 JSON 安全值的转换行为,<code>JSON.stringify</code> 实际进行了几个过程,先执行<code>replacer</code>, 再执行对象的 <code>toJSON</code> 方法,再对返回值的 <code>toString</code></p><p>对象的 <code>toJSON</code> 方法应该返回一个 JSON 安全的对象方便<code>toString</code> 调用. 该函数只会调用一次, 并且没有参数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> unSafe <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>  <span class="token function-variable function">b</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token string">'UNDEFINED'</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token string">'FUNCTION'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>unSafe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123;"a":"UNDEFINED","b":"FUNCTION","c":1&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul></li><li><p><code>toNumber</code> 转换为 <code>Number</code></p><ul><li><p>特殊的:<code>true =&gt; 1, false =&gt; 0, undefined =&gt; NaN, null =&gt; 0</code></p></li><li><p>字符串</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 12, 10进制</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token string">'012'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 12, 忽略8进制</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token string">'0x12'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 18, 接受16进制</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token string">'0b111'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 7, 接受2进制</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token string">'0b121'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// NaN, 出现非法字符返回NaN</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token string">'1a2b3c4'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// NaN, 出现非法字符返回NaN</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>对象 / 数组 / 基本类型封装对象:</p><ul><li>对于基本类型封装的对象, 直接提取基本类型.若转换后非数值则在转换为数字.</li><li>对于其他对象, 若对象定义了 <code>valueOf</code> 函数则使用<code>valueOf</code> 函数转换, 否则使用 <code>toString</code> 转换.若转换后非数值则在转换为数字.</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token function-variable function">valueOf</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token string">"42"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token function-variable function">toString</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token string">"42"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>c<span class="token punctuation">.</span><span class="token function-variable function">toString</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span> <span class="token string">""</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// "42"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">Number</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 42</span><span class="token function">Number</span><span class="token punctuation">(</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 42</span><span class="token function">Number</span><span class="token punctuation">(</span> c <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 42</span><span class="token function">Number</span><span class="token punctuation">(</span> <span class="token string">""</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 0</span><span class="token function">Number</span><span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 0</span><span class="token function">Number</span><span class="token punctuation">(</span> <span class="token punctuation">[</span> <span class="token string">"abc"</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// NaN</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p><code>toBoolean</code> 转换为 <code>Boolean</code></p><p>规定假值: <code>undefined</code>, <code>null</code>,<code>false</code>, <code>+0 / -0 / NaN</code>, <code>''</code>,其他都是真值 部分被废弃 / 非标准的 JavaScript 也会被标记为<code>false</code> (例如 <code>document.all</code> 已经被废弃,在老版浏览器中依然存在 <code>!!document.all === true</code>,在新版浏览器中为 <code>!!document.all === true</code>,这可以用于浏览器版本判定)</p></li></ul><p><strong>强制类型转换</strong></p><ul><li><p><code>String &amp; Number</code></p><ul><li><p><code>+var</code> 可以实现 <code>String</code> 到<code>Number</code></p></li><li><p><code>~~var</code> 可以实现将值按位反转再翻回来从而实现小数转 32位整数.</p><p>与 <code>floor / cell</code> 不同, 上述函数会做向上或下取整, 但是<code>~~</code> 会直接去尾</p><p>同时 <code>~</code> 相当于取反码, <code>-1</code> 的反码为<code>0</code>. 而 <code>-1</code> 经常被用作错误标记(如<code>indexof</code>). 所以, 所以经常用于判断值是否为<code>-1</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token string">'asdfghjkl'</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">~</span>s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'f'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'find it'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">else</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'not find  f'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p><code>Number &amp; parseInt</code>: <code>Number</code>构造函数可以读入纯数字的字符串并返回 <code>Number</code> 包装对象. 而<code>parseInt</code> 读入字符串并解析数字直到遇到非数字停止.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token string">'42'</span><span class="token punctuation">;</span><span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token string">'42px'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// NaN</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果不指定进制, <code>parseInt</code> 的行为也不一样</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'0x10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 16 自动识别 16 进制</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'0b10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 自动识别 2 进制</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'010'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10 不识别 8 进制</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>同时, 两函数在遇到非字符串输入时会先转换为 <code>String</code>在转换</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">toString</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">'42px'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">toString</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">'42'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// NaN</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>obj1<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>obj2<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这种转换会带来一些"半隐式"的转换问题</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 18 ( Infinity 会被转换为 'Infinity', 'I' 在 19 进制中是 18)</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token number">0.000008</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 (这个数会被转换为 '0.000008')</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token number">0.0000008</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 8 (这个数会被转换为 '8e-7')</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 250 (会被转换为 'false', 'fa' 都是 16 进制数)</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>parseInt<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 15  (会被转换为 'function..', 'f' 是 16 进制数 )</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>+</code> 二元加法造成的类型转换:若加法两边有字符串就将两边转换为字符串(与直接转字符串不同, 流程是先<code>toValue</code> 再 <code>toString</code> )执行字符串拼接,否则先转换为 <code>Number</code> 再执行数值相加.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">valueOf</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token function-variable function">toString</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">'42'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42: 直接 toString = '42'</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4: 先 valueOf = 4 然后 toString = '4'</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5: valueOf = 4, 4 + 1 = 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>true =&gt; 1, false =&gt; 0</code></p></li></ul></li><li><p><code>Boolean</code></p><ul><li><p><code>!!</code> 可以用于转换类型为 <code>Boolean</code></p></li><li><p><code>if / for / while / do...while / ?:</code> 表达式会自动转换<code>Boolean</code></p></li><li><p><code>|| / &amp;&amp;</code>的<strong>左</strong>操作数在作条件判断时会自动转换.这两个逻辑运算符的返回值并不一定是 <code>Boolean</code>而是根据短路原则直接返回第一或第二个元素</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">||</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a 转为 false, 直接返回 b</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b <span class="token operator">||</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// b 转为 true, 直接返回 b</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a 转为 false, 直接返回 a</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// b 转为 true, 直接返回 a</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><p><strong><code>==</code> 类型转换</strong></p><p><code>===</code> 是不进行类型转换的相等, 不可能产生类型转换,类型转换只会发生在 <code>==</code></p><ul><li><p>特殊情况: <code>NaN != NaN</code>, <code>-0 == 0</code></p></li><li><p><code>String == Number</code>: 将 <code>string</code> 转为<code>toNumber(string)</code> 后比较</p></li><li><p><code>Boolean == *</code>: 将 <code>boolean</code> 转为<code>toNumber(boolean)</code> 后比较</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">"0"</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token string">"0"</span> <span class="token operator">==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token string">"0"</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token string">"0"</span> <span class="token operator">==</span> <span class="token number">NaN</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token string">"0"</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// true</span><span class="token string">"0"</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token number">NaN</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token string">""</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token string">""</span> <span class="token operator">==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token string">""</span> <span class="token operator">==</span> <span class="token number">NaN</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token string">""</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token string">""</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token string">""</span> <span class="token operator">==</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token number">NaN</span><span class="token punctuation">;</span><span class="token comment">// false</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>undefined == null</code></p></li><li><p>对象与非对象: 将对象转为基本类型值再比较. 以下是怪情况</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Number</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">valueOf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">new</span> <span class="token class-name">Number</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token class-name">Number</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">valueOf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Number</span><span class="token punctuation">(</span> <span class="token number">42</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"Yep, this happened."</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>奇葩情况</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// true, 右侧 ![] => false, [] => '' => false</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">null</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true, '\n' / '' / 各种unicode空格 => 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">"0"</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token boolean">false</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token string">""</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token string">""</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// true -- 噢！</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>总之, <code>==</code> 两边不要写 <code>true / false</code>, 避免使用<code>[], '', 0</code></p></li><li><p>各种情况比较表: <ahref="dorey/JavaScript-Equality-Table">dorey/JavaScript-Equality-Table</a></p><p><img src="./你不知道的JavaScript学习/3-1.png" /></p></li></ul><p><strong>比较符</strong></p><p>JavaScript 只定义了 <code>&lt;</code>. <code>a &gt; b</code>会被自动转为 <code>b &lt; a</code>, <code>a &lt;= b</code> 会被转换为<code>!(b &lt; a)</code>.</p><p>在比较时, 双方会先转换为基本数值类型再比较</p><h3 id="语法">语法</h3><p><strong>结果值</strong></p><p>在 DevTools 中, 在输入语句后即使没有 <code>Console</code> 语句,DevTool 也会输出一个结果, 这里显示的是语句的结果值.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">></span> <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;</span> <span class="token keyword">undefined</span><span class="token operator">></span> a<span class="token operator">&lt;</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在正常代码中, 如果一个语句中只有 <code>a</code>, JavaScript是不会输出结果的, 但是 DevTool 会输出这个语句的结果值</p><ul><li><p>声明语句 <code>let a = 1</code> 有结果值, 但是会被JavaScript引擎屏蔽, 最终显示 <code>undefined</code></p></li><li><p>赋值语句 <code>a = b</code> 的结果值为赋的值(但是不是<code>a</code> ! 只是 <code>a</code> 对应的右值!)</p><p>由于赋值语句的结果值是赋的右值, 可以借助这个特性实现链式赋值</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">a <span class="token operator">=</span> b <span class="token operator">=</span> c <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>值得注意的是, 声明语句的结果值被屏蔽为了 <code>undefined</code>.所以, 不能链式声明</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> a <span class="token operator">=</span> b <span class="token operator">=</span> c <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// 👎 静默失效</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>代码块 <code>&#123;&#125;</code> 的结果值是代码块的最后一个语句 /表达式</p></li></ul><p>在编程中, 可以使用 <code>eval</code> 获取结果值(但是不建议),未来可能可以通过 <code>do</code> 获取结果值</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>a <span class="token operator">=</span> <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    b <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>表达式的结果是右值</strong></p><p>表达式的结果值是右值, 这就意味着这样的写法是非法的</p><ul><li><code>++a++</code>: 相当于 <code>++(a++)</code>, 而 <code>a++</code>返回的是右值, 无法对右值做 <code>++</code></li><li><code>(a || b) = 1</code>: <code>||</code> 是选择符号,看起来的意思是若 <code>a</code> 是假值则执行 <code>b = 1</code> 否则<code>a=1</code>. 但是 <code>(a || b)</code> 返回的是右值</li></ul><p><strong>多重语法</strong></p><ul><li><p><code>&#123;&#125;</code>: 可以是对象也可以是代码快, 这就导致了</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// 结果值: "[Obejct Obejct]" (&#123;&#125; 前有 +, 所以&#123;&#125;是一个对象)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 结果值: 0 (&#123;&#125;前啥也没有, 所以是个代码块, 其等价于 +[], 格式转换为 0)</span>a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// a == "[Obejct Obejct]" (&#123;&#125; 前有 +, 所以&#123;&#125;是一个对象)</span>b <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// b == [Obejct Obejct]" (&#123;&#125; 前有 =, 所以&#123;&#125;是一个对象)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>同时, 代码块内属性的含义也变了</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 此时是一个对象</span>a <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">// 对象中的一个属性</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 此时是一个简单的代码块</span><span class="token punctuation">&#123;</span>  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">// 代码快中的标签</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>标签(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvU3RhdGVtZW50cy9sYWJlbA==">MDN<i class="fa fa-external-link-alt"></i></span>)类似于C 语言中 <code>goto</code> 的 label, 与之不同的是 JavaScript 中没有<code>goto</code>, 只能通过 <code>continue / break</code> 跳转,同时不能对非循环的块代码执行 <code>continue</code></p><p>同时注意, 标签名前后不能有双引号, 即</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"foo"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>是不合法的(震惊 JavaScript 竟然不完美兼容 JSON!)</p></li></ul><p><strong>优先级与结合性</strong></p><ul><li>优先级: <code>! &gt; &amp;&amp; &gt; || ?:</code> (<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvT3BlcmF0b3JzL09wZXJhdG9yX1ByZWNlZGVuY2UjJUU2JUIxJTg3JUU2JTgwJUJCJUU4JUExJUE4">详见MDN<i class="fa fa-external-link-alt"></i></span>)</li><li>结合性: <code>?:</code> 是右结合的 (<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvT3BlcmF0b3JzL09wZXJhdG9yX1ByZWNlZGVuY2UjJUU2JUIxJTg3JUU2JTgwJUJCJUU4JUExJUE4">详见MDN<i class="fa fa-external-link-alt"></i></span>)</li></ul><p><strong>自动分号(ASI)</strong></p><p>JavaScript 会自动在行末加 <code>;</code>,这可以防止很多不经意间造成的问题</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">do</span><span class="token punctuation">&#123;</span>    <span class="token comment">// ...</span><span class="token punctuation">&#125;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里在语法中必须加 ; 得益于 ASI, 程序员可以不用加</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>暂时性死区</strong></p><p>就是在变量声明前使用变量(针对 <code>let</code>, <code>var</code>有声明提升不会出事). 提前使用会造成 <code>Reference Error</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 啥事没有</span>b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span><span class="token keyword">let</span> b<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>还有个小例外</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined, 没有报错!</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError</span><span class="token keyword">let</span> b<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>函数参数</strong></p><p>在非严格模式下函数参数列表中标识符会与 <code>arguments</code>变量建立"连接"关系</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 只修改了 a , 但是 arguments[0] 连接到了 a, 所以依然被修改了...</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2,2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>无需考虑函数默认值问题, 启用默认值会自动启用函数严格模式</p><p><strong>try...finally</strong></p><p><code>finally</code>块包含的语句在<code>try</code>块和<code>catch</code>之后,无论 <code>try</code> 是否抛出异常 <code>finally</code> 子句都会执行.这里的 <code>finally</code> 就像一个回调一样, 执行顺序为<code>try -&gt; (catch) -&gt; finally -&gt; 函数的正常功能</code></p><ul><li><p>当 <code>try</code> 中出现 <code>return</code> 时</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 虽然 try return 了, 但是由于 finally 的存在, return 会被"暂存" 到finall 结束</span>  <span class="token punctuation">&#125;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>当 <code>try / catch &amp; finally</code> 中出现<code>return</code> 时</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// finally 的 return 会覆盖 try 的</span>  <span class="token punctuation">&#125;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// console => 0, 1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">throw</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// finally 的 return 会覆盖 catch 的</span>  <span class="token punctuation">&#125;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// console => 0, 1, 2</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>该规则同样适用于 <code>continue</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">continue</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 0, 1, 2, 3, 4, 5(没有*)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>最迷惑的是与 <code>break</code> 一起使用</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">lab</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">break</span> lab<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>switch</strong></p><ul><li><p>最简形式: <code>case</code> 接一个值, JavaScript 会将<code>a</code> 与 case 值做 <code>===</code> 比较</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">a <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token comment">// a == 1 成立, 但是 a === 1 不成立</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token keyword">case</span> <span class="token boolean">true</span><span class="token operator">:</span> <span class="token comment">// 走这里了</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>如果像做一些类型转换, 可以将 <code>switch</code> 的值换成<code>true</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">a <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">case</span> a <span class="token operator">==</span> <span class="token number">1</span><span class="token operator">:</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 走这里了</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token keyword">case</span> a <span class="token operator">==</span> <span class="token boolean">true</span><span class="token operator">:</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>如果要用 <code>switch (true)</code> 的写法的话, 需要保证计算<code>case</code> 的计算结果一定是 <code>true</code> 而不是可以转换为<code>true</code>, <code>switch</code> 做的是 <code>===</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">a <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>s <span class="token operator">=</span> <span class="token string">'demo'</span><span class="token punctuation">;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">case</span> a <span class="token operator">&amp;&amp;</span> s<span class="token operator">:</span> <span class="token comment">// &amp;&amp; 返回 b 而 b !== true</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token keyword">default</span><span class="token operator">:</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 走这里了</span>    <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="异步">异步</h2><h3 id="异步-1">异步</h3><p><strong>控制台异步</strong></p><p>实际上 <code>console.*</code> 系列函数并不是 ES 标准语法,其是由宿主环境决定的. 而宿主环境经常会为降低 I/O 开销而延迟输出, 这种I/O 异步的策略会造成输出"出错"</p><p><strong>程序执行时机</strong></p><p>JavaScript 中的代码是分块的(如一个个函数),我们希望可以干预函数执行的顺序与时机(如 Ajax 请求成功后再执行某个函数,先执行别的函数等一会儿再执行某个函数), 有两种常见方法</p><ul><li>回调函数</li><li><code>setTimeout</code> 等异步API</li></ul><p><strong>调用栈, 事件循环与任务队列</strong></p><p>JavaScript 是一个单线程的异步编程语言,让一个单线程的语言实现多任务异步是有点麻烦的. JavaScript搞了事件循环机制, 包括了调用栈, 任务队列, 事件循环</p><ul><li><p>调用栈(Call Stack): 存档代码执行时的 ConText(如函数嵌套)</p></li><li><p>事件循环: 每当调用栈清空(当前工作结束)时,事件循环会向任务队列首部取任务, 放调用栈执行</p></li><li><p>任务队列: 当有异步任务需要执行(如:定时器<strong>到期</strong>)时, JavaScript 会向任务队列中压入任务.任务队列又分宏队列与微队列, 不同的任务会放入不同的队列</p><p>宏队列</p><table><colgroup><col style="width: 83%" /><col style="width: 9%" /><col style="width: 6%" /></colgroup><thead><tr class="header"><th></th><th>浏览器</th><th>Node</th></tr></thead><tbody><tr class="odd"><td>整体代码(script)</td><td>✅</td><td>✅</td></tr><tr class="even"><td>UI交互事件</td><td>✅</td><td>❌</td></tr><tr class="odd"><td>I/O</td><td>✅</td><td>✅</td></tr><tr class="even"><td>setTimeout<br />(setTimeout(,0)是常用的放队尾的方法)</td><td>✅</td><td>✅</td></tr><tr class="odd"><td>setInterval</td><td>✅</td><td>✅</td></tr><tr class="even"><td>setImmediate</td><td>❌</td><td>✅</td></tr><tr class="odd"><td>requestAnimationFrame</td><td>✅</td><td>❌</td></tr></tbody></table><p>微队列</p><table><thead><tr class="header"><th></th><th>浏览器</th><th>Node</th></tr></thead><tbody><tr class="odd"><td>process.nextTick</td><td>❌</td><td>✅</td></tr><tr class="even"><td>MutationObserver</td><td>✅</td><td>❌</td></tr><tr class="odd"><td>Promise.then catch finally</td><td>✅</td><td>✅</td></tr></tbody></table></li></ul><p>总流程如下</p><ol type="1"><li>从宏任务队列中，按照<strong>入队顺序</strong>，找到第一个执行的宏任务，放入调用栈，开始执行；</li><li>执行完<strong>该宏任务</strong>下所有同步任务后，即调用栈清空后，该宏任务被推出宏任务队列，然后微任务队列开始按照入队顺序，依次执行其中的微任务，<strong>直至微任务队列清空为止</strong>；</li><li>当微任务队列清空后，一个事件循环结束；</li><li>接着从宏任务队列中，找到下一个执行的宏任务，开始第二个事件循环，直至宏任务队列清空为止。</li></ol><p>这里有几个重点：</p><ul><li>当我们第一次执行的时候，解释器会将整体代码<code>script</code>放入宏任务队列中，因此事件循环是从第一个宏任务开始的；</li><li>如果在执行微任务的过程中，产生新的微任务添加到微任务队列中，也需要一起清空；微任务队列没清空之前，是不会执行下一个宏任务的。</li></ul><p><strong>异步并行</strong></p><p>异步与并行不一样, 异步是允许指定代码块的运行时机,并行是多个代码块同时运行. 更加形象的说, 异步就是维护一个事件循环,并行就是维护一堆事件循环.</p><p>异步与并行都会带来不确定性,异步的不确定性是不知道任务会在什么时候被塞到队列尾部,而并行的不确定性是不确定指令之间的执行顺序</p><p>所幸, JavaScript 是单线程的异步语言, 这意味着 JavaScript调度最小单位是单个任务(函数要么全运行要么不运行,我们将其成为<strong>完整运行</strong>), 不会出现抢占式调度</p><p><strong>并发</strong></p><p>将常见的并发模式分为三种</p><ul><li><p>非互动式: 进程间不共享内存</p></li><li><p>互动式: 进程间共享内存</p><p>这会导致由于未知执行顺序造成的资源竞争</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// ajax(..) 是某个包中任意的Ajax函数</span><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">"http://some.url.1"</span><span class="token punctuation">,</span> response <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">"http://some.url.2"</span><span class="token punctuation">,</span> response <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一般解决方案有</p><ul><li><p>编号</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>url <span class="token operator">==</span> <span class="token string">"http://some.url.1"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>url <span class="token operator">==</span> <span class="token string">"http://some.url.2"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// ajax(..) 是某个包中任意的Ajax函数</span><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">"http://some.url.1"</span><span class="token punctuation">,</span> response <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">"http://some.url.2"</span><span class="token punctuation">,</span> response <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>设置大门(只有两个进程都完成才能继续)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> a <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> b <span class="token operator">=</span> y <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token operator">+</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// ajax(..) 是某个包中任意的Ajax函数</span><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">"http://some.url.1"</span><span class="token punctuation">,</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">"http://some.url.2"</span><span class="token punctuation">,</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>设置"门闩"(即函数只给特定次调用者用)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a<span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> a <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> a <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// ajax(..) 是某个包中任意的Ajax函数</span><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">"http://some.url.1"</span><span class="token punctuation">,</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">"http://some.url.2"</span><span class="token punctuation">,</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p>协作式</p><p>对于计算量很大的同步任务, 经常将其拆解为异步的多个不冲突任务以放置JavaScript 运行阻塞</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// `response(..)`从Ajax调用收到一个10000000000的数组, 要同步执行一定会花很多时间</span><span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> res <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>  data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>   <span class="token keyword">return</span> val <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// ajax(..) 是某个包中任意的Ajax函数</span><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">"http://some.url.1"</span><span class="token punctuation">,</span> response <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">"http://some.url.2"</span><span class="token punctuation">,</span> response <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将其分解</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 一次只处理1000件</span> <span class="token keyword">var</span> chunk <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    res <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>  <span class="token comment">// 制造一个新的变形过的数组，所有的`data`值都翻倍</span>  chunk<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>   <span class="token keyword">return</span> val <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 异步规划下一个批处理</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 通过 setTImeout 将任务再次放入队尾</span>   <span class="token function">response</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// ajax(..) 是某个包中任意的Ajax函数</span><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">"http://some.url.1"</span><span class="token punctuation">,</span> response <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">"http://some.url.2"</span><span class="token punctuation">,</span> response <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>语句顺序</strong></p><p>JavaScript 编译器在执行代码前会做代码优化, 这可能改变语句执行顺序,但是这些改变都是安全的, 不必担心</p><h3 id="回调">回调</h3><p>JavaScript 是单线程的,其实现异步的最基本模式就是让主线程在不同任务上下文之间快速切换.基础的异步模式有回调与 <code>Promise</code>.</p><p><strong>回调的问题</strong></p><p>回调会让代码变得难以预测, 跟踪, 调试. 其存在多种问题</p><ul><li><p>回调地狱</p><p>称多层嵌套回调函数的代码为回调地狱.回调地狱不仅会造成代码形式上的难以理解,更重要的是在同步异步函数混杂的回调嵌套代码中,代码的行为与异步函数的执行时机往往是多样化的且容易被搞错.</p></li><li><p>信任问题</p><p>当使用第三方库异步函数时, 我们需要为第三方函数传入回调.而我们完全不清楚第三方库触发回调的时机, 次数, 三方函数出错后行为.过早过晚过多或出错后触发回调将会带来未知的问题.使用者在设计回调时需要考虑回调在不同时机调用的处理问题. 同时,称这种将函数执行时机交给三方函数的行为称为: 控制权反转</p></li></ul><p><strong>解决</strong></p><ul><li><p>解决回调地狱: 链式回调</p><p>将嵌套式回调</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>转为链式回调</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// do something</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span>doB<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">doB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// do something</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span>doC<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">doC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// do something</span>  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这让代码在形式上看起来清晰了一点, 但是没有根本解决问题.函数的执行还是难以追踪的.</p></li><li><p>解决信任问题: <code>Error-Else</code> 风格</p><p>也称 Node.JS 分格. 在设计回调函数时, 传入第一个参数为 Error 信息.若函数出错, 在执行回调时候将第一个参数设置为 Error 信息,回调一旦看到第一个函数非假就知道上层函数出错了, 若 Error 为假,则从第二个参数开始获取传入信息.</p></li><li><p>解决信任问题: 借用并发解决方案</p><p>为解决回调时机问题, 可以借助并发思路, 通过设置 flag 识别运行时机,解决运行时机问题</p></li></ul><h3 id="promise">Promise</h3><p>回调存在的两个问题: 信任问题 &amp; 回调地狱(异步代码难以理解). 在 ES6中, Promise &amp; 生成器分别解决了这两个问题.</p><p><strong>鸭子类型</strong></p><p>如何判断一个对象是 Promise 对象呢? JavaScript的判断方式是检查对象是否是 "thenable" 的, 即: 对象是否具有<code>then</code> 方法. <strong>任何有 <code>then</code> 方法的对象都是Promise</strong></p><p>显然, 这会造成严重的兼容问题, 老代码中定义 <code>then</code>的对象都莫名其妙变成了 Promise</p><p><code>Promise.resolve</code> 可以一定程度上解决这一问题.该函数不仅可以返回一个 Promise, 更重要的是其可以将参数中的<code>thenable</code> 转换为非 <code>thenable</code></p><p><strong>Promise 解决了信任问题</strong></p><ul><li><p>控制权反转: 在回调中, 我们将回调交给三方函数.三方函数的执行是不可预测的. 而在 Promise 中,三方异步函数只在结束时向我们返回执行结果 / 错误信息.</p></li><li><p>调用过早: 在回调中, 可能出现异步函数结束前调用回调的问题, 在Promise 中, 即使后继函数被注册, 也要等到 Promise 被决议后的下一个 trick再执行</p></li><li><p>调用过晚: 在回调中, 可能会出现后注册的回调先执行的问题</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'TEST1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'TEST2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hook'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// TEST1</span><span class="token comment">// Hook         // 👎</span><span class="token comment">// TEST2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 Promise 中, 后继函数的执行顺序是严格按照注册顺序来到</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'THEN 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hook'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'THEN 2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// THEN 1</span><span class="token comment">// THEN 2</span><span class="token comment">// Hook        // 👍</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>超时不调用: 在回调中, 如果三方函数不调用, 我们也没办法, 但是在Promise 中, 可以通过 <code>Promise.race()</code> 的方式解决这一问题</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">timeOutError</span><span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'TIME OUT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">timeOutError</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>  <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'T1 FUL: '</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'T1 REJ: '</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token function">timeOutError</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>  <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'T2 FUL: '</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'T2 REJ: '</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// T2 FUL:  OK</span><span class="token comment">// T1 REJ:  TIME OUT</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>调用次数不正确: Promise 一旦确定就无法更改(之后的<code>resolve</code> / <code>reject</code> 静默失效), 通过<code>then</code> 注册的函数也只能执行一次</p></li><li><p>传参异常: 在回调中可能出现参数长度不正确, 但是 Promise只允许传入一个参数, 多传的参数静默失效</p></li><li><p>异常处理: 在回调中, 如果三方函数出现异常, 回调函数可能不执行.但是在 Promise 中, 若执行出现异常, Promise 会自动执行 reject,捕获异常并传递到后继函数.</p></li></ul><p><strong>为什么是 <code>resolve</code> 而不是<code>fulfill</code></strong></p><p>Promise 的状态有 <code>pending</code> &amp; <code>fulfilled</code>&amp; <code>rejected</code>, 但是我们在构造 Promise回调的时候习惯上写的却是 <code>resolve</code> &amp; <code>reject</code>.为什么这里不用 <code>fulfill</code> &amp; <code>reject</code> 呢?</p><p><code>fulfilled</code> 表示 Promise 被接受, 而 <code>rejected</code>表示被拒绝. 然而 Promise 构造函数上的 <code>resolve &amp; reject</code>功能却不是这样的</p><ul><li><p><code>reject</code> 调用会让 Promise 无条件变为<code>rejected</code>, 且原因为传入的参数</p></li><li><p><code>resolve</code> 调用会让 Promise 变为调用<code>Promise.resolve</code> 后的结果. 如果传入的是一个 Error, Promise将变为 <code>rejected</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token function">resolve</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FLU'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'REJ'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// REJ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也就是说 <code>resolve</code> 不会让 Promise 无条件变为<code>fulfilled</code>, 这也就是不用 <code>fulfill</code>的原因</p></li></ul><p><strong>链式调用</strong></p><ul><li>Promise 每次调用 <code>then</code> 都会创建并返回一个 Promise 替代原Promise</li><li>若 <code>then</code> 中函数返回非 Promise, 则自动为其包上<code>Promise.resolve</code>. 不返回则相当于返回 <code>undefined</code>即返回 <code>Promise.resolve(undefined)</code></li><li><code>then</code> 中函数的返回值将被用作下一个 <code>then</code>中函数的参数.</li><li><code>then</code> 中的函数抛出错误, 并不会引全局错误, 而是会返回<code>Promise.reject</code> 交由下一个 <code>then</code> 处理.</li><li><code>then</code> 函数有两个默认值, 第一个会将收到的参数重新<code>resolve</code> 传给下一级,第二个会将传入的参数重新作为错误抛出</li><li><code>catch(fn)</code> 相当于 <code>then(undefined, fn)</code></li></ul><p><strong>为什么不是 <code>try...catch</code></strong></p><p>Promise 中使用 <code>reject</code> 而不是 <code>try...catch</code>的原因是 <code>reject</code> 可以异步的处理错误.</p><p><strong>并发</strong></p><ul><li><code>Promise.all</code> 可以实现并发执行, 传入<code>Promise.all</code> 数组中的每个元素在执行前都会被<code>Promise.resolve</code> 过滤一遍. 若执行时出现了一个<code>reject</code> 则直接返回 <code>reject</code>,否则全部执行并返回结果数组</li><li><code>Promise.race</code> 无论结果如何, 只返回第一个. (为<code>Promise.race</code> 传入空数组会导致 Promise 永远处于<code>pedding</code> 状态)</li><li><code>Promise.none</code>: <code>Promise.all</code> 的反面, 只有全<code>rejected</code> 才返回数组</li><li><code>Promise.any</code>: 忽略拒绝, 返回第一个<code>fulfilled</code>, 若都失败则返回失败</li><li><code>Promise.first</code>: <del>和 any 一样</del></li><li><code>Promise.last</code>: 返回最后一个成功</li></ul><p><strong>缺陷</strong></p><p><del>其实我觉得这都不是缺陷</del></p><ol type="1"><li>无法可靠捕获 <code>Promise</code> 最终的结果: 我们不知道 Promise什么时候执行完, 也无法知道 Promise 是否出现错误. 最简单的想法是在Promise 最后注册一个 <code>then</code> 用于通知 Promise 执行完成. 但是,如果这个这个函数出错了, 我们将无法得知 Promise 最后是<code>fulfilled</code> 还是 <code>rejected</code>.唯一的可行方法是利用浏览器的垃圾回收机制, 若一个 Promise 处于待回收状态,那么这个 Promise 肯定是执行完了, 这个时候可以检测 Promise 的状态</li><li>一旦确定无法修正: Promise 一旦做出决定就无法变化, 这意味着很难让Promise 做重复性工作(一旦监听到鼠标按下就执行函数),我们只能借助辅助函数不断的生成新的 Promise</li><li>无法取消. 我们可以使用 <code>Promise.race</code> 实现超时报错,但是报错并不会影响超时的 Promise 继续执行.</li></ol><h3 id="生成器">生成器</h3><p>Promise 解决了异步的信任问题, 而生成器解决了回调地狱问题.将异步代码转换为看似同步的顺序代码风格.</p><p><strong>异步执行</strong></p><p>生成器返回一个迭代器,调用者可以在任何时机调用迭代器以实现看似同步的异步调用.一个生成器可以生成多个迭代器. 这些迭代器之间可以交替执行,迭代器之间独立无法直接通信, 但是可以通过外部变量闭包通信.</p><p><strong>双向数据传递</strong></p><p>我们希望在每次调用迭代器时候都能为生成器传入参数, 并获得迭代器的相应.可以通过 <code>yield X</code> 或 <code>return X</code> 的方式获取返回值,通过 <code>yield</code> 传入参数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> y <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3.      ^ 执行到这里就停下, 返回 C</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> y<span class="token punctuation">;</span> <span class="token comment">// &lt;- 5. 执行到这里, 返回 y</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1. 只是返回生成器, 但是一点都不执行</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2. 开始执行生成器</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4. 传入 3 继续执行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>构造迭代器</strong></p><p>为对象加入 <code>[Symbol.iterator]</code> &amp; <code>next</code>方法, 即可将对象变为迭代器.</p><ul><li><code>[Symbol.iterator]</code> 方法是一个计算属性, 与 TypeScript的计算属性一样, <code>Symbol.iterator</code> 就是 <code>Symbol</code>的静态成员. 该方法应该返回一个迭代器自身.</li><li><code>next</code> 方法返回 <code>&#123;done: boolean, value: &#125;</code>对象.</li></ul><p><code>for...of</code>可以实现遍历迭代器</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> it <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 返回一个随机数</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">of</span> it<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 永远不 done 就会陷入死循环</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>生成器与迭代器</strong></p><p>为生成器产生的迭代器做一些改造可以实现特殊功能</p><ul><li><p>实现一个计数器</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">yield</span> <span class="token operator">++</span>cnt<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> counter1 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> counter2 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>实现关闭迭代器钩子</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">yield</span> <span class="token operator">++</span>cnt<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 相当于实现了一个执行结束的钩子, 可以用来做垃圾回收</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OK I will clean all the code'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> counter1 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> counter2 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span><span class="token comment">// 关闭生成器, 执行 finally</span>counter2<span class="token punctuation">.</span><span class="token function">return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>同步风格的异步代码</strong></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">ajax</span><span class="token punctuation">(</span>  <span class="token string">"http://some.url.1/?x="</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">"&amp;y="</span> <span class="token operator">+</span> y<span class="token punctuation">,</span>  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 向`*main()`中扔进一个错误</span>    it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>   <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 使用收到的`data`来继续`*main()`</span>    it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> text <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">31</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回并执行异步, 异步执行后会调用生成器下一步. 同时支持错误处理</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> text <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 使一切开始运行！</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>生成器与Promise</strong></p><p>迭代器可以用来写异步代码且不产生回调地狱.但是生成器需要外界不断控制自己执行下一块代码. 这个工作如果由 Promise完成那就会变得十分优雅</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'demo.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// request 会返回一个 Promise</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ERROR'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> p <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// p 现在是一个Promise对象</span>it<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>  <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让 Promise 执行流程控制</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在这里, Promise的异步控制只是在程序执行成功与出错的时候返回与抛出消息.完全可以用一个函数实现</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 感谢Benjamin Gruenbaum (@benjamingr在GitHub)在此做出的巨大改进！</span><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">gen</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> it<span class="token punctuation">;</span> <span class="token comment">// 在当前的上下文环境中初始化generator</span> it <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">,</span> args <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 为generator的完成返回一个promise</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">handleNext</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>   <span class="token comment">// 运行至下一个让出的值</span>   <span class="token keyword">var</span> next <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">handleResult</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// generator已经完成运行了？</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">return</span> next<span class="token punctuation">.</span>value<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 否则继续执行</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span> next<span class="token punctuation">.</span>value <span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>       <span class="token comment">// 在成功的情况下继续异步循环，将解析的值送回generator</span>       handleNext<span class="token punctuation">,</span>       <span class="token comment">// 如果`value`是一个拒绝的promise，就将错误传播回generator自己的错误处理g</span>       <span class="token keyword">function</span> <span class="token function">handleErr</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>         it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span>        <span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> handleResult <span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>      <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 ES7 中, 还可以使用 <code>async</code> &amp; <code>await</code>实现上述功能</p><p><strong>并发</strong></p><p>可以借助 Promise API 实现并发(这也启示了我们应该在哪里使用<code>async</code> &amp; <code>await</code>)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>    <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'demo-partA.com'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'demo-partB.com'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">demo-full.com?a=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>a<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&amp;b=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>b<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> p <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// p 现在是一个Promise对象</span>it<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 让 Promise 执行流程控制</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>生成器委托</strong></p><p>可以将生成器嵌套生成器直接扁平化为一维生成器</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>变为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 在调用的时候带上 * 这样相当于实现了生成器"转移"</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1 2 3 4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>生成器委托的对象可以是任何可迭代的值</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> foo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">yield</span><span class="token operator">*</span> foo<span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1 9 8 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以委托异常</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">yield</span> <span class="token string">"B"</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"error caught inside `*foo()`:"</span><span class="token punctuation">,</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">yield</span> <span class="token string">"C"</span><span class="token punctuation">;</span> <span class="token keyword">throw</span> <span class="token string">"D"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">yield</span> <span class="token string">"A"</span><span class="token punctuation">;</span> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"error caught inside `*bar()`:"</span><span class="token punctuation">,</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">yield</span> <span class="token string">"E"</span><span class="token punctuation">;</span> <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// note: can't get here!</span> <span class="token keyword">yield</span> <span class="token string">"G"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">throw</span> <span class="token string">"F"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"outside:"</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// outside: A</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"outside:"</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// outside: B</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"outside:"</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// error caught inside `*foo()`: 2</span><span class="token comment">// outside: C</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"outside:"</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// error caught inside `*bar()`: D</span><span class="token comment">// outside: E</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"outside:"</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"error caught outside:"</span><span class="token punctuation">,</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// error caught outside: F</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>形实转换(Thunk)</strong></p><p>一种古老的模式: 执行某个无参函数, 相当于这个另一个函数. 例如</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">fooThunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 稍后</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">fooThunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 7</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>实际上, 这种模式也实现了异步. 但是 Thunk 的无参意味着硬编码.可以通过工厂函数解决这个问题.</p><p><strong>polyfill</strong></p><p>我们可以轻松实现 Promise 的兼容代码, 因为 Promise 是一个API,但是生成器是一种语法. 我们没法实现兼容. 可以先看看生成器的实现</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 管理 generator 状态</span> <span class="token keyword">var</span> state<span class="token punctuation">;</span> <span class="token comment">// generator-范围的变量声明</span> <span class="token keyword">var</span> val<span class="token punctuation">;</span> <span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"requesting:"</span><span class="token punctuation">,</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>    val <span class="token operator">=</span> v<span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> val <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>   <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>    <span class="token keyword">var</span> err <span class="token operator">=</span> v<span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">"Oops:"</span><span class="token punctuation">,</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 制造并返回 iterator</span> <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 初始状态</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    state <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>     <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>     <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>   <span class="token comment">// 成功地让出继续值</span>   <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    state <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>     <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>     <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">process</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>   <span class="token comment">// generator 已经完成了</span>   <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>     <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>     <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">undefined</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token string-property property">"throw"</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 在状态 *1* 中，有唯一明确的错误处理</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    state <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>     <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>     <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">process</span><span class="token punctuation">(</span> e <span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>   <span class="token comment">// 否则，是一个不会被处理的错误，所以我们仅仅把它扔回去</span>   <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果真的需要在不支持 ES6 的环境下实现生成器.可以考虑代码转译工具.</p><h2 id="性能">性能</h2><h3 id="性能提升">性能提升</h3><p>异步可以实现多任务并发并显著提高性能. JavaScript中其他性能提升特性有</p><p><strong>Web Worker(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvQVBJL1dlYl9Xb3JrZXJzX0FQSS9Vc2luZ193ZWJfd29ya2Vycw==">MDN<i class="fa fa-external-link-alt"></i></span>)</strong></p><p>Web Worker 并不是 ES 标准语法, 只是宿主环境的功能.其可以提供一个并行的, 不共享作用域与资源的新线程. 通过与主线程<code>post</code> &amp; <code>listen</code> 消息实现通信.消息传递有如下方式</p><ul><li>转换为 String</li><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvQVBJL1dlYl9Xb3JrZXJzX0FQSS9TdHJ1Y3R1cmVkX2Nsb25lX2FsZ29yaXRobQ==">结构化拷贝<i class="fa fa-external-link-alt"></i></span>:高级的克隆算法, 支持循环引用等特殊对象的拷贝</li><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvQVBJL1dlYl9Xb3JrZXJzX0FQSS9Vc2luZ193ZWJfd29ya2VycyMlRTklODAlOUElRTglQkYlODclRTglQkQlQUMlRTglQUUlQTklRTYlODklODAlRTYlOUMlODklRTYlOUQlODMlRTUlOEYlQUYlRTglQkQlQUMlRTglQUUlQTklRTUlQUYlQjklRTglQjElQTElRTYlOUQlQTUlRTQlQkMlQTAlRTklODAlOTIlRTYlOTUlQjAlRTYlOEQlQUU=">所有权转移<i class="fa fa-external-link-alt"></i></span>:直接将对象的引用与所有权发给 Worker, 此时宿主函数无法访问对象</li></ul><p>Web Worker 也支持创建共享 Worker(并不是资源共享, 而是一个 Worker可以与多个宿主通行). 在实现共享 Worker 时, 需要为每次通行建立新的port</p><p><strong>SIMD</strong></p><p>单指令多数据(SIMD)是一种数据并行方法.其原理是将多个小数据拼成一个大数据一起运算. CPU 将其底层 API 暴露给JavaScript 以实现高效计算</p><p><strong>asm.js</strong></p><p>是一个 JavaScript 子集(只保留可优化的语法), 可以将 JavaScript编译为二进制文件</p><h3 id="性能测试">性能测试</h3><p>错误的测试方法: 多次循环测执行时间</p><p><strong>问题</strong></p><ul><li>计时器本身有不可忽视的误差</li><li>不能通过简单的除以测试次数的方法计算单次执行时间(考虑到极端数据,执行事件方差等). 应该用一系列统计学方法衡量执行时间</li><li>指令通过循环测得的执行效率与真实环境的执行效率可能不同</li></ul><p><strong>解决方案</strong></p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9iZW5jaG1hcmtqcy5jb20v">Benchmark.js<i class="fa fa-external-link-alt"></i></span>:提供了一套性能检测框架, 提供详细的测试结果</li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2pzcGVyZi9qc3BlcmYuY29t">jsPerf.com<i class="fa fa-external-link-alt"></i></span>:该网站提供不同 JavaScript 运行时性能测试</li></ul><p><strong>优化哪些</strong></p><ul><li><p>全局视角: 专注优化执行频率极高的部分</p><blockquote><p>非关键路径的优化都是万恶之源</p></blockquote></li><li><p>微优化: 不关注微优化(如: <code>++a</code> 与 <code>a++</code>的区别, <code>x &gt;&gt;&gt; 1</code> 与 <code>x/2</code> 的区别),编译器会在执行前自动优化. 虽然不同引擎优化不尽相同, 但是</p><blockquote><p>永远不要觉得自己比引擎聪明</p></blockquote><p>这些微优化很可能随着引擎种类的不同, 引擎版本的不同而失效.</p></li><li><p>尾调用优化(TCO): ES6 的一个特殊优化.</p><p>当一个函数在执行过程中调用另一个函数时,引擎需要开辟一个而外的空间(栈帧)管理调用栈.但是如果函数调用发生在函数最后, 那么引擎就无需开辟新栈帧,直接覆盖使用老栈帧即可.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> x<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">foo</span><span class="token punctuation">(</span> y <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 尾部调用</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">bar</span><span class="token punctuation">(</span> <span class="token number">40</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 不是尾部调用, 因为调用后还要执行加法</span><span class="token punctuation">&#125;</span><span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 42</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="回顾-javascript">回顾 JavaScript</h2><ul><li><p>在浏览器环境中通过 JavaScript 输入字符串</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token function">prompt</span><span class="token punctuation">(</span><span class="token string">'Please input a string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>在注释中应该写的是程序为什么是这样运行的,而不是程序是什么(暴论)</p></li><li><p>JavaScript 中通常使用全大写书写变量并使用 <code>_</code>连接单词(指的是常量而不是不变的const)</p></li><li><p><code>?:</code> 运算符不一定用在赋值上,但是这肯定是最常见的</p></li><li><p>基于原型链的继承方案与类继承方案是两套完全不同的设计模式.原型链继承的主要思想是委托.</p></li><li><p>兼容方案</p><ul><li>polufilling: 直接实现某个新功能API</li><li>transpliling: 通过转译实现新语法</li></ul></li></ul><h2 id="es6">ES6</h2><h3 id="语法-1">语法</h3><p><strong>Let &amp; Const</strong></p><ul><li><p>新增 <code>let &amp; const</code> 声明,这俩都具有块作用域其不会发生提升. <code>let</code>声明会产生暂时性死区(TDZ)问题, 建议在块首第一行就一起声明<code>let</code> 变量</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">;</span> <span class="token comment">//最好放一行, 方便看. 暂时无法赋值的就只声明以规避 TDZ</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>  d <span class="token operator">=</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在 <code>for</code> 的括号中使用 <code>let</code>声明迭代变量相当于为每个循环块中声明了一次变量(裸着可以理解为条件部分与循环体之间有一层作用域)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 相当于为每个循环体声明了一个 i</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>函数</strong></p><ul><li><p>函数实参部分有自己的块作用域</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> w <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> z <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">// 在作用域内找不到 w 就去全局找</span><span class="token comment">// 在作用域内找到了 x 且 x 已经声明, 不存在 TDZ, 搞定</span><span class="token comment">// 在作用域内找到了 z 但是 z 还没有被初始化, 抛出异常</span><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token parameter">x <span class="token operator">=</span> w <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> z <span class="token operator">=</span> z <span class="token operator">+</span> <span class="token number">1</span></span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ReferenceError</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>只有向函数实参传入 <code>undefined</code>(或者不传参)才会触发默认值</p></li><li><p>默认值是惰性求值的(如果有参数传入就不计算默认值的表达式了)</p></li><li><p>如果希望默认值是一个空函数可以使用<code>Function.prototype</code> 而不是<code>function() &#123;&#125;</code></p></li></ul><p><strong>解构与赋值</strong></p><ul><li><p>对象解构:</p><ul><li><p>对象解构与对象的表述不太相同, 对象的表述是 <code>标识符-值</code>模式, 但是对象的解构是 <code>对应属性-目标标识符</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> aa <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> bb <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">x</span><span class="token operator">:</span> aa<span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> bb <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 标识符: 值</span><span class="token keyword">var</span>     <span class="token punctuation">&#123;</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token constant">AA</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token constant">BB</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> o<span class="token punctuation">;</span> <span class="token comment">// 对应属性: 目标标识符</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token constant">AA</span><span class="token punctuation">,</span> <span class="token constant">BB</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 10 20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在对象解构中如果对应属性和目标标识符同名, 可以只写目标标识符</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> a<span class="token punctuation">,</span> b <span class="token punctuation">&#125;</span> <span class="token operator">=</span> o<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>实际上是</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> a<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> b <span class="token punctuation">&#125;</span> <span class="token operator">=</span> o<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>中省去 <code>a:</code> 的结果</p></li><li><p>在对象解构中如果对象前没有关键字(如<code>let / var / const</code>)就需要为加一层<code>()</code>防止将对象解析为代码块</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> a<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> b <span class="token punctuation">&#125;</span> <span class="token operator">=</span> o<span class="token punctuation">;</span> <span class="token comment">// 正常版本</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> a<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> b <span class="token punctuation">&#125;</span> <span class="token operator">=</span> o<span class="token punctuation">;</span> <span class="token comment">// &#123;&#125; 会被解析为代码快</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> a<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> b <span class="token punctuation">&#125;</span> <span class="token operator">=</span> o<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token comment">// ok</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>对象解构时允许出现计算属性</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token operator">:</span> t<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 前者是计算属性, 后者只是属性访问</span><span class="token punctuation">&#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123; a: 1, b: 2, c: 3 &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>支持重复赋值</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> na<span class="token punctuation">,</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">b</span><span class="token operator">:</span> nb<span class="token punctuation">,</span> <span class="token literal-property property">c</span><span class="token operator">:</span> nc <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span> <span class="token operator">=</span> o<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>na<span class="token punctuation">,</span> nb<span class="token punctuation">,</span> nc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123; b: 1, c: 2 &#125; 1 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>支持连环赋值, 由于赋值的结果值是原值,所以支持在链上不完全解构</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> a1<span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> b1 <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> a2<span class="token punctuation">,</span> <span class="token literal-property property">c</span><span class="token operator">:</span> c2 <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">b</span><span class="token operator">:</span> b3<span class="token punctuation">,</span> <span class="token literal-property property">c</span><span class="token operator">:</span> c3 <span class="token punctuation">&#125;</span> <span class="token operator">=</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> b3<span class="token punctuation">,</span> c3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 1 0 2 1 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>对象解构默认值</p><p>就是在目标标识符后面加上 <code>= x</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token literal-property property">w</span><span class="token operator">:</span> <span class="token constant">WW</span> <span class="token operator">=</span> <span class="token number">20</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> z <span class="token operator">=</span> <span class="token number">6</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> <span class="token constant">WW</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 4 5 6 20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>同时由于简化对象解构是简化了前半部分 <code>x:</code> 所以支持简写</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token punctuation">[</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span> d <span class="token operator">=</span> <span class="token number">12</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token keyword">var</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> z <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">,</span> w <span class="token operator">=</span> <span class="token number">20</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> z <span class="token operator">=</span> <span class="token number">6</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>但是不要过度依赖, 会严重降低可读性</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">,</span> z <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token keyword">var</span> o1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">42</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">y</span><span class="token operator">:</span> z <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">y</span><span class="token operator">:</span> x <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">y</span><span class="token operator">:</span> y <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> o1 <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">z</span><span class="token operator">:</span> y <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">y</span><span class="token operator">:</span> z <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> o1 <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">x</span><span class="token operator">:</span> z <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">y</span><span class="token operator">:</span> x <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> o1 <span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> x<span class="token punctuation">.</span>y<span class="token punctuation">,</span> y<span class="token punctuation">.</span>y<span class="token punctuation">,</span> z<span class="token punctuation">.</span>y <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 300 100 42</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p>数组解构</p><ul><li><p>支持部分赋值</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token punctuation">,</span> b<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p>数组 / 对象解构支持嵌套</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a1 <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">var</span> o1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">var</span> <span class="token punctuation">[</span> a<span class="token punctuation">,</span> <span class="token punctuation">[</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d <span class="token punctuation">]</span><span class="token punctuation">,</span> e <span class="token punctuation">]</span> <span class="token operator">=</span> a1<span class="token punctuation">;</span><span class="token keyword">var</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">z</span><span class="token operator">:</span> w <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> o1<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 2 3 4 5</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> w <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>对象</strong></p><ul><li><p>简洁属性(当属性与变量同名)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    x<span class="token punctuation">,</span>    y<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>简洁方法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ..</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token operator">*</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 生成器</span>    <span class="token comment">// ..</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这种简洁方法相当于是</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">x</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ..</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token function-variable function">y</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// ..</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>带来的后果就是对象中的方法变成了匿名函数, 这不利于内部对方法引用</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">runSomething</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> <span class="token function">something</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">></span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">return</span> <span class="token function">something</span><span class="token punctuation">(</span> y<span class="token punctuation">,</span> x <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// error</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> y <span class="token operator">-</span> x<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">runSomething</span><span class="token punctuation">(</span> <span class="token punctuation">&#123;</span> <span class="token function-variable function">something</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">something</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">></span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">return</span> <span class="token function">something</span><span class="token punctuation">(</span> y<span class="token punctuation">,</span> x <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ok, 因为有块作用域</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> y <span class="token operator">-</span> x<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>简洁 <code>getter &amp; setter</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">__id</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword">get</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__id<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">set</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__id <span class="token operator">=</span> v<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>supper</code></p><p>不止 <code>class</code> 支持 <code>supper</code>, 对象也可以使用<code>supper</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> o1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token string">'FA'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> o2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token string">'SON'</span><span class="token punctuation">,</span>  <span class="token comment">// na: super.a // 👎, supper 不能用于属性声明时</span>  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>o2<span class="token punctuation">,</span> o1<span class="token punctuation">)</span><span class="token punctuation">;</span>o2<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// SON FA</span><span class="token comment">// console.log(o2.super.a); // 👎, supper 不能用于属性访问</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>模板字符串</strong></p><ul><li><p>在模板字符串中, 除非出现转义, <code>\n, \r, \r\n</code>都会被转为 <code>\n</code></p></li><li><p>模板字符串没有自己的动态作用域</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hi, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token punctuation">(</span>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>模板字符串的标签函数(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvVGVtcGxhdGVfbGl0ZXJhbHMjJUU1JUI4JUE2JUU2JUEwJTg3JUU3JUFEJUJFJUU3JTlBJTg0JUU2JUE4JUExJUU2JTlEJUJGJUU1JUFEJTk3JUU3JUFDJUE2JUU0JUI4JUIy">MDN<i class="fa fa-external-link-alt"></i></span>)</p><p>可以在模板字符串前面加一个函数名, 这样模板字符串会作为参数传入函数,函数的返回结果作为模板字符串的结果. 参数传入的形式比较特殊.传入两个数组, 第一个数组包含为 <code>$&#123;&#125;</code> 的内容, 将<code>$&#123;&#125;</code> 作为分隔符将字符串分开, 第二个数组包含所有<code>$&#123;&#125;</code> 传入的内容</p><p>简单的实现</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">tag</span><span class="token punctuation">(</span><span class="token parameter">strings<span class="token punctuation">,</span> <span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">s<span class="token punctuation">,</span> v<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> s <span class="token operator">+</span> <span class="token punctuation">(</span>idx <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> values<span class="token punctuation">[</span>idx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> v<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> desc <span class="token operator">=</span> <span class="token string">'awesome'</span><span class="token punctuation">;</span><span class="token keyword">var</span> text <span class="token operator">=</span> tag<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Everything is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>desc<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Everything is awesome!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将模板字符串中插入的所有数字前加上 <code>$</code> 并保留两位小数</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">dollabillsyall</span><span class="token punctuation">(</span><span class="token parameter">strings<span class="token punctuation">,</span> <span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">s<span class="token punctuation">,</span>v<span class="token punctuation">,</span>idx</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> values<span class="token punctuation">[</span>idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"number"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 看，也使用插值性字符串字面量！</span>    s <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>values<span class="token punctuation">[</span>idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>   <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    s <span class="token operator">+=</span> values<span class="token punctuation">[</span>idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> s <span class="token operator">+</span> v<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">""</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> amt1 <span class="token operator">=</span> <span class="token number">11.99</span><span class="token punctuation">,</span> amt2 <span class="token operator">=</span> amt1 <span class="token operator">*</span> <span class="token number">1.08</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"Kyle"</span><span class="token punctuation">;</span><span class="token keyword">var</span> text <span class="token operator">=</span> dollabillsyall<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Thanks for your purchase, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">! Yourproduct cost was </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>amt1<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">, which with taxcomes out to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>amt2<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> text <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Thanks for your purchase, Kyle! Your</span><span class="token comment">// product cost was $11.99, which with tax</span><span class="token comment">// comes out to $12.95.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>模板字符串函数中的 <code>raw</code></p><p>类似于 HTML 中的 <code>pre</code> 标签</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">showraw</span><span class="token punctuation">(</span><span class="token parameter">strings<span class="token punctuation">,</span> <span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>strings<span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>showraw<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello\nWorld</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><span class="token comment">// [ "Hello</span><span class="token comment">// World" ]</span><span class="token comment">// [ "Hello\nWorld" ]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>箭头函数</strong></p><ul><li>箭头函数: 一般用于短小的, 不需要自己作用域的匿名函数(无需绑定, 监听,递归).</li><li>箭头函数有自己的作用域, 但是父作用域与声明时的作用域绑定.箭头函数没有自己的 <code>this</code>, <code>arguments</code>,<code>super</code>, <code>new.target</code> 均从父作用域继承</li></ul><p><strong>迭代器</strong></p><ul><li><p>JavaScript 中默认可迭代的对象有</p><ul><li>Array</li><li>String</li><li>生成器</li><li>Collections &amp; TypedArrays</li></ul></li><li><p><code>for...of</code> 可以迭代可迭代对象</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>a <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> o<span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 1 2 3</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">x</span><span class="token operator">:</span> o<span class="token punctuation">.</span>a<span class="token punctuation">&#125;</span> <span class="token keyword">of</span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">&#125;</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> o<span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 1 2 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>正则表达式</strong></p><ul><li><p>Unicode</p><p>Unicode 字符可以分为BMP(基本多语言平面)部分(0x000000-0x00ffff)与其他部分(0x00ffff-0x10ffff).在 ES6 之前, 正则只能匹配 BMP 部分的内容, 非 BMP部分的字符会被匹配为多个 BMP 字符</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token string">'👍👍👍'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^👍.👍$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false 将一个 👍 解析为两个字符所以 . 失效了</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^👍.&#123;2&#125;👍$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^👍.👍$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">u</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true 加上 u 后支持解析 Unicode 非 BMP 部分</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^👍.&#123;2&#125;👍$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">u</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>支持 Unicode 后还可以用这种操作</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token string">'👍🏻'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[👍-👍🏼]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">u</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>定点标识(黏滞标识)</p><p>定点标识(<code>lastIndex</code>)可以指定从哪一位开始正则匹配(必须从这一位开始).</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">foo</span><span class="token regex-delimiter">/</span><span class="token regex-flags">y</span></span><span class="token punctuation">;</span> <span class="token comment">// 使用 y 开启定点标识</span>str <span class="token operator">=</span> <span class="token string">'abcfooabc'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认是0</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false: 让第0位 a 作为开头匹配失败</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 由于匹配失败变为0</span>re<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true: 让第3位 f 作为开头匹配成功</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 匹配成功后 lastIndex 匹配部分最后一位的下一位 6</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false: 让第6位 a 作为开头匹配失败</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 由于匹配失败变为0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们必须手动将 <code>lastIndex</code> 设置到指定的位置,或在每次匹配成功后自动修改位置. 这玩意看起来没什么用.常规的使用场景有</p><ul><li><p>要求每若干位置出现一次匹配串</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[0-9]+\.[^ ]+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">y</span></span><span class="token punctuation">;</span> <span class="token comment">// 使用 y 开启定点标识</span>str <span class="token operator">=</span> <span class="token string">'1.你好, 我是ABC    2.Hello, IM A  3.HI'</span><span class="token punctuation">;</span><span class="token comment">// 测试每15位出现一次 x.一段文字</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> str<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  re<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>已知匹配串的固定模式由 JavaScript 自动更新<code>lastIndex</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[0-9]+\.[^0-9]+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">y</span></span><span class="token punctuation">;</span> <span class="token comment">// 使用 y 开启定点标识</span>str <span class="token operator">=</span> <span class="token string">'1.你好, 我是ABC          2.Hello, IM A     3.HI'</span><span class="token punctuation">;</span><span class="token comment">// 测试文本符合 x.一段文字 的模式并获得每次模式开头的下标</span><span class="token keyword">while</span> <span class="token punctuation">(</span>re<span class="token punctuation">.</span>lastIndex <span class="token operator">&lt;</span> str<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// true 21 true 39 true 43</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>注意</strong>: 若正则使用了 <code>^</code> 而定点标识的<code>lastIndex !== 0</code> 那必定匹配失败</p></li><li><p>flags</p><ul><li><code>g</code>: 全局匹配</li><li><code>i</code>: 忽略大小写</li><li><code>m</code>: 支持多行模式(此时 <code>^</code> 与 <code>$</code>既表示行始末也表示文本始末)</li><li><code>u</code>: 支持 Unicode 非 BMP 区域字符</li><li><code>y</code>: 支持定点标识</li></ul></li></ul><p><strong>Unicode</strong></p><ul><li>Unicode 的表示<ul><li>ES6 之前: 使用 <code>"\uxxxx"</code> 但是只支持 BMP 部分字符</li><li>ES6 的 Unicode 转义: <code>"\u&#123;1-ffff&#125;"</code> 支持全部 Unicode字符</li></ul></li></ul><p><strong>Symbol</strong></p><ul><li><p>使用 <code>symbol(string)</code> 即可声明 Symbol(无需<code>new</code>)</p></li><li><p><code>Symbol.toString</code> 的结果为</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'hihi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Symbol(hihi)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>可以通过 <code>Symbol.for</code> 将一个 Symbol 注册为全局符号.<code>Symbol.for</code> 相当于一个单例构造函数 API.若构造用字符串从未被注册则会构造并返回 Symbol. 若已经注册, 则直接返回Symbol(前提是必须用 <code>Symbol.for</code> 创建)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> s1 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'ruru'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> s2 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'ruru'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s1 <span class="token operator">===</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span><span class="token keyword">const</span> s3 <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'hihi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> s4 <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'hihi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s3 <span class="token operator">===</span> s4<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>Symbol.keyfor</code> 可以获取 <code>Symbol.for</code> 注册Symbol 的描述字符串</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> s1 <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'ruru'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ruru</span><span class="token keyword">const</span> s2 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'hihi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>当 Symbol 作为对象属性时, 无法通过<code>Object.key / Object.getOwnPropertyNames</code> 获取, 可以通过<code>Object.getOwnPropertySymbols</code> 获取</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a1</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token string">'c'</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'hihi'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123; a1: 1, c1: 2, [Symbol(hihi)]: 3 &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 'a1', 'c1' ]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 'a1', 'c1' ]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ Symbol(hihi) ]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="代码组织">代码组织</h3><p><strong>迭代器</strong></p><ul><li><p>接口</p><ul><li><p><code>next</code> 函数[必须实现]: 返回一个<code>&#123;value:, done: boolean&#125;</code></p></li><li><p><code>return</code> 函数[可选实现]: 返回一个<code>&#123;value:, done: boolean&#125;</code>, 用来结束迭代器,并完成代码清理工作</p></li><li><p><code>throw</code> 函数[可选实现]: 返回一个<code>&#123;value:, done: boolean&#125;</code>,用来通过异常的方式结束迭代器并调用并完成代码清理工作</p><p>若是调用生成器的 <code>throw</code>相当于是在生成器函数执行上下文上插入一个错误, 结束迭代器.</p></li><li><p><code>[Symbol.iterator]</code> 函数[可选实现]:返回一个迭代器</p></li></ul></li><li><p>自定义迭代器: 只需要返回一个 <code>thenable</code> 的对象即可</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> Fib <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">var</span> n1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> n2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 使迭代器成为一个可迭代对象</span>   <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> current <span class="token operator">=</span> n2<span class="token punctuation">;</span>    n2 <span class="token operator">=</span> n1<span class="token punctuation">;</span>    n1 <span class="token operator">=</span> n1 <span class="token operator">+</span> current<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">value</span><span class="token operator">:</span> current<span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token keyword">return</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>     <span class="token string">"Fibonacci sequence abandoned."</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">value</span><span class="token operator">:</span> v<span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token keyword">of</span> Fib<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">></span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 1 1 2 3 5 8 13 21 34 55</span><span class="token comment">// Fibonacci sequence abandoned.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>迭代器相关 API</p><p><code>...</code> &amp; <code>for...of</code> &amp;数组解构(不能是普通对象) 都需要消耗迭代器生成序列</p></li></ul><p><strong>生成器</strong></p><ul><li><p>yield 的优先级与 <code>=</code> 基本相同, <code>yield</code>时注意加 <code>()</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 合法</span>b <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 不合法</span>b <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 合法</span><span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 合法</span>a <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 不合法</span>a <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 合法</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>yield</code> 委托返回后会自动 <code>next</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    x <span class="token operator">=</span> <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123; value: 24, done: true &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>yield</code> 与 <code>next</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">const</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1. 先构造生成器, 但是不执行</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2. 传入 'A' 可惜没东西接收, 执行到 yield 暂停, 返回 1, 输出 1</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3. 转入 'B' 被 console.log 接收, 执行到第2个 yield 暂停, 返回 2, 输出 2</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3. 转入 'C' 被 console.log 接收, 执行到第3个 yield 暂停, 返回 3, 输出 3</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3. 转入 'D' 被 console.log 接收, 执行结束, 返回 done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在执行 <code>next</code> 时: 先传入, 再暂停, 最后返回.<strong>对于同一个 <code>yield</code>, 传入参数的 <code>next</code>与返回参数的 <code>next</code> 不同!</strong>.</p><p>同时注意: 在第三个 <code>next</code> 执行结束后虽然没有<code>yield</code> 了, 但是仍然不返回 <code>&#123;done: true&#125;</code>,这是因为 <code>for...of</code> 语句在遇到 <code>&#123;done: true&#125;</code>后会立马停止(这是书上的说法, 我觉得不对, 为了碟醋包饺子行为)</p></li><li><p>调用生成器上迭代器的 <code>throw</code> 相当于为上下文加入 Error,用 <code>try...catch</code> 可以捕获</p></li></ul><p><strong>模块</strong></p><ul><li><p>ES6 之前的模块: 通过函数与闭包实现</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Hello</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">function</span> <span class="token function">greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello '</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">greeting</span><span class="token operator">:</span> greeting<span class="token punctuation">,</span> <span class="token comment">// 需要暴露的API</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> me <span class="token operator">=</span> <span class="token function">Hello</span><span class="token punctuation">(</span><span class="token string">'Kyle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>me<span class="token punctuation">.</span><span class="token function">greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello Kyle!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>还有 AMD, CMD 等各种兼容方案</p></li><li><p>ES6 模块特性</p><ul><li><p>模块基于文件: 一个文件一个模块,暂时无法在一个文件中放多模块</p></li><li><p>模块是单例的: 实例只有一个, 多个模块导入同一个模块,该模块被多模块共享(如果不想共享, 可以考虑搞一个工厂函数)</p><ul><li><p><code>/index.js</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token string">'./mod1.js'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'./mod2.js'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> o <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./mod3.js'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123;a: 2&#125;, 所有模块引入的都是一个实例</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>/mod1.js</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> o <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./mod3.js'</span><span class="token punctuation">;</span>o<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p><code>/mod2.js</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> o <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./mod3.js'</span><span class="token punctuation">;</span>o<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p><code>/mod3.js</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p>模块是静态定义的: 这意味着在网络请求模块时可以预加载</p></li><li><p>导入声明只能在模块的顶层使用</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> o <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./mod3'</span><span class="token punctuation">;</span> <span class="token comment">// 👍</span><span class="token keyword">function</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> o <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./mod3'</span><span class="token punctuation">;</span> <span class="token comment">// 👎</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>自动提升: 所有导入的对象会自动提升到顶层作用域最前面</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [Function: foo]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> foo<span class="token punctuation">,</span> bar <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./mod3.js'</span><span class="token punctuation">;</span> <span class="token comment">// 不论是导入的函数还是变量, 都会提升</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>支持循环依赖</p><p>JavaScript 执行模块的过程: 打开文件 - 扫描文件的所有导出并记录导出项- 扫描文件的所有导入 - 对于每个导入, 以同样的模式扫描每个导入文件</p><p>对于循环依赖: 设模块 A 被首先加载, 经过上述扫描, 更具加载指令加载模块B 并做同样的扫描分析. 看到 B 加载 A 时发现 A 以及扫描过,直接标注这个导入合法</p><ul><li><p><code>mod1.js</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> foo <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./mod2.js'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'IM MOD 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>mod2.js</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> bar <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./mod1.js'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'IM MOD 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul></li><li><p>导出模块</p><p>有两种导出方式</p><ul><li><p>命名导出: 将模块与<strong>变量本身</strong>绑定,导出的是变量的引用(或指针). <strong>这意味着在导出后若修改变量的值,导出的变量也会发生变化</strong></p><ul><li><p>一个一个导出</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 需要导出 o 就在前面加个 export</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>批量导出</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token punctuation">&#123;</span> o<span class="token punctuation">,</span> a <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 将需要导出的内容写入一个括号内.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意: 这个括号只是语法, 不是对象,<strong>不是导出了一个匿名对象</strong></p></li><li><p>导出并重命名</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token punctuation">&#123;</span>  o <span class="token keyword">as</span> q<span class="token punctuation">,</span> <span class="token comment">// 导出的就只有 q 没有 o 了, 但是 q 就是 o 的指针</span>  a<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p>默认导出: 将模块与<strong>值</strong>绑定, 导出的是值,不导出变量名. <strong>这意味着在导出后若修改变量的值,导出的值也不会变化</strong>. 默认导出只能绑定一个值</p><ul><li><p>一般写法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> o<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>命名导出与默认导出同时导出</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在批量命名导出时指定一个值默认导出</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token punctuation">&#123;</span>  o<span class="token punctuation">,</span>  a <span class="token keyword">as</span> <span class="token keyword">default</span> <span class="token comment">// 相当于默认导出值 1, 命名导出 o</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>不要图方便将所有需要导出的变量默认导出, 这会导致 JavaScript无法做静态分析</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 👎</span>  <span class="token literal-property property">s</span><span class="token operator">:</span> a<span class="token punctuation">,</span>  b<span class="token punctuation">,</span>  c<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>导入同时导出</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./mod.js'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>相当于从 <code>/mod.js</code> 导入所有命名导出, 然后再导出. 此时<code>/mod.js</code> 中的命名导出不会被导入, 会直接导出</p></li></ul></li></ul></li><li><p>导入模块</p><p>两种导出方式对应两种导入方式</p><ul><li><p>导入默认导出的值</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> s <span class="token keyword">from</span> <span class="token string">'./mod.js'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>默认导入的是值, 需要自己命名, 同时导出的是值, 导入后默认为常量,不可修改值.</p></li><li><p>导入命名导出的变量</p><ul><li><p>按需导入</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// mod.js</span><span class="token comment">//   export &#123;a,b,c&#125; // 注意, 这不是导出匿名对象! 只是语法</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> a<span class="token punctuation">,</span> b <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./mod.js'</span><span class="token punctuation">;</span> <span class="token comment">// 注意, 这不是对象解构! 只是语法!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这种方法最好, 但是每次需要变量都要修改导入命令</p></li><li><p>全部导入</p><p>将全部命名导出的变量导入固然方便, 但是会污染命名空间.解决方案是全部导入并重命名</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> s <span class="token keyword">from</span> <span class="token string">'./mod.js'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul></li><li><p>混合导入默认与命名导出</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// mod.js</span><span class="token comment">//   export default function foo() &#123;&#125;</span><span class="token comment">//   export function bar() &#123;&#125;</span><span class="token comment">//   export function baz() &#123;&#125;</span><span class="token comment">//   export function yoo() &#123;&#125;</span><span class="token keyword">import</span> s<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> bar<span class="token punctuation">,</span> baz <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./mod'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><p><strong>类(ES6)</strong></p><ul><li><p><code>class</code> 语法糖</p><ul><li><p><code>constructor</code> 相当于原来的函数名</p></li><li><p>类上的方法(包括 <code>getter</code> &amp;<code>setter</code>)都支持简洁模式</p></li><li><p>类上的方法相当于 <code>类.prototype.方法</code></p></li></ul></li><li><p>与 ES5 的区别</p><ul><li><p>在 ES6 之前可以用 <code>Foo.call(obj)</code> 创建对象, 使用<code>class</code> 后只能用 <code>new</code></p></li><li><p><code>class</code> 不像 <code>function</code>一样支持提升</p></li><li><p><code>class</code> 声明的类会创建作用域词法分析符</p></li></ul></li><li><p><code>supper</code></p><ul><li><p><code>supper</code> 在不同位置表意不同</p><ul><li><p>在构造函数中: 父类的构造函数</p></li><li><p>在类的非构造函数中: 指向父类, 可以调用父类的静态方法,构造函数(只能带 <code>new</code> 用:<code>new super.constructor</code>)</p></li><li><p>在对象中: 指向对象的 <code>__protp__</code></p></li></ul></li><li><p>子类构造函数必须先调用 <code>this</code> 在访问<code>this</code>(JavaScript 的委托继承)</p></li><li><p>类上的 <code>supper</code> 是静态绑定的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ParentA</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'a'</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ParentA:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">ParentB</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'b'</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ParentB:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">ChildA</span> <span class="token keyword">extends</span> <span class="token class-name">ParentA</span> <span class="token punctuation">&#123;</span>  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ChildA:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">ChildB</span> <span class="token keyword">extends</span> <span class="token class-name">ParentB</span> <span class="token punctuation">&#123;</span>  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ChildB:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 常规操作</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChildA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>a<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ParentA: a</span>         <span class="token comment">// ChildA: a</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChildB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>b<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ParentB: b</span>         <span class="token comment">// ChildB: b</span><span class="token comment">// 修改 this</span>b<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ParentB: a (supper不变, 依然指向 B, this 变了)</span>               <span class="token comment">// ChildB: a</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p><code>extends</code></p><p>相当于 ES6 之前用 <code>prototype</code> 将两个类连起来. 除此之外,<code>extends</code> 还完美支持了原生类型的扩展. 例如: 在 ES6 之前,手动创建的 <code>Array</code> 子类并不会像 <code>Array</code>一样实现自动更新 <code>.length</code> 但是 <code>extends</code>支持</p></li><li><p><code>new.target</code></p><p>在构造函数中查看此属性可以返回类名, 在其他函数中是<code>undefined</code>.可以通过此属性判断构造函数是作为被继承类构造还是直接构造</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Foo: '</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">.</span>target<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token keyword">extends</span> <span class="token class-name">Foo</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Bar: '</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">.</span>target<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'baz: '</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Foo: Foo</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Foo: Bar   &lt;-- 虽然调用的是 Foo 的构造函数, 但是 new 的是 Bar</span><span class="token comment">// Bar: Bar</span>b<span class="token punctuation">.</span><span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// baz: undefined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>static</code></p><p>用于声明类上的静态对象, 相当于在 ES5 的构造函数上直接绑定对象.子类可以通过 <code>supper</code> 直接调用</p></li></ul><h3 id="集合">集合</h3><p>主要包含 <code>TypedArray</code>, <code>Map</code>,<code>WeakMap</code>, <code>Set</code>, <code>WeakSet</code></p><p><strong><code>TypedArray</code></strong></p><ul><li><p>静态长度与类型的 <code>Array</code>,一般用于表示二进制数据.</p></li><li><p><code>TypedArray</code>存在大小端问题(低位存左边还是右边)</p></li><li><p>通过 <code>ArrayBuffer</code> 申请空间(Buffer), 通过<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvVHlwZWRBcnJheQ==">类型数组构造函数<i class="fa fa-external-link-alt"></i></span>创建指定类型与大小的视图,并绑定的 Buffer. Buffer 与视图可以是一对多的关系</p></li></ul><p><strong><code>Map</code> &amp; <code>WeakMap</code></strong></p><ul><li><p>构造函数接受 <ahref="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/entries"><code>Object.entire()</code>模式</a>的数组</p></li><li><p>通过 <code>get</code> / <code>set</code> / <code>delete</code>方法查询 / 增加 / 删除Map</p></li><li><p>通过 <code>has</code> 方法查询是否有键名</p></li><li><p>通过 <code>clear</code> 方法清空 Map</p></li><li><p>Map 本身是可迭代的</p><ul><li>迭代器每次迭代一个数组, 第一个是 Key, 第二个是 Value</li><li>可以通过 <code>entries</code> 获取键值对数组</li><li>可以通过 <code>keys</code> 获取键值对数组</li><li>可以通过 <code>values</code> 获取键值对数组</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [Map Entries] &#123; [ 'a', 1 ], [ 'b', 2 ], [ 'c', 3 ] &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [Map Iterator] &#123; 1, 2, 3 &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [Map Iterator] &#123; 'a', 'b', 'c' &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>如果将对象作为 <code>Map</code> 的 Key, 对象的引用次数将<code>+1</code>, 这意味着不将 Key 删除, 对象将无法被 GC.<code>WeakMap</code> 解决了这一问题</p><ul><li><code>WeakMap</code> 的 Key只能是对象但是对象引用次数不会被影响</li><li>当对象被 GC 时, 映射会自动删除</li><li><code>WeakMap</code> 没有 <code>size</code>, <code>clear</code>方法</li></ul></li></ul><p><strong><code>Set</code> &amp; <code>WeakSet</code></strong></p><ul><li><p>相当于 <code>set</code> 换为 <code>add</code> 且<code>Vaule === Key</code> 的 <code>Map</code> &amp;<code>WeakMap</code></p></li><li><p>不支持强制类型转换(<code>1 !== '1'</code>)</p></li><li><p>同样支持迭代器</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [Set Entries] &#123; [ 1, 1 ], [ 2, 2 ], [ 3, 3 ] &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [Set Iterator] &#123; 1, 2, 3 &#125;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [Set Iterator] &#123; 1, 2, 3 &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>WeakSet</code> 的 Key 只能是对象</p></li></ul><h3 id="es6新api">ES6新API</h3><p><strong>Array</strong></p><ul><li><p><code>Array.of</code> 方法</p><p>类似 <code>Array</code> 构造函数,区别是若传入单个数字会创建一个长度为 1 的数组, 而不是那么长的数组.不仅规避的 <code>Array</code> 的陷阱, 还防止了<code>&lt;empty items&gt;</code> 的出现</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ &lt;5 empty items> ]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 5 ]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 5, 6, 7 ]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 5, 6, 7 ]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>Array.from</code> 方法</p><p>将一个 <code>Object</code> 中的正整数 Key 提取出来构造数组. 长度为<code>object.length</code>, 找不到的下标直接设为<code>undefined</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">fakeArr <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">)</span>arr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>fakeArr<span class="token punctuation">)</span> <span class="token comment">// [body]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>相对于 <code>Array.prototype.slice</code> 不会产生空值</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token number">0</span><span class="token operator">:</span> <span class="token string">'HIHI'</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token operator">:</span> <span class="token string">'RURU'</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token operator">:</span> <span class="token string">'LALA'</span><span class="token punctuation">,</span>  <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 'HIHI', 'RURU', undefined, 'LALA' ]</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 'HIHI', 'RURU', &lt;1 empty item>, 'LALA' ]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>Array.prototype.copyWithin</code> 方法</p><p>浅复制数组的一部分到同一数组中的另一个位置.</p><p>用法: <code>arr.copyWithin(target[, start[, end]])</code>,区间前取后不取, 起止位置接受负数(倒数第几个)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1,2,3,1,2]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1,2,3,1,5]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [4,5,3,4,5]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [4,2,3,4,5]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>拷贝的顺序是自右向左的</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copyWithin</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 自左向右拷贝的话是</span><span class="token comment">// [1,2,3,4,5] -> [1,2,2,4,5] -> [1,2,2,2,5] -> [1,2,2,2,5] -> [1,2,2,2,2]</span><span class="token comment">// 自右向左拷贝的话是</span><span class="token comment">// [1,2,3,4,5] -> [1,2,3,4,4] -> [1,2,3,3,4] -> [1,2,2,3,4]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>Array.prototype.find</code>方法: 使用 <code>===</code>查找元素返回 <code>boolean</code>. 如果需要自定义比较规则, 可以使用<code>Array.prototype.some</code>(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvc29tZQ==">MDN<i class="fa fa-external-link-alt"></i></span>).如果想要找到下标可以用 <code>Array.prototype.findIndex</code>(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvZmluZEluZGV4">MDN<i class="fa fa-external-link-alt"></i></span>)</p></li></ul><p><strong>Object</strong></p><ul><li><p><code>Object.is(..)</code> 方法</p><p>比 <code>===</code> 更严格的比较</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">NaN</span><span class="token punctuation">,</span>  y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>  z <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">;</span>x <span class="token operator">===</span> x<span class="token punctuation">;</span> <span class="token comment">// false</span>y <span class="token operator">===</span> z<span class="token punctuation">;</span> <span class="token comment">// true</span>Object<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>Object<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>Object.assign</code> 方法</p><p>用来合并对象, 只保留原对象中自有(非继承)的, 可枚举的属性</p></li></ul><p><strong>Number</strong></p><ul><li><p><code>Number.isNaN()</code></p></li><li><p><code>Number.isFinite()</code>:不进行强制类型转换判断是不是有穷的(NaN, Infinity都不算). 如需类型转换,可以使用全局的 <code>isFinite</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">a <span class="token operator">=</span> <span class="token string">'10'</span><span class="token punctuation">;</span>b <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token function">isFinite</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>Number<span class="token punctuation">.</span><span class="token function">isFinite</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span><span class="token function">isFinite</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>Number<span class="token punctuation">.</span><span class="token function">isFinite</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>Number.isInteger()</code>: 判断是不是整数, 虽然 JavaScript的数都是基于 IEEE 754 的, 但是还是可以通过判断小数位是否全 0判断是不是整数</p></li></ul><p><strong>String</strong></p><ul><li><p><code>String.prototype.repeat</code> 方法</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">"foo"</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'foofoofoo'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h3 id="元编程">元编程</h3><p>通过操作程序实体, 在编译时计算出运行时需要的常数, 类型,代码的方法(说白了就是操作代码实体)</p><p><strong>获取函数名</strong></p><p>通过 <code>.name</code> 可以获取函数名</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name:</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name:</span>window<span class="token punctuation">.</span><span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// name:</span><span class="token keyword">class</span> <span class="token class-name">Awesome</span> <span class="token punctuation">&#123;</span>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// name: Awesome</span>  <span class="token function">funny</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// name: funny</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Awesome</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// name: Awesome</span><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// name: foo</span>  <span class="token operator">*</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// name: bar</span>  <span class="token function-variable function">baz</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// name: baz</span>  <span class="token function-variable function">bam</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// name: bam</span>  <span class="token keyword">get</span> <span class="token function">qux</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// name: get qux</span>  <span class="token keyword">set</span> <span class="token function">fuz</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// name: set fuz</span>  <span class="token punctuation">[</span><span class="token string">'b'</span> <span class="token operator">+</span> <span class="token string">'iz'</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// name: biz</span>  <span class="token punctuation">[</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'buz'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// name: [buz]</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">var</span> x <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name: bound foo</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name: bound</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// name: default</span><span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name: anonymous</span><span class="token keyword">var</span> <span class="token function-variable function">GeneratorFunction</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor<span class="token punctuation">;</span><span class="token keyword">var</span> z <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GeneratorFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// name: anonymous</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Symbol</strong></p><ul><li><p><code>Symbol.iterator</code>: 返回对象的迭代器</p></li><li><p><code>Symbol.toStringTag</code>: toString的返回结果</p></li><li><p><code>Symbol.hasInstance</code>: 判断对象是不是该类型的实例</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token parameter">greeting</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>greeting <span class="token operator">=</span> greeting<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Foo'</span><span class="token punctuation">;</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Foo<span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>hasInstance<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>  <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">inst</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> inst<span class="token punctuation">.</span>greeting <span class="token operator">==</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>b<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'cool'</span><span class="token punctuation">;</span>a<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [object Foo]</span><span class="token function">String</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [object cool]</span>a <span class="token keyword">instanceof</span> <span class="token class-name">Foo</span><span class="token punctuation">;</span> <span class="token comment">// true</span>b <span class="token keyword">instanceof</span> <span class="token class-name">Foo</span><span class="token punctuation">;</span> <span class="token comment">// false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>Symbol.species</code></p></li><li><p><code>Symbol.toPrimitive</code></p></li><li><p>正则相关:</p><ul><li><code>Symbol.match</code></li><li><code>Symbol.replace</code></li><li><code>Symbol.search</code></li><li><code>String.prototype.split</code> 对应四个正则方法, 一般不要改,引擎实现的版本性能很好</li></ul></li><li><p><code>Symbol.isConcatSpreadable</code>:对象在合并时是否可以展开</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>b<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>isConcatSpreadable<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span> a<span class="token punctuation">,</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1,2,3,[4,5,6]]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p><code>Symbol.unscopables</code> 属性是否可以在 <code>with</code>中暴露</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>  b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span>  c <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>o<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>unscopables<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">with</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// o.b 不暴露, 所以只能请求外部的 b</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 20 3</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="es6-1">ES6+</h3><ul><li><p><code>async &amp; await</code> 异步支持: 相当于生成器 + Promise语法糖</p></li><li><p>对象的 <code>...</code>: <strong>这不是 Spread 表达式,对象默认是不可迭代的</strong>.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TypeError: Found non-callable @@iterator</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个功能可以将对象解构成并并入其他对象</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">const</span> o2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token operator">...</span>o<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>o2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#123; c: 3, a: 1, b: 2 &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>Array.prototype.includes</code>:查找数组并返回数组中是否有元素. 支持查找 <code>NaN</code>, 无法区分<code>+0 &amp; -0</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">NaN</span><span class="token punctuation">,</span> <span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">~</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token number">NaN</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0, 找不到</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token number">NaN</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true, 找的到</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true, 无法区分</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>Object.observe()</code> (没有支持但是很伟大的 API)</p><ul><li><p>相当于一个钩子函数, 支持对象在如下变化后调用函数</p><ul><li><p>add</p></li><li><p>update</p></li><li><p>delete</p></li><li><p>reconfigure(通过 <code>Object.defineProperty(..)</code>而重新配置时触发)</p></li><li><p>setPrototype(不论是使用<code>__proto__.setter</code>,还是使用<code>Object.setPrototypeOf(..)</code>都会触发)</p></li><li><p>preventExtensions(状态改变, <code>Object.seal(..)</code> 和<code>Object.freeze(..)</code> 也会触发)</p></li></ul></li><li><p>也支持自定义事件并触发(这不就相当于是个全局事件总线??)</p></li><li><p>可以直接使用该功能实现 MVVM</p></li><li><p>虽然目前没有实现, 但是实现了对 DOM 树监控的 <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvQVBJL011dGF0aW9uT2JzZXJ2ZXI=">MutationObserver<i class="fa fa-external-link-alt"></i></span></p></li></ul></li></ul>]]></content>
    
    
    <summary type="html">JS黄宝书第一版</summary>
    
    
    
    <category term="前端" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="JS" scheme="https://blog.liukairui.me/categories/%E5%89%8D%E7%AB%AF/JS/"/>
    
    
    <category term="前端" scheme="https://blog.liukairui.me/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="JavaScript" scheme="https://blog.liukairui.me/tags/JavaScript/"/>
    
  </entry>
  
</feed>
