<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="manifest" href="/images/manifest.json"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CPT+Sans:300,300italic,400,400italic,700,700italic%7CFira+Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/greem/pace-theme-minimal.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"blog.liukairui.me","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.13.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"width":320},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"algolia":{"appID":"GPJGYFJZH3","apiKey":"594eec10fca5caccffae82e82d066310","indexName":"hexo","hits":{"per_page":10}}}</script><script src="/js/config.js"></script><meta name="description" content="å°è¯•ç†è§£ Vue çš„è®¾è®¡æ€æƒ³ä¸å®ç°, å‚è€ƒè‡ª: mini-vue, Vue.js è®¾è®¡ä¸å®ç°"><meta property="og:type" content="article"><meta property="og:title" content="ç†è§£Vue"><meta property="og:url" content="https://blog.liukairui.me/article/%E7%90%86%E8%A7%A3Vue/"><meta property="og:site_name" content="LiuKairui&#39;s Blog"><meta property="og:description" content="å°è¯•ç†è§£ Vue çš„è®¾è®¡æ€æƒ³ä¸å®ç°, å‚è€ƒè‡ª: mini-vue, Vue.js è®¾è®¡ä¸å®ç°"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-08-15T16:00:00.000Z"><meta property="article:modified_time" content="2022-10-18T17:31:24.086Z"><meta property="article:author" content="Liu Kairui"><meta property="article:tag" content="å‰ç«¯"><meta property="article:tag" content="ç¬”è®°"><meta property="article:tag" content="å‰ç«¯æ¡†æ¶"><meta property="article:tag" content="Vue"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://blog.liukairui.me/article/%E7%90%86%E8%A7%A3Vue/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.liukairui.me/article/%E7%90%86%E8%A7%A3Vue/","path":"article/ç†è§£Vue/","title":"ç†è§£Vue"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>ç†è§£Vue | LiuKairui's Blog</title><script>var titleTime,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="æˆ‘ä»¬æ´»ç€æ˜¯ä¸ºäº†ä»€ä¹ˆ? | "+OriginTitile,clearTimeout(titleTime)):(document.title="æ•´ç‚¹è–¯æ¡ | "+OriginTitile,titleTime=setTimeout(function(){document.title=OriginTitile},2e3))})</script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="LiuKairui's Blog" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">LiuKairui's Blog</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">æ•´ç‚¹è–¯æ¡</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fas fa-hashtag fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-æ”¶è—å¤¹"><a href="/favorites/" rel="section"><i class="fab fa-gratipay fa-fw"></i>æ”¶è—å¤¹</a></li><li class="menu-item menu-item-ç•™è¨€æ¿"><a href="/messageBoard/" rel="section"><i class="fab fa-facebook-messenger fa-fw"></i>ç•™è¨€æ¿</a></li><li class="menu-item menu-item-é¡¹ç›®"><a href="/projects/" rel="section"><i class="fa fa-satellite fa-fw"></i>é¡¹ç›®</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="algolia-stats"><hr></div><div class="algolia-hits"></div><div class="algolia-pagination"></div></div></div></div><script async src="/js/wobblewindow.js"></script><script async>window.addEventListener("load",function(){768<window.innerWidth&&($("body>main>header").wobbleWindow({radius:50,movementTop:!1,movementLeft:!1,movementRight:!1,debug:!1}),$("body>footer").wobbleWindow({radius:50,movementBottom:!1,movementLeft:!1,movementRight:!1,debug:!1}))})</script></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">æ–‡ç« ç›®å½•</li><li class="sidebar-nav-overview">ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E8%A7%88"><span class="nav-text">æ€»è§ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#vue3-%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="nav-text">Vue3 çš„åŸºæœ¬ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reactivity-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="nav-text">Reactivity çš„åŸºæœ¬æµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#runtime-core-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="nav-text">Runtime-core çš„åŸºæœ¬æµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-reactivity"><span class="nav-text">å®ç° Reactivity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-text">ç¯å¢ƒæ­å»º</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E5%9F%BA%E6%9C%AC-effect-%E4%B8%8E-reactive"><span class="nav-text">æ„å»ºåŸºæœ¬ effect ä¸ reactive</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA-effect-%E7%9A%84-scheduler-%E9%80%89%E9%A1%B9-watch"><span class="nav-text">æ„å»º effect çš„ scheduler é€‰é¡¹ (watch)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA-effect-%E7%9A%84-stop-%E4%B8%8E-onstop-%E9%80%89%E9%A1%B9"><span class="nav-text">æ„å»º effect çš„ stop ä¸ onStop é€‰é¡¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA-proxy-%E7%9A%84-readonly"><span class="nav-text">æ„å»º Proxy çš„ Readonly</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0-isreadonly-isreactive-isproxy"><span class="nav-text">æ„å»ºå·¥å…·å‡½æ•° isReadonly, isReactive, isProxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-reactive-readonly-%E5%B5%8C%E5%A5%97"><span class="nav-text">å®ç° reactive &#x2F; readonly åµŒå¥—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA-shadowreadonly"><span class="nav-text">æ„å»º shadowReadonly</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA-ref"><span class="nav-text">æ„å»º ref</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0-isref-unref-proxyrefs"><span class="nav-text">æ„å»ºå·¥å…·å‡½æ•° isRef &amp; unRef &amp; proxyRefs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-computed"><span class="nav-text">å®ç° computed</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-text">å°ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-runtime-core-%E7%9A%84-mount-%E9%83%A8%E5%88%86"><span class="nav-text">å®ç° runtime-core çš„ mount éƒ¨åˆ†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83"><span class="nav-text">æ­å»ºç¯å¢ƒ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="nav-text">æ„é€ æµ‹è¯•ç”¨ä¾‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E4%B8%BB%E6%B5%81%E7%A8%8B"><span class="nav-text">æ„é€ ä¸»æµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B-proxy"><span class="nav-text">å®ç°ç»„ä»¶å®ä¾‹ Proxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-shapeflags"><span class="nav-text">å®ç° shapeFlags</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%8B%E4%BB%B6%E6%B3%A8%E5%86%8C"><span class="nav-text">å®ç°äº‹ä»¶æ³¨å†Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-props"><span class="nav-text">å®ç° props</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-emits"><span class="nav-text">å®ç° emits</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-slot"><span class="nav-text">å®ç° slot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-fragmentnode"><span class="nav-text">å®ç° FragmentNode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-textnode"><span class="nav-text">å®ç° TextNode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0-getcurrentinstance"><span class="nav-text">å®ç°å·¥å…·å‡½æ•° getCurrentInstance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-provide-inject"><span class="nav-text">å®ç° provide-inject</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="nav-text">å°ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-runtime-core-%E7%9A%84-update-%E9%83%A8%E5%88%86"><span class="nav-text">å®ç° runtime-core çš„ update éƒ¨åˆ†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%80%9D%E6%83%B3"><span class="nav-text">åŸºæœ¬æ€æƒ³</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-pipeline"><span class="nav-text">æ›´æ–° pipeline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#element-%E6%9B%B4%E6%96%B0-props"><span class="nav-text">Element æ›´æ–° props</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#element-%E6%9B%B4%E6%96%B0-children-%E5%89%8D%E4%B8%89%E7%A7%8D%E6%83%85%E5%86%B5"><span class="nav-text">Element æ›´æ–° children å‰ä¸‰ç§æƒ…å†µ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#element-%E6%9B%B4%E6%96%B0-children-%E7%9A%84%E5%8F%8C%E7%AB%AF%E5%AF%B9%E6%AF%94%E6%B3%95"><span class="nav-text">Element æ›´æ–° children çš„åŒç«¯å¯¹æ¯”æ³•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%84%E4%BB%B6%E6%9B%B4%E6%96%B0"><span class="nav-text">ç»„ä»¶æ›´æ–°</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Liu Kairui" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">Liu Kairui</p><div class="site-description" itemprop="description">LiuKairui's Personal Website</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">48</span> <span class="site-state-item-name">æ—¥å¿—</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">26</span> <span class="site-state-item-name">åˆ†ç±»</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">60</span> <span class="site-state-item-name">æ ‡ç­¾</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0thaXJ1aUxpdQ==" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;KairuiLiu"><i class="fab fa-github fa-fw"></i>GitHub</span> </span><span class="links-of-author-item"><span class="exturl" data-url="bWFpbHRvOm1lQGxpdWthaXJ1aS5tZQ==" title="E-Mail â†’ mailto:me@liukairui.me"><i class="fa fa-envelope fa-fw"></i>E-Mail</span> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9xbS5xcS5jb20vY2dpLWJpbi9xbS9xcj9rPW9hZjNUb09sTjE3aHI1c0hWOThiVDhxeHNOWUdhdzVMJm5vdmVyaWZ5PTA=" title="QQ â†’ https:&#x2F;&#x2F;qm.qq.com&#x2F;cgi-bin&#x2F;qm&#x2F;qr?k&#x3D;oaf3ToOlN17hr5sHV98bT8qxsNYGaw5L&amp;noverify&#x3D;0"><i class="fab fa-qq fa-fw"></i>QQ</span> </span><span class="links-of-author-item"><a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9saXVrYWlydWkuYmxvZy5jc2RuLm5ldA==" title="CSDN â†’ https:&#x2F;&#x2F;liukairui.blog.csdn.net"><i class="fab fa-cuttlefish fa-fw"></i>CSDN</span> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cDovL2xpdWthaXJ1aS5jYw==" title="å›½å†…ç«™ç‚¹ â†’ http:&#x2F;&#x2F;liukairui.cc"><i class="fa fa-globe fa-fw"></i>å›½å†…ç«™ç‚¹</span></span></div><div class="cc-license site-overview-item animated" itemprop="license"><span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></span></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.liukairui.me/article/%E7%90%86%E8%A7%A3Vue/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Liu Kairui"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="LiuKairui's Blog"><meta itemprop="description" content="LiuKairui's Personal Website"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="ç†è§£Vue | LiuKairui's Blog"><meta itemprop="description" content="å°è¯•ç†è§£ Vue çš„è®¾è®¡æ€æƒ³ä¸å®ç°, å‚è€ƒè‡ª: mini-vue, Vue.js è®¾è®¡ä¸å®ç°"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">ç†è§£Vue</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-08-16 00:00:00" itemprop="dateCreated datePublished" datetime="2022-08-16T00:00:00+08:00">2022-08-16</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">åˆ†ç±»äº</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">å‰ç«¯</span></a> </span>ï¼Œ <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">å‰ç«¯æ¡†æ¶</span></a> </span></span><span id="/article/%E7%90%86%E8%A7%A3Vue/" class="post-meta-item leancloud_visitors" data-flag-title="ç†è§£Vue" title="é˜…è¯»æ¬¡æ•°"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span> <span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valineï¼š</span> <a title="valine" href="/article/%E7%90%86%E8%A7%A3Vue/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/article/%E7%90%86%E8%A7%A3Vue/" itemprop="commentCount"></span> </a></span><span class="post-meta-item theme_switch_wapper hidden" id="theme_switch_wapper"><span class="post-meta-item-icon"><i class="fa-brands fa-markdown"></i></span> <span class="post-meta-item-text">ä¸»é¢˜ï¼š </span><select name="theme_switch" id="theme_switch"><option>sneh</option><option>mo</option><option>with</option><option>next</option></select> </span><span class="post-meta-item" title="æœ¬æ–‡å­—æ•°"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span> <span>68k</span></span></div><div class="post-description">å°è¯•ç†è§£ Vue çš„è®¾è®¡æ€æƒ³ä¸å®ç°, å‚è€ƒè‡ª: mini-vue, Vue.js è®¾è®¡ä¸å®ç°</div></div></header><div class="post-body" itemprop="articleBody"><h2 id="æ€»è§ˆ">æ€»è§ˆ</h2><h3 id="vue3-çš„åŸºæœ¬ç»“æ„">Vue3 çš„åŸºæœ¬ç»“æ„</h3><p>é‡‡ç”¨ Monorepo æ¨¡å¼(å¤šç»„ä»¶æ”¾åœ¨ä¸€ä¸ª Repo ä¸­), åœ¨ <code>/packages/</code> ä¸­å­˜å‚¨æ‰€æœ‰çš„æ¨¡å—.</p><p><strong>æ¨¡å—åˆ†ä¸ºå‡ ç±»:</strong></p><ul><li>ç¼–è¯‘æ—¶(<code>/package/compiler-*</code>)<ul><li><code>compiler-core</code>: ä¸å¹³å°æ— å…³çš„ç¼–è¯‘å™¨æ ¸å¿ƒ</li><li><code>compiler-dom</code>: åŸºäº <code>compiler-core</code> è§£æ <code>&lt;template&gt;</code> æ ‡ç­¾å¹¶ç¼–è¯‘ä¸º render å‡½æ•°</li><li><code>compiler-sfc</code>: åŸºäº <code>compiler-dom</code> ä¸ <code>compiler-core</code> è§£æ SFC (å•æ–‡ä»¶ç»„ä»¶, é€šä¿—ç†è§£å°±æ˜¯ <code>.vue</code> æ–‡ä»¶) ç¼–è¯‘ä¸ºæµè§ˆå™¨å¯æ‰§è¡Œçš„ JavaScript</li><li><code>compiler-ssr</code>: æœåŠ¡ç«¯æ¸²æŸ“çš„ç¼–è¯‘æ¨¡å—</li></ul></li><li>è¿è¡Œæ—¶(<code>/package/runtime-*</code>)<ul><li><code>reactivity</code>: å®ç°å“åº”å¼</li><li><code>runtime-core</code>: åŸºäº <code>reactivity</code> å®ç°è¿è¡Œæ—¶æ ¸å¿ƒ</li><li><code>runtime-dom</code>: åŸºäº <code>runtime-core</code> å®ç°é’ˆå¯¹æµè§ˆå™¨çš„è¿è¡Œæ—¶. åŒ…æ‹¬DOM API, å±æ€§, äº‹ä»¶å¤„ç†ç­‰</li></ul></li><li>å…¶ä»–<ul><li><code>template-explorer</code>: ç”¨äºè°ƒè¯•ç¼–è¯‘å™¨è¾“å‡ºçš„å¼€å‘å·¥å…·</li><li><code>shared</code>: å¤šä¸ªåŒ…ä¹‹é—´å…±äº«çš„å†…å®¹</li><li><code>vue</code>: å®Œæ•´ç‰ˆæœ¬,åŒ…æ‹¬è¿è¡Œæ—¶å’Œç¼–è¯‘å™¨</li></ul></li></ul><p><strong>ä¾èµ–å…³ç³»</strong></p><pre class="line-numbers language-none"><code class="language-none">                                 +---------------------+
                                 |                     |
                                 |  @vue&#x2F;compiler-sfc  |
                                 |                     |
                                 +-----+--------+------+
                                       |        |
                                       v        v
                   +---------------------+    +----------------------+
                   |                     |    |                      |
     +------------&gt;|  @vue&#x2F;compiler-dom  +---&gt;|  @vue&#x2F;compiler-core  |
     |             |                     |    |                      |
+----+----+        +---------------------+    +----------------------+
|         |
|   vue   |
|         |
+----+----+        +---------------------+    +----------------------+    +-------------------+
     |             |                     |    |                      |    |                   |
     +------------&gt;|  @vue&#x2F;runtime-dom   +---&gt;|  @vue&#x2F;runtime-core   +---&gt;|  @vue&#x2F;reactivity  |
                   |                     |    |                      |    |                   |
                   +---------------------+    +----------------------+    +-------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>å­¦ä¹ è·¯çº¿</strong></p><p>æ ¹æ®æ¨¡å—ä¾èµ–å…³ç³», è·¯çº¿ä¸º: <code>reactivity</code> -&gt; <code>runtime-core</code> -&gt; <code>runtime-dom</code> -&gt; <code>compiler</code>. é‡ç‚¹æ˜¯ <code>runtime-*</code></p><p><strong>ä»£ç åˆ†ææ­¥éª¤</strong>:</p><ol type="1"><li>æŸ¥çœ‹å•å…ƒæµ‹è¯•(ä½äº<code>packages/**/__tests__/</code>)</li><li>æ ¹æ®å•å…ƒæµ‹è¯•äº†è§£æ¨¡å—å®ç°çš„åŠŸèƒ½</li><li>è·Ÿç€å•å…ƒæµ‹è¯•çš„äº†è§£æ¨¡å—åŠŸèƒ½, äº†è§£æ¨¡å—åŠŸèƒ½æ—¶: å…ˆçœ‹å¯¼å‡º(æ¨¡å—æ˜¯ä»€ä¹ˆ), å†çœ‹æ¨¡å—è¢«è°å¯¼å…¥(ä¸ºä»€ä¹ˆè¢«éœ€è¦), æœ€åçœ‹å¯¼å‡ºéƒ¨åˆ†å¯¹åº”çš„å®ç°(æ€ä¹ˆæ ·å®ç°)</li></ol><p><strong>å‚è€ƒ repo</strong></p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2N1aXhpYW9ydWkvbWluaS12dWU=">cuixiaorui/mini-vue<i class="fa fa-external-link-alt"></i></span>: ç”¨æ¥å­¦ä¹ </li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z1ZWpzL2NvcmU=">vuejs/core<i class="fa fa-external-link-alt"></i></span>: ç”¨æ¥éªŒè¯</li></ul><h3 id="reactivity-çš„åŸºæœ¬æµç¨‹">Reactivity çš„åŸºæœ¬æµç¨‹</h3><p><code>Reactivity</code> æ¨¡å—æ˜¯è¿è¡Œæ—¶çš„æœ€åº•å±‚, è´Ÿè´£å®ç°å“åº”å¼, ä½äº: <code>mini-vue/packages/reactivity</code></p><p><strong><code>reactive</code> çš„åŸºæœ¬æµç¨‹</strong></p><p><code>reactive</code> æ˜¯ <code>Reactivity</code> çš„åŸºç¡€. è´Ÿè´£å®ç°å¯¹è±¡çš„å“åº”å¼, å¹¶å‘ä¸Šæä¾›è°ƒç”¨æ—¶æ–¹æ³•. åŸºæœ¬æ€æƒ³å°±æ˜¯å€ŸåŠ© ES6 çš„ <code>Proxy</code> è‡ªå®šä¹‰ <code>get &amp; set</code></p><ol type="1"><li><p>è½¬åˆ° <code>mini-vue/../__tests__/reactive.spec.ts</code>, å‘ç°æµ‹è¯•çš„ä¸»è¦ç›®çš„æ˜¯çœ‹ <code>reactive</code> æ„é€ æ–¹æ³•.</p></li><li><p>è½¬åˆ° <code>mini-vue/../src/reactive.ts</code>, å‘ç°å®šä¹‰äº† <code>reactive</code>, <code>readonly</code> ç­‰æ–¹æ³•, è¿™äº›æ–¹æ³•éƒ½äº¤ç”± <code>createReactiveObject</code> å¤„ç†.</p><p>è§‚å¯Ÿ <code>createReactiveObject</code>, å¯ä»¥å¾—åˆ°ä¸‰ä¸ªè°ƒç”¨å‚æ•°æ„ä¹‰:</p><ul><li><p><code>target</code>: è¦è¢«ä»£ç†çš„å€¼</p></li><li><p><code>proxyMap</code>: ä¸åŒç±»å‹çš„å·¥å‚å‡½æ•°æœ‰ä¸åŒçš„å…¨å±€ <code>proxyMap</code>, è¿™æ„å‘³ç€è¯¥å˜é‡å¯èƒ½ä¼šå­˜å‚¨æ‰€æœ‰ä»£ç†çš„æŸç±»å‹å˜é‡. æ ¹æ®</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> existingProxy <span class="token operator">=</span> proxyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> existingProxy<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥éªŒè¯æƒ³æ³•, å…¶åœ¨ <code>createReactiveObject</code> çš„ç›®çš„å°±æ˜¯æŒä¹…åŒ– <code>Proxy</code> é˜²æ­¢é‡å¤åˆ›å»ºä»£ç†</p></li><li><p><code>baseHandlers</code>: æ ¹æ®</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¾—å‡ºè¯¥æ–¹æ³•å°±æ˜¯ Proxy(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvUHJveHk=">MDN<i class="fa fa-external-link-alt"></i></span>) çš„ <code>get &amp; set</code> å¯¹è±¡. ä¸åŒç±»å‹çš„ Proxy æœ‰ä¸åŒçš„ <code>baseHandlers</code></p></li></ul></li><li><p>è½¬åˆ° <code>mini-vue/../src/baseHandlers.ts</code> å‘ç°æ¨¡å—ä¸»è¦æ˜¯æä¾›ä¸åŒçš„ <code>get &amp; set</code> è€Œè¿™äº›éƒ½æ˜¯ç”±ä¸¤ä¸ª <code>create</code> å‡½æ•°å®ç°çš„, å°è¯•ç†è§£</p><ul><li><p><code>createGetter</code> åº”è¯¥è¿”å›ä¸€ä¸ª <code>handler.get</code>(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvUHJveHkvUHJveHkvZ2V0">MDN<i class="fa fa-external-link-alt"></i></span>) å®ç°. å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ä¸Šæœ‰ä¸€å †ç±»å‹åˆ¤æ–­çš„æ–¹æ³•, ç„¶ååšäº†ä¸¤æ­¥</p><ul><li>é€šè¿‡ <code>Reflect.get</code>(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvUmVmbGVjdC9nZXQ=">MDN<i class="fa fa-external-link-alt"></i></span>) è·å–å±æ€§</li><li>é€šè¿‡ <code>track</code> è¿›è¡Œ<strong>ä¾èµ–æ”¶é›†</strong>, è¿™éƒ¨åˆ†åé¢å†çœ‹</li></ul><p>æœ€åè¿”å›è·å–ç»“æœ. æ•´ä¸ª <code>get</code> æ„Ÿè§‰å’ŒåŸç”Ÿæ–¹æ³•ç›¸æ¯”å°±æ˜¯å¤šäº†ä¸ªç±»å‹åˆ¤æ–­å’Œ <code>track</code>, å¤§éƒ¨åˆ†çš„å“åº”å¼éƒ½æ˜¯ä¾èµ–è¿™ä¸ª <code>track</code> å®ç°çš„</p></li><li><p><code>createSetter</code> æ›´åŠ ç®€å•, çœ‹èµ·æ¥å°±æ˜¯åœ¨å®ç° <code>handler.set</code>(<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvUHJveHkvUHJveHkvc2V0">MDN<i class="fa fa-external-link-alt"></i></span>) çš„åŸºç¡€ä¸Šå¤šäº†ä¸ª <code>trigger</code></p></li></ul><p>åˆ°ç›®å‰ä½ç½®è¿™ä¸ªåªæœ‰ <code>track</code> å’Œ <code>trigger</code> æ˜¯ä¸æ¸…æ¥šçš„, è¿™ä¸¤ä¸ªå‡½æ•°åœ¨ <code>effect</code> ç­‰éƒ¨åˆ†åšä¾èµ–æ”¶é›†çš„, å¯ä»¥å…ˆä¸ç®¡. å…¶ä»–éƒ¨åˆ†å°±æ˜¯åŸç”ŸåŠŸèƒ½è°ƒç”¨ä¸æƒé™ç®¡ç†</p></li></ol><p><strong><code>effect</code> çš„åŸºæœ¬æµç¨‹</strong></p><p>å¦‚æœè®©æˆ‘å®ç° <code>effect</code> æˆ‘ä¼šæ€ä¹ˆå®ç°å‘¢? æˆ‘å…ˆæƒ³åˆ°çš„æ˜¯åˆ©ç”¨ç¼–è¯‘åŸç†ç­‰é­”æ³•å¯¹ä»£ç åšé™æ€åˆ†æ, æ‰¾åˆ°æ‰€ç”¨å“åº”å¼å¯¹è±¡, åœ¨å“åº”å¼å¯¹è±¡çš„ <code>set</code> ä¸ŠæŒ‚ä¸Šå‡½æ•°. ä½†æ˜¯, JavaScript æ˜¯ä¸ªåŠ¨æ€è¯­è¨€, è¿™å®Œå…¨æ²¡æ³•æŒ‚å•Š! åªèƒ½åœ¨è¿è¡Œæ—¶åŠ¨æ€è§£æ.</p><p>Vue çš„å®ç°å°±æ¯”è¾ƒæµç•…. æ—¢ç„¶æˆ‘ <code>effect</code> è¦ç«‹å³æ‰§è¡Œä¸€éå‡½æ•°, é‚£ä¸ºå•¥ä¸åœ¨æ‰§è¡Œå‰ååšä¸‹ Flag, ä¸€æ—¦ Proxy çš„ <code>get</code> è¢«è°ƒç”¨, è®© <code>get</code> æ£€æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯åœ¨ <code>effect</code> æ‰§è¡Œé˜¶æ®µ, è‹¥æ˜¯å°±æŠŠå‡½æ•°æ³¨å†Œåˆ°è¿™ä¸ªå“åº”å¼å¯¹è±¡ä¸ŠğŸ˜</p><ol type="1"><li><p>è½¬åˆ° <code>mini-vue/../__tests__/reactive.spec.ts</code> çœ‹åˆ° <code>effect</code> çš„ä¸»è¦åŠŸèƒ½æ˜¯ç«‹å³æ‰§è¡Œå‡½æ•°å¹¶åœ¨å“åº”å¼æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶, å»æ‰§è¡Œ <code>effect</code> æ³¨å†Œçš„å‡½æ•°</p></li><li><p>è½¬åˆ° <code>mini-vue/../src/effect.ts</code> çœ‹ <code>effect</code> å‡½æ•°çš„å®ç°. çœ‹åˆ°è¿™é‡Œæœ‰ç†Ÿæ‚‰çš„ <code>effect</code>, <code>track</code>, <code>trigger</code></p><ol type="1"><li><p><code>effect</code> å‡½æ•°å°†ä¼ å…¥å‡½æ•°åŒ…è£…ä¸º <code>ReactiveEffect</code> å¯¹è±¡, åˆå¹¶é…ç½®, æ‰§è¡Œ <code>run</code> å‡½æ•°, æ„é€  <code>runner</code> å¹¶è¿”å›(ç”¨äºåæœŸè°ƒç”¨)</p></li><li><p><code>ReactiveEffect</code> ç±»</p><ul><li><code>active</code>: æ ¹æ® <code>run</code>, <code>stop</code> å‡½æ•°å’Œæµ‹è¯•æ–‡ä»¶ä¸­çš„ <code>it("stop")</code> æ–­è¨€å¯ä»¥æ¨å‡ºå…¶æ˜¯ç”¨æ¥å¼€å…³ <code>effect</code> åŠŸèƒ½çš„</li><li><code>deps</code>: æ ¹æ® <code>track</code> ä¸ <code>trigger</code> å¯¹å…¶è°ƒç”¨å¯ä»¥åˆ¤æ–­å…¶æ˜¯ç”¨æ¥è®°å½•å‡½æ•°å¯¹åº”ä¾èµ–çš„</li><li><code>run</code>: å¯¹ <code>effect</code> æ³¨å†Œå‡½æ•°çš„åŒ…è£…, åœ¨æ‰§è¡Œå‡½æ•°å‰åæ‰“å…¥ <code>shouldTrack</code> æ ‡è®°, å¹¶å°† <code>activeEffect</code> æ ‡è®°ä¸ºè¦æ‰§è¡Œçš„ <code>ReactiveEffect</code> å¥½è®© <code>get</code> çŸ¥é“å“ªä¸ª <code>effect</code> åœ¨è·‘</li></ul></li><li><p><code>track</code> å‡½æ•°: åœ¨ <code>reactive</code> çš„ <code>get</code> ä¸­è°ƒç”¨</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>track</code> å‘ç°è‡ªå·±å¤„äº <code>effect</code> é˜¶æ®µæ—¶ä¼šå…ˆæ£€æŸ¥è‡ªå·±æ‰€åœ¨å¯¹è±¡æœ‰æ²¡æœ‰åˆ›å»º <code>attribute</code> - <code>effect</code> å‡½æ•°heap çš„ <code>map</code>, å¦‚æœæ¯å°±åˆ›å»º, ç„¶åçœ‹ <code>map</code> ä¸Šæœ‰æ²¡æœ‰è®°å½•å½“å‰å±æ€§, å¦‚æœæ²¡æœ‰, å°±å»ºç«‹ä¾èµ–çš„ <code>set</code> å¹¶äº¤ç”± <code>trackEffects</code> åŠ å…¥å¹¶åœ¨ <code>ReactiveEffect</code> ä¸Šä¹Ÿåšè®°å½•.</p></li><li><p><code>trigger</code> å‡½æ•°: åœ¨ <code>reactive</code> çš„ <code>set</code> ä¸­è°ƒç”¨</p><p>å…ˆæ‰¾åˆ°å¯¹åº” <code>attribute</code> çš„ <code>effect</code> ä¾èµ–, å»é‡, æ ¹æ®é…ç½®å»¶è¿Ÿæˆ–ç«‹å³æ”¯æŒ <code>effect</code></p></li></ol></li></ol><p><strong>æ€»ç»“</strong></p><ul><li><code>reactive</code> çš„æµç¨‹: ä¼ å…¥å¯¹è±¡, æŒä¹…åŒ–, ç»‘å®š <code>baseHandlers</code> åšæƒé™ç®¡ç†ä¸ä¾èµ–æ”¶é›†</li><li><code>effect</code> çš„æµç¨‹: å°†ä¼ å…¥å‡½æ•°åŒ…è£…ä¸ºå¯¹è±¡, ç«‹å³æ‰§è¡Œå‡½æ•°å¹¶åšå¥½æ ‡è®°, åœ¨æ‰§è¡Œæ—¶æ”¶é›†ä¾èµ–. æ¯å½“ <code>reactive</code> è¢«è°ƒç”¨æ—¶å°± <code>tigger</code> æ”¶é›†çš„ <code>effect</code>, å¹¶äºŒæ¬¡æ”¶é›†ä¾èµ–</li></ul><p><strong>é—®é¢˜</strong></p><ul><li><p>æ‰€æœ‰çš„ä¾èµ–æ”¶é›†éƒ½æ˜¯åŸºäº <code>get</code>, è¿™æ ·çš„ <code>effect</code> å­˜åœ¨é—®é¢˜</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should observe basic properties'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> dummy<span class="token punctuation">,</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">num</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      dummy <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  counter<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Except 2, Received -1</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸åªæ˜¯ <code>mini-vue</code>, <code>vue/core</code> çš„å•å…ƒæµ‹è¯•ä¹Ÿå­˜åœ¨è¿™ä¸ªé—®é¢˜. ä½†æ˜¯åœ¨ <code>Vue</code> ä»£ç ä¸­å¹¶ä¸ä¼šå‡ºç°æ— æ³•è¿½è¸ªä¾èµ–çš„é—®é¢˜, çœ‹æ¥è¿˜æœ‰ä¸€äº›éšè—çš„ä¼˜åŒ–æ²¡æœ‰æ‰¾åˆ°</p></li></ul><h3 id="runtime-core-çš„åŸºæœ¬æµç¨‹">Runtime-core çš„åŸºæœ¬æµç¨‹</h3><p><code>runtime-core</code> ä¾èµ– <code>Reactivity</code> ä¸º runtime æä¾›æœåŠ¡. å¯ä»¥é€šè¿‡è§‚å¯Ÿ Vue æ–‡ä»¶çš„è¿è¡Œè§‚å¯Ÿ <code>runtime-core</code> çš„åŸºæœ¬æµç¨‹</p><p><strong>æ–‡ä»¶åŸºæœ¬ç»“æ„</strong></p><ol type="1"><li><p>è½¬åˆ° <code>mini-vue/packages/vue/example/helloWorld/</code> çš„æ–‡ä»¶å¤¹äº†è§£ vue çš„åŸºæœ¬å·¥ä½œæµç¨‹</p></li><li><p>è½¬åˆ° <code>mini-vue/../helloWorld/index.html</code>, åªæœ‰ä¸ª <code>div#root</code> å’Œ <code>script</code></p></li><li><p>è½¬åˆ° <code>mini-vue/.../helloWorld/main.js</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createApp <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../dist/mini-vue.esm-bundler.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.js'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> rootContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span>rootContainer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¼•å…¥äº†åˆ›å»ºæ ¹ç»„ä»¶çš„ <code>createApp</code> ä¸æ ¹ç»„ä»¶ <code>App</code>, æŸ¥æ‰¾äº† html æ–‡ä»¶ä¸­å£°æ˜çš„æŒ‚è½½ç‚¹, ç„¶åé€šè¿‡ <code>createApp(App)</code> æ‰“åŒ…æ ¹ç»„ä»¶å†å°†æ‰“åŒ…åç»“æœæŒ‚è½½</p></li><li><p>è½¬åˆ° <code>mini-vue/../helloWorld/App.js</code> å‘ç°å®šä¹‰äº†ä¸¤ä¸ª vue2 é£æ ¼çš„ç»„ä»¶å¯¹è±¡</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'App'</span><span class="token punctuation">,</span> <span class="token comment">// ç»„ä»¶å</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// setup æ–¹æ³•</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// æ¸²æŸ“æ–¹æ³•</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">tId</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'ä¸»é¡µ'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span>HelloWorld<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>å‰é¢æœ‰æåˆ°: <code>compiler-dom</code> å°† <code>&lt;template&gt;</code> æ ‡ç­¾è§£æå¹¶ç¼–è¯‘ä¸º render å‡½æ•°. åœ¨è¿™é‡Œä¸ºäº†ä¸è¿½è¸ª <code>compiler-dom</code> çš„è¡Œä¸º, æˆ‘ä»¬ç›´æ¥å°† <code>render</code> ç»™å‡º</p></li><li><p><code>h</code> ä¸ºæ¸²æŸ“å‡½æ•°, å‚æ•°åˆ†åˆ«æ˜¯: ç»„ä»¶çš„ <code>ElementType</code>, é…ç½®, å­ç»„ä»¶æ•°ç»„, å¯ä»¥çœ‹åˆ°, è¿™é‡Œç¬¬ä¸€ä¸ªå­ç»„ä»¶æ˜¯ä¸€ä¸ª <code>&lt;p&gt;</code> ç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ªç»„ä»¶</p></li><li><p>å¯ä»¥åœ¨å¯¹è±¡ä¸­ä½¿ç”¨ <code>render</code>, ä¹Ÿå¯ä»¥è®© <code>setup</code> è¿”å› <code>render</code> æ–¹æ³•, å³</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'App'</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">tId</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'ä¸»é¡µ'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span>HelloWorld<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p><code>createApp</code> è°ƒç”¨å…³ç³»æ¯”è¾ƒå¤æ‚, ç›´æ¥ä½¿ç”¨ dev-tools è§‚å¯Ÿæ‰§è¡Œè¿‡ç¨‹. æ‰“å¼€ä¸€ä¸ª http æœåŠ¡å™¨å¹¶è½¬åˆ° dev-toolsä¸‹, æ‰¾åˆ° <code>createApp.js</code> å¹¶æ‰“ä¸‹æ–­ç‚¹</p></li><li><p><code>createApp</code> æ–¹æ³•æ¥å—æ ¹ç»„ä»¶é…ç½®å¯¹è±¡ <code>App</code> ç›´æ¥åŒ…äº†ä¸ªå¯¹è±¡, æœ‰</p><ul><li><code>_componment = App</code></li><li><code>mount</code> æ–¹æ³•, çœ‹è¯­ä¹‰, è¿™ä¸ªæ–¹æ³•æ¥æ”¶æŒ‚è½½ç‚¹, å°†æ ¹ç»„ä»¶åˆ›å»ºä¸º <code>VNode</code> å¹¶æŒ‚è½½åˆ°æŒ‚è½½ç‚¹(<code>main.js</code> ä¸­çš„ <code>rootContainer</code>), æ‰§è¡Œå®Œå <code>main.js</code> å°±ç»“æŸäº†</li></ul><p>æˆ‘ä»¬éœ€è¦ç»§ç»­åˆ†æçš„å°±æ˜¯ <code>VNode</code> çš„åˆ›å»ºè¿‡ç¨‹ä¸ <code>render</code> çš„æŒ‚è½½è¿‡ç¨‹</p></li></ol><p><strong>ç»„ä»¶åˆå§‹åŒ–è¿‡ç¨‹</strong></p><ol type="1"><li><p>å•æ­¥è¿›å…¥ <code>createVNode</code> å‘ç°å…¶å£°æ˜äº†ä¸ª <code>vnode</code>.</p><p>å°†ä¼ å…¥å¯¹è±¡(<code>rootComponent / App</code>) ä½œä¸º <code>vnode.type</code></p><p>åœ¨ <code>vnode</code> ä¸Šåˆå¹¶å¯¹è±¡å¹¶é…ç½® <code>shapeFlag</code> ç”¨äºæ ‡è®°ç±»å‹</p><p>ä¹‹åè°ƒç”¨ <code>normalizeChildren</code> å¹¶è¿”å›å¯¹è±¡</p><ul><li>è¿›å…¥ <code>normalizeChildren</code> çœ‹èµ·æ¥æ˜¯ä½œäº† <code>slot</code> ç‰¹åˆ¤</li></ul></li><li><p>å•æ­¥è¿›å…¥ <code>render</code>, å…¶æ¥æ”¶äº†å¤„ç†åçš„ <code>vnode</code> ä¸æŒ‚è½½ç‚¹ <code>rootContainer</code> ç„¶åå°†å‚æ•°ç›´æ¥äº¤ç»™ <code>patch</code>, å¯ä»¥çŒœåˆ° <code>patch</code> ä¼šæ˜¯ä¸€ä¸ªå¾ˆé€šç”¨çš„å‡½æ•°</p><ul><li><p>å•æ­¥è¿›å…¥ <code>patch</code>, å…¶æ¥æ”¶ <code>n1 = null</code>, <code>n2 = vnode</code>, <code>container</code>.</p><p>è§£æ„å‡ºäº†<code>n2</code> çš„ <code>type = App</code> ä¸ <code>shapeFlag</code>,</p><p>é€šè¿‡é¢„å®šä¹‰çš„ <code>Symbol</code> åˆ¤æ–­å¯¹è±¡ç±»å‹, è¿›å…¥ <code>default</code>,</p><p>é€šè¿‡ä½è¿ç®—åˆ¤æ–­ <code>shapeFlag</code> ç±»å‹, è¢«è¯†åˆ«ä¸ºç»„ä»¶ (è€Œä¸æ˜¯åƒ <code>h('p', &#123;&#125;, 'ä¸»é¡µ')</code> ä¸€æ ·çš„ Element) æ‰§è¡Œ <code>processComponent</code></p><ul><li><p>å•æ­¥è¿›å…¥ <code>processComponent</code>,</p><p>å‡½æ•°åšäº†ä¸€ä¸ªåˆ¤æ–­: å¦‚æœæ²¡æœ‰ <code>n1</code> å°±è®¤ä¸º <code>n2</code> è¿˜æ²¡æœ‰è¢«æŒ‚è½½å°±æŒ‚è½½ <code>n2</code> å¦åˆ™æ›´æ–° <code>n2</code></p><ul><li><p>å•æ­¥è¿›å…¥ <code>mountComponent</code>, å…¶æ¥æ”¶äº† <code>vnode</code> ä¸æŒ‚è½½ç‚¹</p><p>å°† <code>vnode</code> è½¬æ¢ä¸ºå®ä¾‹ <code>instance</code>, æ‰§è¡Œ <code>setupComponent</code> å¤„ç† <code>instance</code></p><ul><li><p>å•æ­¥è¿›å…¥ <code>setupComponent</code> å‘ç°å…¶åªæ˜¯å¤„ç†äº† <code>prop</code> ä¸ <code>slot</code> ç„¶åäº¤ç»™ <code>setupStatefulComponent</code> ç»§ç»­é…ç½®</p><ul><li><p>å•æ­¥è¿›å…¥ <code>setupStatefulComponent</code>, å…¶æ¥æ”¶ <code>instance</code></p><p>å°† <code>instance.ctx</code> é…ç½®äº† <code>PublicInstanceProxyHandlers</code> ä»£ç†(åé¢åˆ†æ)</p><p>æå– <code>Component = APP</code>, <code>setup = APP.setup</code></p><p>å¦‚æœ <code>setup</code> ä¸å­˜åœ¨å°±ç›´æ¥ <code>finishComponentSetup</code></p><p>å¦åˆ™ç”¨ <code>setCurrentInstance</code> æ‰“æ ‡è®°, ä¸º <code>setup</code> ä¼ å…¥å‚æ•°å¹¶è·å–æ‰§è¡Œç»“æœ, æ‰§è¡Œ <code>handleSetupResult</code> å¤„ç†ç»“æœ</p><ul><li><p>å•æ­¥è¿›å…¥ <code>handleSetupResult</code> è¯¥å‡½æ•°å¯¹ <code>setup</code> ç»“æœæ‰§è¡Œåˆ¤æ–­</p><p>å¦‚æœæ˜¯ <code>function</code> è¯´æ˜æ˜¯å¯¼å‡ºäº† <code>render</code> å‡½æ•°, å°† <code>render</code> èµ‹å€¼åˆ° <code>instance.render</code> ä¸Š</p><p>å¦åˆ™å¯¼å‡ºçš„å¯¹è±¡å­˜å…¥ <code>isntance.setupState</code></p><p>æœ€åæ‰§è¡Œ <code>finishComponentSetup</code> ä¸æ—  <code>setup</code> çš„æƒ…å†µæ±‡åˆ</p></li><li><p>å•æ­¥è¿›å…¥ <code>finishComponentSetup</code> å…¶æ¥æ”¶ <code>instance</code></p><p>è‹¥ <code>instance</code> ä¸Šæ²¡æœ‰ <code>render</code> å°±å°è¯•ä» <code>template</code> ç¼–è¯‘ç»“æœä¸Šè·å–å¹¶å­˜å…¥ <code>instrance.render</code></p></li></ul></li></ul></li><li><p>å•æ­¥è¿›å…¥ <code>setupRenderEffect</code> å‘ç°å…¶å®šä¹‰ç»‘å®šäº†ä¸€ä¸ª <code>componentUpdateFn</code> å‡½æ•°</p><ul><li><p>æ‰“æ–­ç‚¹å¹¶è¿›å…¥ <code>componentUpdateFn</code> å‡½æ•°</p><p>å¦‚æœç»„ä»¶æ²¡æœ‰è¢«æŒ‚è½½, è·å–å­èŠ‚ç‚¹, è·å– <code>instance</code> çš„ Proxy, æ„å»ºå­èŠ‚ç‚¹ <code>subTree</code> å¹¶é€’å½’ <code>patch</code>, å½“ <code>patch</code> åˆ° Element æ—¶è°ƒç”¨ <code>processElement</code> æŒ‚è½½èŠ‚ç‚¹</p><p>å¦åˆ™æ›´æ–°èŠ‚ç‚¹(åé¢åˆ†æ)</p></li></ul></li></ul></li></ul></li></ul></li></ul></li></ol><p><strong>ç»„ä»¶æ›´æ–°è¿‡ç¨‹</strong></p><p>ä¸ºç»„ä»¶åˆ›å»ºå“åº”å¼å¹¶å°† <code>reavtive</code> å¯¼å‡ºåˆ°å…¨å±€</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'HelloWorld'</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">tId</span><span class="token operator">:</span> <span class="token string">'helloWorld'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello world: count: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ dev-tools ä¸­ä¿®æ”¹ <code>count.value</code> æ ¹æ®è¾“å‡ºæ¥è‡ª <code>effect.ts</code> è¿›å…¥æ–‡ä»¶å¹¶ä¸º <code>run</code> å‡½æ•°æ‰“ä¸Šæ–­ç‚¹, å†æ¬¡ä¿®æ”¹å€¼, å‘ç° <code>run</code> å‡½æ•°å®é™…ä¸Šå°±æ˜¯æ‰§è¡Œäº†å½“æ—¶çš„ <code>componentUpdateFn</code>, ä¸º <code>componentUpdateFn</code> ä¸­å·²æŒ‚è½½çš„åˆ¤æ–­éƒ¨åˆ†æ‰“ä¸Šæ–­ç‚¹</p><ol type="1"><li><p>åœ¨æ–­ç‚¹å¤„æŸ¥çœ‹è°ƒç”¨æ ˆ, ç¡®å®šå‡½æ•°å°±æ˜¯å› ä¸º <code>ref</code> ä¿®æ”¹è€Œå¼•å‘çš„</p></li><li><p>åœ¨æ‰§è¡Œä¿®æ”¹å‰å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰ <code>nextTrick</code> éœ€è¦æ‰§è¡Œ</p></li><li><p>è·å–æ–°èŠ‚ç‚¹çš„ <code>vnode</code></p></li><li><p>å°†è€èŠ‚ç‚¹å­æ ‘å¤åˆ¶åˆ°æ–°èŠ‚ç‚¹</p></li><li><p>è§¦å‘ç”Ÿå‘½å‘¨æœŸå‡½æ•°</p></li><li><p><code>patch</code> æ–°èŠ‚ç‚¹</p><p>å•æ­¥è¿›å…¥ <code>patch</code>, æ¥å—è€èŠ‚ç‚¹ <code>n1</code> æ–°èŠ‚ç‚¹ <code>n2</code> è¿™æ¬¡æ›´æ–°çš„æ˜¯ä¸€ä¸ª Element äºæ˜¯è¿›å…¥ <code>ShapeFlags.ELEMENT</code>, è¿›å…¥ <code>processElement</code></p><ul><li>å•æ­¥è¿›å…¥ <code>processElement</code>, è¿™æ¬¡è€èŠ‚ç‚¹å·²ç»æŒ‚è½½, ç›´æ¥èµ°æ›´æ–°ç¨‹åº<ul><li>å•æ­¥è¿›å…¥ <code>updateElement</code> è¯¥å‡½æ•°åˆ†åˆ«å¯¹æ¯”äº† <code>props</code> ä¸ å­èŠ‚ç‚¹å¹¶æ›´æ–°</li></ul></li></ul></li><li><p>è§¦å‘ç”Ÿå‘½å‘¨æœŸå‡½æ•°</p></li></ol><p><strong>æ€»ç»“</strong></p><pre class="mermaid">graph TB

init((åˆå§‹åŒ–ç»„ä»¶)) --> createAPp[å°†Appäº¤ç»™createApp, å°†AppåŒ…è£…ä¸ºvnode] --- norm1[å°†vnodeåº”ç”¨normalizeChildrené…ç½®, äº¤ç»™renderæ¸²æŸ“]  --> renderdispatch[renderç›´æ¥äº¤ç»™patch] --> check[patchæ£€æŸ¥ç±»å‹] --ä¸ºç»„ä»¶--> processComponent[äº¤ç»™processComponentåˆ¤æ–­çŠ¶æ€] --ä¸ºæ–°èŠ‚ç‚¹--> mountComponent[æ‰§è¡ŒmountComponentæŒ‚è½½vnode: æ„é€ instance, è¿è¡Œ setup, è·å– render] --> effect[æ³¨å†Œrenderçš„effect] --> run[æ‰§è¡Œeffect, æ£€æµ‹æ˜¯å¦æŒ‚è½½]  --æ²¡æœ‰--> patch2(é€’å½’patchå­èŠ‚ç‚¹)

update((reactiveæ›´æ–°)) -.-> run[æ‰§è¡Œeffect, æ£€æµ‹æ˜¯å¦æŒ‚è½½] -.-æŒ‚è½½äº†-.-> newvnode[æ„é€ æ–°vnode, diffæ£€æŸ¥, å¤åˆ¶å±æ€§] -.-> patch2 ==> check

check ==ä¸ºElement==> mountDir(ç›´æ¥ä¿®æ”¹DOM)</pre><h2 id="å®ç°-reactivity">å®ç° Reactivity</h2><h3 id="ç¯å¢ƒæ­å»º">ç¯å¢ƒæ­å»º</h3><ul><li><p>ç›®å½•ç»“æ„</p><p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">.
â”œâ”€â”€ jest.config.js
â”œâ”€â”€ package.json
â”œâ”€â”€ packages
â”‚Â Â  â””â”€â”€ reactivity
â”‚Â Â      â”œâ”€â”€ index.ts # å…¥å£æ–‡ä»¶
â”‚Â Â      â””â”€â”€ __tests__ # æµ‹è¯•æ–‡ä»¶
â”‚Â Â          â””â”€â”€ index.spec.ts
â”œâ”€â”€ README-EN.md
â”œâ”€â”€ README.md
â””â”€â”€ tsconfig.json # tsc --init<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>ä¾èµ–: <code>typescript</code> / <code>@types/node</code> / <code>jest</code> / <code>ts-jest</code> / <code>@types/jest</code></p></li></ul><h3 id="æ„å»ºåŸºæœ¬-effect-ä¸-reactive">æ„å»ºåŸºæœ¬ <code>effect</code> ä¸ <code>reactive</code></h3><p><strong>TDD</strong></p><p>TDD(Test-Driven Development), æ˜¯æ•æ·å¼€å‘ä¸­çš„ä¸€é¡¹æ ¸å¿ƒå®è·µå’ŒæŠ€æœ¯, ä¹Ÿæ˜¯ä¸€ç§è®¾è®¡æ–¹æ³•è®º. TDDçš„åŸç†æ˜¯åœ¨å¼€å‘åŠŸèƒ½ä»£ç ä¹‹å‰, å…ˆç¼–å†™å•å…ƒæµ‹è¯•ç”¨ä¾‹ä»£ç , æµ‹è¯•ä»£ç ç¡®å®šéœ€è¦ç¼–å†™ä»€ä¹ˆäº§å“ä»£ç . TDDè™½æ˜¯æ•æ·æ–¹æ³•çš„æ ¸å¿ƒå®è·µ.</p><p><strong>æ„å»ºåŸºæœ¬çš„ <code>reactive</code></strong></p><p><strong>éœ€æ±‚</strong>: æœ€ç®€å•çš„ <code>reactive</code>, è¾“å…¥å¯¹è±¡å¹¶è¾“å‡ºå¯¹è±¡çš„ä»£ç†. ä»£ç†å¯¹è±¡ä¿®æ”¹æ—¶åŸå¯¹è±¡åŒæ­¥ä¿®æ”¹</p><ol type="1"><li>æµ‹è¯•<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Should different'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¾“å…¥å¯¹è±¡å¹¶è¿”å›ä»£ç†å¯¹è±¡</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// observed å’ŒåŸæ¥çš„ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡</span>
  observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¸¤è€…åŒæ­¥ä¿®æ”¹</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>å®ç° åªéœ€è¦ä¸ºå¯¹è±¡é…ç½®ä¸€ä¸ªæ™®é€šä»£ç†<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// å°±æ˜¯ç»™ä¸€ä¸ªå¯¹è±¡, è¿”å›ä¸€ä¸ª new Proxy</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// è¯­æ³•è§ https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/get</span>
    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token comment">// è¯­æ³•è§ https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/set</span>
    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>å”¯ä¸€çš„éš¾ç‚¹å°±æ˜¯ <code>Proxy</code> è¯­æ³•</li><li>é‡æ„: æ— </li></ol><p><strong>æ„å»ºåŸºæœ¬çš„ <code>effect</code></strong></p><p><strong>éœ€æ±‚</strong>: 1. è¾“å…¥å‡½æ•°, æ‰§è¡Œå‡½æ•°, å½“å‡½æ•°ä¸­è¢« <code>[GET]</code> çš„å“åº”å¼å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°æ‰§è¡Œå‡½æ•° 2. è¿”å›ä¸€ä¸ªå‡½æ•° <code>runner</code>, å½“æ‰§è¡Œ <code>runner</code> æ—¶æ‰§è¡Œ <code>effect</code> ä¼ å…¥çš„å‡½æ•°</p><p><strong>éœ€æ±‚åˆ†æ</strong>: 1. ä¸ºä»€ä¹ˆæ˜¯å‡½æ•°ä¸­è¢« <code>[GET]</code> çš„å“åº”å¼å¯¹è±¡å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œå‡½æ•°, <code>[SET]</code> ä¸è¡Œå—? ä¸è¡Œ, å“åº”å¼å¯¹è±¡è¢« <code>[SET]</code> åå¦‚æœæ‰§è¡Œäº†å‡½æ•°, å“åº”å¼å¯¹è±¡ä¼šè¢«é‡æ–° <code>[SET]</code>, é‚£ä¹ˆä¸Šä¸€æ¬¡ <code>[SET]</code> å°±æ²¡ç”¨äº†. åŒæ—¶å¦‚æœå‡½æ•°ä¸­å…¶ä»–å˜é‡ä¸å˜åªæœ‰å“åº”å¼å¯¹è±¡è¢« <code>[SET]</code> æ­¤æ—¶æ‰§è¡Œå‡½æ•°å¹¶ä¸ä¼šä½¿å¾—å‡½æ•°ä¸­å˜é‡å€¼å‘ç”Ÿå˜åŒ–(æ¯•ç«Ÿå˜åŒ–çš„å“åº”å¼å˜é‡æ²¡æœ‰è¢« <code>[GET]</code>), ä¸ä¼šäº§ç”Ÿ sideEffect. 2. æ‰§è¡Œæµç¨‹: å¼€å§‹æ‰§è¡Œå‡½æ•° -&gt; <code>[GET]</code> å“åº”å¼å¯¹è±¡ -&gt; ç»“æŸæ‰§è¡Œå‡½æ•° -&gt; å½“å“åº”å¼å¯¹è±¡è¢« <code>[SET]</code> -&gt; æ‰§è¡Œå‡½æ•° å¯ä»¥å‘ç°åªéœ€è¦è®©å“åº”å¼å¯¹è±¡çŸ¥é“å½“è‡ªå·±å˜åŒ–æ—¶å“ªäº› <code>effect</code> éœ€è¦æ‰§è¡Œå°±å¯ä»¥äº†, è‡³äº <code>effect</code> çŸ¥ä¸çŸ¥é“å“åº”å¼å¯¹è±¡æ˜¯è°é‚£æ— æ‰€è°“. å¯ä»¥åœ¨å‡½æ•°æ‰§è¡ŒæœŸé—´æ‰§è¡Œä¾èµ–æ”¶é›†, ä¸º <code>[GET]</code> çš„å“åº”å¼å¯¹è±¡æ³¨å†Œ Effect Function, åœ¨å“åº”å¼å¯¹è±¡ä¿®æ”¹æ—¶æ‰§è¡Œå…¶æ³¨å†Œçš„ Effect Function.</p><p>Â </p><ol type="1"><li>æµ‹è¯•:<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Effect test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Should sync'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> bar<span class="token punctuation">;</span>
    <span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      bar <span class="token operator">=</span> observed<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// origin -> observed</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç«‹å³æ‰§è¡Œ fn</span>
    observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// ä¿®æ”¹æœ‰ [GET] çš„å“åº”å¼å¯¹è±¡</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å“åº”å¼å¯¹è±¡å˜åŒ–</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åŸå¯¹è±¡å˜åŒ–</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‰§è¡Œå‡½æ•°</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Should return runner'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span>info <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åŠ«æŒ console.info</span>
    <span class="token keyword">let</span> bar<span class="token punctuation">;</span>
    <span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'I RUN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bar <span class="token operator">=</span> observed<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç«‹å³æ‰§è¡Œ fn, console.info è¢«è°ƒç”¨ 1 æ¬¡</span>
    observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å“åº”å¼å¯¹è±¡å‘ç”Ÿå˜åŒ–æ‰§è¡Œ fn, console.info è¢«è°ƒç”¨ 2 æ¬¡</span>
    <span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‰‹åŠ¨è°ƒç”¨ runner, console.info è¢«è°ƒç”¨ 3 æ¬¡</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>å®ç° åˆ©ç”¨ <code>targetMap</code> å®ç°å“åº”å¼å¯¹è±¡ -&gt; Key -&gt; Effective Function çš„æ˜ å°„. å¯¼å‡º <code>track</code> ä¸ <code>trigger</code> ç”¨äºæ”¶é›†ä¸è§¦å‘ä¾èµ–<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// target: Object => keyMap:(string=>Set)</span>
<span class="token comment">// keyMap: string => Set</span>
<span class="token keyword">const</span> <span class="token literal-property property">targetMap</span><span class="token operator">:</span> Map<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>EffectReactive<span class="token operator">>>></span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token literal-property property">activeEffectFn</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">EffectReactive</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">runner</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> any<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>runner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    activeEffectFn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// å…¨å±€æ³¨å†Œå½“å‰æ­£åœ¨æ”¶é›†ä¾èµ–çš„ Effect</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‰§è¡Œå‡½æ•°</span>
    activeEffectFn <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// å–æ¶ˆæ³¨å†Œ</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// è€ƒè™‘åˆ° effect ä¸ŠåŠ¨ä½œå¾ˆå¤š, æˆ‘ä»¬å°†å…¶æŠ½ç¦»ä¸º EffectFunction å‡½æ•°</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EffectReactive</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">.</span>runner<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// ä¾èµ–æ”¶é›†å‡½æ•°, ç”± `[GET]` è§¦å‘, è¯¥å‡½æ•°æ£€æŸ¥æ˜¯å¦æœ‰ active çš„ Effect, æœ‰å°±æ”¶é›†ä¾èµ–</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>targetMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> keyMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> keyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> dependenceEffect <span class="token operator">=</span> keyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  dependenceEffect<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// è§¦å‘å‡½æ•°, å½“å“åº”å¼å¯¹è±¡è¢« `[SET]` æ—¶å°è¯•è§¦å‘å…¶æ”¶é›†çš„æ‰€æœ‰ Effect</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> keyMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyMap<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> depSet <span class="token operator">=</span> keyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depSet<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span><span class="token operator">...</span>depSet<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>åœ¨ <code>Proxy</code> ä¸ŠåŒæ­¥ä¿®æ”¹<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">export function reactive(origin) &#123;
  return new Proxy(origin, &#123;
    get(target, key, receiver) &#123;
+     track(target, key);
      return Reflect.get(target, key, receiver);
    &#125;,
    set(target, key, value, receiver) &#123;
+     &#x2F;&#x2F; è¿™ä¸¤è¡Œé¡ºåºåäº†å°±å¯„äº†
      const res &#x3D; Reflect.set(target, key, value, receiver);
+     trigger(target, key);
      return res;
    &#125;,
  &#125;);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>é‡æ„: ä¸Šé¢è¿™ä¸ªä»£ç æœ‰ç‚¹é—®é¢˜, æˆ‘ä»¬åªåœ¨æ„é€  EffectFunction æ—¶æ”¶é›†äº†ä¾èµ–, ä½†æ˜¯å¹¶ä¸èƒ½æ”¶é›†å…¨<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'dym track'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observe1 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> origin2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observe2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    ob <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      ob <span class="token operator">=</span> observe1<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      ob <span class="token operator">=</span> observe2<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    cnt<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>ob<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  observe1<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>ob<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  observe2<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>ob<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>è¿™ä¸ªæµ‹è¯•å°±æ— æ³•é€šè¿‡, å› ä¸º <code>observe2</code> ç†è®ºä¸Šåº”è¯¥åœ¨ <code>observe1.set</code> è°ƒç”¨ <code>run</code> çš„æ—¶å€™æ”¶é›†ä¾èµ–, æ‰€ä»¥åº”è¯¥ä¿®æ”¹æ„é€ å‡½æ•°å’Œ <code>run</code> ä¸º<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> fn<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  activeEffect <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>æˆ‘ä»¬çŸ¥é“, æ‰€æœ‰çš„ä¾èµ–æ”¶é›†éƒ½æ˜¯é€šè¿‡ fn ä¸­å¯¹ reactive çš„ <code>[GET]</code> å®ç°çš„, æˆ‘å¯ä»¥ä¿è¯åªè¦æ‰§è¡Œ <code>fn</code> åœ¨å…¶å‰åéƒ½åŠ å…¥äº†ä¾èµ–æ”¶é›†çš„ flag å°±å¯ä»¥. è°ƒç”¨ <code>fn</code> åªå¯èƒ½å‘ç”Ÿåœ¨</li><li>æ„é€ å‡½æ•°</li><li>æ‰‹åŠ¨æ‰§è¡Œ <code>runner</code></li><li>reactive æ‰§è¡Œ <code>[SET]</code> è§¦å‘ trigger</li></ol><p>è¿™ä¸‰éƒ¨åˆ†è¦æ‰§è¡Œçš„éƒ½æ˜¯ <code>run</code> æˆ‘ä»¬å¯ä»¥ä¿è¯åªè¦æ‰§è¡Œ <code>run</code> å°±è§¦å‘ä¾èµ–æ”¶é›†</p><h3 id="æ„å»º-effect-çš„-scheduler-é€‰é¡¹-watch">æ„å»º <code>effect</code> çš„ <code>scheduler</code> é€‰é¡¹ (<code>watch</code>)</h3><p><strong>éœ€æ±‚</strong>: ä¸º <code>effect</code> ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°, å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡, å…¶ä¸­åŒ…å« <code>scheduler</code> å‡½æ•°, å½“æ„é€  Effect æ—¶æ‰§è¡Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‡½æ•°å‚æ•°, å½“å“åº”å¼å‡½æ•°å˜åŒ–æ—¶æ‰§è¡Œ <code>scheduler</code> å‡½æ•°. è¿™ä¸ Vue 3 çš„ <code>watch</code> ç±»ä¼¼</p><p><strong>éœ€æ±‚åˆ†æ</strong>: åœ¨æ„é€  Effect çš„æ—¶å€™ä¼ å…¥é…ç½®å¹¶åœ¨è§¦å‘çš„æ—¶å€™åˆ¤æ–­æ˜¯å¦æœ‰ <code>scheduler</code> å‡½æ•°</p><ol type="1"><li>æµ‹è¯•</li></ol><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Shound run scheduler'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> bar<span class="token punctuation">;</span>
  <span class="token function">effect</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      bar <span class="token operator">=</span> observed<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span> <span class="token comment">// ä¼ å…¥é…ç½®</span>
      <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        bar <span class="token operator">=</span> <span class="token operator">-</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç¬¬ä¸€æ¬¡è¿è¡Œ fn å‡½æ•°</span>
  observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç¬¬äºŒæ¬¡è¿è¡Œ scheduler å‡½æ•°</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><ol start="2" type="1"><li>å®ç°</li></ol><ul><li>ä¿®æ”¹ effect å‡½æ•°, åŠ å…¥é…ç½®é¡¹<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EffectReactive</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">.</span>runner<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li>ä¿®æ”¹ EffectReactive çš„æ„é€ å‡½æ•°åŠ è½½é…ç½®é¡¹<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">EffectReactive</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">runner</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> any<span class="token punctuation">;</span>
  <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> any <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> fn<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scheduler <span class="token operator">=</span> options<span class="token punctuation">.</span>scheduler<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>ä¿®æ”¹è§¦å‘å‡½æ•°<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token punctuation">[</span><span class="token operator">...</span>depSet<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>scheduler <span class="token operator">?</span> d<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> d<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li>é‡æ„: æ— </li></ul><p><strong>ä»€ä¹ˆæ—¶å€™å°è¯•æŠ½ç¦»å‡½æ•° / å¯¹è±¡</strong></p><ol type="1"><li>å‡½æ•°ä¸Šæœ‰å¾ˆå¤šåŠ¨ä½œ</li><li>å‡½æ•°ä½œç”¨èŒƒå›´å¹¿, è¯­ä¹‰å·®</li></ol><h3 id="æ„å»º-effect-çš„-stop-ä¸-onstop-é€‰é¡¹">æ„å»º <code>effect</code> çš„ <code>stop</code> ä¸ <code>onStop</code> é€‰é¡¹</h3><p><strong>éœ€æ±‚</strong>: 1. å®šä¹‰ä¸€ä¸ªå¤–éƒ¨å‡½æ•° <code>stop</code>. ä¼ å…¥ <code>runner</code> è®© <code>runner</code> ä¸å†è¢«å“åº”å¼å¯¹è±¡ trigger 2. <code>effect</code> ä¸­åŠ å…¥ <code>onStop</code> é…ç½®, åœ¨ <code>stop</code> æ—¶è°ƒç”¨</p><p><strong>éœ€æ±‚åˆ†æ</strong>: åªéœ€è¦å°† EffectFunction ä»å“åº”å¼å¯¹è±¡çš„ä¾èµ–è¡¨ä¸­åˆ é™¤å³å¯. ä½†æ˜¯æˆ‘ä»¬ä¹‹å‰å°±æ²¡è®°å½•æœ‰å“ªäº›å“åº”å¼å¯¹è±¡å°† EffectFunction ä½œä¸ºä¾èµ–..., æ‰€ä»¥éœ€è¦å¼€ä¸€ä¸ª Set è®°å½•è¿™äº›å“åº”å¼å¯¹è±¡. åŒæ—¶, æˆ‘ä»¬ä¸éœ€è¦è®°å½•ä¾èµ–çš„å¯¹è±¡æ˜¯ä»€ä¹ˆ, åªéœ€è¦è®°å½• KeyMap å¯¹åº”çš„ Set.</p><ol type="1"><li>æµ‹è¯•<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Should stop trigger'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> bar<span class="token punctuation">;</span>
  <span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      bar <span class="token operator">=</span> observed<span class="token punctuation">.</span>foo<span class="token punctuation">;</span> <span class="token comment">// ç«‹å³æ‰§è¡Œ</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bar <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> bar <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// å¦‚æœé¦–æ¬¡è°ƒç”¨ç½® 0</span>
        bar<span class="token operator">--</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç«‹å³æ‰§è¡Œ</span>
  <span class="token function">stop</span><span class="token punctuation">(</span>runner<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åœæ­¢åç¬¬ä¸€æ¬¡æ‰§è¡Œä¸º -1</span>
  observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// reactive å˜åŒ–ä¹Ÿä¸è°ƒç”¨ fn</span>
  <span class="token function">stop</span><span class="token punctuation">(</span>runner<span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åå¤ stop ä¸åå¤æ‰§è¡Œ onStop</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>å®ç° ä¿®æ­£ EffectReactive<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">EffectReactive</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">runner</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// effect åªè¿”å› runner, stop å‡½æ•°éœ€è¦æ ¹æ® runner æ‰¾åˆ° EffectReactive, æ‰€ä»¥è¦åœ¨å‡½æ•°ä¸ŠåŠ ä¸€ä¸ªå±æ€§è®°å½•ä¸€ä¸‹</span>
    <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
    effect<span class="token operator">?</span><span class="token operator">:</span> EffectReactive<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token function-variable function">onStop</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> any <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// stop å›è°ƒ</span>
  <span class="token literal-property property">deps</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>Set<span class="token operator">&lt;</span>EffectReactive<span class="token operator">>></span><span class="token punctuation">;</span> <span class="token comment">// æ”¶é›†äº†è¿™ä¸ªå‡½æ•°ä¾èµ–çš„å˜é‡çš„ä¾èµ–è¡¨é›†åˆ</span>
  <span class="token literal-property property">active</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span> <span class="token comment">// EffectReactive æ˜¯å¦è¿è¡Œ (stop æ—¶ç½® 0)</span>
  <span class="token comment">// ...</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> fn<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>runner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>runner<span class="token punctuation">.</span>effect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onStop <span class="token operator">=</span> options<span class="token punctuation">.</span>onStop<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// å¦‚æœç”¨æˆ·æ‰‹åŠ¨æ‰§è¡Œ runner é‚£ä¹ˆåªæ‰§è¡Œ fn, ä¸è¿½è¸ªä¾èµ–, æ”¾ç½®ä¾èµ–è¿½è¸ªç»™å·²ç»è§£é™¤ä¾èµ–çš„å…ƒç´ å†ç»‘å®šä¸Šä¾èµ–</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    activeEffect <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>ä¿®æ­£ä¾èµ–æ”¶é›†å‡½æ•°<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//</span>
  dependenceEffect<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ä¸ºå½“å‰æ­£åœ¨ä¾èµ–æ”¶é›†çš„ effect çš„ä¾èµ–ä¸ŠåŠ å…¥è¿™ä¸ª key çš„ä¾èµ–è¡¨</span>
  activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependenceEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>å®ç° <code>stop</code> å‡½æ•°<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token parameter">runner</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ä¸åå¤æ‰§è¡Œ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>runner<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  runner<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// æ‰¾åˆ°æ‰€æœ‰æ”¶é›†è¿‡ effect çš„å˜é‡, å°† effect ä»ä¾èµ–è¡¨ä¸­åˆ é™¤</span>
  <span class="token punctuation">[</span><span class="token operator">...</span>runner<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>deps<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>effect<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ‰§è¡Œ onStop</span>
  runner<span class="token punctuation">.</span>effect<span class="token punctuation">.</span>onStop <span class="token operator">&amp;&amp;</span> runner<span class="token punctuation">.</span>effect<span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>é‡æ„: æ— </li></ol><h3 id="æ„å»º-proxy-çš„-readonly">æ„å»º <code>Proxy</code> çš„ <code>Readonly</code></h3><p><strong>éœ€æ±‚</strong>: <code>readonly</code> ä¸ <code>reactive</code> ç±»ä¼¼, ä¸è¿‡ä¸æ”¯æŒ <code>set</code></p><p><strong>éœ€æ±‚åˆ†æ</strong>: ä¸€ä¸ªå…ƒç´ ä¸æ”¯æŒ <code>set</code> ä¹Ÿå°±ä¸å¯èƒ½è§¦å‘ä¾èµ–, æ‰€ä»¥ä¹Ÿæ²¡æœ‰å¿…è¦åšä¾èµ–æ”¶é›†. æ‰€ä»¥åªéœ€è¦ç²¾ç®€ä¸€ä¸‹ <code>reactive</code>. å¯ä»¥å‘ç°, ä¸åŒæƒé™çš„å˜é‡åªæ˜¯åœ¨æ„é€ çš„æ—¶å€™é‡‡ç”¨ä¸åŒçš„ <code>[GET]</code> ä¸ <code>[SET]</code> ç­–ç•¥. å¯ä»¥å°† <code>[GET]</code> ä¸ <code>[SET]</code> æŠ½ç¦»å‡ºæ¥</p><ol type="1"><li>æµ‹è¯•<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Happy path'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span>warn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†åŸå§‹å¯¹è±¡åŒ…è£…ä¸ºåªè¯»å¯¹è±¡</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æœ€å¼€å§‹ä¸æŠ¥é”™</span>
  observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// ä¿®æ”¹, é™é»˜å¤±æ•ˆ, æŠ¥ warning</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// warning è¢«è°ƒç”¨ä¸€æ¬¡</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// readOnly é™é»˜å¤±æ•ˆ</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>å®ç° æŠ½ç¦» <code>[GET]</code> ä¸ <code>[SET]</code><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// reactive çš„ [GET]</span>
<span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// reactive çš„ [SET]</span>
<span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">getReadonly</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">setReadonly</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Can not set readonly'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¦è¿”å›ä¸€ä¸‹è®¾ç½®ç»“æœ, å¦‚æœè¿”å› false ä¼šæŠ›å‡ºå¼‚å¸¸, è€Œæˆ‘ä»¬åªå¸Œæœ›é™é»˜å¤±æ•ˆ</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> proxyConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  get<span class="token punctuation">,</span>
  set<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> proxyReadonlyConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">get</span><span class="token operator">:</span> getReadonly<span class="token punctuation">,</span>
  <span class="token literal-property property">set</span><span class="token operator">:</span> setReadonly<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>æŠ½ç¦»å¯¹è±¡åˆ›å»ºå‡½æ•°<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span><span class="token parameter">origin<span class="token punctuation">,</span> readonly <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>readonly<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> proxyReadonlyConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> proxyConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>é‡å†™ <code>reactive</code> æ„å»º <code>readonly</code><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>é‡æ„: ä¸Šé¢çš„å°±æ˜¯é‡æ„åçš„ä»£ç </li></ol><h3 id="æ„å»ºå·¥å…·å‡½æ•°-isreadonly-isreactive-isproxy">æ„å»ºå·¥å…·å‡½æ•° <code>isReadonly</code>, <code>isReactive</code>, <code>isProxy</code></h3><p><strong>éœ€æ±‚</strong>: æ„å»ºå·¥å…·å‡½æ•°, <code>isReadonly</code>, <code>isReactive</code>, <code>isProxy</code>(å‰ä¸¤ä¸ªå‡½æ•°äºŒé€‰ä¸€).</p><p><strong>éœ€æ±‚åˆ†æ</strong>: åªéœ€è¦åœ¨ <code>[GET]</code> ä¸Šç‰¹åˆ¤å³å¯</p><ol type="1"><li>æµ‹è¯•<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'isReadonly test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReadonly</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'isReactive test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReadonly</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'isProxy test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isProxy</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>å®ç° æ„é€ ä¸ªæšä¸¾<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> ReactiveFlag <span class="token punctuation">&#123;</span>
  <span class="token constant">IS_REACTIVE</span> <span class="token operator">=</span> <span class="token string">'__v_isReactive'</span><span class="token punctuation">,</span>
  <span class="token constant">IS_READONLY</span> <span class="token operator">=</span> <span class="token string">'__v_isReadonly'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>å®ç°å‡½æ•°<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isReactive</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// è¦è½¬ä¸€ä¸‹ Boolean å› ä¸ºé reactive å¯¹è±¡ä¼šè¿”å› undefined</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>value<span class="token punctuation">[</span>ReactiveFlag<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isReadonly</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>value<span class="token punctuation">[</span>ReactiveFlag<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isProxy</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">isReactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isReadonly</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>ä¿®æ”¹ <code>[GET]</code><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> reactiveFlags <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">[</span>ReactiveFlag<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>ReactiveFlag<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> readonlyFlags <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">[</span>ReactiveFlag<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>ReactiveFlag<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reactiveFlags<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token operator">=></span>d<span class="token operator">===</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> reactiveFlags<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">getReadonly</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>readonlyFlags<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token operator">=></span>d<span class="token operator">===</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> readonlyFlags<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>é‡æ„: æ— </li></ol><h3 id="å®ç°-reactive-readonly-åµŒå¥—">å®ç° <code>reactive</code> / <code>readonly</code> åµŒå¥—</h3><p><strong>éœ€æ±‚:</strong> è‹¥ <code>reactive</code> / <code>readonly</code> å†…éƒ¨ value ä¸ºå¯¹è±¡, é‚£ä¹ˆè¯¥å¯¹è±¡ä¹Ÿåº”è¯¥æ˜¯ <code>reactive</code> / <code>readonly</code></p><p><strong>éœ€æ±‚åˆ†æ:</strong> æˆ‘æœ€å¼€å§‹çš„æƒ³æ³•æ˜¯åœ¨æ„é€  <code>reactive</code> çš„æ—¶å€™éå†æ‰€æœ‰å±æ€§, ç„¶åä¸ºè¿™äº›å±æ€§é…ç½® <code>reactive</code>. ç„¶è€Œ, è¿™æ— æ³•å°†åŠ¨æ€æ·»åŠ çš„å¯¹è±¡è½¬ä¸º <code>reactive</code>. è€ƒè™‘éœ€æ±‚, æˆ‘ä»¬å¸Œæœ›è®©å†…å±‚å¯¹è±¡æ”¯æŒ reactive, å®é™…ä¸Šæ˜¯å¸Œæœ›è®©å†…å±‚å¯¹è±¡ä¹Ÿæ”¯æŒä¾èµ–æ”¶é›†ç­‰ <code>reactive</code> åŠŸèƒ½, è€Œè¿™äº›åŠŸèƒ½éƒ½æ˜¯åœ¨å¯¹è±¡è¢« <code>[GET]</code> çš„æ—¶å€™è¢«æ¿€æ´»çš„. ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æœ€æ™šå¯ä»¥åœ¨é¦–æ¬¡è®¿é—®å±æ€§çš„å°†å†…å±‚å¯¹è±¡è½¬æ¢ä¸º <code>reactive</code>.</p><ol type="1"><li>æµ‹è¯•(åªå†™äº† <code>reactive</code> çš„)<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Should nested track'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observe <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observe<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observe<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observe<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observe<span class="token punctuation">.</span>bar<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>å®ç° åªéœ€è¦åœ¨ <code>[GET]</code> çš„æ—¶å€™åˆ¤æ–­å±æ€§æ˜¯å¦æ˜¯å¯¹è±¡, å¦‚æœæ˜¯å¯¹è±¡é‚£ä¹ˆè¿”å›åŒ…è£…åçš„ <code>reactive</code></li></ol><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reactiveFlags<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d <span class="token operator">===</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> reactiveFlags<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è·å–ç»“æœ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¦‚æœç»“æœæ˜¯å¯¹è±¡, å°†å…¶åŒ…è£…ä¸º reactive</span>
  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">getReadonly</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>readonlyFlags<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d <span class="token operator">===</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> readonlyFlags<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è·å–ç»“æœ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">readonly</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¦‚æœç»“æœæ˜¯å¯¹è±¡, å°†å…¶åŒ…è£…ä¸º readonly</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>åœ¨ <code>packages/share/index.ts</code> ä¸­æ„é€ å·¥å…·å‡½æ•°åˆ¤æ–­è¾“å…¥æ˜¯å¦æ˜¯å¯¹è±¡<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> v <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> v <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>3. æ”¹è¿›: æˆ‘ä»¬å¹¶æ²¡æœ‰å®ç°å†…å±‚ reactive çš„æŒä¹…åŒ–, ä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡ reactive çš„ç»“æœæ˜¯ä¸åŒçš„... å®ç°å†…å±‚å¯¹è±¡æŒä¹…åŒ–<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> reactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> readonlyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reactiveMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span>
    reactiveMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> reactiveMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>readonlyMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span>
    readonlyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> readonlyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p><strong>æ³¨æ„</strong></p><ol type="1"><li><strong>JSæ˜¯åŠ¨æ€è¯­è¨€, ä¸è¦å°è¯•åšé™æ€ä»£ç åˆ†æ</strong>: æˆ‘ä»¬åœ¨å®ç°åŠŸèƒ½çš„æ—¶å€™åº”è¯¥è€ƒè™‘ä»€ä¹ˆæ—¶å€™å®Œæˆå·¥ä½œä¸æ™š, ä¸é—æ¼è€Œä¸æ˜¯ç›¸é™æ€è¯­è¨€ä¸€æ ·æƒ³ä»€ä¹ˆæ—¶å€™å¯ä»¥æ“ä½œæ•°æ®</li><li><strong>å®ç°åŠŸèƒ½æ—¶æƒ³æƒ³è¿™ä¸ªåŠŸèƒ½å¸Œæœ›æˆ‘ä»¬å¯¹å¤–è¡¨ç°ä¸ºä»€ä¹ˆæ ·å­</strong>: æ€è€ƒæ˜¯ä»€ä¹ˆè€Œä¸æ˜¯æ€ä¹ˆåš, æ¯”å¦‚å†…å±‚ reactive çš„ç¬¬ä¸€ç‰ˆä»£ç å¹¶æ²¡æœ‰å®ç°å°†å¯¹è±¡è½¬ä¸º reactive å¹¶é™„ç€åœ¨å¯¹è±¡ä¸Š, è€Œæ˜¯è€ƒè™‘å¦‚æœä¸€ä¸ªå†…å±‚å¯¹è±¡æ˜¯ reactive, é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥åœ¨ <code>[GET]</code> çš„æ—¶å€™è¡¨ç°çš„ä¸åŸå§‹å¯¹è±¡ä¸åŒ. è¿™å°±å¯å‘æˆ‘ä»¬åªéœ€è¦åœ¨ <code>[GET]</code> çš„æ—¶å€™å¤„ç†æ•°æ®å°±å¯ä»¥è€Œä¸éœ€è¦åœ¨æ„é€ å¯¹è±¡çš„æ—¶å€™å®ç°è¿™ä¸€åŠŸèƒ½.</li></ol><h3 id="æ„å»º-shadowreadonly">æ„å»º <code>shadowReadonly</code></h3><p><strong>éœ€æ±‚:</strong> <code>shadowReadonly</code> å°±æ˜¯åªå¯¹å¯¹è±¡å¤–å±‚å®ç° readonly, å†…éƒ¨å¯¹è±¡ä¸ç®¡, ä¸ Proxy</p><p><strong>éœ€æ±‚åˆ†æ:</strong> å®é™…ä¸Šå°±æ˜¯ä¸æ”¯æŒåµŒå¥—çš„ readonly</p><ol type="1"><li>æµ‹è¯•<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Happy path'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">shadowReadonly</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span>warn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// å¤–å±‚ç¦æ­¢ä¿®æ”¹</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  observed<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// å†…éƒ¨ä¸ç®¡</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>warn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isProxy</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>å®ç°<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">getShadowReadonly</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>readonlyFlags<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d <span class="token operator">===</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> readonlyFlags<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// å…¶å®å°±æ˜¯ä¸æ”¯æŒåµŒå¥—è¿½è¸ªçš„ readonly. shadowReadonly çš„å…ƒç´ ä¸€å®šæ˜¯é reactive å¯¹è±¡, æ‰€ä»¥ç›´æ¥è¿”å›</span>
  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> proxyShadowReadonlyConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">get</span><span class="token operator">:</span> getShadowReadonly<span class="token punctuation">,</span>
  <span class="token literal-property property">set</span><span class="token operator">:</span> setReadonly<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>å®ç° shadowReadonly<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> shadowReadonlyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span><span class="token parameter">origin<span class="token punctuation">,</span> readonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shadow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shadow <span class="token operator">&amp;&amp;</span> readonly<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> proxyShadowReadonlyConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>readonly<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> proxyReadonlyConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> proxyConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">shadowReadonly</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shadowReadonlyMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span>
    shadowReadonlyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> shadowReadonlyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>é‡æ„</li></ol><h3 id="æ„å»º-ref">æ„å»º <code>ref</code></h3><p><strong>éœ€æ±‚</strong>: å®ç° <code>ref</code> - å¦‚æœ <code>ref(value)</code> è¾“å…¥çš„æ˜¯ä¸æ˜¯å¯¹è±¡, é‚£ä¹ˆå¯ä»¥ - é€šè¿‡ <code>.value</code> è®¿é—®å€¼ - é€šè¿‡ <code>.value</code> æ›´æ–°å€¼, å¦‚æœèµ‹å€¼æ—¶æ–°å€¼ä¸æ—§å€¼ä¸€æ ·åˆ™ä»€ä¹ˆéƒ½ä¸åš - æ”¯æŒç±»ä¼¼ <code>reactive</code> çš„ä¾èµ–æ”¶é›†ä¸è§¦å‘ - å¦‚æœ <code>ref(value)</code> è¾“å…¥çš„æ˜¯å¯¹è±¡, é‚£ä¹ˆå¯ä»¥ - åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šå¯¹è¦æ±‚å¯¹è±¡æ”¯æŒ <code>reactive</code></p><p><strong>éœ€æ±‚åˆ†æ</strong>:</p><ul><li>æˆ‘æœ€å¼€å§‹æƒ³åˆ°çš„æ˜¯ <code>ref = (value) =&gt; reactive(&#123;value&#125;)</code> ä½†æ˜¯å¦‚æœåªæ˜¯è¿™ä¹ˆç®€å•å®ç°, é‚£ä¹ˆ <code>ref</code> çš„é <code>value</code> å±æ€§ä¹Ÿå°†å˜ä¸º <code>reactive</code>. åŒæ—¶å¯ä»¥é¢„è§è¿™æ ·å®ç°çš„ <code>ref</code> æ€§èƒ½ä¸åŠæ ‡å‡† <code>ref</code>.</li><li><code>ref</code> çš„ç‰¹ç‚¹æ˜¯<strong>å¤–å±‚æœ‰ä¸”åªæœ‰</strong> <code>value</code> ä¸€ä¸ª <code>key</code>, è¿™æ„å‘³æˆ‘ä»¬åœ¨å®ç°æ—¶<ul><li>ä¸ç”¨ä½¿ç”¨å…¨å±€ <code>targetMap</code> (åªæœ‰ä¸€ä¸ªdepSet)</li><li>ä¸ç”¨åƒ <code>reactive</code> ä¸€æ ·å®ç°ä¸€ä¸ª Proxy, å¯ä»¥åªå®ç°ä¸€ä¸ª <code>[GET]</code> &amp; <code>[SET]</code>.</li></ul></li><li>è€ƒè™‘åˆ° <code>ref</code> çš„<strong>è¾“å…¥å¯èƒ½æ˜¯å¯¹è±¡æˆ–éå¯¹è±¡</strong><ul><li>æˆ‘ä»¬èƒ½ä¸ä½¿ç”¨å…¨å±€çš„ <code>targetMap</code>, å¦åˆ™ä¸¤ä¸ªå€¼ç›¸åŒçš„ <code>ref</code> ä¼šè¢«åˆ¤å®šä¸ºåŒä¸€ä¸ª <code>keyMap</code></li><li>è‹¥è¾“å…¥ä¸ºå¯¹è±¡, åœ¨å¯¹æ¯”èµ‹å€¼æ—¶æ–°å€¼ä¸æ—§å€¼ä¸€æ ·ä¸èƒ½ç®€å•çš„æ¯”è¾ƒ <code>_value === newValue</code>. è‹¥è¾“å…¥ä¸ºå¯¹è±¡, é‚£ä¹ˆ <code>reactive(obj) !== obj</code>. æˆ‘ä»¬è¿˜éœ€è¦ä¿å­˜è¾“å…¥çš„åŸå§‹å€¼</li></ul></li></ul><ol type="1"><li><p>æµ‹è¯• <code>ref</code> éå¯¹è±¡æ—¶<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should be reactive'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> dummy<span class="token punctuation">;</span>
  <span class="token keyword">let</span> calls <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    calls<span class="token operator">++</span><span class="token punctuation">;</span>
    dummy <span class="token operator">=</span> a<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ„é€  EffectFunction æ‰§è¡Œä¸€æ¬¡</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  a<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// ref ä¹Ÿæ”¯æŒä¾èµ–æ”¶é›†ä¸è§¦å‘</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  a<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// åŒå€¼ä¸è§¦å‘</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><code>ref</code> å¯¹è±¡æ—¶è¦æŠŠå†…å±‚å¯¹è±¡å˜ä¸º <code>reactive</code>, å¯¹è±¡ä¹Ÿå¯ä»¥å˜ä¸ºéå¯¹è±¡<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should convert to reactive'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> dummy<span class="token punctuation">;</span>
  <span class="token keyword">let</span> calls <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    calls<span class="token operator">++</span><span class="token punctuation">;</span>
    dummy <span class="token operator">=</span> a<span class="token punctuation">.</span>value<span class="token punctuation">.</span>foo <span class="token operator">?</span> a<span class="token punctuation">.</span>value<span class="token punctuation">.</span>foo <span class="token operator">:</span> a<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ„é€  EffectFunction æ‰§è¡Œä¸€æ¬¡</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  a<span class="token punctuation">.</span>value<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// ref ä¹Ÿæ”¯æŒä¾èµ–æ”¶é›†ä¸è§¦å‘</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  a<span class="token punctuation">.</span>value <span class="token operator">=</span> origin<span class="token punctuation">;</span> <span class="token comment">// åŒå€¼ä¸è§¦å‘</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  a<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// åŒå€¼ä¸è§¦å‘</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  a<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// å˜ä¸ºéå¯¹è±¡</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>å®ç°</p></li></ol><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ä¸ reactive ç›´æ¥è¿”å›ä¸€ä¸ª Proxy ä¸åŒ, æˆ‘ä»¬åªæœ‰ value ä¸€ä¸ªå±æ€§, æ‰€ä»¥è¦æ‰‹åŠ¨æ„å»ºä¸€ä¸ªå¯¹è±¡</span>
<span class="token keyword">class</span> <span class="token class-name">RefImpl</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// è¿™é‡Œæˆ‘ä»¬ä¸ä½¿ç”¨å…¨å±€çš„ targetMap åŸå› æ˜¯</span>
  <span class="token comment">//   - æˆ‘ä»¬è¿™é‡Œçš„ Key å¯ä»¥ä¸æ˜¯å¯¹è±¡, ä¸¤ä¸ªå€¼ç›¸åŒçš„ ref ä¼šè¢«åˆ¤å®šä¸ºåŒä¸€ä¸ª key</span>
  <span class="token comment">//   - åªå­˜åœ¨ä¸€ä¸ª Key: value, æ‰€ä»¥æ²¡æœ‰å¿…è¦ä½¿ç”¨ä¸¤ä¸ª Map, åªéœ€è¦ä¸€ä¸ª Set å°±å¯ä»¥å­˜å‚¨æ‰€æœ‰çš„ EffectReactive</span>
  <span class="token keyword">private</span> <span class="token literal-property property">deps</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>EffectReactive<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _value<span class="token punctuation">;</span>
  <span class="token keyword">private</span> rawValue<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rawValue <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// åªéœ€è¦ value çš„ [SET] [GET] å°±å¯ä»¥å®ç°</span>
  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">trackEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¾èµ–è¿½è¸ª</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// é‡å¤èµ‹å€¼ä¸è§¦å‘, è€ƒè™‘ä¸¤ç§æƒ…å†µ</span>
    <span class="token comment">//   - this._value ä¸æ˜¯ Object, ç›´æ¥æ¯”è¾ƒ</span>
    <span class="token comment">//   - this._value æ˜¯ Object, æ­¤æ—¶ this._value æ˜¯ä¸€ä¸ª reactive, reactive(obj) !== obj, å¿…é¡»ä½¿ç”¨åŸå§‹å€¼æ¯”è¾ƒ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rawValue <span class="token operator">===</span> newValue<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rawValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token function">isObject</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token operator">:</span> newValue<span class="token punctuation">;</span>
    <span class="token function">triggerEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è§¦å‘ä¾èµ–</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RefImpl</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>åœ¨è¿™é‡Œ, <code>trackEffect</code> ä¸ <code>triggerEffect</code> ç›¸å½“äºä¸éœ€è¦æŸ¥ <code>Set</code> çš„ <code>track</code> ä¸ <code>trigger</code>(å› ä¸ºåªæœ‰ä¸€ä¸ª <code>Set</code>). æˆ‘ä»¬å¯ä»¥å°†åŸæ¥çš„ <code>track</code> ä¸ <code>trigger</code> æ‹†å¼€</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>targetMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> keyMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> keyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æŠ½æˆä¸€ä¸ªå‡½æ•°</span>
  <span class="token function">trackEffect</span><span class="token punctuation">(</span>keyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trackEffect</span><span class="token punctuation">(</span><span class="token parameter">dependenceEffect</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// æœ¬æ¥åªéœ€è¦åœ¨ track ä¸Šåˆ¤æ–­ activeEffect ä½†æ˜¯è¿™ä¸ªå‡½æ•°å¯èƒ½è¢« track æˆ–è€… RefImpl è°ƒç”¨, æ‰€ä»¥è¿˜éœ€è¦åœ¨åˆ¤æ–­ä¸€æ¬¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  dependenceEffect<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependenceEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> keyMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyMap<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> depSet <span class="token operator">=</span> keyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depSet<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">// æŠ½æˆä¸€ä¸ªå‡½æ•°</span>
  <span class="token function">triggerEffect</span><span class="token punctuation">(</span>depSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">triggerEffect</span><span class="token punctuation">(</span><span class="token parameter">depSet</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">[</span><span class="token operator">...</span>depSet<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>scheduler <span class="token operator">?</span> d<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> d<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="æ„å»ºå·¥å…·å‡½æ•°-isref-unref-proxyrefs">æ„å»ºå·¥å…·å‡½æ•° <code>isRef</code> &amp; <code>unRef</code> &amp; <code>proxyRefs</code></h3><p><strong>éœ€æ±‚</strong>: - <code>isRef</code>: åˆ¤æ–­è¾“å…¥æ˜¯ä¸æ˜¯ <code>ref</code> - <code>unRef</code>: è¿”å› <code>ref</code> çš„ <code>value</code> - <code>proxyRefs</code>: æ¨¡æ‹Ÿ Vue3 çš„ setup å‡½æ•°, é€šè¿‡è¯¥å‡½æ•°è¿”å›çš„å¯¹è±¡ä¸­çš„ <code>ref</code> åœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­æ— éœ€ <code>.value</code> å³å¯è®¿é—®ä¸èµ‹å€¼. ç®€å•æ¥è¯´å°±æ˜¯è¾“å…¥å¯¹è±¡, åœ¨è®¿é—®å¯¹è±¡ä¸­æµ…å±‚ <code>ref</code> çš„ <code>Key</code> æ—¶æ— éœ€ <code>.value</code> å³å¯è®¿é—®</p><p><strong>éœ€æ±‚åˆ†æ</strong>: - <code>isRef</code>: åŠ ä¸€ä¸ª flag å³å¯ - <code>unRef</code>: åˆ¤æ–­æ˜¯ä¸æ˜¯ <code>ref</code>, æ˜¯å°±è¿”å› <code>ref.value</code> - <code>proxyRefs</code>: æ„é€ ä¸€ä¸ªä»£ç†, åœ¨è¯»å†™æ˜¯åˆ¤æ–­è¯»å†™ç›®æ ‡æ˜¯ä¸æ˜¯ <code>ref</code> å¦‚æœæ˜¯å°±è¿”å› <code>ref.value</code>. åŒæ—¶, åœ¨ <code>[SET]</code> æ—¶, å¦‚æœæ–°æ—§å€¼éƒ½æ˜¯ <code>ref</code> é‚£ä¹ˆç›´æ¥æ›¿æ¢æ‰æ—§ <code>ref</code></p><ol type="1"><li><p>æµ‹è¯•<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'isRef'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> origin2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed1 <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>origin1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed2 <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>origin1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>observed1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>observed2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'unRef'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> origin1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> origin2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed1 <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>origin1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed2 <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">unRef</span><span class="token punctuation">(</span>observed1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>origin1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">unRef</span><span class="token punctuation">(</span>observed2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">unRef</span><span class="token punctuation">(</span>observed2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">unRef</span><span class="token punctuation">(</span>observed2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token function">reactive</span><span class="token punctuation">(</span>origin2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'proxyRefs'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">sampleRef</span><span class="token operator">:</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">sampleStr</span><span class="token operator">:</span> <span class="token string">'demo'</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> proxyUser <span class="token operator">=</span> <span class="token function">proxyRefs</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>sampleRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>proxyUser<span class="token punctuation">.</span>sampleRef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>proxyUser<span class="token punctuation">.</span>sampleStr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">(</span>proxyUser <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>sampleRef <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>proxyUser<span class="token punctuation">.</span>sampleRef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>sampleRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  proxyUser<span class="token punctuation">.</span>sampleRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>proxyUser<span class="token punctuation">.</span>sampleRef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>sampleRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>å®ç°</p></li></ol><p>æ‰“flag<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">RefImpl</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> __v_isRef <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>å®ç° <code>isRef</code> ä¸ <code>unRef</code><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">unRef</span><span class="token punctuation">(</span><span class="token parameter">ref</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">isRef</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token operator">?</span> ref<span class="token punctuation">.</span>value <span class="token operator">:</span> ref<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isRef</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>value<span class="token operator">?.</span>__v_isRef<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>å®ç° <code>proxyRef</code><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">proxyRefs</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> proxyProxyRefConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">getProxyRef</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ä¸ç”¨è¿™ä¹ˆéº»çƒ¦</span>
  <span class="token comment">// if (isRef(target[key])) return target[key].value;</span>
  <span class="token comment">// return target[key];</span>
  <span class="token keyword">return</span> <span class="token function">unRef</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">setProxyRef</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// åªç‰¹åˆ¤ ref &lt;- æ™®é€šå€¼</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> proxyProxyRefConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">get</span><span class="token operator">:</span> getProxyRef<span class="token punctuation">,</span>
  <span class="token literal-property property">set</span><span class="token operator">:</span> setProxyRef<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>3. é‡æ„: æ— </p><h3 id="å®ç°-computed">å®ç° <code>computed</code></h3><p><strong>éœ€æ±‚:</strong> 1. è¾“å…¥ä¸€ä¸ªå‡½æ•°, è¿”å›ä¸€ä¸ªå¯¹è±¡, å¯ä»¥é€šè¿‡ <code>.value</code> è·å–å‡½æ•°è¿”å›å€¼, å½“å‡½æ•°å†…éƒ¨ <code>reactive</code> å˜åŒ–æ—¶, è¿”å›å€¼ä¹Ÿè¦å˜åŒ–. 2. æ”¯æŒ Lazy, å³: 1. åœ¨ <code>computed</code> å†…éƒ¨ <code>reactive</code> å˜åŒ–æ—¶ä¸è§¦å‘ <code>computed</code> ä¼ å…¥å‡½æ•° 2. åœ¨ <code>[GET]</code> æ—¶æ‰è§¦å‘ <code>computed</code> ä¼ å…¥å‡½æ•° 3. è‹¥å†…éƒ¨ <code>reactive</code> ä¸å˜, é‡å¤è§¦å‘ <code>[GET]</code> ä¸é‡å¤è§¦å‘ä¼ å…¥å‡½æ•° 3. è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ª <code>reactive</code> å¯¹è±¡, å³ <code>.value</code> å˜åŒ–æ—¶è¦è§¦å‘ä¾èµ–</p><p><strong>éœ€æ±‚åˆ†æ:</strong></p><ol type="1"><li>æµ‹è¯•<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should reactive'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    cnt<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> observed<span class="token punctuation">.</span>foo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Lazy</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Lazy</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Lazy</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è¿”å›å€¼ä¹Ÿå¯ä»¥æ”¶é›†ä¾èµ–</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should trigger effect'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> cValue <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> value<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> dummy<span class="token punctuation">;</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    dummy <span class="token operator">=</span> cValue<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  value<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>å®ç°</li></ol><ul><li>æ„é€ ä¸€ä¸ª <code>old</code>, å½“å†…éƒ¨ reactive å˜åŒ–æ—¶ä¿®æ”¹, å¦‚æœå†…éƒ¨ä¸å˜å°±ç›´æ¥ä½¿ç”¨åŸ <code>_value</code></li><li>ç±»ä¼¼æ„é€  <code>ref</code> çš„ <code>dep</code> æ”¶é›† <code>.value</code> çš„ä¾èµ–</li><li>æˆ‘ä»¬å¸Œæœ›åœ¨ç¬¬ä¸€æ¬¡ <code>[GET]</code> çš„æ—¶å€™æ”¶é›†ä¾èµ–, è¿™å¯ä»¥ä½¿ç”¨ <code>EffectReactive</code> å®ç°, ä½†æ˜¯ä¸ºäº†å®ç° Lazy æˆ‘ä»¬åˆä¸å¸Œæœ›æ¯æ¬¡å†…éƒ¨ <code>reactive</code> å˜åŒ–éƒ½è§¦å‘ä¾èµ–. æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ <code>scheduler</code> è§£å†³, æ¯æ¬¡å†…éƒ¨ <code>reactive</code> å˜åŒ–æ—¶å€™æ‰“ä¸‹æ ‡è®°(<code>old</code>), å¹¶é€šçŸ¥ <code>computed</code> è¦è§¦å‘ä¾èµ–äº†. å¦‚æœ <code>computed</code> æ²¡æœ‰ä¾èµ–é‚£è¿™æ¬¡å°± Lazy è¿‡å»äº†, å¦‚æœæœ‰é‚£åœ¨è§¦å‘ä¾èµ–æ—¶å…¶ä»–å‡½æ•°ä¼šè°ƒç”¨è®¡ç®—å±æ€§çš„ <code>[GET]</code> æ­¤æ—¶å®Œæˆåˆ·æ–°</li></ul><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>
  effect<span class="token punctuation">,</span>
  EffectReactive<span class="token punctuation">,</span>
  trackEffect<span class="token punctuation">,</span>
  triggerEffect<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./effect'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ComputedImpl</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">old</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
  <span class="token literal-property property">fst</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
  <span class="token literal-property property">_value</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token literal-property property">dep</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>EffectReactive<span class="token operator">></span><span class="token punctuation">;</span>
  effect<span class="token operator">!</span><span class="token operator">:</span> EffectReactive<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>old <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fst <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">trackEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¸ºå•¥äººå®¶çš„ä»£ç æ²¡ fst å‘¢? å› ä¸ºäººå®¶çš„ EffectReactive æ¯åœ¨æ„é€ å‡½æ•°çš„æ—¶å€™ run. äººå®¶å¯ä»¥åœ¨æ„é€ å‡½æ•°é‡Œé¢æ³¨å†Œè¿™ä¸ª effect</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fst<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fst <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EffectReactive</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>old <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">triggerEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>old<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>old <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>effect<span class="token punctuation">.</span><span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">triggerEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">_</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Can not set computed value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">origin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComputedImpl</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>- é‡æ„: è€ƒè™‘ä¿®æ”¹ <code>EffectReactive</code> æ„é€ å‡½æ•°</p><h3 id="å°ç»“">å°ç»“</h3><ul><li>å®ç° <code>Reactivity</code> çš„æ ¸å¿ƒå°±æ˜¯ä¸€ä¸ª <code>Proxy</code>. é€šè¿‡ä¿®æ”¹ <code>[GET]</code> &amp; <code>[SET]</code> å®ç°ä¸åŒæƒé™</li><li>æ—¶åˆ»è°¨è®° JavaScript æ˜¯åŠ¨æ€è¯­è¨€, å¯¹è±¡ä¸Šçš„å±æ€§éšæ—¶åœ¨å˜åŒ–, ä¸è¦æƒ³åœ¨æŸä¸€ä¸ªå¯¹å¯¹è±¡ä¸Šçš„å±æ€§åšç‰¹æ®Šå¤„ç†, å¾ˆå®¹æ˜“é—æ¼, æˆ‘ä»¬å¯ä»¥æƒ³æƒ³ä»€ä¹ˆæ—¶å€™å¤–éƒ¨éœ€è¦æˆ‘ä»¬ç‰¹æ®Šå¤„ç†çš„ç‰¹æ€§, åœ¨å‡ºå£å¤„"å›´è¿½å µæˆª"</li><li>æ³¨æ„æˆ‘ä»¬åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™æŠ½è±¡å‡½æ•°<ul><li>è¯­ä¹‰ä¸Šå¯ä»¥æŠ½è±¡æ—¶å€™</li><li>åŠŸèƒ½é‡å¤æ—¶</li></ul></li><li>å½“å‡½æ•°åŠŸèƒ½éƒ¨åˆ†é‡å æ—¶è¦æ•¢äºæ‹†åˆ†å‡½æ•°</li><li><code>ref</code> ç›¸å½“äºæ˜¯ä¸€ä¸ªæ•´ä½“åŠŸèƒ½å¼±åŒ–çš„ <code>reactive</code>, æ‰€ä»¥æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨å…¨å±€ <code>targetMap</code></li><li><code>computed</code> çš„å®ç°æ¯”è¾ƒå·§å¦™, è¿ç”¨äº†ä¸€ä¸ª effect çš„é…ç½®é¡¹, æˆ‘ä»¬åœ¨å®ç°å·¥å…·å‡½æ•°çš„æ—¶å€™ä¹Ÿå¯ä»¥æƒ³æƒ³æ˜¯å¦å¯ä»¥é€šè¿‡é…ç½®é¡¹å°†ä¸¤ä¸ªåŠŸèƒ½ç±»ä¼¼çš„ç±»åˆå¹¶æˆä¸€ä¸ªç±».</li></ul><h2 id="å®ç°-runtime-core-çš„-mount-éƒ¨åˆ†">å®ç° runtime-core çš„ mount éƒ¨åˆ†</h2><h3 id="æ­å»ºç¯å¢ƒ">æ­å»ºç¯å¢ƒ</h3><p>runtime-core ç›´æ¥å‚ä¸é¡µé¢æ„å»º, æˆ‘ä»¬éœ€è¦åˆ©ç”¨æ‰“åŒ…å·¥å…·æ‰“åŒ…ä»£ç . åœ¨æ‰“åŒ…ç½‘é¡µæ—¶ä¸€èˆ¬ä½¿ç”¨ webpack, è€Œåœ¨æ‰“åŒ…æ¨¡å—æ—¶ä¸€èˆ¬ä½¿ç”¨ rollup.js. å®‰è£… rollup åŠå…¶ TypeScript ä¾èµ–</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pnpm i -D rollup @rollup&#x2F;plugin-typescript tslib rollup-plugin-sourcemaps
#         ^ æœ¬ä½“  ^ typescript æ”¯æŒ          ^ TS æ”¯æŒä¾èµ–<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>é…ç½® rollup</p><ul><li>åˆ›å»º <code>/package/index.ts</code> ä½œä¸ºæ•´ä¸ªé¡¹ç›®çš„å‡ºå£</li><li>åˆ›å»º rollup é…ç½®æ–‡ä»¶ <code>/package/rollup.config.js</code><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> typescript <span class="token keyword">from</span> <span class="token string">'@rollup/plugin-typescript'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> sourceMaps <span class="token keyword">from</span> <span class="token string">'rollup-plugin-sourcemaps'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">'./packages/index.ts'</span><span class="token punctuation">,</span> <span class="token comment">// å…¥å£æ–‡ä»¶</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 2ç§è¾“å‡ºæ ¼å¼</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span> <span class="token comment">// è¾“å‡ºæ ¼å¼</span>
      <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token string">'./lib/micro-vue.cjs.js'</span><span class="token punctuation">,</span> <span class="token comment">// è¾“å‡ºè·¯å¾„</span>
      <span class="token literal-property property">sourcemap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'es'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token string">'./lib/micro-vue.esm.js'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">sourcemap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">typescript</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sourceMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>æ‰§è¡Œ <code>rollup -c ./rollup.config.js</code> æ‰“åŒ…</li><li>æ ¹æ®æç¤ºå°† <code>tsconfig.json</code> ä¸­ <code>"module": "commonjs"</code> æ”¹ä¸º <code>"module": "ESNext"</code></li><li>åœ¨ <code>package.json</code> ä¸­æ³¨å†ŒåŒ…çš„å…¥å£æ–‡ä»¶, <code>main</code> å¯¹åº” commonjs åŒ…, <code>module</code> å¯¹åº” ESM åŒ…<pre class="line-numbers language-json" data-language="json"><code class="language-json">&quot;main&quot;: &quot;lib&#x2F;micro-vue.cjs.js&quot;,
&quot;module&quot;: &quot;lib&#x2F;micro-vue.esm.js&quot;,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h3 id="æ„é€ æµ‹è¯•ç”¨ä¾‹">æ„é€ æµ‹è¯•ç”¨ä¾‹</h3><p>æˆ‘ä»¬æ„é€ ä¸€ä¸ªç®€å•çš„ Vue demo å¹¶å°è¯•æ„å»º vue-runtime ä¸»æµç¨‹ä½¿å…¶å¯ä»¥å°†æˆ‘ä»¬çš„ demo æ¸²æŸ“å‡ºæ¥, Vue é¡¹ç›®ä¸€èˆ¬åŒ…å«å¦‚ä¸‹æ–‡ä»¶</p><ul><li><code>index.html</code>: è‡³å°‘åŒ…å«ä¸€ä¸ªæŒ‚è½½ç‚¹</li><li><code>index.js</code>: å¼•å…¥æ ¹ç»„ä»¶, å°†æ ¹ç»„ä»¶æŒ‚è½½åˆ°æŒ‚è½½ç‚¹</li><li><code>App.vue</code>: å®šä¹‰æ ¹ç»„ä»¶</li></ul><p>SFC éœ€è¦ vue-loader ç¼–è¯‘æ‰èƒ½å®ç°. è€Œ vue-loader çš„ä½œç”¨æ˜¯å°† SFC å¤„ç†ä¸º <code>render</code> å‡½æ•°, åœ¨æ­¤æˆ‘ä»¬åªèƒ½å…ˆå°† <code>App.vue</code> å¤„ç†ä¸º vue-loader ç¼–è¯‘åå‡½æ•°. å®šä¹‰</p><ul><li><code>index.html</code>: åªæ„é€ ä¸€ä¸ªæŒ‚è½½ç‚¹å¹¶å¼•å…¥ JS<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>micro-vue runtime-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./index.js<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>model<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><code>index.js</code>: å…ˆä¸ç®¡æœ‰æ²¡æœ‰è¿™äº›å‡½æ•°, å¹³æ—¶å’‹å†™å°±å’‹å†™<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createApp <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../lib/micro-vue.esm'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span><span class="token punctuation">;</span>

<span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><code>App.js</code>:<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../lib/micro-vue.esm.js'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"222"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><code>App.js</code> é»˜è®¤å¯¼å‡ºäº†ä¸€ä¸ªé…ç½®å¯¹è±¡, è¯¥å¯¹è±¡åº”è¯¥åŒ…å« SFC ä¸­å¯¼å‡ºçš„ <code>setup</code> ä¸ vue-loader ç¼–è¯‘å¾—åˆ°çš„ <code>render</code> å‡½æ•°. å…¶ä¸­</p><ul><li><code>setup</code> å‡½æ•°çš„è¿”å›å€¼å¯ä»¥æ˜¯å¯¹è±¡, ä¹Ÿå¯ä»¥æ˜¯æ¸²æŸ“å‡½æ•°</li><li>åœ¨è§£æ SFC æ–‡ä»¶æ—¶, å¦‚æœç”¨æˆ·æ‰‹åŠ¨é€šè¿‡ <code>setup</code> è¿”å›äº†æ¸²æŸ“å‡½æ•°é‚£ä¹ˆ vue-loader å°±ä¸ç¼–è¯‘æ¨¡æ¿, å¦‚æœæ²¡æœ‰è¿”å›åˆ™ç¼–è¯‘æ¨¡æ¿å¹¶æ„é€ æ¸²æŸ“å‡½æ•° <code>render</code>. <code>render</code> å‡½æ•°æè¿°äº†<strong>è¿™ä¸ªç»„ä»¶é‡Œé¢</strong>åº”è¯¥å¦‚ä½•æ¸²æŸ“</li><li><code>render</code> ä¸­çš„ <code>h</code> ç”¨äºè¡¨è¿°ä¸€ä¸ªç»„ä»¶/å…ƒç´ , è¯­æ³•ä¸º: <code>h(type, attr, children)</code>.<ul><li><code>type</code>: æè¿°å…ƒç´ æˆ–ç»„ä»¶ç±»å‹, å¦‚æœå¸Œæœ›å°†ç›®æ ‡æ¸²æŸ“ä¸º Element é‚£ä¹ˆ <code>type</code> ä¸ºæ ‡ç­¾å, å¦‚æœå¸Œæœ›æ¸²æŸ“ä¸ºç»„ä»¶é‚£ä¹ˆ <code>type</code> ä¸º ç»„ä»¶é…ç½®å¯¹è±¡</li><li><code>attr</code>: æè¿°å…ƒç´ æˆ–ç»„ä»¶ä¸Šçš„å±æ€§(ä¾‹å¦‚: <code>class</code>)</li><li><code>children</code>:<ul><li>å¦‚æœå¾…æ¸²æŸ“çš„æ˜¯ä¸€ä¸ªå…ƒç´ , å¦‚æœè¿™ä¸ªå…ƒç´ ä¸‹é¢æ²¡æœ‰å­å…ƒç´ æˆ–è€…å­ç»„ä»¶, é‚£ä¹ˆ <code>children</code> ä¸ºå…ƒç´ çš„ <code>innerText</code>, å¦‚æœä¸‹é¢è¿˜æœ‰å­ç»„ä»¶æˆ–å­å…ƒç´ , é‚£ä¹ˆ <code>children</code> åº”è¯¥æ˜¯ä¸€ä¸ª <code>h</code> å‡½æ•°è¿”å›å€¼æ•°ç»„</li><li><strong>å¦‚æœå¾…æ¸²æŸ“çš„æ˜¯ä¸€ä¸ªç»„ä»¶, <code>children</code> å±æ€§å°†ä¼ å…¥æ’æ§½è€Œä¸æ˜¯å­å…ƒç´ , è¿™ä¸€ç‚¹ä¸æ¨¡æ¿è®¾è®¡æ˜¯ç±»ä¼¼çš„</strong><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>111<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>222<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>çš„ <code>h</code> å‡½æ•°<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>å¯¹äºç»„ä»¶<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Comp</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>111<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>222<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Comp</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>çš„ <code>h</code> å‡½æ•°<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">h</span><span class="token punctuation">(</span>Comp<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>è®¾è®¡ä¸Šæ˜¯ç»Ÿä¸€çš„.</li></ul></li></ul></li></ul><p>ä¸Šé¢è¿™ä¸ªä¾‹å­æè¿°äº†è¿™æ ·ä¸€ä¸ªç»„ä»¶:</p><ul><li><p>é¦–å…ˆé»˜è®¤å¯¼å‡ºçš„æ˜¯ä¸€ä¸ªç»„ä»¶é…ç½®å¯¹è±¡</p></li><li><p>è¿™ä¸ªç»„ä»¶è¢«ç¼–è¯‘ä¸ºäº† <code>render</code> å‡½æ•°, <code>render</code> å‡½æ•°è¿”å›äº†ä¸€ä¸ª <code>h</code>.</p><ul><li><p><strong>è¯¶, æˆ‘è¦æ¸²æŸ“ä¸€ä¸ªç»„ä»¶, ä¸ºå•¥ <code>h</code> çš„ <code>type</code> æ˜¯ <code>div</code> è€Œä¸æ˜¯é…ç½®å¯¹è±¡å‘¢?</strong> ä¸€å®šæ³¨æ„, <code>render</code> æè¿°çš„æ˜¯ç»„ä»¶<strong>é‡Œé¢</strong>åº”è¯¥å¦‚ä½•æ¸²æŸ“, è¿™é‡Œçš„ <code>h</code> æ˜¯è¯´, App ç»„ä»¶é‡Œé¢æœ‰ä¸€ä¸ª <code>div</code>, å¦‚æœæˆ‘ä»¬è¿™é‡Œå†™çš„æ˜¯ <code>h(demoObj, &#123;&#125;, '111')</code> è¿™ä¸ªæ„æ€æ˜¯ App ç»„ä»¶é‡Œé¢æœ‰ä¸€ä¸ª demo ç»„ä»¶, è¿™ä¸ª demo ç»„ä»¶é‡Œé¢å•¥ä¹Ÿæ²¡æœ‰, ä»–çš„ innerText æ˜¯ '111'</p></li><li><p><strong>è¯¶, é‚£æˆ‘ä»¬åœ¨å“ªé‡Œå®šä¹‰äº† App çš„ h å‡½æ•°å‘¢?</strong> æˆ‘ä»¬æ²¡æœ‰ç”¨ <code>h</code> å‡½æ•°å®šä¹‰ App (æ˜¯åˆ©ç”¨ createApp å®šä¹‰çš„) è‡³äºè¿™ä¿©å‡½æ•°æœ‰ä»€ä¹ˆè”ç³»åé¢å†è¯´</p></li><li><p><strong>è¯¶, é‚£éš¾é“ç»„ä»¶å†…éƒ¨åªèƒ½æœ‰ä¸€ä¸ªä¸€çº§å­å…ƒç´ ?</strong> æ˜¯çš„, åœ¨ Vue2 ä¸­æˆ‘ä»¬å°±è§„å®š <code>template</code> ä¸‹æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªä¸€çº§å­å…ƒç´ , åœ¨ Vue3 ä¸­æˆ‘ä»¬ç”¨è¯­æ³•ç³–è§£é™¤äº†è¿™ä¸ªé™åˆ¶. ä½ å¯èƒ½ä¼šæƒ³åˆ°å¯¹äº App ä¸‹çš„æŸä¸ªç»„ä»¶(å¦‚ demo), æˆ‘ä»¬é€šè¿‡è¿™æ ·çš„æ–¹å¼è®©è¿™ä¸ªç»„ä»¶æœ‰å¤šä¸ªå­å…ƒç´ </p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// App.js çš„ render</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>demoConfig<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"222"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ˜¯é”™çš„, æ•°ç»„å°†ä½œä¸ºæ’æ§½ä¼ å…¥ demo ç»„ä»¶, ç»„ä»¶çš„å­å…ƒç´ æ˜¯åœ¨ç»„ä»¶è‡ªå·±çš„ <code>render</code> ä¸­å®šä¹‰çš„.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">
demoConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"222"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// App.js çš„ render</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>demoConfig<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶å®æˆ‘ä»¬çš„ç–‘é—®å°±æ˜¯åˆ°åº•æ˜¯ä»–å¦ˆçš„è°æ„é€ äº†æ ¹ç»„ä»¶ <code>App</code> çš„ <code>h</code> å‡½æ•°</p></li></ul></li><li><p>App æ˜¯ä¸€ä¸ªç»„ä»¶, è¿™ä¸ªç»„ä»¶å†…éƒ¨æœ‰ä¸€ä¸ª <code>div</code> è¿™ä¸ª <code>div</code> åˆæœ‰ä¸¤ä¸ªå­<code>span</code>, å†…å®¹åˆ†åˆ«æ˜¯ <code>111</code> å’Œ <code>222</code></p></li></ul><h3 id="æ„é€ ä¸»æµç¨‹">æ„é€ ä¸»æµç¨‹</h3><ul><li><p><code>vue-runtime</code> çš„ä¸»æµç¨‹</p><pre class="mermaid">  graph TB
æ ¹ç»„ä»¶é…ç½®å¯¹è±¡ --createApp--> ä¸€ç§ç‰¹æ®Šçš„vNode --æŒ‚è½½æ ¹ç»„ä»¶--> æ ¹ç»„ä»¶ç‰¹æ®Šä½¿å‘½ç»“æŸ,æˆä¸ºæ™®é€šçš„ç»„ä»¶ --æ¸²æŸ“--> è¿›å…¥patchå‡½æ•° --ç›®æ ‡æ˜¯Element--> Elementå¤„ç†å‡½æ•° --æ–°Element--> æŒ‚è½½Element --æ²¡æœ‰å­Element --> å†™å…¥innerText
æŒ‚è½½Element --æœ‰å­Element--> æ¯ä¸ªå­Element --æ¸²æŸ“--> è¿›å…¥patchå‡½æ•°
Elementå¤„ç†å‡½æ•° --è€Element--> æ›´æ–°Element
è¿›å…¥patchå‡½æ•° --ç›®æ ‡æ˜¯ç»„ä»¶--> ç»„ä»¶å¤„ç†å‡½æ•° --æ–°ç»„ä»¶--> æ–°å»ºç»„ä»¶ --> åº”ç”¨é…ç½® --> è¿è¡Œrender --> æ¯ä¸ªå­ç»„ä»¶ --æ¸²æŸ“--> è¿›å…¥patchå‡½æ•°
ç»„ä»¶å¤„ç†å‡½æ•° --è€ç»„ä»¶--> æ›´æ–°ç»„ä»¶</pre></li><li><p>å¯ä»¥çœ‹åˆ° <code>createApp</code> è¾“å…¥é…ç½®å¯¹è±¡, <code>h</code> å‡½æ•°è¾“å…¥ <code>type</code>(å¯ä»¥æ˜¯stringå¯ä»¥æ˜¯é…ç½®å¯¹è±¡), <code>props</code>, <code>children</code>. è™½ç„¶ä¸¤è€…è¾“å…¥ä¸åŒ, ä½†æ˜¯ä»–ä»¬éƒ½è¿”å›äº† vNode. <code>createApp</code> çš„è¾“å…¥å¯ä»¥çœ‹ä½œæ˜¯æ²¡æœ‰ <code>props</code>, <code>children</code> çš„ <code>h</code> å‡½æ•°çš„ç»„ä»¶è¾“å…¥, è€Œ <code>createApp</code> çš„è¾“å‡ºå¯ä»¥çœ‹ä½œæ˜¯å…·æœ‰ç‰¹æ®ŠåŠŸèƒ½çš„ <code>h</code> è¾“å‡º. å®é™…ä¸Š <code>createApp</code> ä¸ <code>h</code> åœ¨åº•å±‚éƒ½ä¾èµ–äº† <code>createVNode</code> å‡½æ•°.</p></li><li><p>vue æ¸²æŸ“ä¸­å¯¹è±¡å‘ç”Ÿäº†å¦‚ä¸‹å˜åŒ–:</p><pre class="mermaid">  graph LR
ç»„ä»¶/å…ƒç´ é…ç½®å¯¹è±¡ --> è™šæ‹ŸèŠ‚ç‚¹vNode --> å®ä¾‹å¯¹è±¡ --> DOM</pre><ul><li>ç»„ä»¶é…ç½®å¯¹è±¡åŒ…å«äº† <code>render</code>, <code>setup</code></li><li><code>vNode</code> åœ¨é…ç½®å¯¹è±¡çš„åŸºç¡€ä¸ŠåŠ å…¥äº†éƒ¨åˆ†å±æ€§</li><li>å®ä¾‹å¯¹è±¡åˆåœ¨ <code>vNode</code> çš„åŸºç¡€ä¸ŠåŠ å…¥äº†å±æ€§</li><li>æœ€åæŒ‚è½½ä¸º DOM</li></ul></li></ul><p><code>vue-runtime</code> å¯¹å¤–æš´éœ²å‡½æ•°åªæœ‰ <code>createApp</code> æˆ‘ä»¬ä»è¿™ä¸ªå‡½æ•°å…¥æ‰‹</p><ul><li><p><code>createApp</code> åˆ›å»ºäº† app ç»„ä»¶ <code>vNode</code>, åŒæ—¶è¿™ä¸ªçš„ <code>vNode</code> è¿˜åº”è¯¥æœ‰ <code>mount</code> å‡½æ•°(å”¯ä¸€ç‰¹æ®Šçš„åœ°æ–¹)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/createApp.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createVNode <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./vnode'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> render <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./render'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token parameter">rootComponent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">_component</span><span class="token operator">:</span> rootComponent<span class="token punctuation">,</span>
    <span class="token function">mount</span><span class="token punctuation">(</span><span class="token parameter">container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> vNode <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>rootComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">render</span><span class="token punctuation">(</span>vNode<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>createVnode</code>: æ”¶åˆ°é…ç½®å¯¹è±¡, <code>props</code>, <code>children</code> å°†ä»–ä»¬ä½œä¸ºä¸€ä¸ªå¯¹è±¡å­˜èµ·æ¥(API ä¸ <code>h</code> å‡½æ•°ä¸€æ ·)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/vnode.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token parameter">component<span class="token punctuation">,</span> props <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> component<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    children<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>render</code> è´Ÿè´£æ¸²æŸ“ <code>vNode</code>, ä½†æ˜¯ <code>render</code> ä»€ä¹ˆéƒ½æ²¡åš, åªæ˜¯è°ƒç”¨äº† <code>patch</code>. è¿™é‡Œå¤šæ­¤ä¸€ä¸¾æ˜¯ä¸ºäº†æ–¹ä¾¿ä¹‹åéƒ¨ç½²å­å…ƒç´ æ—¶é€’å½’æ–¹ä¾¿</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> vNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç¬¬ä¸€æ¬¡åˆ›å»ºæ²¡æœ‰è€å…ƒç´ </span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>patch</code> å‡½æ•°æ”¶å…¥æ›´æ–°å‰åèŠ‚ç‚¹ä¸æŒ‚è½½ç‚¹(æ–°èŠ‚ç‚¹çš„æŒ‚è½½å‰èŠ‚ç‚¹ä¸º <code>null</code>), é’ˆå¯¹ä¸åŒèŠ‚ç‚¹ç±»å‹è°ƒç”¨ä¸åŒå¤„ç†å‡½æ•°</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">processComponent</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token function">processElement</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>processComponent</code> å¤„ç†ç»„ä»¶</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span>
<span class="token keyword">function</span> <span class="token function">processComponent</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">updateComponent</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è€å…ƒç´ å°± update</span>
  <span class="token keyword">return</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span>vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  æ–°å…ƒç´ å°±æŒ‚è½½</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>updateComponent</code> æš‚æ—¶æ²¡æœ‰å¿…è¦å®ç°</p></li><li><p><code>mountComponent</code> æŒ‚è½½ç»„ä»¶. é¦–å…ˆæ˜ç¡®ç»„ä»¶è‡ªå·±æ˜¯æ²¡æœ‰ HTML æ ‡ç­¾çš„, æŒ‚è½½ç»„ä»¶å®é™…ä¸Šæ˜¯æŒ‚è½½ç»„ä»¶ä¸­çš„å­å…ƒç´ . è€Œç»„ä»¶å­˜åœ¨çš„å¿…è¦æ˜¯å…¶å¯¼å‡ºçš„ setup å‡½æ•°ä¸­å­˜åœ¨å­å…ƒç´ éœ€è¦çš„å˜é‡ä¸å‡½æ•°.</p><p>æˆ‘ä»¬æ„å»ºç»„ä»¶å®ä¾‹åœ¨ä¸Šé¢è®°å½•ç»„ä»¶éœ€è¦çš„ä¸Šä¸‹æ–‡</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span>
<span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>vNode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆ›å»ºå®ä¾‹</span>
  <span class="token function">setupComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é…ç½®å®ä¾‹</span>
  <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>render<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// éƒ¨ç½²å®ä¾‹</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>createComponent</code> ç”¨äºåˆ›å»ºç»„ä»¶å®ä¾‹, ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬å°†ç»„ä»¶çš„ type æåˆ°å®ä¾‹ä¸Š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componment.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token parameter">vNode</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    vNode<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> vNode<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token comment">// å›¾æ–¹ä¾¿</span>
    <span class="token literal-property property">render</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>setupComponent</code> ç”¨äºåˆ›å»ºå®ä¾‹, é…ç½®å®ä¾‹, åŒ…æ‹¬åˆå§‹åŒ– props, slots, å¤„ç† setup å¯¼å‡ºçš„å˜é‡ç­‰. è¿™é‡Œæˆ‘ä»¬å…ˆä¸å¤„ç† props, slot, å¿½ç•¥ setup å¯¼å‡ºçš„å˜é‡åçš„å½’å±é—®é¢˜, åªè§£å†³</p><ul><li>å¦‚æœæœ‰ <code>setup</code> å°±æ‰§è¡Œ <code>setup</code>, å¦‚æœæ‰§è¡Œç»“æœæ˜¯å¯¹è±¡å°±å°†å¯¼å‡ºå¯¹è±¡ç»‘å®šåˆ° instance ä¸Š, å¦‚æœæ˜¯å‡½æ•°å°±æŠŠä»–å½“æˆ <code>render</code> å‡½æ•°</li><li>å¦‚æœæ²¡ <code>render</code> å°±ä» <code>vNode</code> çš„ <code>type</code> ä¸Šè¯»å– <code>render</code></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componment.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupComponent</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// initProp</span>
  <span class="token comment">// initSlot</span>
  <span class="token function">setupStatefulComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// å¦‚æœæœ‰ setup å°±å¤„ç† setup å‡½æ•°è¿è¡Œç»“æœ</span>
<span class="token keyword">function</span> <span class="token function">setupStatefulComponent</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span>setup<span class="token punctuation">)</span>
    <span class="token function">handleSetupResult</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  finishComponentSetup<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// å¤„ç† setup å‡½æ•°è¿è¡Œç»“æœ</span>
<span class="token keyword">function</span> <span class="token function">handleSetupResult</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> instance<span class="token punctuation">.</span>render <span class="token operator">=</span> res<span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    instance<span class="token punctuation">.</span>setupResult <span class="token operator">=</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// æœ€åå…œåº•è·å– render</span>
<span class="token keyword">function</span> <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  instance<span class="token punctuation">.</span>render <span class="token operator">=</span> instance<span class="token punctuation">.</span>render <span class="token operator">||</span> instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span>render<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æ„å»º <code>instance</code> ä¹‹åéœ€è¦å°†ä¸­çš„å­å…ƒç´ æŒ‚è½½å‡ºå», é€’å½’ <code>patch</code> å³å¯</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componment.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span><span class="token parameter">render<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> subTree <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// render åªèƒ½è¿”å› h å‡½æ•°çš„ç»“æœ, æ‰€ä»¥ä¸€å®šæ˜¯ä¸€ä¸ª vNode, ç›´æ¥ patch å°±è¡Œ</span>
  <span class="token comment">// !</span>
  <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ç±»ä¼¼çš„å®ç° Element å¤„ç†åŠŸèƒ½</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span>
<span class="token keyword">function</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">updateElement</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">mountElement</span><span class="token punctuation">(</span>vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>å®ç°æŒ‚è½½ Element</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span>
<span class="token keyword">function</span> <span class="token function">mountElement</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement<span class="token punctuation">;</span> <span class="token comment">// æ„é€  DOM å…ƒç´ </span>
  <span class="token comment">// æ·»åŠ å±æ€§</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=></span> el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> vNode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æœ‰å­å…ƒç´ </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    vNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é€’å½’æŒ‚è½½</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vNode<span class="token punctuation">.</span>children<span class="token punctuation">;</span> <span class="token comment">// æ²¡å­å…ƒç´ </span>
  container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æœ€åå†™ä¸‹ <code>h</code> å‡½æ•°</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/h.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createVNode <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./vnode"</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> h <span class="token operator">=</span> createVNode<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="å®ç°ç»„ä»¶å®ä¾‹-proxy">å®ç°ç»„ä»¶å®ä¾‹ <code>Proxy</code></h3><p>æˆ‘ä»¬æƒ³è¦è®©ç»„ä»¶å¯ä»¥å¼•ç”¨è‡ªå·±å¯¼å‡ºçš„å˜é‡</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'micro-vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'hi '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¯å› ä¸ºæˆ‘ä»¬ç›´æ¥è°ƒç”¨äº† <code>render</code> å‡½æ•°</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/component.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span><span class="token parameter">render<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> subTree <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥ <code>render</code> çš„ <code>this</code> æ˜¯ <code>global</code>, æˆ‘ä»¬å¸Œæœ› <code>render</code> çš„ <code>this</code> åŒ…æ‹¬ <code>setup</code> å¯¼å‡ºçš„å¯¹è±¡ä¸ Vue 3 æ–‡æ¡£ä¸­çš„<span class="exturl" data-url="aHR0cHM6Ly9jbi52dWVqcy5vcmcvYXBpL2NvbXBvbmVudC1pbnN0YW5jZS5odG1s">ç»„ä»¶å®ä¾‹<i class="fa fa-external-link-alt"></i></span>, æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ª Proxy åŒæ—¶å®ç°è®¿é—® setup ç»“æœä¸ç»„ä»¶å¯¹è±¡</p><ol type="1"><li>å¤„ç† setup å¯¼å‡º</li></ol><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/component.ts</span>
<span class="token keyword">function</span> <span class="token function">handleSetupResult</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  instance<span class="token punctuation">.</span>setupResult <span class="token operator">=</span> <span class="token function">proxyRefs</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><ol start="2" type="1"><li>åœ¨ç»“æŸç»„ä»¶åˆå§‹åŒ–æ—¶æ„é€ ä»£ç†å¯¹è±¡, å°†ä»£ç†å¯¹è±¡ä½œä¸ºä¸€ä¸ªå±æ€§æ’å…¥å®ä¾‹<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/component.ts</span>
<span class="token keyword">function</span> <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// å£°æ˜ä»£ç†å¯¹è±¡</span>
  instance<span class="token punctuation">.</span>proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> instance <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> publicInstanceProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>render <span class="token operator">=</span> instance<span class="token punctuation">.</span>render <span class="token operator">||</span> instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span>render<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>å°† <code>target</code> å®šä¹‰ä¸º <code>&#123; instance &#125;</code> çœ‹èµ·æ¥å¾ˆæ€ª, ä¸ºå•¥ä¸ç›´æ¥ç”¨ <code>instance</code> å‘¢? å› ä¸ºåœ¨ DEV æ¨¡å¼ä¸‹è¿™ä¸ªå¯¹è±¡å†…éƒ¨åº”è¯¥è¿˜æœ‰å¾ˆå¤šå±æ€§, åªä¸è¿‡æˆ‘ä»¬æ²¡æœ‰è€ƒè™‘</li><li>å®šä¹‰ä»£ç†<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/publicInstanceProxy.ts</span>
<span class="token keyword">const</span> specialInstanceKeyMap <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">$el</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> publicInstanceProxy <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// å¦‚æœ setup å¯¼å‡ºçš„å¯¹è±¡ä¸Šæœ‰å°±è¿”å›</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>setupResult<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>setupResult<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä»ç»„ä»¶å±æ€§ä¸Šå¯¼å‡ºå±æ€§</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> specialInstanceKeyMap<span class="token punctuation">)</span>
      <span class="token keyword">return</span> specialInstanceKeyMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> target<span class="token punctuation">.</span>instance<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>å®ç° <code>$el</code></li></ol><p>æœ‰å¾ˆå¤šç»„ä»¶å®ä¾‹, æˆ‘ä»¬æš‚æ—¶åªå®ç° <code>$el</code>. æŒ‚è½½ç‚¹åº”è¯¥æ˜¯ <code>vNode</code> çš„å±æ€§, æ‰€ä»¥æˆ‘ä»¬å°†æŒ‚è½½ç‚¹è®°å½•åœ¨ <code>vNode</code> ä¸Š</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/vnode.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token parameter">component<span class="token punctuation">,</span> props <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><code>el</code> ä½œä¸ºç»„ä»¶å®ä¾‹åœ¨ç»„ä»¶æŒ‚è½½ååœ¨ vNode ä¸Šæ›´æ–°å³å¯</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/publicInstanceProxy.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>el <span class="token operator">=</span> container<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h3 id="å®ç°-shapeflags">å®ç° <code>shapeFlags</code></h3><p>å¯ä»¥å°†ç»„ä»¶ç±»å‹åˆ¤æ–­æŠ½å‡ºä¸ºä¸€ä¸ªå˜é‡, é€šè¿‡ä½è¿ç®—åˆ¤æ–­ç»„ä»¶ç±»å‹. æˆ‘ä»¬ç›®å‰éœ€è¦åˆ¤æ–­çš„æœ‰:</p><ul><li>æ˜¯å¦æ˜¯ <code>Element</code></li><li>æ˜¯å¦æ˜¯æœ‰ <code>setup</code> çš„ç»„ä»¶(ä¹Ÿå« stateful component)</li><li>å­èŠ‚ç‚¹æ˜¯ string è¿˜æ˜¯æ•°ç»„</li></ul><p>å®ç°</p><ul><li>ä¿®æ”¹ <code>vNode</code> å®šä¹‰<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token parameter">component<span class="token punctuation">,</span> props <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">shapeFlags</span><span class="token operator">:</span> <span class="token function">getShapeFlags</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>åˆ¤æ–­å‡½æ•°<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> isObject <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../share/index'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> ShapeFlags <span class="token punctuation">&#123;</span>
  <span class="token constant">ELEMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token constant">STATEFUL_COMPONENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token constant">TEXT_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token constant">ARRAY_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getShapeFlags</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// æ³¨æ„, è¿™ä¿©ä¸æ˜¯äº’æ–¥çš„...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> res <span class="token operator">|=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span>setup<span class="token punctuation">)</span> res <span class="token operator">|=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> res <span class="token operator">|=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> res <span class="token operator">|=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>åŒæ­¥åˆ¤æ–­<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">setupStatefulComponent</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span><span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">mountElement</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement<span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=></span> el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> vNode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span>
    <span class="token function">processElement</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="å®ç°äº‹ä»¶æ³¨å†Œ">å®ç°äº‹ä»¶æ³¨å†Œ</h3><p>æˆ‘ä»¬å¯ä»¥ä¸º Element ä¼ å…¥ attribute, ä½†æ˜¯æ— æ³•ä¼ å…¥ç»‘å®šäº‹ä»¶, ä¾‹å¦‚ä¼ å…¥ <code>&#123; onClick: ()=&gt;&#123;&#125; &#125;</code> åœ¨æ¸²æŸ“åˆ° DOM æ—¶å¯ä»¥å‘ç°æ¸²æŸ“ç»“æœä¸º</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>div onclick<span class="token operator">=</span><span class="token string">"()=>&#123;&#125;"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><code>onClick</code> çš„å°é©¼å³°å‘½åæ²¡äº†</li><li>value åº”è¯¥æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨, è€Œè¿™é‡Œåªå†™äº†ä¸€ä¸ªå‡½æ•°, è¿™æ ·ç‚¹å‡»æ—¶å€™å¹¶ä¸ä¼šæ‰§è¡Œå‡½æ•°åªä¼šå³æŸ¥è¯¢ä¸€ä¸‹è¿™ä¸ªå‡½æ•°</li></ul><p>æ‰€ä»¥æˆ‘ä»¬è¦æ‰‹åŠ¨å®ç°è¿™æ ·çš„åŠŸèƒ½: åœ¨æŒ‚è½½ Element æ—¶, è‹¥ä¼ å…¥çš„æ˜¯äº‹ä»¶, æ‰‹åŠ¨ç»‘å®šè¿™ä¸ªäº‹ä»¶</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">mountElement</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement<span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// é€šè¿‡æ­£åˆ™åˆ¤æ–­æ˜¯å¦ä¸ºäº‹ä»¶ç»‘å®š</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
      el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        k<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on([A-Z].*)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        vNode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> vNode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®ç°-props">å®ç° <code>props</code></h3><p><strong>éœ€æ±‚:</strong></p><ol type="1"><li>å°† props è¾“å…¥ <code>setup</code>, ä½¿å¾—å¯ä»¥åœ¨ <code>setup</code> ä¸­é€šè¿‡ <code>props.å±æ€§å</code> è°ƒç”¨, åŒæ—¶ <code>props</code> ä¸º shadowReadonly</li><li>åœ¨ <code>render</code> å¯ä»¥é€šè¿‡ <code>this.å±æ€§å</code> è°ƒç”¨</li></ol><p><strong>å®ç°:</strong></p><ul><li><p>åœ¨ setup æ—¶æ„é€ </p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupComponent</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token function">initProps</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>é€šè¿‡ç¬¬äºŒç‚¹æˆ‘ä»¬å°±çŸ¥é“æˆ‘ä»¬éœ€è¦å°† props åŠ å…¥ componentPublicProxy</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> publicInstanceProxy <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> target<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token keyword">return</span> target<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  	<span class="token comment">// ...</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>å‚è€ƒ Vue çš„API, å¯¹äºç¬¬ä¸€ç‚¹éœ€æ±‚æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ <code>handleSetupResult</code> çš„è°ƒç”¨, ä¼ å…¥æ—¶åŠ å…¥ shadowReadonly</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">handleSetupResult</span><span class="token punctuation">(</span> instance<span class="token punctuation">,</span>
      instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token function">shadowReadonly</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¸º setup ä¼ å…¥å‚æ•°å³å¯</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> emit <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    props<span class="token punctuation">.</span>foo<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// warn: readonly value</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>æˆ‘ä»¬ä¸ºå•¥ä¸æŠŠ shadowReadonly å†™å…¥ componentPublicProxy å‘¢? è¿™æ ·å²‚ä¸æ˜¯å¯ä»¥ä¿æŠ¤ <code>render</code> ä¸­è°ƒç”¨ä¸ä¼šä¿®æ”¹åŸå€¼? æ²¡æœ‰å¿…è¦, æˆ‘ä»¬åªéœ€è¦ä¿è¯æµ…å±‚ readOnly, è€Œ render æ˜¯ç›´æ¥æ‹¿å±æ€§åçš„, ä¸ä¼šä¿®æ”¹ props ä¸Šçš„å±æ€§å®šä¹‰.</p></li></ul><h3 id="å®ç°-emits">å®ç° <code>emits</code></h3><p><strong>éœ€æ±‚:</strong></p><p>é€šè¿‡ props ä¼ å…¥ä¸€å † <code>onXxxXxx</code> å‡½æ•°åœ¨ <code>setup</code> ä¸­å¯ä»¥é€šè¿‡ <code>emit(xxxXxx)</code> è°ƒç”¨å‡½æ•°. å…¶ä¸­<code>emit</code> é€šè¿‡ <code>setup(props, &#123;emit&#125;)</code> çš„æ–¹å¼ä¼ å…¥.</p><p><strong>æ³¨æ„, è¿™é‡Œå°±æ˜¯å·®ä¸€ä¸ª <code>on</code></strong>. ä½ è¯´ä¸ºå•¥ä»–å¦ˆçš„ä½ è¦å·®ä¸ª <code>on</code> å•Š, æˆ‘å†™ Vue çš„æ—¶å€™ä¹Ÿæ²¡æœ‰å·®å¼‚å•Š, è¿™ä¸ªåº”è¯¥æ˜¯ vue-loader ä¸ºä¼ å…¥çš„ <code>emit</code> ååŠ ä¸Šçš„ (å¦‚: <code>&lt;comp v-on:doSth='xxx'&gt;</code>, å¯èƒ½ä¼šè¢« vue-loader è½¬ä¸º <code>&#123; onDoSth: xxx &#125;</code>)</p><p><strong>é‚£ä¹ˆ, éš¾é“ <code>props</code> ä¸Šçš„ <code>onDoSth</code> ä¸ä¼šè¢«æ³¨å†Œæˆäº‹ä»¶ç›‘å¬å—?</strong> æ€ä¹ˆä¼š, æˆ‘ä»¬çš„äº‹ä»¶ç›‘å¬æ˜¯ä¸º Element ç»‘å®šçš„!</p><p><strong>å®ç°:</strong></p><ul><li><p>å®ç° emit å‡½æ•°</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> event<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> eventName <span class="token operator">=</span> event<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">-([a-z])</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>eventName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// å¦‚æœæ˜¯ xxx-xxx å‘½åæ³•, å°†å…¶è½¬æ¢ä¸ºå°é©¼å³°</span>
    eventName <span class="token operator">=</span> eventName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">-([a-z])</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> lc</span><span class="token punctuation">)</span> <span class="token operator">=></span> lc<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[a-z].*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>eventName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// å¦‚æœæ˜¯å°é©¼å³°å‘½åæ³•, å°†å…¶è½¬æ¢ä¸ºå¤§é©¼å³°</span>
    eventName <span class="token operator">=</span> eventName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> eventName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  eventName <span class="token operator">=</span> <span class="token string">'on'</span> <span class="token operator">+</span> eventName<span class="token punctuation">;</span> <span class="token comment">// åŠ å…¥ on</span>
  instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>props<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>å°†å‡½æ•°åŠ å…¥å®ä¾‹å¯¹è±¡ <code>$emit</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> specialInstanceKeyMap <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">$el</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span>
  <span class="token function-variable function">$emit</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">emit</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> publicInstanceProxy <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token comment">/*...*/</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒç»•çš„ç‚¹, Vue è¦æ±‚ <code>emit</code> è°ƒç”¨æ–¹æ³•ä¸º <code>emit(åå­—, å‡½æ•°è°ƒç”¨å‚æ•°)</code>, æˆ‘ä»¬è¿™è¾¹å¤šäº†ä¸€ä¸ª <code>instance</code>, æ‰€ä»¥æˆ‘ä»¬åœ¨å®šä¹‰ <code>$emit</code> æ—¶ä¸ºå‡½æ•° bind ç¬¬ä¸€ä¸ªå‚æ•°</p></li><li><p>ä¼ å…¥ <code>setup</code> çš„è°ƒç”¨å‚æ•°</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">handleSetupResult</span><span class="token punctuation">(</span>
    instance<span class="token punctuation">,</span>
    instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token function">shadowReadonly</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">emit</span><span class="token operator">:</span> instance<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>$emit<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="å®ç°-slot">å®ç° <code>slot</code></h3><p>ä¹‹å‰å·²ç»æ¢³ç†è¿‡ç»„ä»¶çš„ children å­˜å‚¨çš„æ˜¯ slot. Vue æœ‰ä¸‰ç§ slot</p><ul><li>é»˜è®¤ slot: ç›´æ¥ä½œä¸ºå­å…ƒç´ å†™å…¥, åœ¨å­ç»„ä»¶ä¸­ä¼šæŒ‰é¡ºåºå†™å…¥</li><li>å…·å slot: æŒ‡å®šå…ƒç´ æ’å…¥ä»€ä¹ˆåœ°æ–¹</li><li>ä½œç”¨åŸŸ slot: ä¸ºå…·å slot ä¼ å…¥å‚æ•°</li></ul><p>å…ˆè€ƒè™‘ç»„ä»¶çš„ children åº”è¯¥ä¼ å…¥ä»€ä¹ˆæ ·çš„æ•°æ®ç±»å‹ (<code>h(comp, &#123;&#125;, children)</code>)</p><ul><li><p>å¦‚æœåªæ”¯æŒé»˜è®¤ slot, æˆ‘ä»¬å¤§å¯å°†æ•°ç»„ä¼ å…¥ children å¹¶å°† render å‡½æ•°å†™æˆä¸‹é¢è¿™æ ·</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> HelloWorld <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// å‡è®¾ $slot è¡¨ç¤ºçˆ¶ç»„ä»¶ä¼ å…¥çš„æ’æ§½æ•°ç»„, è®©å­ç»„ä»¶åœ¨æ¸²æŸ“æ—¶ç›´æ¥è§£æ„ä¸Šå»</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>$slot<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'APP'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">h</span><span class="token punctuation">(</span>HelloWorld<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">'hi'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM LEFT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM RIGHT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>å¦‚æœéœ€è¦æ”¯æŒå…·åæ’æ§½, æˆ‘ä»¬å¯ä»¥ä¼ å…¥æ•°ç»„, å¹¶åœ¨æ¯ä¸ªå…ƒç´ ä¸Šæ‰“ä¸Š <code>name</code>. ä½†æ˜¯è¿™æ ·æ¯æ¬¡æ”¾å…¥å…ƒç´ éƒ½éœ€è¦ <span class="math inline">\(O(n)\)</span> æŸ¥æ‰¾. å¯ä»¥è€ƒè™‘å°†ä¼ å…¥çš„ <code>children</code> åšæˆå¯¹è±¡, Key ä¸ºå…·åæ’æ§½åå­—, Value å¯ä»¥æ˜¯ vNode æ•°ç»„ä¹Ÿå¯ä»¥æ˜¯ vNode.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> h<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> renderSlots <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'../../lib/micro-vue.esm.js'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> HelloWorld <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token comment">// ç”±äº this.$slots[key] ä¸çŸ¥é“æ˜¯æ•°ç»„è¿˜æ˜¯å¯¹è±¡, æˆ‘ä»¬ç”¨ä¸€ä¸ªå‡½æ•°è¾…åŠ©å¤„ç†</span>
      <span class="token function">renderSlots</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">,</span> <span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">renderSlots</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">,</span> <span class="token string">'right'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">renderSlots</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// è°ƒç”¨é»˜è®¤æ’æ§½</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'APP'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">h</span><span class="token punctuation">(</span>HelloWorld<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">'hi'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM LEFT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// left æ’æ§½</span>
        <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM RIGHT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// right æ’æ§½</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM D1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM D2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">// é»˜è®¤æ’æ§½</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œ Vue å¼•å…¥äº† <code>renderSlots</code> å‡½æ•°, æˆ‘ä»¥ä¸ºå…¶ä½œç”¨å°±æ˜¯æ‰¾åˆ°æ’æ§½å¹¶è½¬æ¢ä¸ºæ•°ç»„, å°±åƒä¸‹é¢è¿™æ ·</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">renderSlots</span><span class="token punctuation">(</span>slots<span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">'default'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> rSlots <span class="token operator">=</span> slots<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">?</span> slots<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">isObject</span><span class="token punctuation">(</span>slots<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span>rSlots<span class="token punctuation">]</span> <span class="token operator">:</span> rSlots<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª vNode, Vue ä¼šç›´æ¥å°†ä¸€ä¸ªæˆ–å¤šä¸ª vNode æ‰“åŒ…æˆä¸€ä¸ª vNode è¿”å›ä»è€Œè§„é¿æ•°ç»„è§£æ„</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componentSlots.ts</span>
<span class="token keyword">function</span> <span class="token function">renderSlots</span><span class="token punctuation">(</span>slots<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'default'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> rSlots <span class="token operator">=</span> name <span class="token keyword">in</span> slots <span class="token operator">?</span> slots<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    rSlots <span class="token operator">=</span> <span class="token function">testAndTransArray</span><span class="token punctuation">(</span>rSlots<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> rSlots<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšğŸ˜Ÿ</p></li><li><p>ç»§ç»­è€ƒè™‘ä½œç”¨åŸŸæ’æ§½, ä¸ºäº†å®ç°ä½œç”¨åŸŸå˜é‡ä¼ é€’, æˆ‘ä»¬éœ€è¦å°†æ’æ§½å®šä¹‰ä¸ºå‡½æ•°, å¹¶åœ¨è°ƒç”¨ <code>renderSolts</code> æ—¶ä¼ å…¥å‚æ•°</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> HelloWorld <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">renderSlots</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">,</span> <span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">renderSlots</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">,</span> <span class="token string">'right'</span><span class="token punctuation">,</span> <span class="token string">'wuhu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// ä½œç”¨åŸŸ slot ä¼ å…¥å‚æ•°</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'OK'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">renderSlots</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token string">'wula'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'APP'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">h</span><span class="token punctuation">(</span>
        HelloWorld<span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">'hi'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span>
          <span class="token function-variable function">left</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM LEFT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function-variable function">right</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">foo</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">foo</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM '</span> <span class="token operator">+</span> foo<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'IM D2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åªéœ€è¦åœ¨ <code>renderSlots</code> ä¸­åˆ¤æ–­ value æ˜¯å¯¹è±¡è¿˜æ˜¯å‡½æ•°å¹¶åˆ†ç±»è®¨è®ºå³å¯.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componentSlots.ts</span>
<span class="token keyword">function</span> <span class="token function">renderSlots</span><span class="token punctuation">(</span>slots<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> rSlots <span class="token operator">=</span> name <span class="token keyword">in</span> slots <span class="token operator">?</span> slots<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// é˜²æ­¢ç»™æ— æ•ˆ Key</span>
    <span class="token comment">// å¦‚æœæ˜¯å¯¹è±¡ / æ•°ç»„å°±ä¸ç®¡, å‡½æ•°å°±è°ƒç”¨</span>
    rSlots <span class="token operator">=</span> <span class="token function">isObject</span><span class="token punctuation">(</span>rSlots<span class="token punctuation">)</span> <span class="token operator">?</span> rSlots <span class="token operator">:</span> <span class="token function">rSlots</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å°è¯•è½¬ä¸ºæ•°ç»„</span>
    rSlots <span class="token operator">=</span> <span class="token function">testAndTransArray</span><span class="token punctuation">(</span>rSlots<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>typeSymbol<span class="token punctuation">.</span>FragmentNode<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> rSlots<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// @packages/share/index.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">testAndTransArray</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">?</span> v <span class="token operator">:</span> <span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>è‡³æ­¤, æˆ‘ä»¬å®ç°äº†æ’æ§½çš„æ¸²æŸ“, å†å®ç°ä¸€äº›å¤–å›´æ–¹æ³•</p><ul><li><p>å®ç° <code>initSlot</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componentSlots.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initSlot</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  instance<span class="token punctuation">.</span>slots <span class="token operator">=</span> instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>æ·»åŠ  <code>$slot</code> å®šä¹‰</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componentPublicInstance.ts</span>
<span class="token keyword">const</span> specialInstanceKeyMap <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">$el</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span>
  <span class="token function-variable function">$emit</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">emit</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">$slots</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> instance<span class="token punctuation">.</span>slots<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="å®ç°-fragmentnode">å®ç° <code>FragmentNode</code></h3><p>åœ¨å®ç° <code>renderSolts</code> æ—¶æˆ‘ä»¬ä¸ºå°†å¤šä¸ª vNode æ‰“åŒ…æˆä¸€ä¸ª vNode é‡‡ç”¨ <code>h('div', &#123;&#125;, rSlots)</code> å°†å¤šä¸ªæ’æ§½æ”¾å…¥äº†ä¸€ä¸ª <code>div</code> ä¸‹. ç„¶è€Œæˆ‘ä»¬å¸Œæœ›åœ¨ HTML ä¸­ä¸ç°å®è¿™ä¸ªå¤šä½™çš„ <code>div</code>, æ­¤æ—¶å°±éœ€è¦ <code>Fragment</code> æ ‡ç­¾, å®ƒç›¸å½“äº Vue æ’æ§½ä¸­çš„ <code>&lt;template&gt;&lt;/template&gt;</code> æ ‡ç­¾, æ°¸ä¸ä¼šè¢«æ¸²æŸ“. å…¶å®ç°çš„åŸç†å°±æ˜¯åœ¨ mount æ—¶ä¸æŒ‚è½½çˆ¶èŠ‚ç‚¹, ç›´æ¥å°†å­èŠ‚ç‚¹æŒ‚è½½åˆ° container ä¸Š</p><ul><li><p>å…ˆç”¨ Symbol å®šä¹‰æ ‡ç­¾å</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/vnode.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> typeSymbol <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">FragmentNode</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'FragmentNode'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>åœ¨ <code>patch</code> æ—¶ç‰¹åˆ¤ <code>Fragment</code> (å› ä¸º <code>Fragment</code> ä¸ component, Element åˆ¤æ–­æ¡ä»¶ä¸åŒ, æˆ‘ä»¬æ²¡æ³•æŠŠä»–ä»¬æ”¾å…¥ç”¨ä¸‰ä¸ª <code>case</code> ä¸­)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> typeSymbol<span class="token punctuation">.</span>FragmentNode<span class="token operator">:</span>
      <span class="token function">processFragmentNode</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç‰¹åˆ¤ Fragment</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span>
        <span class="token function">processElement</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token function">processComponent</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">processFragmentNode</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">mountFragmentNode</span><span class="token punctuation">(</span>vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">mountFragmentNode</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ä¸æŒ‚è½½çˆ¶èŠ‚ç‚¹ç›´æ¥å°†å­èŠ‚ç‚¹æŒ‚è½½åˆ° container ä¸Š</span>
  vNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ä¿®æ”¹ <code>renderSlots</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/componentSlots.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderSlots</span><span class="token punctuation">(</span>slots<span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> rSlots <span class="token operator">=</span> name <span class="token keyword">in</span> slots <span class="token operator">?</span> slots<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  rSlots <span class="token operator">=</span> <span class="token function">testAndTransArray</span><span class="token punctuation">(</span>rSlots<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>typeSymbol<span class="token punctuation">.</span>FragmentNode<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> rSlots<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//       ^ å°æ”¹ä¸€ä¸‹</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="å®ç°-textnode">å®ç° <code>TextNode</code></h3><p>æˆ‘ä»¬è¿˜å¸Œæœ›åœ¨ HTML ä¸­ä¸ä½¿ç”¨ <code>span</code> å°±å†™å…¥æ–‡å­—, å°±åƒ</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>æˆ‘æƒ³å†™ span å°±å†™ span<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
  æƒ³ç›´æ¥å†™å°±ç›´æ¥å†™
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>é™¤éä½¿ç”¨ <code>FragmentNode</code> æˆ‘ä»¬æ— æ³•ä¸æ¸²æŸ“ä¸€æ®µå†…å®¹çš„æ ‡ç­¾, ä½†æ˜¯ <code>FragmentNode</code> æ ‡ç­¾çš„ <code>children</code> ä¹Ÿå¿…é¡»æ˜¯ vNode, æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªç‰¹æ®Šæ ‡ç­¾, å®ƒæœ¬èº«ä¼šæ¸²æŸ“ä¸º TextNode</p><ul><li><p>å®šä¹‰ç±»å‹</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/vnode.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> typeSymbol <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">FragmentNode</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'FragmentNode'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">TextNode</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'TextNode'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ç‰¹åˆ¤ç±»å‹</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> typeSymbol<span class="token punctuation">.</span>FragmentNode<span class="token operator">:</span>
      <span class="token function">processFragmentNode</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> typeSymbol<span class="token punctuation">.</span>TextNode<span class="token operator">:</span> <span class="token comment">// ç‰¹åˆ¤ TextNode</span>
      <span class="token function">processTextNode</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span>
        <span class="token function">processElement</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token function">processComponent</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">processTextNode</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">mountTextNode</span><span class="token punctuation">(</span>vNode2<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">mountTextNode</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> elem <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vNode<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é€šè¿‡ createTextNode åˆ›å»º</span>
  container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>å‘å¤–éƒ¨æš´éœ²æ¥å£</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/vnode.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createTextVNode</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>typeSymbol<span class="token punctuation">.</span>TextNode<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ä½¿ç”¨</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">createTextVNode</span><span class="token punctuation">(</span><span class="token string">'im text'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="å®ç°å·¥å…·å‡½æ•°-getcurrentinstance">å®ç°å·¥å…·å‡½æ•° <code>getCurrentInstance</code></h3><p>è¯¥å‡½æ•°ç”¨äºåœ¨ setup ä¸­è·å–å½“å‰ setup æ‰€åœ¨çš„ instance. åªé¡»åœ¨å…¨å±€å˜é‡ä¸Šæ‰“ä¸ªæ ‡è®°å°±å¯ä»¥å®ç°</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/component.ts</span>
<span class="token keyword">let</span> currentInstance <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">setupStatefulComponent</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    currentInstance <span class="token operator">=</span> instance<span class="token punctuation">;</span> <span class="token comment">// æ‰“ä¸ªæ ‡è®°å†æ‰§è¡Œ</span>
    <span class="token function">handleSetupResult</span><span class="token punctuation">(</span>
      instance<span class="token punctuation">,</span>
      instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token function">shadowReadonly</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">emit</span><span class="token operator">:</span> instance<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>$emit<span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentInstance <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// åˆ é™¤æ ‡è®°</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">finishComponentSetup</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> currentInstance<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®ç°-provide-inject">å®ç° <code>provide-inject</code></h3><p><code>provide-inject</code> æœºåˆ¶å…è®¸ç»„ä»¶åœ¨ <code>setup</code> å‡½æ•°ä¸­è°ƒç”¨ <code>provide(key, value)</code> è®¾ç½®ä¸€ä¸ªå˜é‡. åœ¨è‹¥å¹²çº§å„¿ç»„ä»¶ä¸­é€šè¿‡ <code>inject(key)</code> è·å–å€¼çš„ä¿¡æ¯ä¼ é€’æœºåˆ¶. åŒæ—¶è¯¥æœºåˆ¶éµå®ˆç±»ä¼¼å†…å¤–å±‚ä½œç”¨åŸŸåŒåæ—¶çš„å†…å±‚å˜é‡ä¿æŠ¤æœºåˆ¶, ä¾‹å¦‚æœ‰å¦‚ä¸‹ provide å…³ç³»</p><pre class="mermaid">graph TB
A:provide-a=1  -->  B:provide-a=2  --> C:inject-a=2
A:provide-a=1  -->  D:provide-b=1
A:provide-a=1  -->  E:inject-a=1 -->  F:inject-b=undefined</pre><p>ä¹Ÿå°±æ˜¯è¯´å½“ç»„ä»¶åœ¨çˆ¶ç»„ä»¶ä¸Šæ— æ³• inject å±æ€§æ—¶ä¼šå‘æ›´ä¸Šå±‚ inject å±æ€§.</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ç»„ä»¶å®ä¾‹ä¸Šå®šä¹‰ç»„ä»¶çš„ provide ä¸è¯¥ç»„ä»¶çš„çˆ¶ç»„ä»¶ç„¶åå®ç°é€’å½’æŸ¥æ‰¾çš„ inject å‡½æ•°. ä½†æ˜¯ JavaScript çš„åŸå‹é“¾æœ¬èº«å°±æ”¯æŒé€’å½’æŸ¥æ‰¾, æˆ‘ä»¬å¯ä»¥æŒ‡å®šé€šè¿‡æŒ‡å®šæŸä¸ªç»„ä»¶ provide çš„ <code>__proto__</code> ä¸ºçˆ¶ç»„ä»¶çš„ provide å®ç°.</p><ul><li><p>åœ¨ instance ä¸ŠåŠ å…¥ provide å±æ€§è®°å½•è¯¥ç»„ä»¶æ‰€ provide çš„æ‰€æœ‰é”®å€¼å¯¹å¹¶è®¾ç½® <code>provide.__proto__ = parent.provide</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    parent<span class="token punctuation">,</span> <span class="token comment">// çˆ¶ç»„ä»¶</span>
    <span class="token literal-property property">provides</span><span class="token operator">:</span> parent <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>provides<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// ç»„ä»¶çš„ provide</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬è¦æ±‚åœ¨ <code>createComponent</code> çš„æ—¶å€™æä¾› <code>parent</code> å±æ€§, é‚£ä¹ˆæˆ‘ä»¬ä¹Ÿè¦åœ¨è°ƒç”¨è¯¥å‡½æ•°æ—¶åŠ å…¥è¯¥å‚æ•°, è¯¥å‡½æ•°ä¾èµ–å…³ç³»å¦‚ä¸‹</p><pre class="mermaid">  graph TB

render -.-> patch --> processComponent --> mountComponent --> createComponent((createComponent)) -.-> renderEffect -.-> patch
patch --> processElement --> mountElement --> patch</pre><p>ä¸ºäº†è®© <code>createComponent</code> æœ‰å‚æ•°æˆ‘ä»¬éœ€è¦è®©å…¶å‰ç½®å‡½æ•°éƒ½å¸¦ parent å‚æ•°, æ‰€æœ‰å¯èƒ½è°ƒç”¨å…¶å‰ç½®å‡½æ•°çš„å‡½æ•°ä¹Ÿè¦å¸¦å‚æ•°. å…¶ä¸­å­˜åœ¨ä¸¤ä¸ªç‰¹æ®Šå‡½æ•°.</p><ul><li><code>render</code>: è¯¥å‡½æ•°ç”¨æ¥æ¸²æŸ“æ ¹èŠ‚ç‚¹, æ ¹èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯ <code>null</code></li><li><code>renderEffect</code>: è¯¥å‡½æ•°æ˜¯ç”¨æ¥æ¸²æŸ“ç»„ä»¶ <code>instance</code> çš„å­ç»„ä»¶ <code>subTree</code> æ‰€ä»¥ parent å‚æ•°å°±æ˜¯ <code>instance</code></li></ul></li><li><p>å®ç° API</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/apiInject.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> getCurrentInstance <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./component'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">provide</span><span class="token punctuation">(</span><span class="token parameter">k<span class="token punctuation">,</span> v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> currentInstance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> any<span class="token punctuation">;</span>
  currentInstance<span class="token punctuation">.</span>provides<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> defaultValue</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> currentInstance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> any<span class="token punctuation">;</span>
  <span class="token keyword">return</span> currentInstance <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> currentInstance<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>provides
    <span class="token operator">?</span> currentInstance<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>provides<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token operator">:</span> defaultValue<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>æµ‹è¯•å¤–å±‚å±è”½ä¸è·¨ç»„ä»¶ä¼ é€’</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @App.js</span>
<span class="token keyword">const</span> ProviderOne <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'F1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'B1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">h</span><span class="token punctuation">(</span>ProviderTwo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ProviderTwo <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'F2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'baz'</span><span class="token punctuation">,</span> <span class="token string">'Z2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> i_foo <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> i_bar <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'@ provide 2:'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'foo: '</span> <span class="token operator">+</span> i_foo<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'bar: '</span> <span class="token operator">+</span> i_bar<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span>Consumer<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Consumer <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> i_foo <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> i_bar <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> i_baz <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'baz'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'@ consumer:'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'foo: '</span> <span class="token operator">+</span> i_foo<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'bar: '</span> <span class="token operator">+</span> i_bar<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'baz: '</span> <span class="token operator">+</span> i_baz<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'App'</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'apiInject'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span>ProviderOne<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“æœ</p><pre class="line-numbers language-none"><code class="language-none">apiInject

@ provide 2:foo: F1bar: B1
@ consumer:foo: F2bar: B1baz: Z2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å°ç»“-1">å°ç»“</h3><p>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å®Œæˆäº†ç»„ä»¶æŒ‚è½½éƒ¨åˆ†. é‚£æˆ‘ä»¬æŠ˜è…¾äº†ç‚¹ä»€ä¹ˆå‘¢? æˆ‘ä»¬å°±æ˜¯å®ç°äº† <code>h</code> å‡½æ•°çš„ä¸åŒåŠŸèƒ½. åœ¨å®ç° API çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿè¦ç‰¢è®° API æ˜¯ä¸ºè°å®ç°çš„.</p><table><thead><tr class="header"><th>å‚æ•°</th><th>å¯¹äºç»„ä»¶</th><th>å¯¹äºElement</th></tr></thead><tbody><tr class="odd"><td><code>type</code></td><td>åŒ…å« <code>render</code> ä¸ <code>setup</code> çš„å¯¹è±¡</td><td>æ ‡ç­¾å</td></tr><tr class="even"><td><code>props</code></td><td>ç»„ä»¶å®ä¾‹çš„ <code>props</code></td><td>åŒ…å«å±æ€§ä¸äº‹ä»¶çš„å¯¹è±¡</td></tr><tr class="odd"><td><code>children</code></td><td>slots</td><td>å­å…ƒç´  / å­ç»„ä»¶</td></tr></tbody></table><p>å¯ä»¥å‘ç°, è¿™ä¸ª API è®¾è®¡çš„éå¸¸å¯¹ä»—å·¥æ•´.</p><ul><li><p>å¯¹äº <code>type</code>: åˆ†åˆ«ä¼ å…¥å¯¹è±¡ä¸æ ‡ç­¾å, æ— è¯å¯è¯´</p></li><li><p>å¯¹äº <code>props</code>:</p><ul><li>å¯¹äº Element: ä¼ å…¥ä¸€å † attribute. Element æ˜¯ä¼šè¢«ç›´æ¥æ¸²æŸ“çš„, æˆ‘ä»¬ç›´æ¥å°† Key-Value å†™å…¥æ ‡ç­¾å³å¯. åœ¨å®è·µä¸­æˆ‘ä»¬å‘ç°åšäº‹ä»¶ç»‘å®šæ—¶, ç”±äº value æ˜¯å‡½æ•°å, æˆ‘ä»¬æ— æ³•ç›´æ¥å°† <code>onXxx</code> å†™å…¥æ ‡ç­¾. æ‰€ä»¥éœ€è¦æ‰‹åŠ¨å¤„ç†äº‹ä»¶è°ƒç”¨</li><li>å¯¹äºç»„ä»¶: ä¼ å…¥ä¸€å † props ä¸ emits. <strong>éš¾é“å°±æ²¡æœ‰ç±»ä¼¼ <code>onClick</code> çš„äº‹ä»¶ç›‘å¬æˆ–è€…ç±»ä¼¼ <code>style</code> çš„å±æ€§å—? æ²¡æœ‰! ç»„ä»¶æœ¬èº«æ˜¯ä¸ä¼šè¢«æ¸²æŸ“çš„! ä¸å¯èƒ½å‘ç»„ä»¶æ ‡ç­¾ä¸Šç»‘å®šä»€ä¹ˆä¸œè¥¿. ç»„ä»¶èƒ½ä¼ å…¥çš„åªæœ‰ç”¨äº setup / render çš„å±æ€§ä¸ emits äº‹ä»¶</strong></li></ul></li><li><p>å¯¹äº <code>children</code>:</p><ul><li><p>å¯¹äº Element: ä¼ å…¥ä¸€å †å­å…ƒç´  / å­ç»„ä»¶, æŒ¨ä¸ª patch å°±è¡Œ</p></li><li><p>å¯¹äºç»„ä»¶: ä¼ å…¥ slots, å°† slots åœ¨æ·»åŠ åˆ°å…ƒç´ ä¸Š</p></li><li><p><strong>ä¸ºå•¥ä¸è®©ç»„ä»¶çš„å­å…ƒç´ ä¹Ÿå†™å…¥ children å‘¢? è¿™æ ·çœ‹çš„å¤šå·¥æ•´!</strong></p><p>ç»„ä»¶çš„å­å…ƒç´ åœ¨ç»„ä»¶çš„ render é‡Œé¢, ä¸åœ¨ <code>children</code></p></li><li><p><strong>ä¸ºå•¥ä¸è®©Elementçš„å­å…ƒç´ ä¹Ÿå†™å…¥ render å‘¢?</strong></p><p>äººå®¶ Element å‹æ ¹å°±æ²¡å¯¹è±¡å­˜å­å…ƒç´ çš„</p></li><li><p><strong>è¿™å°¤é›¨æºªæ‡‚ä¸ªé”¤å­ Vue, è®¾è®¡çš„ API å’‹è¿˜è¦åˆ†ç±»è®¨è®ºå•Š!</strong></p><p>å®é™…ä¸Šè¿™ä¸ª API è®¾è®¡çš„å¾ˆæœ‰è¶£, çœ‹çœ‹æˆ‘ä»¬åœ¨ template ä¸­æ˜¯æ€ä¹ˆä¹¦å†™çš„(ä»å‰é¢å†æŠ„ä¸€é)</p><p>å¯¹äº Element</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>111<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>222<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>h</code> å‡½æ•°å†™æ³•</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯¹äºç»„ä»¶<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Comp</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>111<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span>222<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Comp</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><code>h</code> å‡½æ•°å†™æ³•</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">h</span><span class="token punctuation">(</span>Comp<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'111'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'222'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨ç»“æ„ä¸Šæ˜¯å¯¹ä»—çš„. è¿™ API è®¾è®¡çš„å¤ªä¼Ÿå¤§äº†</p></li></ul></li></ul><p>æ­¤å¤–æˆ‘ä»¬è¿˜æ„å»ºäº†ç‰¹æ®Šçš„ <code>Fragment</code> ä¸ <code>TextNode</code> è¿™ä¿©éƒ½æ˜¯é­”æ”¹ patch å®ç°çš„. æˆ‘ä»¬è¿˜å®ç°äº† <code>provide-inject</code> API, è¿™é‡Œå€ŸåŠ©åŸå‹é“¾å®ç°åŠŸèƒ½ä¹Ÿå¾ˆæœ‰è¶£</p><h2 id="å®ç°-runtime-core-çš„-update-éƒ¨åˆ†">å®ç° runtime-core çš„ update éƒ¨åˆ†</h2><p>åœ¨å®ç°æ›´æ–°é€»è¾‘æ—¶æˆ‘ä»¬ä¹Ÿè¦å¯¹ç»„ä»¶ä¸ Element åˆ†ç±»è®¨è®ºå¹¶è°¨è®°å½“å‰å®ç°çš„æ˜¯ç»„ä»¶è¿˜æ˜¯ Element</p><h3 id="åŸºæœ¬æ€æƒ³">åŸºæœ¬æ€æƒ³</h3><ul><li><p>update äº‹ä»¶çš„è§¦å‘è€…æ˜¯<strong>ç»„ä»¶</strong>. å“åº”å¼å¯¹è±¡ä¿®æ”¹åä¼šè§¦å‘å‡½æ•°, è¿™ä¸ªå‡½æ•°ä¸€å®šæ˜¯ç»„ä»¶ä¸Šçš„å‡½æ•°, Element ä¸Šå­˜ä¸äº†å‡½æ•°</p></li><li><p>å“åº”å¼å¯¹è±¡å˜åŒ–åæœ€ååº”è¯¥è§¦å‘çš„æ˜¯ä¾èµ–ç»„ä»¶çš„ <code>render</code> å‡½æ•°, <code>render</code> å‡½æ•°é‡æ–°æ‰§è¡Œå¹¶ç”Ÿæˆæ–°çš„ subTree.</p></li><li><p>æˆ‘ä»¬ä¸èƒ½ç›´æ¥å°†è€çš„ subTree åˆ é™¤æ‰æ›¿æ¢ä¸ºæ–°çš„ subTree, è¿™æ ·æ€§èƒ½æŸè€—å¤ªå¤§, <strong>æˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½å¯¹æ¯”æ–°è€ subTree, æ ¹æ®ä¸¤ä¸ª subTree ä¹‹é—´çš„å˜åŒ–åˆ·æ–° DOM</strong></p></li><li><p>æˆ‘ä»¬å¯¹æ¯”çš„æ˜¯ vNode, å­˜åœ¨ Element ä¸ç»„ä»¶ä¸¤ç§ vNode, æˆ‘ä»¬è¦åˆ†åˆ«å¯¹ä¸åŒç±»å‹ vNode è®¨è®ºæ›´æ–°æ–¹æ³•</p></li><li><p><strong>å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ª vNode æ˜¯ "åŒç±»å‹" çš„</strong></p><p>è¿™é‡Œçš„ "åŒç±»å‹" æ˜¯æŒ‡ä¸¤ä¸ª vNode å¯ä»¥é€šè¿‡ä¿®æ”¹å¯¹åº” DOM çš„å­å…ƒç´ , ä¿®æ”¹ props å®ç°æ›´æ–°, è€Œä¸éœ€è¦å¸è½½DOM.</p><ul><li><p><code>type</code> ä¸åŒçš„ vNode ä¸€å®šä¸æ˜¯åŒç±»å‹çš„</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">oldVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'å‘€å“ˆå“ˆ'</span><span class="token punctuation">)</span>
newVnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'å…‹æ´›æ´›'</span><span class="token punctuation">)</span>
newVnode2 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>HelloWorld<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¸‰ä¸ª vNode çš„ <code>type</code> ä¸åŒè¿™å¯¼è‡´ DOM æ ‡ç­¾åä¸åŒ, é“å®šæ— æ³•ä¸å¸è½½å…ƒç´ æ›´æ–°</p></li><li><p><code>props.key</code> ä¸åŒä¸€å®šä¸æ˜¯åŒç±»å‹çš„</p><p>åœ¨ Vue ä¸­æˆ‘ä»¬å¯ä»¥æŒ‡å®šå…ƒç´ çš„ key ä½œä¸ºå…ƒç´ çš„ id, ä¸åŒ id çš„å…ƒç´ ä¸€å®šæ˜¯ä¸åŒå‹çš„</p></li></ul><p>ç»¼ä¸Šæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>vNode1.type === vNode2.type &amp;&amp; vNode1.props.key === vNode2.props.key</code> åˆ¤æ–­ä¸¤ä¸ª vNode æ˜¯ä¸æ˜¯åŒç±»å‹çš„</p></li><li><p><strong>å¦‚æœä¸¤ä¸ª vNode æ˜¯ "åŒç±»å‹" çš„å¦‚ä½•æ›´æ–°</strong></p><ul><li><p><strong>vNode æ˜¯ Element å‹çš„</strong></p><p>Element å‹ vNode è¢«å®å®åœ¨åœ¨çš„æ¸²æŸ“åˆ°äº† DOM æ ‘ä¸Š, æˆ‘ä»¬å¸Œæœ›å°½é‡ä¸å¸è½½æŒ‚è½½ DOM å…ƒç´ , è€Œå¸Œæœ›åœ¨åŸ Element ä¸Šåšæ›´æ–°. æˆ‘ä»¬éœ€è¦æ›´æ–° DOM çš„å±æ€§ä¸ children</p><ul><li><p>æ›´æ–° props</p></li><li><p>æ›´æ–° children</p><p>children å¯ä»¥æ˜¯å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯ vNode æ•°ç»„, æˆ‘ä»¬éœ€è¦åˆ†ç±»è®¨è®º</p><ul><li><p>Text å‹åˆ° Text å‹:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">oldVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'å‘€å“ˆå“ˆ'</span><span class="token punctuation">)</span>
newVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'å…‹æ´›æ´›'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç›´æ¥æ›´æ–° textCont</p></li><li><p>Text å‹åˆ° Array å‹:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">oldVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'å‘€å“ˆå“ˆ'</span><span class="token punctuation">)</span>
newVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'å…‹æ´›æ´›'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'å“'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åˆ æ‰ DOM çš„ textCont, patch æ–° vNode è¿›å»</p></li><li><p>Array å‹åˆ° Text å‹:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">oldVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'å…‹æ´›æ´›'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'å“'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
newVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'å‘€å“ˆå“ˆ'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åˆ æ‰ DOM çš„æ‰€æœ‰ children, å†™å…¥ textContent</p></li><li><p>Array å‹åˆ° Array å‹: æœ€éº»çƒ¦çš„, é‡‡ç”¨åŒç«¯å¯¹æ¯”æ³•, æ‰¾åˆ°èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–çš„åŒºé—´, åˆ é™¤æ–° vNode ä¸­ä¸å­˜åœ¨çš„èŠ‚ç‚¹, åŠ å…¥æ–° vNode ä¸­ç‹¬æœ‰èŠ‚ç‚¹, è°ƒæ•´èŠ‚ç‚¹é¡ºåº</p></li></ul></li></ul></li><li><p><strong>æ–° vNode æ˜¯ç»„ä»¶å‹çš„</strong></p><p>??</p></li></ul></li><li><p><strong>å¦‚æœä¸¤ä¸ª vNode ä¸æ˜¯ "åŒç±»å‹" çš„å¦‚ä½•æ›´æ–°</strong></p><p>å¦‚æœæ˜¯è¿™ç§æƒ…å†µæˆ‘ä»¬å°±æŸæ‰‹æ— ç­–äº†</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">oldVnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'å‘€å“ˆå“ˆ'</span><span class="token punctuation">)</span>
newVnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'å…‹æ´›æ´›'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä½†æ˜¯è¿™ç§æƒ…å†µæ˜¯ä¸å­˜åœ¨çš„. è‹¥ä¸¤ä¸ªä¸åŒç±»å‹ vNode è¦æ±‚æ›´æ–°, é‚£ä¹ˆå‰é¢ä¸€å®šè°ƒç”¨è¿‡ <code>patch(vNode1, vNode2, ...)</code>, åœ¨æ›´æ–°æ—¶å“ªäº›æƒ…å†µä¼šè°ƒç”¨ <code>vNode1 !== null</code> çš„ patch å‘¢? ç»„ä»¶æ›´æ–°, åŒç±»å‹ Element çš„ Array to Array. ä¸åŒç±»å‹çš„èŠ‚ç‚¹ä¼šè¢«åŒç«¯å¯¹æ¯”ç®—æ³•è§†ä¸ºä¸åŒèŠ‚ç‚¹è€Œè¢«åˆ é™¤ / å¢åŠ æ‰. æ‰€ä»¥ä¸å¯èƒ½è®©ä¸åŒç±»å‹èŠ‚ç‚¹ <code>patch</code> åœ¨ä¸€èµ·.</p></li></ul><h3 id="æ›´æ–°-pipeline">æ›´æ–° pipeline</h3><p>è®©å“åº”å¼å¯¹è±¡æ”¯æŒä¾èµ–æ”¶é›†ä¸è§¦å‘ä¾èµ–. å°†æ•´ä¸ª renderEffect è£…å…¥ effect, è¿™æ„å‘³ç€æ¯æ¬¡å“åº”å¼å¯¹è±¡å‘ç”Ÿå˜åŒ–éƒ½ä¼šé‡å¤è°ƒç”¨ renderEffect. åŒæ—¶æˆ‘ä»¬è¦åŒºåˆ†æ˜¯ mount è¿˜æ˜¯ update, æˆ‘ä»¬å¯ä»¥è®© instance è®°å½•æ›´æ–°å‰çš„ subTree å¹¶é»˜è®¤ä¸º null å®ç°è¿™ä¸€åŠŸèƒ½</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/component.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> subTree <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>subTree<span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//    ^ ç¬¬ä¸€æ¬¡æ˜¯ null</span>
    instance<span class="token punctuation">.</span>vNode<span class="token punctuation">.</span>el <span class="token operator">=</span> container<span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> subTree<span class="token punctuation">;</span> <span class="token comment">// è®°å½•å½“å‰ subTree</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŒæ­¥ä¿®æ­£ä¸€ä¸‹ <code>createComponent</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token parameter">vNode<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token literal-property property">subTree</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹‹åéœ€è¦å®ç°:</p><ul><li>Element:<ul><li>æ›´æ–° props</li><li>æ›´æ–° children</li></ul></li><li>ç»„ä»¶<ul><li>æ›´æ–°??</li></ul></li></ul><h3 id="element-æ›´æ–°-props">Element æ›´æ–° props</h3><p>ç»™å®šæ›´æ–°å‰åçš„ vNode ä¸ç›®æ ‡ DOM å¯¹è±¡, å®ç° props æ›´æ–°.</p><ul><li><p>æ„å»ºæµ‹è¯•ç”¨ä¾‹</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> attrValue <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">attrValue</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>cnt<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    window<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      attrValue<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">attrValue</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token operator">++</span>cnt<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> attrValue<span class="token punctuation">,</span> htmlValue <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">attrValue</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>attrValue<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>å…ˆæ„å»º <code>updateElement</code> å‡½æ•°</p><p>ç”±äº <code>vNode2</code> æ²¡æœ‰è¢« mount æ‰€ä»¥ <code>vNode2.el</code> ä¸å­˜åœ¨, ä½†æ˜¯ä¸¤ä¸ª vNode å¯¹åº”çš„æ˜¯åŒä¸€ä¸ª DOM å¯¹è±¡, æˆ‘ä»¬å¯ä»¥å°† <code>vNode1.el</code> ç›´æ¥ç»™åˆ° <code>vNode2.el</code>. åŒæ—¶æˆ‘ä»¬å®šä¹‰ <code>patchProps</code> ç”¨äºå®ç°åŠŸèƒ½</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> elem <span class="token operator">=</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>el <span class="token operator">=</span> vNode1<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">patchProps</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> vNode1<span class="token operator">?.</span>props<span class="token punctuation">,</span> vNode2<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>å®ç° <code>patchProps</code></p><p>é¦–å…ˆè¦æ˜ç¡®æˆ‘ä»¬éœ€è¦ patch ä»€ä¹ˆæ ·çš„ props.</p><ul><li>ç©ºå€¼å½“ä¸å­˜åœ¨: å¦‚æœ props æ˜¯ <code>&#123;key: undefined / null&#125;</code> æˆ‘ä»¬å°±ä¸ patch è¿™ä¸ª key</li><li>value å¯èƒ½æ˜¯äº‹ä»¶ç›‘å¬: æˆ‘ä»¬å¯ä»¥å€ŸåŠ© mountElement ä¸­çš„ props å®ç°</li></ul><p>å…ˆå®ç°è¾…åŠ©å‡½æ•°åˆ¤æ–­ key æ˜¯å¦åœ¨ props ä¸Š. å¦‚æœ value æ˜¯ null / undefined / NaN ä¹Ÿå½“ key ä¸å­˜åœ¨</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/share/index.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isUNKey</span><span class="token punctuation">(</span><span class="token parameter">k<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> k <span class="token keyword">in</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å®ç° <code>patchProps</code> å‡½æ•°</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">patchProps</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">elem</span><span class="token operator">:</span> HTMLElement<span class="token punctuation">,</span> oldProps <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> newProps <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// è·å–æ‰€æœ‰ props</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>newProps<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// å‡è®¾ key æ˜¯äº‹ä»¶ç›‘å¬, å°è¯•å°†å…¶è½¬åŒ–ä¸ºå°é©¼å³°</span>
    <span class="token keyword">let</span> ek <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>
      <span class="token operator">?</span> k<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on([A-Z].*)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token operator">=></span> e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœ key åœ¨è€ vNode ä¸­å­˜åœ¨, åœ¨æ–° vNode ä¸­ä¸å­˜åœ¨: removeAttribute</span>
    <span class="token comment">// å¦‚æœ key åœ¨è€ vNode ä¸­å­˜åœ¨, æ˜¯äº‹ä»¶ç›‘å¬: è§£é™¤ é˜²æ­¢ç›‘å¬å‡½æ•°å˜åŒ–</span>
    <span class="token comment">// å¦‚æœ key åœ¨è€ vNode ä¸­å­˜åœ¨, ä¸æ˜¯äº‹ä»¶ç›‘å¬, åœ¨æ–° vNode ä¹Ÿæœ‰: ä¸ç®¡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUNKey</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> oldProps<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isUNKey</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span> <span class="token operator">||</span> ek<span class="token punctuation">)</span><span class="token punctuation">)</span>
      ek <span class="token operator">?</span> elem<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>ek<span class="token punctuation">,</span> oldProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> elem<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¸ç®¡è€èŠ‚ç‚¹æœ‰æ²¡æœ‰, æ–°èŠ‚ç‚¹æœ‰: setAttribute / addEventListener</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUNKey</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">)</span>
      ek
        <span class="token operator">?</span> elem<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>ek<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> elem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ä¸ºä»€ä¹ˆå« <code>patchProps</code> ä¸å« <code>updateProps</code>?</p><p>å®é™…ä¸Šè¿™ä¸ªå‡½æ•°ä¹Ÿå¯ä»¥ç”¨äº <code>mountElement</code> ä¸­ props å¤„ç†(ä»¤ <code>oldProps = &#123;&#125;</code>), å¹¶ä¸æ˜¯ <code>updateElement</code> ä¸“ç”¨çš„. ä¿®æ”¹</p><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">function mountElement(vNode, container, parent) &#123;
  const el &#x3D; (vNode.el &#x3D; document.createElement(vNode.type) as HTMLElement);
- Object.keys(vNode.props).forEach((k) &#x3D;&gt; &#123;
-   if (&#x2F;^on[A-Z]&#x2F;.test(k))
-     el.addEventListener(
-       k.replace(&#x2F;^on([A-Z].*)&#x2F;, (_, e) &#x3D;&gt; e[0].toLowerCase() + e.slice(1)),
-       vNode.props[k]
-     );
-   else el.setAttribute(k, vNode.props[k]);
- &#125;);
+ patchProps(el, &#123;&#125;, vNode.props);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="element-æ›´æ–°-children-å‰ä¸‰ç§æƒ…å†µ">Element æ›´æ–° children å‰ä¸‰ç§æƒ…å†µ</h3><ul><li><p>Text to Text</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">T2T</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> ot <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      ot<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ot <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ot <span class="token operator">?</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token constant">T2T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åªéœ€ä¿®æ”¹ DOM å†…éƒ¨ textContent, å¦‚æœå†…å®¹ä¸å˜å°±ä¸ä¿®æ”¹</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>children <span class="token operator">!==</span> vNode1<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
     container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vNode2<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>Array to Text</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">A2T</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> ot <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      ot<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ot <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ot
      <span class="token operator">?</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°† DOM ä¸­æ‰€æœ‰ Element éƒ½åˆ é™¤, å†™å…¥ conteneText</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span>
      <span class="token punctuation">[</span><span class="token operator">...</span>container<span class="token punctuation">.</span>children<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿™é‡Œåˆå¹¶äº†ä¸‹ä»£ç , å¦‚æœæ˜¯ Array to Text, é‚£ä¹ˆ Array !== string ä¸€å®šæˆç«‹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>children <span class="token operator">!==</span> vNode1<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
      container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vNode2<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>Text to Array</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">T2A</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> ot <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      ot<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> ot <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ot
      <span class="token operator">?</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'after'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'before'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ é™¤å†…éƒ¨ textContent æ’å…¥ vNode æ•°ç»„</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span>
      <span class="token punctuation">[</span><span class="token operator">...</span>container<span class="token punctuation">.</span>children<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>children <span class="token operator">!==</span> vNode1<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
      container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vNode2<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      vNode2<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> element<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ä¸º Array to Array é¢„ç•™å‡½æ•°è°ƒç”¨ <code>patchKeyedChildren</code></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span>
      <span class="token punctuation">[</span><span class="token operator">...</span>container<span class="token punctuation">.</span>children<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode2<span class="token punctuation">.</span>children <span class="token operator">!==</span> vNode1<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
      container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> vNode2<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>shapeFlags <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      container<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      vNode2<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> element<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>children<span class="token punctuation">,</span> vNode2<span class="token punctuation">.</span>children<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="element-æ›´æ–°-children-çš„åŒç«¯å¯¹æ¯”æ³•">Element æ›´æ–° children çš„åŒç«¯å¯¹æ¯”æ³•</h3><p><strong>åŸºæœ¬æ€æƒ³</strong></p><p>åˆ†åˆ«ä»å·¦è¾¹å³è¾¹å¯¹æ¯”å…ƒç´ , æ‰¾åˆ°å‘ç”Ÿå˜åŒ–çš„åŒºé—´, ä¾‹å¦‚å‰åä¸¤ä¸ª Array åˆ†åˆ«ä¸º</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span> a b c d e f g h <span class="token punctuation">]</span>
<span class="token punctuation">[</span> a b e d i g h <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä»å·¦è¾¹æ‰¾æ‰¾åˆ°åªæœ‰ <code>a b</code> æ˜¯ç›¸åŒçš„</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span> a b <span class="token operator">|</span> c d e f g h <span class="token punctuation">]</span>
<span class="token punctuation">[</span> a b <span class="token operator">|</span> e d i g h <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä»å³è¾¹æ‰¾æ‰¾åˆ°åªæœ‰ <code>g h</code> æ˜¯ç›¸åŒçš„</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span> a b <span class="token operator">|</span> c d e f <span class="token operator">|</span> g h <span class="token punctuation">]</span>
<span class="token punctuation">[</span> a b <span class="token operator">|</span> e d i <span class="token operator">|</span> g h <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æœ€åæˆ‘ä»¬æ‰¾åˆ°å˜åŒ–åŒºé—´(<code>[c d e f] -&gt; [e d i]</code>)</p><p>å°†è€ vNode ç‹¬æœ‰çš„å­ vNode ç§»é™¤(<code>[c f]</code>), å°†æ–° vNode ç‹¬æœ‰çš„å­ vNode patchä¸Š(<code>[i]</code>), è°ƒæ•´å­ vNode çš„é¡ºåº. å¯ä»¥ä½¿ç”¨ <code>insertBefore</code> è°ƒæ•´é¡ºåº.</p><ul><li><p>åˆ é™¤è€ vNode ç‹¬æœ‰å­å…ƒç´ </p><p>ä¸ºæ–° vNode å˜åŒ–åŒºé—´ä¸Šçš„å…ƒç´ ç¼–å·, å»ºç«‹ <code>key -&gt; index</code> çš„æ˜ å°„. éå†è€èŠ‚ç‚¹, å¦‚æœæ²¡æœ‰æŸ¥åˆ° key å°±åˆ é™¤èŠ‚ç‚¹</p></li><li><p>åˆ›å»ºæ–° vNode ç‹¬æœ‰çš„å­å…ƒç´ : åœ¨è°ƒæ•´ä½ç½®æ—¶ä¸€å¹¶å¤„ç†</p></li><li><p>è°ƒæ•´ä½ç½®</p><p>å¯ä»¥é€šè¿‡ä¹‹å‰å»ºç«‹çš„ <code>key -&gt; index</code> æ˜ å°„ä¸€è‚¡è„‘çš„å°† DOM è°ƒæ•´åˆ°æ­£å¸¸ä½ç½®, ä½†æ˜¯è°ƒæ•´ DOM çš„ä»£ä»·å¤ªé«˜äº†, æˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½å°‘çš„å‡å°‘ <code>insertBefore</code> æ“ä½œ.</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span>l1 l2 <span class="token function">l3</span> <span class="token punctuation">(</span> a b c d e f g h i <span class="token punctuation">)</span> r1 r2 r3<span class="token punctuation">]</span>
<span class="token punctuation">[</span>l1 l2 <span class="token function">l3</span> <span class="token punctuation">(</span> i a b c d e f g h <span class="token punctuation">)</span> r1 r2 r3<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¦‚æœé‡‡ç”¨ä¸€èˆ¬æ–¹æ³•, æˆ‘ä»¬éœ€è¦åˆ†åˆ«å°† <code>a - h</code> ç§»åŠ¨åˆ° <code>r1</code> å‰é¢. è¿™æ˜æ˜¾ä¸å¦‚å°† <code>i</code> ç§»åŠ¨åˆ° <code>a</code> å‰é¢åˆ’ç®—.</p><p>æˆ‘ä»¬å¯ä»¥åœ¨åŸ vNode çš„å­ vNode æ•°ç»„ä¸­å®šä¹‰ä¸€ä¸ªç¨³å®šä¸², ä¿è¯ç¨³å®šä¸²ä¸­çš„å…ƒç´ ç›¸å¯¹ä½ç½®ç¬¦åˆæ–° vNode è®¾å®š, æˆ‘ä»¬åªéœ€è¦éå†æ–° vNode çš„å­å…ƒç´ , å¦‚æœè¯¥å…ƒç´ æ²¡æœ‰åœ¨è€ vNode ä¸­å‡ºç°å°±åˆ›å»ºå¹¶å°†å…¶ patch åˆ°æŒ‡å®šä½ç½®, å¦‚æœåœ¨éç¨³å®šä¸²ä¸­å‡ºç°æˆ‘ä»¬å°±å°†å…¶ <code>insetBefore</code> åˆ°æŒ‡å®šä½ç½®. è€ƒè™‘åˆ°æˆ‘ä»¬åªæœ‰ <code>insertBefore</code> æ²¡æœ‰ <code>insertAfter</code> å‡½æ•°, æˆ‘ä»¬è¿˜éœ€è¦ä¿è¯ä¸€ä¸ªå…ƒç´ åœ¨ <code>insertBefore</code> å‰ä»–åä¸€ä¸ªçš„å…ƒç´ å·²ç»å°±ä½äº†. æ‰€ä»¥æˆ‘ä»¬éœ€è¦å€’ç€éå†æ–° vNode.</p><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­, å¯ä»¥å°† <code>a b c d e f g h</code> è§†ä½œç¨³å®šä¸², è°ƒæ•´ <code>i</code> åˆ° <code>a</code> å‰å³å¯</p></li><li><p>å°† vNode patch åˆ°æŒ‡å®šä½ç½®</p><p>æƒ³è¦å°† Element è°ƒæ•´åˆ°æŒ‡å®š Element å‰é¢, æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ <code>container.insertBefore(elem, target)</code>, å¦‚æœ <code>target == null</code> å°±å°†å…ƒç´ è°ƒæ•´åˆ° container å°¾éƒ¨.</p><p>ä½†æ˜¯å¦‚æœæƒ³å°†æ–° vNode è°ƒæ•´åˆ°æŒ‡å®š Element å‰é¢å°±éœ€è¦è°ƒç”¨ patch äº†, æˆ‘ä»¬éœ€è¦ä¸º patch åŠ å…¥ä¸€ä¸ªé”šç‚¹å‚æ•°æŒ‡å®šå°† vNode patch åˆ°å“ªé‡Œ: <code>patch(vNode1, vNode2, container, parent = null, anchor = null)</code></p></li><li><p>å¯»æ‰¾ç¨³å®šä¸²</p><p>å¯»æ‰¾ç¨³å®šä¸²å…¶å®å°±æ˜¯å¯»æ‰¾ç›¸å¯¹ä½ç½®æ­£ç¡®çš„å°½å¯èƒ½é•¿çš„å­ä¸², æˆ‘ä»¬åˆå·²çŸ¥é“è€èŠ‚ç‚¹å¯¹åº”çš„æ–°èŠ‚ç‚¹æœ‰ä¸€ä¸ª <code>key -&gt; index</code> çš„æ˜ å°„, åœ¨æ–°èŠ‚ç‚¹ä¸­, index ä¸¥æ ¼é€’å¢, æ‰€ä»¥å¯ä»¥è·å–æ¯ä¸ªè€èŠ‚ç‚¹å¯¹åº”çš„ index å¹¶æŸ¥æ‰¾ LIS. ä¾‹å¦‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">oldIndex</span><span class="token operator">:</span>  <span class="token number">0</span>  <span class="token number">1</span>  <span class="token number">2</span>    <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span> <span class="token number">10</span> <span class="token number">11</span> <span class="token number">3</span>   <span class="token number">12</span> <span class="token number">13</span> <span class="token number">14</span>
<span class="token literal-property property">oldVNode</span><span class="token operator">:</span> <span class="token punctuation">[</span>l1 l2 <span class="token function">l3</span> <span class="token punctuation">(</span> a b c d e f g  h  i <span class="token punctuation">)</span> r1 r2 r3<span class="token punctuation">]</span>
<span class="token literal-property property">newVNode</span><span class="token operator">:</span> <span class="token punctuation">[</span>l1 l2 <span class="token function">l3</span> <span class="token punctuation">(</span> i a b c d e f  g  h <span class="token punctuation">)</span> r1 r2 r3<span class="token punctuation">]</span>
<span class="token literal-property property">newIndex</span><span class="token operator">:</span>  <span class="token number">0</span>  <span class="token number">1</span>  <span class="token number">2</span>    <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span>  <span class="token number">10</span> <span class="token number">11</span>  <span class="token number">12</span> <span class="token number">13</span> <span class="token number">14</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥å¾—åˆ° <code>lis = [a b c d e f g h]</code></p></li></ul><p><strong>ç‰¹æ®Šæƒ…å†µ</strong></p><p>å¯ä»¥é’ˆå¯¹éƒ¨åˆ†ç‰¹æ®Šæƒ…å†µç‰¹æ®Šå¤„ç†é¿å…è®¡ç®— LIS</p><ul><li><p>æ–° vNode åªåœ¨æœ€å³è¾¹åŠ äº†ä¸€å †å…ƒç´ : åªéœ€è¦ patch å¤šå‡ºæ¥çš„éƒ¨åˆ†</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">old</span><span class="token operator">:</span> <span class="token punctuation">[</span>a b c<span class="token punctuation">]</span>
<span class="token keyword">new</span><span class="token operator">:</span> <span class="token punctuation">[</span>a b c d e f<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>æ–° vNode åªåœ¨æœ€å·¦è¾¹åŠ äº†ä¸€å †å…ƒç´ : åªéœ€è¦ patch å¤šå‡ºæ¥çš„éƒ¨åˆ†</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">old</span><span class="token operator">:</span> <span class="token punctuation">[</span>      d e f<span class="token punctuation">]</span>
<span class="token keyword">new</span><span class="token operator">:</span> <span class="token punctuation">[</span>a b c d e f<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>æ–° vNode åªæœ€å³è¾¹å°‘äº†ä¸€å †å…ƒç´ : remove å¤šä½™ vNode çš„ DOM å…ƒç´ . æ³¨æ„è¿™é‡Œ remove çš„ä¸èƒ½æ˜¯ vNode, è¿™æ ·ä¸ç®¡å­ vNode æ˜¯ Element è¿˜æ˜¯ç»„ä»¶ç±»å‹çš„éƒ½å¯ä»¥ä¸€é”®å¸è½½(å› ä¸º ELement æˆ– ç»„ä»¶ç±»å‹çš„ vNode å¯¹åº”çš„ DOM æ ‘éƒ½ä¸€å®šåªæœ‰ä¸€ä¸ªæ ¹ Element)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">old</span><span class="token operator">:</span> <span class="token punctuation">[</span>a b c d e f<span class="token punctuation">]</span>
<span class="token keyword">new</span><span class="token operator">:</span> <span class="token punctuation">[</span>a b c<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>æ–° vNode åªæœ€å·¦è¾¹å°‘äº†ä¸€å †å…ƒç´ : remove å¤šä½™ vNode çš„ DOM å…ƒç´ </p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">old</span><span class="token operator">:</span> <span class="token punctuation">[</span>a b c d e f<span class="token punctuation">]</span>
<span class="token keyword">new</span><span class="token operator">:</span> <span class="token punctuation">[</span>      d e f<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><p><strong>æˆ‘çš„éƒ¨åˆ†å®ç°</strong></p><p>å®šä¹‰</p><ul><li><code>c1, c2</code>: æ›´æ–°å‰å vNode çš„ children æ•°ç»„</li><li><code>anchor</code>: é”šç‚¹</li><li><code>i</code>: å˜åŒ–åŒºé—´çš„å·¦è¾¹ç•Œ(åŒ…æ‹¬)</li><li><code>e1, e2</code>: å˜åŒ–åŒºé—´å¯¹åº” <code>c1, c2</code> çš„å³è¾¹ç•Œ(åŒ…æ‹¬)</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span><span class="token parameter">c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
    e2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">// ä»å·¦å¾€å³çœ‹, å¦‚æœç±»å‹ä¸åŒæˆ–è€… key ä¸åŒå°±é€€å‡º, å¦åˆ™é€’å½’æ›´æ–°å­èŠ‚ç‚¹</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">!==</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">||</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>key <span class="token operator">!==</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token function">patch</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// ä»å³å¾€å·¦çœ‹, å¦‚æœç±»å‹ä¸åŒæˆ–è€… key ä¸åŒå°±é€€å‡º, å¦åˆ™é€’å½’æ›´æ–°å­èŠ‚ç‚¹</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> e1 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> e2 <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> e1 <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">,</span> e2 <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">!==</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">||</span> c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>key <span class="token operator">!==</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token function">patch</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å³ä¾§æœ‰æ–°èŠ‚ç‚¹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> c1<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    c2<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span>
      <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> i <span class="token operator">>=</span> c2<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å³ä¾§æœ‰è€èŠ‚ç‚¹</span>
  <span class="token comment">//     ä¼ å…¥çš„æ˜¯ vNode è¦åŠ ä¸Š el æ‰¾åˆ° DOM å¯¹è±¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> c2<span class="token punctuation">.</span>length<span class="token punctuation">)</span> c1<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å·¦ä¾§æœ‰æ–°èŠ‚ç‚¹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e1 <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> e2 <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    c2<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span>
      <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> c1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å·¦ä¾§æœ‰è€èŠ‚ç‚¹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e2 <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> e1 <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> c1<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ä¸­é—´</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> newRange <span class="token operator">=</span> c2<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> oldRange <span class="token operator">=</span> c1<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> k2iNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span>newRange<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">,</span> i <span class="token operator">+</span> idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> k2iOld <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>oldRange<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    oldRange<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
       <span class="token comment">// æ–°çš„æœ‰, è€çš„æœ‰ ç›´æ¥æ›´æ–°</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>k2iNew<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">patch</span><span class="token punctuation">(</span>
          d<span class="token punctuation">,</span>
          c2<span class="token punctuation">[</span>k2iNew<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token keyword">as</span> number<span class="token punctuation">]</span><span class="token punctuation">,</span>
          container<span class="token punctuation">,</span>
          parent<span class="token punctuation">,</span>
          anchor
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// æ–°çš„æ²¡æœ‰, è€çš„æœ‰ ç›´æ¥åˆ é™¤</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>k2iNew<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        d<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        k2iOld<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ–°çš„æœ‰è€çš„æ²¡æœ‰ æ–°å»ºåˆ°é—®é¢˜åŒºé—´çš„å°¾éƒ¨</span>
    newRange<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>k2iOld<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">patch</span><span class="token punctuation">(</span>
          <span class="token keyword">null</span><span class="token punctuation">,</span>
          c2<span class="token punctuation">[</span>k2iNew<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token keyword">as</span> number<span class="token punctuation">]</span><span class="token punctuation">,</span>
          container<span class="token punctuation">,</span>
          parent<span class="token punctuation">,</span>
          e2 <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> c2<span class="token punctuation">.</span>length <span class="token operator">?</span> c2<span class="token punctuation">[</span>e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el <span class="token operator">:</span> <span class="token keyword">null</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        k2iOld<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... è°ƒæ•´ä½ç½®</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>å­˜åœ¨çš„é—®é¢˜</strong></p><ul><li><p>åœ¨ä¸­é—´å¯¹æ¯”æ—¶: æ–°çš„æœ‰è€çš„æ²¡æœ‰çš„æƒ…å†µå¯ä»¥åˆå¹¶åˆ°è°ƒæ•´ä½ç½®ä¸Š</p></li><li><p>ä¸ºåªç”¨å››ä¸ª if è€ƒè™‘äº†ç‰¹æ®Šæƒ…å†µ, æ²¡æœ‰è€ƒè™‘ç‰¹æ®Šæƒ…å†µçš„çš„æ‰©å±•</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">old <span class="token operator">=</span> <span class="token punctuation">[</span>a b c d e f<span class="token punctuation">]</span>
<span class="token keyword">new</span> <span class="token operator">=</span> <span class="token punctuation">[</span>a b     e f<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ—¢ç„¶ä»å·¦å¾€å³çœ‹ <code>[a b]</code> ä¸€æ ·, æˆ‘ä»¬å¯ä»¥å‡è£…æ¶ˆæ‰ <code>[a b]</code> æŠŠ <code>[c d]</code> çœ‹æˆåªæœ‰å·¦ä¾§æœ‰å¤šäºå…ƒç´ çš„æƒ…å†µæ­¤æ—¶ç›´æ¥æ¶ˆé™¤ <code>[c d]</code> å³å¯, ç±»ä¼¼çš„è¿˜æœ‰</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">old <span class="token operator">=</span> <span class="token punctuation">[</span>a b     e f<span class="token punctuation">]</span>
<span class="token keyword">new</span> <span class="token operator">=</span> <span class="token punctuation">[</span>a b c d e f<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¦‚æœå¯ä»¥ç‰¹åˆ¤è¿™ç§æƒ…å†µå°±çˆ½æ­»äº†</p></li></ul><p><strong>åˆ«ä¸ªçš„å®ç°</strong></p><p>mini-vue çš„å®ç°å’ŒåŸç‰ˆçš„å·®ä¸å¤š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span> <span class="token parameter">c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentAnchor<span class="token punctuation">,</span> parentComponent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> l2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> e2 <span class="token operator">=</span> l2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">isSameVNodeType</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> n1<span class="token punctuation">.</span>type <span class="token operator">===</span> n2<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> n1<span class="token punctuation">.</span>key <span class="token operator">===</span> n2<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token comment">// ... æ±‚ i e1 e2</span>
  <span class="token comment">// äººå®¶åœ¨è¿™é‡Œæ˜¯æ¯”è¾ƒäº† e1 e2 i çš„å…³ç³», è¿™æ ·å˜ç›¸çš„ "æ¶ˆé™¤" æ‰äº†å‰åç½®å…ƒç´ </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> nextPos <span class="token operator">=</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextPos <span class="token operator">&lt;</span> l2 <span class="token operator">?</span> c2<span class="token punctuation">[</span>nextPos<span class="token punctuation">]</span><span class="token punctuation">.</span>el <span class="token operator">:</span> parentAnchor<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> parentComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> e2 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">hostRemove</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
      i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ... ä¸­é—´å¯¹æ¯”</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªæ˜æ˜¾ä¸å¦‚å››ä¸ª if æ¥çš„ç›´è§‚, ä½†æ˜¯é¡ºé“å¤„ç†äº†ç‰¹æ®Šæƒ…å†µçš„æ‰©å±•æƒ…å†µ. æœ‰ä¸€è¯´ä¸€ vuejs/core åœ¨è¿™ä¸€æ®µä¸­ä»£ç çš„æ³¨é‡Šä¸­ä¹Ÿæ²¡æœ‰æèµ·è¿™ç§æƒ…å†µ, ä½†æ˜¯é€šè¿‡è¿™ä¸ªæ³›æ³›çš„åˆ¤æ–­æ¡ä»¶æˆ‘ä»¬ç¡®å®æ•è·åˆ°äº†è¿™ç§æƒ…å†µ. çœ‹èµ·æ¥è¿™æ˜¯ä¸€ä¸ªæ— æ„ä¸ºä¹‹çš„ä¼˜åŒ–?</p><p><strong>æœ€ç»ˆå®ç°</strong></p><ul><li><p>å®ç° diff</p><p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span>
<span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">c1</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">c2</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
    e2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">isSameType</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v1<span class="token punctuation">,</span> v2</span><span class="token punctuation">)</span> <span class="token operator">=></span>
    v1<span class="token punctuation">.</span>type <span class="token operator">===</span> v2<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> v1<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key <span class="token operator">===</span> v2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token comment">// æ‰¾åˆ°åŒºé—´</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSameType</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token function">patch</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> e1 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> e2 <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> e1 <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">,</span> e2 <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSameType</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token function">patch</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ç‰¹åˆ¤</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e2 <span class="token operator">&lt;</span> i <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> c1<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span> d<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e1 <span class="token operator">&lt;</span> i <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span>
    c2<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=></span>
      <span class="token function">patch</span><span class="token punctuation">(</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        d<span class="token punctuation">,</span>
        container<span class="token punctuation">,</span>
        parent<span class="token punctuation">,</span>
        e1 <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">>=</span> c1<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> c1<span class="token punctuation">[</span>e1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ä¸­é—´</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> newRange <span class="token operator">=</span> c2<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> oldRange <span class="token operator">=</span> c1<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> new2oldIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ–°èŠ‚ç‚¹ index -> è€èŠ‚ç‚¹ index</span>
    <span class="token keyword">const</span> key2indexNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span> <span class="token comment">// æ–°èŠ‚ç‚¹ key -> æ–°èŠ‚ç‚¹ index</span>
      newRange<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span>d<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">,</span> i <span class="token operator">+</span> idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœè€èŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹ä¸­å­˜åœ¨ æ„é€  æ–°èŠ‚ç‚¹ index -> è€èŠ‚ç‚¹ index</span>
    <span class="token comment">//                     ä¸å­˜åœ¨ åˆ é™¤è€èŠ‚ç‚¹</span>
    oldRange<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key2indexNew<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        new2oldIndex<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key2indexNew<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> vnode<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lis <span class="token operator">=</span> <span class="token constant">LIS</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>new2oldIndex<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ„å»ºç¨³å®šåºåˆ—</span>
    newRange<span class="token punctuation">.</span><span class="token function">reduceRight</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> curIndex</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> oldVnode <span class="token operator">=</span> oldRange<span class="token punctuation">[</span>new2oldIndex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>curIndex <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// å¯¹åº”è€èŠ‚ç‚¹(å¦‚æœå­˜åœ¨)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lis<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>curIndex <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// å¤„äºç¨³å®šåºåˆ—å°±åªæ›´æ–°</span>
          <span class="token keyword">return</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> prev<span class="token operator">?.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>new2oldIndex<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>curIndex <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// ä¸åœ¨å°±ç§»åŠ¨èŠ‚ç‚¹</span>
          container<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> prev<span class="token operator">?.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> prev<span class="token operator">?.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> cur<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> prev<span class="token operator">?.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ²¡æœ‰è€èŠ‚ç‚¹å°±åŠ å…¥</span>
        <span class="token keyword">return</span> cur<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      e2 <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">>=</span> c2<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> c2<span class="token punctuation">[</span>e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p></li><li><p>å®ç° LIS</p><p>å®šä¹‰ <code>low</code> æ•°ç»„, <code>low[i]</code> è¡¨ç¤ºé•¿åº¦ä¸º <code>i</code> çš„LISç»“å°¾å…ƒç´ çš„æœ€å°å€¼. å¯¹äºä¸€ä¸ªä¸Šå‡å­åºåˆ—ï¼Œæ˜¾ç„¶å…¶ç»“å°¾å…ƒç´ è¶Šå°, è¶Šæœ‰åˆ©äºåœ¨åé¢æ¥å…¶ä»–çš„å…ƒç´ , ä¹Ÿå°±è¶Šå¯èƒ½å˜å¾—æ›´é•¿. å› æ­¤, æˆ‘ä»¬åªéœ€è¦ç»´æŠ¤ <code>low</code> æ•°ç»„ï¼Œå¯¹äºæ¯ä¸€ä¸ª <code>s[i]</code>ï¼Œå¦‚æœ <code>s[i] &gt; low[å½“å‰æœ€é•¿çš„LISé•¿åº¦]</code>ï¼Œå°±æŠŠ <code>a[i]</code> æ¥åˆ°å½“å‰æœ€é•¿çš„ LIS åé¢ï¼Œå³ <code>low[++å½“å‰æœ€é•¿çš„LISé•¿åº¦] = a[i]</code> å¯¹äºæ¯ä¸€ä¸ª <code>s[i]</code> ï¼Œå¦‚æœ <code>s[i]</code> èƒ½æ¥åˆ° LIS åé¢ï¼Œå°±æ¥ä¸Šå». å¦åˆ™ï¼Œå°±ç”¨ <code>s[i]</code> å–æ›´æ–° <code>low</code> æ•°ç»„ã€‚å…·ä½“æ–¹æ³•æ˜¯, åœ¨ <code>low</code> æ•°ç»„ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äº <code>s[i]</code> çš„å…ƒç´  <code>low[j]</code>, ç”¨ <code>s[i]</code> å»æ›´æ–° <code>low[j]</code>. å¦‚æœä»å¤´åˆ°å°¾æ‰«ä¸€é <code>low</code> æ•°ç»„çš„è¯ï¼Œæ—¶é—´å¤æ‚åº¦ä»æ˜¯ <span class="math inline">\(O(n^2)\)</span>. æˆ‘ä»¬æ³¨æ„åˆ° <code>low</code> æ•°ç»„å†…éƒ¨ä¸€å®šæ˜¯å•è°ƒä¸é™çš„. æ‰€æœ‰æˆ‘ä»¬å¯ä»¥äºŒåˆ† <code>low</code> æ•°ç»„ï¼Œæ‰¾å‡ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº <code>s[i]</code> çš„å…ƒç´ . æ€»æ—¶é—´å¤æ‚åº¦ä¸º <span class="math inline">\(O(n \log n)\)</span></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/share/index.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token constant">LIS</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> low <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>s<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> s<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> cur <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      j <span class="token operator">=</span> res<span class="token punctuation">[</span>res<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> cur<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        low<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">let</span> u <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> v <span class="token operator">=</span> res<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>u <span class="token operator">&lt;</span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token punctuation">(</span>u <span class="token operator">+</span> v<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span>res<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> cur<span class="token punctuation">)</span> u <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> v <span class="token operator">=</span> c<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">&lt;</span> s<span class="token punctuation">[</span>res<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> low<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        res<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">let</span> u <span class="token operator">=</span> res<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">let</span> v <span class="token operator">=</span> res<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>u<span class="token operator">--</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
    v <span class="token operator">=</span> low<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>ä¸ºä»€ä¹ˆè¦ç”¨åŒç«¯å¯¹æ¯”æ³•</strong></p><ul><li>åŒç«¯å¯¹æ¯”æ³•çš„ç†è®ºæ€§èƒ½å¯èƒ½å¹¶ä¸æ˜¯æœ€ä¼˜ç§€çš„, ä½†æ˜¯å…¶ç”¨äºå‰ç«¯ vNode list çš„å¯¹æ¯”å¾ˆä¼˜ç§€, å› ä¸ºå‰ç«¯ DOM çš„ä¿®æ”¹å¾ˆå°‘æ¶‰åŠå…¨å±€ä¿®æ”¹, ä¸€èˆ¬éƒ½æ˜¯ä¸€ä¸¤ä¸ªå…ƒç´ çš„å¢å‡è°ƒæ¢, åŒç«¯å¯¹æ¯”æ³•å¯ä»¥å¿«é€Ÿé”å®šä¿®æ”¹åŒºé—´, å¿½ç•¥ä¸å˜éƒ¨åˆ†, LIS å¯ä»¥ä¿è¯åœ¨è¾ƒå°‘æ’å…¥æ¬¡æ•°ä¸‹å®ç°ä½ç½®è°ƒæ•´</li><li>ä¸ºä»€ä¹ˆè¦è®¨è®ºç‰¹æ®Šæƒ…å†µ, æ˜æ˜å¯ä»¥ç›´æ¥åˆ©ç”¨æœ€åçš„é€šç”¨ç®—æ³•æ±‚è§£. é¦–å…ˆè¿™ä¸ªç‰¹åˆ¤ä¼šè®©å•æ¬¡ update å¿«å¾ˆå¤š, åŒæ—¶è€ƒè™‘å‰ç«¯åº”ç”¨åœºæ™¯, update å•ä¸ªå¤´å°¾ / ä¸­éƒ¨å…ƒç´ æ¯”è¾ƒé¢‘ç¹, è¿™ä¸ªç‰¹åˆ¤ä¼šè¢«ç‰¹åˆ«å¤šæ¬¡è°ƒç”¨</li></ul><h3 id="ç»„ä»¶æ›´æ–°">ç»„ä»¶æ›´æ–°</h3><p>ç»„ä»¶ vNode æ›´æ–°æ—¶ <code>setupRenderEffect</code> ä¼šè§¦å‘ <code>patch(ç»„ä»¶vNode, ...)</code> æœ€å <code>updateComponent</code></p><p>ä¸ç®¡ç»„ä»¶æœ‰å¤šå¤æ‚æˆ‘ä»¬æ›´æ–°çš„éƒ½æ˜¯ç»„ä»¶æŒ‚è½½çš„ DOM, ç»„ä»¶çš„ render è¿”å›çš„æ˜¯ä¸€ä¸ª <code>h</code> ä¹Ÿå°±æ˜¯è¯´ç»„ä»¶æœ€å¤šæœ‰ä¸€ä¸ªæ ¹ DOM, æˆ‘ä»¬å¯ä»¥ç›´æ¥æ›´æ–°è¿™ä¸ª DOM.</p><p>æˆ‘ä»¬æ›´æ–°çš„æ—¶å€™æ‹¿åˆ°çš„æ˜¯ vNode, ä½†æ˜¯ä¸ºç»„ä»¶ä¼ å…¥çš„ props è¿˜åœ¨ instance ä¸Š, æˆ‘ä»¬éœ€è¦ä¸º vNode ç»‘å®š instance (ä½¿ç”¨ <code>.component</code> å±æ€§)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/render.ts</span>
<span class="token keyword">function</span> <span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token parameter">vNode1<span class="token punctuation">,</span> vNode2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  vNode2<span class="token punctuation">.</span>el <span class="token operator">=</span> vNode1<span class="token punctuation">.</span>el<span class="token punctuation">;</span> <span class="token comment">// ç»‘å®š DOM</span>
  vNode2<span class="token punctuation">.</span>component <span class="token operator">=</span> vNode1<span class="token punctuation">.</span>component<span class="token punctuation">;</span> <span class="token comment">// ç»‘å®š instance</span>
  <span class="token comment">// åˆ¤æ–­ props ä¸€ä¸ä¸€æ ·: ä¸€æ ·å°±ä¸æ›´æ–° (è¯´æ˜æ˜¯çˆ¶èŠ‚ç‚¹è§¦å‘äº†, é€’å½’åˆ°å­èŠ‚ç‚¹)</span>
  <span class="token comment">//                      ä¸ä¸€æ ·å°±é‡æ–°æ¸²æŸ“è¿™ä¸ªç»„ä»¶ä¸‹çš„ vNode</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameProps</span><span class="token punctuation">(</span>vNode1<span class="token punctuation">.</span>props<span class="token punctuation">,</span> vNode2<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    vNode1<span class="token punctuation">.</span>component<span class="token punctuation">.</span>vNode <span class="token operator">=</span> vNode2<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// æˆ‘ä»¬è¦æ‰‹åŠ¨è§¦å‘è¿™ä¸ªå”¯ä¸€çš„å­ vNode çš„render, æ‰€ä»¥è¿˜éœ€è¦ä¿å­˜æ¯ä¸ª vNode çš„ render å‡½æ•°</span>
    <span class="token comment">// ä¿å­˜åœ¨ `.runner`</span>
    <span class="token comment">// åŒæ—¶è®°å½• .next ä¸ºæ–° vNode</span>
    vNode1<span class="token punctuation">.</span>component<span class="token punctuation">.</span>next <span class="token operator">=</span> vNode2<span class="token punctuation">;</span>
    <span class="token comment">// è°ƒç”¨è€ vNode çš„æ¸²æŸ“å‡½æ•°</span>
    vNode1<span class="token punctuation">.</span>component<span class="token operator">?.</span>runner <span class="token operator">&amp;&amp;</span> vNode1<span class="token punctuation">.</span>component<span class="token punctuation">.</span><span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ¤æ–­ç»„ä»¶æ˜¯å¦æœ‰å¿…è¦æ›´æ–°(<code>props</code> ä¸€ä¸ä¸€æ ·)</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// @packages/runtime-core/src/component.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isSameProps</span><span class="token punctuation">(</span><span class="token parameter">props1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> props2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>props1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>props2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=></span> props1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">!==</span> props2<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨æŒ‚è½½ç»„ä»¶æ—¶åŒæ­¥è®°å½• instance</p><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">&#x2F;&#x2F; @packages&#x2F;runtime-core&#x2F;src&#x2F;render.ts
function mountComponent(vNode, container, parent, anchor) &#123;
  const instance &#x3D; createComponent(vNode, parent);
+ vNode.component &#x3D; instance;
  setupComponent(instance);
  setupRenderEffect(instance, container, anchor);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨é‡æ–°æ¸²æŸ“ç»„ä»¶æ—¶è¿ç§» props</p><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">&#x2F;&#x2F; @packages&#x2F;runtime-core&#x2F;src&#x2F;component.ts
export function setupRenderEffect(instance, container, anchor) &#123;
+ instance.runner &#x3D; effect(() &#x3D;&gt; &#123;
    const subTree &#x3D; instance.render.call(instance.proxy);
+   if (instance.next) &#123;
+     instance.vNode &#x3D; instance.next;
+     instance.props &#x3D; instance.next.props;
+     instance.next &#x3D; null;
+   &#125;
    patch(instance.subTree, subTree, container, instance, anchor);
    instance.vNode.el &#x3D; container;
    instance.subTree &#x3D; subTree;
  &#125;);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><footer class="post-footer"><p class="post-end-coffee">-------- æœ¬æ–‡ç»“æŸ <i class="fa-solid fa-mug-hot"></i> æ„Ÿè°¢é˜…è¯» --------</p><div class="popular-posts-header">ç›¸å…³æ–‡ç« </div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/article/Vue23åŸºç¡€/" rel="bookmark">Vue2/3å…¥é—¨ç¬”è®°</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/article/Ajaxä¸Axiosçš„ä½¿ç”¨ä¸å…³é”®æºç ç¬”è®°/" rel="bookmark">Ajaxä¸Axiosçš„ä½¿ç”¨ä¸å…³é”®æºç ç¬”è®°</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/article/BootStrapç¬”è®°/" rel="bookmark">BootStrap ç¬”è®°</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/article/2022å¯’å‡å­—èŠ‚è·³åŠ¨å‰ç«¯è®­ç»ƒè¥ç¬”è®°/" rel="bookmark">2022å¯’å‡å­—èŠ‚è·³åŠ¨å‰ç«¯è®­ç»ƒè¥ç¬”è®°</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/article/Canvaså­¦ä¹ ç¬”è®°/" rel="bookmark">Canvaså­¦ä¹ ç¬”è®°</a></div></li></ul><script>let post_body = document.querySelector('.post-body');
  let theme_switch = document.getElementById('theme_switch');
  const theme = {};
  Object.defineProperty(theme, 'value', {
    set(v){
      post_body.setAttribute('theme', v);
      localStorage.setItem('md_theme', v);
      theme_switch.value = v;
    }
  })
  theme.value = localStorage.getItem('md_theme') || 'sneh';
  theme_switch.addEventListener('change',e=>theme.value = e.target.value)
  document.getElementById('theme_switch_wapper').classList.remove('hidden');</script><div class="reward-container"><div></div><button>èµèµ</button><div class="post-reward"><div><img src="/images/wechatpay.png" alt="Liu Kairui å¾®ä¿¡"> <span>å¾®ä¿¡</span></div><div><img src="/images/alipay.png" alt="Liu Kairui æ”¯ä»˜å®"> <span>æ”¯ä»˜å®</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š </strong>Liu Kairui</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong> <a href="https://blog.liukairui.me/article/%E7%90%86%E8%A7%A3Vue/" title="ç†è§£Vue">https://blog.liukairui.me/article/ç†è§£Vue/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</li></ul></div><div class="post-tags"><a href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag"><i class="fa fa-tag"></i> å‰ç«¯</a> <a href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag"><i class="fa fa-tag"></i> ç¬”è®°</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/" rel="tag"><i class="fa fa-tag"></i> å‰ç«¯æ¡†æ¶</a> <a href="/tags/Vue/" rel="tag"><i class="fa fa-tag"></i> Vue</a></div><div class="post-nav"><div class="post-nav-item"><a href="/article/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84JavaScript%E5%AD%A6%E4%B9%A0/" rel="prev" title="ã€Šä½ ä¸çŸ¥é“çš„JavaScriptã€‹å­¦ä¹ "><i class="fa fa-chevron-left"></i> ã€Šä½ ä¸çŸ¥é“çš„JavaScriptã€‹å­¦ä¹ </a></div><div class="post-nav-item"></div></div></footer></article></div><div class="comments" id="valine-comments"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2019 â€“ <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Liu Kairui</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>æ€»å­—æ•°ï¼š</span> <span title="æ€»å­—æ•°">1.4m</span></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="æ€»è®¿å®¢é‡"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="æ€»è®¿é—®é‡"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="powered-by">ç”± <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9taXN0Lw==">NexT.Mist</span> å¼ºåŠ›é©±åŠ¨</div><div class="addthis_inline_share_toolbox"><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-630c5bd30a606ba8" async></script></div><div id="time_and_count"></div><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/moment.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment-precise-range-plugin@1.3.0/moment-precise-range.min.js"></script><script>function timer() {
    var ages = moment.preciseDiff(moment(),moment(20201101,"YYYYMMDD"));
    ages = ages.replace(/years?/, "å¹´");
    ages = ages.replace(/months?/, "æœˆ");
    ages = ages.replace(/days?/, "å¤©");
    ages = ages.replace(/hours?/, "å°æ—¶");
    ages = ages.replace(/minutes?/, "åˆ†");
    ages = ages.replace(/seconds?/, "ç§’");
    ages = ages.replace(/\d+/g, '<span class="daysCnt" style="color: #1890ff">$&</span>');
    div.innerHTML = `å°ç«™å·²æ‚„æ‚„è¿è¡Œäº† ${ages}`;
    div.className="workDays";
  }
  let div = document.createElement("div");
  let time_and_count = document.getElementById("time_and_count");
  time_and_count.appendChild(div);
  timer();
  setInterval("timer()",1000)</script><script>let footer = document.querySelector('.footer-inner')

let wordCount = document.querySelector('.wordcount')
wordCount.innerHTML = wordCount.innerText.replace('ï¼š',': ').replace('m','M')
if(wordCount){
  time_and_count.appendChild(wordCount);
}

let busaunzi = document.querySelector('.busuanzi-count')
if(busaunzi){
  footer.appendChild(busaunzi);
}

let powerby = document.querySelector('.powered-by')
if(powerby){
  footer.appendChild(powerby);
}</script></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.14.2/algoliasearch-lite.umd.js" integrity="sha256-dImjLPUsG/6p3+i7gVKBiDM8EemJAhQ0VvkRK2pVsQY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.45.0/instantsearch.production.min.js" integrity="sha256-356MuKn0s/KnBeNjzWGP1048qENU5M4IiAWc7q9GErU=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.8/pdfobject.min.js","integrity":"sha256-tu9j5pBilBQrWSDePOOajCUdz6hWsid/lBNzK4KgEPM="},"url":"/lib/pdf/web/viewer"}</script><script src="/js/third-party/tags/pdf.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"forest","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.6/mermaid.min.js","integrity":"sha256-ZfzwelSToHk5YAcr9wbXAmWgyn9Jyq08fSLrLhZE89w="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/fancybox.js"></script><script src="/js/third-party/pace.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"ABKlVtS4cyaWYEwunPyK3sXt-9Nh9j0Va","app_key":"xxGXdTTEGEVifs2TLB35844I","server_url":"https://abklvts4.lc-cn-e1-shared.com","security":false}</script><script src="/js/third-party/statistics/lean-analytics.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":false,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://blog.liukairui.me/article/%E7%90%86%E8%A7%A3Vue/"}</script><script src="/js/third-party/quicklink.js"></script><script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>var options = {
  bottom: '71px',
  right: 'unset',
  left: '30px',
  time: '0s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#222',
  buttonColorLight: '#222',
  saveInCookies: true,
  label: '',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();</script><script>NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"ABKlVtS4cyaWYEwunPyK3sXt-9Nh9j0Va","appKey":"xxGXdTTEGEVifs2TLB35844I","serverURLs":"https://abklvts4.lc-cn-e1-shared.com","placeholder":"è¯·å¼€å§‹ä½ çš„è¡¨æ¼”","avatar":"identicon","meta":["nick","mail","link"],"pageSize":10,"lang":"zh-CN","visitor":false,"comment_count":true,"recordIP":true,"enableQQ":true,"requiredFields":[]}, {
      el: '#valine-comments',
      path: "/article/%E7%90%86%E8%A7%A3Vue/",
      serverURLs: "https://abklvts4.lc-cn-e1-shared.com"
    }));
  }, window.Valine);
});</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!1},react:{opacity:.7}})</script></body></html>